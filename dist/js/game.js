/**
 * PadManiacs Rhythm Game
 * Copyright (C) RETORA 2025
 * Licensed under the PadManiacs License (see LICENSE file for full terms)
 * 
 * Source: https://github.com/RetoraDev/PadManiacs
 * Version: v0.0.6 dev
 * Build: 11/24/2025, 3:41:16 PM
 * Platform: Development
 * Debug: false
 * Minified: true
 */

const COPYRIGHT="(C) RETORA 2025",VERSION="v0.0.6 dev";window.DEBUG=!1;const FONTS={default:{font:"font_tiny"},tiny:{font:"font_tiny"},shaded:{font:"font_tiny_shaded"},stroke:{font:"font_tiny_stroke",fontWidth:5},number:{font:"font_tiny_number",fontMap:"1234567890 "},combo:{font:"font_combo",fontMap:"0123456789 ",fontWidth:8,fontHeight:8}},WINDOW_PANELS=["1"],DEFAULT_SONG_FOLDERS=["MikiMikiRomanticNight","ThousandCherryBlossoms","UndeadEnemy","Carnival","HatsuneMiku-Melt","KagamineRin-LoveIsWar(R184mmRemix)","KasaneTerritory-KasaneTeto","ANewWorld","39","AsuNoHikari","TheDubstepSoldiersattheFront","JustBeFriends","GentleDespair","Palette","GiganticGirl","melody_2.exe"],JUDGE_WINDOWS={marvelous:44,perfect:60,great:90,good:135,boo:180},SCORE_VALUES={marvelous:1e3,perfect:800,great:500,good:200,boo:50,miss:0},ENVIRONMENT={UNKNOWN:"WEB",NWJS:"NWJS",CORDOVA:"CORDOVA",WEB:"WEB"},CURRENT_ENVIRONMENT=ENVIRONMENT.UNKNOWN,CORDOVA_EXTERNAL_DIRECTORY="PadManiacs/",NWJS_EXTERNAL_DIRECTORY="data/",EXTERNAL_DIRECTORY=CURRENT_ENVIRONMENT==ENVIRONMENT.CORDOVA?"PadManiacs/":"data/",ADDONS_DIRECTORY="Addons",SCREENSHOTS_DIRECTORY="Screenshots",SONGS_DIRECTORY="Songs",ENABLE_PARALLEL_LOADING=!1,MAX_PARALLEL_DOWNLOADS=16,MAX_PARALLEL_ADDON_LOADS=3,ENABLE_ADDON_SAFE_MODE=!0,ENABLE_UI_SFX=!1,ENABLE_EXP_SFX=!0,CHARACTER_SYSTEM={MAX_NAME_LENGTH:6,DEFAULT_CHARACTER:"EIRI",MAX_SKILL_LEVEL:5,EXPERIENCE_CURVE:e=>Math.floor(8*Math.pow(e,1.2)),SKILL_UNLOCK_CHANCE:.7,HAIR_UNLOCK_CHANCE:.5,ITEM_UNLOCK_CHANCE:.4,SKILL_LEVEL_UP_CHANCE:.5,MIN_LEVEL_FOR_SKILL:4,MIN_LEVEL_FOR_HAIR:1,MIN_LEVEL_FOR_ITEM:3,SKILL_COOLDOWN_LEVELS:4,HAIR_COOLDOWN_LEVELS:3,ITEM_COOLDOWN_LEVELS:4,PORTRAIT_CROP:{x:43,y:11,w:15,h:15},CLOSE_SHOT_CROP:{x:32,y:15,w:36,h:7},HAIR_STYLES:{front:["Casual","Smart","Daring","Simple","Bulky","Afro","Emotional","Clean"],back:["Casual","Smart","Curly","Ponytails","Short","Afro","Diva","Clean"]}},DEFAULT_CHARACTER={name:"EIRI",level:1,experience:0,skillLevel:1,unlockedSkills:["focus_boost"],selectedSkill:"focus_boost",appearance:{skinTone:0,hairColor:11038810,frontHair:1,backHair:1,clothing:"school_uniform",accessory:null},stats:{gamesPlayed:0,totalScore:0,maxCombo:0,perfectGames:0,skillsUsed:0},lastSkillLevelUp:0},CHARACTER_SKILLS=[{id:"safety_net",name:"Safety Net",description:"Converts Miss judgments to Boo when activated",activationCondition:"on_miss",effect:"convert_judgement",effectParams:{from:"miss",to:"boo"},duration:0,cooldown:0},{id:"focus_boost",name:"Focus Boost",description:"Temporarily increases accuracy window by 20%",activationCondition:"on_combo",effect:"modify_judgement_window",effectParams:{multiplier:1.2,threshold:50},duration:5e3,cooldown:3e4},{id:"health_regen",name:"Health Regeneration",description:"Regenerates 1 health per second for 10 seconds",activationCondition:"on_low_health",effect:"health_regen",effectParams:{amount:1,interval:1e3,threshold:30},duration:1e4,cooldown:45e3},{id:"max_health_boost",name:"Max Health Boost",description:"Increases maximum health by 25 for 15 seconds",activationCondition:"on_high_combo",effect:"modify_max_health",effectParams:{amount:25,threshold:100},duration:15e3,cooldown:6e4},{id:"time_dilation",name:"Time Dilation",description:"Slows down note speed by 15% for 8 seconds",activationCondition:"on_perfect_streak",effect:"modify_note_speed",effectParams:{multiplier:.85,threshold:10},duration:8e3,cooldown:4e4},{id:"rhythm_echo",name:"Rhythm Echo",description:"Slightly extends hold forgiveness for 12 seconds",activationCondition:"on_combo",effect:"modify_hold_forgiveness",effectParams:{multiplier:1.3,threshold:30},duration:12e3,cooldown:35e3},{id:"combo_shield",name:"Combo Shield",description:"Next miss won't break combo (one-time use)",activationCondition:"on_high_combo",effect:"combo_shield",effectParams:{threshold:75},duration:0,cooldown:6e4},{id:"precision_focus",name:"Precision Focus",description:"Reduces judgement window variation for 10 seconds",activationCondition:"on_perfect_streak",effect:"stabilize_judgement",effectParams:{threshold:8},duration:1e4,cooldown:45e3},{id:"recovery_boost",name:"Recovery Boost",description:"Increases health gain from hits by 50% for 15 seconds",activationCondition:"on_low_health",effect:"modify_health_gain",effectParams:{multiplier:1.5,threshold:40},duration:15e3,cooldown:5e4},{id:"mine_evasion",name:"Mine Evasion",description:"Reduces mine damage by 50% for 20 seconds",activationCondition:"on_mine_hit",effect:"reduce_mine_damage",effectParams:{multiplier:.5},duration:2e4,cooldown:4e4},{id:"momentum_builder",name:"Momentum Builder",description:"Slightly increases score from perfects for 12 seconds",activationCondition:"on_combo",effect:"modify_score_gain",effectParams:{multiplier:1.1,judgement:"perfect",threshold:40},duration:12e3,cooldown:3e4},{id:"grace_period",name:"Grace Period",description:"Extends roll note tapping window for 10 seconds",activationCondition:"on_low_health",effect:"modify_roll_forgiveness",effectParams:{multiplier:1.4,threshold:25},duration:1e4,cooldown:4e4},{id:"steady_hands",name:"Steady Hands",description:"Reduces input lag slightly for 8 seconds",activationCondition:"on_perfect_streak",effect:"modify_input_lag",effectParams:{reduction:.02,threshold:12},duration:8e3,cooldown:35e3},{id:"second_wind",name:"Second Wind",description:"Brief health regeneration when very low health",activationCondition:"on_critical_health",effect:"burst_health_regen",effectParams:{amount:15,threshold:15},duration:0,cooldown:9e4},{id:"flow_state",name:"Flow State",description:"Slightly improves all judgements for a short time",activationCondition:"on_high_combo",effect:"general_boost",effectParams:{windowMultiplier:1.1,healthMultiplier:1.2,threshold:150},duration:6e3,cooldown:6e4},{id:"rapid_recovery",name:"Rapid Recovery",description:"Quick health burst when combo reaches 25",activationCondition:"on_combo",effect:"burst_health_regen",effectParams:{amount:10,threshold:25},duration:0,cooldown:3e4},{id:"precision_flow",name:"Precision Flow",description:"Slightly widens judgement windows at 40 combo",activationCondition:"on_combo",effect:"modify_judgement_window",effectParams:{multiplier:1.15,threshold:40},duration:8e3,cooldown:35e3},{id:"endurance_training",name:"Endurance Training",description:"Increases max health by 15 at 80 combo",activationCondition:"on_high_combo",effect:"modify_max_health",effectParams:{amount:15,threshold:80},duration:12e3,cooldown:45e3},{id:"slow_motion",name:"Slow Motion",description:"Reduces note speed by 10% after 15 perfects",activationCondition:"on_perfect_streak",effect:"modify_note_speed",effectParams:{multiplier:.9,threshold:15},duration:6e3,cooldown:4e4},{id:"safety_cushion",name:"Safety Cushion",description:"Converts two misses to boos when health is low",activationCondition:"on_low_health",effect:"convert_judgement",effectParams:{from:"miss",to:"boo",threshold:25},duration:15e3,cooldown:6e4},{id:"rhythm_mastery",name:"Rhythm Mastery",description:"Extends hold forgiveness by 25% at 60 combo",activationCondition:"on_combo",effect:"modify_hold_forgiveness",effectParams:{multiplier:1.25,threshold:60},duration:1e4,cooldown:3e4},{id:"roll_expert",name:"Roll Expert",description:"Increases roll forgiveness by 35% when health drops",activationCondition:"on_low_health",effect:"modify_roll_forgiveness",effectParams:{multiplier:1.35,threshold:35},duration:12e3,cooldown:4e4},{id:"mine_deflector",name:"Mine Deflector",description:"Reduces mine damage by 75% after hitting a mine",activationCondition:"on_mine_hit",effect:"reduce_mine_damage",effectParams:{multiplier:.25},duration:15e3,cooldown:5e4},{id:"score_amplifier",name:"Score Amplifier",description:"Increases marvelous score by 15% at 100 combo",activationCondition:"on_high_combo",effect:"modify_score_gain",effectParams:{multiplier:1.15,judgement:"marvelous",threshold:100},duration:1e4,cooldown:35e3},{id:"vitality_surge",name:"Vitality Surge",description:"Boosts health gain by 75% when critically low",activationCondition:"on_critical_health",effect:"modify_health_gain",effectParams:{multiplier:1.75,threshold:20},duration:8e3,cooldown:45e3},{id:"combo_anchor",name:"Combo Anchor",description:"Prevents combo break at 50 combo (one-time)",activationCondition:"on_high_combo",effect:"combo_shield",effectParams:{threshold:50},duration:0,cooldown:75e3},{id:"reflex_enhancer",name:"Reflex Enhancer",description:"Reduces input lag after 8 perfects in a row",activationCondition:"on_perfect_streak",effect:"modify_input_lag",effectParams:{reduction:.015,threshold:8},duration:5e3,cooldown:3e4},{id:"graceful_recovery",name:"Graceful Recovery",description:"Converts good to great when missing",activationCondition:"on_miss",effect:"convert_judgement",effectParams:{from:"good",to:"great"},duration:1e4,cooldown:4e4},{id:"momentum_keeper",name:"Momentum Keeper",description:"Regenerates 2 health/sec for 8s at 30 combo",activationCondition:"on_combo",effect:"health_regen",effectParams:{amount:2,interval:1e3,threshold:30},duration:8e3,cooldown:4e4},{id:"precision_boost",name:"Precision Boost",description:"Widens perfect window by 18% after 12 perfects",activationCondition:"on_perfect_streak",effect:"modify_judgement_window",effectParams:{multiplier:1.18,threshold:12},duration:7e3,cooldown:35e3},{id:"health_reserve",name:"Health Reserve",description:"Adds 20 max health when health drops to 40%",activationCondition:"on_low_health",effect:"modify_max_health",effectParams:{amount:20,threshold:40},duration:1e4,cooldown:5e4},{id:"tempo_control",name:"Tempo Control",description:"Slows notes by 12% at 120 combo",activationCondition:"on_high_combo",effect:"modify_note_speed",effectParams:{multiplier:.88,threshold:120},duration:9e3,cooldown:45e3},{id:"hold_stability",name:"Hold Stability",description:"40% longer hold forgiveness when struggling",activationCondition:"on_low_health",effect:"modify_hold_forgiveness",effectParams:{multiplier:1.4,threshold:30},duration:15e3,cooldown:5e4},{id:"rapid_rolls",name:"Rapid Rolls",description:"50% more roll forgiveness at 70 combo",activationCondition:"on_combo",effect:"modify_roll_forgiveness",effectParams:{multiplier:1.5,threshold:70},duration:8e3,cooldown:35e3},{id:"mine_immunity",name:"Mine Immunity",description:"90% mine damage reduction after mine hit",activationCondition:"on_mine_hit",effect:"reduce_mine_damage",effectParams:{multiplier:.1},duration:1e4,cooldown:6e4},{id:"perfect_bonus",name:"Perfect Bonus",description:"20% more score from perfects at 90 combo",activationCondition:"on_high_combo",effect:"modify_score_gain",effectParams:{multiplier:1.2,judgement:"perfect",threshold:90},duration:12e3,cooldown:4e4},{id:"recovery_expert",name:"Recovery Expert",description:"Double health gain when below 25% health",activationCondition:"on_critical_health",effect:"modify_health_gain",effectParams:{multiplier:2,threshold:25},duration:1e4,cooldown:55e3},{id:"unbreakable_chain",name:"Unbreakable Chain",description:"Combo shield activates at 200 combo",activationCondition:"on_high_combo",effect:"combo_shield",effectParams:{threshold:200},duration:0,cooldown:9e4},{id:"lightning_reflexes",name:"Lightning Reflexes",description:"Maximum input lag reduction after 20 perfects",activationCondition:"on_perfect_streak",effect:"modify_input_lag",effectParams:{reduction:.025,threshold:20},duration:6e3,cooldown:4e4},{id:"judgement_boost",name:"Judgement Boost",description:"Multiple improvements at high combo",activationCondition:"on_high_combo",effect:"general_boost",effectParams:{windowMultiplier:1.12,healthMultiplier:1.3,threshold:150},duration:5e3,cooldown:6e4},{id:"emergency_convert",name:"Emergency Convert",description:"Converts boo to good when health critical",activationCondition:"on_critical_health",effect:"convert_judgement",effectParams:{from:"boo",to:"good",threshold:10},duration:12e3,cooldown:7e4},{id:"sustained_rhythm",name:"Sustained Rhythm",description:"Long health regeneration at medium combo",activationCondition:"on_combo",effect:"health_regen",effectParams:{amount:1,interval:800,threshold:45},duration:15e3,cooldown:5e4},{id:"accuracy_focus",name:"Accuracy Focus",description:"Major window increase after perfect streak",activationCondition:"on_perfect_streak",effect:"modify_judgement_window",effectParams:{multiplier:1.25,threshold:18},duration:6e3,cooldown:45e3},{id:"overdrive_health",name:"Overdrive Health",description:"Large max health boost at very high combo",activationCondition:"on_high_combo",effect:"modify_max_health",effectParams:{amount:35,threshold:180},duration:8e3,cooldown:7e4},{id:"time_master",name:"Time Master",description:"Significant note slowdown for skilled play",activationCondition:"on_perfect_streak",effect:"modify_note_speed",effectParams:{multiplier:.8,threshold:25},duration:7e3,cooldown:6e4},{id:"expert_holds",name:"Expert Holds",description:"Maximum hold forgiveness extension",activationCondition:"on_high_combo",effect:"modify_hold_forgiveness",effectParams:{multiplier:1.6,threshold:130},duration:1e4,cooldown:4e4},{id:"master_roller",name:"Master Roller",description:"Extreme roll forgiveness for high combo",activationCondition:"on_high_combo",effect:"modify_roll_forgiveness",effectParams:{multiplier:1.8,threshold:110},duration:9e3,cooldown:45e3},{id:"score_perfection",name:"Score Perfection",description:"Massive score boost for marvelous hits",activationCondition:"on_perfect_streak",effect:"modify_score_gain",effectParams:{multiplier:1.3,judgement:"marvelous",threshold:15},duration:8e3,cooldown:5e4},{id:"ultimate_recovery",name:"Ultimate Recovery",description:"Maximum health gain boost in critical state",activationCondition:"on_critical_health",effect:"modify_health_gain",effectParams:{multiplier:2.5,threshold:15},duration:12e3,cooldown:8e4},{id:"perfect_flow",name:"Perfect Flow",description:"Ultimate general boost for expert players",activationCondition:"on_perfect_streak",effect:"general_boost",effectParams:{windowMultiplier:1.2,healthMultiplier:1.5,threshold:30},duration:4e3,cooldown:75e3},{id:"final_stand",name:"Final Stand",description:"Emergency health burst when near failure",activationCondition:"on_critical_health",effect:"burst_health_regen",effectParams:{amount:25,threshold:5},duration:0,cooldown:12e4},{id:"rhythm_savant",name:"Rhythm Savant",description:"Perfect input timing at extreme combo",activationCondition:"on_high_combo",effect:"modify_input_lag",effectParams:{reduction:.03,threshold:250},duration:5e3,cooldown:9e4}],CHARACTER_ITEMS={clothing:[{id:"school_uniform",name:"School Uniform",type:"clothing"},{id:"teacher_clothing",name:"Teacher Clothing",type:"clothing"},{id:"daring_clothing",name:"Daring",type:"clothing"},{id:"short_dress_red",name:"Short Dress (RED)",type:"clothing"},{id:"short_dress_black",name:"Short Dress (BLACK)",type:"clothing"},{id:"short_dress_orange",name:"Short Dress (ORANGE)",type:"clothing"},{id:"short_dress_blue",name:"Short Dress (BLUE)",type:"clothing"},{id:"dubstep_dress_black",name:"Dubstep Dress (BLACK)",type:"clothing"},{id:"dubstep_dress_blue",name:"Dubstep Dress (BLUE)",type:"clothing"},{id:"pinkachu",name:"Pinkachu :D",hideCharacter:!0,type:"clothing"},{id:"lencery",name:"Lencery (Remove this! For the love of god!)",type:"clothing"}],accessories:[{id:"headphones",name:"Headphones",type:"accessory"},{id:"hair_ties_red",name:"Hair Ties (RED)",type:"accessory"},{id:"hair_ties_black",name:"Hair Ties (BLACK)",type:"accessory"},{id:"hair_ties_orange",name:"Hair Ties (ORANGE)",type:"accessory"},{id:"hair_ties_blue",name:"Hair Ties (BLUE)",type:"accessory"}]},DEFAULT_ACCOUNT={settings:{volume:3,autoplay:!1,enableMenuMusic:!0,randomSong:!1,renderer:0,pixelated:!0,noteColorOption:"NOTE",noteSpeedMult:1,userOffset:0,scrollDirection:"falling",visualizer:"BPM",metronome:"OFF",beatLines:!1,beatsPerMeasure:4,speedMod:"X-MOD",safeMode:!1,enabledAddons:[],hibernatingAddons:[]},characters:{unlockedHairs:{front:[1],back:[1]},unlockedItems:["school_uniform"],currentCharacter:DEFAULT_CHARACTER.name,list:[JSON.parse(JSON.stringify(DEFAULT_CHARACTER))]},lastSong:null,highScores:{},stats:{totalGamesPlayed:0,totalTimePlayed:0,totalScore:0,maxCombo:0,perfectGames:0,maxMarvelousInGame:0,charactersCreated:0,maxCharacterLevel:1,skillsUnlocked:0,currentStreak:0,longestStreak:0,lastPlayedDate:null,difficultiesCompleted:0,highScoresSet:0,totalPlaySessions:0,averageSessionTime:0,longestSession:0,currentSessionStart:null,playedAtNight:!1,playedEarlyMorning:!1,playedWeekend:!1,playedHoliday:!1,maxSkillsInGame:0,totalNotesHit:0,totalMarvelous:0,totalPerfect:0,totalGreat:0,totalGood:0,totalBoo:0,totalMiss:0},achievements:{unlocked:{},progress:{}}},ACHIEVEMENTS={MAX_VISIBLE_NOTIFICATIONS:3,NOTIFICATION_DURATION:3e3,NOTIFICATION_DELAY:100,NOTIFICATION_SPACING:1,EXPERIENCE_VALUES:{COMMON:5,UNCOMMON:10,RARE:20,EPIC:35,LEGENDARY:64}},ACHIEVEMENT_CATEGORIES={GAMEPLAY:"Gameplay",CHARACTER:"Character",PROGRESSION:"Progression",MASTERY:"Mastery",MISC:"Miscellaneous"},ACHIEVEMENT_DEFINITIONS=[{id:"first_game",name:"First Steps",category:ACHIEVEMENT_CATEGORIES.GAMEPLAY,description:{unachieved:"Complete your first game",achieved:"You completed your first game!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.COMMON,condition:e=>e.totalGamesPlayed>=1,hidden:!1},{id:"combo_10",name:"Getting the Rhythm",category:ACHIEVEMENT_CATEGORIES.GAMEPLAY,description:{unachieved:"Reach 10 combo",achieved:"You reached 10 combo!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.COMMON,condition:e=>e.maxCombo>=10,hidden:!1},{id:"combo_25",name:"Chain Starter",category:ACHIEVEMENT_CATEGORIES.GAMEPLAY,description:{unachieved:"Reach 25 combo",achieved:"You reached 25 combo!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.COMMON,condition:e=>e.maxCombo>=25,hidden:!1},{id:"combo_50",name:"Combo Builder",category:ACHIEVEMENT_CATEGORIES.GAMEPLAY,description:{unachieved:"Reach 50 combo",achieved:"You reached 50 combo!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.COMMON,condition:e=>e.maxCombo>=50,hidden:!1},{id:"combo_100",name:"Chain Master",category:ACHIEVEMENT_CATEGORIES.GAMEPLAY,description:{unachieved:"Reach 100 combo",achieved:"You reached 100 combo!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.UNCOMMON,condition:e=>e.maxCombo>=100,hidden:!1},{id:"combo_250",name:"Rhythm Savant",category:ACHIEVEMENT_CATEGORIES.GAMEPLAY,description:{unachieved:"Reach 250 combo",achieved:"You reached 250 combo!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.RARE,condition:e=>e.maxCombo>=250,hidden:!1},{id:"combo_500",name:"Unbreakable Chain",category:ACHIEVEMENT_CATEGORIES.GAMEPLAY,description:{unachieved:"Reach 500 combo",achieved:"You reached 500 combo!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.EPIC,condition:e=>e.maxCombo>=500,hidden:!1},{id:"combo_1000",name:"Perfect Flow",category:ACHIEVEMENT_CATEGORIES.GAMEPLAY,description:{unachieved:"Reach 1000 combo",achieved:"You reached 1000 combo!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.LEGENDARY,condition:e=>e.maxCombo>=1e3,hidden:!1},{id:"perfect_game",name:"Flawless Performance",category:ACHIEVEMENT_CATEGORIES.GAMEPLAY,description:{unachieved:"Complete a song with 100% accuracy",achieved:"You completed a song with 100% accuracy!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.RARE,condition:e=>e.perfectGames>=1,hidden:!1},{id:"perfect_games_5",name:"Consistent Perfection",category:ACHIEVEMENT_CATEGORIES.GAMEPLAY,description:{unachieved:"Complete 5 songs with 100% accuracy",achieved:"You completed 5 songs with 100% accuracy!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.EPIC,condition:e=>e.perfectGames>=5,hidden:!1},{id:"perfect_games_25",name:"Perfection Master",category:ACHIEVEMENT_CATEGORIES.GAMEPLAY,description:{unachieved:"Complete 25 songs with 100% accuracy",achieved:"You completed 25 songs with 100% accuracy!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.LEGENDARY,condition:e=>e.perfectGames>=25,hidden:!1},{id:"marvelous_50",name:"Marvelous Master",category:ACHIEVEMENT_CATEGORIES.GAMEPLAY,description:{unachieved:"Get 50 Marvelous judgements in one game",achieved:"You got 50 Marvelous judgements!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.UNCOMMON,condition:e=>e.maxMarvelousInGame>=50,hidden:!1},{id:"marvelous_100",name:"Precision Expert",category:ACHIEVEMENT_CATEGORIES.GAMEPLAY,description:{unachieved:"Get 100 Marvelous judgements in one game",achieved:"You got 100 Marvelous judgements!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.RARE,condition:e=>e.maxMarvelousInGame>=100,hidden:!1},{id:"marvelous_250",name:"Timing Virtuoso",category:ACHIEVEMENT_CATEGORIES.GAMEPLAY,description:{unachieved:"Get 250 Marvelous judgements in one game",achieved:"You got 250 Marvelous judgements!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.EPIC,condition:e=>e.maxMarvelousInGame>=250,hidden:!1},{id:"no_miss_game",name:"No Mistakes",category:ACHIEVEMENT_CATEGORIES.GAMEPLAY,description:{unachieved:"Complete a song without any misses",achieved:"You completed a song without any misses!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.UNCOMMON,condition:e=>e.perfectGames>=1,hidden:!1},{id:"full_combo",name:"Full Combo",category:ACHIEVEMENT_CATEGORIES.GAMEPLAY,description:{unachieved:"Maintain combo through entire song",achieved:"You maintained combo through entire song!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.RARE,condition:e=>e.perfectGames>=1,hidden:!1},{id:"all_marvelous",name:"Absolute Precision",category:ACHIEVEMENT_CATEGORIES.GAMEPLAY,description:{unachieved:"Get only Marvelous judgements in a song",achieved:"You got only Marvelous judgements in a song!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.EPIC,condition:e=>e.perfectGames>=1&&e.maxMarvelousInGame>=50,hidden:!1},{id:"first_100k",name:"Six Figures",category:ACHIEVEMENT_CATEGORIES.GAMEPLAY,description:{unachieved:"Score 100,000 points in one game",achieved:"You scored 100,000 points in one game!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.COMMON,condition:e=>e.totalScore>=1e5,hidden:!1},{id:"first_500k",name:"Half Million",category:ACHIEVEMENT_CATEGORIES.GAMEPLAY,description:{unachieved:"Score 500,000 points in one game",achieved:"You scored 500,000 points in one game!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.UNCOMMON,condition:e=>e.totalScore>=5e5,hidden:!1},{id:"first_million",name:"Millionaire",category:ACHIEVEMENT_CATEGORIES.GAMEPLAY,description:{unachieved:"Score 1,000,000 points in one game",achieved:"You scored 1,000,000 points in one game!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.RARE,condition:e=>e.totalScore>=1e6,hidden:!1},{id:"accuracy_90",name:"A Grade",category:ACHIEVEMENT_CATEGORIES.GAMEPLAY,description:{unachieved:"Achieve 90% accuracy in a song",achieved:"You achieved 90% accuracy in a song!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.COMMON,condition:e=>e.perfectGames>=1,hidden:!1},{id:"accuracy_95",name:"S Grade",category:ACHIEVEMENT_CATEGORIES.GAMEPLAY,description:{unachieved:"Achieve 95% accuracy in a song",achieved:"You achieved 95% accuracy in a song!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.UNCOMMON,condition:e=>e.perfectGames>=1,hidden:!1},{id:"accuracy_99",name:"SS Grade",category:ACHIEVEMENT_CATEGORIES.GAMEPLAY,description:{unachieved:"Achieve 99% accuracy in a song",achieved:"You achieved 99% accuracy in a song!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.RARE,condition:e=>e.perfectGames>=1,hidden:!1},{id:"no_boo_game",name:"Clean Play",category:ACHIEVEMENT_CATEGORIES.GAMEPLAY,description:{unachieved:"Complete a song without any Boo judgements",achieved:"You completed a song without any Boo judgements!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.COMMON,condition:e=>e.perfectGames>=1,hidden:!1},{id:"only_perfect_plus",name:"Perfect+ Only",category:ACHIEVEMENT_CATEGORIES.GAMEPLAY,description:{unachieved:"Get only Marvelous and Perfect judgements",achieved:"You got only Marvelous and Perfect judgements!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.RARE,condition:e=>e.perfectGames>=1,hidden:!1},{id:"first_hold",name:"Hold It!",category:ACHIEVEMENT_CATEGORIES.GAMEPLAY,description:{unachieved:"Complete your first hold note",achieved:"You completed your first hold note!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.COMMON,condition:e=>e.totalNotesHit>=10,hidden:!1},{id:"first_roll",name:"Rolling Start",category:ACHIEVEMENT_CATEGORIES.GAMEPLAY,description:{unachieved:"Complete your first roll note",achieved:"You completed your first roll note!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.COMMON,condition:e=>e.totalNotesHit>=20,hidden:!1},{id:"mine_dodger",name:"Mine Dodger",category:ACHIEVEMENT_CATEGORIES.GAMEPLAY,description:{unachieved:"Avoid 10 mines in one song",achieved:"You avoided 10 mines in one song!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.UNCOMMON,condition:e=>e.totalGamesPlayed>=5,hidden:!1},{id:"mine_master",name:"Mine Master",category:ACHIEVEMENT_CATEGORIES.GAMEPLAY,description:{unachieved:"Avoid 50 mines in one song",achieved:"You avoided 50 mines in one song!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.RARE,condition:e=>e.totalGamesPlayed>=10,hidden:!1},{id:"speed_challenge",name:"Speed Demon",category:ACHIEVEMENT_CATEGORIES.GAMEPLAY,description:{unachieved:"Complete a song on maximum note speed",achieved:"You completed a song on maximum note speed!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.RARE,condition:e=>e.totalGamesPlayed>=15,hidden:!1},{id:"first_character",name:"New Identity",category:ACHIEVEMENT_CATEGORIES.CHARACTER,description:{unachieved:"Create your first character",achieved:"You created your first character!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.COMMON,condition:e=>e.charactersCreated>=1,hidden:!1},{id:"character_collector",name:"Character Collector",category:ACHIEVEMENT_CATEGORIES.CHARACTER,description:{unachieved:"Create 5 different characters",achieved:"You created 5 different characters!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.UNCOMMON,condition:e=>e.charactersCreated>=5,hidden:!1},{id:"character_archivist",name:"Character Archivist",category:ACHIEVEMENT_CATEGORIES.CHARACTER,description:{unachieved:"Create 10 different characters",achieved:"You created 10 different characters!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.RARE,condition:e=>e.charactersCreated>=10,hidden:!1},{id:"character_level_5",name:"Apprentice Dancer",category:ACHIEVEMENT_CATEGORIES.CHARACTER,description:{unachieved:"Reach character level 5",achieved:"You reached character level 5!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.COMMON,condition:e=>e.maxCharacterLevel>=5,hidden:!1},{id:"character_level_10",name:"Seasoned Performer",category:ACHIEVEMENT_CATEGORIES.CHARACTER,description:{unachieved:"Reach character level 10",achieved:"You reached character level 10!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.UNCOMMON,condition:e=>e.maxCharacterLevel>=10,hidden:!1},{id:"character_level_20",name:"Experienced Artist",category:ACHIEVEMENT_CATEGORIES.CHARACTER,description:{unachieved:"Reach character level 20",achieved:"You reached character level 20!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.RARE,condition:e=>e.maxCharacterLevel>=20,hidden:!1},{id:"character_level_30",name:"Veteran Dancer",category:ACHIEVEMENT_CATEGORIES.CHARACTER,description:{unachieved:"Reach character level 30",achieved:"You reached character level 30!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.EPIC,condition:e=>e.maxCharacterLevel>=30,hidden:!1},{id:"character_level_50",name:"Rhythm Legend",category:ACHIEVEMENT_CATEGORIES.CHARACTER,description:{unachieved:"Reach character level 50",achieved:"You reached character level 50!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.LEGENDARY,condition:e=>e.maxCharacterLevel>=50,hidden:!1},{id:"first_skill",name:"First Skill",category:ACHIEVEMENT_CATEGORIES.CHARACTER,description:{unachieved:"Unlock your first skill",achieved:"You unlocked your first skill!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.COMMON,condition:e=>e.skillsUnlocked>=1,hidden:!1},{id:"skill_collector",name:"Skill Collector",category:ACHIEVEMENT_CATEGORIES.CHARACTER,description:{unachieved:"Unlock 5 different skills",achieved:"You unlocked 5 different skills!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.UNCOMMON,condition:e=>e.skillsUnlocked>=5,hidden:!1},{id:"skill_master",name:"Skill Master",category:ACHIEVEMENT_CATEGORIES.CHARACTER,description:{unachieved:"Unlock 10 different skills",achieved:"You unlocked 10 different skills!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.RARE,condition:e=>e.skillsUnlocked>=10,hidden:!1},{id:"skill_grandmaster",name:"Skill Grandmaster",category:ACHIEVEMENT_CATEGORIES.CHARACTER,description:{unachieved:"Unlock 20 different skills",achieved:"You unlocked 20 different skills!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.EPIC,condition:e=>e.skillsUnlocked>=20,hidden:!1},{id:"skill_legend",name:"Skill Legend",category:ACHIEVEMENT_CATEGORIES.CHARACTER,description:{unachieved:"Unlock 30 different skills",achieved:"You unlocked 30 different skills!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.LEGENDARY,condition:e=>e.skillsUnlocked>=30,hidden:!1},{id:"first_hair_style",name:"New Look",category:ACHIEVEMENT_CATEGORIES.CHARACTER,description:{unachieved:"Unlock a new hair style",achieved:"You unlocked a new hair style!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.COMMON,condition:e=>e.charactersCreated>=1,hidden:!1},{id:"fashion_collector",name:"Fashion Collector",category:ACHIEVEMENT_CATEGORIES.CHARACTER,description:{unachieved:"Unlock 5 different clothing items",achieved:"You unlocked 5 different clothing items!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.UNCOMMON,condition:e=>e.charactersCreated>=2,hidden:!1},{id:"fashion_icon",name:"Fashion Icon",category:ACHIEVEMENT_CATEGORIES.CHARACTER,description:{unachieved:"Unlock 10 different clothing items",achieved:"You unlocked 10 different clothing items!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.RARE,condition:e=>e.charactersCreated>=3,hidden:!1},{id:"accessory_hunter",name:"Accessory Hunter",category:ACHIEVEMENT_CATEGORIES.CHARACTER,description:{unachieved:"Unlock 5 different accessories",achieved:"You unlocked 5 different accessories!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.UNCOMMON,condition:e=>e.charactersCreated>=2,hidden:!1},{id:"max_skill_level",name:"Maxed Out",category:ACHIEVEMENT_CATEGORIES.CHARACTER,description:{unachieved:"Reach maximum skill level with a character",achieved:"You reached maximum skill level with a character!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.EPIC,condition:e=>e.maxCharacterLevel>=CHARACTER_SYSTEM.MAX_SKILL_LEVEL,hidden:!1},{id:"character_perfection",name:"Character Perfection",category:ACHIEVEMENT_CATEGORIES.CHARACTER,description:{unachieved:"Max out all character stats",achieved:"You maxed out all character stats!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.LEGENDARY,condition:e=>e.maxCharacterLevel>=50&&e.skillsUnlocked>=30,hidden:!1},{id:"name_master",name:"Name Master",category:ACHIEVEMENT_CATEGORIES.CHARACTER,description:{unachieved:"Create a character with maximum name length",achieved:"You created a character with maximum name length!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.COMMON,condition:e=>e.charactersCreated>=1,hidden:!1},{id:"games_10",name:"Dedicated Player",category:ACHIEVEMENT_CATEGORIES.PROGRESSION,description:{unachieved:"Play 10 games",achieved:"You played 10 games!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.COMMON,condition:e=>e.totalGamesPlayed>=10,hidden:!1},{id:"games_25",name:"Regular Player",category:ACHIEVEMENT_CATEGORIES.PROGRESSION,description:{unachieved:"Play 25 games",achieved:"You played 25 games!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.UNCOMMON,condition:e=>e.totalGamesPlayed>=25,hidden:!1},{id:"games_50",name:"Rhythm Enthusiast",category:ACHIEVEMENT_CATEGORIES.PROGRESSION,description:{unachieved:"Play 50 games",achieved:"You played 50 games!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.RARE,condition:e=>e.totalGamesPlayed>=50,hidden:!1},{id:"games_100",name:"Addicted to Rhythm",category:ACHIEVEMENT_CATEGORIES.PROGRESSION,description:{unachieved:"Play 100 games",achieved:"You played 100 games!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.EPIC,condition:e=>e.totalGamesPlayed>=100,hidden:!1},{id:"games_250",name:"Rhythm Addict",category:ACHIEVEMENT_CATEGORIES.PROGRESSION,description:{unachieved:"Play 250 games",achieved:"You played 250 games!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.LEGENDARY,condition:e=>e.totalGamesPlayed>=250,hidden:!1},{id:"streak_3",name:"Consistent Player",category:ACHIEVEMENT_CATEGORIES.PROGRESSION,description:{unachieved:"Maintain a 3-day play streak",achieved:"You maintained a 3-day play streak!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.COMMON,condition:e=>e.currentStreak>=3,hidden:!1},{id:"streak_7",name:"Weekly Warrior",category:ACHIEVEMENT_CATEGORIES.PROGRESSION,description:{unachieved:"Maintain a 7-day play streak",achieved:"You maintained a 7-day play streak!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.UNCOMMON,condition:e=>e.currentStreak>=7,hidden:!1},{id:"streak_14",name:"Fortnight Fanatic",category:ACHIEVEMENT_CATEGORIES.PROGRESSION,description:{unachieved:"Maintain a 14-day play streak",achieved:"You maintained a 14-day play streak!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.RARE,condition:e=>e.currentStreak>=14,hidden:!1},{id:"streak_30",name:"Monthly Master",category:ACHIEVEMENT_CATEGORIES.PROGRESSION,description:{unachieved:"Maintain a 30-day play streak",achieved:"You maintained a 30-day play streak!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.EPIC,condition:e=>e.currentStreak>=30,hidden:!1},{id:"streak_90",name:"Seasoned Veteran",category:ACHIEVEMENT_CATEGORIES.PROGRESSION,description:{unachieved:"Maintain a 90-day play streak",achieved:"You maintained a 90-day play streak!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.LEGENDARY,condition:e=>e.currentStreak>=90,hidden:!1},{id:"first_high_score",name:"High Scorer",category:ACHIEVEMENT_CATEGORIES.PROGRESSION,description:{unachieved:"Set your first high score",achieved:"You set your first high score!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.COMMON,condition:e=>e.highScoresSet>=1,hidden:!1},{id:"high_score_master",name:"High Score Hunter",category:ACHIEVEMENT_CATEGORIES.PROGRESSION,description:{unachieved:"Set 10 high scores",achieved:"You set 10 high scores!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.UNCOMMON,condition:e=>e.highScoresSet>=10,hidden:!1},{id:"high_score_expert",name:"High Score Expert",category:ACHIEVEMENT_CATEGORIES.PROGRESSION,description:{unachieved:"Set 25 high scores",achieved:"You set 25 high scores!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.RARE,condition:e=>e.highScoresSet>=25,hidden:!1},{id:"high_score_legend",name:"High Score Legend",category:ACHIEVEMENT_CATEGORIES.PROGRESSION,description:{unachieved:"Set 50 high scores",achieved:"You set 50 high scores!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.EPIC,condition:e=>e.highScoresSet>=50,hidden:!1},{id:"total_score_1m",name:"Million Points",category:ACHIEVEMENT_CATEGORIES.PROGRESSION,description:{unachieved:"Reach 1 million total score",achieved:"You reached 1 million total score!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.UNCOMMON,condition:e=>e.totalScore>=1e6,hidden:!1},{id:"total_score_10m",name:"Ten Million Points",category:ACHIEVEMENT_CATEGORIES.PROGRESSION,description:{unachieved:"Reach 10 million total score",achieved:"You reached 10 million total score!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.RARE,condition:e=>e.totalScore>=1e7,hidden:!1},{id:"total_score_100m",name:"Hundred Million Points",category:ACHIEVEMENT_CATEGORIES.PROGRESSION,description:{unachieved:"Reach 100 million total score",achieved:"You reached 100 million total score!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.EPIC,condition:e=>e.totalScore>=1e8,hidden:!1},{id:"notes_1000",name:"Thousand Notes",category:ACHIEVEMENT_CATEGORIES.PROGRESSION,description:{unachieved:"Hit 1000 notes total",achieved:"You hit 1000 notes total!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.COMMON,condition:e=>e.totalNotesHit>=1e3,hidden:!1},{id:"notes_10000",name:"Ten Thousand Notes",category:ACHIEVEMENT_CATEGORIES.PROGRESSION,description:{unachieved:"Hit 10,000 notes total",achieved:"You hit 10,000 notes total!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.UNCOMMON,condition:e=>e.totalNotesHit>=1e4,hidden:!1},{id:"notes_100000",name:"Hundred Thousand Notes",category:ACHIEVEMENT_CATEGORIES.PROGRESSION,description:{unachieved:"Hit 100,000 notes total",achieved:"You hit 100,000 notes total!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.RARE,condition:e=>e.totalNotesHit>=1e5,hidden:!1},{id:"time_1_hour",name:"Hour of Rhythm",category:ACHIEVEMENT_CATEGORIES.TIME,description:{unachieved:"Play for 1 hour total",achieved:"You played for 1 hour total!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.COMMON,condition:e=>e.totalTimePlayed>=3600,hidden:!1},{id:"time_5_hours",name:"Rhythm Enthusiast",category:ACHIEVEMENT_CATEGORIES.TIME,description:{unachieved:"Play for 5 hours total",achieved:"You played for 5 hours total!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.UNCOMMON,condition:e=>e.totalTimePlayed>=18e3,hidden:!1},{id:"time_10_hours",name:"Dedicated Dancer",category:ACHIEVEMENT_CATEGORIES.TIME,description:{unachieved:"Play for 10 hours total",achieved:"You played for 10 hours total!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.RARE,condition:e=>e.totalTimePlayed>=36e3,hidden:!1},{id:"time_24_hours",name:"Rhythm Marathon",category:ACHIEVEMENT_CATEGORIES.TIME,description:{unachieved:"Play for 24 hours total",achieved:"You played for 24 hours total!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.EPIC,condition:e=>e.totalTimePlayed>=86400,hidden:!1},{id:"time_100_hours",name:"Rhythm Master",category:ACHIEVEMENT_CATEGORIES.TIME,description:{unachieved:"Play for 100 hours total",achieved:"You played for 100 hours total!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.LEGENDARY,condition:e=>e.totalTimePlayed>=36e4,hidden:!1},{id:"session_30_min",name:"Focused Session",category:ACHIEVEMENT_CATEGORIES.TIME,description:{unachieved:"Play a single session for 30 minutes",achieved:"You played a single session for 30 minutes!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.UNCOMMON,condition:e=>e.longestSession>=1800,hidden:!1},{id:"session_1_hour",name:"Extended Session",category:ACHIEVEMENT_CATEGORIES.TIME,description:{unachieved:"Play a single session for 1 hour",achieved:"You played a single session for 1 hour!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.RARE,condition:e=>e.longestSession>=3600,hidden:!1},{id:"session_2_hours",name:"Marathon Session",category:ACHIEVEMENT_CATEGORIES.TIME,description:{unachieved:"Play a single session for 2 hours",achieved:"You played a single session for 2 hours!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.EPIC,condition:e=>e.longestSession>=7200,hidden:!1},{id:"session_4_hours",name:"Ultra Marathon",category:ACHIEVEMENT_CATEGORIES.TIME,description:{unachieved:"Play a single session for 4 hours",achieved:"You played a single session for 4 hours!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.LEGENDARY,condition:e=>e.longestSession>=14400,hidden:!1},{id:"early_bird",name:"Early Bird",category:ACHIEVEMENT_CATEGORIES.TIME,description:{unachieved:"Play between 5 AM and 9 AM",achieved:"You played between 5 AM and 9 AM!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.COMMON,condition:e=>e.playedEarlyMorning,hidden:!0},{id:"night_owl",name:"Night Owl",category:ACHIEVEMENT_CATEGORIES.TIME,description:{unachieved:"Play between midnight and 4 AM",achieved:"You played between midnight and 4 AM!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.UNCOMMON,condition:e=>e.playedAtNight,hidden:!0},{id:"weekend_warrior",name:"Weekend Warrior",category:ACHIEVEMENT_CATEGORIES.TIME,description:{unachieved:"Play on a weekend",achieved:"You played on a weekend!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.COMMON,condition:e=>e.playedWeekend,hidden:!1},{id:"holiday_player",name:"Holiday Player",category:ACHIEVEMENT_CATEGORIES.TIME,description:{unachieved:"Play on a holiday",achieved:"You played on a holiday!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.UNCOMMON,condition:e=>e.playedHoliday,hidden:!0},{id:"new_years_player",name:"New Year's Rhythm",category:ACHIEVEMENT_CATEGORIES.TIME,description:{unachieved:"Play on New Year's Day",achieved:"You played on New Year's Day!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.RARE,condition:e=>e.playedHoliday,hidden:!0},{id:"valentines_player",name:"Valentine's Beat",category:ACHIEVEMENT_CATEGORIES.TIME,description:{unachieved:"Play on Valentine's Day",achieved:"You played on Valentine's Day!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.RARE,condition:e=>e.playedHoliday,hidden:!0},{id:"all_difficulties",name:"Versatile Player",category:ACHIEVEMENT_CATEGORIES.MASTERY,description:{unachieved:"Complete songs on all difficulty types",achieved:"You completed songs on all difficulty types!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.RARE,condition:e=>e.difficultiesCompleted>=5,hidden:!1},{id:"beginner_master",name:"Beginner Master",category:ACHIEVEMENT_CATEGORIES.MASTERY,description:{unachieved:"Complete 10 Beginner difficulty songs",achieved:"You completed 10 Beginner difficulty songs!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.COMMON,condition:e=>e.totalGamesPlayed>=10,hidden:!1},{id:"easy_master",name:"Easy Master",category:ACHIEVEMENT_CATEGORIES.MASTERY,description:{unachieved:"Complete 10 Easy difficulty songs",achieved:"You completed 10 Easy difficulty songs!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.COMMON,condition:e=>e.totalGamesPlayed>=15,hidden:!1},{id:"medium_master",name:"Medium Master",category:ACHIEVEMENT_CATEGORIES.MASTERY,description:{unachieved:"Complete 10 Medium difficulty songs",achieved:"You completed 10 Medium difficulty songs!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.UNCOMMON,condition:e=>e.totalGamesPlayed>=20,hidden:!1},{id:"hard_master",name:"Hard Master",category:ACHIEVEMENT_CATEGORIES.MASTERY,description:{unachieved:"Complete 10 Hard difficulty songs",achieved:"You completed 10 Hard difficulty songs!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.RARE,condition:e=>e.totalGamesPlayed>=25,hidden:!1},{id:"challenge_master",name:"Challenge Master",category:ACHIEVEMENT_CATEGORIES.MASTERY,description:{unachieved:"Complete 10 Challenge difficulty songs",achieved:"You completed 10 Challenge difficulty songs!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.EPIC,condition:e=>e.totalGamesPlayed>=30,hidden:!1},{id:"difficulty_15",name:"Expert Player",category:ACHIEVEMENT_CATEGORIES.MASTERY,description:{unachieved:"Complete a difficulty 15 song",achieved:"You completed a difficulty 15 song!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.RARE,condition:e=>e.totalGamesPlayed>=20,hidden:!1},{id:"difficulty_20",name:"Master Player",category:ACHIEVEMENT_CATEGORIES.MASTERY,description:{unachieved:"Complete a difficulty 20 song",achieved:"You completed a difficulty 20 song!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.EPIC,condition:e=>e.totalGamesPlayed>=30,hidden:!1},{id:"all_songs",name:"Song Completionist",category:ACHIEVEMENT_CATEGORIES.MASTERY,description:{unachieved:"Complete all available songs",achieved:"You completed all available songs!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.LEGENDARY,condition:e=>e.totalGamesPlayed>=50,hidden:!1},{id:"perfect_all_songs",name:"Perfect Completionist",category:ACHIEVEMENT_CATEGORIES.MASTERY,description:{unachieved:"Perfect complete all songs",achieved:"You perfect completed all songs!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.LEGENDARY,condition:e=>e.perfectGames>=50,hidden:!1},{id:"skill_spammer",name:"Skill Spammer",category:ACHIEVEMENT_CATEGORIES.MASTERY,description:{unachieved:"Use 5 skills in a single game",achieved:"You used 5 skills in a single game!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.COMMON,condition:e=>e.maxSkillsInGame>=5,hidden:!1},{id:"skill_expert",name:"Skill Expert",category:ACHIEVEMENT_CATEGORIES.MASTERY,description:{unachieved:"Use 10 skills in a single game",achieved:"You used 10 skills in a single game!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.UNCOMMON,condition:e=>e.maxSkillsInGame>=10,hidden:!1},{id:"skill_mastery",name:"Skill Mastery",category:ACHIEVEMENT_CATEGORIES.MASTERY,description:{unachieved:"Use every skill at least once",achieved:"You used every skill at least once!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.RARE,condition:e=>e.skillsUnlocked>=10,hidden:!1},{id:"offset_master",name:"Offset Master",category:ACHIEVEMENT_CATEGORIES.MASTERY,description:{unachieved:"Perfect your global offset setting",achieved:"You perfected your global offset setting!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.UNCOMMON,condition:e=>e.totalGamesPlayed>=10,hidden:!1},{id:"visualizer_master",name:"Visualizer Master",category:ACHIEVEMENT_CATEGORIES.MASTERY,description:{unachieved:"Try all visualizer types",achieved:"You tried all visualizer types!"},expReward:ACHIEVEMENTS.EXPERIENCE_VALUES.COMMON,condition:e=>e.totalGamesPlayed>=5,hidden:!1}];class Character{constructor(e){this.name=e.name,this.level=e.level||1,this.experience=e.experience||0,this.skillLevel=e.skillLevel||1,this.unlockedSkills=e.unlockedSkills||[],this.selectedSkill=e.selectedSkill||null,this.appearance=e.appearance||{skinTone:0,hairColor:16777215,frontHair:"1",backHair:"1",clothing:"school_uniform",accessory:"headphones"},this.stats=e.stats||{gamesPlayed:0,totalScore:0,maxCombo:0,perfectGames:0,skillsUsed:0},this.experienceStory=[],this.lastSkillLevelUp=e.lastSkillLevelUp||0,this.lastHairUnlockLevel=e.lastHairUnlockLevel||0,this.lastItemUnlockLevel=e.lastItemUnlockLevel||0}getLastExperienceStoryEntry(){return this.experienceStory.length?this.experienceStory[this.experienceStory.length-1]:null}addExperience(e){const t={levelBefore:this.level,expBefore:this.experience,expGain:e};this.experience+=e;const i=CHARACTER_SYSTEM.EXPERIENCE_CURVE(this.level);for(;this.experience>=i;)this.levelUp(),this.experience-=i;t.expAfter=this.experience,t.levelAfter=this.level,this.experienceStory.push(t)}levelUp(){if(this.level++,Math.random()<CHARACTER_SYSTEM.SKILL_UNLOCK_CHANCE&&this.level>=CHARACTER_SYSTEM.MIN_LEVEL_FOR_SKILL){const e=this.unlockRandomSkill();e&&notifications.show(`New skill unlocked: ${e.name}`)}if(this.level>=CHARACTER_SYSTEM.MIN_LEVEL_FOR_HAIR&&this.level-this.lastHairUnlockLevel>=CHARACTER_SYSTEM.HAIR_COOLDOWN_LEVELS&&Math.random()<CHARACTER_SYSTEM.HAIR_UNLOCK_CHANCE){const e=this.unlockRandomHairStyle();e&&(this.lastHairUnlockLevel=this.level,notifications.show(`New hair style unlocked: ${e.type} ${e.id}`))}if(this.level>=CHARACTER_SYSTEM.MIN_LEVEL_FOR_ITEM&&this.level-this.lastItemUnlockLevel>=CHARACTER_SYSTEM.ITEM_COOLDOWN_LEVELS&&Math.random()<CHARACTER_SYSTEM.ITEM_UNLOCK_CHANCE){const e=this.unlockRandomItem();e&&(this.lastItemUnlockLevel=this.level,notifications.show(`New item unlocked: ${e.name}`))}this.level-this.lastSkillLevelUp>=CHARACTER_SYSTEM.SKILL_COOLDOWN_LEVELS&&Math.random()<CHARACTER_SYSTEM.SKILL_LEVEL_UP_CHANCE&&this.skillLevel<CHARACTER_SYSTEM.MAX_SKILL_LEVEL&&(this.skillLevel++,this.lastSkillLevelUp=this.level,notifications.show(`Skill level increased to ${this.skillLevel}`))}unlockRandomSkill(){const e=CHARACTER_SKILLS.filter(e=>!this.unlockedSkills.includes(e.id));if(e.length>0){const t=e[Math.floor(Math.random()*e.length)];return this.unlockedSkills.push(t.id),t}return null}unlockRandomHairStyle(){const e=[],t=[];for(let t=1;t<=CHARACTER_SYSTEM.HAIR_STYLES.front;t++)Account.characters.unlockedHairs.front.includes(t)||e.push(t);for(let e=1;e<=CHARACTER_SYSTEM.HAIR_STYLES.back;e++)Account.characters.unlockedHairs.back.includes(e)||t.push(e);const i=Math.random()<.5?"front":"back",s="front"===i?e:t;if(s.length>0){const e=s[Math.floor(Math.random()*s.length)];return Account.characters.unlockedHairs[i].push(e),localStorage.setItem("Account",JSON.stringify(Account)),{type:i,id:e}}return null}unlockRandomItem(){const e=[...CHARACTER_ITEMS.clothing,...CHARACTER_ITEMS.accessories].filter(e=>!Account.characters.unlockedItems.includes(e.id));if(e.length>0){const t=e[Math.floor(Math.random()*e.length)];return Account.characters.unlockedItems.push(t.id),localStorage.setItem("Account",JSON.stringify(Account)),t}return null}getAvailableHairStyles(){return{front:Account.characters.unlockedHairs.front,back:Account.characters.unlockedHairs.back}}getAvailableItems(){return Account.characters.unlockedItems}changeHairStyle(e,t){return"front"===e&&Account.characters.unlockedHairs.front.includes(t)?(this.appearance.frontHair=t,!0):!("back"!==e||!Account.characters.unlockedHairs.back.includes(t))&&(this.appearance.backHair=t,!0)}changeClothing(e){if(Account.characters.unlockedItems.includes(e)){const t=CHARACTER_ITEMS.clothing.find(t=>t.id===e)||CHARACTER_ITEMS.accessories.find(t=>t.id===e);if(t)return"clothing"===t.type?this.appearance.clothing=e:"accessory"===t.type&&(this.appearance.accessory=e),!0}return!1}getRequiredExperience(){return CHARACTER_SYSTEM.EXPERIENCE_CURVE(this.level)}getExperienceProgress(){const e=this.getRequiredExperience();return this.experience/e}canUseSkill(){return this.skillLevel>0&&this.unlockedSkills.length>0}toJSON(){return{name:this.name,level:this.level,experience:this.experience,skillLevel:this.skillLevel,unlockedSkills:this.unlockedSkills,selectedSkill:this.selectedSkill,appearance:this.appearance,stats:this.stats,lastSkillLevelUp:this.lastSkillLevelUp,lastHairUnlockLevel:this.lastHairUnlockLevel,lastItemUnlockLevel:this.lastItemUnlockLevel}}}class CharacterDisplay extends Phaser.Sprite{constructor(e,t,i){super(game,e,t),this.character=i,this.layers={},i&&this.createLayers(),game.add.existing(this)}createLayers(){this.layers.backHair=game.add.sprite(0,0,`character_back_hair_${this.character.appearance.backHair}`),this.layers.backHair.tint=this.character.appearance.hairColor,this.addChild(this.layers.backHair),this.layers.base=game.add.sprite(0,0,"character_base",this.character.appearance.skinTone),this.addChild(this.layers.base),this.layers.frontHair=game.add.sprite(0,0,`character_front_hair_${this.character.appearance.frontHair}`),this.layers.frontHair.tint=this.character.appearance.hairColor,this.addChild(this.layers.frontHair),this.layers.eyes=game.add.sprite(0,0,"character_eyes",0),this.addChild(this.layers.eyes),this.setupBlinking(),this.layers.clothing=game.add.sprite(0,0,`character_clothing_${this.character.appearance.clothing}`),this.addChild(this.layers.clothing),this.character.appearance.accessory&&(this.layers.accessory=game.add.sprite(0,0,`character_accessory_${this.character.appearance.accessory}`),this.addChild(this.layers.accessory)),this.setClothingVisibility()}setClothingVisibility(){const e=!CHARACTER_ITEMS.clothing.find(e=>e.id===this.character.appearance.clothing).hideCharacter;this.layers.backHair.visible=e,this.layers.base.visible=e,this.layers.frontHair.visible=e,this.layers.eyes.visible=e,this.layers.frontHair.visible=e,this.layers.accessory&&(this.layers.accessory.visible=e)}setupBlinking(){this.layers.eyes.animations.add("blink",[0,1,2,3,2,1,0],16,!1),this.startBlinking()}startBlinking(){const e=game.rnd.between(500,5e3);this.blink(e,()=>{this.startBlinking()})}blink(e,t){game.time.events.add(e,()=>{this.layers.eyes&&(this.layers.eyes.animations.play("blink"),this.layers.eyes.animations.currentAnim.onComplete.addOnce(()=>t?.()))})}updateAppearance(e){this.character.appearance={...this.character.appearance,...e},this.layers.backHair&&(this.layers.backHair.tint=this.character.appearance.hairColor,e.backHair&&this.layers.backHair.loadTexture(`character_back_hair_${e.backHair}`)),this.layers.frontHair&&(this.layers.frontHair.tint=this.character.appearance.hairColor,e.frontHair&&this.layers.frontHair.loadTexture(`character_front_hair_${e.frontHair}`)),this.layers.base&&void 0!==e.skinTone&&(this.layers.base.frame=this.character.appearance.skinTone),this.layers.clothing&&e.clothing&&this.layers.clothing.loadTexture(`character_clothing_${e.clothing}`),void 0!==e.accessory&&(this.layers.accessory&&this.layers.accessory.destroy(),e.accessory&&(this.layers.accessory=game.add.sprite(0,0,`character_accessory_${e.accessory}`),this.addChild(this.layers.accessory))),this.setClothingVisibility()}destroy(){Object.values(this.layers).forEach(e=>{e&&e.destroy&&e.destroy()}),this.layers={},super.destroy()}}class CharacterCroppedDisplay extends CharacterDisplay{constructor(e,t,i,s){super(0,0,i),this.cropArea=s,this.cropSprite(),this.x=e,this.y=t}cropSprite(){Object.values(this.layers).forEach(e=>{e&&e.crop(new Phaser.Rectangle(this.cropArea.x,this.cropArea.y,this.cropArea.w,this.cropArea.h))})}updateAppearance(e){super.updateAppearance(e),this.cropSprite()}}class CharacterPortrait extends CharacterCroppedDisplay{constructor(e,t,i){super(e,t,i,CHARACTER_SYSTEM.PORTRAIT_CROP)}}class CharacterCloseShot extends CharacterCroppedDisplay{constructor(e,t,i){super(e,t,i,CHARACTER_SYSTEM.CLOSE_SHOT_CROP)}}class CharacterManager{constructor(){this.characters=new Map,this.currentCharacter=null,this.loadFromAccount()}loadFromAccount(){Account.characters||(Account.characters=JSON.parse(JSON.stringify(DEFAULT_ACCOUNT.characters))),Account.characters.list.forEach(e=>{const t=new Character(e);this.characters.set(t.name,t)}),Account.characters.currentCharacter?this.currentCharacter=this.characters.get(Account.characters.currentCharacter)||this.characters.values().next().value:this.currentCharacter=null}createCharacter(e,t={}){if(this.characters.has(e)||e.length>CHARACTER_SYSTEM.MAX_NAME_LENGTH)return null;const i=new Character({name:e,appearance:{skinTone:t.skinTone||0,hairColor:t.hairColor||16777215,frontHair:t.frontHair||"1",backHair:t.backHair||"1",clothing:t.clothing||"school_uniform",accessory:t.accessory||null}});return this.characters.set(e,i),Account.characters.list.push(i.toJSON()),saveAccount(),i}deleteCharacter(e){this.characters.size<=1&&this.unsetCharacter;const t=this.characters.delete(e);return t&&(Account.characters.list=Account.characters.list.filter(t=>t.name!==e),Account.characters.currentCharacter===e&&(Account.characters.currentCharacter=this.characters.keys().next().value,this.currentCharacter=this.characters.get(Account.characters.currentCharacter)),saveAccount()),t}unsetCharacter(){this.currentCharacter=null,Account.characters.currentCharacter=null,saveAccount()}setCurrentCharacter(e){const t=this.characters.get(e);return!!t&&(this.currentCharacter=t,Account.characters.currentCharacter=e,saveAccount(),!0)}updateCharacterStats(e){if(!this.currentCharacter)return 0;const t=this.currentCharacter;t.stats.gamesPlayed++,t.stats.totalScore+=e.score,t.stats.maxCombo=Math.max(t.stats.maxCombo,e.maxCombo),e.accuracy>=100&&t.stats.perfectGames++,t.stats.skillsUsed+=e.skillsUsed||0;const i=this.calculateExperienceGain(e);t.addExperience(i);const s=Account.characters.list.find(e=>e.name===t.name);return s&&Object.assign(s,t.toJSON()),saveAccount(),i}calculateExperienceGain(e){let t=0;const i=Object.values(e.judgements).reduce((e,t)=>e+t,0);if(i<25)return 0;if(e.accuracy<50)return 0;if(e.accuracy>=70&&(t+=2),e.accuracy>=100?t+=8:e.accuracy>=99?t+=6:e.accuracy>=97?t+=5:e.accuracy>=95?t+=4:e.accuracy>=90?t+=3:e.accuracy>=85?t+=2:e.accuracy>=80&&(t+=1),e.maxCombo>=1e3?t+=8:e.maxCombo>=500?t+=6:e.maxCombo>=250?t+=4:e.maxCombo>=100?t+=3:e.maxCombo>=50&&(t+=2),e.maxCombo>0&&0===e.judgements.miss){t+=8;(e.judgements.marvelous||0)+(e.judgements.perfect||0)===i&&(t+=4)}if(i>0){const s=(e.judgements.marvelous||0)/i,a=(e.judgements.perfect||0)/i;s>=.8?t+=3:(s>=.6||a>=.9)&&(t+=2)}return e.difficultyRating&&(e.difficultyRating>=15?t+=3:e.difficultyRating>=12?t+=2:e.difficultyRating>=9&&(t+=1)),e.skillsUsed>0&&(t+=Math.min(2,e.skillsUsed)),t}unlockHair(e,t){return!Account.characters.unlockedHairs[e].includes(t)&&(Account.characters.unlockedHairs[e].push(t),saveAccount(),!0)}unlockItem(e){return!Account.characters.unlockedItems.includes(e)&&(Account.characters.unlockedItems.push(e),saveAccount(),!0)}getCharacterList(){return Array.from(this.characters.values())}getCurrentCharacter(){return this.currentCharacter}saveToAccount(){Account.characters.list=this.getCharacterList().map(e=>e.toJSON()),Account.characters.currentCharacter=this.currentCharacter?this.currentCharacter.name:null,saveAccount()}}class CharacterSkillSystem{constructor(e,t){this.scene=e,this.character=t||e.character,this.activeSkills=new Map,this.skillCooldowns=new Map,this.skillsUsedThisGame=0,this.skillEffects={judgementConversion:null,judgementWindowMultiplier:1,healthRegen:null,maxHealthBonus:0,noteSpeedMultiplier:1,holdForgivenessMultiplier:1,rollForgivenessMultiplier:1,mineDamageMultiplier:1,scoreMultipliers:{},healthGainMultiplier:1,comboShield:!1,inputLagReduction:0}}checkSkillActivation(e,t={}){if(!this.character||this.exhausted)return;const i=this.character.unlockedSkills.map(e=>CHARACTER_SKILLS.find(t=>t.id===e)).find(e=>e.id===this.character.selectedSkill);i&&i.activationCondition===e&&this.canActivateSkill(i,t)&&(this.activateSkill(i,t),this.skillsUsedThisGame++)}canActivateSkill(e,t){if(this.exhausted)return!1;if(this.skillCooldowns.has(e.id))return!1;if(this.scene.autoPlay)return!1;switch(e.activationCondition){case"on_miss":return"miss"===t.judgement;case"on_combo":return t.combo>=(e.effectParams.threshold||50);case"on_low_health":return t.health<=(e.effectParams.threshold||30);case"on_high_combo":return t.combo>=(e.effectParams.threshold||100);case"on_perfect_streak":return t.perfectStreak>=(e.effectParams.threshold||10);case"on_mine_hit":default:return!0;case"on_critical_health":return t.health<=(e.effectParams.threshold||15);case"custom":return!!e.activationCheckFunction&&e.activationCheckFunction()}}activateSkill(e,t){this.applySkillEffect(e),e.cooldown>0&&(this.skillCooldowns.set(e.id,game.time.now+e.cooldown),game.time.events.add(e.cooldown,()=>{this.skillCooldowns.delete(e.id)})),this.scene?.showCharacterCloseShot(e.duration||1800),e.duration>0&&(this.activeSkills.set(e.id,{skill:e,startTime:game.time.now,endTime:game.time.now+e.duration}),game.time.events.add(e.duration,()=>{this.deactivateSkill(e.id)})),this.notifySkillUsed(e)}notifySkillUsed(e){const t=8+4*e.name.length,i="rgba(44, 90, 198, 0.6)",s=game.add.bitmapData(t,8),a=s.context.createLinearGradient(0,0,t,0);a.addColorStop(0,i),a.addColorStop(.7,i),a.addColorStop(1,"transparent"),s.context.fillStyle=a,s.context.fillRect(0,0,t,8);const n=game.add.sprite(-t,32,s);n.alpha=0;new Text(4,1,e.name,FONTS.default,n);game.add.tween(n).to({alpha:1,x:4},350,Phaser.Easing.Quadratic.Out,!0).yoyo(!0).yoyoDelay(1e3)}applySkillEffect(e){switch(e.effect){case"convert_judgement":this.skillEffects.judgementConversion=e.effectParams;break;case"modify_judgement_window":this.skillEffects.judgementWindowMultiplier=e.effectParams.multiplier;break;case"health_regen":this.startHealthRegen(e.effectParams);break;case"modify_max_health":this.skillEffects.maxHealthBonus=e.effectParams.amount;break;case"modify_note_speed":this.skillEffects.noteSpeedMultiplier=e.effectParams.multiplier,this.scene.showGlitchAnimation(100);break;case"modify_hold_forgiveness":this.skillEffects.holdForgivenessMultiplier=e.effectParams.multiplier;break;case"modify_roll_forgiveness":this.skillEffects.rollForgivenessMultiplier=e.effectParams.multiplier;break;case"reduce_mine_damage":this.skillEffects.mineDamageMultiplier=e.effectParams.multiplier;break;case"modify_score_gain":this.skillEffects.scoreMultipliers[e.effectParams.judgement]=e.effectParams.multiplier;break;case"modify_health_gain":this.skillEffects.healthGainMultiplier=e.effectParams.multiplier;break;case"combo_shield":this.skillEffects.comboShield=!0,this.onComboShield&&this.onComboShield();break;case"modify_input_lag":this.skillEffects.inputLagReduction=e.effectParams.reduction;break;case"burst_health_regen":this.onHealthRegen&&this.onHealthRegen(e.effectParams.amount);break;case"stabilize_judgement":break;case"general_boost":this.skillEffects.judgementWindowMultiplier=e.effectParams.windowMultiplier,this.skillEffects.healthGainMultiplier=e.effectParams.healthMultiplier}}deactivateSkill(e){const t=this.activeSkills.get(e);if(!t)return;const i=t.skill;switch(i.effect){case"convert_judgement":this.skillEffects.judgementConversion=null;break;case"modify_judgement_window":this.skillEffects.judgementWindowMultiplier=1;break;case"health_regen":this.stopHealthRegen();break;case"modify_max_health":this.skillEffects.maxHealthBonus=0;break;case"modify_note_speed":this.skillEffects.noteSpeedMultiplier=1,this.scene.showGlitchAnimation(100);break;case"modify_hold_forgiveness":this.skillEffects.holdForgivenessMultiplier=1;break;case"modify_roll_forgiveness":this.skillEffects.rollForgivenessMultiplier=1;break;case"reduce_mine_damage":this.skillEffects.mineDamageMultiplier=1;break;case"modify_score_gain":delete this.skillEffects.scoreMultipliers[i.effectParams.judgement];break;case"modify_health_gain":this.skillEffects.healthGainMultiplier=1;break;case"combo_shield":this.skillEffects.comboShield=!1;break;case"modify_input_lag":this.skillEffects.inputLagReduction=0;break;case"general_boost":this.skillEffects.judgementWindowMultiplier=1,this.skillEffects.healthGainMultiplier=1}this.activeSkills.delete(e)}startHealthRegen(e){this.stopHealthRegen(),this.healthRegenTimer=game.time.events.loop(e.interval,()=>{this.onHealthRegen&&this.onHealthRegen(e.amount)})}stopHealthRegen(){this.healthRegenTimer&&(game.time.events.remove(this.healthRegenTimer),this.healthRegenTimer=null)}getJudgementConversion(){return this.exhausted?null:this.skillEffects.judgementConversion}getJudgementWindowMultiplier(){return this.skillEffects.judgementWindowMultiplier}getMaxHealthBonus(){return this.skillEffects.maxHealthBonus}getNoteSpeedMultiplier(){return this.skillEffects.noteSpeedMultiplier}getHoldForgivenessMultiplier(){return this.skillEffects.holdForgivenessMultiplier}getRollForgivenessMultiplier(){return this.skillEffects.rollForgivenessMultiplier}getMineDamageMultiplier(){return this.skillEffects.mineDamageMultiplier}getScoreMultiplier(e){return this.skillEffects.scoreMultipliers[e]||1}getHealthGainMultiplier(){return this.skillEffects.healthGainMultiplier}getInputLagReduction(){return this.skillEffects.inputLagReduction}update(){const e=game.time.now;if(this.character){this.exhausted=this.skillsUsedThisGame>=this.character.skillLevel;for(const[t,i]of this.activeSkills)e>=i.endTime&&this.deactivateSkill(t);for(const[t,i]of this.skillCooldowns)e>=i&&this.skillCooldowns.delete(t);this.scene.skillBar.value=5-(5-this.character.skillLevel)-this.getSkillsUsed(),this.scene.skillBar.visibleParts=this.character.skillLevel,this.scene.skillBar.update()}}resetGame(){for(const e of this.activeSkills.keys())this.deactivateSkill(e);this.activeSkills.clear(),this.skillCooldowns.clear(),this.skillsUsedThisGame=0,this.skillEffects={judgementConversion:null,judgementWindowMultiplier:1,healthRegen:null,maxHealthBonus:0,noteSpeedMultiplier:1,holdForgivenessMultiplier:1,rollForgivenessMultiplier:1,mineDamageMultiplier:1,scoreMultipliers:{},healthGainMultiplier:1,comboShield:!1,inputLagReduction:0},this.stopHealthRegen()}getSkillsUsed(){return this.skillsUsedThisGame}}class AchievementsManager{constructor(){this.newAchievements=[],this.timeUpdateInterval=null,this.sessionStartTime=null,this.lastUpdateTime=null,this.isTracking=!1,this.lastSaveTime=null,this.autoSaveInterval=1e4}initialize(){Account.achievements||(Account.achievements={unlocked:{},progress:{}}),Account.stats||(Account.stats=JSON.parse(JSON.stringify(DEFAULT_ACCOUNT.stats))),ACHIEVEMENT_DEFINITIONS.forEach(e=>{Account.achievements.progress[e.id]||(Account.achievements.progress[e.id]=0)}),this.recoverSessionTime(),this.startSession(),this.startTimeTracking(),this.startAutoSave(),this.setupWindowEvents(),setInterval(()=>this.update(),2),console.log("Achievements Manager initialized")}recoverSessionTime(){if(Account.stats.currentSessionStart){const e=Account.stats.currentSessionStart,t=Date.now(),i=Math.floor((t-e)/1e3);i>0&&i<86400&&(console.log(`Recovered ${i} seconds of lost session time`),Account.stats.totalTimePlayed+=i,i>Account.stats.longestSession&&(Account.stats.longestSession=i)),Account.stats.currentSessionStart=null}}startSession(){this.sessionStartTime=Date.now(),this.lastUpdateTime=this.sessionStartTime,Account.stats.currentSessionStart||(Account.stats.totalPlaySessions++,Account.stats.currentSessionStart=this.sessionStartTime),this.updatePlayStreak(),this.checkTimeBasedConditions(),console.log("New play session started")}startTimeTracking(){this.timeUpdateInterval&&clearInterval(this.timeUpdateInterval),this.timeUpdateInterval=setInterval(()=>{this.updateTimeStats()},100),this.isTracking=!0}updateTimeStats(){if(!this.isTracking||!this.sessionStartTime)return;const e=Date.now(),t=Math.floor((e-this.lastUpdateTime)/1e3);if(t>0){Account.stats.totalTimePlayed+=t;const i=Math.floor((e-this.sessionStartTime)/1e3);i>Account.stats.longestSession&&(Account.stats.longestSession=i),this.lastUpdateTime=e,(t>=60||this.lastUpdateTime%6e4<1e3)&&this.checkTimeBasedAchievements()}}updatePlayStreak(){const e=(new Date).toDateString(),t=Account.stats.lastPlayedDate;if(t){const i=new Date(t),s=new Date;s.setDate(s.getDate()-1),i.toDateString()===s.toDateString()?(Account.stats.currentStreak++,Account.stats.longestStreak=Math.max(Account.stats.longestStreak,Account.stats.currentStreak)):i.toDateString()!==e&&(Account.stats.currentStreak=1)}else Account.stats.currentStreak=1,Account.stats.longestStreak=Math.max(Account.stats.longestStreak,1);Account.stats.lastPlayedDate=e}checkTimeBasedConditions(){const e=new Date,t=e.getHours(),i=e.getDay();t>=5&&t<9&&(Account.stats.playedEarlyMorning=!0),t>=0&&t<4&&(Account.stats.playedAtNight=!0),0!==i&&6!==i||(Account.stats.playedWeekend=!0);const s=e.getMonth(),a=e.getDate();this.isHoliday(s,a)&&(Account.stats.playedHoliday=!0)}checkTimeBasedAchievements(){this.checkAchievements()}isHoliday(e,t){const i={0:[1],1:[14],2:[17],4:[5],5:[14],6:[4],8:[11],9:[31],10:[11,25],11:[24,25,31]};return i[e]&&i[e].includes(t)}startAutoSave(){setInterval(()=>{this.saveSessionState()},this.autoSaveInterval)}saveSessionState(){this.lastSaveTime=Date.now(),Account.stats.currentSessionStart&&(Account.stats.lastSessionSave=this.lastSaveTime)}setupWindowEvents(){document.addEventListener("visibilitychange",()=>{document.hidden?this.onPageHide():this.onPageShow()}),window.addEventListener("beforeunload",()=>{this.endSession()}),document.addEventListener("freeze",()=>{this.onPageHide()}),document.addEventListener("resume",()=>{this.onPageShow()})}onPageHide(){this.isTracking=!1,this.saveSessionState(),console.log("Page hidden - time tracking paused")}onPageShow(){this.isTracking||(this.lastUpdateTime=Date.now(),this.isTracking=!0,console.log("Page visible - time tracking resumed"))}endSession(){this.updateTimeStats(),this.timeUpdateInterval&&(clearInterval(this.timeUpdateInterval),this.timeUpdateInterval=null),Account.stats.totalPlaySessions>0&&(Account.stats.averageSessionTime=Math.floor(Account.stats.totalTimePlayed/Account.stats.totalPlaySessions)),Account.stats.currentSessionStart=null,Account.stats.lastSessionSave=null,this.isTracking=!1,this.sessionStartTime=null,console.log("Play session ended")}updateStats(e=null){if(!Account.stats)return;e&&this.updateGameStats(e);const t=Date.now();(!this.lastStreakUpdate||t-this.lastStreakUpdate>6e4)&&(this.updatePlayStreak(),this.lastStreakUpdate=t);const i=this.checkAchievements();return i.length>0&&console.log(`Unlocked ${i.length} new achievements`),i}updateGameStats(e){if(Account.settings.autoplay)return;Account.stats.totalGamesPlayed++,Account.stats.totalScore+=e.score,Account.stats.maxCombo=Math.max(Account.stats.maxCombo,e.maxCombo),e.accuracy>=100&&Account.stats.perfectGames++;const t=e.judgements||{};Account.stats.totalNotesHit+=Object.values(t).reduce((e,t)=>e+t,0),Account.stats.totalMarvelous+=t.marvelous||0,Account.stats.totalPerfect+=t.perfect||0,Account.stats.totalGreat+=t.great||0,Account.stats.totalGood+=t.good||0,Account.stats.totalBoo+=t.boo||0,Account.stats.totalMiss+=t.miss||0,Account.stats.maxMarvelousInGame=Math.max(Account.stats.maxMarvelousInGame,t.marvelous||0),Account.stats.maxSkillsInGame=Math.max(Account.stats.maxSkillsInGame,e.skillsUsed||0),e.character&&(Account.stats.maxCharacterLevel=Math.max(Account.stats.maxCharacterLevel,e.character.level||1),Account.stats.skillsUnlocked=Math.max(Account.stats.skillsUnlocked,e.character.unlockedSkills?.length||0))}checkAchievements(){const e=[];return ACHIEVEMENT_DEFINITIONS.forEach(t=>{if(!Account.achievements.unlocked[t.id]){t.condition(Account.stats)&&!Account.achievements.unlocked[t.id]&&(Account.achievements.unlocked[t.id]={unlockedAt:Date.now(),expReward:t.expReward},e.push(t),saveAccount(),notifications.showAchievement(t),this.awardAchievementExp(t))}}),this.newAchievements=e,e}awardAchievementExp(e){if(e.expReward>0){const t=new CharacterManager,i=t.getCurrentCharacter();if(i){i.addExperience(e.expReward);const{levelBefore:s,levelAfter:a,expBefore:n,expAfter:o}=i.getLastExperienceStoryEntry();t.saveToAccount()}}}getUnlockedAchievements(){return ACHIEVEMENT_DEFINITIONS.filter(e=>Account.achievements.unlocked[e.id])}getLockedAchievements(){return ACHIEVEMENT_DEFINITIONS.filter(e=>!Account.achievements.unlocked[e.id]&&!e.hidden)}getHiddenAchievements(){return ACHIEVEMENT_DEFINITIONS.filter(e=>e.hidden&&!Account.achievements.unlocked[e.id])}getAchievementProgress(e){return Account.achievements.progress[e]||0}getTotalUnlockedCount(){return Object.keys(Account.achievements.unlocked).length}getTotalAchievementsCount(){return ACHIEVEMENT_DEFINITIONS.length}getCompletionPercentage(){const e=this.getTotalAchievementsCount(),t=this.getTotalUnlockedCount();return e>0?Math.floor(t/e*100):0}getTimePlayedFormatted(){return this.formatTime(Account.stats.totalTimePlayed)}formatTime(e){const t=Math.floor(e/3600),i=Math.floor(e%3600/60),s=e%60;return t>0?`${t}h ${i}m ${s}s`:i>0?`${i}m ${s}s`:`${s}s`}getCurrentSessionTime(){return this.sessionStartTime?Math.floor((Date.now()-this.sessionStartTime)/1e3):0}update(){}forceSave(){this.saveSessionState()}destroy(){this.endSession(),document.removeEventListener("visibilitychange",this.onPageHide),document.removeEventListener("visibilitychange",this.onPageShow),document.removeEventListener("freeze",this.onPageHide),document.removeEventListener("resume",this.onPageShow),window.removeEventListener("beforeunload",this.endSession),console.log("Achievements Manager destroyed")}}class Text extends Phaser.Sprite{constructor(e,t,i="",s,a){s={font:"font_tiny",fontMap:" ABCDEFGHIJKLMNOPQRSTUVWXYZ.,:!?h+-*()[]/\\0123456789_'\"`<>=%",fontWidth:4,fontHeight:6,typewriter:!1,typewriterInterval:100,...s},super(game,e,t),this.config=s,this.texture=new Phaser.RetroFont(game,s.font,s.fontWidth,s.fontHeight,s.fontMap),this.texture.multiLine=!0,this.texture.autoUpperCase=!0,this.timer=game.time.create(!1),this.typewriterInterval=s.typewriterInterval,s.typewriter?this.typewriter(i):this.write(i),game.add.existing(this),a&&(a instanceof Phaser.Group?a.add(this):a instanceof PIXI.DisplayObjectContainer&&a.addChild(this))}write(e,t){return t&&e.length>t?this.scrollwrite(e,t):(this.timer.running&&this.timer.stop(),this.texture.text=e),this}typewrite(e,t){this.timer.running&&this.timer.stop();let i=0;return this.texture.text="",this.timer.loop(this.typewriterInterval,()=>{i<e.length?(this.write(this.texture.text+e[i]),i++):(t&&t(),this.timer.stop())}),this.timer.start(),this}scrollwrite(e,t=5,i=200,s=5){this.timer.running&&this.timer.stop();const a=e+" ".repeat(s);let n=0,o=!0;const r=()=>{if(!this.visible||!o)return;let e="";for(let i=0;i<t;i++){e+=a[(n+i)%a.length]}this.texture.text=e,n=(n+1)%a.length};return this.timer.loop(i,()=>r()),r(),this.timer.start(),{stop:()=>{o=!1,this.timer.stop()},pause:()=>{o=!1},resume:()=>{o=!0},setSpeed:e=>{i=e,this.timer.loopDelay=e}}}stopScrolling(){this.timer.running&&this.timer.stop()}isScrolling(){return this.timer.running}wrap(e,t=1){if(!this.texture.text)return this;const i=this.texture.text,s=this.config.fontWidth||4,a=Math.floor(e/s);if(a<=0)return this;const n=i.split(" "),o=[];let r="";for(let e=0;e<n.length;e++){const t=n[e],i=r?`${r} ${t}`:t;if(t.length>a){r&&(o.push(r),r="");let e="";for(let i=0;i<t.length;i++)e+=t[i],(e.length>=a||i===t.length-1)&&(o.push(e),e="");continue}i.length<=a?r=i:(o.push(r),r=t)}r&&o.push(r);const c=o.join("\n");return this.write(c),this}wrapPreserveNewlines(e,t=1){if(!this.texture.text)return this;const i=this.texture.text,s=this.config.fontWidth||4,a=Math.floor(e/s);if(a<=0)return this;const n=i.split("\n"),o=[];for(const e of n){if(e.length<=a){o.push(e);continue}const t=e.split(" ");let i="";for(let e=0;e<t.length;e++){const s=t[e];if(s.length>a){i&&(o.push(i),i="");let e="";for(let t=0;t<s.length;t++)e+=s[t],(e.length>=a||t===s.length-1)&&(o.push(e),e="");continue}const n=i?`${i} ${s}`:s;n.length<=a?i=n:(i&&o.push(i),i=s)}i&&o.push(i)}const r=o.join("\n");return this.write(r),this}getWrappedText(e){if(!this.texture.text)return"";const t=this.texture.text,i=this.config.fontWidth||4,s=Math.floor(e/i);if(s<=0)return t;const a=t.split(" "),n=[];let o="";for(let e=0;e<a.length;e++){const t=a[e];if(t.length>s){o&&(n.push(o),o="");let e="";for(let i=0;i<t.length;i++)e+=t[i],(e.length>=s||i===t.length-1)&&(n.push(e),e="");continue}const i=o?`${o} ${t}`:t;i.length<=s?o=i:(n.push(o),o=t)}return o&&n.push(o),n.join("\n")}}class Window extends Phaser.Sprite{constructor(e,t,i,s,a="1",n=null){super(game,8*e,8*t),this.size={width:i,height:s},this.offset={x:0,y:0},this.scrollOffset=0,this.itemOffset=1,this.visibleItems=s,this.selectedIndex=0,this.focus=!1,this.skin=a,this.font="default",this.fontTint=7797982,this.disableScrollBar=!1,n?n.addChild(this):game.add.existing(this),this.createWindowFrame(),this.selector=game.add.sprite(3,0,`ui_window_${a}`,9),this.selector.visible=!1,this.selector.animations.add("blink",[9,10],4,!0),this.selector.animations.play("blink"),this.addChild(this.selector),this.scrollBar=game.add.graphics(8*this.size.width-3,8),this.scrollBar.alpha=0,this.addChild(this.scrollBar),this.scrollBarTween=null,this.onSelect=new Phaser.Signal,this.onConfirm=new Phaser.Signal,this.onCancel=new Phaser.Signal,this.items=[],this.updateSelector()}createWindowFrame(){this.frameParts=[];for(let e=0;e<this.size.height;e++)for(let t=0;t<this.size.width;t++){let i=4;i=0===e?0===t?0:t>=this.size.width-1?2:1:e===this.size.height-1?0===t?6:t>=this.size.width-1?8:7:0===t?3:t>=this.size.width-1?5:4;const s=game.add.sprite(8*t,8*e,`ui_window_${this.skin}`,i);this.addChild(s),this.frameParts.push(s)}}addItem(e,t,i=null,s=!1){const a=new Text(8+this.offset.x,0,e,{...FONTS[this.font],tint:this.fontTint});this.addChild(a);const n=new Text(8*this.size.width-8-4,0,t,{...FONTS[this.font],tint:this.fontTint});n.anchor.x=1,a.addChild(n);const o={text:a,valueText:n,callback:i,backButton:s,type:"item",visible:!0,setText:e=>{a.write(e)},setValueText:e=>{n.write(e)}};return this.items.push(o),o}addSettingItem(e,t,i,s=null){const a=new Text(8+this.offset.x,0,e,{...FONTS[this.font],tint:this.fontTint});this.addChild(a),t=t.map(e=>Window.processMultilingual(e));const n=new Text(8*this.size.width-8-4,0,t[i].toString(),{...FONTS[this.font],tint:this.fontTint});n.anchor.x=1,a.addChild(n);const o={text:a,valueText:n,options:t,currentIndex:i,callback:s,type:"setting",visible:!0};return this.items.push(o),this.update(),o}static processMultilingual(e){if("string"!=typeof e)return e;return e=(e=e.replace(/([^|(]+\|\|[^|)]+)/g,e=>{const t=e.split("||");return t[SETTINGS.language]||t[0]})).replace(/\(([^)|]+)\|([^)]+)\)/g,(e,t,i)=>0===SETTINGS.language?t:i)}getVisibleHeight(e=0){return 8*this.size.height-(10+this.offset.y)}update(){const e=this.getVisibleHeight();this.visibleItems=Math.floor(e/8),this.visibleItems=Math.min(this.visibleItems,this.items.length),this.scrollOffset=Math.max(0,Math.min(this.scrollOffset,this.items.length-this.visibleItems));const t=8*this.visibleItems,i=(8*this.size.height-t)/2;this.items.forEach((e,t)=>{const s=t>=this.scrollOffset&&t<this.scrollOffset+this.visibleItems;if(e.text.visible=s,e.visible=s,e.text.tint=this.fontTint,e.valueText&&(e.valueText.tint=this.fontTint),s){const s=t-this.scrollOffset,a=i+8*s;e.text.y=a+this.offset.y}}),this.updateSelector()}updateSelector(){if(this.focus&&this.items.length>0&&this.selectedIndex>=this.scrollOffset&&this.selectedIndex<this.scrollOffset+this.visibleItems){const e=8*this.visibleItems,t=(8*this.size.height-e)/2+8*(this.selectedIndex-this.scrollOffset)+this.offset.y;this.selector.y=t,this.selector.visible=!0}else this.selector.visible=!1}updateScrollBar(){if(this.disableScrollBar)return;if(this.scrollBar.clear(),this.items.length<=this.visibleItems)return void this.hideScrollBar();const e=8*(this.size.height-2),t=this.items.length,i=Math.max(8,this.visibleItems/t*e),s=t-this.visibleItems,a=this.scrollOffset/s*(e-i);this.scrollBar.beginFill(this.fontTint,.8),this.scrollBar.drawRect(0,a,1,i),this.scrollBar.endFill(),this.showScrollBar()}showScrollBar(){this.scrollBarTween&&this.scrollBarTween.stop(),this.scrollBar.alpha=1,this.scrollBarTween=game.add.tween(this.scrollBar),this.scrollBarTween.to({alpha:0},1e3,Phaser.Easing.Quadratic.Out,!0,500).onComplete.add(()=>{this.scrollBarTween=null})}hideScrollBar(){this.scrollBarTween&&(this.scrollBarTween.stop(),this.scrollBarTween=null),this.scrollBar.alpha=0,this.scrollBar.clear()}adjustScroll(){this.selectedIndex<this.scrollOffset?this.scrollOffset=this.selectedIndex:this.selectedIndex>=this.scrollOffset+this.visibleItems&&(this.scrollOffset=this.selectedIndex-this.visibleItems+1)}navigate(e){if(0===this.items.length)return;let t=this.selectedIndex;switch(e){case"up":t=Math.max(0,this.selectedIndex-1);break;case"down":t=Math.min(this.items.length-1,this.selectedIndex+1);break;case"left":return void this.handleLeft();case"right":return void this.handleRight()}this.onSelect.dispatch(t,e),t!==this.selectedIndex&&(this.selectedIndex=t,this.adjustScroll(),this.updateScrollBar(),this.playNavSound())}handleLeft(){const e=this.items[this.selectedIndex];e&&("setting"===e.type?(e.currentIndex=(e.currentIndex-1+e.options.length)%e.options.length,e.valueText.write(e.options[e.currentIndex].toString()),e.callback&&e.callback(e.currentIndex,e.options[e.currentIndex]),this.playNavSound()):"toggle"===e.type&&(e.state=!e.state,e.toggleSwitch.animations.play(e.state?"on":"off"),e.callback&&e.callback(e.state),this.playNavSound()))}handleRight(){const e=this.items[this.selectedIndex];e&&("setting"===e.type?(e.currentIndex=(e.currentIndex+1)%e.options.length,e.valueText.write(e.options[e.currentIndex].toString()),e.callback&&e.callback(e.currentIndex,e.options[e.currentIndex]),this.playNavSound()):"toggle"===e.type&&(e.state=!e.state,e.toggleSwitch.animations.play(e.state?"on":"off"),e.callback&&e.callback(e.state),this.playNavSound()))}playNavSound(){}confirm(){if(this.items.length>0){const e=this.items[this.selectedIndex];return"item"===e.type?e.callback&&e.callback(this.items[this.selectedIndex]):this.handleRight(),!0}return this.onConfirm.dispatch(this.selectedIndex,this.items[this.selectedIndex]),!1}cancel(){this.items.forEach(e=>{e.backButton&&e.callback()}),this.onCancel.dispatch(this.selectedIndex)}clear(){this.items.forEach(e=>{e.text.destroy(),e.valueText&&e.valueText.destroy(),e.toggleText&&e.toggleText.destroy()}),this.scrollBarTween&&(this.scrollBarTween.stop(),this.scrollBarTween=null),this.frameParts.forEach(e=>e.destroy()),this.items=[],this.frameParts=[],this.selectedIndex=0,this.scrollOffset=0}show(){this.visible=!0}hide(){this.visible=!1}destroy(){this.clear(),super.destroy()}}class WindowManager{constructor(){this.windows=[],this.focusedWindow=null,this.lastUp=!1,this.lastDown=!1,this.lastConfirm=!1,this.lastCancel=!1}add(e){return this.windows.includes(e)||(this.windows.push(e),e.selector.visible=!1,1===this.windows.length&&this.focus(e)),e}show(e){e.show()}remove(e,t=!0){const i=this.windows.indexOf(e);return-1!==i&&(e===this.focusedWindow?(this.windows.splice(i,1),this.focusedWindow=this.windows.length>0?this.windows[this.windows.length-1]:null,this.focusedWindow&&(this.focusedWindow.selector.visible=!0)):this.windows.splice(i,1),t&&e.destroy(),!0)}focus(e,t=!0){return!(!e||!this.windows.includes(e))&&(this.focusedWindow&&(this.focusedWindow.focus=!1,t&&(this.focusedWindow.visible=!1),this.focusedWindow.selector.visible=!1),this.focusedWindow=e,e.focus=!0,e.selector.visible=!0,e.show(),!0)}unfocus(){this.focusedWindow=null}closeAll(){this.focusedWindow&&(this.focusedWindow.focus=!1,this.focusedWindow=null),this.windows.forEach(e=>e.hide())}update(){if(this.focusedWindow){const e=gamepad.pressed.up&&!this.lastUp,t=gamepad.pressed.down&&!this.lastDown,i=gamepad.pressed.left&&!this.lastDown,s=gamepad.pressed.right&&!this.lastDown,a=gamepad.pressed.a&&!this.lastConfirm,n=gamepad.pressed.b&&!this.lastCancel;e?this.focusedWindow.navigate("up"):t?this.focusedWindow.navigate("down"):i?this.focusedWindow.navigate("left"):s&&this.focusedWindow.navigate("right"),a&&this.focusedWindow.confirm(),n&&this.focusedWindow.cancel(),this.lastUp=gamepad.pressed.up,this.lastDown=gamepad.pressed.down,this.lastConfirm=gamepad.pressed.a,this.lastCancel=gamepad.pressed.b}}createWindow(e,t,i,s,a="1",n=null){const o=new Window(e,t,i,s,a,n);return this.add(o),o}clearAll(e=!1){e&&this.windows.forEach(e=>e.destroy()),this.windows=[],this.focusedWindow=null}bringToFront(e){return!!this.windows.includes(e)&&(e.bringToTop(),this.windows.splice(this.windows.indexOf(e),1),this.windows.push(e),!0)}}class CarouselMenu extends Phaser.Sprite{constructor(e,t,i,s,a={}){super(game,e,t),this.config={animate:!0,align:"left",bgcolor:"#3498db",fgcolor:"#ffffff",disableScrollBar:!1,disableConfirm:!1,disableCancel:!1,inactiveAlpha:.4,activeAlpha:.9,...a,margin:{top:4,bottom:4,left:4,right:4,...a.margin||{}}},this.viewport={width:i,height:s},this.items=[],this.selectedIndex=0,this.scrollOffset=0,this.itemHeight=8,this.itemSpacing=1,this.totalItemHeight=this.itemHeight+this.itemSpacing,this.visibleItems=Math.floor((s-this.config.margin.top-this.config.margin.bottom)/this.totalItemHeight),this.visibleItems=Math.max(1,this.visibleItems),this.isAnimating=!1,this.inputEnabled=!0,this.config.disableScrollBar||(this.scrollBar=game.add.graphics(this.viewport.width-3,this.config.margin.top),this.scrollBar.alpha=0,this.addChild(this.scrollBar),this.scrollBarTween=null),this.lastUp=!1,this.lastDown=!1,this.lastLeft=!1,this.lastRight=!1,this.lastConfirm=!1,this.lastCancel=!1,this.setupInput(),this.config.silent||game.add.existing(this)}setupInput(){gamepad.releaseAll(),this.onSelect=new Phaser.Signal,this.onConfirm=new Phaser.Signal,this.onCancel=new Phaser.Signal}addItem(e,t=null,i={}){const s={parent:null,background:null,text:null,textContent:e,callback:t,data:i,index:this.items.length,originalX:"right"===this.config.align?this.config.margin.right:this.config.margin.left,originalAlpha:this.config.inactiveAlpha,isSelected:!1,alphaTween:null};return this.items.push(s),this.updateSelection(),s}createItemVisuals(e,t){const i=e.index;let s=this.config.margin.left,a=e.initialY||this.config.margin.top+i*this.totalItemHeight;const n=e.data;e.initialY=null;const o=new Phaser.Sprite(game,s,a);o.alpha=this.config.inactiveAlpha,this.addChild(o);const r=this.viewport.width-this.config.margin.left-this.config.margin.right,c=this.itemHeight,l=this.createGradientBackground(r,c,n.bgcolor);l.x=e.originalX,o.addChild(l);const h="right"===this.config.align?r-8:8,d="right"===this.config.align?1:0,u=new Text(h,0,e.textContent,{...FONTS.default,tint:n.fgcolor||this.config.fgcolor});u.anchor.x=d,u.y=1,o.addChild(u),4*e.textContent.length>this.viewport.width-16&&u.write(e.textContent.substr(0,Math.floor(this.viewport.width-16)/4)),e.parent=o,e.background=l,e.text=u}removeItemVisuals(e){e.parent?.destroy(),e.parent=null,e.background=null,e.text=null}createGradientBackground(e,t,i){const s=game.add.bitmapData(e,t),a=s.context.createLinearGradient("right"===this.config.align?e:0,0,"right"===this.config.align?0:e,0),n=i||this.config.bgcolor;"right"===this.config.align?(a.addColorStop(0,"transparent"),a.addColorStop(.3,n),a.addColorStop(1,n)):(a.addColorStop(0,n),a.addColorStop(.7,n),a.addColorStop(1,"transparent")),s.context.fillStyle=a,s.context.fillRect(0,0,e,t);return game.add.sprite(0,0,s)}update(){this.inputEnabled&&(this.handleInput(),this.updateAnimations())}handleInput(){const e=gamepad.pressed.up&&!this.lastUp,t=gamepad.pressed.down&&!this.lastDown,i=gamepad.pressed.left&&!this.lastLeft,s=gamepad.pressed.right&&!this.lastRight,a=gamepad.pressed.a&&!this.lastConfirm,n=gamepad.pressed.b&&!this.lastCancel;e?this.navigate(-1):t?this.navigate(1):i?this.navigate(-1,!0):s&&this.navigate(1,!0),a&&this.items.length>0&&this.confirm(),n&&this.cancel(),this.lastUp=gamepad.pressed.up,this.lastDown=gamepad.pressed.down,this.lastLeft=gamepad.pressed.left,this.lastRight=gamepad.pressed.right,this.lastConfirm=gamepad.pressed.a,this.lastCancel=gamepad.pressed.b}navigate(e,t){if(0===this.items.length||this.isAnimating)return;let i=t?e*Math.max(1,this.visibleItems):e,s=this.selectedIndex+i;t?(s<0&&(s=0),s>this.items.length-1&&(s=this.items.length-1)):(s<0&&(s=this.items.length-1),s>this.items.length-1&&(s=0)),s!==this.selectedIndex&&(this.selectedIndex=s,this.updateSelection(),this.playNavSound(),this.onSelect.dispatch(this.selectedIndex,this.items[this.selectedIndex]),this.config.disableScrollBar||this.showScrollBar())}selectIndex(e){this.selectedIndex=e,this.updateSelection(),this.onSelect.dispatch(e,this.items[e])}updateSelection(){this.adjustScroll(),this.items.forEach((e,t)=>{const i=t===this.selectedIndex;t>=this.scrollOffset&&t<this.scrollOffset+this.visibleItems?(e.parent||this.createItemVisuals(e,i),i&&!e.isSelected?this.selectItem(e):!i&&e.isSelected&&this.deselectItem(e)):(e.parent&&this.removeItemVisuals(e),e.isSelected&&this.deselectItem(e))}),this.updateItemPositions(),this.config.disableScrollBar||this.updateScrollBar()}selectItem(e){const t=this.items.find(t=>t.isSelected&&t!==e);t&&this.deselectItem(t),e.isSelected=!0,e.alphaTween&&e.alphaTween.stop(),e.parent&&(this.config.animate?e.alphaTween=game.add.tween(e.parent).to({alpha:this.config.activeAlpha},250,Phaser.Easing.Quadratic.InOut,!0,0,-1,!0).yoyo(!0,500):e.parent.alpha=this.config.activeAlpha,e.text&&4*e.textContent.length>this.viewport.width-16&&e.text.scrollwrite(e.textContent,Math.floor(this.viewport.width-16)/4))}deselectItem(e){e.isSelected=!1,e.alphaTween&&(e.alphaTween.stop(),e.alphaTween=null),e.parent&&(this.config.animate?game.add.tween(e.parent).to({alpha:this.config.inactiveAlpha},100,Phaser.Easing.Quadratic.Out,!0):e.parent.alpha=this.config.inactiveAlpha,e.text&&e.text.isScrolling()&&(e.text.stopScrolling(),e.text.write(e.textContent.substr(0,Math.floor(this.viewport.width-16)/4))))}adjustScroll(){this.selectedIndex<this.scrollOffset?this.scrollOffset=this.selectedIndex:this.selectedIndex>=this.scrollOffset+this.visibleItems&&(this.scrollOffset=this.selectedIndex-this.visibleItems+1),this.scrollOffset=Phaser.Math.clamp(this.scrollOffset,0,Math.max(0,this.items.length-this.visibleItems))}updateScrollBar(){if(this.config.disableScrollBar)return;if(this.scrollBar.clear(),this.items.length<=this.visibleItems)return void this.hideScrollBar();const e=this.viewport.height-this.config.margin.top-this.config.margin.bottom,t=this.items.length,i=Math.max(8,this.visibleItems/t*e),s=t-this.visibleItems,a=this.scrollOffset/s*(e-i),n=Phaser.Color.hexToRGB(this.config.fgcolor);this.scrollBar.beginFill(n,.8),this.scrollBar.drawRect(0,a,1,i),this.scrollBar.endFill(),this.showScrollBar()}showScrollBar(){this.config.disableScrollBar||(this.scrollBarTween&&this.scrollBarTween.stop(),this.scrollBar.alpha=1,this.scrollBarTween=game.add.tween(this.scrollBar),this.scrollBarTween.to({alpha:0},1e3,Phaser.Easing.Quadratic.Out,!0,500).onComplete.add(()=>{this.scrollBarTween=null}))}hideScrollBar(){this.config.disableScrollBar||(this.scrollBarTween&&(this.scrollBarTween.stop(),this.scrollBarTween=null),this.scrollBar.alpha=0,this.scrollBar.clear())}updateItemPositions(){this.items.forEach((e,t)=>{const i=t-this.scrollOffset,s=this.config.margin.top+i*this.totalItemHeight;e.parent?this.config.animate&&!this.isAnimating?game.add.tween(e.parent).to({y:s},150,"Quad.easeOut",!0):e.parent.y=s:e.initialY=s})}updateAnimations(){}confirm(){if(0===this.items.length||this.isAnimating||this.config.disableConfirm)return;const e=this.items[this.selectedIndex];this.inputEnabled=!1,this.isAnimating=!0,this.animateSelection(e,()=>{this.onConfirm.dispatch(this.selectedIndex,e),e.callback?.(e),this.destroy()})}animateSelection(e,t){if(this.items.forEach(e=>{e.alphaTween&&(e.alphaTween.stop(),e.alphaTween=null)}),!e.parent)return;const i="right"===this.config.align?100:-100;this.items.forEach(t=>{t!==e&&t.parent&&t.parent.visible&&game.add.tween(t.parent).to({x:t.parent.x+i,alpha:0},500,"Quad.easeOut",!0)}),e.alphaTween&&e.alphaTween.stop(),e.parent.alpha=1;const s=this.viewport.width-this.config.margin.left-this.config.margin.right,a=this.itemHeight,n=this.createGradientBackground(s,a);n.x="right"===this.config.align?this.config.margin.right:this.config.margin.left,n.alpha=0,e.parent.addChild(n);game.add.tween(n).to({alpha:1},100,"Linear",!0).onComplete.addOnce(()=>{e.text.visible=!1;game.add.tween(e.parent).to({alpha:0},100,"Linear",!0).onComplete.addOnce(()=>{t?.()})})}animateCancel(e){this.items.forEach(e=>{e.alphaTween&&(e.alphaTween.stop(),e.alphaTween=null)});const t="right"===this.config.align?100:-100;this.items.forEach(e=>{e.parent&&e.parent.visible&&game.add.tween(e.parent).to({x:e.parent.x+t,alpha:0},500,"Quad.easeOut",!0)}),game.time.events.add(500,()=>e?.())}cancel(){(!this.isAnimating&&this.onCancel.getNumListeners()>0||this.config.disableCancel)&&this.animateCancel(()=>{this.onCancel.dispatch(),this.destroy()})}playNavSound(){}clear(){this.items.forEach(e=>{this.removeItemVisuals(e),e.alphaTween&&e.alphaTween.stop(),e.parent&&e.parent.destroy()}),this.items=[],this.selectedIndex=0,this.scrollOffset=0,!this.config.disableScrollBar&&this.scrollBarTween&&(this.scrollBarTween.stop(),this.scrollBarTween=null),this.onSelect.dispose(),this.onConfirm.dispose(),this.onCancel.dispose()}destroy(){this.clear(),super.destroy()}}class BackgroundGradient extends Phaser.Sprite{constructor(e=.1,t=.5,i=5e3){super(game,0,0,"ui_background_gradient"),this.alpha=e,game.add.tween(this).to({alpha:t},5e3,Phaser.Easing.Quadratic.InOut,!0).yoyo(!0).repeat(-1),game.add.existing(this)}}class Background extends Phaser.Sprite{constructor(e,t,i=.1,s=.5,a=5e3){super(game,0,0,e),this.alpha=i,t&&game.add.tween(this).to({alpha:s},5e3,Phaser.Easing.Quadratic.InOut,!0).yoyo(!0).repeat(-1),game.add.existing(this)}}class FuturisticLines extends Phaser.Sprite{constructor(){super(game,0,0),this.lines=[],this.maxLines=12,this.lineSpeed=1.2,this.tailLength=100,this.spawnRate=150,this.lastSpawnTime=0,this.lineColors=[7798015,4914430,58879,47316],this.lineAlpha=.3,this.graphics=game.add.graphics(0,0),this.addChild(this.graphics),game.add.existing(this)}update(){const e=game.time.now;this.lines.length<this.maxLines&&e-this.lastSpawnTime>this.spawnRate&&(this.spawnLine(),this.spawnRate=game.rnd.between(150,2e3),this.lastSpawnTime=e),this.updateLines(),this.drawLines()}spawnLine(){const e=game.rnd.integerInRange(10,game.height-10),t={x:-20,y:e,startY:e,points:[{x:-20,y:e}],color:game.rnd.pick(this.lineColors),speed:this.lineSpeed*game.rnd.realInRange(.9,1.1),direction:0,age:0,maxAge:1e4,active:!0,lastDirectionChange:0,nextDirectionChangeTime:game.rnd.integerInRange(1e3,5e3),state:"straight"};this.lines.push(t)}updateLines(){for(let e=this.lines.length-1;e>=0;e--){const t=this.lines[e];if(!t.active){this.lines.splice(e,1);continue}if(t.age+=game.time.elapsed,t.age>t.maxAge){t.active=!1;continue}t.age-t.lastDirectionChange>t.nextDirectionChangeTime&&this.changeLineDirection(t);const i=t.direction*(Math.PI/180),s=t.speed*Math.cos(i),a=t.speed*Math.sin(i);for(t.x+=s,t.y+=a,t.points.push({x:t.x,y:t.y});t.points.length>0&&t.points[0].x<t.x-this.tailLength;)t.points.shift();(t.x>game.width+100+this.tailLength||t.y<-50||t.y>game.height+50)&&(t.active=!1)}}changeLineDirection(e){e.lastDirectionChange=e.age,"straight"===e.state?(e.direction=game.rnd.pick([-45,45]),e.state="angled",e.nextDirectionChangeTime=game.rnd.integerInRange(100,500)):"angled"===e.state&&(e.direction=0,e.state="straight",e.nextDirectionChangeTime=game.rnd.integerInRange(1e3,5e3))}drawLines(){this.graphics.clear();for(const e of this.lines)!e.active||e.points.length<2||(this.drawTail(e),this.drawCap(e))}drawTail(e){const t=e.points;for(let i=1;i<t.length;i++){const s=t[i-1],a=t[i],n=i/t.length,o=i<=4?0:this.lineAlpha*(.9*n);this.graphics.lineStyle(1,e.color,o),this.graphics.moveTo(s.x,s.y),this.graphics.lineTo(a.x,a.y)}}drawCap(e){if(0===e.points.length)return;const t=e.points[e.points.length-1];this.graphics.beginFill(16777215,1.5*this.lineAlpha),this.graphics.drawRect(t.x,t.y,1,1),this.graphics.endFill()}setDensity(e){this.maxLines=Phaser.Math.clamp(e,1,15)}setSpeed(e){this.lineSpeed=Phaser.Math.clamp(e,.5,3)}setTailLength(e){this.tailLength=Phaser.Math.clamp(e,20,100)}clearLines(){this.lines=[],this.graphics.clear()}setColors(e){this.lineColors=e}setAlpha(e){this.lineAlpha=Phaser.Math.clamp(e,.1,.8)}destroy(){this.clearLines(),this.graphics.destroy(),super.destroy()}}class LoadingDots extends Phaser.Sprite{constructor(){super(game,game.width-2,game.height-2,"ui_loading_dots"),this.anchor.set(1),this.animations.add("loading",[0,1,2,3,4,3,2,1],8,!0),this.animations.play("loading"),game.add.existing(this)}}class Logo extends Phaser.Sprite{constructor(){super(game,game.width/2,game.height/2,null),this.anchor.set(.5),this.mainShape=this.addShape(),game.add.existing(this)}intro(e){this.mainShape.alpha=0,game.add.tween(this.mainShape).to({alpha:1},1e3,"Linear",!0).onComplete.addOnce(()=>{this.logoTween=game.add.tween(this.mainShape).to({alpha:.8},500,"Linear",!0).repeat(-1).yoyo(!0),e&&e()})}outro(e){this.effect(32,1e3);const t=this.addShape();t.alpha=1,game.add.tween(t).to({alpha:0},250,"Linear",!0),game.add.tween(t.scale).to({x:8,y:8},250,"Linear",!0),game.camera.flash(16777215,300),game.time.events.add(350,()=>game.camera.fade(16777215,1e3)),game.camera.onFadeComplete.addOnce(()=>e&&e())}effect(e=5,t=1e3,i=!1){let s=[];for(let a=0;a<e;a++){const n=this.addShape();n.alpha=0,n.scale.set(1+a/10),s.push(n),game.add.tween(n).to({alpha:1},t,"Linear",!0,(i?100*-e:0)+100*a).yoyo(!0)}}addShape(e=16777215,t=0,i=0){const s=game.add.sprite(t,i,"ui_logo_shape");return s.anchor.set(.5),s.tint=e,this.addChild(s),s}}class NavigationHint extends Phaser.Sprite{constructor(e=0){super(game,0,0),this.defaultFrame=e,this.lastInputSource=null,game.add.existing(this)}change(e){this.defaultFrame=e,this.frame=e,console.log(e)}hide(){this.visible=!1}show(){this.visible=!0}update(){gamepad&&(gamepad.lastInputSource!=this.lastInputSource&&(this.loadTexture("keyboard"==gamepad.lastInputSource?"ui_navigation_hint_keyboard":"ui_navigation_hint_gamepad"),this.frame=this.defaultFrame),this.lastInputSource=gamepad.lastInputSource)}}class ProgressText extends Text{constructor(e){super(4,game.height-4,e,FONTS.default),this.anchor.y=1}}class ExperienceBar extends Phaser.Sprite{constructor(e,t,i,s){super(game,e,t),this.barWidth=i,this.barHeight=s,this.progress=0,this.background=game.add.graphics(0,0),this.background.beginFill(3355443),this.background.drawRect(0,0,i,s),this.background.endFill(),this.addChild(this.background),this.bar=game.add.graphics(0,0),this.addChild(this.bar),this.border=game.add.graphics(0,0),this.border.lineStyle(1,16777215,1),this.border.drawRect(0,0,i,s),this.border.endFill(),this.addChild(this.border),this.updateBar(),game.add.existing(this)}setProgress(e){this.progress=Phaser.Math.clamp(e,0,1),this.updateBar()}updateBar(){this.bar.clear(),this.bar.beginFill(7797982),this.bar.drawRect(0,0,this.barWidth*this.progress,this.barHeight),this.bar.endFill()}destroy(){this.background.destroy(),this.bar.destroy(),this.border.destroy(),super.destroy()}}class SkillBar extends Phaser.Sprite{constructor(e,t){super(game,e,t),this.parts=[],this.visibleParts=5,this.value=5;for(let e=0,t=0;e<5;e++,t+=3){const e=game.add.sprite(t,0,"ui_skill_bar",0);this.addChild(e),this.parts.push(e)}game.add.existing(this)}update(){for(let e=1;e<=5;e++){const t=this.parts[e-1];t.visible=e<=this.visibleParts,t.frame=this.value>=e?0:1}}}class TextInput extends Phaser.Sprite{constructor(e="",t=6,i,s){super(game,96,28),this.anchor.x=.5,this.characterSet="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 ",this.window=new Window(0,0,t,2,"1",this),this.window.x-=this.window.size.width/2*8,this.stackedText=e,this.text="",this.currentIndex=0,this.maxLength=t,this.textLayer=new Text(3,5,e),this.textLayer.tint=this.window.fontTint,this.window.addChild(this.textLayer),this.cursor=game.add.graphics(0,1),this.cursor.beginFill(this.window.fontTint,1),this.cursor.drawRect(0,0,2,4),this.cursor.endFill(),this.textLayer.addChild(this.cursor),this.lastCursorBlinkTime=0,this.cursorVisible=!1,this.onConfirm=new Phaser.Signal,this.onCancel=new Phaser.Signal,i&&this.onConfirm.add(i),s&&this.onCancel.add(s),game.add.existing(this)}getCharacterToInsert(){return this.characterSet[this.currentIndex]}update(){const e=this.stackedText.length>=this.maxLength;this.text=e?this.stackedText:this.stackedText+this.getCharacterToInsert(),this.textLayer.write(this.text),this.cursor.x=4*this.text.length,this.cursor.visible=!e&&this.cursorVisible;let t=this.currentIndex;gamepad.pressed.up&&t--,gamepad.pressed.down&&t++,t<0&&(t=this.characterSet.length-1),t>this.characterSet.length-1&&(t=0),this.currentIndex=t,gamepad.pressed.a&&(e?this.confirm():this.stackedText+=this.getCharacterToInsert()),gamepad.pressed.b&&(this.stackedText.length>0?this.stackedText=this.stackedText.substr(0,this.stackedText.length-1):this.cancel()),game.time.now-this.lastCursorBlinkTime>=350&&(this.cursorVisible=!this.cursorVisible,this.lastCursorBlinkTime=game.time.now),gamepad.pressed.start&&this.confirm(),gamepad.pressed.select&&this.cancel()}confirm(){this.onConfirm.dispatch(this.text),this.destroy()}cancel(){this.onCancel.dispatch(this.text),this.destroy()}destroy(){super.destroy(),this.onConfirm.dispose()}}class NotificationSystem{constructor(){this.queue=[],this.isShowing=!1,this.currentNotification=null,this.duration=3e3,this.lineHeight=8,this.padding=8,this.maxLineWidth=160,this.charWidth=4,this.notificationWindow=null,this.notificationTexts=null,this.restrictedStates=new Set(["Title","Play","Load","LoadLocalSongs","LoadExternalSongs","LoadSongFolder","Boot"]),this.allowedStates=new Set(["MainMenu","SongSelect","Results","CharacterSelect","Jukebox","AchievementsMenu","StatsMenu"]),this.setupStateChangeHandling()}setupStateChangeHandling(){const e=game.state.start;game.state.start=function(t,i,s,...a){return notifications&&notifications.isShowing&&notifications.preserveCurrentNotification(),e.call(this,t,i,s,...a)},game.state.onStateChange.add(this.onStateChange,this)}onStateChange(e){game.time.events.add(100,()=>{const e=game.state.getCurrentState(),t=e?.constructor?.name||"";this.isStateAllowed(t)&&this.processPendingNotifications(),this.preservedNotification&&this.restorePreservedNotification()})}show(e,t=2e3){const i=game.state.getCurrentState(),s=i?.constructor?.name||"",a=this.wrapText(e);this.queue.push({type:"text",text:a,originalText:e,duration:t,endTime:Date.now()+t,queuedInState:s}),this.isStateAllowed(s)&&!this.isShowing&&this.processNext()}showAchievement(e,t=0){const i=game.state.getCurrentState(),s=i?.constructor?.name||"";this.queue.push({type:"achievement",text:`Achievement Unlocked!\n${e.name}\n${e.description.achieved}`,duration:2500,endTime:Date.now()+2500,queuedInState:s}),this.isStateAllowed(s)&&!this.isShowing&&this.processNext()}showExpGain(e,t,i,s,a,n){const o=game.state.getCurrentState(),r=o?.constructor?.name||"";this.queue.push({type:"exp",character:e,expGain:t,levelBefore:i,levelAfter:s,expBefore:a,expAfter:n,duration:5e3,endTime:Date.now()+5e3,queuedInState:r}),this.isStateAllowed(r)&&!this.isShowing&&this.processNext()}processPendingNotifications(){this.queue.length>0&&!this.isShowing&&this.processNext()}processNext(){const e=game.state.getCurrentState(),t=e?.constructor?.name||"";if(!this.isStateAllowed(t))return;if(0===this.queue.length)return void(this.isShowing=!1);this.isShowing=!0;const i=this.queue.shift();switch(this.currentNotification=i,i.type){case"achievement":case"text":default:this.displayTextNotification(i.text);break;case"exp":this.displayExpNotification(i)}game.time.events.add(i.duration,()=>{this.hideCurrent()})}displayTextNotification(e){const t=e.split("\n"),i=t.length,s=Math.min(this.maxLineWidth,Math.max(...t.map(e=>this.getTextWidth(e)))),a=Math.floor(Math.min(180,s+2*this.padding)),n=Math.floor(i*this.lineHeight+2*this.padding),o=(game.width-a)/2;this.notificationWindow=new Window(o/8,.5,a/8,n/8,"1"),this.notificationWindow.focus=!1,this.notificationWindow.selector.visible=!1,this.notificationTexts=[],t.forEach((e,t)=>{const i=new Text(a/2,this.padding+t*this.lineHeight+this.lineHeight/2,e,{...FONTS.default,tint:7797982});i.anchor.set(.5),this.notificationWindow.addChild(i),this.notificationTexts.push(i)}),this.notificationWindow.alpha=0,game.add.tween(this.notificationWindow).to({alpha:1},300,"Linear",!0)}displayExpNotification(e){const t=140,i=(game.width-t)/2;this.notificationWindow=new Window(i/8,.5,17.5,5,"1"),this.notificationWindow.focus=!1,this.notificationWindow.selector.visible=!1;const s=new Text(70,7,"EXPERIENCE GAIN!",{...FONTS.default,tint:7797982});s.anchor.set(.5),this.notificationWindow.addChild(s);const a=new Text(70,14,`${e.character.name} - Level ${e.levelBefore}`,{...FONTS.default,tint:16777215});a.anchor.set(.5),this.notificationWindow.addChild(a);const n=new Text(70,22,`+${e.expGain} EXP`,{...FONTS.default,tint:16777215});n.anchor.set(.5),this.notificationWindow.addChild(n);const o=game.add.graphics(20,30);o.beginFill(3355443),o.drawRect(0,0,100,4),o.endFill(),this.notificationWindow.addChild(o);const r=game.add.graphics(20,30);r.beginFill(7797982),this.notificationWindow.addChild(r),this.notificationWindow.alpha=0,game.add.tween(this.notificationWindow).to({alpha:1},300,"Linear",!0),this.animateExpBar(e,r,100)}animateExpBar(e,t,i){const s=CHARACTER_SYSTEM.EXPERIENCE_CURVE;let a=e.expBefore,n=e.levelBefore;const o=e.expAfter,r=e.levelAfter,c=()=>{if(n<r||a<o){a<s(n)?a++:(a=0,n++,this.showLevelUpEffect(n));const e=a/s(n);t.clear(),t.beginFill(7797982),t.drawRect(0,0,i*e,4),t.endFill(),game.time.events.add(30,c)}};game.time.events.add(500,c)}showLevelUpEffect(e){const t=new Text(game.width/2,game.height/2,`LEVEL UP! ${e}`,{...FONTS.shaded,tint:16766720});t.anchor.set(.5),t.alpha=0,t.scale.set(1.5),game.world.add(t);game.add.tween(t).to({alpha:1,scale:{x:2,y:2}},400,Phaser.Easing.Back.Out,!0).onComplete.add(()=>{game.add.tween(t).to({alpha:0,y:t.y-20},600,Phaser.Easing.Cubic.In,!0).onComplete.add(()=>{t.destroy()})})}wrapText(e){const t=e.split("\n"),i=[];for(let e of t){if(this.getTextWidth(e)<=this.maxLineWidth){i.push(e);continue}let t="";const s=e.split(" ");for(let e of s){if(this.getTextWidth(e)>this.maxLineWidth){t&&(i.push(t.trim()),t="");const s=this.breakLongWord(e);i.push(...s);continue}const s=t?`${t} ${e}`:e;this.getTextWidth(s)<=this.maxLineWidth?t=s:(t&&i.push(t.trim()),t=e)}t&&i.push(t.trim())}return i.join("\n")}breakLongWord(e){const t=[];let i="";for(let s=0;s<e.length;s++)i+=e[s],this.getTextWidth(i+(e[s+1]||""))>this.maxLineWidth&&(t.push(i),i="");return i&&t.push(i),t}getTextWidth(e){return e.length*this.charWidth}preserveCurrentNotification(){this.currentNotification&&this.notificationWindow&&(this.preservedNotification={...this.currentNotification,remainingTime:this.currentNotification.endTime-Date.now()},this.cleanupUI())}restorePreservedNotification(){if(this.preservedNotification){const e=game.state.getCurrentState(),t=e?.constructor?.name||"";if(!this.isStateAllowed(t))return;const i=this.preservedNotification;switch(i.type){case"achievement":case"text":default:this.displayTextNotification(i.text);break;case"exp":this.displayExpNotification(i)}this.isShowing=!0;const s=Math.max(500,i.remainingTime);game.time.events.add(s,()=>{this.hideCurrent()}),this.currentNotification={...i,duration:s,endTime:Date.now()+s},this.preservedNotification=null}}hideCurrent(){if(this.currentNotification&&this.notificationWindow){game.add.tween(this.notificationWindow).to({alpha:0},300,"Linear",!0).onComplete.add(()=>{this.cleanupUI(),this.currentNotification=null;const e=game.state.getCurrentState(),t=e?.constructor?.name||"";this.isStateAllowed(t)&&this.processNext()})}}cleanupUI(){this.notificationWindow&&(this.notificationWindow.destroy(),this.notificationWindow=null),this.notificationTexts&&(this.notificationTexts.forEach(e=>e.destroy()),this.notificationTexts=null)}isStateAllowed(e){return this.allowedStates.has(e)}clear(){this.queue=[],this.currentNotification&&this.hideCurrent(),this.preservedNotification=null}destroy(){this.clear(),game.state.onStateChange.remove(this.onStateChange,this)}}class Lyrics{constructor(e={}){this.textElement=e.textElement||null,this.maxLineLength=e.maxLineLength||30,this.currentTime=0,this.lrcData=[],this.rangeLrc=[],this.currentLineIndex=-1,e.lrc&&this.setLrc(e.lrc)}setLrc(e){this.tags={},this.lrcData=[],this.rangeLrc=[],this.currentLineIndex=-1;const t=/\[([a-z]+):(.*)\].*/,i=/(\[[0-9.:\[\]]*\])+(.*)/,s=/\[([0-9]+):([0-9.]+)\]/,a=e.split(/[\r\n]/);for(let e=0;e<a.length;e++){const n=t.exec(a[e]);if(n&&n[0]){this.tags[n[1]]=n[2];continue}const o=i.exec(a[e]);if(o&&o[0]){const e=o[1].replace(/\]\[/g,"],[").split(","),t=o[2].trim();for(let i=0;i<e.length;i++){const a=s.exec(e[i]);if(a&&a[0]){const e=60*parseInt(a[1],10)+parseFloat(a[2]);this.lrcData.push({startTime:e,line:t})}}}}this.lrcData.sort((e,t)=>e.startTime-t.startTime);let n=0,o="";for(let e=0;e<this.lrcData.length;e++){const t=this.lrcData[e].startTime;this.rangeLrc.push({startTime:n,endTime:t,line:o}),n=t,o=this.lrcData[e].line}this.rangeLrc.push({startTime:n,endTime:Number.MAX_SAFE_INTEGER,line:o})}move(e){this.currentTime=e;for(let t=0;t<this.rangeLrc.length;t++)if(e>=this.rangeLrc[t].startTime&&e<this.rangeLrc[t].endTime)return void(this.currentLineIndex!==t&&this.textElement&&(this.currentLineIndex=t,this.displayCurrentLine()));-1!==this.currentLineIndex&&this.textElement&&(this.currentLineIndex=-1,this.textElement.write(""))}displayCurrentLine(){if(!this.textElement||this.currentLineIndex<0)return;const e=this.rangeLrc[this.currentLineIndex].line.trim();e?(this.textElement.isScrolling&&this.textElement.stopScrolling&&this.textElement.stopScrolling(),this.textElement.write(e),e.length>this.maxLineLength&&this.textElement.wrap(5*this.maxLineLength)):this.textElement.write("")}getCurrentLine(){return this.currentLineIndex>=0&&this.currentLineIndex<this.rangeLrc.length?this.rangeLrc[this.currentLineIndex].line:""}getNextLine(){const e=this.currentLineIndex+1;return e<this.rangeLrc.length?this.rangeLrc[e].line:""}hasLyrics(){return this.lrcData.length>0}clear(){this.textElement&&this.textElement.write(""),this.currentLineIndex=-1,this.lrcData=[],this.rangeLrc=[]}destroy(){this.clear(),this.textElement=null}}class OffsetAssistant extends Phaser.Sprite{constructor(e){super(e,0,0),this.taps=[],this.confidenceThreshold=.8,this.maxTaps=16,this.requiredTaps=8,this.tickBPM=120,this.tickInterval=6e4/this.tickBPM,this.wasMusicPlaying=backgroundMusic&&backgroundMusic.isPlaying,this.originalMusicTime=0,this.pauseBackgroundMusic(),this.startTickSound(),this.background=e.add.graphics(0,0),this.background.beginFill(0,.8),this.background.drawRect(0,0,e.width,e.height),this.background.endFill(),this.addChild(this.background),this.instructionText=new Text(e.width/2,e.height/2-20,"TAP A TO THE TICK",FONTS.shaded),this.instructionText.anchor.set(.5),this.addChild(this.instructionText),this.offsetText=new Text(e.width/2,e.height/2+10,"Offset: 0ms",FONTS.default),this.offsetText.anchor.set(.5),this.addChild(this.offsetText),this.tapCounter=new Text(e.width/2,e.height/2+30,"Taps: 0",FONTS.default),this.tapCounter.anchor.set(.5),this.tapCounter.alpha=.7,this.addChild(this.tapCounter),this.exitText=new Text(e.width/2,e.height-10,"Press B to exit and save",FONTS.default),this.exitText.anchor.set(.5),this.exitText.alpha=.5,this.addChild(this.exitText),this.lastAPress=!1,this.lastBPress=!1,this.lastTickTime=0,this.nextTickTime=this.game.time.now,this.calculatedOffsets=[]}update(){gamepad.pressed.a&&!this.lastAPress&&this.onTap(),this.lastAPress=gamepad.pressed.a,gamepad.pressed.b&&!this.lastBPress&&this.exit(),this.lastBPress=gamepad.pressed.b,this.updateTickSound(),this.tapCounter.write(`Taps: ${this.taps.length}`)}pauseBackgroundMusic(){backgroundMusic&&backgroundMusic.isPlaying&&(this.originalMusicTime=backgroundMusic.audio.currentTime,backgroundMusic.stop())}resumeBackgroundMusic(){backgroundMusic&&this.wasMusicPlaying&&(backgroundMusic.audio.currentTime=this.originalMusicTime,backgroundMusic.audio.play())}startTickSound(){game.cache.checkSoundKey("assist_tick")?(this.playTickSound(),this.lastTickTime=this.game.time.now,this.nextTickTime=this.lastTickTime+this.tickInterval):console.warn("Tick sound not preloaded!")}updateTickSound(){if(this.destroyed)return;const e=this.game.time.now;e>=this.nextTickTime&&(this.playTickSound(),this.lastTickTime=e,this.nextTickTime=e+this.tickInterval)}playTickSound(){if(game.cache.checkSoundKey("assist_tick")){const e=game.add.audio("assist_tick");e.volume=.5,e.play()}}onTap(){const e=this.game.time.now;this.taps.push(e),this.taps.length>this.maxTaps&&this.taps.shift(),this.calculateOffset(),this.showTapFeedback()}calculateOffset(){if(this.taps.length<2)return this.offsetText.write("Offset: 0ms"),void(this.offsetText.tint=16777215);const e=[];for(let t=0;t<this.taps.length;t++){const i=this.taps[t],s=Math.round((i-this.taps[0])/this.tickInterval),a=i-(this.taps[0]+s*this.tickInterval);e.push(a)}const t=e.reduce((e,t)=>e+t,0)/e.length,i=25*Math.round(t/25);this.calculatedOffsets.push(i),this.calculatedOffsets.length>5&&this.calculatedOffsets.shift();const s=this.calculatedOffsets.length>0?25*Math.round(this.calculatedOffsets.reduce((e,t)=>e+t,0)/this.calculatedOffsets.length/25):i,a=this.calculateConfidence(e),n=`Offset: ${s}ms`;this.offsetText.write(n),this.taps.length>=this.requiredTaps&&a>=this.confidenceThreshold?this.offsetText.tint=65280:this.taps.length>=4?this.offsetText.tint=16776960:this.offsetText.tint=16777215}calculateConfidence(e){if(e.length<3)return 0;const t=e.reduce((e,t)=>e+t,0)/e.length,i=e.reduce((e,i)=>e+Math.pow(i-t,2),0)/e.length,s=Math.sqrt(i),a=Math.max(0,1-s/50);return Math.min(1,a)}roundToNearestMultipleOf25(e){const t=Math.round(e/25);return t>=0?25*t:25*(t+1)}showTapFeedback(){this.game.add.tween(this.instructionText.scale).to({x:1.1,y:1.1},50,Phaser.Easing.Quadratic.Out,!0).yoyo(!0)}exit(){let e=0;if(this.calculatedOffsets.length>0)e=this.roundToNearestMultipleOf25(this.calculatedOffsets.reduce((e,t)=>e+t,0)/this.calculatedOffsets.length),Account.settings.userOffset=e,saveAccount(),notifications.show(`Offset set to ${e}ms`);else if(this.taps.length>0){const e=this.parseOffsetText();null!==e&&(Account.settings.userOffset=e,saveAccount(),notifications.show(`Offset set to ${e}ms`))}this.resumeBackgroundMusic(),this.destroy(),game.state.getCurrentState().menu()}parseOffsetText(){const e=this.offsetText.text.match(/Offset: (-?\d+)ms/);return e?parseInt(e[1],10):null}destroy(){this.resumeBackgroundMusic(),this.destroyed=!0,this.background.destroy(),this.instructionText.destroy(),this.offsetText.destroy(),this.tapCounter.destroy(),this.exitText.destroy(),super.destroy()}}class FileSystemTools{constructor(){this.platform=this.detectPlatform(),"nwjs"===this.platform?this.fileSystem=new NodeFileSystem:"cordova"===this.platform?this.fileSystem=new CordovaFileSystem:this.fileSystem=new FallbackFileSystem,console.log(`FileSystem: Using ${this.platform} implementation`)}detectPlatform(){return"undefined"!=typeof nw&&nw.process?"nwjs":"undefined"!=typeof cordova&&cordova.file?"cordova":"fallback"}getDirectory(e){return this.fileSystem.getDirectory(e)}listDirectories(e){return this.fileSystem.listDirectories(e)}listAllDirectories(e){return this.fileSystem.listAllDirectories(e)}listFiles(e){return this.fileSystem.listFiles(e)}getFile(e){return this.fileSystem.getFile(e)}readFileContent(e){return this.fileSystem.readFileContent(e)}saveFile(e,t,i){return this.fileSystem.saveFile(e,t,i)}createEmptyFile(e,t,i){return this.fileSystem.createEmptyFile(e,t,i)}writeFile(e,t,i){return this.fileSystem.writeFile(e,t,i)}createDirectory(e,t){return this.fileSystem.createDirectory(e,t)}getBasePath(){return"nwjs"===this.platform&&this.fileSystem.getBasePath?this.fileSystem.getBasePath():""}canExitApp(){return"nwjs"===this.platform||"cordova"===this.platform}exitApp(){"nwjs"===this.platform?"undefined"!=typeof nw&&nw.App&&nw.App.quit():"cordova"===this.platform&&"undefined"!=typeof navigator&&navigator.app&&navigator.app.exitApp()}}class NodeDirectoryEntry{constructor(e,t,i,s){this.isFile=!1,this.isDirectory=!0,this.name=e,this.fullPath=t,this.filesystem=i,this.nativeURL=s||`file://${t}`}createReader(){const e=require("fs"),t=require("path"),i=t.join(this.filesystem.basePath,this.fullPath);return{readEntries:(s,a)=>{try{const a=[],n=e.readdirSync(i);for(const s of n){const n=t.join(i,s),o=e.statSync(n),r=t.join(this.fullPath,s);o.isDirectory()?a.push(new NodeDirectoryEntry(s,r,this.filesystem,`file://${n}`)):a.push(new NodeFileEntry(s,r,this.filesystem,`file://${n}`))}s(a)}catch(e){a(e)}}}}getDirectory(e,t,i,s){const a=require("fs"),n=require("path"),o=n.join(this.filesystem.basePath,this.fullPath,e);try{if(!a.existsSync(o)){if(!t||!t.create)throw new Error(`Directory not found: ${e}`);a.mkdirSync(o,{recursive:!0})}if(!a.statSync(o).isDirectory())throw new Error(`Path is not a directory: ${e}`);i(new NodeDirectoryEntry(n.basename(e),n.join(this.fullPath,e),this.filesystem,`file://${o}`))}catch(e){s(e)}}getFile(e,t,i,s){const a=require("fs"),n=require("path"),o=n.join(this.filesystem.basePath,this.fullPath,e);try{if(!a.existsSync(o)){if(!t||!t.create)throw new Error(`File not found: ${e}`);a.writeFileSync(o,"")}if(!a.statSync(o).isFile())throw new Error(`Path is not a file: ${e}`);i(new NodeFileEntry(n.basename(e),n.join(this.fullPath,e),this.filesystem,`file://${o}`))}catch(e){s(e)}}removeRecursively(e,t){const i=require("fs"),s=require("path"),a=s.join(this.filesystem.basePath,this.fullPath);try{const t=e=>{if(i.existsSync(e)){const a=i.readdirSync(e);for(const n of a){const a=s.join(e,n);i.statSync(a).isDirectory()?t(a):i.unlinkSync(a)}i.rmdirSync(e)}};t(a),e()}catch(e){t(e)}}}class NodeFileEntry{constructor(e,t,i,s){this.isFile=!0,this.isDirectory=!1,this.name=e,this.fullPath=t,this.filesystem=i,this.nativeURL=s||`file://${t}`}createWriter(e,t){const i=require("fs"),s=require("path").join(this.filesystem.basePath,this.fullPath);try{e({write:e=>{try{if(e instanceof Blob){const a=new FileReader;a.onload=()=>{i.writeFileSync(s,Buffer.from(a.result))},a.onerror=()=>t(a.error),a.readAsArrayBuffer(e)}else"string"==typeof e?i.writeFileSync(s,e):e instanceof ArrayBuffer?i.writeFileSync(s,Buffer.from(e)):i.writeFileSync(s,e)}catch(e){t(e)}}})}catch(e){t(e)}}file(e,t){const i=require("fs"),s=require("path").join(this.filesystem.basePath,this.fullPath);try{const t=i.statSync(s),a={name:this.name,size:t.size,type:this.getMimeType(this.name),lastModified:t.mtime,slice:(e,t)=>i.readFileSync(s).slice(e,t),localURL:s};a._path=s,e(a)}catch(e){t(e)}}getMimeType(e){return{png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",bmp:"image/bmp",mp3:"audio/mpeg",wav:"audio/wav",ogg:"audio/ogg",mp4:"video/mp4",avi:"video/x-msvideo",mov:"video/quicktime",sm:"text/plain",ssc:"text/plain",json:"application/json",txt:"text/plain"}[e.split(".").pop().toLowerCase()]||"application/octet-stream"}}class NodeFileSystem{constructor(){try{this.fs=require("fs"),this.path=require("path"),this.basePath=this.getBasePath(),this.fileSystemObj={name:"nodefs",root:new NodeDirectoryEntry("","/",this,`file://${this.basePath}`)}}catch(e){throw console.error("Node.js modules not available:",e),e}}getBasePath(){return"undefined"!=typeof nw&&nw.process?nw.process.cwd():"undefined"!=typeof process&&process.cwd?process.cwd():"."}getDirectory(e){return new Promise((t,i)=>{const s=this.path.join(this.basePath,e);this.fs.stat(s,(a,n)=>{if(a)return void i(a);if(!n.isDirectory())return void i(new Error(`Path is not a directory: ${e}`));const o=new NodeDirectoryEntry(this.path.basename(e)||".",e,this,`file://${s}`);t(o)})})}listDirectories(e){return new Promise((t,i)=>{e.createReader().readEntries(e=>t(e.filter(e=>e.isDirectory)),e=>i(e))})}listAllDirectories(e){return new Promise(async t=>{const i=[],s=[e];for(;s.length;){const e=s.shift();try{const t=await this.listDirectories(e);i.push(...t),s.push(...t)}catch(t){console.warn(`Error listing directories in ${e.name}:`,t)}}t(i)})}listFiles(e){return new Promise((t,i)=>{e.createReader().readEntries(e=>t(e.filter(e=>e.isFile)),e=>i(e))})}getFile(e){return new Promise((t,i)=>{e.file(e=>t(e),e=>i(e))})}readFileContent(e){return new Promise((t,i)=>{if(e._path)this.fs.readFile(e._path,"utf8",(e,s)=>{e?i(e):t(s)});else{const s=new FileReader;s.onload=()=>t(s.result),s.onerror=()=>i(s.error),s.readAsText(e)}})}saveFile(e,t,i){return new Promise((t,s)=>{e.getFile(i,{create:!0,exclusive:!1},e=>t(e),e=>s(e))})}createEmptyFile(e,t,i){return new Promise((i,s)=>{e.getFile(t,{create:!0,exclusive:!1},e=>i(e),e=>s(e))})}writeFile(e,t,i){return new Promise((i,s)=>{e.createWriter(e=>{e.write(t),i(e)},e=>s(e))})}createDirectory(e,t){return new Promise((i,s)=>{e.getDirectory(t,{create:!0},e=>i(e),e=>s(e))})}}class CordovaFileSystem{getDirectory(e){return new Promise((t,i)=>{let s=LocalFileSystem.PERSISTENT;game.device.windows?s=cordova.file.dataDirectory:game.device.macOS||game.device.iOS?s=cordova.file.documentsDirectory:game.device.android&&(s=cordova.file.externalRootDirectory),window.resolveLocalFileSystemURL(s+e,e=>t(e),e=>i(e))})}listDirectories(e){return new Promise((t,i)=>{e.createReader().readEntries(e=>t(e.filter(e=>e.isDirectory)),e=>i(e))})}listAllDirectories(e){return new Promise(async t=>{const i=[],s=[e];for(;s.length;){const e=s.shift();try{const t=await this.listDirectories(e);i.push(...t),s.push(...t)}catch(t){console.warn(`Error listing directories in ${e.name}:`,t)}}t(i)})}listFiles(e){return new Promise((t,i)=>{e.createReader().readEntries(e=>t(e.filter(e=>e.isFile)),e=>i(e))})}getFile(e){return new Promise((t,i)=>{e.file(e=>t(e),e=>i(e))})}readFileContent(e){return new Promise((t,i)=>{const s=new FileReader;s.onload=()=>t(s.result),s.onerror=()=>i(s.error),s.readAsText(e)})}saveFile(e,t,i){return new Promise((s,a)=>{e.getFile(i,{create:!0,exclusive:!1},e=>{this.writeFile(e,t).then(()=>s(e)).catch(e=>a(e))},e=>a(e))})}createEmptyFile(e,t,i){return new Promise((s,a)=>{e.getFile(t,{create:!0,exclusive:!1},e=>{this.writeFile(e,null,i).then(()=>s(e)).catch(e=>a(e))},e=>a(e))})}writeFile(e,t,i){return new Promise((i,s)=>{e.createWriter(e=>{e.onwrite=()=>i(e),e.onerror=e=>s(e),e.write(t)})})}createDirectory(e,t){return new Promise((i,s)=>{e.getDirectory(t,{create:!0},e=>{i(e)},e=>s(e))})}}class FallbackFileSystem{getDirectory(e){return Promise.reject(new Error("File system not available in this environment"))}listDirectories(e){return Promise.reject(new Error("File system not available in this environment"))}listAllDirectories(e){return Promise.reject(new Error("File system not available in this environment"))}listFiles(e){return Promise.reject(new Error("File system not available in this environment"))}getFile(e){return Promise.reject(new Error("File system not available in this environment"))}readFileContent(e){return Promise.reject(new Error("File system not available in this environment"))}saveFile(e,t,i){return Promise.reject(new Error("File system not available in this environment"))}createEmptyFile(e,t,i){return Promise.reject(new Error("File system not available in this environment"))}writeFile(e,t,i){return Promise.reject(new Error("File system not available in this environment"))}createDirectory(e,t){return Promise.reject(new Error("File system not available in this environment"))}}let game,gamepad,backgroundMusic,notifications,addonManager,sidebarNotifications,achievementsManager,Account={...DEFAULT_ACCOUNT,...JSON.parse(localStorage.getItem("Account")||"{}")};const saveAccount=()=>localStorage.setItem("Account",JSON.stringify(Account)),bootGame=()=>{game&&game.destroy(),game=new Phaser.Game({width:192,height:112,renderer:Account.settings.renderer,scaleMode:Phaser.ScaleManager.SHOW_ALL,crisp:Account.settings.pixelated,antialias:!1,alignV:!1,alignH:!0,enableDebug:!1,failIfMajorPerformanceCaveat:!1,forceSetTimeOut:!1,clearBeforeRender:!0,forceSingleUpdate:!1,maxPointers:0,keyboard:!0,mouse:!1,mouseWheel:!1,mspointer:!1,multiTexture:!1,pointerLock:!1,preserveDrawingBuffer:!1,roundPixels:!0,touch:!1,transparent:!1,parent:"game",state:{create(){game.state.add("Boot",Boot),game.state.start("Boot"),game.recorder=new ScreenRecorder(game)}},...window.GameConfig||{}})};window.onload=bootGame;const addFpsText=()=>{const e=new Text(190,2,"");e.anchor.x=1,game.time.events.loop(100,()=>e.write(`${game.time.fps} (${game.renderer.renderSession.drawCount-1})`))},Audio={pool:{},add:function(e,t=1,i=!1,s=!0){return s&&this.pool[e]||(this.pool[e]=game.add.audio(e)),this.pool[e]},play:function(e,t=1,i=!1,s=!0){if(game)return s&&this.pool[e]||(this.pool[e]=game.add.audio(e)),this.pool[e].play(null,0,t,i,s)},stop:function(e,t){if(game){const i=this.pool[e];return void(i&&(t?i.stop():(i.fadeOut(),i.onFadeComplete.addOnce(()=>i.stop()))))}}};class Gamepad{constructor(e){this.game=e,this.keys=["up","down","left","right","a","b","select","start"],this.held={},this.pressed={},this.released={},this.prevState={},this.keys.forEach(e=>{this.held[e]=!1,this.pressed[e]=!1,this.released[e]=!1,this.prevState[e]=!1}),this.held.any=!1,this.pressed.any=!1,this.released.any=!1,this.prevState.any=!1,this.keyboardMap={up:[Phaser.KeyCode.UP,Phaser.KeyCode.B],down:[Phaser.KeyCode.DOWN,Phaser.KeyCode.F,Phaser.KeyCode.V],left:[Phaser.KeyCode.LEFT,Phaser.KeyCode.D,Phaser.KeyCode.C],right:[Phaser.KeyCode.RIGHT,Phaser.KeyCode.N],a:[Phaser.KeyCode.Z,Phaser.KeyCode.K],b:[Phaser.KeyCode.X,Phaser.KeyCode.J],select:[Phaser.KeyCode.SHIFT,Phaser.KeyCode.TAB,Phaser.KeyCode.SPACEBAR],start:[Phaser.KeyCode.ENTER,Phaser.KeyCode.ESC,Phaser.KeyCode.P]},this.gamepadMap={up:12,down:13,left:14,right:15,a:0,b:1,select:8,start:9},this.signals={pressed:{},released:{}},this.keys.forEach(e=>{this.signals.pressed[e]=new Phaser.Signal,this.signals.released[e]=new Phaser.Signal}),this.signals.pressed.any=new Phaser.Signal,this.signals.released.any=new Phaser.Signal,this.activeTouches=new Map,this.maxTouches=4,this.lastInputSource="none",this.inputDetectionTimeout=null,this.touchControlsVisible=!1,this.setupKeyboard(),this.setupGamepad(),this.setupTouch(),this.setupInputDetection()}setupKeyboard(){this.keyboardState={},this.keys.forEach(e=>{this.keyboardState[e]=!1}),this.keyCodeToAction={};for(const[e,t]of Object.entries(this.keyboardMap))t.forEach(t=>{this.keyCodeToAction[t]=e});const e=[];for(const t of Object.values(this.keyboardMap))e.push(...t);const t=[...new Set(e)];this.game.input.keyboard.addKeyCapture(t),this.game.input.keyboard.onDownCallback=e=>{const t=this.keyCodeToAction[e.keyCode];t&&(this.held[t]=!0,this.keyboardState[t]=!0),this.detectInputSource("keyboard")},this.game.input.keyboard.onUpCallback=e=>{const t=this.keyCodeToAction[e.keyCode];t&&(this.held[t]=!1,this.keyboardState[t]=!1)}}setupGamepad(){this.game.input.gamepad.supported&&(this.game.input.gamepad.start(),this.gamepadState={},this.keys.forEach(e=>{this.gamepadState[e]=!1}),this.game.input.gamepad.onDownCallback=e=>{this.keys.forEach(t=>{this.gamepadMap[t]==e&&(this.held[t]=!0,this.gamepadState[t]=!0,this.detectInputSource("gamepad"))})},this.game.input.gamepad.onUpCallback=e=>{this.keys.forEach(t=>{this.gamepadMap[t]==e&&(this.held[t]=!1,this.gamepadState[t]=!1)})})}setupTouch(){this.controllerElement=document.getElementById("controller"),this.controllerElement&&(this.dpadElements={up:document.getElementById("controller_up"),down:document.getElementById("controller_down"),left:document.getElementById("controller_left"),right:document.getElementById("controller_right")},this.buttonElements={a:document.getElementById("controller_a"),b:document.getElementById("controller_b"),select:document.getElementById("controller_select"),start:document.getElementById("controller_start"),rhythm_up:document.getElementById("controller_rhythm_up"),rhythm_down:document.getElementById("controller_rhythm_down"),rhythm_left:document.getElementById("controller_rhythm_left"),rhythm_right:document.getElementById("controller_rhythm_right")},this.setupControllerTouchEvents(),this.updateTouchControlsVisibility())}setupInputDetection(){document.addEventListener("touchstart",e=>{e.target.closest("#controller")||this.detectInputSource("touch")},{passive:!0}),document.addEventListener("mousedown",e=>{this.game.device.touch&&!e.target.closest("#controller")&&this.detectInputSource("touch")},{passive:!0})}detectInputSource(e){this.lastInputSource!==e&&(this.lastInputSource=e,this.inputDetectionTimeout&&clearTimeout(this.inputDetectionTimeout),this.updateTouchControlsVisibility(),"touch"!==e&&this.game.device.touch&&(this.inputDetectionTimeout=setTimeout(()=>{this.lastInputSource===e&&(this.lastInputSource="none",this.updateTouchControlsVisibility())},1e4)))}updateTouchControlsVisibility(){if(!this.controllerElement)return;const e=this.game.device.touch&&("touch"===this.lastInputSource||"none"===this.lastInputSource);e!==this.touchControlsVisible&&(this.controllerElement.style.display=e?"block":"none",this.touchControlsVisible=e)}setupControllerTouchEvents(){const e=this.controllerElement,t=e=>e.preventDefault();e.addEventListener("touchstart",t,{passive:!1}),e.addEventListener("touchmove",t,{passive:!1}),e.addEventListener("touchend",t,{passive:!1}),e.addEventListener("touchcancel",t,{passive:!1}),e.addEventListener("touchstart",e=>this.handleTouchStart(e)),e.addEventListener("touchmove",e=>this.handleTouchMove(e)),e.addEventListener("touchend",e=>this.handleTouchEnd(e)),e.addEventListener("touchcancel",e=>this.handleTouchEnd(e))}handleTouchStart(e){const t=e.changedTouches;for(let e=0;e<t.length;e++){const i=t[e];if(this.activeTouches.size>=this.maxTouches)continue;const s=this.getButtonFromTouch(i);if(s){this.activeTouches.set(i.identifier,s),this.held[s.replace("rhythm_","")]=!0,this.detectInputSource("touch");const e=this.dpadElements[s]||this.buttonElements[s];e&&e.classList.add("btnPressed")}}}handleTouchMove(e){const t=e.changedTouches;for(let e=0;e<t.length;e++){const i=t[e],s=this.activeTouches.get(i.identifier);if(void 0!==s){const e=this.getButtonFromTouch(i);if(e&&e!==s){this.held[s.replace("rhythm_","")]=!1,this.held[e.replace("rhythm_","")]=!0;const t=this.dpadElements[s]||this.buttonElements[s],a=this.dpadElements[e]||this.buttonElements[e];t&&t.classList.remove("btnPressed"),a&&a.classList.add("btnPressed"),this.activeTouches.set(i.identifier,e)}else if(!e){this.held[s.replace("rhythm_","")]=!1;const e=this.dpadElements[s]||this.buttonElements[s];e&&e.classList.remove("btnPressed")}}}}handleTouchEnd(e){const t=e.changedTouches;for(let e=0;e<t.length;e++){const i=t[e],s=this.activeTouches.get(i.identifier);if(void 0!==s){this.held[s.replace("rhythm_","")]=!1;const e=this.dpadElements[s]||this.buttonElements[s];e&&e.classList.remove("btnPressed"),this.activeTouches.delete(i.identifier)}}}getButtonFromTouch(e){const t=document.elementFromPoint(e.clientX,e.clientY);if(!t)return null;const i=t.closest('[id^="controller_"]');if(!i)return null;const s=i.id.replace("controller_","");return this.keys.includes(s)||s.startsWith("rhythm_")?s:null}update(){if(this.dontUpdateThisTime)return void delete this.dontUpdateThisTime;this.updateButtonStates();let e=null,t=null;this.keys.forEach(i=>{this.pressed[i]&&(this.signals.pressed[i].dispatch(),e=i),this.released[i]&&(this.signals.released[i].dispatch(),t=i)}),e&&this.signals.pressed.any.dispatch(e),t&&this.signals.released.any.dispatch(t),this.keys.forEach(e=>{this.prevState[e]=this.held[e]}),this.prevState.any=this.held.any}isTouchControlled(e){return Array.from(this.activeTouches.values()).includes(e)}updateButtonStates(){let e=!1,t=!1,i=!1;this.keys.forEach(s=>{this.pressed[s]=this.held[s]&&!this.prevState[s],this.released[s]=!this.held[s]&&this.prevState[s],this.pressed[s]&&(e=!0),this.released[s]&&(t=!0),this.held[s]&&(i=!0)}),this.pressed.any=e,this.released.any=t,this.held.any=i}releaseAll(){this.keys.forEach(e=>{this.held[e]=!1,this.pressed[e]=!1,this.released[e]=!1}),this.held.any=!1,this.pressed.any=!1,this.released.any=!1}press(e){this.dontUpdateThisTime=!0,this.pressed[e]=!0,this.pressed.any=!0,this.held[e]=!0,this.held.any=!0}isDirectionPressed(){return this.held.up||this.held.down||this.held.left||this.held.right}getDirection(){let e=0,t=0;return this.held.left&&(e-=1),this.held.right&&(e+=1),this.held.up&&(t-=1),this.held.down&&(t+=1),0!==e&&0!==t&&(e*=.7071,t*=.7071),{x:e,y:t}}reset(){this.releaseAll(),this.activeTouches.clear(),Object.values(this.dpadElements).forEach(e=>e?.classList.remove("btnPressed")),Object.values(this.buttonElements).forEach(e=>e?.classList.remove("btnPressed"))}destroy(){this.inputDetectionTimeout&&clearTimeout(this.inputDetectionTimeout),this.keyboardKeys&&Object.values(this.keyboardKeys).forEach(e=>{e.forEach(e=>{e.onDown.removeAll(),e.onUp.removeAll()})}),this.game.input.gamepad&&(this.game.input.gamepad.onConnectCallback=null,this.game.input.gamepad.onDisconnectCallback=null),this.signals&&(Object.values(this.signals.pressed).forEach(e=>e?.removeAll()),Object.values(this.signals.released).forEach(e=>e?.removeAll())),this.controllerElement&&this.controllerElement.remove(),this.activeTouches?.clear()}}class ScreenRecorder{constructor(e){this.game=e,this.mediaRecorder=null,this.recordedBlobs=[],this.isRecording=!1,this.stream=null,this.videoBitsPerSecond=11e5,this.videoFrameRate=25,this.scale=1,this.imageScale=7,this.canvas=e.canvas,this.canvas.captureStream||console.error("Canvas captureStream is not supported in this browser")}async start(e=null,t=0){if(this.isRecording)console.warn("Already recording");else if(this.canvas.captureStream)try{this.scaledCanvas=document.createElement("canvas"),this.scaledCanvas.width=this.canvas.width*this.scale,this.scaledCanvas.height=this.canvas.height*this.scale,this.scaledContext=this.scaledCanvas.getContext("2d"),this.scaledContext.imageSmoothingEnabled=!1,this.scaledContext.webkitImageSmoothingEnabled=!1,this.scaledContext.mozImageSmoothingEnabled=!1,this.stream=this.scaledCanvas.captureStream(this.videoFrameRate),e&&await this.addAudioToStream(e,t);let i={mimeType:"video/webm; codecs=vp9",videoBitsPerSecond:this.videoBitsPerSecond};MediaRecorder.isTypeSupported(i.mimeType)||(i={mimeType:"video/webm; codecs=vp8",videoBitsPerSecond:this.videoBitsPerSecond},MediaRecorder.isTypeSupported(i.mimeType)||(i={mimeType:"video/webm",videoBitsPerSecond:this.videoBitsPerSecond})),this.mediaRecorder=new MediaRecorder(this.stream,i),this.recordedBlobs=[],this.mediaRecorder.ondataavailable=e=>{e.data&&e.data.size>0&&this.recordedBlobs.push(e.data)},this.mediaRecorder.onstop=()=>{this.save(),this.cleanup()},this.mediaRecorder.onerror=e=>{console.error("MediaRecorder error:",e.error),this.isRecording=!1,this.cleanup()},this.mediaRecorder.start(1e3),this.isRecording=!0,this.startRenderingLoop(),console.log(`Started recording with MIME type: ${i.mimeType}, audio delay: ${t}ms`)}catch(e){console.error("MediaRecorder init failed:",e),this.cleanup()}else console.error("Screen recording not supported in this browser")}startRenderingLoop(){const e=()=>{this.isRecording&&this.scaledCanvas&&this.scaledContext&&(this.scaledContext.fillStyle="#000000",this.scaledContext.fillRect(0,0,this.scaledCanvas.width,this.scaledCanvas.height),this.scaledContext.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,0,0,this.scaledCanvas.width,this.scaledCanvas.height),requestAnimationFrame(e))};e()}stop(){if(this.isRecording&&this.mediaRecorder)try{this.mediaRecorder.stop(),this.isRecording=!1,console.log("Stopped recording")}catch(e){console.error("Error stopping recorder:",e),this.cleanup()}else console.warn("Not recording")}pause(){this.isRecording&&this.mediaRecorder&&"recording"===this.mediaRecorder.state&&(this.mediaRecorder.pause(),console.log("Recording paused"))}resume(){this.isRecording&&this.mediaRecorder&&"paused"===this.mediaRecorder.state&&(this.mediaRecorder.resume(),console.log("Recording resumed"))}screenshot(){const e=document.createElement("canvas");e.width=this.game.width*this.imageScale,e.height=this.game.height*this.imageScale;const t=e.getContext("2d");t.imageSmoothingEnabled=!1,t.webkitImageSmoothingEnabled=!1,t.mozImageSmoothingEnabled=!1,t.fillStyle="#000000",t.fillRect(0,0,e.width,e.height);const i=this.game.add.renderTexture(this.game.width,this.game.height,"screenshotTemp");i.renderXY(this.game.world,0,0,!0);const s=i.getCanvas();t.drawImage(s,0,0,this.game.width,this.game.height,0,0,e.width,e.height),e.toBlob(async e=>{const t=`screenshot-${Date.now()}.png`;await this.saveFile(t,e),console.log("Screenshot saved:",t)},"image/png"),i.destroy()}async save(e){if(0===this.recordedBlobs.length)return void console.warn("No recording data available");const t=new Blob(this.recordedBlobs,{type:"video/webm"});e||(e=`recording_${Date.now()}.webm`),await this.saveFile(e,t),console.log("Recording saved as:",e)}async saveFile(e,t){if(CURRENT_ENVIRONMENT===ENVIRONMENT.CORDOVA||CURRENT_ENVIRONMENT===ENVIRONMENT.NWJS){const i=new FileSystemTools,s="Screenshots",a=await i.getDirectory(EXTERNAL_DIRECTORY+s);await i.saveFile(a,t,e)}else{const i=window.URL.createObjectURL(t),s=document.createElement("a");s.style.display="none",s.href=i,s.download=e,document.body.appendChild(s),s.click(),setTimeout(()=>{document.body.removeChild(s),window.URL.revokeObjectURL(i)},100)}}async addAudioToStream(e=null,t=0){try{if(e&&e.src){if(t>0&&(console.log(`Applying audio delay: ${t}ms`),e.currentTime>0&&(e.currentTime=Math.max(0,e.currentTime-t/1e3)),await new Promise(e=>setTimeout(e,t))),e.paused){console.warn("Audio element is paused, attempting to play it");try{await e.play()}catch(e){console.warn("Could not play audio element:",e)}}if(e.captureStream){const t=e.captureStream();if(await new Promise(e=>setTimeout(e,100)),t&&t.getAudioTracks().length>0)return t.getAudioTracks().forEach(e=>{console.log("Adding audio track:",e),this.stream.addTrack(e)}),console.log("Game audio added to recording"),!0;console.warn("Audio stream has no audio tracks")}else console.warn("Audio element does not support captureStream")}console.log("Falling back to microphone audio");return(await navigator.mediaDevices.getUserMedia({audio:!0})).getAudioTracks().forEach(e=>{this.stream.addTrack(e)}),console.log("Microphone audio added to recording"),!0}catch(e){return console.warn("Could not add audio to recording:",e),!1}}async addAudioAfterStart(e=null,t=0){if(!this.isRecording||!this.mediaRecorder)return console.warn("Cannot add audio - recording not started"),!1;this.mediaRecorder.pause();try{const i=await this.addAudioToStream(e,t);return this.mediaRecorder.resume(),i}catch(e){return console.error("Error adding audio after start:",e),this.mediaRecorder.resume(),!1}}cleanup(){this.isRecording=!1,this.stream&&(this.stream.getTracks().forEach(e=>e.stop()),this.stream=null),this.scaledCanvas&&(this.scaledCanvas=null,this.scaledContext=null),this.mediaRecorder=null}static isSupported(){return!(!HTMLCanvasElement.prototype.captureStream||!window.MediaRecorder)}getState(){return this.mediaRecorder?this.mediaRecorder.state:"inactive"}setScale(e){this.scale=e,console.log(`Scale factor set to: ${this.scale}`)}getScale(){return this.scale}}class Metronome{constructor(e){this.scene=e,this.player=e.player,this.mode=Account.settings.metronome,this.enabled="OFF"!==this.mode,this.beatDivisions={OFF:0,Quarters:1,Eighths:2,Sixteenths:4,"Thirty-seconds":8,Note:"Note"},this.lastDivisionValue=-1,this.currentDivision=this.beatDivisions[this.mode],this.noteIndex=0,this.lastNoteBeat=-1,this.notes=[],this.scene.onSelectPressed=this.toggle.bind(this)}update(){this.enabled&&("Note"===this.mode?this.updateNoteMode():this.updateBeatMode())}updateBeatMode(){if(0===this.currentDivision)return;const{beat:e}=this.scene.getCurrentTime(),t=this.getCurrentDivisionValue(e);t!==this.lastDivisionValue&&(this.playTick(),this.lastDivisionValue=t)}updateNoteMode(){const{beat:e}=this.scene.getCurrentTime(),t=e;if(0===this.notes.length&&this.initializeNotes(),this.noteIndex>=this.notes.length)return;const i=this.notes[this.noteIndex];if(t>=i)for(this.playTick(),this.lastNoteBeat=i,this.noteIndex++;this.noteIndex<this.notes.length&&this.notes[this.noteIndex]===this.lastNoteBeat;)this.noteIndex++}initializeNotes(){const e=this.scene.song.chart.difficulties[this.scene.song.difficultyIndex],t=`${e.type}${e.rating}`,i=this.scene.song.chart.notes[t];if(!i)return void(this.notes=[]);const s=new Set;for(const e of i)if("1"===e.type||"2"===e.type||"4"===e.type){const t=Math.round(1e3*e.beat)/1e3;s.add(t)}this.notes=Array.from(s).sort((e,t)=>e-t),this.noteIndex=0,this.lastNoteBeat=-1}getCurrentDivisionValue(e){return 0===this.currentDivision?-1:Math.floor(e*this.currentDivision)}playTick(){Audio.play("assist_tick")}toggle(){"OFF"!=this.mode&&(this.enabled=!this.enabled,this.lastDivisionValue=-1,this.resetNoteMode())}resetNoteMode(){this.noteIndex=0,this.lastNoteBeat=-1,this.notes=[]}setMode(e){this.beatDivisions.hasOwnProperty(e)&&(this.mode=e,this.currentDivision=this.beatDivisions[e],this.lastDivisionValue=-1,this.resetNoteMode(),this.enabled="OFF"!==e,Account.settings.metronome=e,saveAccount())}destroy(){this.enabled=!1,this.lastDivisionValue=-1,this.resetNoteMode(),this.statusText&&(this.statusText.destroy(),this.statusText=null)}}class BackgroundMusic{constructor(){this.audio=document.createElement("audio"),this.audio.volume=[0,25,50,75,100][Account.settings.volume]/100,this.randomSong=Account.settings.randomSong,this.audio.loop=!0,this.isPlaying=!1,this.currentSong=null,this.availableSongsCache=null,this.cacheTimestamp=0,this.cacheDuration=3e4,this.registerVisibilityChangeListener()}registerVisibilityChangeListener(){this.visibilityChangeListener=()=>{document.hidden?this.audio.pause():this.audio.play()},window.addEventListener("visibilitychange",this.visibilityChangeListener)}async playLastSong(){if(this.isPlaying||!Account.settings.enableMenuMusic)return;if(this.randomSong||!Account.lastSong)return void this.playRandomSong();const e=Account.lastSong;if(e.isExternal)try{await this.checkUrlAccessible(e.url),this.playSong(e)}catch(e){console.warn("Last external song not accessible, falling back to random song:",e),this.playRandomSong()}else this.playSong(e)}playRandomSong(){const e=this.getCachedAvailableSongs();if(0===e.length)return;const t=game.rnd.pick(e),i={url:t.audioUrl,title:t.title||t.chart?.title||"Unknown",artist:t.artist||t.chart?.artist||"Unknown",sampleStart:t.sampleStart||t.chart?.sampleStart||0,isExternal:void 0!==t.files||void 0!==t.chart?.files};this.playSong(i)}getCachedAvailableSongs(){const e=Date.now();return this.availableSongsCache&&e-this.cacheTimestamp<this.cacheDuration||(this.availableSongsCache=this.getAllAvailableSongsFast(),this.cacheTimestamp=e),this.availableSongsCache}getAllAvailableSongsFast(){const e=[],t=new Set;if(window.localSongs&&window.localSongs.length>0)for(const i of window.localSongs)i.audioUrl&&this.isValidAudioUrl(i.audioUrl)&&(t.has(i.audioUrl)||(t.add(i.audioUrl),e.push(i)));if(window.externalSongs&&window.externalSongs.length>0)for(const i of window.externalSongs)i.audioUrl&&this.isValidAudioUrl(i.audioUrl)&&(t.has(i.audioUrl)||(t.add(i.audioUrl),e.push(i)));const i=game.state.getCurrentState();if(i&&i.songs&&Array.isArray(i.songs))for(const s of i.songs)s.audioUrl&&this.isValidAudioUrl(s.audioUrl)&&(t.has(s.audioUrl)||(t.add(s.audioUrl),e.push(s)));return e}isValidAudioUrl(e){return!!e&&("string"==typeof e&&(!e.includes("assets/no-")&&("undefined"!==e&&"null"!==e&&0!==e.trim().length)))}async checkUrlAccessible(e){return new Promise((t,i)=>{if(!e)return void i();if(e.startsWith("blob:"))return void t();const s=document.createElement("audio");s.preload="metadata",s.onloadedmetadata=()=>{s.remove(),t()},s.onerror=()=>{s.remove(),i(new Error("Audio load failed"))},setTimeout(()=>{s.remove(),i(new Error("Audio load timeout"))},800),s.src=e})}playSong(e){this.audio.pause(),this.audio.currentTime=0,this.audio.src=e.url,this.audio.currentTime=e.sampleStart||0,this.audio.play().then(()=>{if(this.isPlaying=!0,this.currentSong=e,notifications){e.title,e.artist}}).catch(t=>{console.warn(`Failed to play background music: ${e.title}`,t),this.removeSongFromCache(e.url),setTimeout(()=>{this.playRandomSong()},100)})}removeSongFromCache(e){this.availableSongsCache&&(this.availableSongsCache=this.availableSongsCache.filter(t=>t.audioUrl!==e))}stop(){this.audio.pause(),this.audio.currentTime=0,this.isPlaying=!1,this.currentSong=null}setVolume(e){this.audio.volume=[0,25,50,75,100][e]/100}refreshCache(){this.availableSongsCache=null,this.cacheTimestamp=0}destroy(){this.stop(),this.audio.src="",this.audio=null,window.removeEventListener("visibilitychange",this.visibilityChangeListener),this.availableSongsCache=null}}class Visualizer{constructor(e,t,i,s,a){this.scene=e,this.x=t,this.y=i,this.width=s,this.height=a,this.graphics=e.add.graphics(t,i),this.active=!0}update(){}destroy(){this.graphics.destroy()}clear(){this.graphics.clear()}}class AccuracyVisualizer extends Visualizer{constructor(e,t,i,s,a){super(e,t,i,s,a),this.accuracyHistory=[],this.maxHistoryLength=this.width/4}update(){if(this.active&&this.scene.player&&(this.clear(),this.accuracyHistory=this.scene.player.timingStory,this.accuracyHistory.length>this.maxHistoryLength&&this.accuracyHistory.shift(),this.graphics.lineStyle(1,15790320,.3),this.graphics.moveTo(0,3),this.graphics.lineTo(this.width,3),this.accuracyHistory.length>1)){this.graphics.lineStyle(1,65280,1),this.graphics.moveTo(0,3);for(let e=0;e<this.accuracyHistory.length;e++){const t=e/this.maxHistoryLength*this.width,i=2+this.accuracyHistory[e]/.4*3;this.graphics.lineTo(t,i)}}}}class AudioVisualizer extends Visualizer{constructor(e,t,i,s,a){super(e,t,i,s,a),this.audioContext=null,this.analyser=null,this.dataArray=null,this.bufferLength=32,this.bars=[],this.setupAudioAnalysis()}setupAudioAnalysis(){try{if(this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=64,this.analyser.maxDecibels=-10,this.analyser.smoothingTimeConstant=.1,this.bufferLength=this.analyser.frequencyBinCount,this.dataArray=new Uint8Array(this.bufferLength),this.scene.audio){this.audioContext.createMediaElementSource(this.scene.audio).connect(this.analyser),this.analyser.connect(this.audioContext.destination)}}catch(e){console.warn("Audio visualizer not supported:",e),this.active=!1}}update(){if(!this.active||!this.analyser)return;this.clear(),this.analyser.getByteFrequencyData(this.dataArray);const e=this.width/this.bufferLength*2;let t=0;for(let i=0;i<this.bufferLength/2;i++){const s=this.dataArray[i]/255*this.height;s>0&&(this.graphics.lineStyle(e-1,255,.9),this.graphics.moveTo(t,this.height-1),this.graphics.lineTo(t,this.height-s)),t+=e}}destroy(){super.destroy(),this.audioContext&&this.audioContext.close()}}class BPMVisualizer extends Visualizer{constructor(e,t,i,s,a){super(e,t,i,s,a),this.bpmChanges=e.song?.chart?.bpmChanges||[],this.stops=e.song?.chart?.stops||[],this.text=new Text(s-1,1,""),this.text.anchor.x=1,this.text.alpha=.5,this.graphics.addChild(this.text),this.beatIndicatorAlpha=1,this.currentBeat=0,this.currentBeatInt=0,this.previusBeatInt=1,this.currentBpm=0,this.previusBpm=1}update(){if(!this.active)return;this.clear();const e=this.scene.getCurrentTime();this.currentBeat=e.beat,this.currentBeatInt=Math.floor(this.currentBeat),this.currentBeatInt!=this.previusBeatInt&&(this.beatIndicatorAlpha=1),this.previusBeatInt=this.currentBeatInt,this.currentBpm=this.getLastBpm(),this.currentBpm!=this.previusBpm&&(this.text.write(`${this.currentBpm}`),this.text.alpha=1,game.add.tween(this.text).to({alpha:.5},100,"Linear",!0)),this.text.tint=this.getLastStop()&&this.getLastStop().beat==this.currentBeat?16711680:16777215,this.previusBpm=this.currentBpm;Math.max(...this.bpmChanges.map(e=>e.beat),this.currentBeat+50);this.bpmChanges.forEach(e=>{const t=(e.beat-this.currentBeat)/8*this.width;t>=0&&t<=this.width&&(this.graphics.beginFill(16776960,.8),this.graphics.drawRect(t-1,0,1,this.height),this.graphics.endFill())}),this.stops.forEach(e=>{const t=(e.beat-this.currentBeat)/8*this.width;t>=0&&t<=this.width&&(this.graphics.beginFill(16711680,.8),this.graphics.drawRect(t-1,0,1,this.height),this.graphics.endFill())}),this.graphics.beginFill(65280,this.beatIndicatorAlpha),this.graphics.drawCircle(3,3,4),this.graphics.endFill();let t=Math.min(250,this.currentBpm)/250*.5;this.beatIndicatorAlpha-=t}getLastBpm(){return this.bpmChanges.length?this.bpmChanges.find((e,t,i)=>t+1==i.length||i[t+1].beat>=this.currentBeat).bpm:0}getLastStop(){return this.stops.length?this.stops.find((e,t,i)=>t+1==i.length||i[t+1].beat>=this.currentBeat):null}destroy(){super.destroy(),this.text.destroy()}}class FullScreenAudioVisualizer{constructor(e,t={}){this.audioElement=e,this.options={barColor:7797982,barWidth:4,barSpacing:2,barBaseHeight:10,barMaxHeight:80,smoothing:.8,alpha:1,fftSize:256,visualizationType:"circular",...t},this.graphics=game.add.graphics(0,0),this.analyser=null,this.dataArray=null,this.bufferLength=0,this.frequencyData=null,this.isActive=!1,this.setupAudioAnalysis()}setupAudioAnalysis(){try{this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext)),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=this.options.fftSize,this.analyser.smoothingTimeConstant=this.options.smoothing,this.analyser.minDecibels=-90,this.analyser.maxDecibels=-10,this.bufferLength=this.analyser.frequencyBinCount,this.dataArray=new Uint8Array(this.bufferLength),this.frequencyData=new Uint8Array(this.bufferLength),this.audioElement&&this.connectAudioSource(),this.isActive=!0}catch(e){console.warn("FullScreenAudioVisualizer: Audio analysis not supported:",e),this.isActive=!1}}connectAudioSource(){if(this.audioElement&&this.analyser)try{this.source&&this.source.disconnect(),this.source=this.audioContext.createMediaElementSource(this.audioElement),this.source.connect(this.analyser),this.analyser.connect(this.audioContext.destination)}catch(e){console.warn("FullScreenAudioVisualizer: Could not connect audio source:",e)}}setAudioSource(e){this.audioElement=e,this.isActive&&this.connectAudioSource()}update(){if(!this.isActive||!this.analyser)return;this.graphics.clear(),this.graphics.alpha=this.options.alpha,this.analyser.getByteFrequencyData(this.dataArray);const e=Math.floor(this.bufferLength/2);if(this.frequencyData){for(let t=0;t<e;t++)this.frequencyData[t]=Math.max(this.frequencyData[t]*this.options.smoothing,this.dataArray[t]);for(let t=e;t<this.bufferLength;t++)this.frequencyData[t]=0}else this.frequencyData=new Uint8Array(this.dataArray);switch(this.options.visualizationType){case"bars":default:this.drawBars();break;case"waveform":this.drawWaveform();break;case"circular":this.drawCircularVisualizer();break;case"symmetrical":this.drawSymmetricalBars()}}drawBars(){const e=Math.floor(game.width/(this.options.barWidth+this.options.barSpacing)),t=(game.width-e*(this.options.barWidth+this.options.barSpacing))/2,i=Math.floor(this.bufferLength/2);for(let s=0;s<e;s++){const a=Math.floor(s/e*i);if(a>=i)continue;const n=(this.frequencyData[a]||0)/255,o=this.options.barBaseHeight+n*this.options.barMaxHeight,r=t+s*(this.options.barWidth+this.options.barSpacing),c=game.height-o;this.drawBar(r,c,this.options.barWidth,o,n)}}drawSymmetricalBars(){const e=Math.floor(game.width/(this.options.barWidth+this.options.barSpacing)),t=Math.floor(e/2),i=game.width/2,s=Math.floor(this.bufferLength/2);for(let e=0;e<t;e++){const a=Math.floor(e/t*s);if(a>=s)continue;const n=(this.frequencyData[a]||0)/255,o=this.options.barBaseHeight+n*this.options.barMaxHeight,r=i+e*(this.options.barWidth+this.options.barSpacing),c=game.height-o;this.drawBar(r,c,this.options.barWidth,o,n);const l=i-(e+1)*(this.options.barWidth+this.options.barSpacing),h=game.height-o;this.drawBar(l,h,this.options.barWidth,o,n)}}drawWaveform(){const e=new Uint8Array(this.bufferLength);this.analyser.getByteTimeDomainData(e),this.graphics.lineStyle(2,this.options.barColor,.8);const t=game.width/this.bufferLength;let i=0;for(let s=0;s<this.bufferLength;s++){const a=e[s]/128*game.height/2;0===s?this.graphics.moveTo(i,a):this.graphics.lineTo(i,a),i+=t}}drawCircularVisualizer(){const e=game.width/2,t=game.height/2,i=.3*Math.min(game.width,game.height),s=Math.floor(this.bufferLength/2);this.graphics.lineStyle(2,this.options.barColor,.8);for(let a=0;a<s;a+=2){const n=this.frequencyData[a]/255,o=a/s*Math.PI*2,r=n*i*.5,c=e+Math.cos(o)*i,l=t+Math.sin(o)*i,h=e+Math.cos(o)*(i+r),d=t+Math.sin(o)*(i+r);this.graphics.moveTo(c,l),this.graphics.lineTo(h,d)}}drawBar(e,t,i,s,a){const n=this.options.barColor,o=.3+.7*a,r=(n>>16&255)*o,c=(n>>8&255)*o,l=(255&n)*o,h=Math.floor(r)<<16|Math.floor(c)<<8|Math.floor(l);if(this.graphics.beginFill(h,.8),this.graphics.drawRect(e,t,i,s),this.graphics.endFill(),a>.5){const n=.4*(a-.5);this.graphics.beginFill(16777215,n),this.graphics.drawRect(e,t,i,Math.max(2,.1*s)),this.graphics.endFill()}}setVisualizationType(e){["bars","waveform","circular","symmetrical"].includes(e)?this.options.visualizationType=e:(console.warn(`Invalid visualization type: ${e}. Using 'bars' instead.`),this.options.visualizationType="bars")}setBarColor(e){this.options.barColor=e}setAlpha(e){this.options.alpha=Phaser.Math.clamp(e,0,1)}setOptions(e){this.options={...this.options,...e},this.analyser&&(e.fftSize&&(this.analyser.fftSize=e.fftSize,this.bufferLength=this.analyser.frequencyBinCount,this.dataArray=new Uint8Array(this.bufferLength),this.frequencyData=new Uint8Array(this.bufferLength)),void 0!==e.smoothing&&(this.analyser.smoothingTimeConstant=e.smoothing)),e.visualizationType&&this.setVisualizationType(e.visualizationType)}getSettings(){return{...this.options}}isReady(){return this.isActive&&null!==this.analyser}pause(){this.isActive=!1}resume(){this.isActive=!0}destroy(){this.isActive=!1,this.source&&this.source.disconnect(),this.analyser&&this.analyser.disconnect(),this.audioContext&&"closed"!==this.audioContext.state&&this.audioContext.close().catch(e=>{console.warn("Error closing audio context:",e)}),this.graphics&&this.graphics.destroy(),this.audioElement=null,this.analyser=null,this.source=null,this.audioContext=null,this.dataArray=null,this.frequencyData=null}static create(e,t={}){return new FullScreenAudioVisualizer(e,t)}static isSupported(){return!(!window.AudioContext&&!window.webkitAudioContext)}}class SMFile{static generateSMContent(e){let t="";if(t+=`#TITLE:${e.title||""};\n`,t+=`#SUBTITLE:${e.subtitle||""};\n`,t+=`#ARTIST:${e.artist||""};\n`,t+=`#TITLETRANSLIT:${e.titleTranslit||""};\n`,t+=`#SUBTITLETRANSLIT:${e.subtitleTranslit||""};\n`,t+=`#ARTISTTRANSLIT:${e.artistTranslit||""};\n`,t+=`#GENRE:${e.genre||""};\n`,t+=`#CREDIT:${e.credit||""};\n`,t+=`#BANNER:${this.getFilename(e.banner)};\n`,t+=`#BACKGROUND:${this.getFilename(e.background)};\n`,t+=`#LYRICSPATH:${this.getFilename(e.lyrics)};\n`,t+=`#CDTITLE:${this.getFilename(e.cdtitle)};\n`,t+=`#MUSIC:${this.getFilename(e.audio)};\n`,t+=`#OFFSET:${e.offset||0};\n`,t+=`#SAMPLESTART:${e.sampleStart||0};\n`,t+=`#SAMPLELENGTH:${e.sampleLength||10};\n`,e.bpmChanges&&e.bpmChanges.length>0?t+=`#BPMS:${e.bpmChanges.map(e=>`${e.beat.toFixed(3)}=${e.bpm.toFixed(3)}`).join(",")};\n`:t+="#BPMS:0.000=120.000;\n",e.stops&&e.stops.length>0?t+=`#STOPS:${e.stops.map(e=>`${e.beat.toFixed(3)}=${e.len.toFixed(3)}`).join(",")};\n`:t+="#STOPS:;\n",e.backgrounds&&e.backgrounds.length>0){const i=e.backgrounds.map(e=>`${e.beat.toFixed(3)}=${e.file||""}=${e.opacity||1}=${e.fadeIn||0}=${e.fadeOut||0}=${e.effect||0}`).join(",");t+=`#BGCHANGES:${i};\n`}else t+="#BGCHANGES:;\n";return e.difficulties&&e.notes&&e.difficulties.forEach(i=>{const s=i.type+i.rating,a=e.notes[s];a&&(t+=this.generateNotesSection(i,a))}),t}static getFilename(e){if(!e||"no-media"===e)return"";const t=e.split(/[\\/]/);return t[t.length-1]||""}static generateNotesSection(e,t){let i="#NOTES:\n";i+="     dance-single:\n",i+="     :\n",i+=`     ${e.type}:\n`,i+=`     ${e.rating}:\n`,i+="     0.000000:\n";const s={};let a=4;t.forEach(e=>{const t=Math.floor(e.beat/4);s[t]||(s[t]=[]),s[t].push(e);const i=e.beat-Math.floor(e.beat);if(i>0){const e=this.findRequiredResolution(i);a=Math.max(a,e)}});const n=Object.keys(s).map(Number).sort((e,t)=>e-t),o=a;return n.forEach(e=>{const t=s[e],a=this.convertMeasureToSM(t,e,o);i+=a}),i+=";\n",i}static findRequiredResolution(e){const t=[4,8,12,16,24,32,48,64,96,192];for(const i of t){const t=Math.round(e*i)/i;if(Math.abs(e-t)<.001)return i}return 192}static convertMeasureToSM(e,t,i){const s=[],a=4*t,n=4/i;for(let e=0;e<i;e++)s.push("0000");return e.forEach(e=>{const t=e.beat-a,o=Math.round(t/n);if(o>=0&&o<i){const t=s[o].split("");let i="0";switch(e.type){case"1":i="1";break;case"2":i="2";break;case"3":i="3";break;case"4":i="4";break;case"M":i="M"}t[e.column]=i,s[o]=t.join("")}}),s.join(",\n")+",\n"}static parseSMContent(e,t=""){let i=e.replace(/\/\/.*/g,"").replace(/\r?\n|\r/g,"").split(";");for(let e=i.length-1;e>=0;e-=1)if(i[e]){i[e]=i[e].split(/:/g);for(let t in i[e])i[e][t]=i[e][t].trim()}else i.splice(e,1);let s={};const a={bpmChanges:[],stops:[],notes:{},backgrounds:[],banner:"no-media",difficulties:[],background:"no-media",cdtitle:null,audioUrl:null,videoUrl:null,sampleStart:0,sampleLength:10,baseUrl:t};for(let e in i){let n=i[e];switch(n[0]){case"#TITLE":a.title=n[1];break;case"#SUBTITLE":a.subtitle=n[1];break;case"#ARTIST":a.artist=n[1];break;case"#TITLETRANSLIT":a.titleTranslit=n[1];break;case"#SUBTITLETRANSLIT":a.subtitleTranslit=n[1];break;case"#ARTISTTRANSLIT":a.artistTranslit=n[1];break;case"#GENRE":a.genre=n[1];break;case"#CREDIT":a.credit=n[1];break;case"#BANNER":n[1]&&(a.banner=this.resolveFileUrl(n[1],t));break;case"#BACKGROUND":n[1]&&(a.background=this.resolveFileUrl(n[1],t));break;case"#MUSIC":n[1]&&(a.audio=n[1],a.audioUrl=this.resolveFileUrl(n[1],t));break;case"#OFFSET":a.offset=Number(n[1]);break;case"#BPMS":{let e=n[1].split(",");e=e.filter(e=>/=/.exec(e));for(let t in e){let i=e[t].split("=");e[t]={beat:Number(i[0]),bpm:Number(i[1])}}a.bpmChanges=a.bpmChanges.concat(e);break}case"#STOPS":{let e=n[1].split(",");e=e.filter(e=>e.includes("="));for(let t in e){let i=e[t].split("=");e[t]={beat:Number(i[0]),len:Number(i[1])}}a.stops=a.stops.concat(e);break}case"#NOTES":s[n[3]+n[4]]=n[6].split(","),a.difficulties.push({type:n[3],rating:n[4]})}}for(let e in s)a.notes[e]=this.parseNotes(s[e],a.bpmChanges,a.stops);return a}static resolveFileUrl(e,t){return e?e.startsWith("http")||e.startsWith("//")?e:t+e:null}static parseNotes(e,t,i){const s=[];let a=0;const n=(e,t,i)=>4*e+t/i*4,o=e=>(new LocalSMParser).beatToSec(t,i,e);for(let t in e){const i=e[t].trim();if(!i)continue;const r=i.length/4;for(let e=0;e<r;e++){const t=i.substr(4*e,4);for(let c=0;c<4;c++){const l=t[c];if("0"!==l){const t=n(a,e,r),h={type:l,beat:t,sec:o(t),column:c};if("2"===l||"4"===l){let s=!1;for(let l=e+1;l<r&&!s;l++){if("3"===i.substr(4*l+c,1)){const e=n(a,l,r);h.beatLength=e-t,h.secLength=o(e)-o(t),h.beatEnd=e,h.secEnd=o(e),s=!0}}}s.push(h)}}}a++}return s}}class LocalSMParser{constructor(){this.baseUrl=""}async parseSM(e,t){this.baseUrl=t.endsWith("/")?t:t+"/";let i={};if(e.includes("#VERSION:"))return this.parseSSC(e,t);let s=e.replace(/\/\/.*/g,"").replace(/\r?\n|\r/g,"").split(";");for(let e=s.length-1;e>=0;e-=1)if(s[e]){s[e]=s[e].split(/:/g);for(let t in s[e])s[e][t]=s[e][t].trim()}else s.splice(e,1);let a={};i.bpmChanges=[],i.stops=[],i.notes={},i.backgrounds=[],i.banner="no-media",i.difficulties=[],i.background="no-media",i.cdtitle=null,i.audioUrl=null,i.videoUrl=null,i.sampleStart=0,i.sampleLength=10,i.baseUrl=t;for(let e in s){let t=s[e];switch(t[0]){case"#TITLE":i.title=t[1];break;case"#SUBTITLE":i.subtitle=t[1];break;case"#ARTIST":i.artist=t[1];break;case"#TITLETRANSLIT":i.titleTranslit=t[1];break;case"#SUBTITLETRANSLIT":i.subtitleTranslit=t[1];break;case"#ARTISTTRANSLIT":i.artistTranslit=t[1];break;case"#GENRE":i.genre=t[1];break;case"#CREDIT":i.credit=t[1];break;case"#BGCHANGES":t[1]&&t[1].split(",").forEach(e=>{if(!(e=e.trim()))return;const t=e.split("=").filter(e=>""!==e);if(t.length<6)return;const s={beat:parseFloat(t[0]),file:t[1],opacity:parseFloat(t[2]),fadeIn:parseInt(t[3])||0,fadeOut:parseInt(t[4])||0,effect:parseInt(t[5])||0,type:"image",startTime:0,duration:0};if(s.file){const e=s.file.split(".").pop().toLowerCase();s.type=["mp4","avi","mov"].includes(e)?"video":"image",s.url=this.resolveFileUrl(s.file)}t.length>6&&(s.duration=parseFloat(t[6])||0,s.startTime=parseFloat(t[7])||0),i.backgrounds.push(s)});break;case"#BANNER":t[1]&&(i.banner=this.resolveFileUrl(t[1]));break;case"#CDTITLE":t[1]&&(i.cdtitle=this.resolveFileUrl(t[1]));break;case"#LYRICSPATH":t[1]&&(i.lyrics=this.resolveFileUrl(t[1]));break;case"#SAMPLESTART":t[1]&&(i.sampleStart=parseFloat(t[1]));break;case"#SAMPLELENGTH":t[1]&&(i.sampleLength=parseFloat(t[1]));break;case"#BACKGROUND":t[1]&&(i.background=this.resolveFileUrl(t[1]));break;case"#VIDEO":t[1]&&(i.videoUrl=this.resolveFileUrl(t[1]));break;case"#MUSIC":t[1]&&(i.audio=t[1],i.audioUrl=this.resolveFileUrl(t[1]));break;case"#OFFSET":i.offset=Number(t[1]);break;case"#BPMS":{let e=t[1].split(",");e=e.filter(e=>/=/.exec(e));for(let t in e){let i=e[t].split("=");e[t]={beat:Number(i[0]),bpm:Number(i[1])}}i.bpmChanges=i.bpmChanges.concat(e);break}case"#STOPS":{let e=t[1].split(",");e=e.filter(e=>e.includes("="));for(let t in e){let i=e[t].split("=");e[t]={beat:Number(i[0]),len:Number(i[1])}}i.stops=i.stops.concat(e);break}case"#NOTES":a[t[3]+t[4]]=t[6].split(","),i.difficulties.push({type:t[3],rating:t[4]})}}if(i.bpmChanges.sort((e,t)=>e.beat-t.beat),0!==i.bpmChanges[0].beat)throw`No starting bpm, first bpm change is ${i.bpmChanges[0]}`;i.bpmChanges[0].sec=0;for(let e=1;e<i.bpmChanges.length;e++)i.bpmChanges[e].sec=this.beatToSec(i.bpmChanges,i.stops,i.bpmChanges[e].beat);for(let e=0;e<i.stops.length;e++)i.stops[e].sec=this.beatToSec(i.bpmChanges,i.stops,i.stops[e].beat);for(let e in a){let t=[null,null,null,null];i.notes[e]=[];for(let s in a[e]){if(a[e][s]=a[e][s].trim(),a[e][s].length%4)throw`Invalid length on measure ${s}, length is ${a[e][s].length}`;a[e][s]=a[e][s].match(/(.{4})/g);let n=a[e][s].length;for(let o in a[e][s]){let r=a[e][s][o],c=[{},{},{},{}],l=4*s+o/n*4;for(let s=0;s<c.length;s++){switch(r[s]){case"3":if(null==t[s])throw"hold end without any hold before";{let a=i.notes[e][t[s]];a.beatEnd=l,a.beatLength=l-a.beat,a.secEnd=this.beatToSec(i.bpmChanges,i.stops,l),a.secLength=this.beatToSec(i.bpmChanges,i.stops,l)-this.beatToSec(i.bpmChanges,i.stops,a.beat)}t[s]=null;case"0":c[s]=null;continue;case"4":case"2":if(t[s])throw"new hold started before last ended";t[s]=i.notes[e].length+s;case"1":case"M":c[s].type=r[s];break;default:throw`invalid note type ${r[s]}`}c[s].beat=l,c[s].sec=this.beatToSec(i.bpmChanges,i.stops,l),c[s].column=s}i.notes[e]=i.notes[e].concat(c)}}i.notes[e]=i.notes[e].filter(e=>null!==e)}return i}resolveFileUrl(e){return e?e.startsWith("http")||e.startsWith("//")?e:this.baseUrl+e:null}getLastBpm(e,t,i){return e.find((e,s,a)=>s+1==a.length||a[s+1][i]>=t)}beatToSec(e,t,i){let s=this.getLastBpm(e,i,"beat"),a=(i-s.beat)/s.bpm*60+s.sec,n=t.filter(({beat:e})=>e>=s.beat&&e<i).map(e=>e.len);for(let e in n)a+=n[e];return a}parseSSC(e,t){const i={bpmChanges:[],stops:[],notes:{},backgrounds:[],banner:"no-media",difficulties:[],background:"no-media",cdtitle:null,audioUrl:null,videoUrl:null,sampleStart:0,sampleLength:10,baseUrl:t},s=e.split(/\/\/-+/)[0].split("\n");for(let e of s)if(e.startsWith("#")){const[t,...s]=e.slice(1).split(":"),a=s.join(":").trim();switch(t){case"TITLE":i.title=a;break;case"ARTIST":i.artist=a;break;case"BANNER":i.banner=this.resolveFileUrl(a);break;case"BACKGROUND":i.background=this.resolveFileUrl(a);break;case"MUSIC":i.audio=a,i.audioUrl=this.resolveFileUrl(a)}}return i}}class ExternalSMParser{parseSM(e,t){let i={};if(t.includes("#VERSION:"))return this.parseSSC(e,t);let s=t.replace(/\/\/.*/g,"").replace(/\r?\n|\r/g,"").split(";");for(let e=s.length-1;e>=0;e-=1)if(s[e]){s[e]=s[e].split(/:/g);for(let t in s[e])s[e][t]=s[e][t].trim()}else s.splice(e,1);let a={};i.bpmChanges=[],i.stops=[],i.notes={},i.backgrounds=[],i.banner="no-media",i.difficulties=[],i.background="no-media",i.cdtitle=null,i.audioUrl=null,i.videoUrl=null,i.files=e,i.sampleStart=0,i.sampleLength=10;for(let t in s){let n=s[t];switch(n[0]){case"#TITLE":i.title=n[1];break;case"#SUBTITLE":i.subtitle=n[1];break;case"#ARTIST":i.artist=n[1];break;case"#TITLETRANSLIT":i.titleTranslit=n[1];break;case"#SUBTITLETRANSLIT":i.subtitleTranslit=n[1];break;case"#ARTISTTRANSLIT":i.artistTranslit=n[1];break;case"#GENRE":i.genre=n[1];break;case"#CREDIT":i.credit=n[1];break;case"#BGCHANGES":n[1]&&n[1].split(",").forEach(t=>{if(!(t=t.trim()))return;const s=t.split("=").filter(e=>""!==e);if(s.length<6)return;const a={beat:parseFloat(s[0]),file:s[1],opacity:parseFloat(s[2]),fadeIn:parseInt(s[3])||0,fadeOut:parseInt(s[4])||0,effect:parseInt(s[5])||0,type:"image",startTime:0,duration:0};if(a.file){const t=a.file.split(".").pop().toLowerCase();if(a.type=["mp4","avi","mov"].includes(t)?"video":"image",e[a.file.toLowerCase()]){const t=e[a.file.toLowerCase()];a.url=t.localURL?t.localURL:URL.createObjectURL(t),a.url=a.url.replace("cdvfile://","file://").replace("localhost/persistent/","/storage/emulated/0/")}}s.length>6&&(a.duration=parseFloat(s[6])||0,a.startTime=parseFloat(s[7])||0),i.backgrounds.push(a)});break;case"#BANNER":if(n[1]&&e[n[1].toLowerCase()]){const t=e[n[1].toLowerCase()];i.banner=t.localURL?t.localURL:URL.createObjectURL(t),i.banner=i.banner.replace("cdvfile://","file://").replace("localhost/persistent/","/storage/emulated/0/")}break;case"#CDTITLE":if(n[1]&&e[n[1].toLowerCase()]){const t=e[n[1].toLowerCase()];i.cdtitle=t.localURL?t.localURL:URL.createObjectURL(t),i.cdtitle=i.cdtitle.replace("cdvfile://","file://").replace("localhost/persistent/","/storage/emulated/0/")}break;case"#SAMPLESTART":n[1]&&(i.sampleStart=parseFloat(n[1]));break;case"#SAMPLELENGTH":n[1]&&(i.sampleLength=parseFloat(n[1]));break;case"#BACKGROUND":if(n[1]&&e[n[1].toLowerCase()]){const t=e[n[1].toLowerCase()];i.background=t.localURL?t.localURL:URL.createObjectURL(t),i.background=i.background.replace("cdvfile://","file://").replace("localhost/persistent/","/storage/emulated/0/")}break;case"#VIDEO":if(n[1]&&e[n[1].toLowerCase()]){const t=e[n[1].toLowerCase()];i.videoUrl=t.localURL?t.localURL:URL.createObjectURL(t),i.videoUrl=i.videoUrl.replace("cdvfile://","file://").replace("localhost/persistent/","/storage/emulated/0/")}break;case"#LYRICSPATH":if(n[1]&&e[n[1].toLowerCase()]){const t=e[n[1].toLowerCase()];i.lyrics=t.localURL?t.localURL:URL.createObjectURL(t),i.lyrics=i.lyrics.replace("cdvfile://","file://").replace("localhost/persistent/","/storage/emulated/0/")}break;case"#MUSIC":if(n[1]&&(i.audio=n[1],e[n[1].toLowerCase()])){const t=e[n[1].toLowerCase()];i.audioUrl=t.localURL?t.localURL:URL.createObjectURL(t),i.audioUrl=i.audioUrl.replace("cdvfile://","file://").replace("localhost/persistent/","/storage/emulated/0/")}break;case"#OFFSET":i.offset=Number(n[1]);break;case"#BPMS":{let e=n[1].split(",");e=e.filter(e=>/=/.exec(e));for(let t in e){let i=e[t].split("=");e[t]={beat:Number(i[0]),bpm:Number(i[1])}}i.bpmChanges=i.bpmChanges.concat(e);break}case"#STOPS":{let e=n[1].split(",");e=e.filter(e=>e.includes("="));for(let t in e){let i=e[t].split("=");e[t]={beat:Number(i[0]),len:Number(i[1])}}i.stops=i.stops.concat(e);break}case"#NOTES":a[n[3]+n[4]]=n[6].split(","),i.difficulties.push({type:n[3],rating:n[4]})}}if(i.bpmChanges.sort((e,t)=>e.beat-t.beat),0===i.bpmChanges.length||0!==i.bpmChanges[0].beat)throw"No starting bpm";i.bpmChanges[0].sec=0;for(let e=1;e<i.bpmChanges.length;e++)i.bpmChanges[e].sec=this.beatToSec(i.bpmChanges,i.stops,i.bpmChanges[e].beat);for(let e=0;e<i.stops.length;e++)i.stops[e].sec=this.beatToSec(i.bpmChanges,i.stops,i.stops[e].beat);for(let e in a){let t=[null,null,null,null];i.notes[e]=[];for(let s in a[e]){if(a[e][s]=a[e][s].trim(),a[e][s].length%4)throw`Invalid length on measure ${s}, length is ${a[e][s].length}`;a[e][s]=a[e][s].match(/(.{4})/g);let n=a[e][s].length;for(let o in a[e][s]){let r=a[e][s][o],c=[{},{},{},{}],l=4*s+o/n*4;for(let s=0;s<c.length;s++){switch(r[s]){case"3":if(null==t[s])throw"hold end without any hold before";{let a=i.notes[e][t[s]];a.beatEnd=l,a.beatLength=l-a.beat,a.secEnd=this.beatToSec(i.bpmChanges,i.stops,l),a.secLength=this.beatToSec(i.bpmChanges,i.stops,l)-this.beatToSec(i.bpmChanges,i.stops,a.beat)}t[s]=null;case"0":c[s]=null;continue;case"4":case"2":if(t[s])throw"new hold started before last ended";t[s]=i.notes[e].length+s;case"1":case"M":c[s].type=r[s];break;default:throw`invalid note type ${r[s]}`}c[s].beat=l,c[s].sec=this.beatToSec(i.bpmChanges,i.stops,l),c[s].column=s}i.notes[e]=i.notes[e].concat(c)}}i.notes[e]=i.notes[e].filter(e=>null!==e)}return i}parseSSC(e,t){const i=t.split(/\/\/-+/),s=i[0],a=i.slice(1),n={bpmChanges:[],stops:[],notes:{},backgrounds:[],banner:"no-media",difficulties:[],background:"no-media",cdtitle:null,audioUrl:null,videoUrl:null,files:e,sampleStart:0,sampleLength:10},o={};if(s.split("\n").filter(e=>e.trim().startsWith("#")).forEach(e=>{const[t,...i]=e.slice(1).split(":");let s=i.join(":").trim().replace(/;+$/,"");["BPMS","STOPS","BGCHANGES"].includes(t)&&(s=s.split(",").map(e=>e.trim()).join(",")),o[t]=s}),o.MUSIC&&e[o.MUSIC.toLowerCase()]){const t=e[o.MUSIC.toLowerCase()];n.audioUrl=t.localURL?t.localURL:URL.createObjectURL(t),n.audio=o.MUSIC}if(Object.assign(n,{title:o.TITLE||"",subtitle:o.SUBTITLE||"",artist:o.ARTIST||"",titleTranslit:o.TITLETRANSLIT||"",subtitleTranslit:o.SUBTITLETRANSLIT||"",artistTranslit:o.ARTISTTRANSLIT||"",genre:o.GENRE||"",credit:o.CREDIT||"",offset:Number(o.OFFSET)||0,sampleStart:Number(o.SAMPLESTART)||0,sampleLength:Number(o.SAMPLELENGTH)||10}),o.BANNER&&e[o.BANNER.toLowerCase()]){const t=e[o.BANNER.toLowerCase()];n.banner=t.localURL?t.localURL:URL.createObjectURL(t)}if(o.BACKGROUND&&e[o.BACKGROUND.toLowerCase()]){const t=e[o.BACKGROUND.toLowerCase()];n.background=t.localURL?t.localURL:URL.createObjectURL(t)}if(o.BPMS){const e=o.BPMS.split(",").map(e=>{const[t,i]=e.split("=");return{beat:Number(t),bpm:Number(i)}});n.bpmChanges=e}if(o.STOPS){const e=o.STOPS.split(",").map(e=>{const[t,i]=e.split("=");return{beat:Number(t),len:Number(i)}});n.stops=e}if(n.bpmChanges.length>0){n.bpmChanges.sort((e,t)=>e.beat-t.beat),n.bpmChanges[0].sec=0;for(let e=1;e<n.bpmChanges.length;e++)n.bpmChanges[e].sec=this.beatToSec(n.bpmChanges,n.stops,n.bpmChanges[e].beat);for(let e=0;e<n.stops.length;e++)n.stops[e].sec=this.beatToSec(n.bpmChanges,n.stops,n.stops[e].beat)}return a.forEach(e=>{const t=e.split("\n").filter(e=>""!==e.trim()),i={};let s=!1,a=[];if(t.forEach(e=>{if(e.startsWith("#")){if(e.startsWith("#NOTES"))s=!0;else if(!e.startsWith("#NOTEDATA")&&!e.startsWith("#CHARTNAME")){const[t,...s]=e.slice(1).split(":"),a=s.join(":").trim().replace(/;+$/,"");i[t]=a}}else s&&(";"===e.trim()?s=!1:a.push(e.trim()))}),i.DIFFICULTY&&i.METER){const e=`${i.DIFFICULTY}${i.METER}`;n.difficulties.push({type:i.DIFFICULTY,rating:i.METER}),n.notes[e]=this.convertSSCNotes(a,n.bpmChanges,n.stops)}}),n}convertSSCNotes(e,t,i){const s=[];let a=0;return e.forEach(e=>{const n=e.split("\n").filter(e=>""!==e.trim()),o=n.length;n.forEach((e,n)=>{const r=4*a+n/o*4;for(let a=0;a<4&&a<e.length;a++){const n=e[a];if("0"!==n&&"3"!==n){const e={type:n,beat:r,sec:this.beatToSec(t,i,r),column:a};s.push(e)}}}),a++}),s}getLastBpm(e,t,i){return e.find((e,s,a)=>s+1==a.length||a[s+1][i]>=t)}beatToSec(e,t,i){if(!e||0===e.length)return i;let s=this.getLastBpm(e,i,"beat"),a=(i-s.beat)/s.bpm*60+s.sec,n=t.filter(({beat:e})=>e>=s.beat&&e<i).map(e=>e.len);for(let e in n)a+=n[e];return a}}class AddonManager{constructor(){this.addons=new Map,this.enabledAddons=new Set,this.hibernatingAddons=new Set,this.safeMode=!1,this.isInitialized=!1}async initialize(){if(!this.isInitialized){if(this.safeMode=Account.settings?.safeMode||!1,this.enabledAddons=new Set(Account.settings?.enabledAddons||[]),this.hibernatingAddons=new Set(Account.settings?.hibernatingAddons||[]),this.safeMode)return console.log(" Addon Safe Mode enabled - skipping addon loading"),void(this.isInitialized=!0);await this.loadAddons(),this.isInitialized=!0}}async loadAddons(){try{console.log(" Loading addons..."),await this.loadAddonsFromStorage(),await this.processAddons()}catch(e){console.error("Error loading addons:",e)}}async loadAddonsFromStorage(){const e=new FileSystemTools;try{const t=await e.getDirectory(EXTERNAL_DIRECTORY+"Addons"),i=await e.listDirectories(t);console.log(`Found ${i.length} addon directories`);for(const t of i)try{await this.loadAddonFromDirectory(t,e)}catch(e){console.warn(`Failed to load addon from ${t.name}:`,e)}}catch(e){console.log("No external addons directory found")}}async loadAddonFromDirectory(e,t){const i=await t.listFiles(e),s={};for(const e of i){const i=await t.getFile(e);s[i.name.toLowerCase()]={entry:e,file:i,name:i.name}}const a=s["manifest.json"];if(!a)throw new Error("No manifest.json found");const n=await t.readFileContent(a.file),o=JSON.parse(n);if(!o.id||!o.name||!o.version)throw new Error("Invalid manifest: missing required fields");const r={id:o.id,name:o.name,version:o.version,icon:o.icon,author:o.author||"Unknown",description:o.description||"",manifest:o,directory:e,dir:e,files:s,assets:[],behaviors:{},isEnabled:this.enabledAddons.has(o.id)&&!this.hibernatingAddons.has(o.id),isHibernating:this.hibernatingAddons.has(o.id)};o.icon&&(r.icon=r.dir.nativeURL+o.icon),this.processAddonAssets(r),this.addons.set(r.id,r),console.log(` Loaded addon: ${r.name} v${r.version} (${r.isEnabled?"enabled":"disabled"})`)}async processAddons(){for(const[e,t]of this.addons)if(t.isEnabled)try{await this.processAddonBehaviors(t)}catch(e){console.error(`Failed to process addon ${t.name}:`,e)}}processAddonAssets(e){const t=e.manifest.assets;if(!t)return;const i={};window.gameResources.forEach(e=>i[e.key]=e);for(const[s,a]of Object.entries(t)){const t=e.dir.nativeURL+a;e.assets;i[s]?e.assets.push({...i[s],key:s,url:t}):e.assets.push({type:"image",key:s,url:t})}}async processAddonBehaviors(e){const t=e.manifest.behaviors;if(t)for(const[i,s]of Object.entries(t)){const t=e.dir.nativeURL+s,a=await this.loadTextFile(t);e.behaviors[i]={content:a,stateName:i}}}async loadTextFile(e){return new Promise((t,i)=>{const s=new XMLHttpRequest;s.open("GET",e),s.onload=()=>{200===s.status?t(s.responseText):t(null)},s.onerror=()=>t(null),s.send()})}async readFileContent(e){return new Promise((t,i)=>{const s=new FileReader;s.onload=()=>t(s.result),s.onerror=()=>i(s.error),s.readAsText(e)})}executeBehavior(e,t,i,s){const a=e.behaviors[t];if(a)try{const t={global:i.global,game:game,state:i.state,addon:e,console:console,...s||{}};new Function(...Object.keys(t),`${a.content}`).call(i.global||window,...Object.values(t))}catch(i){console.error(`Error executing behavior for ${e.name} in ${t}:`,i)}}executeGlobalBehaviors(){for(const[e,t]of this.addons)!t.isHibernating&&t.isEnabled&&this.executeBehavior(t,"Global",{game:game,global:window})}executeStateBehaviors(e,t,i){for(const[s,a]of this.addons)!a.isHibernating&&a.isEnabled&&this.executeBehavior(a,e,{game:game,global:t,state:t,stateName:e,extraParams:i})}parseVersion(e){const t=e.split(".").map(e=>parseInt(e,10)||0);for(;t.length<3;)t.push(0);return t}compareVersions(e,t){for(let i=0;i<3;i++){if(e[i]>t[i])return 1;if(e[i]<t[i])return-1}return 0}enableAddon(e){const t=this.addons.get(e);return!!t&&(t.isEnabled=!0,this.enabledAddons.add(e),this.hibernatingAddons.delete(e),this.saveAddonSettings(),!0)}disableAddon(e){const t=this.addons.get(e);return!!t&&(t.isEnabled=!1,this.enabledAddons.delete(e),this.saveAddonSettings(),!0)}hibernateAddon(e){const t=this.addons.get(e);return!!t&&(t.isEnabled=!1,t.isHibernating=!0,this.enabledAddons.delete(e),this.hibernatingAddons.add(e),this.saveAddonSettings(),!0)}wakeAddon(e){const t=this.addons.get(e);return!(!t||!t.isHibernating)&&(t.isEnabled=!0,t.isHibernating=!1,this.enabledAddons.add(e),this.hibernatingAddons.delete(e),this.saveAddonSettings(),!0)}uninstallAddon(e){const t=this.addons.get(e);return!!t&&(t.dir.removeRecursively(),this.addons.delete(e),!0)}setSafeMode(e){this.safeMode=e,Account.settings.safeMode=e,saveAccount()}getAddonList(){return Array.from(this.addons.values()).map(e=>({id:e.id,name:e.name,version:e.version,author:e.author,description:e.description,isEnabled:e.isEnabled,isHibernating:e.isHibernating,icon:e.icon,assets:e.assets,behaviors:e.behaviors,hasAssets:Object.keys(e.assets).length>0,hasBehaviors:Object.keys(e.behaviors).length>0}))}getResourceList(){let e=[];return Array.from(this.addons.values()).forEach(t=>{!t.isHibernating&&t.isEnabled&&(e=[...e,...t.assets])}),e}saveAddonSettings(){Account.settings.enabledAddons=Array.from(this.enabledAddons),Account.settings.hibernatingAddons=Array.from(this.hibernatingAddons),Account.settings.safeMode=this.safeMode,saveAccount()}needsReload(){const e=new Set(Account.settings?.enabledAddons||[]),t=new Set(Account.settings?.hibernatingAddons||[]),i=Account.settings?.safeMode||!1;return!this.setsEqual(e,this.enabledAddons)||!this.setsEqual(t,this.hibernatingAddons)||i!==this.safeMode}setsEqual(e,t){if(e.size!==t.size)return!1;for(const i of e)if(!t.has(i))return!1;return!0}}class Boot{preload(){this.load.baseURL="assets/",this.keys=[],Object.keys(FONTS).forEach(e=>{const t=FONTS[e];this.load.spritesheet(t.font,`fonts/${e}.png`,t.fontWidth||4,t.fontHeight||6)}),WINDOW_PANELS.forEach(e=>{this.load.spritesheet(`ui_window_${e}`,`ui/window_${e}.png`,8,8),this.keys.push(`ui_window_${e}`)})}create(){gamepad=new Gamepad(game),notifications=new NotificationSystem,achievementsManager=new AchievementsManager,achievementsManager.initialize(),game.time.advancedTiming=!0,game.world.updateOnlyExistingChildren=!0,game.onMenuIn=new Phaser.Signal,game.state.add("Load",Load),game.state.add("LoadCordova",LoadCordova),game.state.add("LoadAddons",LoadAddons),game.state.add("LoadLocalSongs",LoadLocalSongs),game.state.add("LoadExternalSongs",LoadExternalSongs),game.state.add("LoadSongFolder",LoadSongFolder),game.state.add("Title",Title),game.state.add("MainMenu",MainMenu),game.state.add("SongSelect",SongSelect),game.state.add("CharacterSelect",CharacterSelect),game.state.add("AchievementsMenu",AchievementsMenu),game.state.add("StatsMenu",StatsMenu),game.state.add("Play",Play),game.state.add("Results",Results),game.state.add("Jukebox",Jukebox),game.state.add("Credits",Credits),window.primaryAssets=this.keys,window.gameResources=[{key:"ui_loading_dots",url:"ui/loading_dots.png",type:"spritesheet",frameWidth:26,frameHeight:6},{key:"ui_background_gradient",url:"ui/background_gradient.png"},{key:"ui_logo_shape",url:"ui/logo_shape.png"},{key:"ui_hud_background",url:"ui/hud_background.png"},{key:"ui_lobby_background",url:"ui/lobby_background.png"},{key:"ui_lobby_overlay",url:"ui/lobby_overlay.png"},{key:"ui_navigation_hint_keyboard",url:"ui/navigation_hint_keyboard.png",type:"spritesheet",frameWidth:192,frameHeight:112},{key:"ui_glitch_animation",url:"ui/glitch_animation.png",type:"spritesheet",frameWidth:192,frameHeight:112},{key:"ui_navigation_hint_gamepad",url:"ui/navigation_hint_gamepad.png",type:"spritesheet",frameWidth:192,frameHeight:112},{key:"ui_difficulty_banner",url:"ui/difficulty_banner.png"},{key:"ui_lifebar",url:"ui/lifebar.png",type:"spritesheet",frameWidth:1,frameHeight:5},{key:"ui_skill_bar",url:"ui/skill_bar.png",type:"spritesheet",frameWidth:2,frameHeight:2},{key:"ui_accuracy_bar",url:"ui/accuracy_bar.png"},{key:"ui_jukebox_pause_toggle",url:"ui/jukebox_pause_toggle.png",type:"spritesheet",frameWidth:12,frameHeight:12},{key:"ui_jukebox_seek",url:"ui/jukebox_seek.png",type:"spritesheet",frameWidth:8,frameHeight:8},{key:"ui_jukebox_skip",url:"ui/jukebox_skip.png",type:"spritesheet",frameWidth:8,frameHeight:8},{key:"ui_jukebox_menu",url:"ui/jukebox_menu.png",type:"spritesheet",frameWidth:8,frameHeight:8},{key:"ui_jukebox_visualization",url:"ui/jukebox_visualization.png",type:"spritesheet",frameWidth:8,frameHeight:8},{key:"assist_tick",type:"audio",url:"sfx/assist_tick.ogg"},{key:"level_up",type:"audio",url:"sfx/level_up.ogg"},{key:"exp_up",type:"audio",url:"sfx/exp_up.ogg"},{key:"arrows",url:"chart/arrows.png",type:"spritesheet",frameWidth:16,frameHeight:16},{key:"receptor",url:"chart/receptor.png",type:"spritesheet",frameWidth:16,frameHeight:16},{key:"explosion",url:"chart/explosion.png",type:"image"},{key:"mineexplosion",url:"chart/mine_explosion.png",type:"image"},{key:"mine",url:"chart/mine.png",type:"spritesheet",frameWidth:16,frameHeight:16},{key:"hold_end",url:"chart/hold_end.png",type:"spritesheet",frameWidth:16,frameHeight:8},{key:"hold_body",url:"chart/hold_body.png",type:"spritesheet",frameWidth:16,frameHeight:112},{key:"roll_end",url:"chart/roll_end.png",type:"spritesheet",frameWidth:16,frameHeight:8},{key:"roll_body",url:"chart/roll_body.png",type:"spritesheet",frameWidth:16,frameHeight:16},{key:"character_base",url:"character/base.png",type:"spritesheet",frameWidth:100,frameHeight:100},{key:"character_eyes",url:"character/eyes.png",type:"spritesheet",frameWidth:100,frameHeight:100},...(()=>{const e=[];for(let t=1;t<=CHARACTER_SYSTEM.HAIR_STYLES.front.length;t++)e.push({key:`character_front_hair_${t}`,url:`character/front_hair_${t}.png`,type:"spritesheet",frameWidth:100,frameHeight:100});for(let t=1;t<=CHARACTER_SYSTEM.HAIR_STYLES.back.length;t++)e.push({key:`character_back_hair_${t}`,url:`character/back_hair_${t}.png`,type:"spritesheet",frameWidth:100,frameHeight:100});return e})(),...(()=>{const e=[];return CHARACTER_ITEMS.clothing.forEach(t=>{e.push({key:`character_clothing_${t.id}`,url:`character/${t.id}.png`,type:"spritesheet",frameWidth:100,frameHeight:100})}),CHARACTER_ITEMS.accessories.forEach(t=>{e.push({key:`character_accessory_${t.id}`,url:`character/${t.id}.png`,type:"spritesheet",frameWidth:100,frameHeight:100})}),e})(),{key:"character_noise",url:"ui/character_noise.png",type:"spritesheet",frameWidth:36,frameHeight:7}],window.addEventListener("keydown",e=>{if("INPUT"!==document.activeElement.tagName)switch(e.code){case"F8":e.preventDefault(),game.recorder&&game.recorder.screenshot();break;case"F9":e.preventDefault(),game.recorder.isRecording?game.recorder.stop():game.recorder.start();break;case"F10":e.preventDefault(),window.recordNextGame=!0}}),game.state.start("Load",!0,!1,window.gameResources,"LoadCordova")}}class Load{init(e,t,i){this.resources=e||[],this.nextState=t||"Title",this.nextStateParams=i||{},this.loadedCount=0,this.totalCount=this.resources.length}preload(){this.resources.forEach(e=>{switch(e.type){case void 0:case"image":this.load.image(e.key,e.url);break;case"spritesheet":this.load.spritesheet(e.key,e.url,e.frameWidth,e.frameHeight);break;case"audio":this.load.audio(e.key,e.url);break;case"video":this.load.video(e.key,e.url,"canplay",!0);break;case"json":this.load.json(e.key,e.url);break;case"text":this.load.text(e.key,e.url)}this.loadedCount++}),this.progressText=new ProgressText("LOADING ASSETS")}create(){game.state.start(this.nextState,!0,!1,this.nextStateParams)}}class LoadCordova{create(){CURRENT_ENVIRONMENT==ENVIRONMENT.CORDOVA?this.loadScript():this.createFolderStructure()}loadScript(){this.loadingDots=new LoadingDots,this.progressText=new ProgressText("INITIALIZING FILESYSTEM");const e=document.createElement("script");e.src="./cordova/cordova.js",document.head.appendChild(e),document.addEventListener("deviceready",()=>{this.createFolderStructure(),document.addEventListener("backbutton",()=>{"Play"==game.state.current?gamepad.press("start"):gamepad.press("b")})})}async createFolderStructure(){if(CURRENT_ENVIRONMENT==ENVIRONMENT.CORDOVA||CURRENT_ENVIRONMENT==ENVIRONMENT.NWJS){const e=new FileSystemTools,t=await e.getDirectory(""),i=await e.createDirectory(t,EXTERNAL_DIRECTORY);await e.createDirectory(i,"Addons"),await e.createDirectory(i,"Screenshots"),await e.createDirectory(i,"Songs")}this.continue()}continue(){game.state.start("LoadAddons")}}class LoadAddons{create(){this.progressText=new ProgressText("LOADING ADD-ONS"),this.loadingDots=new LoadingDots,this.initialize()}async initialize(){addonManager=new AddonManager,await addonManager.initialize(),addonManager.executeGlobalBehaviors();const e=addonManager.getResourceList();game.load.baseURL="",game.state.start("Load",!0,!1,e,"LoadLocalSongs")}}class LoadLocalSongs{create(){this.progressText=new ProgressText("LOADING SONGS"),this.songs=[],this.parser=new LocalSMParser,this.loadSongs(),this.loadingDots=new LoadingDots}async loadSongs(){try{const e=DEFAULT_SONG_FOLDERS;for(const t of e)try{const e=await this.loadSong(t);e&&this.songs.push(e)}catch(e){console.warn(`Failed to load song from ${t}:`,e)}this.finish()}catch(e){console.error("Error loading songs:",e)}}async loadSong(e){const t=`assets/songs/${e}/`;try{let i=t+e+".sm",s=await this.loadTextFile(i);if(!s){const e=["song.sm","chart.sm","steps.sm"];for(const i of e)if(s=await this.loadTextFile(t+i),s)break}if(!s)throw new Error(`No .sm file found in ${e}`);const a=await this.parser.parseSM(s,t);return a.folderName=e,a.loaded=!0,a}catch(t){return console.warn(`Could not load song ${e}:`,t),null}}async loadTextFile(e){return new Promise((t,i)=>{const s=new XMLHttpRequest;s.open("GET",e),s.onload=()=>{200===s.status?t(s.responseText):t(null)},s.onerror=()=>t(null),s.send()})}finish(){window.localSongs=this.songs,game.state.start("Title")}}class LoadExternalSongs{init(e,t){this.nextState=e||"SongSelect",this.nextStateParams=t||[]}create(){if(this.loadingDots=new LoadingDots,this.progressText=new ProgressText("LOADING EXTERNAL SONGS"),this.fileSystem=new FileSystemTools,window.externalSongs)return this.songs=window.externalSongs,void this.finish(window.lastExternalSongIndex||0);this.songs=[],this.parser=new ExternalSMParser,this.loadedCount=0,this.failedCount=0,this.totalCount=0,this.currentlyLoading=new Set,CURRENT_ENVIRONMENT==ENVIRONMENT.CORDOVA||CURRENT_ENVIRONMENT==ENVIRONMENT.NWJS?this.loadSongsFromStorage():this.showFileInput()}async loadSongsFromStorage(){try{console.log("Loading songs from external storage...");const e=await this.fileSystem.getDirectory(EXTERNAL_DIRECTORY+"Songs"),t=await this.fileSystem.listAllDirectories(e);t.unshift(e),this.totalCount=t.length,this.updateProgress(),console.log(`Found ${this.totalCount} directories to scan`),await this.loadDirectoriesSequential(t),this.finish()}catch(e){console.error("Error loading external songs:",e),this.showError("Failed to load external songs: "+e.message)}}async loadDirectoriesParallel(e){const t=[];for(let i=0;i<e.length;i+=16)t.push(e.slice(i,i+16));for(const e of t)await this.processDirectoryBatch(e)}async processDirectoryBatch(e){const t=e.map(e=>this.processSongDirectoryWithTracking(e));await Promise.allSettled(t)}async loadDirectoriesSequential(e){for(const t of e)await this.processSongDirectoryWithTracking(t)}async processSongDirectoryWithTracking(e){const t=e.name||"Unknown Directory";this.currentlyLoading.add(t);try{const i=await this.processSongDirectory(e);i?(this.songs.push(i),this.loadedCount++,console.log(` Loaded: ${i.title||t}`)):(this.failedCount++,console.log(` Failed: ${t} (no valid chart found)`))}catch(e){console.warn(` Error in ${t}:`,e),this.failedCount++}finally{this.currentlyLoading.delete(t),this.updateProgress()}}async processSongDirectory(e){try{const t=await this.fileSystem.listFiles(e),i={};for(const e of t){const t=await this.fileSystem.getFile(e);i[t.name.toLowerCase()]=t}const s=Object.keys(i).filter(e=>e.endsWith(".sm")||e.endsWith(".ssc"));if(0===s.length)return console.log(`No chart files found in ${e.name}`),null;for(const t of s)try{console.log(`Trying to parse ${t} in ${e.name}`);const s=await this.fileSystem.readFileContent(i[t]),a=this.parser.parseSM(i,s);if(a&&a.difficulties&&a.difficulties.length>0)return a.folderName=e.name||"External Song",a.loaded=!0,console.log(` Successfully parsed ${t}`),a}catch(e){console.warn(`Failed to parse ${t}:`,e);continue}return console.log(`No valid chart files in ${e.name}`),null}catch(t){return console.warn(`Error processing directory ${e.name}:`,t),null}}updateProgress(){const e=this.loadedCount+this.failedCount,t=this.totalCount>0?Math.round(e/this.totalCount*100):0,i=`${this.loadedCount}/${this.totalCount-this.failedCount} (${t}%)`;this.progressText.write(i)}showFileInput(){const e=document.createElement("input");e.type="file",e.webkitdirectory=!0,e.multiple=!0,e.onchange=e=>{this.processFileInput(e.target.files)},e.click()}async processFileInput(e){try{const t={};for(let i=0;i<e.length;i++)t[e[i].name.toLowerCase()]=e[i];const i={};for(const t of e){const e=t.webkitRelativePath.split("/")[0];i[e]||(i[e]={}),i[e][t.name.toLowerCase()]=t}const s=Object.keys(i);this.totalCount=s.length,this.updateProgress(),await this.processFileDirectoriesSequential(i,s),this.finish()}catch(e){console.error("Error processing file input:",e),this.showError("Failed to load songs from files: "+e.message)}}async processFileDirectoriesParallel(e,t){const i=[];for(let e=0;e<t.length;e+=16)i.push(t.slice(e,e+16));for(const t of i)await this.processFileDirectoryBatch(e,t)}async processFileDirectoryBatch(e,t){const i=t.map(t=>this.processSongFilesWithTracking(e[t],t));await Promise.allSettled(i)}async processFileDirectoriesSequential(e,t){for(const i of t)await this.processSongFilesWithTracking(e[i],i)}async processSongFilesWithTracking(e,t){this.currentlyLoading.add(t);try{const i=await this.processSongFiles(e,t);i?(this.songs.push(i),this.loadedCount++,console.log(` Loaded: ${i.title||t}`)):(this.failedCount++,console.log(` Failed: ${t} (no valid chart found)`))}catch(e){console.warn(` Error in ${t}:`,e),this.failedCount++}finally{this.currentlyLoading.delete(t),this.updateProgress()}}async processSongFiles(e,t){const i=Object.keys(e).filter(e=>e.endsWith(".sm")||e.endsWith(".ssc"));if(0===i.length)return console.log(`No chart files found in ${t}`),null;for(const s of i)try{console.log(`Trying to parse ${s} in ${t}`);const i=await this.fileSystem.readFileContent(e[s]),a=this.parser.parseSM(e,i);if(a&&a.difficulties&&a.difficulties.length>0)return a.folderName=t,a.loaded=!0,console.log(` Successfully parsed ${s}`),a}catch(e){console.warn(`Failed to parse ${s}:`,e);continue}return console.log(`No valid chart files in ${t}`),null}showError(e){this.progressText.write(e),game.time.events.add(3e3,()=>{game.state.start("MainMenu")})}finish(e=0){console.log(`Loading complete: ${this.loadedCount} songs loaded, ${this.failedCount} failed`),0!==this.songs.length?(window.externalSongs=this.songs,this.nextStateParams.length?game.state.start(this.nextState,!0,!1,...this.nextStateParams):game.state.start(this.nextState,!0,!1,this.songs),setTimeout(()=>window.lastExternalSongIndex=window.selectStartingIndex)):this.showError("No external songs found")}}class LoadSongFolder{create(){this.progressText=new ProgressText("SELECT SONG FOLDER"),this.parser=new ExternalSMParser,this.showFileInput()}showFileInput(){const e=document.createElement("input");e.type="file",e.webkitdirectory=!0,e.multiple=!0,e.onchange=e=>{this.processFiles(e.target.files)},e.webkitdirectory||(e.multiple=!0,this.progressText.write("Select all song files")),e.click()}async processFiles(e){try{this.progressText.write("LOADING SONG...");const t={};for(let i=0;i<e.length;i++)t[e[i].name.toLowerCase()]=e[i];const i=Object.keys(t).filter(e=>e.endsWith(".sm"));if(0===i.length)return void this.showError("No .sm file found in selected folder");const s=i[0],a=await this.readFileContent(t[s]),n=this.parser.parseSM(t,a);n.folderName=`Single_External_${s}`,n.loaded=!0,game.state.start("SongSelect",!0,!1,[n],0,!0)}catch(e){console.error("Error loading song folder:",e),this.showError("Failed to load song")}}readFileContent(e){return new Promise((t,i)=>{const s=new FileReader;s.onload=()=>t(s.result),s.onerror=()=>i(s.error),s.readAsText(e)})}showError(e){this.progressText.write(e),game.time.events.add(3e3,()=>{game.state.start("MainMenu")})}}class Title{create(){game.camera.fadeIn(16777215),this.background=new BackgroundGradient,this.lines=new FuturisticLines,this.logo=new Logo,this.inputInstructionText=new Text(game.width/2,80,"PRESS ANY KEY"),this.inputInstructionText.anchor.x=.5,game.add.tween(this.inputInstructionText).to({alpha:0},500,"Linear",!0,0,-1).yoyo(!0),this.text=game.add.sprite(0,0),this.creditText=new Text(2,110,COPYRIGHT,this.text),this.creditText.anchor.y=1,this.creditText=new Text(190,110,VERSION,this.text),this.creditText.anchor.set(1),backgroundMusic||(backgroundMusic=new BackgroundMusic),backgroundMusic.playLastSong(),this.introEnded=!1,this.logo.intro(()=>this.introEnded=!0),addonManager.executeStateBehaviors(this.constructor.name,this)}update(){gamepad.update(),this.introEnded&&!this.outroStarted&&gamepad.pressed.any&&(this.outroStarted=!0,this.text.alpha=0,this.logo.outro(()=>game.state.start("MainMenu")))}}class MainMenu{create(){game.camera.fadeIn(16777215),this.futuristicLines=new FuturisticLines,this.backgroundGradient=new BackgroundGradient,this.navigationHint=new NavigationHint(0),this.menu(),this.previewCanvas=document.createElement("canvas"),this.previewCtx=this.previewCanvas.getContext("2d"),this.previewImg=new Image,backgroundMusic&&backgroundMusic.isPlaying||(backgroundMusic||(backgroundMusic=new BackgroundMusic),backgroundMusic.playLastSong()),this.keepBackgroundMusic=!1,addonManager.executeStateBehaviors(this.constructor.name,this)}menu(){const e=new WindowManager;this.manager=e;const t=()=>{const e=new CarouselMenu(0,40,112,56,{align:"left",bgcolor:"brown",fgcolor:"#ffffff",animate:!0,crop:!1});e.addItem("Rhythm Game",()=>i()),e.addItem("Character Select",()=>{this.keepBackgroundMusic=!0,game.state.start("CharacterSelect")}),e.addItem("Settings",()=>n()),e.addItem("Extras",()=>o()),game.onMenuIn.dispatch("home",e),CURRENT_ENVIRONMENT!=ENVIRONMENT.CORDOVA&&CURRENT_ENVIRONMENT!=ENVIRONMENT.NWJS||(e.addItem("Exit",()=>u()),e.onCancel.add(()=>u()))},i=()=>{const e=new CarouselMenu(0,40,112,56,{align:"left",bgcolor:"brown",fgcolor:"#ffffff",animate:!0,crop:!1});e.addItem("Free Play",()=>this.freePlay()),e.addItem("Extra Songs",()=>s()),game.onMenuIn.dispatch("startGame",e),e.addItem("< Back",()=>t()),e.onCancel.add(()=>t())},s=()=>{const e=new CarouselMenu(0,40,112,56,{align:"left",bgcolor:"brown",fgcolor:"#ffffff",animate:!0,crop:!1});CURRENT_ENVIRONMENT!=ENVIRONMENT.CORDOVA&&CURRENT_ENVIRONMENT!=ENVIRONMENT.NWJS||e.addItem("User Songs",()=>this.loadExternalSongs()),e.addItem("Load Single Song",()=>this.loadSingleSong()),!window.externalSongs||CURRENT_ENVIRONMENT!=ENVIRONMENT.CORDOVA&&CURRENT_ENVIRONMENT!=ENVIRONMENT.NWJS||e.addItem("Reload User Songs",()=>{backgroundMusic.refreshCache(),window.externalSongs=void 0,this.loadExternalSongs()}),game.onMenuIn.dispatch("extraSongs",e),e.addItem("< Back",()=>t()),e.onCancel.add(()=>t())};let a;const n=()=>{a=e.createWindow(3,1,18,12,"1"),a.fontTint=7797982,a.addSettingItem("Volume",["0%","25%","50%","75%","100%"],Account.settings.volume,e=>{Account.settings.volume=e,saveAccount(),backgroundMusic.audio.volume=[0,25,50,75,100][e]/100}),a.addSettingItem("Auto-play",["OFF","ON"],Account.settings.autoplay?1:0,e=>{Account.settings.autoplay=1===e,saveAccount()});const i=["OFF","Note","Quarters","Eighths","Sixteenths","Thirty-seconds"],s=Account.settings.metronome||"OFF",n=i.indexOf(s);a.addSettingItem("Metronome",i,n,e=>{const t=i[e];Account.settings.metronome=t,saveAccount()});let o=0;o=Account.settings.enableMenuMusic?Account.settings.randomSong?1:0:2;const r=["NONE","BPM","ACCURACY","AUDIO"],c=Account.settings.visualizer||"NONE",u=r.indexOf(c);a.addSettingItem("Visualizer",r,u,e=>{const t=r[e];Account.settings.visualizer=t,saveAccount()}),a.addSettingItem("Scroll Direction",["FALLING","RISING"],"falling"===Account.settings.scrollDirection?0:1,e=>{Account.settings.scrollDirection=0===e?"falling":"rising",saveAccount()});const g=[{value:"NOTE",display:"NOTE"},{value:"VIVID",display:"VIVID"},{value:"FLAT",display:"FLAT"},{value:"RAINBOW",display:"RAINBOW"}],m=Account.settings.noteColorOption||"NOTE",p=g.findIndex(e=>e.value===m);a.addSettingItem("Note Colors",g.map(e=>e.display),p,e=>{const t=g[e].value;Account.settings.noteColorOption=t,saveAccount()}),a.addSettingItem("Note Speed",["Normal","Double","Triple","Insane","Sound Barrier","Light Speed","Faster than light"],Account.settings.noteSpeedMult-1,e=>{Account.settings.noteSpeedMult=e+1,saveAccount()}),a.addSettingItem("Speed Mod",["X-MOD","C-MOD"],"C-MOD"===Account.settings.speedMod?1:0,e=>{Account.settings.speedMod=1===e?"C-MOD":"X-MOD",saveAccount()}),a.addSettingItem("Beat Lines",["YES","NO"],Account.settings.beatLines?0:1,e=>{Account.settings.beatLines=0===e,saveAccount()});const f=[];for(let e=-1e3;e<=1e3;e+=25)f.push(`${e}ms`);const E=((Account.settings.userOffset||0)+1e3)/25;a.addSettingItem("Global Offset",f,E,e=>{const t=25*e-1e3;Account.settings.userOffset=t,saveAccount()}),a.addSettingItem("Menu Music",["LAST SONG","RANDOM SONG","OFF"],o,e=>{switch(e){case 0:Account.settings.randomSong=!1,Account.settings.enableMenuMusic=!0;break;case 1:Account.settings.randomSong=!0,Account.settings.enableMenuMusic=!0;break;case 2:Account.settings.enableMenuMusic=!1}saveAccount()});let S=!1;a.addSettingItem("Renderer",["AUTO","CANVAS","WEBGL"],Account.settings.renderer,e=>{Account.settings.renderer=e,saveAccount(),S=!0}),a.addSettingItem("Pixelated",["YES","NO"],Account.settings.pixelated?0:1,e=>{Account.settings.pixelated=0==e,S=!0,saveAccount()}),a.addSettingItem("Safe Mode",["ENABLED","DISABLED"],Account.settings.safeMode?0:1,e=>{S=!0;const t=0==e;addonManager?.setSafeMode(t),saveAccount()}),a.addItem("Erase Highscores","",()=>l()),game.onMenuIn.dispatch("settings",a),a.addItem("Restore Default Settings","",()=>h()),a.addItem("APPLY","",()=>{e.remove(a,!0),S?d():t()},!0)},o=()=>{const e=new CarouselMenu(0,40,112,56,{align:"left",bgcolor:"brown",fgcolor:"#ffffff",animate:!0,crop:!1});CURRENT_ENVIRONMENT!=ENVIRONMENT.CORDOVA&&CURRENT_ENVIRONMENT!=ENVIRONMENT.NWJS||e.addItem("Addon Manager",()=>this.addonManager()),e.addItem("Offset Assistant",()=>this.startOffsetAssistant()),e.addItem("Jukebox",()=>r()),e.addItem("Player Stats",()=>this.showStats()),e.addItem("Achievements",()=>this.showAchievements()),e.addItem("Credits",()=>this.showCredits()),game.onMenuIn.dispatch("extras",e),e.addItem("< Back",()=>t()),e.onCancel.add(()=>t())},r=()=>{CURRENT_ENVIRONMENT==ENVIRONMENT.CORDOVA||CURRENT_ENVIRONMENT==ENVIRONMENT.NWJS?window.externalSongs?game.state.start("Jukebox"):c("Load extra songs from external storage?",()=>{game.state.start("LoadExternalSongs",!0,!1,"Jukebox",[void 0,void 0])},()=>{game.state.start("Jukebox")}):game.state.start("Jukebox")},c=(t,i,s)=>{e.remove(a,!0);const n=new Text(game.width/2,40,t||"You sure?",FONTS.shaded);n.anchor.x=.5;const o=e.createWindow(10,7,5,4,"1");o.fontTint=7797982,o.offset={x:7,y:0},o.addItem("Yes","",()=>{n.destroy(),e.remove(o,!0),i?.()}),o.addItem("No","",()=>{n.destroy(),e.remove(o,!0),s?.()},!0)},l=()=>c("Permanently erase hight scores?",()=>{Account.highScores={},saveAccount(),n()},()=>n()),h=()=>{c("All settings will be restored to default.\nA refresh is needed",()=>{Account.settings=DEFAULT_ACCOUNT.settings,saveAccount(),window.location.reload()},()=>n())},d=()=>c("Restart Now?",()=>location.reload(),()=>n()),u=()=>c("Sure? Exit?",()=>{switch(CURRENT_ENVIRONMENT){case ENVIRONMENT.CORDOVA:navigator.app.exitApp();break;case ENVIRONMENT.NWJS:nw?.App?.quit?.()}},()=>t());t()}freePlay(){game.state.start("SongSelect",!0,!1,window.localSongs)}startOffsetAssistant(){const e=new OffsetAssistant(game);game.add.existing(e)}loadExternalSongs(){game.state.start("LoadExternalSongs")}loadSingleSong(){game.state.start("LoadSongFolder")}addonManager(){const e=new Text(4,4,""),t=game.add.sprite(112,4),i=()=>{const e=addonManager.getAddonList(),t=new CarouselMenu(96,56,96,56,{align:"left",bgcolor:"brown",fgcolor:"#ffffff",animate:!0,crop:!1});0===e.length?t.addItem("No addons installed",()=>{}):(e.forEach(e=>{const i=e.isHibernating?"gray":e.isEnabled?"#00cc00":"brown";t.addItem(`${e.name} v${e.version}`,()=>n(e),{addon:e,bgcolor:i})}),t.onSelect.add((e,t)=>{t.data&&t.data.addon&&a(t.data.addon)}),a(e[0])),game.onMenuIn.dispatch("addons",t),t.addItem("< Back",()=>o()),t.onCancel.add(()=>o())};let s=!1;const a=i=>{e.write(`${i.name}\nV${i.version}\nBy ${i.author}\nBEHAVIORS:${i.behaviors?Object.keys(i.behaviors).length:0}\nASSETS:${i.assets?i.assets.length:0}\n\n${i.description}\nSTATE: `+(i.isHibernating?"Hybernating":i.isEnabled?"Enabled":"Disabled")+"\n").wrap(112),i.icon&&(this.previewImg.src=i.icon,this.previewImg.onload=()=>{this.previewCtx.drawImage(this.previewImg,0,0,50,50),t.loadTexture(PIXI.Texture.fromCanvas(this.previewCanvas))})},n=e=>{const t=new CarouselMenu(96,56,96,56,{align:"left",bgcolor:"#9b59b6",fgcolor:"#ffffff",animate:!0,crop:!1});e.isHibernating?t.addItem("Wake Addon",()=>{addonManager.wakeAddon(e.id),s=!0,i()}):e.isEnabled?(t.addItem("Disable Addon",()=>{addonManager.disableAddon(e.id),s=!0,i()}),t.addItem("Hibernate Addon",()=>{addonManager.hibernateAddon(e.id),s=!0,i()})):t.addItem("Enable Addon",()=>{addonManager.enableAddon(e.id),s=!0,i()}),t.addItem("Uninstall Addon",()=>r("The addon folder will be removed. Continue?",()=>{addonManager.uninstallAddon(e.id),s=!0,i()},()=>i())),game.onMenuIn.dispatch("addonDetails",t),t.addItem("< Back",()=>i()),t.onCancel.add(()=>i())},o=()=>{s||addonManager.needsReload()?r("Reload required. Restart now?",()=>{location.reload()},()=>{this.menu()}):(t.destroy(),e.destroy(),this.menu())},r=(i,s,a)=>{const n=new Text(game.width/2,40,i||"You sure?",FONTS.shaded);n.anchor.x=.5,t.destroy(),e.destroy();const o=this.manager.createWindow(10,7,5,4,"1");o.fontTint=7797982,o.offset={x:7,y:0},o.addItem("Yes","",()=>{n.destroy(),this.manager.remove(o,!0),s?.()}),o.addItem("No","",()=>{n.destroy(),this.manager.remove(o,!0),a?.()},!0)};i()}showAchievements(){game.state.start("AchievementsMenu")}showStats(){game.state.start("StatsMenu")}showCredits(){game.state.start("Credits",!0,!1,"MainMenu")}update(){gamepad.update(),this.manager?.update()}shutdown(){backgroundMusic&&!this.keepBackgroundMusic&&(backgroundMusic.destroy(),backgroundMusic=null)}}class SongSelect{init(e,t,i){this.songs=e||[],this.songs=e||(window.selectedSongs||[]),window.selectedSongs=this.songs,this.startingIndex=t||(window.selectStartingIndex||0),this.autoSelect=i||!1,this.startingIndex+1>this.songs.length&&(this.startingIndex=0)}create(){game.camera.fadeIn(0),new FuturisticLines,new BackgroundGradient,this.selectedSong=null,this.selectedDifficulty=0,backgroundMusic&&backgroundMusic.stop(),this.previewAudio=document.createElement("audio"),this.previewAudio.volume=[0,25,50,75,100][Account.settings.volume]/100,this.bannerImg=document.createElement("img"),this.cdtitleImg=document.createElement("img"),this.previewCanvas=document.createElement("canvas"),this.previewCtx=this.previewCanvas.getContext("2d"),this.navigationHint=new NavigationHint(2),this.autoplayText=new Text(4,104,""),this.bannerSprite=game.add.sprite(4,4,null),this.metadataText=new Text(102,4,""),this.highScoreText=new Text(104,50,""),this.loadingDots=new LoadingDots,this.loadingDots.visible=!1,this.visibilityChangeListener=()=>{document.hidden?this.previewAudio?.pause():this.previewAudio?.play()},window.addEventListener("visibilitychange",this.visibilityChangeListener),this.createSongSelectionMenu(),this.autoSelect&&(this.selectSong(this.songs[this.songCarousel.selectedIndex],this.songCarousel.selectedIndex),this.songCarousel.destroy(),this.autoSelect=!1),addonManager.executeStateBehaviors(this.constructor.name,this)}createSongSelectionMenu(){const e=game.width/2;this.songCarousel=new CarouselMenu(0,35,e,72,{bgcolor:"#9b59b6",fgcolor:"#ffffff",align:"left",animate:!0,margin:{left:2}}),0===this.songs.length?this.songCarousel.addItem("No songs found",null):this.songs.forEach((e,t)=>{const i=e.titleTranslit||e.title,s=i||`Song ${t+1}`;this.songCarousel.addItem(s,i=>{this.selectSong(e,t)},{song:e,index:t})}),game.onMenuIn.dispatch("songList",this.songCarousel),this.songCarousel.selectedIndex=this.startingIndex,this.songCarousel.updateSelection(),this.songCarousel.onSelect.add((e,t)=>{t.data&&t.data.song&&this.previewSong(t.data.song)}),this.songCarousel.onCancel.add(()=>{game.state.start("MainMenu")}),this.songs.length>0&&this.previewSong(this.songs[this.songCarousel.selectedIndex])}previewSong(e){this.autoSelect||(this.loadingDots.visible=!0);let t=this.songCarousel.selectedIndex;e.audioUrl&&(this.previewAudio.src=e.audioUrl,this.previewAudio.currentTime=e.sampleStart||0,this.previewAudio.play()),e.banner&&(this.bannerImg.src=e.banner,this.bannerImg.onload=()=>{t==this.songCarousel.selectedIndex&&(this.loadingDots.visible=!1),this.previewCtx.drawImage(this.bannerImg,0,0,96,32);const e=PIXI.Texture.fromCanvas(this.previewCanvas);this.bannerSprite.loadTexture(e)},this.bannerImg.onerror=()=>this.loadingDots.visible=!1),this.metadataText.write(this.getMetadataText(e)),this.metadataText.wrapPreserveNewlines(80),this.displayHighScores(e),this.startingIndex=window.selectStartingIndex=this.songCarousel.selectedIndex}displayHighScores(e){const t=this.getSongKey(e),i=Account.highScores[t];if(!i)return void(this.highScoreText&&this.highScoreText.write("NO HIGH SCORES"));let s="HIGH SCORES:\n";e.difficulties.forEach((e,t)=>{const a=`${e.type}${e.rating}`,n=i[a];s+=n?`${e.type}: ${n.score.toLocaleString()} (${n.rating})\n`:`${e.type}: ---\n`}),this.highScoreText.write(s)}getSongKey(e){if(e.folderName)return`local_${e.folderName}`;if(e.audioUrl){let t=0;for(let i=0;i<e.audioUrl.length;i++){t=(t<<5)-t+e.audioUrl.charCodeAt(i),t&=t}return`external_${t.toString(36)}`}return`unknown_${Date.now()}`}getMetadataText(e){const t=e.titleTranslit||e.title,i=e.subtitleTranslit||e.subtitle,s=e.artistTranslit||e.artist,a=(e.genre,e.credit);let n="";return t&&(n+=t+"\n"),i&&(n+=i+"\n"),s&&(n+="Artist: "+s+"\n"),a&&(n+="Credit: "+a),n}selectSong(e,t){this.selectedSong=e,this.selectedDifficulty=0,this.showDifficultySelection(e)}showDifficultySelection(e){const t=game.width/2,i=game.height;this.difficultyCarousel=new CarouselMenu(0,37,t,i,{bgcolor:"#e67e22",fgcolor:"#ffffff",align:"center",animate:!0}),game.onMenuIn.dispatch("difficulty",this.songCarousel),e.difficulties.sort((e,t)=>e.rating-t.rating).forEach((t,i)=>{this.difficultyCarousel.addItem(`${t.type} (${t.rating})`,t=>{this.startGame(e,i)},{difficulty:t,index:i,bgcolor:this.getDifficultyColor(parseInt(t.rating))})}),this.difficultyCarousel.onCancel.add(()=>{this.createSongSelectionMenu()})}getDifficultyColor(e){e=Math.max(0,Math.min(11,e));var t=25,i=210,s=25,a=210,n=0,o=0,r=Math.floor(t+e/11*(a-t)),c=Math.floor(i+e/11*(n-i)),l=Math.floor(s+e/11*(o-s));return`#${Phaser.Color.componentToHex(r)}${Phaser.Color.componentToHex(c)}${Phaser.Color.componentToHex(l)}`}startGame(e,t){const i=[];e.lyrics&&i.push({type:"text",key:"song_lyrics",url:e.lyrics}),this.load.baseURL="",i.length?game.state.start("Load",!0,!1,i,"Play",{chart:e,difficultyIndex:t}):game.state.start("Play",!0,!1,{chart:e,difficultyIndex:t})}update(){gamepad.update(),this.songCarousel&&this.songCarousel.update(),this.difficultyCarousel&&this.difficultyCarousel.update(),gamepad.pressed.select&&(Account.settings.autoplay=!Account.settings.autoplay),this.autoplayText.write(Account.settings.autoplay?"AUTOPLAY":"")}shutdown(){this.previewAudio.pause(),this.previewAudio.src=null,this.previewAudio=null,window.removeEventListener("visibilitychange",this.visibilityChangeListener)}}class CharacterSelect extends Phaser.State{create(){game.camera.fadeIn(0),this.characterManager=new CharacterManager,this.selectedCharacter=this.characterManager.getCurrentCharacter(),new Background("ui_lobby_background",!1,1),new Background("ui_lobby_overlay",!0,.3,.5),new FuturisticLines,this.navigationHint=new NavigationHint(0),this.createUI(),this.updateDisplay()}createUI(){this.characterDisplay=new CharacterDisplay(46,6,this.selectedCharacter),this.createDetailsText(),this.actionMenu=null,this.customizationMenu=null,this.skillsCarousel=null,this.creationMenu=null,this.characterCarousel=null,this.showHomeUI()}createDetailsText(){this.nameText=new Text(115,10,"",FONTS.shaded),this.levelText=new Text(140,10,"",FONTS.default),this.selectedSkillText=new Text(115,34,"",FONTS.default),this.skillDescriptionText=new Text(117,42,"",FONTS.default),this.expBar=new ExperienceBar(140,16,36,3),this.skillBar=new SkillBar(117,18)}showHomeUI(){this.clearAllMenus(),this.showCharacterDetails(),this.showCharacterList(),this.updateDisplay()}clearAllMenus(){this.characterCarousel&&(this.characterCarousel.destroy(),this.characterCarousel=null),this.actionMenu&&(this.actionMenu.destroy(),this.actionMenu=null),this.customizationMenu&&(this.customizationMenu.destroy(),this.customizationMenu=null),this.skillsCarousel&&(this.skillsCarousel.destroy(),this.skillsCarousel=null),this.creationMenu&&(this.creationMenu.destroy(),this.creationMenu=null),gamepad.signals.pressed.any.removeAll()}writeCharacterInformation(){const e=this.selectedCharacter;this.nameText.write(e?e.name:""),this.nameText.bringToTop();e&&(e.experience,e.getRequiredExperience());if(this.levelText.write(e?`Lv. ${e.level}`:""),this.levelText.bringToTop(),e?(this.expBar.setProgress(e.getExperienceProgress()),this.expBar.bringToTop(),this.expBar.visible=!0):this.expBar.visible=!1,e?(this.skillBar.value=e.skillLevel,this.skillBar.update(),this.skillBar.bringToTop(),this.skillBar.visible=!0):this.skillBar.visible=!1,e&&e.selectedSkill){const t=CHARACTER_SKILLS.find(t=>t.id===e.selectedSkill);t?(this.selectedSkillText.write(t.name),this.skillDescriptionText.write(t.description),this.skillDescriptionText.wrapPreserveNewlines(70),this.selectedSkillText.bringToTop(),this.skillDescriptionText.bringToTop()):(this.selectedSkillText.write(""),this.skillDescriptionText.write("< NO SKILL >"),this.skillDescriptionText.bringToTop())}else this.selectedSkillText.write(""),this.skillDescriptionText.write(e?"< NO SKILL >":"< NO CHARACTER >"),this.selectedSkillText.bringToTop()}selectCharacter(e){this.selectedCharacter=e,this.updateDisplay()}updateDisplay(){this.characterDisplay&&this.characterDisplay.destroy(),this.characterDisplay=new CharacterDisplay(46,6,this.selectedCharacter),this.characterCarousel&&this.characterCarousel.bringToTop(),this.writeCharacterInformation()}showCharacterList(){this.characterCarousel=new CarouselMenu(0,8,80,104,{bgcolor:"#9b59b6",fgcolor:"#ffffff",align:"left",animate:!0});let e=0;this.characterManager.getCharacterList().forEach(t=>{const i=this.selectedCharacter&&t.name===this.selectedCharacter.name;this.characterCarousel.addItem(i?`> ${t.name}`:`  ${t.name}`,()=>{this.selectCharacter(t),this.showActionMenu()},{character:t,bgcolor:i?"#e74c3c":"#9b59b6"}),i&&this.characterCarousel.selectIndex(e),e++}),this.characterCarousel.addItem(" NO CHARACTER",()=>{this.selectedCharacter=null,this.characterManager.unsetCharacter(),this.showHomeUI()},{bgcolor:this.selectedCharacter?"#9b59b6":"#e74c3c"}),this.selectedCharacter||this.characterCarousel.selectIndex(e),this.characterCarousel.addItem("+ ADD CHARACTER",()=>this.startCharacterCreation()),this.characterCarousel.onSelect.add((e,t)=>{this.selectCharacter(t.data.character||null)}),this.showCharacterDetails(),this.characterCarousel.onCancel.add(()=>{game.state.start("MainMenu")})}showActionMenu(){this.clearAllMenus(),this.hideCharacterDetails(),this.actionMenu=new CarouselMenu(60,60,72,48,{bgcolor:"#34495e",fgcolor:"#ffffff",align:"center",activeAlpha:1,inactiveAlpha:.5}),this.actionMenu.addItem("SELECT",()=>this.confirmSelection()),this.selectedCharacter.unlockedSkills.length&&this.actionMenu.addItem("SET SKILL",()=>this.setSkill()),this.actionMenu.addItem("CUSTOMIZE",()=>this.customizeCharacter()),this.actionMenu.addItem("DELETE",()=>this.deleteCharacter()),this.actionMenu.onCancel.add(()=>{this.showHomeUI()})}confirmSelection(){this.characterManager.setCurrentCharacter(this.selectedCharacter.name),this.showCharacterList()}setSkill(){this.hideCharacterDetails(),this.skillPreviewText=new Text(110,4,"",FONTS.default),this.skillPreviewText.wrapPreserveNewlines(70),this.skillsCarousel=new CarouselMenu(0,8,80,104,{bgcolor:"#9b59b6",fgcolor:"#ffffff",align:"left",animate:!0});let e=0,t=0;this.selectedCharacter.unlockedSkills.forEach(i=>{const s=CHARACTER_SKILLS.find(e=>e.id===i);if(s){const a=this.selectedCharacter.selectedSkill===i;a&&(t=e),e++,this.skillsCarousel.addItem(a?`> ${s.name}`:`  ${s.name}`,e=>{this.selectedCharacter.selectedSkill=e.data.skillId,this.updateSkillPreview(e.data.skillId),this.skillsCarousel.destroy(),this.skillsCarousel=null,this.skillPreviewText.destroy(),this.setSkill()},{skillId:i,bgcolor:a?"#e74c3c":"#9b59b6"})}}),this.skillsCarousel.selectIndex(t),this.skillsCarousel.onSelect.add((e,t)=>{this.updateSkillPreview(t.data.skillId)}),this.skillsCarousel.onCancel.add(()=>{this.skillsCarousel.destroy(),this.skillsCarousel=null,this.skillPreviewText.destroy(),this.showActionMenu()}),this.selectedCharacter.unlockedSkills.length>0&&this.updateSkillPreview(this.selectedCharacter.unlockedSkills[0])}updateSkillPreview(e){const t=CHARACTER_SKILLS.find(t=>t.id===e);if(!t)return;let i=`${t.name}\n\n`;switch(i+=`${t.description}\n\n`,i+="EFFECT:\n",t.effect){case"convert_judgement":i+=` Converts ${t.effectParams.from} to ${t.effectParams.to}\n`;break;case"modify_judgement_window":i+=` Judgement window ${t.effectParams.multiplier}\n`;break;case"health_regen":i+=` +${t.effectParams.amount} HP every ${t.effectParams.interval/1e3}s\n`;break;case"modify_max_health":i+=` +${t.effectParams.amount} Max HP\n`;break;case"modify_note_speed":i+=` Note speed ${t.effectParams.multiplier}\n`}switch(i+="\nACTIVATION:\n",t.activationCondition){case"on_miss":i+=" When you get a Miss judgement\n";break;case"on_combo":case"on_high_combo":i+=` When combo reaches ${t.effectParams.threshold}\n`;break;case"on_low_health":i+=` When health drops below ${t.effectParams.threshold}%\n`;break;case"on_perfect_streak":i+=` After ${t.effectParams.threshold} perfect notes in a row\n`}t.duration>0&&(i+=`\nDURATION: ${t.duration/1e3}s\n`),t.cooldown>0&&(i+=`COOLDOWN: ${t.cooldown/1e3}s\n`),this.skillPreviewText.write(i),this.skillPreviewText.wrapPreserveNewlines(80),this.skillPreviewText.bringToTop()}customizeCharacter(){this.showCustomizationMenu()}showCustomizationMenu(){this.clearAllMenus(),this.customizationMenu=new CarouselMenu(10,60,172,48,{bgcolor:"#2c3e50",fgcolor:"#ffffff",align:"center",activeAlpha:1,inactiveAlpha:.6}),this.customizationMenu.addItem("SKIN TONE",()=>this.customizeSkinTone()),this.customizationMenu.addItem("HAIR COLOR",()=>this.customizeHairColor()),this.customizationMenu.addItem("FRONT HAIR",()=>this.customizeHairStyle("frontHair")),this.customizationMenu.addItem("BACK HAIR",()=>this.customizeHairStyle("backHair")),this.customizationMenu.addItem("CLOTHING",()=>this.customizeClothing()),this.customizationMenu.addItem("ACCESSORY",()=>this.customizeAccessory()),this.customizationMenu.addItem("APPLY",()=>this.finishCustomization()),this.customizationMenu.onCancel.add(()=>{this.characterDisplay.updateAppearance(this.originalAppearance),this.showActionMenu()}),this.originalAppearance={...this.selectedCharacter.appearance}}createGradientBackground(e,t,i,s,a){const n=game.add.bitmapData(i,s),o=n.context.createLinearGradient(i,0,0,0),r=a||"rgba(44, 90, 198, 0.6)";o.addColorStop(0,"transparent"),o.addColorStop(.3,r),o.addColorStop(.7,r),o.addColorStop(1,"transparent"),n.context.fillStyle=o,n.context.fillRect(0,0,i,s);return game.add.sprite(e,t,n)}customizeSkinTone(){const e=["LIGHT","DARK"],t=this.createGradientBackground(92,85,92,24);t.anchor.set(.5);const i=new Text(96,80,"SKIN TONE",FONTS.shaded);i.anchor.set(.5);let s=this.selectedCharacter.appearance.skinTone;const a=new Text(96,90,e[s],FONTS.default);a.anchor.set(.5);const n=o=>{if("left"===o)s=(s-1+e.length)%e.length,this.selectedCharacter.appearance.skinTone=s,this.characterDisplay.updateAppearance({skinTone:s});else if("right"===o)s=(s+1)%e.length,this.selectedCharacter.appearance.skinTone=s,this.characterDisplay.updateAppearance({skinTone:s});else if("a"===o||"b"===o||"start"===o)return i.destroy(),a.destroy(),t.destroy(),gamepad.signals.pressed.any.remove(n),void this.showCustomizationMenu();a.write(e[s])};gamepad.signals.pressed.any.add(n)}customizeHairColor(){let e=this.selectedCharacter.appearance.hairColor,t=e>>16&255,i=e>>8&255,s=255&e;this.navigationHint.change(4);const a=this.createGradientBackground(92,85,92,24);a.anchor.set(.5);const n=new Text(96,80,"HAIR COLOR",FONTS.shaded);n.anchor.set(.5);const o=new Text(96,90,`R:${t} G:${i} B:${s}`,FONTS.default);o.anchor.set(.5);const r=()=>{const e=t<<16|i<<8|s;this.selectedCharacter.appearance.hairColor=e,this.characterDisplay.updateAppearance({hairColor:e}),o.write(`R:${t} G:${i} B:${s}`)},c=e=>{switch(e){case"left":t=Math.max(0,t-32);break;case"right":t=Math.min(255,t+32);break;case"up":i=Math.min(255,i+32);break;case"down":i=Math.max(0,i-32);break;case"a":s=Math.min(255,s+32);break;case"b":s=Math.max(0,s-32);break;case"start":return n.destroy(),o.destroy(),a.destroy(),gamepad.signals.pressed.any.remove(c),this.navigationHint.change(0),void this.showCustomizationMenu()}r()};gamepad.signals.pressed.any.add(c)}customizeHairStyle(e){const t=Account.characters.unlockedHairs["frontHair"===e?"front":"back"],i=t.map(t=>CHARACTER_SYSTEM.HAIR_STYLES["frontHair"===e?"front":"back"][t-1]),s=[];for(let e=0;e<t.length;e++)s.push(e+1);const a=this.createGradientBackground(92,85,92,24);a.anchor.set(.5);const n=new Text(96,80,`${e.toUpperCase()}`,FONTS.shaded);n.anchor.set(.5);let o=this.selectedCharacter.appearance[e]-1;const r=new Text(96,90,"",FONTS.default);r.write(i[o],18),r.anchor.set(.5);const c=t=>{if("left"===t)o=(o-1+i.length)%i.length,this.characterDisplay.updateAppearance({[e]:s[o]});else if("right"===t)o=(o+1)%i.length,this.characterDisplay.updateAppearance({[e]:s[o]});else if("a"===t||"b"===t||"start"===t)return this.selectedCharacter.appearance[e]=s[o],this.characterDisplay.updateAppearance({[e]:s[o]}),n.destroy(),r.destroy(),a.destroy(),gamepad.signals.pressed.any.remove(c),void this.showCustomizationMenu();r.write(i[o],18)};gamepad.signals.pressed.any.add(c)}customizeClothing(){const e=Account.characters.unlockedItems.filter(e=>CHARACTER_ITEMS.clothing.some(t=>t.id===e)),t=e.map(e=>{const t=CHARACTER_ITEMS.clothing.find(t=>t.id===e);return t?t.name:e}),i=this.createGradientBackground(92,85,92,24);i.anchor.set(.5);const s=new Text(96,80,"CLOTHING",FONTS.shaded);s.anchor.set(.5);let a=e.indexOf(this.selectedCharacter.appearance.clothing);-1===a&&(a=0);const n=new Text(96,90,"",FONTS.default);n.write(t[a],18),n.anchor.set(.5);const o=r=>{if("left"===r)a=(a-1+t.length)%t.length,this.characterDisplay.updateAppearance({clothing:e[a]});else if("right"===r)a=(a+1)%t.length,this.characterDisplay.updateAppearance({clothing:e[a]});else if("a"===r||"b"===r||"start"===r)return this.selectedCharacter.appearance.clothing=e[a],this.characterDisplay.updateAppearance({clothing:e[a]}),s.destroy(),n.destroy(),i.destroy(),gamepad.signals.pressed.any.remove(o),void this.showCustomizationMenu();n.write(t[a],18)};gamepad.signals.pressed.any.add(o)}customizeAccessory(){const e=Account.characters.unlockedItems.filter(e=>CHARACTER_ITEMS.accessories.some(t=>t.id===e)),t=["NONE",...e.map(e=>{const t=CHARACTER_ITEMS.accessories.find(t=>t.id===e);return t?t.name:e})],i=this.createGradientBackground(92,85,92,24);i.anchor.set(.5);const s=new Text(96,80,"ACCESSORY",FONTS.shaded);s.anchor.set(.5);let a=this.selectedCharacter.appearance.accessory?e.indexOf(this.selectedCharacter.appearance.accessory)+1:0;const n=new Text(96,90,"",FONTS.default);n.write(t[a],18),n.anchor.set(.5);const o=r=>{if("left"===r)a=(a-1+t.length)%t.length,this.characterDisplay.updateAppearance({accessory:0===a?null:e[a-1]});else if("right"===r)a=(a+1)%t.length,this.characterDisplay.updateAppearance({accessory:0===a?null:e[a-1]});else if("a"===r||"b"===r||"start"===r)return this.selectedCharacter.appearance.accessory=0===a?null:e[a-1],this.characterDisplay.updateAppearance({accessory:this.selectedCharacter.appearance.accessory}),s.destroy(),n.destroy(),i.destroy(),gamepad.signals.pressed.any.remove(o),void this.showCustomizationMenu();n.write(t[a],18)};gamepad.signals.pressed.any.add(o)}finishCustomization(){this.characterManager.saveToAccount(),this.showActionMenu()}deleteCharacter(){this.confirm("DELETE CHARACTER?",()=>{this.characterManager.deleteCharacter(this.selectedCharacter.name),this.characterManager.getCharacterList().length<=1?(this.selectedCharacter=null,this.characterManager.unsetCharacter()):this.selectedCharacter=this.characterManager.getCharacterList()[0],this.showHomeUI()},()=>{this.showActionMenu()},"no")}confirm(e,t,i,s="none"){this.clearAllMenus();const a=new Text(96,60,e,FONTS.shaded);a.anchor.set(.5);const n=new CarouselMenu(60,70,72,32,{bgcolor:"#2c3e50",fgcolor:"#ffffff",align:"center"});let o="#34495e",r="#34495e",c=0;switch(s){case"yes":o="#27ae60",r="#c0392b",c=0;break;case"no":o="#c0392b",r="#27ae60",c=1;break;default:o="#34495e",r="#34495e",c=0}n.addItem("YES",()=>{a.destroy(),n.destroy(),t?.()},{bgcolor:o}),n.addItem("NO",()=>{a.destroy(),n.destroy(),i?.()},{bgcolor:r}),1===c&&n.selectIndex(1),n.onCancel.add(()=>{a.destroy(),n.destroy(),i?.()})}startCharacterCreation(){this.creationStep=0,this.newCharacterAppearance={skinTone:0,hairColor:16777215,frontHair:"1",backHair:"1",clothing:"school_uniform",accessory:null},this.clearAllMenus(),this.hideCharacterDetails(),this.tempCharacterDisplay=new CharacterDisplay(46,6,{name:"NEW CHARACTER",appearance:this.newCharacterAppearance}),this.creationWindowManager=new WindowManager,this.showCreationStep()}hideCharacterDetails(){this.nameText.visible=!1,this.levelText.visible=!1,this.selectedSkillText.visible=!1,this.skillDescriptionText.visible=!1,this.expBar.visible=!1,this.skillBar.visible=!1}showCharacterDetails(){this.nameText.visible=!0,this.levelText.visible=!0,this.selectedSkillText.visible=!0,this.skillDescriptionText.visible=!0,this.expBar.visible=!0,this.skillBar.visible=!0}showCreationStep(){this.creationMenu&&(this.creationMenu.destroy(),this.creationMenu=null),this.creationText&&(this.creationText.destroy(),this.creationText=null),this.creationWindow&&this.creationWindowManager.remove(this.creationWindow,!0),gamepad.signals.pressed.any.removeAll();const e=[{title:"CHOOSE SKIN TONE",action:e=>this.creationCustomizeSkinTone(e)},{title:"CHOOSE HAIR COLOR",action:e=>this.creationCustomizeHairColor(e)},{title:"CHOOSE FRONT HAIR",action:e=>this.creationCustomizeHairStyle("frontHair",e)},{title:"CHOOSE BACK HAIR",action:e=>this.creationCustomizeHairStyle("backHair",e)},{title:"CHOOSE CLOTHING",action:e=>this.creationCustomizeClothing(e)},{title:"CHOOSE ACCESSORY",action:e=>this.creationCustomizeAccessory(e)},{title:"NAME YOUR CHARACTER",action:e=>this.creationNameCharacter(e)}];if(this.creationStep<e.length){const t=e[this.creationStep];this.creationWindow=this.creationWindowManager.createWindow(12,7,10,5,"1"),this.creationWindow.x-=this.creationWindow.size.width/2*8,this.creationWindow.offset={x:20,y:8},this.creationWindow.disableScrollBar=!0,this.creationText=new Text(96,70,t.title,FONTS.shaded),this.creationText.anchor.set(.5),t.action(()=>{this.showCreationNavigationMenu()})}}showCreationNavigationMenu(){this.creationWindow.addItem("NEXT","",()=>{this.creationStep++,this.showCreationStep()}),this.creationStep>0&&this.creationWindow.addItem("PREVIOUS","",()=>{this.creationStep--,this.showCreationStep()},!0),this.creationWindow.addItem("CANCEL","",()=>{this.cancelCharacterCreation()},this.creationStep<=0),this.creationWindowManager.focus(this.creationWindow)}creationCustomizeSkinTone(e){const t=["LIGHT","DARK"];let i=this.newCharacterAppearance.skinTone;const s=new Text(96,80,t[i],FONTS.default);s.anchor.set(.5);const a=n=>{if("left"===n)i=(i-1+t.length)%t.length;else if("right"===n)i=(i+1)%t.length;else{if("a"===n)return s.destroy(),gamepad.signals.pressed.any.remove(a),void e();if("b"===n)return s.destroy(),gamepad.signals.pressed.any.remove(a),void this.showCreationNavigationMenu()}this.newCharacterAppearance.skinTone=i,this.tempCharacterDisplay.updateAppearance({skinTone:i}),s.write(t[i])};gamepad.signals.pressed.any.add(a)}creationCustomizeHairColor(e){let t=this.newCharacterAppearance.hairColor,i=Math.max(136,t>>16&255),s=Math.max(136,t>>8&255),a=Math.max(136,255&t);const n=()=>{const e=i<<16|s<<8|a;return this.newCharacterAppearance.hairColor=e,this.tempCharacterDisplay.updateAppearance({hairColor:e}),`R:${i} G:${s} B:${a}`},o=new Text(96,80,n(),FONTS.default);o.anchor.set(.5);const r=t=>{switch(t){case"left":i=Math.max(0,i-32);break;case"right":i=Math.min(255,i+32);break;case"up":s=Math.min(255,s+32);break;case"down":s=Math.max(0,s-32);break;case"a":a=Math.min(255,a+32);break;case"b":a=Math.max(0,a-32);break;case"start":return o.destroy(),gamepad.signals.pressed.any.remove(r),e(),void this.navigationHint.change(0);case"select":return o.destroy(),gamepad.signals.pressed.any.remove(r),this.navigationHint.change(0),void this.showCreationNavigationMenu()}o.write(n())};this.navigationHint.change(4),gamepad.signals.pressed.any.add(r)}creationCustomizeHairStyle(e,t){const i=Account.characters.unlockedHairs["frontHair"===e?"front":"back"],s=i.map(t=>CHARACTER_SYSTEM.HAIR_STYLES["frontHair"===e?"front":"back"][t-1]),a=[];for(let e=0;e<i.length;e++)a.push(e+1);let n=this.newCharacterAppearance[e]-1;const o=new Text(96,80,s[n],FONTS.default);o.anchor.set(.5);const r=()=>{this.newCharacterAppearance[e]=a[n],this.tempCharacterDisplay.updateAppearance({[e]:a[n]}),o.write(s[n])},c=e=>{if("left"===e)n=(n-1+s.length)%s.length;else if("right"===e)n=(n+1)%s.length;else{if("a"===e)return o.destroy(),gamepad.signals.pressed.any.remove(c),void t();if("b"===e)return o.destroy(),gamepad.signals.pressed.any.remove(c),void this.showCreationNavigationMenu()}r()};r(),gamepad.signals.pressed.any.add(c)}creationCustomizeClothing(e){const t=Account.characters.unlockedItems.filter(e=>CHARACTER_ITEMS.clothing.some(t=>t.id===e)),i=t.map(e=>{const t=CHARACTER_ITEMS.clothing.find(t=>t.id===e);return t?t.name:e});let s=t.indexOf(this.newCharacterAppearance.clothing);-1===s&&(s=0);const a=new Text(96,80,i[s],FONTS.default);a.anchor.set(.5);const n=o=>{if("left"===o)s=(s-1+i.length)%i.length;else if("right"===o)s=(s+1)%i.length;else{if("a"===o)return a.destroy(),gamepad.signals.pressed.any.remove(n),void e();if("b"===o)return a.destroy(),gamepad.signals.pressed.any.remove(n),void this.showCreationNavigationMenu()}this.newCharacterAppearance.clothing=t[s],this.tempCharacterDisplay.updateAppearance({clothing:t[s]}),a.write(i[s])};gamepad.signals.pressed.any.add(n)}creationCustomizeAccessory(e){const t=Account.characters.unlockedItems.filter(e=>CHARACTER_ITEMS.accessories.some(t=>t.id===e)),i=["NONE",...t.map(e=>{const t=CHARACTER_ITEMS.accessories.find(t=>t.id===e);return t?t.name:e})];let s=this.newCharacterAppearance.accessory?t.indexOf(this.newCharacterAppearance.accessory)+1:0;const a=new Text(96,80,i[s],FONTS.default);a.anchor.set(.5);const n=o=>{if("left"===o)s=(s-1+i.length)%i.length;else if("right"===o)s=(s+1)%i.length;else{if("a"===o)return a.destroy(),gamepad.signals.pressed.any.remove(n),void e();if("b"===o)return a.destroy(),gamepad.signals.pressed.any.remove(n),void this.showCreationNavigationMenu()}this.newCharacterAppearance.accessory=0===s?null:t[s-1],this.tempCharacterDisplay.updateAppearance({accessory:this.newCharacterAppearance.accessory}),a.write(i[s])};n(),gamepad.signals.pressed.any.add(n)}creationNameCharacter(e){this.creationMenu&&(this.creationMenu.destroy(),this.creationMenu=null),this.creationText&&(this.creationText.destroy(),this.creationText=null),this.creationWindow&&(this.creationWindow.visible=!1);const t=new Text(96,80,"ENTER CHARACTER NAME",FONTS.shaded);t.anchor.set(.5),this.navigationHint.change(5),new TextInput("",CHARACTER_SYSTEM.MAX_NAME_LENGTH,i=>{const s=this.characterManager.createCharacter(i,this.newCharacterAppearance);s?(this.selectedCharacter=s,t.destroy(),this.navigationHint.change(0),this.tempCharacterDisplay&&(this.tempCharacterDisplay.destroy(),this.tempCharacterDisplay=null),this.showHomeUI()):(notifications.show("Character name already exists"),this.navigationHint.change(0),this.creationNameCharacter(e))},()=>{t.destroy(),this.navigationHint.change(0),this.cancelCharacterCreation()})}cancelCharacterCreation(){this.tempCharacterDisplay&&(this.tempCharacterDisplay.destroy(),this.tempCharacterDisplay=null),this.creationMenu&&(this.creationMenu.destroy(),this.creationMenu=null),this.creationText&&(this.creationText.destroy(),this.creationText=null),this.creationWindow&&this.creationWindowManager.remove(this.creationWindow,!0),this.showHomeUI()}update(){gamepad.update(),this.creationWindowManager&&this.creationWindowManager.update()}shutdown(){this.characterManager.saveToAccount()}}class AchievementsMenu{create(){game.camera.fadeIn(0),new FuturisticLines,new BackgroundGradient,this.navigationHint=new NavigationHint(6),this.showingUnlocked=!0,this.detailsText=new Text(game.width/2+8,10,""),this.createMenu(),addonManager.executeStateBehaviors(this.constructor.name,this)}createMenu(){new AchievementsManager;const e=game.width/2,t=game.height-12;this.carousel=new CarouselMenu(0,8,e,t,{bgcolor:"#9b59b6",fgcolor:"#ffffff",align:"left",animate:!0,disableConfirm:!0,disableCancel:!0}),this.toggleText=new Text(4,4,"SHOWING: UNLOCKED"),game.onMenuIn.dispatch("achievements",this.carousel),this.updateAchievementsList()}updateAchievementsList(){const e=new AchievementsManager,t=this.showingUnlocked?e.getUnlockedAchievements():e.getLockedAchievements();this.carousel.clear(),0===t.length?(this.carousel.addItem(this.showingUnlocked?"No achievements unlocked":"No achievements available",null,{bgcolor:"#34495e"}),this.detailsText&&this.detailsText.write("")):(t.forEach(e=>{const t=`${this.showingUnlocked?"":""} ${e.name}`;this.carousel.addItem(t,null,{achievement:e,bgcolor:this.showingUnlocked?"#27ae60":"#e74c3c"})}),t.length>0&&this.detailsText&&this.showAchievementDetails(t[0])),this.toggleText&&this.toggleText.write("SHOWING: "+(this.showingUnlocked?"UNLOCKED":"LOCKED")),this.carousel.onSelect.add((e,t)=>{t.data&&t.data.achievement&&this.showAchievementDetails(t.data.achievement)}),this.carousel.onCancel.add(()=>{game.state.start("MainMenu")})}showAchievementDetails(e){if(!this.detailsText)return;new AchievementsManager;const t=Account.achievements.unlocked[e.id];let i=`${e.name}\n`;if(i+=`Category: ${e.category}\n\n`,t){i+=e.description.achieved+"\n\n";const t=Account.achievements.unlocked[e.id];i+=`Unlocked: ${new Date(t.unlockedAt).toLocaleDateString()}\n`,i+=`Experience: +${t.expReward}`}else i+=e.description.unachieved+"\n\n",e.hidden?i+="???\n(Hidden Achievement)":i+=`Experience: +${e.expReward}`;this.detailsText.write(i).wrapPreserveNewlines(game.width/2-16)}update(){gamepad.update(),gamepad.pressed.select&&!this.lastSelect&&(this.showingUnlocked=!this.showingUnlocked,this.updateAchievementsList()),this.lastSelect=gamepad.pressed.select}}class StatsMenu{create(){game.camera.fadeIn(0),new FuturisticLines,new BackgroundGradient,this.titleText=new Text(92,8,"PLAYER STATISTICS"),this.titleText.anchor.x=.5,this.leftColumn=new Text(8,56,""),this.leftColumn.anchor.y=.5,this.rightColumn=new Text(92,56,""),this.rightColumn.anchor.y=.5,this.instructionText=new Text(92,92,"PRESS ANY KEY TO LEAVE"),this.instructionText.anchor.x=.5,this.updateStatsText(),this.updateTimer=game.time.events.loop(100,this.updateStatsText,this),addonManager.executeStateBehaviors(this.constructor.name,this)}formatTime(e){const t=Math.floor(e/3600),i=Math.floor(e%3600/60),s=e%60;return`${t.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`}formatSessionTime(e){if(e<60)return`${e}s`;if(e<3600){return`${Math.floor(e/60)}m ${e%60}s`}return`${Math.floor(e/3600)}h ${Math.floor(e%3600/60)}m`}updateStatsText(){if(!Account.stats)return;const e=Account.stats;let t="",i="";t+=`Games Played: ${e.totalGamesPlayed}\n`,t+=`Total Score: ${e.totalScore.toLocaleString()}\n`,t+=`Max Combo: ${e.maxCombo}\n`,t+=`Perfect Games: ${e.perfectGames}\n`,t+=`Characters: ${e.charactersCreated}\n`,t+=`Max Level: ${e.maxCharacterLevel}\n`,t+=`Skills Unlocked: ${e.skillsUnlocked}\n`,i+=`Total Time: ${this.formatTime(e.totalTimePlayed)}\n`,i+=`Play Sessions: ${e.totalPlaySessions}\n`,i+=`Avg Session: ${this.formatSessionTime(e.averageSessionTime)}\n`,i+=`Longest Session: ${this.formatSessionTime(e.longestSession)}\n`,i+=`Current Streak: ${e.currentStreak} days\n`,i+=`Longest Streak: ${e.longestStreak} days\n`,i+=`High Scores: ${e.highScoresSet}\n`,this.leftColumn.write(t),this.rightColumn.write(i)}update(){gamepad.update(),gamepad.pressed.any&&game.state.start("MainMenu")}shutdown(){this.updateTimer&&game.time.events.remove(this.updateTimer)}}class Play{init(e,t){this.song=e,this.difficultyIndex=t,this.player=null,this.backgroundQueue=[],this.currentBackground=null,this.isPaused=!1,this.pauseStartTime=0,this.totalPausedDuration=0,this.pendingSongStart=!1,this.audioEndListener=null,this.started=!1,this.startTime=0,this.autoplay=Account.settings.autoplay,this.userOffset=Account.settings.userOffset,this.lastVideoUpdateTime=0,this.lyrics=null,this.hasLyricsFile=!!e.chart.lyrics,this.visualizerType=Account.settings.visualizer||"NONE",this.lastVisualizerUpdateTime=0,this.metronome=null,this.gameRecorder=null,this.characterManager=new CharacterManager,this.currentCharacter=this.characterManager.getCurrentCharacter(),this.skillSystem=new CharacterSkillSystem(this,this.currentCharacter),Account.lastSong={url:e.chart.audioUrl,title:e.chart.title,artist:e.chart.artist,sampleStart:e.chart.sampleStart||0,isExternal:void 0!==e.chart.files},saveAccount(),this.JUDGE_WINDOWS=JUDGE_WINDOWS,this.SCORE_VALUES=SCORE_VALUES}create(){backgroundMusic&&backgroundMusic.stop(),game.camera.fadeIn(0),this.backgroundLayer=game.add.group(),this.backgroundSprite=game.add.sprite(0,0,null,0,this.backgroundLayer),this.backgroundSprite.alpha=.6,this.backgroundCanvas=document.createElement("canvas"),this.backgroundCanvas.width=192,this.backgroundCanvas.height=112,this.backgroundCtx=this.backgroundCanvas.getContext("2d"),this.audio=document.createElement("audio"),this.audio.src=this.song.chart.audioUrl,this.audio.volume=[0,25,50,75,100][Account.settings.volume]/100,this.visibilityChangeListener=()=>{document.hidden&&(this.isPaused||this.pause())},window.addEventListener("visibilitychange",this.visibilityChangeListener),this.video=document.createElement("video"),this.video.muted=!0,this.video.loop=!0,this.createHud(),this.setupLyrics(),this.setupPlayer(),this.metronome=new Metronome(this),this.songStart(),addonManager.executeStateBehaviors(this.constructor.name,this)}createHud(){this.backgroundGradient=new BackgroundGradient(0,.4,5e3),this.hud=game.add.sprite(0,0,"ui_hud_background",0),this.overHud=game.add.sprite(0,0);const e=this.song.chart.difficulties[this.song.difficultyIndex];this.difficultyBanner=game.add.sprite(0,0,"ui_difficulty_banner",0),this.difficultyBanner.tint=this.getDifficultyColor(e.rating),this.hud.addChild(this.difficultyBanner),this.difficultyTypeText=new Text(5,1,e.type.substr(0,7),null,this.difficultyBanner);const t=this.song.chart.titleTranslit||this.song.chart.title;this.songTitleText=new Text(34,1,"",null,this.hud),this.songTitleText.write(t,28),this.playerName=new Text(4,8,"",FONTS.shaded,this.hud),this.playerName.write(this.currentCharacter?this.currentCharacter.name:"NONE",4),this.playerName.tint=this.currentCharacter?this.currentCharacter.appearance.hairColor:16777215,this.skillBar=new SkillBar(6,15),this.hud.addChild(this.skillBar),this.currentCharacter||(this.skillBar.visible=!1),this.scoreText=new Text(22,12,"0".repeat(9),null,this.hud),this.lifebarStart=game.add.sprite(21,8,"ui_lifebar",0),this.lifebarMiddle=game.add.sprite(1,0,"ui_lifebar",1),this.lifebarMiddle.width=102,this.lifebarEnd=game.add.sprite(103,0,"ui_lifebar",2),this.hud.addChild(this.lifebarStart),this.lifebarStart.addChild(this.lifebarMiddle),this.lifebarStart.addChild(this.lifebarEnd),this.autoplayText=new Text(4,90,this.autoplay?"AUTOPLAY":"",FONTS.stroke,this.hud),this.healthText=new Text(137,8,"100",FONTS.number,this.hud),this.healthText.anchor.x=1,this.judgementText=new Text(game.width/2,60,"",FONTS.shaded),this.judgementText.anchor.set(.5),this.accuracyBar=game.add.sprite(41,108,"ui_accuracy_bar"),this.hud.addChild(this.accuracyBar),this.comboText=new Text(191,106,"0",FONTS.combo),this.comboText.anchor.set(1),this.createVisualizer()}createVisualizer(){switch(this.visualizer&&(this.visualizer.destroy(),this.visualizer=null),this.visualizerType){case"ACCURACY":this.visualizer=new AccuracyVisualizer(this,2,103,36,7);break;case"AUDIO":this.visualizer=new AudioVisualizer(this,2,103,36,7);break;case"BPM":this.visualizer=new BPMVisualizer(this,2,103,36,7);break;default:this.visualizer=null}this.visualizer&&this.hud.addChild(this.visualizer.graphics)}setupPlayer(){this.player=new Player(this)}setupLyrics(){if(this.hasLyricsFile&&game.cache.checkTextKey("song_lyrics")){const e=game.cache.getText("song_lyrics");this.lyricsText=new Text(game.width/2,72,"",FONTS.stroke),this.lyricsText.anchor.set(.5),this.lyrics=new Lyrics({textElement:this.lyricsText,maxLineLength:25,lrc:e})}}getDifficultyColor(e){e=Math.max(0,Math.min(11,e));var t=25,i=210,s=25,a=210,n=0,o=0;return Math.floor(t+e/11*(a-t))<<16|Math.floor(i+e/11*(n-i))<<8|Math.floor(s+e/11*(o-s))}getDifficultyColorFromType(e){return{Beginner:65458,Easy:65356,Medium:16763904,Hard:16744192,Challenge:16731136}[e]}setBackground(){this.song.chart.background&&"no-media"!==this.song.chart.background?this.loadBackgroundImage(this.song.chart.background):(this.backgroundCtx.fillStyle="#000000",this.backgroundCtx.fillRect(0,0,192,112),this.updateBackgroundTexture())}songStart(){this.setBackground();const e=this.song.chart.offset||0;this.startTime=game.time.now+2e3-1e3*e,setTimeout(()=>{this.audio?.play(),this.started=!0,window.recordNextGame&&game.recorder.start(this.audio,0)},2e3+this.userOffset),this.audioEndListener=this.audio.addEventListener("ended",()=>this.songEnd(),{once:!0})}showCharacterCloseShot(e){const t=Math.max(500,e-400),i=new CharacterCloseShot(2,103,this.currentCharacter);i.visible=!1,this.overHud.addChild(i),this.visualizer&&(this.visualizer.graphics.visible=!1);const s=game.add.sprite(2,103,"character_noise");s.animations.add("static",[0,1,2,3,4,5,6,7],60,!0),s.animations.play("static"),this.overHud.addChild(s),game.time.events.add(200,()=>{s.destroy(),i.visible=!0,i.blink(game.rnd.between(0,200))}),game.time.events.add(t,()=>{i.visible=!1;const e=game.add.sprite(2,103,"character_noise");e.animations.add("static",[0,1,2,3,4,5,6,7],60,!0),e.animations.play("static"),this.overHud.addChild(e),game.time.events.add(200,()=>{this.visualizer&&(this.visualizer.graphics.visible=!0),e.destroy(),i.destroy()})})}showGlitchAnimation(e=1e3){const t=game.add.sprite(0,0,"ui_glitch_animation");t.animations.add("glitch",[0,1,2,3,4,5,6],12,!0),t.animations.play("glitch"),t.lifespan=e,t.blendMode=PIXI.blendModes.ADD,this.overHud.addChild(t)}loadBackgroundImage(e){const t=new Image;t.onload=()=>{this.backgroundCtx.drawImage(t,0,0,192,112),this.updateBackgroundTexture()},t.src=e}loadBackgroundVideo(e){this.video.src=e,this.video.play(),this.backgroundGradient.visible=!1}clearBackgroundImage(){this.backgroundSprite.loadTexture(null),this.backgroundGradient.visible=!1}applyBackground(e){"-nosongbg-"==e.file?this.clearBackgroundImage():"video"==e.type?this.loadBackgroundVideo(e.url):(this.loadBackgroundImage(e.url),this.video.src="",this.backgroundGradient.visible=!0),this.currentBackground=e,this.applyBgEffects(e)}applyBgEffects(e){e.fadeIn?(this.backgroundSprite.alpha=0,game.add.tween(this.backgroundSprite).to({alpha:.6*parseFloat(e.opacity)},500,"Linear",!0)):this.backgroundSprite.alpha=.6*e.opacity}updateBackgroundTexture(){const e=PIXI.Texture.fromCanvas(this.backgroundCanvas);this.backgroundSprite.loadTexture(e)}songEnd(){this.updateUserStats();const e={score:this.player.score,accuracy:this.player.accuracy,maxCombo:this.player.maxCombo,judgements:{...this.player.judgementCounts},skillsUsed:this.skillSystem.getSkillsUsed(),difficultyRating:this.song.chart.difficulties[this.song.difficultyIndex].rating},t=this.autoplay?0:this.characterManager.calculateExperienceGain(e);this.autoplay||this.characterManager.updateCharacterStats(e,t);const i={song:this.song,difficultyIndex:this.difficultyIndex,character:this.currentCharacter,player:this.player,expGain:t,gameResults:e};game.state.start("Results",!0,!1,i)}updateUserStats(){if(Account.settings.autoplay)return;Account.stats||(Account.stats={...DEFAULT_ACCOUNT.stats}),Account.stats.totalGamesPlayed++,Account.stats.totalScore+=this.player.score,Account.stats.maxCombo=Math.max(Account.stats.maxCombo,this.player.maxCombo),this.player.accuracy>=100&&Account.stats.perfectGames++,Account.stats.totalNotesHit+=Object.values(this.player.judgementCounts).reduce((e,t)=>e+t,0),Account.stats.totalMarvelous+=this.player.judgementCounts.marvelous||0,Account.stats.totalPerfect+=this.player.judgementCounts.perfect||0,Account.stats.totalGreat+=this.player.judgementCounts.great||0,Account.stats.totalGood+=this.player.judgementCounts.good||0,Account.stats.totalBoo+=this.player.judgementCounts.boo||0,Account.stats.totalMiss+=this.player.judgementCounts.miss||0,Account.stats.maxMarvelousInGame=Math.max(Account.stats.maxMarvelousInGame,this.player.judgementCounts.marvelous||0),Account.stats.maxSkillsInGame=Math.max(Account.stats.maxSkillsInGame,this.skillSystem.getSkillsUsed());(new AchievementsManager).updateStats()}togglePause(){this.isAnimating||(this.isPaused?this.resume():this.pause())}pause(){this.isPaused=!0,this.pauseStartTime=game.time.now,this.audio?.pause(),this.video.src&&this.video?.pause(),this.showPauseMenu()}resume(){this.isPaused=!1,this.totalPausedDuration+=game.time.now-this.pauseStartTime,this.hidePauseMenu(),this.video.src&&this.video?.play(),this.audio?.play()}showPauseMenu(){const e=game.height/2-20;this.pauseBg=game.add.graphics(0,0),this.pauseBg.beginFill(0,.6),this.pauseBg.drawRect(0,0,192,112),this.pauseBg.endFill(),this.pauseCarousel=new CarouselMenu(10,e,80,60,{bgcolor:"brown",fgcolor:"#ffffff",align:"center",animate:!0}),this.pauseCarousel.addItem("CONTINUE",()=>this.resume()),Account.settings.autoplay&&this.pauseCarousel.addItem("DISABLE AUTOPLAY",()=>{Account.settings.autoplay=!1,game.state.start("SongSelect",!0,!1,null,null,!0)}),this.pauseCarousel.addItem("RESTART",()=>game.state.start("Play",!0,!1,this.song,this.difficultyIndex)),this.pauseCarousel.addItem("GIVE UP",()=>this.songEnd()),game.onMenuIn.dispatch("pause",this.pauseCarousel),this.pauseCarousel.addItem("QUIT",()=>game.state.start("MainMenu")),this.pauseCarousel.onCancel.add(()=>this.resume())}hidePauseMenu(){this.pauseCarousel&&(this.pauseBg.destroy(),this.pauseCarousel.destroy(),this.pauseCarousel=null)}getCurrentTime(){if(this.isPaused){const e=this.pauseStartTime-this.startTime-this.totalPausedDuration+this.userOffset;return{now:e/1e3,beat:this.secToBeat(e/1e3)}}{const e=game.time.now-this.startTime-this.totalPausedDuration+this.userOffset;return{now:e/1e3,beat:this.secToBeat(e/1e3)}}}secToBeat(e){return this.player?this.player.secToBeat(e):0}updateBackgrounds(){const{beat:e}=this.getCurrentTime();if(this.song.chart.backgrounds.forEach(t=>{e>=t.beat&&!t.activated&&(t.activated=!0,this.backgroundQueue.push(t))}),this.backgroundQueue.length>0){const e=this.backgroundQueue.shift();this.applyBackground(e)}this.updateVideo()}updateVideo(){this.currentBackground&&"video"==this.currentBackground.type&&game.time.now-this.lastVideoUpdateTime>=3*game.time.elapsedMS&&(this.lastVideoUpdateTime=game.time.now,this.backgroundCtx.drawImage(this.video,0,0,192,112),this.updateBackgroundTexture())}update(){if(gamepad.update(),this.isPaused)return;if(gamepad.pressed.start&&!this.lastStart&&this.togglePause(),this.lastStart=gamepad.pressed.start,this.skillSystem&&this.skillSystem.update(),this.hasLyricsFile&&this.lyrics&&this.started){const e=this.getCurrentTime().now;this.lyrics.move(e)}this.visualizer&&game.time.now-this.lastVisualizerUpdateTime>=2*game.time.elapsedMS&&(this.visualizer.update(),this.lastVisualizerUpdateTime=game.time.now),gamepad.pressed.select&&!this.lastSelect&&this.metronome.toggle(),this.lastSelect=gamepad.pressed.select,this.metronome&&this.metronome.update();let e="";this.autoplay?e=this.metronome.enabled?"AUTOPLAY + METRONOME":"AUTOPLAY":this.metronome.enabled&&(e="METRONOME"),this.autoplayText.text!=e&&this.autoplayText.write(e),this.player.update(),this.updateBackgrounds(),this.hud.bringToTop(),this.hud.alpha=this.player.gameOver?.5:1,this.overHud.bringToTop(),this.judgementText.bringToTop(),this.comboText.bringToTop()}render(){this.player&&this.player.render()}shutdown(){this.audio.removeEventListener("ended",this.audioEndListener),window.removeEventListener("visibilitychange",this.visibilityChangeListener),this.audio.pause(),this.audio.src="",this.audio=null,this.video.src&&(this.video.pause(),this.video.src="",this.video=null),this.song.chart.backgrounds.forEach(e=>e.activated=!1),this.visualizer&&(this.visualizer.destroy(),this.visualizer=null),this.metronome&&(this.metronome.destroy(),this.metronome=null),window.recordNextGame&&(game.recorder.stop(),window.recordNextGame=!1)}}class Results{init(e){this.gameData=e,this.isNewRecord=!1,this.finalScore=0,this.finalAccuracy=0,this.scoreRating=""}create(){game.camera.fadeIn(0),new FuturisticLines,new BackgroundGradient;const{song:e,player:t}=this.gameData,i=e.chart.difficulties[e.difficultyIndex];this.finalScore=t.score,this.finalAccuracy=t.accuracy,this.scoreRating=t.getScoreRating(),this.previewAudio=document.createElement("audio"),this.previewAudio.volume=[0,25,50,75,100][Account.settings.volume]/100,this.visibilityChangeListener=()=>{document.hidden?this.previewAudio?.pause():this.previewAudio?.play()},window.addEventListener("visibilitychange",this.visibilityChangeListener),this.isNewRecord=this.saveHighScore(e,i,t),this.displayResults(),this.gameData.character&&this.showCharacterExp(),this.showMenu(),addonManager.executeStateBehaviors(this.constructor.name,this)}saveHighScore(e,t,i){if(Account.settings.autoplay)return!1;const s=this.getSongKey(e),a=`${t.type}${t.rating}`;Account.highScores[s]||(Account.highScores[s]={});const n=Account.highScores[s][a],o={score:i.score,accuracy:i.accuracy,rating:i.getScoreRating(),maxCombo:i.maxCombo,date:Date.now(),judgements:{...i.judgementCounts}};let r=!1;return(!n||i.score>n.score)&&(Account.highScores[s][a]=o,saveAccount(),r=!0),r}getSongKey(e){return e.chart.folderName?`local_${e.chart.folderName}`:e.chart.audioUrl?`external_${this.hashString(e.chart.audioUrl)}`:`unknown_${Date.now()}`}hashString(e){let t=0;for(let i=0;i<e.length;i++){t=(t<<5)-t+e.charCodeAt(i),t&=t}return t.toString(36)}displayResults(){const{song:e,player:t}=this.gameData,i=e.chart.difficulties[e.difficultyIndex];this.bannerImg=document.createElement("img"),this.cdtitleImg=document.createElement("img"),this.bannerCanvas=document.createElement("canvas"),this.bannerCtx=this.bannerCanvas.getContext("2d"),this.bannerSprite=game.add.sprite(112,10),e.chart.audioUrl&&(this.previewAudio.src=e.chart.audioUrl,this.previewAudio.currentTime=e.chart.sampleStart||0,this.previewAudio.play()),e.chart.banner&&(this.bannerImg.src=e.chart.banner,this.bannerImg.onload=()=>{this.bannerCtx.drawImage(this.bannerImg,0,0,72,28),this.bannerSprite.loadTexture(PIXI.Texture.fromCanvas(this.bannerCanvas))});const s=e.chart.titleTranslit||e.chart.title;this.songText=new Text(8,10,`${s}`,FONTS.shaded),this.diffText=new Text(10,20,`${i.type} (${i.rating})`),this.diffText.tint=(new Play).getDifficultyColor(i.rating),s.length>25&&this.songText.scrollwrite(s,25);const a=Account.settings.autoplay;this.scoreText=new Text(10,30,`SCORE: ${a?"---":this.finalScore.toLocaleString()}`,FONTS.default),this.accuracyText=new Text(10,40,"ACCURACY: "+(a?"---":`${this.finalAccuracy.toFixed(2)}%`),FONTS.default),this.ratingText=new Text(10,50,`RATING: ${a?"AUTO":this.scoreRating}`,FONTS.shaded),this.ratingText.tint=this.getRatingColor(this.scoreRating),this.comboText=new Text(10,60,`MAX COMBO: ${a?"---":t.maxCombo}`,FONTS.default),this.judgementsText=new Text(15,70,a?"\nAUTOPLAY ENABLED":this.getJudgementsText(t.judgementCounts)),this.judgementsText.tint=a?16711680:16777215,!a&&this.isNewRecord&&(this.recordText=new Text(this.scoreText.right+4,this.scoreText.y,"NEW RECORD!",FONTS.shaded),this.recordText.anchor.x=.5,this.recordText.x+=this.scoreText.width/2,this.recordText.tint=16766720,game.add.tween(this.recordText.scale).to({x:1.2,y:1.2},500,"Linear",!0).yoyo(!0).repeat(-1))}showCharacterExp(){new CharacterPortrait(112,41,this.gameData.character||null);const e=new Text(128,42,"",FONTS.shaded),t=new Text(0,42,""),i=new ExperienceBar(129,50,40,3);if(this.gameData.character){e.write(this.gameData.character.name);const s=this.gameData.character.getLastExperienceStoryEntry(),a=CHARACTER_SYSTEM.EXPERIENCE_CURVE;if(s){let n=s.expBefore,o=s.levelBefore;function r(e,n){e<a(n)?(e++,Audio.play("exp_up",.6)):(e=0,n++,t.write(`Lv. ${n}`),Audio.play("level_up",.9)),i.setProgress(e/a(n)),(n<s.levelAfter||e<s.expAfter)&&game.time.events.add(100,()=>r(e,n))}t.x=e.right+8,t.write(`Lv. ${o}`),i.setProgress(n/a(o)),this.gameData.expGain&&game.time.events.add(600,()=>r(n,o))}}}showMenu(){this.navigationHint=new NavigationHint(1);const e=this.gameData.character?72:80,t=this.gameData.character?53:40,i=new CarouselMenu(108,t,80,e,{bgcolor:"brown",fgcolor:"#ffffff"});i.addItem("NEXT",()=>{game.state.start("SongSelect",!0,!1,null,window.selectStartingIndex+1,!0)}),i.addItem("CONTINUE",()=>game.state.start("SongSelect")),Account.settings.autoplay&&i.addItem("DISABLE AUTOPLAY",()=>{Account.settings.autoplay=!1,game.state.start("SongSelect")}),i.addItem("RETRY",()=>game.state.start("Play",!0,!1,this.gameData.song)),i.addItem("QUIT",()=>game.state.start("MainMenu")),game.onMenuIn.dispatch("results",i)}getJudgementsText(e){return`MARVELOUS: ${e.marvelous}\nPERFECT: ${e.perfect}\nGREAT: ${e.great}\nGOOD: ${e.good}\nBOO: ${e.boo}\nMISS: ${e.miss}`}getRatingColor(e){return{"SSS+":16766720,SSS:16766720,SS:15790320,S:15790320,A:65280,B:255,C:16776960,D:16753920,E:16711680,F:8388736}[e]||16777215}update(){gamepad.update()}shutdown(){this.previewAudio.pause(),this.previewAudio.src=null,this.previewAudio=null,window.removeEventListener("visibilitychange",this.visibilityChangeListener)}}class Jukebox{init(e=null,t=0){this.songs=e||(window.localSongs&&window.externalSongs?[...window.localSongs,...window.externalSongs]:window.localSongs)||[],this.currentIndex=t||0,this.currentSong=this.songs[this.currentIndex],this.isPlaying=!1,this.isShuffled=!1,this.menuVisible=!1,this.songListMenuVisible=!1,this.originalSongOrder=[...this.songs],this.visualizerMode="symmetrical",this.seekSpeed=1,this.lastSeekTime=0,this.seekCooldown=60,this.doublePressTimeout=200,this.currentBackground=null,this.backgroundQueue=[],this.backgroundSprite=null,this.videoElement=null,this.visualizer=null,this.lyrics=null,this.hasLyrics=!1,this.fullscreenMode=!1,this.buttonActiveTimers={},this.lastLeftPress=0,this.lastRightPress=0,this.lastSelectPress=0,this.lastBPress=0,this.playbackPositions={}}create(){game.camera.fadeIn(0),this.setupBackground(),this.setupAudioPlayer(),this.setupUI(),this.setupVisualizer(),this.setupLyrics(),this.navigationHint=new NavigationHint(3),this.loadSong(this.currentIndex),addonManager.executeStateBehaviors(this.constructor.name,this)}setupBackground(){this.backgroundSprite=game.add.sprite(0,0),this.backgroundSprite.alpha=.4,this.videoElement=document.createElement("video"),this.videoElement.muted=!0,this.videoElement.loop=!0}setupAudioPlayer(){backgroundMusic&&backgroundMusic.stop(),this.audioElement=document.createElement("audio"),this.audioElement.volume=[0,25,50,75,100][Account.settings.volume]/100,this.audioElement.addEventListener("timeupdate",()=>{this.updateProgressBar(),this.updateTimeDisplay()}),this.audioElement.addEventListener("ended",()=>{this.nextSong(!0)}),this.audioElement.addEventListener("error",e=>{console.warn("Audio error:",e)})}setupUI(){this.uiBackground=game.add.graphics(0,0),this.uiBackground.beginFill(0,.7),this.uiBackground.drawRect(0,80,game.width,32),this.uiBackground.endFill(),this.bannerSprite=game.add.sprite(4,4),this.songTitle=new Text(102,4,"",FONTS.shaded),this.songArtist=new Text(104,14,"",FONTS.default),this.songCredit=new Text(104,24,"",FONTS.default),this.currentTimeText=new Text(4,84,"0:00",FONTS.default),this.durationText=new Text(188,84,"0:00",FONTS.default),this.durationText.anchor.x=1,this.progressBarBg=game.add.graphics(30,86),this.progressBarBg.lineStyle(2,6710886,1),this.progressBarBg.moveTo(0,0),this.progressBarBg.lineTo(132,0),this.progressBar=game.add.graphics(30,86),this.createPlaybackControls(),this.lyricsText=new Text(game.width/2,51,"",FONTS.stroke),this.lyricsText.anchor.set(.5),this.lyricsText.visible=!0}createPlaybackControls(){const e=70,t=8,i=8,s=8,a=12,n=8;let o=game.width/2-(t+2+i+2+s+2+a+2+s+2+i+2+n)/2;this.visualizationButton=game.add.sprite(o+t/2,e,"ui_jukebox_visualization",0),this.visualizationButton.anchor.set(.5),o+=t+2,this.skipLeftButton=game.add.sprite(o+i/2,e,"ui_jukebox_skip",0),this.skipLeftButton.anchor.set(.5),this.skipLeftButton.scale.x=-1,o+=i+2,this.seekLeftButton=game.add.sprite(o+s/2,e,"ui_jukebox_seek",0),this.seekLeftButton.anchor.set(.5),this.seekLeftButton.scale.x=-1,o+=s+2,this.pauseButton=game.add.sprite(o+a/2,e,"ui_jukebox_pause_toggle",0),this.pauseButton.anchor.set(.5),o+=a+2,this.seekRightButton=game.add.sprite(o+s/2,e,"ui_jukebox_seek",0),this.seekRightButton.anchor.set(.5),o+=s+2,this.skipRightButton=game.add.sprite(o+i/2,e,"ui_jukebox_skip",0),this.skipRightButton.anchor.set(.5),o+=i+2,this.menuButton=game.add.sprite(o+n/2,e,"ui_jukebox_menu",0),this.menuButton.anchor.set(.5)}setupVisualizer(){this.visualizer=new FullScreenAudioVisualizer(this.audioElement,{visualizationType:this.visualizerMode,barColor:7797982,barWidth:3,barSpacing:1,barBaseHeight:5,barMaxHeight:40,alpha:.6,fftSize:512,smoothing:.7})}setupLyrics(){this.currentSong.lyrics?this.loadLyrics(this.currentSong.lyrics):(this.lyrics=null,this.hasLyrics=!1)}async loadLyrics(e){try{const t=await new Promise((t,i)=>{const s=new XMLHttpRequest;s.open("GET",e),s.onload=()=>{200===s.status||0===s.status?t(s.responseText):i(new Error(`Failed to load lyrics: ${s.status}`))},s.onerror=()=>i(new Error("Network error loading lyrics")),s.send()});this.lyrics=new Lyrics({textElement:this.lyricsText,maxLineLength:25,lrc:t}),this.hasLyrics=!0}catch(e){console.warn("Could not load lyrics:",e),this.lyrics=null,this.hasLyrics=!1}}getSongKey(e){if(e.folderName)return`local_${e.folderName}`;if(e.audioUrl){let t=0;for(let i=0;i<e.audioUrl.length;i++){t=(t<<5)-t+e.audioUrl.charCodeAt(i),t&=t}return`external_${t.toString(36)}`}return`unknown_${Date.now()}`}resetPlaybackPosition(){if(this.audioElement&&this.currentSong){const e=this.getSongKey(this.currentSong);this.playbackPositions[e]=0}}savePlaybackPosition(){if(this.audioElement&&this.currentSong){const e=this.getSongKey(this.currentSong);this.playbackPositions[e]=this.audioElement.currentTime}}loadPlaybackPosition(){if(this.currentSong){const e=this.getSongKey(this.currentSong),t=this.playbackPositions[e];if(t&&t>0)return t}return 0}loadSong(e,t){if(e<0||e>=this.songs.length)return;t?this.resetPlaybackPosition():this.savePlaybackPosition(),this.audioElement.pause(),this.isPlaying=!1,this.currentIndex=e,this.currentSong=this.songs[this.currentIndex],this.audioElement.src=this.currentSong.audioUrl,this.updateSongDisplay(),this.updateBackground(),this.setupLyrics();const i=this.loadPlaybackPosition();this.audioElement.currentTime=i,this.play()}updateSongDisplay(){const e=this.currentSong;if(this.songTitle.write(e.titleTranslit||e.title||"Unknown Title",21),this.songArtist.write(e.artistTranslit||e.artist||"Unknown Artist",21),this.songCredit.write(e.credit||"",21),e.banner&&"no-media"!==e.banner){const t=new Image;t.onload=()=>{const e=document.createElement("canvas");e.width=96,e.height=32;e.getContext("2d").drawImage(t,0,0,96,32);const i=PIXI.Texture.fromCanvas(e);this.bannerSprite.loadTexture(i)},t.src=e.banner}else this.bannerSprite.loadTexture(null)}updateBackground(){if(this.backgroundSprite.loadTexture(null),this.videoElement.src="",this.currentSong.background&&"no-media"!==this.currentSong.background){const e=new Image;e.onload=()=>{const t=document.createElement("canvas");t.width=192,t.height=112;t.getContext("2d").drawImage(e,0,0,192,112);const i=PIXI.Texture.fromCanvas(t);this.backgroundSprite.loadTexture(i)},e.src=this.currentSong.background}this.currentSong.videoUrl&&(this.videoElement.src=this.currentSong.videoUrl,this.videoElement.play(),this.lastVideoUpdate=game.time.now)}updateDurationDisplay(){const e=this.audioElement.duration;if(isNaN(e)||e==1/0)return void this.durationText.write("--:--");const t=Math.floor(e/60),i=Math.floor(e%60);this.durationText.write(`${t}:${i.toString().padStart(2,"0")}`)}updateProgressBar(){const e=this.audioElement.currentTime,t=this.audioElement.duration;if(isNaN(t)||0===t)return;const i=132*(e/t);this.progressBar.clear(),this.progressBar.lineStyle(2,7797982,1),this.progressBar.moveTo(0,0),this.progressBar.lineTo(i,0)}updateTimeDisplay(){const e=this.audioElement.currentTime,t=Math.floor(e/60),i=Math.floor(e%60);this.currentTimeText.write(`${t}:${i.toString().padStart(2,"0")}`)}updateFullscreenMode(){this.fullscreenMode?(this.backgroundSprite.alpha=1,this.uiBackground.visible=!1,this.bannerSprite.visible=!1,this.songTitle.visible=!1,this.songArtist.visible=!1,this.songCredit.visible=!1,this.currentTimeText.visible=!1,this.durationText.visible=!1,this.progressBarBg.visible=!1,this.progressBar.visible=!1,this.visualizationButton.visible=!1,this.skipLeftButton.visible=!1,this.seekLeftButton.visible=!1,this.pauseButton.visible=!1,this.seekRightButton.visible=!1,this.skipRightButton.visible=!1,this.menuButton.visible=!1,this.navigationHint.visible=!1):(this.backgroundSprite.alpha=.4,this.uiBackground.visible=!0,this.bannerSprite.visible=!0,this.songTitle.visible=!0,this.songArtist.visible=!0,this.songCredit.visible=!0,this.currentTimeText.visible=!0,this.durationText.visible=!0,this.progressBarBg.visible=!0,this.progressBar.visible=!0,this.visualizationButton.visible=!0,this.skipLeftButton.visible=!0,this.seekLeftButton.visible=!0,this.pauseButton.visible=!0,this.seekRightButton.visible=!0,this.skipRightButton.visible=!0,this.menuButton.visible=!0,this.navigationHint.visible=!0),this.lyricsText.visible=!0}toggleFullscreen(){this.fullscreenMode=!this.fullscreenMode,this.updateFullscreenMode()}updateButtonStates(){const e=game.time.now;if(this.menuButton.frame=this.buttonActiveTimers.menu>e?1:0,this.menuVisible||this.songListMenuVisible)return;const t=this.isPlaying?0:1;this.pauseButton.frame=t,this.seekLeftButton.frame=gamepad.held.left?1:0,this.seekRightButton.frame=gamepad.held.right?1:0,this.skipLeftButton.frame=this.buttonActiveTimers.skipLeft>e?1:0,this.skipRightButton.frame=this.buttonActiveTimers.skipRight>e?1:0,this.visualizationButton.frame=this.buttonActiveTimers.visualization>e?1:0}setButtonActive(e,t=100){this.buttonActiveTimers[e]=game.time.now+t}changeVolume(e){let t=Account.settings.volume,i=t+e;if(i=Phaser.Math.clamp(i,0,4),i!==t){Account.settings.volume=i,saveAccount(),this.audioElement.volume=[0,25,50,75,100][i]/100;const e=["MUTE","25%","50%","75%","100%"];notifications.show(`VOLUME: ${e[i]}`,1e3)}}play(){this.audioElement.play().then(()=>{this.isPlaying=!0}).catch(e=>{console.warn("Playback failed:",e),this.isPlaying=!1,this.audioElement.currentTime=0,this.play()})}pause(){this.audioElement.pause(),this.isPlaying=!1}togglePlayback(){this.isPlaying?this.pause():this.play(),this.pauseButton.frame=2,this.setButtonActive("pause",100)}nextSong(e){let t=this.currentIndex+1;t>=this.songs.length&&(t=0),this.loadSong(t,e)}previousSong(){let e=this.currentIndex-1;e<0&&(e=this.songs.length-1),this.loadSong(e)}toggleShuffle(){if(this.isShuffled=!this.isShuffled,this.isShuffled){const e=[...this.songs];for(let t=e.length-1;t>0;t--){const i=Math.floor(Math.random()*(t+1));[e[t],e[i]]=[e[i],e[t]]}this.songs=e}else this.songs=[...this.originalSongOrder];this.setButtonActive("visualization",100)}seekForward(){const e=this.audioElement.currentTime,t=Math.min(e+this.seekSpeed,this.audioElement.duration||1/0);this.audioElement.currentTime=t}seekBackward(){const e=this.audioElement.currentTime,t=Math.max(e-this.seekSpeed,0);this.audioElement.currentTime=t}changeVisualizerMode(){const e=["bars","symmetrical","waveform","circular"],t=(e.indexOf(this.visualizerMode)+1)%e.length;this.visualizerMode=e[t],this.visualizer.setVisualizationType(this.visualizerMode),this.setButtonActive("visualization",100)}showSongList(){this.songListMenuVisible=!0;const e=game.add.graphics(0,0);e.beginFill(0,.7),e.drawRect(0,0,game.width,game.height),e.endFill();const t=new CarouselMenu(20,20,152,72,{bgcolor:"brown",fgcolor:"#ffffff",align:"left",disableScrollBar:!1});this.songs.forEach((i,s)=>{const a=i.titleTranslit||i.title||`Song ${s+1}`,n=s===this.currentIndex,o=n?`> ${a}`:`  ${a}`;t.addItem(o,()=>{s!==this.currentIndex&&this.loadSong(s),t.destroy(),e.destroy(),this.songListMenuVisible=!1},{song:i,index:s,bgcolor:n?"#9b59b6":"brown"})}),t.onCancel.add(()=>{t.destroy(),e.destroy(),this.songListMenuVisible=!1}),t.selectedIndex=this.currentIndex,t.updateSelection()}showMenu(){this.menuVisible=!0,this.setButtonActive("menu",100);const e=game.add.graphics(0,0);e.beginFill(0,.7),e.drawRect(0,0,game.width,game.height),e.endFill();const t=new CarouselMenu(60,40,72,40,{bgcolor:"brown",fgcolor:"#ffffff",align:"center"});t.addItem("Continue",()=>{t.destroy(),e.destroy(),this.menuVisible=!1}),t.addItem("Song List",()=>{t.destroy(),e.destroy(),this.menuVisible=!1,this.showSongList()}),t.addItem("Toggle Shuffle",()=>{this.toggleShuffle(),t.destroy(),e.destroy(),this.menuVisible=!1}),t.addItem("Exit Jukebox",()=>{this.exitJukebox()}),t.onCancel.add(()=>{t.destroy(),e.destroy(),this.menuVisible=!1})}exitJukebox(){this.savePlaybackPosition(),this.audioElement.pause(),this.audioElement.src="",this.videoElement&&(this.videoElement.pause(),this.videoElement.src=""),this.visualizer&&this.visualizer.destroy(),this.lyrics&&this.lyrics.destroy(),game.state.start("MainMenu")}update(){if(this.visualizer&&this.visualizer.update(),this.updateDurationDisplay(),this.updateButtonStates(),this.updateLyrics(),this.videoElement.src&&this.videoElement.readyState>=2){const e=game.time.now;if(e-this.lastVideoUpdate>=33){this.lastVideoUpdate=e;const t=document.createElement("canvas");t.width=192,t.height=112;t.getContext("2d").drawImage(this.videoElement,0,0,192,112);const i=PIXI.Texture.fromCanvas(t);this.backgroundSprite.loadTexture(i)}}this.handleInput()}updateLyrics(){if(this.hasLyrics&&this.lyrics&&this.audioElement){const e=this.audioElement.currentTime;this.lyrics.move(e)}else this.lyricsText.write("")}handleInput(){const e=game.time.now;gamepad.update(),this.menuVisible||this.songListMenuVisible||(gamepad.pressed.up&&this.changeVolume(1),gamepad.pressed.down&&this.changeVolume(-1),gamepad.pressed.a&&this.togglePlayback(),gamepad.pressed.b&&this.toggleFullscreen(),gamepad.pressed.select&&this.changeVisualizerMode(),gamepad.pressed.select&&e-this.lastSelectPress<this.doublePressTimeout&&this.toggleShuffle(),gamepad.pressed.start&&this.showMenu(),e-this.lastSeekTime>this.seekCooldown&&(gamepad.held.left&&(this.seekBackward(),this.lastSeekTime=e),gamepad.held.right&&(this.seekForward(),this.lastSeekTime=e)),gamepad.pressed.left&&e-this.lastLeftPress<this.doublePressTimeout&&(this.previousSong(),this.setButtonActive("skipLeft",100),this.lastSeekTime=e),gamepad.pressed.right&&e-this.lastRightPress<this.doublePressTimeout&&(this.nextSong(),this.setButtonActive("skipRight",100),this.lastSeekTime=e),gamepad.pressed.left&&(this.lastLeftPress=e),gamepad.pressed.right&&(this.lastRightPress=e),gamepad.pressed.select&&(this.lastSelectPress=e),gamepad.pressed.b&&(this.lastBPress=e))}shutdown(){this.savePlaybackPosition(),this.audioElement.pause(),this.audioElement.src="",this.videoElement&&(this.videoElement.pause(),this.videoElement.src=""),this.visualizer&&this.visualizer.destroy(),this.lyrics&&this.lyrics.destroy()}}class Credits{init(e="MainMenu",t={}){this.returnState=e,this.returnStateParams=t,this.scrollSpeed=15,this.isWaitingForInput=!1,this.backgroundInterval=8e3,this.availableBackgrounds=[]}create(){game.camera.fadeIn(0),this.setupBackground(),this.startBackgroundMusic(),this.creditsContainer=game.add.group();const e=[{text:"PADMANIACS",font:FONTS.shaded,tint:7797982,spacing:25},{text:"Created by Retora",font:FONTS.default,tint:16777215,spacing:15},{text:"SONG CREDITS",font:FONTS.shaded,tint:7797982,spacing:20}],t=this.getSongCredits();t.length>0&&(e.push(...t),e.push({text:"",font:FONTS.default,tint:16777215,spacing:15})),e.push({text:"Special Thanks",font:FONTS.shaded,tint:7797982,spacing:20},{text:"StepMania Team",font:FONTS.default,tint:16777215,spacing:8},{text:"photonstorm",font:FONTS.default,tint:16777215,spacing:8},{text:"itch.io",font:FONTS.default,tint:16777215,spacing:8},{text:"You!",font:FONTS.shaded,tint:16777215,spacing:25},{text:COPYRIGHT,font:FONTS.default,tint:8947848,spacing:40});let i=game.height+20;e.forEach((e,t)=>{const s=new Text(game.width/2,i,e.text,e.font,this.creditsContainer);s.anchor.set(.5),s.wrapPreserveNewlines(112),s.tint=e.tint,s.creditData=e,i+=e.spacing}),this.totalHeight=i,this.startY=this.creditsContainer.y,this.creditsComplete=!1,addonManager.executeStateBehaviors(this.constructor.name,this)}setupBackground(){this.backgroundSprite=game.add.sprite(0,0),this.backgroundSprite.alpha=.7,this.collectBackgrounds(),this.availableBackgrounds.length>0?(this.showNextBackground(),this.backgroundTimer=game.time.events.loop(this.backgroundInterval,this.showNextBackground,this)):this.backgroundSprite.loadTexture("ui_background_gradient")}collectBackgrounds(){this.availableBackgrounds=[],window.localSongs&&Array.isArray(window.localSongs)&&window.localSongs.forEach(e=>{e.background&&"no-media"!==e.background&&this.availableBackgrounds.push(e.background),e.banner&&"no-media"!==e.banner&&this.availableBackgrounds.push(e.banner)}),window.externalSongs&&Array.isArray(window.externalSongs)&&window.externalSongs.forEach(e=>{e.background&&"no-media"!==e.background&&this.availableBackgrounds.push(e.background),e.banner&&"no-media"!==e.banner&&this.availableBackgrounds.push(e.banner)}),this.availableBackgrounds=[...new Set(this.availableBackgrounds)],console.log(`Found ${this.availableBackgrounds.length} backgrounds for slideshow`)}showNextBackground(){if(0===this.availableBackgrounds.length)return;const e=game.rnd.pick(this.availableBackgrounds),t=new Image;t.onload=()=>{const e=document.createElement("canvas");e.width=192,e.height=112;e.getContext("2d").drawImage(t,0,0,192,112);const i=PIXI.Texture.fromCanvas(e);this.backgroundSprite.loadTexture(i),this.backgroundSprite.alpha=0,game.add.tween(this.backgroundSprite).to({alpha:.4},1e3,"Linear",!0)},t.src=e}startBackgroundMusic(){backgroundMusic&&backgroundMusic.stop();const e=[];window.localSongs&&Array.isArray(window.localSongs)&&e.push(...window.localSongs),window.externalSongs&&Array.isArray(window.externalSongs)&&e.push(...window.externalSongs);const t=e.filter(e=>e.audioUrl);if(t.length>0){const e=game.rnd.pick(t);this.creditsMusic=document.createElement("audio"),this.creditsMusic.src=e.audioUrl,this.creditsMusic.volume=[0,25,50,75,100][Account.settings.volume]/100,this.creditsMusic.loop=!0,this.creditsMusic.play().catch(e=>{console.warn("Could not play credits music:",e)}),console.log(`Playing credits music: ${e.title||"Unknown Song"}`)}}getSongCredits(){const e=[],t=new Set;return window.localSongs&&Array.isArray(window.localSongs)&&window.localSongs.forEach(i=>{const s=i.credit,a=i.titleTranslit||i.title||"Unknown Song";s&&!t.has(s.toLowerCase())&&(t.add(s.toLowerCase()),e.push({text:a,font:FONTS.default,tint:16777215,spacing:8},{text:`by ${s}`,font:FONTS.default,tint:14737632,spacing:12}))}),e.push({text:"",font:FONTS.default,tint:16777215,spacing:8},{text:"All songs and charts belong to their respective copyright holders.",font:FONTS.default,tint:8947848,spacing:12}),e}update(){if(this.visualizer&&this.visualizer.update(),gamepad.update(),this.creditsComplete)return;this.creditsContainer.y-=this.scrollSpeed*(gamepad.held.any?4:1)*(game.time.elapsed/1e3);this.creditsContainer.y+this.totalHeight<0&&!this.creditsComplete&&(this.creditsComplete=!0,this.onCreditsComplete())}onCreditsComplete(){this.continueText=new Text(game.width/2,game.height/2,"Thank you for playing",FONTS.shaded),this.continueText.anchor.set(.5),this.continueText.alpha=0,game.add.tween(this.continueText).to({alpha:1},1e3,"Linear",!0),this.isWaitingForInput=!0,gamepad.signals.pressed.any.addOnce(()=>{this.returnToMenu()})}returnToMenu(){this.creditsMusic&&(this.creditsMusic.pause(),this.creditsMusic.src="",this.creditsMusic=null),this.backgroundTimer&&game.time.events.remove(this.backgroundTimer),backgroundMusic&&Account.settings.enableMenuMusic&&backgroundMusic.playLastSong(),game.camera.fade(0,1e3),game.camera.onFadeComplete.addOnce(()=>{game.state.start(this.returnState,!0,!1,this.returnStateParams)})}shutdown(){this.skipHandler&&gamepad.signals.pressed.any.remove(this.skipHandler),this.creditsMusic&&(this.creditsMusic.pause(),this.creditsMusic.src=""),this.backgroundTimer&&game.time.events.remove(this.backgroundTimer)}}class ChartRenderer{constructor(e,t,i,s={}){this.scene=e,this.song=t,this.difficultyIndex=i,this.chart=t.chart,this.difficulty=this.chart.difficulties[i],this.notes=this.chart.notes[this.difficulty.type+this.difficulty.rating],this.bpmChanges=this.chart.bpmChanges,this.stops=this.chart.stops,this.options={enableGameplayLogic:!0,enableJudgement:!0,enableInput:!0,enableHealth:!0,enableMissChecking:!0,...s},this.scrollDirection=Account.settings.scrollDirection||"falling",this.VERTICAL_SEPARATION=1.25,this.SCREEN_CONSTANT="C-MOD"===Account.settings.speedMod?4:1,this.NOTE_SPEED_MULTIPLIER=Account.settings.noteSpeedMult+this.SCREEN_CONSTANT,this.JUDGE_LINE="falling"===this.scrollDirection?90:30,this.DIRECTION="falling"===this.scrollDirection?-1:1,this.COLUMN_SIZE=16,this.COLUMN_SEPARATION=4,this.INACTIVE_COLOR=8947848,this.speedMod=Account.settings.speedMod||"X-MOD",this.noteColorOption=Account.settings.noteColorOption||"NOTE";const a=0,n=1,o=2,r=3,c=4,l=5,h=6,d=7,u=8,g=9,m=10,p=11;this.colorMappings={NOTE:{4:a,8:n,12:o,16:r,24:c,32:l,48:h,64:d,96:u,128:g,192:m,default:p},VIVID:{4:r,8:a,12:n,16:h,24:r,32:a,48:n,64:h,96:r,128:a,192:n,default:h},FLAT:{4:r,8:r,12:r,16:r,24:r,32:r,48:r,64:r,96:r,128:r,192:r,default:r},RAINBOW:{4:l,8:n,12:c,16:c,24:n,32:l,48:c,64:n,96:c,128:l,192:n,default:c}},this.linesGroup=new Phaser.SpriteBatch(game),this.receptorsGroup=new Phaser.SpriteBatch(game),this.freezeBodyGroup=new Phaser.Group(game),this.freezeEndGroup=new Phaser.Group(game),this.notesGroup=new Phaser.SpriteBatch(game),this.minesGroup=new Phaser.Group(game),this.explosionsGroup=new Phaser.SpriteBatch(game),this.receptors=[],this.initialize()}initialize(){const e=this.calculateLeftOffset();for(let t=0;t<4;t++){const i=game.add.sprite(e+t*(this.COLUMN_SIZE+this.COLUMN_SEPARATION)+this.COLUMN_SIZE/2,this.JUDGE_LINE,"receptor",2);i.anchor.set(.5),i.angle={0:90,1:0,2:180,3:-90}[t],this.options.enableInput&&(i.inputEnabled=!0,i.down=!1),i.animations.add("down",[2,1,0],30,!1),i.animations.add("up",[0,1,2],30,!1);const s=game.add.sprite(i.x,i.y,"explosion");s.anchor.set(.5),s.angle=i.angle,s.visible=!1,i.explosion=s;const a=50;s.visible=!1,s.scale.setTo(1.5),game.add.tween(s.scale).to({x:2,y:2},a,"Linear",!0).yoyo(!0).repeat(-1),this.receptorsGroup.add(i),this.receptors.push(i)}}calculateLeftOffset(){return(192-(4*this.COLUMN_SIZE+3*this.COLUMN_SEPARATION))/2}getNoteFrame(e){const t=e.beat,i=this.colorMappings[this.noteColorOption],s=Object.keys(i).filter(e=>"default"!==e).map(Number).sort((e,t)=>e-t);for(const e of s)if(this.isBeatDivision(t,e))return i[e];return i.default}isBeatDivision(e,t){const i=1e-4,s=e*t%4;return Math.abs(s)<i||Math.abs(s-4)<i}calculateVerticalPosition(e,t,i){let s,a=0;if("C-MOD"===this.speedMod){if(s=(e.sec-t)*this.COLUMN_SIZE*this.VERTICAL_SEPARATION*this.NOTE_SPEED_MULTIPLIER,e.beatLength){const t=e.secLength||60*e.beatLength/this.getCurrentBPM();a=Math.max(this.COLUMN_SIZE,t*this.COLUMN_SIZE*this.VERTICAL_SEPARATION*this.NOTE_SPEED_MULTIPLIER)}}else{s=(e.beat-i)*this.COLUMN_SIZE*this.VERTICAL_SEPARATION*this.NOTE_SPEED_MULTIPLIER,e.beatLength&&(a=Math.max(this.COLUMN_SIZE,e.beatLength*this.COLUMN_SIZE*this.VERTICAL_SEPARATION*this.NOTE_SPEED_MULTIPLIER))}return{pastSize:s,bodyHeight:a,yPos:"falling"===this.scrollDirection?this.JUDGE_LINE-s:this.JUDGE_LINE+s}}getCurrentBPM(e=0){const t=this.bpmChanges.find((t,i,s)=>i===s.length-1||s[i+1].beat>e);return t?t.bpm:120}getLastBpm(e,t){return this.bpmChanges.find((i,s,a)=>s+1==a.length||a[s+1][t]>=e)}beatToSec(e){let t=this.getLastBpm(e,"beat"),i=(e-t.beat)/t.bpm*60+t.sec,s=this.stops.filter(({beat:i})=>i>=t.beat&&i<e).map(e=>e.len);for(let e in s)i+=s[e];return i}secToBeat(e){let t=this.getLastBpm(e,"sec"),i=this.stops.filter(({sec:i})=>i>=t.sec&&i<e).map(t=>t.sec+t.len>e?e-t.sec:t.len);for(let t in i)e-=i[t];return(e-t.sec)*t.bpm/60+t.beat}render(e,t){"falling"===this.scrollDirection?this.renderFalling(e,t):this.renderRising(e,t),Account.settings.beatLines&&this.renderTimeLines(e,t)}renderFalling(e,t){const i=this.calculateLeftOffset();this.notes.forEach(s=>{let{pastSize:a,bodyHeight:n,yPos:o}=this.calculateVerticalPosition(s,e,t);const r=i+s.column*(this.COLUMN_SIZE+this.COLUMN_SEPARATION);this.options.enableMissChecking&&"M"!==s.type&&"2"!=s.type&&"4"!=s.type&&!s.hit&&!s.miss&&o>game.height&&(s.miss=!0,this.options.enableGameplayLogic&&this.scene.player.processJudgement&&this.scene.player.processJudgement(s,"miss",s.column)),o<-this.COLUMN_SIZE||o>game.height+n?s.sprite&&(s.sprite.kill(),delete s.sprite,s.holdParts&&(s.holdParts.body.destroy(),s.holdParts.end.destroy(),delete s.holdParts)):("M"===s.type?(s.sprite||(s.sprite=this.minesGroup.getFirstDead()||(()=>{const e=game.add.sprite(r,o,"mine");return this.minesGroup.add(e),e})(),s.sprite.reset(0,-32),s.sprite.animations.add("blink",[0,1,2,3,4,5,6,7],10,!0),s.sprite.animations.play("blink")),s.sprite.anchor.set(.5),s.sprite.x=r+this.COLUMN_SIZE/2,s.sprite.y=o):"2"!==s.type&&"4"!==s.type||(o=this.renderHoldNote(s,r,o,n,e,t,"falling")),"M"!==s.type&&"3"!==s.type&&(s.sprite||(s.sprite=this.notesGroup.getFirstDead()||(()=>{const e=game.add.sprite(0,0);return this.notesGroup.add(e),e})(),s.sprite.reset(0,-32),s.sprite.loadTexture("arrows"),s.sprite.frame=this.getNoteFrame(s),s.sprite.anchor.set(.5),s.sprite.angle={0:90,1:0,2:180,3:-90}[s.column]),s.sprite.x=r+this.COLUMN_SIZE/2,s.sprite.y=o))})}renderRising(e,t){const i=this.calculateLeftOffset();this.notes.forEach(s=>{let{pastSize:a,bodyHeight:n,yPos:o}=this.calculateVerticalPosition(s,e,t);const r=i+s.column*(this.COLUMN_SIZE+this.COLUMN_SEPARATION);this.options.enableMissChecking&&"M"!==s.type&&"2"!=s.type&&"4"!=s.type&&!s.hit&&!s.miss&&o<-this.COLUMN_SIZE&&(s.miss=!0,this.options.enableGameplayLogic&&this.scene.player.processJudgement&&this.scene.player.processJudgement(s,"miss",s.column)),o>game.height+this.COLUMN_SIZE||o<-n?s.sprite&&(s.sprite.kill(),delete s.sprite,s.holdParts&&(s.holdParts.body.destroy(),s.holdParts.end.destroy(),delete s.holdParts)):("M"===s.type?(s.sprite||(s.sprite=this.minesGroup.getFirstDead()||(()=>{const e=game.add.sprite(r,o,"mine");return this.notesGroup.add(e),e})(),s.sprite.reset(0,-32),s.sprite.animations.add("blink",[0,1,2,3,4,5,6,7],10,!0),s.sprite.animations.play("blink")),s.sprite.anchor.set(.5),s.sprite.x=r+this.COLUMN_SIZE/2,s.sprite.y=o):"2"!==s.type&&"4"!==s.type||(o=this.renderHoldNote(s,r,o,n,e,t,"rising")),"M"!==s.type&&"3"!==s.type&&(s.sprite||(s.sprite=this.notesGroup.getFirstDead()||(()=>{const e=game.add.sprite(0,0);return this.notesGroup.add(e),e})(),s.sprite.reset(0,-32),s.sprite.loadTexture("arrows"),s.sprite.frame=this.getNoteFrame(s),s.sprite.anchor.set(.5),s.sprite.angle={0:90,1:0,2:180,3:-90}[s.column]),s.sprite.x=r+this.COLUMN_SIZE/2,s.sprite.y=o))})}renderHoldNote(e,t,i,s,a,n,o){if(!e.holdParts){const i="2"===e.type?"hold":"roll",s=()=>{const e=this.freezeBodyGroup.getFirstDead()||(()=>{const e=game.add.tileSprite(-64,-64,this.COLUMN_SIZE,0,`${i}_body`);return"rising"===o?(e.scale.y=-1,e.anchor.y=1):e.anchor.y=1,this.freezeBodyGroup.add(e),e})();return e.reset(t,-64),e.loadTexture(`${i}_body`),e},a=()=>{const e=this.freezeEndGroup.getFirstDead()||(()=>{const e=game.add.sprite(0,0);return"rising"===o?(e.scale.y=-1,e.anchor.y=1):e.anchor.y=1,this.freezeEndGroup.add(e),e})();return e.reset(t,-64),e.loadTexture(`${i}_end`),e};e.holdParts={body:s(),end:a()},e.holdActive=!1}const r=this.options.enableGameplayLogic&&!e.finish&&!e.miss&&this.scene.activeHolds&&this.scene.activeHolds[e.column]?.note===e&&this.scene.activeHolds[e.column].active;let c=void 0!==e.visibleHeight?e.visibleHeight:s;if(c<0&&(c=1),r&&this.options.enableGameplayLogic){if("falling"===o){const t=i-s,a=this.JUDGE_LINE;e.visibleHeight=Math.max(0,a-t),i>a-this.COLUMN_SIZE/2&&(i=a)}else{const t=i+s,a=this.JUDGE_LINE;e.visibleHeight=Math.max(0,t-a),i<a+this.COLUMN_SIZE/2&&(i=a)}e.active=!0}else this.options.enableGameplayLogic&&void 0!==e.visibleHeight&&("falling"===o?i-=s-e.visibleHeight:i+=s-e.visibleHeight,e.active=!1);!this.options.enableMissChecking||e.miss||e.holdActive||("falling"===o&&i>this.JUDGE_LINE+this.COLUMN_SIZE||"rising"===o&&i<this.JUDGE_LINE-this.COLUMN_SIZE)&&(e.miss=!0,this.options.enableGameplayLogic&&this.scene.player.processJudgement&&this.scene.player.processJudgement(e,"miss",e.column));let l=!e.finish,h=Math.floor(i),d=Math.floor(c);"falling"===o?(e.holdParts.body.y=h,e.holdParts.body.height=d,e.holdParts.end.y=h-d):(e.holdParts.body.y=h,e.holdParts.body.height=d,e.holdParts.end.y=h+d),e.holdParts.body.visible=l,e.holdParts.end.visible=l,e.sprite&&(e.sprite.visible=!r&&l);const u=r?1:0,g="2"===e.type?47872:61166,m=e.miss?this.INACTIVE_COLOR:g,p=e.miss?.8:1;return e.holdParts.body.frame=u,e.holdParts.end.frame=u,e.holdParts.body.tint=m,e.holdParts.end.tint=m,e.holdParts.body.alpha=p,e.holdParts.end.alpha=p,i}renderTimeLines(e,t){if(!Account.settings.beatLines)return;const i=Account.settings.beatsPerMeasure||4,s=Math.floor(t/i),a=s+8,n=new Set;for(let o=s;o<=a;o++){const s=o*i;this.updateTimeLine(s,.9,e,t),n.add(s);for(let a=1;a<i;a++){const i=s+a;this.updateTimeLine(i,.35,e,t),n.add(i)}}this.cleanupInvisibleLines(n)}updateTimeLine(e,t,i,s){let a;if("C-MOD"===this.speedMod){const t=(this.beatToSec(e)-i)*this.COLUMN_SIZE*this.VERTICAL_SEPARATION*this.NOTE_SPEED_MULTIPLIER;a="falling"===this.scrollDirection?this.JUDGE_LINE-t:this.JUDGE_LINE+t}else{const t=(e-s)*this.COLUMN_SIZE*this.VERTICAL_SEPARATION*this.NOTE_SPEED_MULTIPLIER;a="falling"===this.scrollDirection?this.JUDGE_LINE-t:this.JUDGE_LINE+t}if(a>=-this.COLUMN_SIZE&&a<=game.height+this.COLUMN_SIZE){let i=this.findLineForBeat(e);return i?(i.y=a,i.alpha=t,i.revive()):(i=this.createLine(a,t),i&&(i.targetBeat=e)),i}return null}findLineForBeat(e){const t=this.linesGroup.getAll("alive",!0);for(let i=0;i<t.length;i++){const s=t[i];if(s.targetBeat===e)return s}return null}createExplosion(e,t="normal"){const i=this.receptors[e.column],s=this.explosionsGroup.getFirstDead()||(()=>{const e=game.add.sprite(-64,-64);return e.anchor.set(.5),this.explosionsGroup.add(e),e})();s.loadTexture("normal"==t?"explosion":"mineexplosion"),s.reset(i.x,i.y),s.alpha=1,s.scale.set(1),s.angle=i.angle;game.add.tween(s.scale).to({x:2,y:2},200,"Linear",!0),game.add.tween(s).to({alpha:0},200,"Linear",!0).onComplete.add(()=>s.kill())}toggleHoldExplosion(e,t){const i=this.receptors[e].explosion;i.visible=t,t&&i.bringToTop()}cleanupInvisibleLines(e){const t=this.linesGroup.getAll("alive",!0);for(let e=0;e<t.length;e++){const i=t[e],s=2*this.COLUMN_SIZE;(i.y<-s||i.y>game.height+s)&&i.kill()}}createLine(e,t){const i=this.linesGroup.getFirstDead()||(()=>{const t=game.add.bitmapData(1,1);t.fill(255,255,255);const i=game.add.sprite(this.calculateLeftOffset(),e,t);return i.width=4*this.COLUMN_SIZE+3*this.COLUMN_SEPARATION,this.linesGroup.add(i),i})();return i.y=e,i.alpha=t,i.revive(),i}destroy(){this.linesGroup.destroy(!0),this.receptorsGroup.destroy(!0),this.freezeBodyGroup.destroy(!0),this.freezeEndGroup.destroy(!0),this.notesGroup.destroy(!0),this.minesGroup.destroy(!0),this.explosionsGroup.destroy(!0)}}class Player{constructor(e){this.scene=e,this.renderer=new ChartRenderer(e,JSON.parse(JSON.stringify(e.song)),e.song.difficultyIndex,{enableGameplayLogic:!0,enableJudgement:!0,enableInput:!0,enableHealth:!0,enableMissChecking:!0}),this.notes=this.renderer.notes,this.bpmChanges=this.renderer.bpmChanges,this.stops=this.renderer.stops,this.autoplay=e.autoplay,this.autoplayActiveHolds=new Set,this.keymap={left:0,down:1,up:2,right:3,a:3,b:2},this.inputStates=[!1,!1,!1,!1],this.lastInputStates=[!1,!1,!1,!1],this.activeHolds={},this.heldColumns=new Set,this.judgementHistory=[],this.lastNoteCheckBeats=[0,0,0,0],this.score=0,this.combo=0,this.maxCombo=0,this.maxHealth=100,this.health=this.maxHealth,this.previousHealth=this.health,this.timingStory=[],this.HOLD_FORGIVENESS=.3,this.ROLL_FORGIVENESS=.3,this.ROLL_REQUIRED_INTERVALS=.5,this.judgementCounts={marvelous:0,perfect:0,great:0,good:0,boo:0,miss:0},this.totalNotes=0,this.accuracy=0,this.gameOver=!1,this.skillSystem=this.scene.skillSystem,this.perfectStreak=0,this.comboShieldActive=!1,this.skillSystem.onHealthRegen=e=>this.onSkillHpRegen(e),this.skillSystem.onComboShield=()=>this.onComboShield(),this.calculateTotalNotes(),this.updateAccuracy(),this.receptors=this.renderer.receptors,this.judgementText=this.scene.judgementText||new Text(96,20,"",{tint:16777215}),this.comboText=this.scene.comboText||new Text(96,40,"0",{tint:16777215}),this.scoreText=this.scene.scoreText||new Text(8,8,"00000000",{tint:16777215}),this.healthText=this.scene.healthText||new Text(184,8,"100%",{tint:16777215})}calculateTotalNotes(){this.totalNotes=this.notes.filter(e=>"1"===e.type||"2"===e.type||"4"===e.type).length}calculateLeftOffset(){return(192-(4*this.COLUMN_SIZE+3*this.COLUMN_SEPARATION))/2}findClosestNote(e,t,i,s=.5){const a=this.scene.getCurrentTime().now,n=s*(this.getCurrentBPM(t)/60),o=this.notes.filter(s=>!s.hit&&s.column===e&&i.includes(s.type)&&Math.abs(s.beat-t)<=n);return 0===o.length?null:o.reduce((e,t)=>Math.abs(t.sec-a)<Math.abs(e.sec-a)?t:e)}findNotesInJudgeWindow(e,t,i,s){return this.notes.filter(a=>!a.hit&&a.column===e&&i.includes(a.type)&&Math.abs(a.beat-t)<=s)}processNoteIfInWindow(e,t,i,s){const a=e.sec-t,n=this.scene.JUDGE_WINDOWS.boo/1e3;return Math.abs(a)<=n&&this.lastNoteCheckBeats[i]!==e.beat&&(s(e,a),this.lastNoteCheckBeats[i]=e.beat,!0)}autoPlay(){if(!this.scene.startTime||this.scene.isPaused)return;const{now:e,beat:t}=this.scene.getCurrentTime();for(let e=0;e<4;e++){const i=this.findClosestNote(e,t,"1");if(i){i.beat-t<=0&&!this.inputStates[e]&&(this.handleInput(e,!0),this.handleInput(e,!1))}}for(let e=0;e<4;e++){const i=this.findClosestNote(e,t,["2","4"]);if(i&&!this.autoplayActiveHolds.has(e)){i.beat-t<=0&&(this.handleInput(e,!0),this.autoplayActiveHolds.add(e))}const s=this.activeHolds[e];s&&s.progress>=s.note.secLength&&(this.handleInput(e,!1),this.autoplayActiveHolds.delete(e))}for(let e of this.autoplayActiveHolds){const t=this.activeHolds[e];t&&!t.note.hit||(this.handleInput(e,!1),this.autoplayActiveHolds.delete(e))}}handleInput(e,t){if(!this.scene.startTime||this.scene.isPaused)return;const{now:i,beat:s}=this.scene.getCurrentTime(),a=this.activeHolds[e];if(this.inputStates[e]=t,t){this.heldColumns.add(e);const t=this.getHoldForgiveness();a?.inactive&&i-a.lastRelease<t&&(a.active=!0,a.inactive=!1,a.pressCount++,a.lastPress=i,this.toggleHoldExplosion(e,!0)),"4"===a?.note.type&&(a.tapped++,a.lastTap=i,a.active=!0,a.inactive=!1);const n=this.checkRegularNotes(e,i,s);a||n||this.checkHoldStart(e,i,s)}else this.heldColumns.delete(e),this.checkHoldRelease(e,i)}checkRegularNotes(e,t,i){const s=this.findClosestNote(e,i,["1"]);return!!s&&this.processNoteIfInWindow(s,t,e,(t,i)=>{const s=this.getJudgement(i);this.createExplosion(t),t.sprite?.destroy(),!t.hit&&this.processJudgement(t,s,e),t.hit=!0})}checkMines(e,t,i){const s=this.notes.filter(t=>!t.hit&&t.column===e&&"M"===t.type&&Math.abs(t.beat-i)<=.1);let a=!1;for(const e of s){const{yPos:s}=this.renderer.calculateVerticalPosition(e,t,i),n=this.renderer.JUDGE_LINE;Math.abs(s-n)<=12&&(this.triggerMine(e),a=!0)}return a}triggerMine(e){this.createExplosion(e,"mine"),e.hit=!0,e.sprite?.destroy();const t=this.skillSystem?this.skillSystem.getMineDamageMultiplier():1,i=Math.floor(10*t);this.health=Math.max(0,this.health-i),this.combo=0,this.skillSystem&&this.skillSystem.checkSkillActivation("on_mine_hit",{})}checkHoldStart(e,t,i){const s=this.findClosestNote(e,i,["2","4"]);s&&this.processNoteIfInWindow(s,t,e,(i,s)=>{const a=this.getJudgement(s);this.processJudgement(i,a,e),this.activeHolds[e]={note:i,startTime:t,progress:0,tapped:0,pressCount:0,active:!0,inactive:!1,lastPress:t,lastRelease:null,lastTap:t},i.holdActive=!0,this.toggleHoldExplosion(e,!0)})}checkHoldRelease(e,t){const i=this.activeHolds[e];if(i&&(i.lastRelease=t,"2"===i.note.type)){const s=this.getHoldForgiveness();i.note.secLength-(t-i.startTime)>s&&(i.active=!1,i.inactive=!0,this.toggleHoldExplosion(e,!1))}}createExplosion(e,t="normal"){this.renderer.createExplosion(e,t)}toggleHoldExplosion(e,t){this.renderer.toggleHoldExplosion(e,t)}getAdjustedJudgementWindows(){const e={...this.scene.JUDGE_WINDOWS},t=this.skillSystem?this.skillSystem.getJudgementWindowMultiplier():1;return Object.keys(e).forEach(i=>{e[i]*=t}),e}getHoldForgiveness(){return this.HOLD_FORGIVENESS*(this.skillSystem?this.skillSystem.getHoldForgivenessMultiplier():1)}getRollForgiveness(){return this.ROLL_FORGIVENESS*(this.skillSystem?this.skillSystem.getRollForgivenessMultiplier():1)}getJudgement(e){this.timingStory.push(e);const t=this.getAdjustedJudgementWindows(),i=Math.abs(1e3*e);for(const[e,s]of Object.entries(t))if(i<=s)return"marvelous"===e||"perfect"===e?this.perfectStreak++:this.perfectStreak=0,e;return"miss"}processJudgement(e,t,i,s="normal"){if("miss"===t&&this.comboShieldActive&&(t="boo",this.comboShieldActive=!1),this.skillSystem&&(this.skillSystem.checkSkillActivation("on_miss",{judgement:t}),this.perfectStreak>0&&this.skillSystem.checkSkillActivation("on_perfect_streak",{perfectStreak:this.perfectStreak})),this.skillSystem){const e=this.skillSystem.getJudgementConversion();e&&t===e.from&&(t=e.to)}let a="";switch(t){case"ok":a="marvelous";break;case"n.g.":case"ng":a="boo",t="n.g.";break;default:a=t}this.autoplay&&(t="normal"==s?"marvelous":"ok",a="marvelous");const n=this.skillSystem?this.skillSystem.getScoreMultiplier(a):1,o=Math.floor(this.scene.SCORE_VALUES[a]*n);if(this.gameOver||(this.score+=o),this.judgementCounts[a]++,"miss"===t)this.combo=0,this.health=Math.max(0,this.health-5);else{this.combo++;const e=this.skillSystem?this.skillSystem.getHealthGainMultiplier():1,t=Math.floor(2*e);this.gameOver||(this.health=Math.min(this.getMaxHealth(),this.health+t)),this.combo>this.maxCombo&&(this.maxCombo=this.combo)}this.updateAccuracy(),this.updateUI(),this.showJudgementText(t,i,s)}getMaxHealth(){return this.maxHealth+(this.skillSystem?this.skillSystem.getMaxHealthBonus():0)}getNoteSpeedMultiplier(){return this.NOTE_SPEED_MULTIPLIER*(this.skillSystem?this.skillSystem.getNoteSpeedMultiplier():1)}updateAccuracy(){if(this.gameOver)return;const e={marvelous:1,perfect:.9,great:.8,good:.5,boo:.25,miss:0};let t=0,i=0;for(const[s,a]of Object.entries(this.judgementCounts)){t+=1*a,i+=a*e[s]}const s=Object.values(this.judgementCounts).reduce((e,t)=>e+t,0);if(t+=1*Math.max(0,this.totalNotes-s),this.accuracy=t>0?i/t*100:100,this.accuracy=Phaser.Math.clamp(this.accuracy,0,100),this.scene.accuracyBar){const e=Math.floor(Math.max(1,this.accuracy/100*150));this.scene.accuracyBar.crop(new Phaser.Rectangle(0,0,e,2))}}updateUI(){this.comboText.write(this.combo.toString()),this.comboText.tint=this.getComboColor(this.combo),this.scoreText.write(this.score.toString().padStart(8,"0")),this.combo>0&&this.pulseText(this.comboText)}getScoreRating(){const e=this.accuracy;return e>=98?"SSS+":e>=95?"SSS":e>=92.5?"SS":e>=90?"S":e>=80?"A":e>=70?"B":e>=60?"C":e>=50?"D":e>=40?"E":"F"}showJudgementText(e,t,i){let s={marvelous:65535,perfect:16776960,great:65280,good:255,boo:16753920,miss:16711680,ok:52224,ng:2293759}[e.replace("n.g.","ng")];if("freeze"==i){const i=new Text(this.renderer.receptors[t].x,this.renderer.JUDGE_LINE+12*this.renderer.DIRECTION,e,FONTS.stroke);i.tint=s,i.anchor.setTo(.5),game.add.tween(i).to({alpha:0,y:i.y+8*this.renderer.DIRECTION},250,"Linear",!0,25).onComplete.addOnce(()=>i.destroy())}else if(this.judgementText.write(e.toUpperCase()),this.judgementText.tint=s,this.judgementText.alpha=1,this.judgementText.scale.set(1),game.tweens.removeFrom(this.judgementText),game.add.tween(this.judgementText.scale).to({x:1.5,y:1},200,"Linear",!0).yoyo(!0),game.add.tween(this.judgementText).to({alpha:0},200,"Linear",!0,200),void 0!==t&&"miss"!==e){const e=this.receptors[t];this.pulseSprite(e)}}pulseText(e){e.scale.set(1),game.add.tween(e.scale).to({x:1.3,y:1.3},100,"Linear",!0).yoyo(!0)}pulseSprite(e){e.scale.set(1),game.add.tween(e.scale).to({x:1.2,y:1.2},50,"Linear",!0).yoyo(!0)}getComboColor(e){const t=100,i=Math.min(t,e);return Math.floor(255+i/t*0)<<16|Math.floor(255+i/t*0)<<8|Math.floor(255+i/t*-255)}onSkillHpRegen(e=0){this.gameOver||(this.health=Math.min(this.getMaxHealth(),this.health+e))}onComboShield(){this.comboShieldActive=!0}getCurrentBPM(e=0){return this.renderer.getCurrentBPM(e)}getLastBpm(e,t){return this.renderer.getLastBpm(e,t)}beatToSec(e){return this.renderer.beatToSec(e)}secToBeat(e){return this.renderer.secToBeat(e)}render(){if(!this.scene.startTime||this.scene.isPaused)return;this.renderer.scene.activeHolds=this.activeHolds;const{now:e,beat:t}=this.scene.getCurrentTime();this.renderer.render(e,t)}update(){const{now:e,beat:t}=this.scene.getCurrentTime();if(this.autoplay)this.autoPlay();else{Object.keys(this.keymap).forEach(e=>{gamepad.pressed[e]?this.handleInput(this.keymap[e],!0):gamepad.released[e]&&this.handleInput(this.keymap[e],!1)});for(let i=0;i<4;i++)this.inputStates[i]&&this.checkMines(i,e,t)}for(let e=0;e<4;e++){const t=this.receptors[e],i=this.inputStates[e];t.down!=i&&(t.down=i),t.frame=i?0:2}this.skillSystem&&(this.skillSystem.update(),this.combo>0&&(this.skillSystem.checkSkillActivation("on_combo",{combo:this.combo}),this.skillSystem.checkSkillActivation("on_high_combo",{combo:this.combo})),this.health<=30&&this.skillSystem.checkSkillActivation("on_low_health",{health:this.health}),this.health<=15&&this.skillSystem.checkSkillActivation("on_critical_health",{health:this.health})),this.health!=this.previousHealth&&(this.previousHealth=this.health,game.add.tween(this.scene.lifebarMiddle).to({width:this.health/this.getMaxHealth()*102},100,Phaser.Easing.Quadratic.In,!0),this.health<=0&&(this.gameOver=!0,this.health=0),this.healthText.write(this.health.toString())),this.scene.lifebarEnd.x=this.scene.lifebarMiddle.width,this.scene.accuracyBar&&(this.accuracy<=0?this.scene.accuracyBar.visible=!1:this.scene.accuracyBar.visible=!0),Object.entries(this.activeHolds).forEach(([e,t])=>{const{now:i}=this.scene.getCurrentTime();if(this.autoplay||"2"===t.note.type){if(!t.active){const s=this.getHoldForgiveness();i-t.lastRelease>s&&(t.inactive=!0,t.note.miss=!0,this.toggleHoldExplosion(e,!1))}}else if("4"===t.note.type){const s=this.getRollForgiveness();i-t.lastTap>s&&(t.inactive=!0,t.active=!1,t.note.miss=!0,this.toggleHoldExplosion(e,!1))}if(t.progress=i-t.startTime,t.progress>=t.note.secLength){let i="n.g.";if("2"===t.note.type)i=t.note.miss?"n.g.":"ok";else if("4"===t.note.type){const e=Math.ceil(t.note.beatLength*this.ROLL_REQUIRED_INTERVALS);i=t.note.beatLength<=.5||t.tapped>=e&&!t.note.miss?"ok":"n.g."}t.note.finish=!0,this.processJudgement(t.note,i,Number(e),"freeze"),t.note.hit=!0,this.toggleHoldExplosion(e,!1),delete this.activeHolds[e]}})}destroy(){this.renderer&&this.renderer.destroy()}}