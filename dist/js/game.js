/**
 * PadManiacs Rhythm Game
 * Copyright (C) RETORA 2025
 * Licensed under the PadManiacs License (see LICENSE file for full terms)
 * 
 * Source: https://github.com/RetoraDev/PadManiacs
 * Version: v0.0.6 dev
 * Build: 11/23/2025, 12:44:32 AM
 * Platform: Development
 * Debug: false
 * Minified: true
 */

const COPYRIGHT="(C) RETORA 2025",VERSION="v0.0.6 dev";window.DEBUG=!1;const FONTS={default:{font:"font_tiny"},tiny:{font:"font_tiny"},shaded:{font:"font_tiny_shaded"},stroke:{font:"font_tiny_stroke",fontWidth:5},number:{font:"font_tiny_number",fontMap:"1234567890 "},combo:{font:"font_combo",fontMap:"0123456789 ",fontWidth:8,fontHeight:8}},WINDOW_PANELS=["1"],DEFAULT_SONG_FOLDERS=["MikiMikiRomanticNight","ThousandCherryBlossoms","UndeadEnemy","Carnival","HatsuneMiku-Melt","KagamineRin-LoveIsWar(R184mmRemix)","KasaneTerritory-KasaneTeto","ANewWorld","39","AsuNoHikari","TheDubstepSoldiersattheFront","JustBeFriends","GentleDespair","Palette","GiganticGirl","melody_2.exe"],JUDGE_WINDOWS={marvelous:33,perfect:45,great:90,good:135,boo:180},SCORE_VALUES={marvelous:1e3,perfect:800,great:500,good:200,boo:50,miss:0},ENVIRONMENT={UNKNOWN:"WEB",NWJS:"NWJS",CORDOVA:"CORDOVA",WEB:"WEB"},CURRENT_ENVIRONMENT=ENVIRONMENT.UNKNOWN,CORDOVA_EXTERNAL_DIRECTORY="PadManiacs/",NWJS_EXTERNAL_DIRECTORY="data/",EXTERNAL_DIRECTORY=CURRENT_ENVIRONMENT==ENVIRONMENT.CORDOVA?"PadManiacs/":"data/",ADDONS_DIRECTORY="Addons",SCREENSHOTS_DIRECTORY="Screenshots",SONGS_DIRECTORY="Songs",ENABLE_PARALLEL_LOADING=!1,MAX_PARALLEL_DOWNLOADS=16,MAX_PARALLEL_ADDON_LOADS=3,ENABLE_ADDON_SAFE_MODE=!0,ENABLE_UI_SFX=!1,ENABLE_EXP_SFX=!0,CHARACTER_SYSTEM={MAX_NAME_LENGTH:6,DEFAULT_CHARACTER:"EIRI",MAX_SKILL_LEVEL:5,EXPERIENCE_CURVE:e=>Math.floor(10*Math.pow(e,1.2)),SKILL_UNLOCK_CHANCE:.5,HAIR_UNLOCK_CHANCE:.4,ITEM_UNLOCK_CHANCE:.3,SKILL_LEVEL_UP_CHANCE:.5,MIN_LEVEL_FOR_SKILL:4,MIN_LEVEL_FOR_HAIR:1,MIN_LEVEL_FOR_ITEM:3,SKILL_COOLDOWN_LEVELS:4,HAIR_COOLDOWN_LEVELS:3,ITEM_COOLDOWN_LEVELS:4,PORTRAIT_CROP:{x:43,y:11,w:15,h:15},CLOSE_SHOT_CROP:{x:32,y:15,w:36,h:7},HAIR_STYLES:{front:["Casual","Smart","Daring","Simple","Bulky","Afro","Emotional","Clean"],back:["Casual","Smart","Curly","Ponytails","Short","Afro","Diva","Clean"]}},DEFAULT_CHARACTER={name:"EIRI",level:1,experience:0,skillLevel:1,unlockedSkills:["focus_boost"],selectedSkill:"focus_boost",appearance:{skinTone:0,hairColor:11038810,frontHair:1,backHair:1,clothing:"school_uniform",accessory:null},stats:{gamesPlayed:0,totalScore:0,maxCombo:0,perfectGames:0,skillsUsed:0},lastSkillLevelUp:0},CHARACTER_SKILLS=[{id:"safety_net",name:"Safety Net",description:"Converts Miss judgments to Boo when activated",activationCondition:"on_miss",effect:"convert_judgement",effectParams:{from:"miss",to:"boo"},duration:0,cooldown:0},{id:"focus_boost",name:"Focus Boost",description:"Temporarily increases accuracy window by 20%",activationCondition:"on_combo",effect:"modify_judgement_window",effectParams:{multiplier:1.2,threshold:50},duration:5e3,cooldown:3e4},{id:"health_regen",name:"Health Regeneration",description:"Regenerates 1 health per second for 10 seconds",activationCondition:"on_low_health",effect:"health_regen",effectParams:{amount:1,interval:1e3,threshold:30},duration:1e4,cooldown:45e3},{id:"max_health_boost",name:"Max Health Boost",description:"Increases maximum health by 25 for 15 seconds",activationCondition:"on_high_combo",effect:"modify_max_health",effectParams:{amount:25,threshold:100},duration:15e3,cooldown:6e4},{id:"time_dilation",name:"Time Dilation",description:"Slows down note speed by 15% for 8 seconds",activationCondition:"on_perfect_streak",effect:"modify_note_speed",effectParams:{multiplier:.85,threshold:10},duration:8e3,cooldown:4e4},{id:"rhythm_echo",name:"Rhythm Echo",description:"Slightly extends hold forgiveness for 12 seconds",activationCondition:"on_combo",effect:"modify_hold_forgiveness",effectParams:{multiplier:1.3,threshold:30},duration:12e3,cooldown:35e3},{id:"combo_shield",name:"Combo Shield",description:"Next miss won't break combo (one-time use)",activationCondition:"on_high_combo",effect:"combo_shield",effectParams:{threshold:75},duration:0,cooldown:6e4},{id:"precision_focus",name:"Precision Focus",description:"Reduces judgement window variation for 10 seconds",activationCondition:"on_perfect_streak",effect:"stabilize_judgement",effectParams:{threshold:8},duration:1e4,cooldown:45e3},{id:"recovery_boost",name:"Recovery Boost",description:"Increases health gain from hits by 50% for 15 seconds",activationCondition:"on_low_health",effect:"modify_health_gain",effectParams:{multiplier:1.5,threshold:40},duration:15e3,cooldown:5e4},{id:"mine_evasion",name:"Mine Evasion",description:"Reduces mine damage by 50% for 20 seconds",activationCondition:"on_mine_hit",effect:"reduce_mine_damage",effectParams:{multiplier:.5},duration:2e4,cooldown:4e4},{id:"momentum_builder",name:"Momentum Builder",description:"Slightly increases score from perfects for 12 seconds",activationCondition:"on_combo",effect:"modify_score_gain",effectParams:{multiplier:1.1,judgement:"perfect",threshold:40},duration:12e3,cooldown:3e4},{id:"grace_period",name:"Grace Period",description:"Extends roll note tapping window for 10 seconds",activationCondition:"on_low_health",effect:"modify_roll_forgiveness",effectParams:{multiplier:1.4,threshold:25},duration:1e4,cooldown:4e4},{id:"steady_hands",name:"Steady Hands",description:"Reduces input lag slightly for 8 seconds",activationCondition:"on_perfect_streak",effect:"modify_input_lag",effectParams:{reduction:.02,threshold:12},duration:8e3,cooldown:35e3},{id:"second_wind",name:"Second Wind",description:"Brief health regeneration when very low health",activationCondition:"on_critical_health",effect:"burst_health_regen",effectParams:{amount:15,threshold:15},duration:0,cooldown:9e4},{id:"flow_state",name:"Flow State",description:"Slightly improves all judgements for a short time",activationCondition:"on_high_combo",effect:"general_boost",effectParams:{windowMultiplier:1.1,healthMultiplier:1.2,threshold:150},duration:6e3,cooldown:6e4},{id:"rapid_recovery",name:"Rapid Recovery",description:"Quick health burst when combo reaches 25",activationCondition:"on_combo",effect:"burst_health_regen",effectParams:{amount:10,threshold:25},duration:0,cooldown:3e4},{id:"precision_flow",name:"Precision Flow",description:"Slightly widens judgement windows at 40 combo",activationCondition:"on_combo",effect:"modify_judgement_window",effectParams:{multiplier:1.15,threshold:40},duration:8e3,cooldown:35e3},{id:"endurance_training",name:"Endurance Training",description:"Increases max health by 15 at 80 combo",activationCondition:"on_high_combo",effect:"modify_max_health",effectParams:{amount:15,threshold:80},duration:12e3,cooldown:45e3},{id:"slow_motion",name:"Slow Motion",description:"Reduces note speed by 10% after 15 perfects",activationCondition:"on_perfect_streak",effect:"modify_note_speed",effectParams:{multiplier:.9,threshold:15},duration:6e3,cooldown:4e4},{id:"safety_cushion",name:"Safety Cushion",description:"Converts two misses to boos when health is low",activationCondition:"on_low_health",effect:"convert_judgement",effectParams:{from:"miss",to:"boo",threshold:25},duration:15e3,cooldown:6e4},{id:"rhythm_mastery",name:"Rhythm Mastery",description:"Extends hold forgiveness by 25% at 60 combo",activationCondition:"on_combo",effect:"modify_hold_forgiveness",effectParams:{multiplier:1.25,threshold:60},duration:1e4,cooldown:3e4},{id:"roll_expert",name:"Roll Expert",description:"Increases roll forgiveness by 35% when health drops",activationCondition:"on_low_health",effect:"modify_roll_forgiveness",effectParams:{multiplier:1.35,threshold:35},duration:12e3,cooldown:4e4},{id:"mine_deflector",name:"Mine Deflector",description:"Reduces mine damage by 75% after hitting a mine",activationCondition:"on_mine_hit",effect:"reduce_mine_damage",effectParams:{multiplier:.25},duration:15e3,cooldown:5e4},{id:"score_amplifier",name:"Score Amplifier",description:"Increases marvelous score by 15% at 100 combo",activationCondition:"on_high_combo",effect:"modify_score_gain",effectParams:{multiplier:1.15,judgement:"marvelous",threshold:100},duration:1e4,cooldown:35e3},{id:"vitality_surge",name:"Vitality Surge",description:"Boosts health gain by 75% when critically low",activationCondition:"on_critical_health",effect:"modify_health_gain",effectParams:{multiplier:1.75,threshold:20},duration:8e3,cooldown:45e3},{id:"combo_anchor",name:"Combo Anchor",description:"Prevents combo break at 50 combo (one-time)",activationCondition:"on_high_combo",effect:"combo_shield",effectParams:{threshold:50},duration:0,cooldown:75e3},{id:"reflex_enhancer",name:"Reflex Enhancer",description:"Reduces input lag after 8 perfects in a row",activationCondition:"on_perfect_streak",effect:"modify_input_lag",effectParams:{reduction:.015,threshold:8},duration:5e3,cooldown:3e4},{id:"graceful_recovery",name:"Graceful Recovery",description:"Converts good to great when missing",activationCondition:"on_miss",effect:"convert_judgement",effectParams:{from:"good",to:"great"},duration:1e4,cooldown:4e4},{id:"momentum_keeper",name:"Momentum Keeper",description:"Regenerates 2 health/sec for 8s at 30 combo",activationCondition:"on_combo",effect:"health_regen",effectParams:{amount:2,interval:1e3,threshold:30},duration:8e3,cooldown:4e4},{id:"precision_boost",name:"Precision Boost",description:"Widens perfect window by 18% after 12 perfects",activationCondition:"on_perfect_streak",effect:"modify_judgement_window",effectParams:{multiplier:1.18,threshold:12},duration:7e3,cooldown:35e3},{id:"health_reserve",name:"Health Reserve",description:"Adds 20 max health when health drops to 40%",activationCondition:"on_low_health",effect:"modify_max_health",effectParams:{amount:20,threshold:40},duration:1e4,cooldown:5e4},{id:"tempo_control",name:"Tempo Control",description:"Slows notes by 12% at 120 combo",activationCondition:"on_high_combo",effect:"modify_note_speed",effectParams:{multiplier:.88,threshold:120},duration:9e3,cooldown:45e3},{id:"hold_stability",name:"Hold Stability",description:"40% longer hold forgiveness when struggling",activationCondition:"on_low_health",effect:"modify_hold_forgiveness",effectParams:{multiplier:1.4,threshold:30},duration:15e3,cooldown:5e4},{id:"rapid_rolls",name:"Rapid Rolls",description:"50% more roll forgiveness at 70 combo",activationCondition:"on_combo",effect:"modify_roll_forgiveness",effectParams:{multiplier:1.5,threshold:70},duration:8e3,cooldown:35e3},{id:"mine_immunity",name:"Mine Immunity",description:"90% mine damage reduction after mine hit",activationCondition:"on_mine_hit",effect:"reduce_mine_damage",effectParams:{multiplier:.1},duration:1e4,cooldown:6e4},{id:"perfect_bonus",name:"Perfect Bonus",description:"20% more score from perfects at 90 combo",activationCondition:"on_high_combo",effect:"modify_score_gain",effectParams:{multiplier:1.2,judgement:"perfect",threshold:90},duration:12e3,cooldown:4e4},{id:"recovery_expert",name:"Recovery Expert",description:"Double health gain when below 25% health",activationCondition:"on_critical_health",effect:"modify_health_gain",effectParams:{multiplier:2,threshold:25},duration:1e4,cooldown:55e3},{id:"unbreakable_chain",name:"Unbreakable Chain",description:"Combo shield activates at 200 combo",activationCondition:"on_high_combo",effect:"combo_shield",effectParams:{threshold:200},duration:0,cooldown:9e4},{id:"lightning_reflexes",name:"Lightning Reflexes",description:"Maximum input lag reduction after 20 perfects",activationCondition:"on_perfect_streak",effect:"modify_input_lag",effectParams:{reduction:.025,threshold:20},duration:6e3,cooldown:4e4},{id:"judgement_boost",name:"Judgement Boost",description:"Multiple improvements at high combo",activationCondition:"on_high_combo",effect:"general_boost",effectParams:{windowMultiplier:1.12,healthMultiplier:1.3,threshold:150},duration:5e3,cooldown:6e4},{id:"emergency_convert",name:"Emergency Convert",description:"Converts boo to good when health critical",activationCondition:"on_critical_health",effect:"convert_judgement",effectParams:{from:"boo",to:"good",threshold:10},duration:12e3,cooldown:7e4},{id:"sustained_rhythm",name:"Sustained Rhythm",description:"Long health regeneration at medium combo",activationCondition:"on_combo",effect:"health_regen",effectParams:{amount:1,interval:800,threshold:45},duration:15e3,cooldown:5e4},{id:"accuracy_focus",name:"Accuracy Focus",description:"Major window increase after perfect streak",activationCondition:"on_perfect_streak",effect:"modify_judgement_window",effectParams:{multiplier:1.25,threshold:18},duration:6e3,cooldown:45e3},{id:"overdrive_health",name:"Overdrive Health",description:"Large max health boost at very high combo",activationCondition:"on_high_combo",effect:"modify_max_health",effectParams:{amount:35,threshold:180},duration:8e3,cooldown:7e4},{id:"time_master",name:"Time Master",description:"Significant note slowdown for skilled play",activationCondition:"on_perfect_streak",effect:"modify_note_speed",effectParams:{multiplier:.8,threshold:25},duration:7e3,cooldown:6e4},{id:"expert_holds",name:"Expert Holds",description:"Maximum hold forgiveness extension",activationCondition:"on_high_combo",effect:"modify_hold_forgiveness",effectParams:{multiplier:1.6,threshold:130},duration:1e4,cooldown:4e4},{id:"master_roller",name:"Master Roller",description:"Extreme roll forgiveness for high combo",activationCondition:"on_high_combo",effect:"modify_roll_forgiveness",effectParams:{multiplier:1.8,threshold:110},duration:9e3,cooldown:45e3},{id:"score_perfection",name:"Score Perfection",description:"Massive score boost for marvelous hits",activationCondition:"on_perfect_streak",effect:"modify_score_gain",effectParams:{multiplier:1.3,judgement:"marvelous",threshold:15},duration:8e3,cooldown:5e4},{id:"ultimate_recovery",name:"Ultimate Recovery",description:"Maximum health gain boost in critical state",activationCondition:"on_critical_health",effect:"modify_health_gain",effectParams:{multiplier:2.5,threshold:15},duration:12e3,cooldown:8e4},{id:"perfect_flow",name:"Perfect Flow",description:"Ultimate general boost for expert players",activationCondition:"on_perfect_streak",effect:"general_boost",effectParams:{windowMultiplier:1.2,healthMultiplier:1.5,threshold:30},duration:4e3,cooldown:75e3},{id:"final_stand",name:"Final Stand",description:"Emergency health burst when near failure",activationCondition:"on_critical_health",effect:"burst_health_regen",effectParams:{amount:25,threshold:5},duration:0,cooldown:12e4},{id:"rhythm_savant",name:"Rhythm Savant",description:"Perfect input timing at extreme combo",activationCondition:"on_high_combo",effect:"modify_input_lag",effectParams:{reduction:.03,threshold:250},duration:5e3,cooldown:9e4}],CHARACTER_ITEMS={clothing:[{id:"school_uniform",name:"School Uniform",type:"clothing"},{id:"teacher_clothing",name:"Teacher Clothing",type:"clothing"},{id:"daring_clothing",name:"Daring",type:"clothing"},{id:"short_dress_red",name:"Short Dress (RED)",type:"clothing"},{id:"short_dress_black",name:"Short Dress (BLACK)",type:"clothing"},{id:"short_dress_orange",name:"Short Dress (ORANGE)",type:"clothing"},{id:"short_dress_blue",name:"Short Dress (BLUE)",type:"clothing"},{id:"dubstep_dress_black",name:"Dubstep Dress (BLACK)",type:"clothing"},{id:"dubstep_dress_blue",name:"Dubstep Dress (BLUE)",type:"clothing"},{id:"pinkachu",name:"Pinkachu :D",hideCharacter:!0,type:"clothing"},{id:"lencery",name:"Lencery (Remove this! For the love of god!)",type:"clothing"}],accessories:[{id:"headphones",name:"Headphones",type:"accessory"},{id:"hair_ties_red",name:"Hair Ties (RED)",type:"accessory"},{id:"hair_ties_black",name:"Hair Ties (BLACK)",type:"accessory"},{id:"hair_ties_orange",name:"Hair Ties (ORANGE)",type:"accessory"},{id:"hair_ties_blue",name:"Hair Ties (BLUE)",type:"accessory"}]},DEFAULT_ACCOUNT={settings:{volume:3,autoplay:!1,enableMenuMusic:!0,randomSong:!1,renderer:0,pixelated:!0,noteColorOption:"NOTE",noteSpeedMult:1,userOffset:0,scrollDirection:"falling",visualizer:"BPM",metronome:"OFF",beatLines:!1,beatsPerMeasure:4,speedMod:"X-MOD",safeMode:!1,enabledAddons:[],hibernatingAddons:[]},characters:{unlockedHairs:{front:[1],back:[1]},unlockedItems:["school_uniform"],currentCharacter:DEFAULT_CHARACTER.name,list:[JSON.parse(JSON.stringify(DEFAULT_CHARACTER))]},lastSong:null,highScores:{}};class Character{constructor(e){this.name=e.name,this.level=e.level||1,this.experience=e.experience||0,this.skillLevel=e.skillLevel||1,this.unlockedSkills=e.unlockedSkills||[],this.selectedSkill=e.selectedSkill||null,this.appearance=e.appearance||{skinTone:0,hairColor:16777215,frontHair:"1",backHair:"1",clothing:"school_uniform",accessory:"headphones"},this.stats=e.stats||{gamesPlayed:0,totalScore:0,maxCombo:0,perfectGames:0,skillsUsed:0},this.experienceStory=[],this.lastSkillLevelUp=e.lastSkillLevelUp||0,this.lastHairUnlockLevel=e.lastHairUnlockLevel||0,this.lastItemUnlockLevel=e.lastItemUnlockLevel||0}addExperience(e){const t={levelBefore:this.level,expBefore:this.experience,expGain:e};this.experience+=e;const s=CHARACTER_SYSTEM.EXPERIENCE_CURVE(this.level);for(;this.experience>=s;)this.levelUp(),this.experience-=s;t.expAfter=this.experience,t.levelAfter=this.level,this.experienceStory.push(t)}levelUp(){if(this.level++,Math.random()<CHARACTER_SYSTEM.SKILL_UNLOCK_CHANCE&&this.level>=CHARACTER_SYSTEM.MIN_LEVEL_FOR_SKILL){const e=this.unlockRandomSkill();e&&notifications.show(`New skill unlocked: ${e.name}`)}if(this.level>=CHARACTER_SYSTEM.MIN_LEVEL_FOR_HAIR&&this.level-this.lastHairUnlockLevel>=CHARACTER_SYSTEM.HAIR_COOLDOWN_LEVELS&&Math.random()<CHARACTER_SYSTEM.HAIR_UNLOCK_CHANCE){const e=this.unlockRandomHairStyle();e&&(this.lastHairUnlockLevel=this.level,notifications.show(`New hair style unlocked: ${e.type} ${e.id}`))}if(this.level>=CHARACTER_SYSTEM.MIN_LEVEL_FOR_ITEM&&this.level-this.lastItemUnlockLevel>=CHARACTER_SYSTEM.ITEM_COOLDOWN_LEVELS&&Math.random()<CHARACTER_SYSTEM.ITEM_UNLOCK_CHANCE){const e=this.unlockRandomItem();e&&(this.lastItemUnlockLevel=this.level,notifications.show(`New item unlocked: ${e.name}`))}this.level-this.lastSkillLevelUp>=CHARACTER_SYSTEM.SKILL_COOLDOWN_LEVELS&&Math.random()<CHARACTER_SYSTEM.SKILL_LEVEL_UP_CHANCE&&this.skillLevel<CHARACTER_SYSTEM.MAX_SKILL_LEVEL&&(this.skillLevel++,this.lastSkillLevelUp=this.level,notifications.show(`Skill level increased to ${this.skillLevel}`))}unlockRandomSkill(){const e=CHARACTER_SKILLS.filter(e=>!this.unlockedSkills.includes(e.id));if(e.length>0){const t=e[Math.floor(Math.random()*e.length)];return this.unlockedSkills.push(t.id),t}return null}unlockRandomHairStyle(){const e=[],t=[];for(let t=1;t<=CHARACTER_SYSTEM.HAIR_STYLES.front;t++)Account.characters.unlockedHairs.front.includes(t)||e.push(t);for(let e=1;e<=CHARACTER_SYSTEM.HAIR_STYLES.back;e++)Account.characters.unlockedHairs.back.includes(e)||t.push(e);const s=Math.random()<.5?"front":"back",i="front"===s?e:t;if(i.length>0){const e=i[Math.floor(Math.random()*i.length)];return Account.characters.unlockedHairs[s].push(e),localStorage.setItem("Account",JSON.stringify(Account)),{type:s,id:e}}return null}unlockRandomItem(){const e=[...CHARACTER_ITEMS.clothing,...CHARACTER_ITEMS.accessories].filter(e=>!Account.characters.unlockedItems.includes(e.id));if(e.length>0){const t=e[Math.floor(Math.random()*e.length)];return Account.characters.unlockedItems.push(t.id),localStorage.setItem("Account",JSON.stringify(Account)),t}return null}getAvailableHairStyles(){return{front:Account.characters.unlockedHairs.front,back:Account.characters.unlockedHairs.back}}getAvailableItems(){return Account.characters.unlockedItems}changeHairStyle(e,t){return"front"===e&&Account.characters.unlockedHairs.front.includes(t)?(this.appearance.frontHair=t,!0):!("back"!==e||!Account.characters.unlockedHairs.back.includes(t))&&(this.appearance.backHair=t,!0)}changeClothing(e){if(Account.characters.unlockedItems.includes(e)){const t=CHARACTER_ITEMS.clothing.find(t=>t.id===e)||CHARACTER_ITEMS.accessories.find(t=>t.id===e);if(t)return"clothing"===t.type?this.appearance.clothing=e:"accessory"===t.type&&(this.appearance.accessory=e),!0}return!1}getRequiredExperience(){return CHARACTER_SYSTEM.EXPERIENCE_CURVE(this.level)}getExperienceProgress(){const e=this.getRequiredExperience();return this.experience/e}canUseSkill(){return this.skillLevel>0&&this.unlockedSkills.length>0}toJSON(){return{name:this.name,level:this.level,experience:this.experience,skillLevel:this.skillLevel,unlockedSkills:this.unlockedSkills,selectedSkill:this.selectedSkill,appearance:this.appearance,stats:this.stats,lastSkillLevelUp:this.lastSkillLevelUp,lastHairUnlockLevel:this.lastHairUnlockLevel,lastItemUnlockLevel:this.lastItemUnlockLevel}}}class CharacterDisplay extends Phaser.Sprite{constructor(e,t,s){super(game,e,t),this.character=s,this.layers={},s&&this.createLayers(),game.add.existing(this)}createLayers(){this.layers.backHair=game.add.sprite(0,0,`character_back_hair_${this.character.appearance.backHair}`),this.layers.backHair.tint=this.character.appearance.hairColor,this.addChild(this.layers.backHair),this.layers.base=game.add.sprite(0,0,"character_base",this.character.appearance.skinTone),this.addChild(this.layers.base),this.layers.frontHair=game.add.sprite(0,0,`character_front_hair_${this.character.appearance.frontHair}`),this.layers.frontHair.tint=this.character.appearance.hairColor,this.addChild(this.layers.frontHair),this.layers.eyes=game.add.sprite(0,0,"character_eyes",0),this.addChild(this.layers.eyes),this.setupBlinking(),this.layers.clothing=game.add.sprite(0,0,`character_clothing_${this.character.appearance.clothing}`),this.addChild(this.layers.clothing),this.character.appearance.accessory&&(this.layers.accessory=game.add.sprite(0,0,`character_accessory_${this.character.appearance.accessory}`),this.addChild(this.layers.accessory)),this.setClothingVisibility()}setClothingVisibility(){const e=!CHARACTER_ITEMS.clothing.find(e=>e.id===this.character.appearance.clothing).hideCharacter;this.layers.backHair.visible=e,this.layers.base.visible=e,this.layers.frontHair.visible=e,this.layers.eyes.visible=e,this.layers.frontHair.visible=e,this.layers.accessory&&(this.layers.accessory.visible=e)}setupBlinking(){this.layers.eyes.animations.add("blink",[0,1,2,3,2,1,0],16,!1),this.startBlinking()}startBlinking(){const e=game.rnd.between(500,5e3);this.blink(e,()=>{this.startBlinking()})}blink(e,t){game.time.events.add(e,()=>{this.layers.eyes&&(this.layers.eyes.animations.play("blink"),this.layers.eyes.animations.currentAnim.onComplete.addOnce(()=>t?.()))})}updateAppearance(e){this.character.appearance={...this.character.appearance,...e},this.layers.backHair&&(this.layers.backHair.tint=this.character.appearance.hairColor,e.backHair&&this.layers.backHair.loadTexture(`character_back_hair_${e.backHair}`)),this.layers.frontHair&&(this.layers.frontHair.tint=this.character.appearance.hairColor,e.frontHair&&this.layers.frontHair.loadTexture(`character_front_hair_${e.frontHair}`)),this.layers.base&&void 0!==e.skinTone&&(this.layers.base.frame=this.character.appearance.skinTone),this.layers.clothing&&e.clothing&&this.layers.clothing.loadTexture(`character_clothing_${e.clothing}`),void 0!==e.accessory&&(this.layers.accessory&&this.layers.accessory.destroy(),e.accessory&&(this.layers.accessory=game.add.sprite(0,0,`character_accessory_${e.accessory}`),this.addChild(this.layers.accessory))),this.setClothingVisibility()}destroy(){Object.values(this.layers).forEach(e=>{e&&e.destroy&&e.destroy()}),this.layers={},super.destroy()}}class CharacterCroppedDisplay extends CharacterDisplay{constructor(e,t,s,i){super(0,0,s),this.cropArea=i,this.cropSprite(),this.x=e,this.y=t}cropSprite(){Object.values(this.layers).forEach(e=>{e&&e.crop(new Phaser.Rectangle(this.cropArea.x,this.cropArea.y,this.cropArea.w,this.cropArea.h))})}updateAppearance(e){super.updateAppearance(e),this.cropSprite()}}class CharacterPortrait extends CharacterCroppedDisplay{constructor(e,t,s){super(e,t,s,CHARACTER_SYSTEM.PORTRAIT_CROP)}}class CharacterCloseShot extends CharacterCroppedDisplay{constructor(e,t,s){super(e,t,s,CHARACTER_SYSTEM.CLOSE_SHOT_CROP)}}class CharacterManager{constructor(){this.characters=new Map,this.currentCharacter=null,this.loadFromAccount()}loadFromAccount(){Account.characters||(Account.characters=JSON.parse(JSON.stringify(DEFAULT_ACCOUNT.characters))),Account.characters.list.forEach(e=>{const t=new Character(e);this.characters.set(t.name,t)}),Account.characters.currentCharacter?this.currentCharacter=this.characters.get(Account.characters.currentCharacter)||this.characters.values().next().value:this.currentCharacter=null}createCharacter(e,t={}){if(this.characters.has(e)||e.length>CHARACTER_SYSTEM.MAX_NAME_LENGTH)return null;const s=new Character({name:e,appearance:{skinTone:t.skinTone||0,hairColor:t.hairColor||16777215,frontHair:t.frontHair||"1",backHair:t.backHair||"1",clothing:t.clothing||"school_uniform",accessory:t.accessory||null}});return this.characters.set(e,s),Account.characters.list.push(s.toJSON()),saveAccount(),s}deleteCharacter(e){this.characters.size<=1&&this.unsetCharacter;const t=this.characters.delete(e);return t&&(Account.characters.list=Account.characters.list.filter(t=>t.name!==e),Account.characters.currentCharacter===e&&(Account.characters.currentCharacter=this.characters.keys().next().value,this.currentCharacter=this.characters.get(Account.characters.currentCharacter)),saveAccount()),t}unsetCharacter(){this.currentCharacter=null,Account.characters.currentCharacter=null,saveAccount()}setCurrentCharacter(e){const t=this.characters.get(e);return!!t&&(this.currentCharacter=t,Account.characters.currentCharacter=e,saveAccount(),!0)}updateCharacterStats(e){if(!this.currentCharacter)return 0;const t=this.currentCharacter;t.stats.gamesPlayed++,t.stats.totalScore+=e.score,t.stats.maxCombo=Math.max(t.stats.maxCombo,e.maxCombo),e.accuracy>=100&&t.stats.perfectGames++,t.stats.skillsUsed+=e.skillsUsed||0;const s=this.calculateExperienceGain(e);t.addExperience(s);const i=Account.characters.list.find(e=>e.name===t.name);return i&&Object.assign(i,t.toJSON()),saveAccount(),s}calculateExperienceGain(e){let t=0;const s=Object.values(e.judgements).reduce((e,t)=>e+t,0);if(s<25)return 0;if(e.accuracy<50)return 0;if(e.accuracy>=70&&(t+=2),e.accuracy>=100?t+=8:e.accuracy>=99?t+=6:e.accuracy>=97?t+=5:e.accuracy>=95?t+=4:e.accuracy>=90?t+=3:e.accuracy>=85?t+=2:e.accuracy>=80&&(t+=1),e.maxCombo>=1e3?t+=8:e.maxCombo>=500?t+=6:e.maxCombo>=250?t+=4:e.maxCombo>=100?t+=3:e.maxCombo>=50&&(t+=2),e.maxCombo>0&&0===e.judgements.miss){t+=8;(e.judgements.marvelous||0)+(e.judgements.perfect||0)===s&&(t+=4)}if(s>0){const i=(e.judgements.marvelous||0)/s,a=(e.judgements.perfect||0)/s;i>=.8?t+=3:(i>=.6||a>=.9)&&(t+=2)}return e.difficultyRating&&(e.difficultyRating>=15?t+=3:e.difficultyRating>=12?t+=2:e.difficultyRating>=9&&(t+=1)),e.skillsUsed>0&&(t+=Math.min(2,e.skillsUsed)),t}unlockHair(e,t){return!Account.characters.unlockedHairs[e].includes(t)&&(Account.characters.unlockedHairs[e].push(t),saveAccount(),!0)}unlockItem(e){return!Account.characters.unlockedItems.includes(e)&&(Account.characters.unlockedItems.push(e),saveAccount(),!0)}getCharacterList(){return Array.from(this.characters.values())}getCurrentCharacter(){return this.currentCharacter}saveToAccount(){Account.characters.list=this.getCharacterList().map(e=>e.toJSON()),Account.characters.currentCharacter=this.currentCharacter?this.currentCharacter.name:null,console.log(Account.characters),saveAccount()}}class CharacterSkillSystem{constructor(e,t){this.scene=e,this.character=t||e.character,this.activeSkills=new Map,this.skillCooldowns=new Map,this.skillsUsedThisGame=0,this.skillEffects={judgementConversion:null,judgementWindowMultiplier:1,healthRegen:null,maxHealthBonus:0,noteSpeedMultiplier:1,holdForgivenessMultiplier:1,rollForgivenessMultiplier:1,mineDamageMultiplier:1,scoreMultipliers:{},healthGainMultiplier:1,comboShield:!1,inputLagReduction:0}}checkSkillActivation(e,t={}){if(!this.character||this.exhausted)return;const s=this.character.unlockedSkills.map(e=>CHARACTER_SKILLS.find(t=>t.id===e)).find(e=>e.id===this.character.selectedSkill);s&&s.activationCondition===e&&this.canActivateSkill(s,t)&&(this.activateSkill(s,t),this.skillsUsedThisGame++)}canActivateSkill(e,t){if(this.exhausted)return!1;if(this.skillCooldowns.has(e.id))return!1;if(this.scene.autoPlay)return!1;switch(e.activationCondition){case"on_miss":return"miss"===t.judgement;case"on_combo":return t.combo>=(e.effectParams.threshold||50);case"on_low_health":return t.health<=(e.effectParams.threshold||30);case"on_high_combo":return t.combo>=(e.effectParams.threshold||100);case"on_perfect_streak":return t.perfectStreak>=(e.effectParams.threshold||10);case"on_mine_hit":default:return!0;case"on_critical_health":return t.health<=(e.effectParams.threshold||15);case"custom":return!!e.activationCheckFunction&&e.activationCheckFunction()}}activateSkill(e,t){this.applySkillEffect(e),e.cooldown>0&&(this.skillCooldowns.set(e.id,game.time.now+e.cooldown),game.time.events.add(e.cooldown,()=>{this.skillCooldowns.delete(e.id)})),this.scene?.showCharacterCloseShot(e.duration||1800),e.duration>0&&(this.activeSkills.set(e.id,{skill:e,startTime:game.time.now,endTime:game.time.now+e.duration}),game.time.events.add(e.duration,()=>{this.deactivateSkill(e.id)})),this.notifySkillUsed(e)}notifySkillUsed(e){const t="rgba(44, 90, 198, 0.6)",s=game.add.bitmapData(40,8),i=s.context.createLinearGradient(40,0,0,0);i.addColorStop(0,t),i.addColorStop(.7,t),i.addColorStop(1,"transparent"),s.context.fillStyle=i,s.context.fillRect(0,0,40,8);const a=game.add.sprite(-40,32,s);a.alpha=0;new Text(4,1,e.name,FONTS.default,a);game.add.tween(a).to({alpha:1,x:4},350,Phaser.Easing.Quadratic.Out,!0).yoyo(!0).yoyoDelay(1e3)}applySkillEffect(e){switch(e.effect){case"convert_judgement":this.skillEffects.judgementConversion=e.effectParams;break;case"modify_judgement_window":this.skillEffects.judgementWindowMultiplier=e.effectParams.multiplier;break;case"health_regen":this.startHealthRegen(e.effectParams);break;case"modify_max_health":this.skillEffects.maxHealthBonus=e.effectParams.amount;break;case"modify_note_speed":this.skillEffects.noteSpeedMultiplier=e.effectParams.multiplier,this.scene.showGlitchAnimation(100);break;case"modify_hold_forgiveness":this.skillEffects.holdForgivenessMultiplier=e.effectParams.multiplier;break;case"modify_roll_forgiveness":this.skillEffects.rollForgivenessMultiplier=e.effectParams.multiplier;break;case"reduce_mine_damage":this.skillEffects.mineDamageMultiplier=e.effectParams.multiplier;break;case"modify_score_gain":this.skillEffects.scoreMultipliers[e.effectParams.judgement]=e.effectParams.multiplier;break;case"modify_health_gain":this.skillEffects.healthGainMultiplier=e.effectParams.multiplier;break;case"combo_shield":this.skillEffects.comboShield=!0,this.onComboShield&&this.onComboShield();break;case"modify_input_lag":this.skillEffects.inputLagReduction=e.effectParams.reduction;break;case"burst_health_regen":this.onHealthRegen&&this.onHealthRegen(e.effectParams.amount);break;case"stabilize_judgement":break;case"general_boost":this.skillEffects.judgementWindowMultiplier=e.effectParams.windowMultiplier,this.skillEffects.healthGainMultiplier=e.effectParams.healthMultiplier}}deactivateSkill(e){const t=this.activeSkills.get(e);if(!t)return;const s=t.skill;switch(s.effect){case"convert_judgement":this.skillEffects.judgementConversion=null;break;case"modify_judgement_window":this.skillEffects.judgementWindowMultiplier=1;break;case"health_regen":this.stopHealthRegen();break;case"modify_max_health":this.skillEffects.maxHealthBonus=0;break;case"modify_note_speed":this.skillEffects.noteSpeedMultiplier=1,this.scene.showGlitchAnimation(100);break;case"modify_hold_forgiveness":this.skillEffects.holdForgivenessMultiplier=1;break;case"modify_roll_forgiveness":this.skillEffects.rollForgivenessMultiplier=1;break;case"reduce_mine_damage":this.skillEffects.mineDamageMultiplier=1;break;case"modify_score_gain":delete this.skillEffects.scoreMultipliers[s.effectParams.judgement];break;case"modify_health_gain":this.skillEffects.healthGainMultiplier=1;break;case"combo_shield":this.skillEffects.comboShield=!1;break;case"modify_input_lag":this.skillEffects.inputLagReduction=0;break;case"general_boost":this.skillEffects.judgementWindowMultiplier=1,this.skillEffects.healthGainMultiplier=1}this.activeSkills.delete(e)}startHealthRegen(e){this.stopHealthRegen(),this.healthRegenTimer=game.time.events.loop(e.interval,()=>{this.onHealthRegen&&this.onHealthRegen(e.amount)})}stopHealthRegen(){this.healthRegenTimer&&(game.time.events.remove(this.healthRegenTimer),this.healthRegenTimer=null)}getJudgementConversion(){return this.exhausted?null:this.skillEffects.judgementConversion}getJudgementWindowMultiplier(){return this.skillEffects.judgementWindowMultiplier}getMaxHealthBonus(){return this.skillEffects.maxHealthBonus}getNoteSpeedMultiplier(){return this.skillEffects.noteSpeedMultiplier}getHoldForgivenessMultiplier(){return this.skillEffects.holdForgivenessMultiplier}getRollForgivenessMultiplier(){return this.skillEffects.rollForgivenessMultiplier}getMineDamageMultiplier(){return this.skillEffects.mineDamageMultiplier}getScoreMultiplier(e){return this.skillEffects.scoreMultipliers[e]||1}getHealthGainMultiplier(){return this.skillEffects.healthGainMultiplier}getInputLagReduction(){return this.skillEffects.inputLagReduction}update(){const e=game.time.now;if(this.character){this.exhausted=this.skillsUsedThisGame>=this.character.skillLevel;for(const[t,s]of this.activeSkills)e>=s.endTime&&this.deactivateSkill(t);for(const[t,s]of this.skillCooldowns)e>=s&&this.skillCooldowns.delete(t);this.scene.skillBar.value=5-(5-this.character.skillLevel)-this.getSkillsUsed(),this.scene.skillBar.visibleParts=this.character.skillLevel,this.scene.skillBar.update()}}resetGame(){for(const e of this.activeSkills.keys())this.deactivateSkill(e);this.activeSkills.clear(),this.skillCooldowns.clear(),this.skillsUsedThisGame=0,this.skillEffects={judgementConversion:null,judgementWindowMultiplier:1,healthRegen:null,maxHealthBonus:0,noteSpeedMultiplier:1,holdForgivenessMultiplier:1,rollForgivenessMultiplier:1,mineDamageMultiplier:1,scoreMultipliers:{},healthGainMultiplier:1,comboShield:!1,inputLagReduction:0},this.stopHealthRegen()}getSkillsUsed(){return this.skillsUsedThisGame}}class Text extends Phaser.Sprite{constructor(e,t,s="",i,a){i={font:"font_tiny",fontMap:" ABCDEFGHIJKLMNOPQRSTUVWXYZ.,:!¡?¿h+-×*()[]/\\0123456789_'\"`•<>=%",fontWidth:4,fontHeight:6,typewriter:!1,typewriterInterval:100,...i},super(game,e,t),this.config=i,this.texture=new Phaser.RetroFont(game,i.font,i.fontWidth,i.fontHeight,i.fontMap),this.texture.multiLine=!0,this.texture.autoUpperCase=!0,this.timer=game.time.create(!1),this.typewriterInterval=i.typewriterInterval,i.typewriter?this.typewriter(s):this.write(s),game.add.existing(this),a&&(a instanceof Phaser.Group?a.add(this):a instanceof PIXI.DisplayObjectContainer&&a.addChild(this))}write(e,t){return t&&e.length>t?this.scrollwrite(e,t):(this.timer.running&&this.timer.stop(),this.texture.text=e),this}typewrite(e,t){this.timer.running&&this.timer.stop();let s=0;return this.texture.text="",this.timer.loop(this.typewriterInterval,()=>{s<e.length?(this.write(this.texture.text+e[s]),s++):(t&&t(),this.timer.stop())}),this.timer.start(),this}scrollwrite(e,t=5,s=200,i=5){this.timer.running&&this.timer.stop();const a=e+" ".repeat(i);let n=0,r=!0;const o=()=>{if(!this.visible||!r)return;let e="";for(let s=0;s<t;s++){e+=a[(n+s)%a.length]}this.texture.text=e,n=(n+1)%a.length};return this.timer.loop(s,()=>o()),o(),this.timer.start(),{stop:()=>{r=!1,this.timer.stop()},pause:()=>{r=!1},resume:()=>{r=!0},setSpeed:e=>{s=e,this.timer.loopDelay=e}}}stopScrolling(){this.timer.running&&this.timer.stop()}isScrolling(){return this.timer.running}wrap(e,t=1){if(!this.texture.text)return this;const s=this.texture.text,i=this.config.fontWidth||4,a=Math.floor(e/i);if(a<=0)return this;const n=s.split(" "),r=[];let o="";for(let e=0;e<n.length;e++){const t=n[e],s=o?`${o} ${t}`:t;if(t.length>a){o&&(r.push(o),o="");let e="";for(let s=0;s<t.length;s++)e+=t[s],(e.length>=a||s===t.length-1)&&(r.push(e),e="");continue}s.length<=a?o=s:(r.push(o),o=t)}o&&r.push(o);const h=r.join("\n");return this.write(h),this}wrapPreserveNewlines(e,t=1){if(!this.texture.text)return this;const s=this.texture.text,i=this.config.fontWidth||4,a=Math.floor(e/i);if(a<=0)return this;const n=s.split("\n"),r=[];for(const e of n){if(e.length<=a){r.push(e);continue}const t=e.split(" ");let s="";for(let e=0;e<t.length;e++){const i=t[e];if(i.length>a){s&&(r.push(s),s="");let e="";for(let t=0;t<i.length;t++)e+=i[t],(e.length>=a||t===i.length-1)&&(r.push(e),e="");continue}const n=s?`${s} ${i}`:i;n.length<=a?s=n:(s&&r.push(s),s=i)}s&&r.push(s)}const o=r.join("\n");return this.write(o),this}getWrappedText(e){if(!this.texture.text)return"";const t=this.texture.text,s=this.config.fontWidth||4,i=Math.floor(e/s);if(i<=0)return t;const a=t.split(" "),n=[];let r="";for(let e=0;e<a.length;e++){const t=a[e];if(t.length>i){r&&(n.push(r),r="");let e="";for(let s=0;s<t.length;s++)e+=t[s],(e.length>=i||s===t.length-1)&&(n.push(e),e="");continue}const s=r?`${r} ${t}`:t;s.length<=i?r=s:(n.push(r),r=t)}return r&&n.push(r),n.join("\n")}}class Window extends Phaser.Sprite{constructor(e,t,s,i,a="1",n=null){super(game,8*e,8*t),this.size={width:s,height:i},this.offset={x:0,y:0},this.scrollOffset=0,this.itemOffset=1,this.visibleItems=i,this.selectedIndex=0,this.focus=!1,this.skin=a,this.font="default",this.fontTint=7797982,this.disableScrollBar=!1,n?n.addChild(this):game.add.existing(this),this.createWindowFrame(),this.selector=game.add.sprite(3,0,`ui_window_${a}`,9),this.selector.visible=!1,this.selector.animations.add("blink",[9,10],4,!0),this.selector.animations.play("blink"),this.addChild(this.selector),this.scrollBar=game.add.graphics(8*this.size.width-3,8),this.scrollBar.alpha=0,this.addChild(this.scrollBar),this.scrollBarTween=null,this.onSelect=new Phaser.Signal,this.onConfirm=new Phaser.Signal,this.onCancel=new Phaser.Signal,this.items=[],this.updateSelector()}createWindowFrame(){this.frameParts=[];for(let e=0;e<this.size.height;e++)for(let t=0;t<this.size.width;t++){let s=4;s=0===e?0===t?0:t>=this.size.width-1?2:1:e===this.size.height-1?0===t?6:t>=this.size.width-1?8:7:0===t?3:t>=this.size.width-1?5:4;const i=game.add.sprite(8*t,8*e,`ui_window_${this.skin}`,s);this.addChild(i),this.frameParts.push(i)}}addItem(e,t,s=null,i=!1){const a=new Text(8+this.offset.x,0,e,{...FONTS[this.font],tint:this.fontTint});this.addChild(a);const n=new Text(8*this.size.width-8-4,0,t,{...FONTS[this.font],tint:this.fontTint});n.anchor.x=1,a.addChild(n);const r={text:a,valueText:n,callback:s,backButton:i,type:"item",visible:!0,setText:e=>{a.write(e)},setValueText:e=>{n.write(e)}};return this.items.push(r),r}addSettingItem(e,t,s,i=null){const a=new Text(8+this.offset.x,0,e,{...FONTS[this.font],tint:this.fontTint});this.addChild(a),t=t.map(e=>Window.processMultilingual(e));const n=new Text(8*this.size.width-8-4,0,t[s].toString(),{...FONTS[this.font],tint:this.fontTint});n.anchor.x=1,a.addChild(n);const r={text:a,valueText:n,options:t,currentIndex:s,callback:i,type:"setting",visible:!0};return this.items.push(r),this.update(),r}static processMultilingual(e){if("string"!=typeof e)return e;return e=(e=e.replace(/([^|(]+\|\|[^|)]+)/g,e=>{const t=e.split("||");return t[SETTINGS.language]||t[0]})).replace(/\(([^)|]+)\|([^)]+)\)/g,(e,t,s)=>0===SETTINGS.language?t:s)}getVisibleHeight(e=0){return 8*this.size.height-(10+this.offset.y)}update(){const e=this.getVisibleHeight();this.visibleItems=Math.floor(e/8),this.visibleItems=Math.min(this.visibleItems,this.items.length),this.scrollOffset=Math.max(0,Math.min(this.scrollOffset,this.items.length-this.visibleItems));const t=8*this.visibleItems,s=(8*this.size.height-t)/2;this.items.forEach((e,t)=>{const i=t>=this.scrollOffset&&t<this.scrollOffset+this.visibleItems;if(e.text.visible=i,e.visible=i,e.text.tint=this.fontTint,e.valueText&&(e.valueText.tint=this.fontTint),i){const i=t-this.scrollOffset,a=s+8*i;e.text.y=a+this.offset.y}}),this.updateSelector()}updateSelector(){if(this.focus&&this.items.length>0&&this.selectedIndex>=this.scrollOffset&&this.selectedIndex<this.scrollOffset+this.visibleItems){const e=8*this.visibleItems,t=(8*this.size.height-e)/2+8*(this.selectedIndex-this.scrollOffset)+this.offset.y;this.selector.y=t,this.selector.visible=!0}else this.selector.visible=!1}updateScrollBar(){if(this.disableScrollBar)return;if(this.scrollBar.clear(),this.items.length<=this.visibleItems)return void this.hideScrollBar();const e=8*(this.size.height-2),t=this.items.length,s=Math.max(8,this.visibleItems/t*e),i=t-this.visibleItems,a=this.scrollOffset/i*(e-s);this.scrollBar.beginFill(this.fontTint,.8),this.scrollBar.drawRect(0,a,1,s),this.scrollBar.endFill(),this.showScrollBar()}showScrollBar(){this.scrollBarTween&&this.scrollBarTween.stop(),this.scrollBar.alpha=1,this.scrollBarTween=game.add.tween(this.scrollBar),this.scrollBarTween.to({alpha:0},1e3,Phaser.Easing.Quadratic.Out,!0,500).onComplete.add(()=>{this.scrollBarTween=null})}hideScrollBar(){this.scrollBarTween&&(this.scrollBarTween.stop(),this.scrollBarTween=null),this.scrollBar.alpha=0,this.scrollBar.clear()}adjustScroll(){this.selectedIndex<this.scrollOffset?this.scrollOffset=this.selectedIndex:this.selectedIndex>=this.scrollOffset+this.visibleItems&&(this.scrollOffset=this.selectedIndex-this.visibleItems+1)}navigate(e){if(0===this.items.length)return;let t=this.selectedIndex;switch(e){case"up":t=Math.max(0,this.selectedIndex-1);break;case"down":t=Math.min(this.items.length-1,this.selectedIndex+1);break;case"left":return void this.handleLeft();case"right":return void this.handleRight()}this.onSelect.dispatch(t,e),t!==this.selectedIndex&&(this.selectedIndex=t,this.adjustScroll(),this.updateScrollBar(),this.playNavSound())}handleLeft(){const e=this.items[this.selectedIndex];e&&("setting"===e.type?(e.currentIndex=(e.currentIndex-1+e.options.length)%e.options.length,e.valueText.write(e.options[e.currentIndex].toString()),e.callback&&e.callback(e.currentIndex,e.options[e.currentIndex]),this.playNavSound()):"toggle"===e.type&&(e.state=!e.state,e.toggleSwitch.animations.play(e.state?"on":"off"),e.callback&&e.callback(e.state),this.playNavSound()))}handleRight(){const e=this.items[this.selectedIndex];e&&("setting"===e.type?(e.currentIndex=(e.currentIndex+1)%e.options.length,e.valueText.write(e.options[e.currentIndex].toString()),e.callback&&e.callback(e.currentIndex,e.options[e.currentIndex]),this.playNavSound()):"toggle"===e.type&&(e.state=!e.state,e.toggleSwitch.animations.play(e.state?"on":"off"),e.callback&&e.callback(e.state),this.playNavSound()))}playNavSound(){}confirm(){if(this.items.length>0){const e=this.items[this.selectedIndex];return"item"===e.type?e.callback&&e.callback(this.items[this.selectedIndex]):this.handleRight(),!0}return this.onConfirm.dispatch(this.selectedIndex,this.items[this.selectedIndex]),!1}cancel(){this.items.forEach(e=>{e.backButton&&e.callback()}),this.onCancel.dispatch(this.selectedIndex)}clear(){this.items.forEach(e=>{e.text.destroy(),e.valueText&&e.valueText.destroy(),e.toggleText&&e.toggleText.destroy()}),this.scrollBarTween&&(this.scrollBarTween.stop(),this.scrollBarTween=null),this.frameParts.forEach(e=>e.destroy()),this.items=[],this.frameParts=[],this.selectedIndex=0,this.scrollOffset=0}show(){this.visible=!0}hide(){this.visible=!1}destroy(){this.clear(),super.destroy()}}class WindowManager{constructor(){this.windows=[],this.focusedWindow=null,this.lastUp=!1,this.lastDown=!1,this.lastConfirm=!1,this.lastCancel=!1}add(e){return this.windows.includes(e)||(this.windows.push(e),e.selector.visible=!1,1===this.windows.length&&this.focus(e)),e}show(e){e.show()}remove(e,t=!0){const s=this.windows.indexOf(e);return-1!==s&&(e===this.focusedWindow?(this.windows.splice(s,1),this.focusedWindow=this.windows.length>0?this.windows[this.windows.length-1]:null,this.focusedWindow&&(this.focusedWindow.selector.visible=!0)):this.windows.splice(s,1),t&&e.destroy(),!0)}focus(e,t=!0){return!(!e||!this.windows.includes(e))&&(this.focusedWindow&&(this.focusedWindow.focus=!1,t&&(this.focusedWindow.visible=!1),this.focusedWindow.selector.visible=!1),this.focusedWindow=e,e.focus=!0,e.selector.visible=!0,e.show(),!0)}unfocus(){this.focusedWindow=null}closeAll(){this.focusedWindow&&(this.focusedWindow.focus=!1,this.focusedWindow=null),this.windows.forEach(e=>e.hide())}update(){if(this.focusedWindow){const e=gamepad.pressed.up&&!this.lastUp,t=gamepad.pressed.down&&!this.lastDown,s=gamepad.pressed.left&&!this.lastDown,i=gamepad.pressed.right&&!this.lastDown,a=gamepad.pressed.a&&!this.lastConfirm,n=gamepad.pressed.b&&!this.lastCancel;e?this.focusedWindow.navigate("up"):t?this.focusedWindow.navigate("down"):s?this.focusedWindow.navigate("left"):i&&this.focusedWindow.navigate("right"),a&&this.focusedWindow.confirm(),n&&this.focusedWindow.cancel(),this.lastUp=gamepad.pressed.up,this.lastDown=gamepad.pressed.down,this.lastConfirm=gamepad.pressed.a,this.lastCancel=gamepad.pressed.b}}createWindow(e,t,s,i,a="1",n=null){const r=new Window(e,t,s,i,a,n);return this.add(r),r}clearAll(e=!1){e&&this.windows.forEach(e=>e.destroy()),this.windows=[],this.focusedWindow=null}bringToFront(e){return!!this.windows.includes(e)&&(e.bringToTop(),this.windows.splice(this.windows.indexOf(e),1),this.windows.push(e),!0)}}class CarouselMenu extends Phaser.Sprite{constructor(e,t,s,i,a={}){super(game,e,t),this.config={animate:!0,align:"left",bgcolor:"#3498db",fgcolor:"#ffffff",disableScrollBar:!1,inactiveAlpha:.4,activeAlpha:.9,...a,margin:{top:4,bottom:4,left:4,right:4,...a.margin||{}}},this.viewport={width:s,height:i},this.items=[],this.selectedIndex=0,this.scrollOffset=0,this.itemHeight=8,this.itemSpacing=1,this.totalItemHeight=this.itemHeight+this.itemSpacing,this.visibleItems=Math.floor((i-this.config.margin.top-this.config.margin.bottom)/this.totalItemHeight),this.visibleItems=Math.max(1,this.visibleItems),this.isAnimating=!1,this.inputEnabled=!0,this.config.disableScrollBar||(this.scrollBar=game.add.graphics(this.viewport.width-3,this.config.margin.top),this.scrollBar.alpha=0,this.addChild(this.scrollBar),this.scrollBarTween=null),this.lastUp=!1,this.lastDown=!1,this.lastLeft=!1,this.lastRight=!1,this.lastConfirm=!1,this.lastCancel=!1,this.setupInput(),this.config.silent||game.add.existing(this)}setupInput(){gamepad.releaseAll(),this.onSelect=new Phaser.Signal,this.onConfirm=new Phaser.Signal,this.onCancel=new Phaser.Signal}addItem(e,t=null,s={}){const i={parent:null,background:null,text:null,textContent:e,callback:t,data:s,index:this.items.length,originalX:"right"===this.config.align?this.config.margin.right:this.config.margin.left,originalAlpha:this.config.inactiveAlpha,isSelected:!1,alphaTween:null};return this.items.push(i),this.updateSelection(),i}createItemVisuals(e,t){const s=e.index;let i=this.config.margin.left,a=e.initialY||this.config.margin.top+s*this.totalItemHeight;const n=e.data;e.initialY=null;const r=new Phaser.Sprite(game,i,a);r.alpha=this.config.inactiveAlpha,this.addChild(r);const o=this.viewport.width-this.config.margin.left-this.config.margin.right,h=this.itemHeight,l=this.createGradientBackground(o,h,n.bgcolor);l.x=e.originalX,r.addChild(l);const c="right"===this.config.align?o-8:8,d="right"===this.config.align?1:0,u=new Text(c,0,e.textContent,{...FONTS.default,tint:n.fgcolor||this.config.fgcolor});u.anchor.x=d,u.y=1,r.addChild(u),4*e.textContent.length>this.viewport.width-16&&u.write(e.textContent.substr(0,Math.floor(this.viewport.width-16)/4)),e.parent=r,e.background=l,e.text=u}removeItemVisuals(e){e.parent?.destroy(),e.parent=null,e.background=null,e.text=null}createGradientBackground(e,t,s){const i=game.add.bitmapData(e,t),a=i.context.createLinearGradient("right"===this.config.align?e:0,0,"right"===this.config.align?0:e,0),n=s||this.config.bgcolor;"right"===this.config.align?(a.addColorStop(0,"transparent"),a.addColorStop(.3,n),a.addColorStop(1,n)):(a.addColorStop(0,n),a.addColorStop(.7,n),a.addColorStop(1,"transparent")),i.context.fillStyle=a,i.context.fillRect(0,0,e,t);return game.add.sprite(0,0,i)}update(){this.inputEnabled&&(this.handleInput(),this.updateAnimations())}handleInput(){const e=gamepad.pressed.up&&!this.lastUp,t=gamepad.pressed.down&&!this.lastDown,s=gamepad.pressed.left&&!this.lastLeft,i=gamepad.pressed.right&&!this.lastRight,a=gamepad.pressed.a&&!this.lastConfirm,n=gamepad.pressed.b&&!this.lastCancel;e?this.navigate(-1):t?this.navigate(1):s?this.navigate(-1,!0):i&&this.navigate(1,!0),a&&this.items.length>0&&this.confirm(),n&&this.cancel(),this.lastUp=gamepad.pressed.up,this.lastDown=gamepad.pressed.down,this.lastLeft=gamepad.pressed.left,this.lastRight=gamepad.pressed.right,this.lastConfirm=gamepad.pressed.a,this.lastCancel=gamepad.pressed.b}navigate(e,t){if(0===this.items.length||this.isAnimating)return;let s=t?e*Math.max(1,this.visibleItems):e,i=this.selectedIndex+s;t?(i<0&&(i=0),i>this.items.length-1&&(i=this.items.length-1)):(i<0&&(i=this.items.length-1),i>this.items.length-1&&(i=0)),i!==this.selectedIndex&&(this.selectedIndex=i,this.updateSelection(),this.playNavSound(),this.onSelect.dispatch(this.selectedIndex,this.items[this.selectedIndex]),this.config.disableScrollBar||this.showScrollBar())}selectIndex(e){this.selectedIndex=e,this.updateSelection(),this.onSelect.dispatch(e,this.items[e])}updateSelection(){this.adjustScroll(),this.items.forEach((e,t)=>{const s=t===this.selectedIndex;t>=this.scrollOffset&&t<this.scrollOffset+this.visibleItems?(e.parent||this.createItemVisuals(e,s),s&&!e.isSelected?this.selectItem(e):!s&&e.isSelected&&this.deselectItem(e)):(e.parent&&this.removeItemVisuals(e),e.isSelected&&this.deselectItem(e))}),this.updateItemPositions(),this.config.disableScrollBar||this.updateScrollBar()}selectItem(e){const t=this.items.find(t=>t.isSelected&&t!==e);t&&this.deselectItem(t),e.isSelected=!0,e.alphaTween&&e.alphaTween.stop(),e.parent&&(this.config.animate?e.alphaTween=game.add.tween(e.parent).to({alpha:this.config.activeAlpha},250,Phaser.Easing.Quadratic.InOut,!0,0,-1,!0).yoyo(!0,500):e.parent.alpha=this.config.activeAlpha,e.text&&4*e.textContent.length>this.viewport.width-16&&e.text.scrollwrite(e.textContent,Math.floor(this.viewport.width-16)/4))}deselectItem(e){e.isSelected=!1,e.alphaTween&&(e.alphaTween.stop(),e.alphaTween=null),e.parent&&(this.config.animate?game.add.tween(e.parent).to({alpha:this.config.inactiveAlpha},100,Phaser.Easing.Quadratic.Out,!0):e.parent.alpha=this.config.inactiveAlpha,e.text&&e.text.isScrolling()&&(e.text.stopScrolling(),e.text.write(e.textContent.substr(0,Math.floor(this.viewport.width-16)/4))))}adjustScroll(){this.selectedIndex<this.scrollOffset?this.scrollOffset=this.selectedIndex:this.selectedIndex>=this.scrollOffset+this.visibleItems&&(this.scrollOffset=this.selectedIndex-this.visibleItems+1),this.scrollOffset=Phaser.Math.clamp(this.scrollOffset,0,Math.max(0,this.items.length-this.visibleItems))}updateScrollBar(){if(this.config.disableScrollBar)return;if(this.scrollBar.clear(),this.items.length<=this.visibleItems)return void this.hideScrollBar();const e=this.viewport.height-this.config.margin.top-this.config.margin.bottom,t=this.items.length,s=Math.max(8,this.visibleItems/t*e),i=t-this.visibleItems,a=this.scrollOffset/i*(e-s),n=Phaser.Color.hexToRGB(this.config.fgcolor);this.scrollBar.beginFill(n,.8),this.scrollBar.drawRect(0,a,1,s),this.scrollBar.endFill(),this.showScrollBar()}showScrollBar(){this.config.disableScrollBar||(this.scrollBarTween&&this.scrollBarTween.stop(),this.scrollBar.alpha=1,this.scrollBarTween=game.add.tween(this.scrollBar),this.scrollBarTween.to({alpha:0},1e3,Phaser.Easing.Quadratic.Out,!0,500).onComplete.add(()=>{this.scrollBarTween=null}))}hideScrollBar(){this.config.disableScrollBar||(this.scrollBarTween&&(this.scrollBarTween.stop(),this.scrollBarTween=null),this.scrollBar.alpha=0,this.scrollBar.clear())}updateItemPositions(){this.items.forEach((e,t)=>{const s=t-this.scrollOffset,i=this.config.margin.top+s*this.totalItemHeight;e.parent?this.config.animate&&!this.isAnimating?game.add.tween(e.parent).to({y:i},150,"Quad.easeOut",!0):e.parent.y=i:e.initialY=i})}updateAnimations(){}confirm(){if(0===this.items.length||this.isAnimating)return;const e=this.items[this.selectedIndex];this.inputEnabled=!1,this.isAnimating=!0,this.animateSelection(e,()=>{this.onConfirm.dispatch(this.selectedIndex,e),e.callback?.(e),this.destroy()})}animateSelection(e,t){if(this.items.forEach(e=>{e.alphaTween&&(e.alphaTween.stop(),e.alphaTween=null)}),!e.parent)return;const s="right"===this.config.align?100:-100;this.items.forEach(t=>{t!==e&&t.parent&&t.parent.visible&&game.add.tween(t.parent).to({x:t.parent.x+s,alpha:0},500,"Quad.easeOut",!0)}),e.alphaTween&&e.alphaTween.stop(),e.parent.alpha=1;const i=this.viewport.width-this.config.margin.left-this.config.margin.right,a=this.itemHeight,n=this.createGradientBackground(i,a);n.x="right"===this.config.align?this.config.margin.right:this.config.margin.left,n.alpha=0,e.parent.addChild(n);game.add.tween(n).to({alpha:1},100,"Linear",!0).onComplete.addOnce(()=>{e.text.visible=!1;game.add.tween(e.parent).to({alpha:0},100,"Linear",!0).onComplete.addOnce(()=>{t?.()})})}animateCancel(e){this.items.forEach(e=>{e.alphaTween&&(e.alphaTween.stop(),e.alphaTween=null)});const t="right"===this.config.align?100:-100;this.items.forEach(e=>{e.parent&&e.parent.visible&&game.add.tween(e.parent).to({x:e.parent.x+t,alpha:0},500,"Quad.easeOut",!0)}),game.time.events.add(500,()=>e?.())}cancel(){!this.isAnimating&&this.onCancel.getNumListeners()>0&&this.animateCancel(()=>{this.onCancel.dispatch(),this.destroy()})}playNavSound(){}clear(){this.items.forEach(e=>{this.removeItemVisuals(e),e.alphaTween&&e.alphaTween.stop(),e.parent&&e.parent.destroy()}),this.items=[],this.selectedIndex=0,this.scrollOffset=0,!this.config.disableScrollBar&&this.scrollBarTween&&(this.scrollBarTween.stop(),this.scrollBarTween=null),this.onSelect.dispose(),this.onConfirm.dispose(),this.onCancel.dispose()}destroy(){this.clear(),super.destroy()}}class BackgroundGradient extends Phaser.Sprite{constructor(e=.1,t=.5,s=5e3){super(game,0,0,"ui_background_gradient"),this.alpha=e,game.add.tween(this).to({alpha:t},5e3,Phaser.Easing.Quadratic.InOut,!0).yoyo(!0).repeat(-1),game.add.existing(this)}}class Background extends Phaser.Sprite{constructor(e,t,s=.1,i=.5,a=5e3){super(game,0,0,e),this.alpha=s,t&&game.add.tween(this).to({alpha:i},5e3,Phaser.Easing.Quadratic.InOut,!0).yoyo(!0).repeat(-1),game.add.existing(this)}}class FuturisticLines extends Phaser.Sprite{constructor(){super(game,0,0),this.lines=[],this.maxLines=12,this.lineSpeed=1.2,this.tailLength=100,this.spawnRate=150,this.lastSpawnTime=0,this.lineColors=[7798015,4914430,58879,47316],this.lineAlpha=.3,this.graphics=game.add.graphics(0,0),this.addChild(this.graphics),game.add.existing(this)}update(){const e=game.time.now;this.lines.length<this.maxLines&&e-this.lastSpawnTime>this.spawnRate&&(this.spawnLine(),this.spawnRate=game.rnd.between(150,2e3),this.lastSpawnTime=e),this.updateLines(),this.drawLines()}spawnLine(){const e=game.rnd.integerInRange(10,game.height-10),t={x:-20,y:e,startY:e,points:[{x:-20,y:e}],color:game.rnd.pick(this.lineColors),speed:this.lineSpeed*game.rnd.realInRange(.9,1.1),direction:0,age:0,maxAge:1e4,active:!0,lastDirectionChange:0,nextDirectionChangeTime:game.rnd.integerInRange(1e3,5e3),state:"straight"};this.lines.push(t)}updateLines(){for(let e=this.lines.length-1;e>=0;e--){const t=this.lines[e];if(!t.active){this.lines.splice(e,1);continue}if(t.age+=game.time.elapsed,t.age>t.maxAge){t.active=!1;continue}t.age-t.lastDirectionChange>t.nextDirectionChangeTime&&this.changeLineDirection(t);const s=t.direction*(Math.PI/180),i=t.speed*Math.cos(s),a=t.speed*Math.sin(s);for(t.x+=i,t.y+=a,t.points.push({x:t.x,y:t.y});t.points.length>0&&t.points[0].x<t.x-this.tailLength;)t.points.shift();(t.x>game.width+100+this.tailLength||t.y<-50||t.y>game.height+50)&&(t.active=!1)}}changeLineDirection(e){e.lastDirectionChange=e.age,"straight"===e.state?(e.direction=game.rnd.pick([-45,45]),e.state="angled",e.nextDirectionChangeTime=game.rnd.integerInRange(100,500)):"angled"===e.state&&(e.direction=0,e.state="straight",e.nextDirectionChangeTime=game.rnd.integerInRange(1e3,5e3))}drawLines(){this.graphics.clear();for(const e of this.lines)!e.active||e.points.length<2||(this.drawTail(e),this.drawCap(e))}drawTail(e){const t=e.points;for(let s=1;s<t.length;s++){const i=t[s-1],a=t[s],n=s/t.length,r=s<=4?0:this.lineAlpha*(.9*n);this.graphics.lineStyle(1,e.color,r),this.graphics.moveTo(i.x,i.y),this.graphics.lineTo(a.x,a.y)}}drawCap(e){if(0===e.points.length)return;const t=e.points[e.points.length-1];this.graphics.beginFill(16777215,1.5*this.lineAlpha),this.graphics.drawRect(t.x,t.y,1,1),this.graphics.endFill()}setDensity(e){this.maxLines=Phaser.Math.clamp(e,1,15)}setSpeed(e){this.lineSpeed=Phaser.Math.clamp(e,.5,3)}setTailLength(e){this.tailLength=Phaser.Math.clamp(e,20,100)}clearLines(){this.lines=[],this.graphics.clear()}setColors(e){this.lineColors=e}setAlpha(e){this.lineAlpha=Phaser.Math.clamp(e,.1,.8)}destroy(){this.clearLines(),this.graphics.destroy(),super.destroy()}}class LoadingDots extends Phaser.Sprite{constructor(){super(game,game.width-2,game.height-2,"ui_loading_dots"),this.anchor.set(1),this.animations.add("loading",[0,1,2,3,4,3,2,1],8,!0),this.animations.play("loading"),game.add.existing(this)}}class Logo extends Phaser.Sprite{constructor(){super(game,game.width/2,game.height/2,null),this.anchor.set(.5),this.mainShape=this.addShape(),game.add.existing(this)}intro(e){this.mainShape.alpha=0,game.add.tween(this.mainShape).to({alpha:1},1e3,"Linear",!0).onComplete.addOnce(()=>{this.logoTween=game.add.tween(this.mainShape).to({alpha:.8},500,"Linear",!0).repeat(-1).yoyo(!0),e&&e()})}outro(e){this.effect(32,1e3);const t=this.addShape();t.alpha=1,game.add.tween(t).to({alpha:0},250,"Linear",!0),game.add.tween(t.scale).to({x:8,y:8},250,"Linear",!0),game.camera.flash(16777215,300),game.time.events.add(350,()=>game.camera.fade(16777215,1e3)),game.camera.onFadeComplete.addOnce(()=>e&&e())}effect(e=5,t=1e3,s=!1){let i=[];for(let a=0;a<e;a++){const n=this.addShape();n.alpha=0,n.scale.set(1+a/10),i.push(n),game.add.tween(n).to({alpha:1},t,"Linear",!0,(s?100*-e:0)+100*a).yoyo(!0)}}addShape(e=16777215,t=0,s=0){const i=game.add.sprite(t,s,"ui_logo_shape");return i.anchor.set(.5),i.tint=e,this.addChild(i),i}}class NavigationHint extends Phaser.Sprite{constructor(e=0){super(game,0,0),this.defaultFrame=e,this.lastInputSource=null,game.add.existing(this)}hide(){this.visible=!1}show(){this.visible=!0}update(){gamepad&&(gamepad.lastInputSource!=this.lastInputSource&&(this.loadTexture("keyboard"==gamepad.lastInputSource?"ui_navigation_hint_keyboard":"ui_navigation_hint_gamepad"),this.frame=this.defaultFrame),this.lastInputSource=gamepad.lastInputSource)}}class ProgressText extends Text{constructor(e){super(4,game.height-4,e,FONTS.default),this.anchor.y=1}}class ExperienceBar extends Phaser.Sprite{constructor(e,t,s,i){super(game,e,t),this.barWidth=s,this.barHeight=i,this.progress=0,this.background=game.add.graphics(0,0),this.background.beginFill(3355443),this.background.drawRect(0,0,s,i),this.background.endFill(),this.addChild(this.background),this.bar=game.add.graphics(0,0),this.addChild(this.bar),this.border=game.add.graphics(0,0),this.border.lineStyle(1,16777215,1),this.border.drawRect(0,0,s,i),this.border.endFill(),this.addChild(this.border),this.updateBar(),game.add.existing(this)}setProgress(e){this.progress=Phaser.Math.clamp(e,0,1),this.updateBar()}updateBar(){this.bar.clear(),this.bar.beginFill(7797982),this.bar.drawRect(0,0,this.barWidth*this.progress,this.barHeight),this.bar.endFill()}destroy(){this.background.destroy(),this.bar.destroy(),this.border.destroy(),super.destroy()}}class SkillBar extends Phaser.Sprite{constructor(e,t){super(game,e,t),this.parts=[],this.visibleParts=5,this.value=5;for(let e=0,t=0;e<5;e++,t+=3){const e=game.add.sprite(t,0,"ui_skill_bar",0);this.addChild(e),this.parts.push(e)}game.add.existing(this)}update(){for(let e=1;e<=5;e++){const t=this.parts[e-1];t.visible=e<=this.visibleParts,t.frame=this.value>=e?0:1}}}class TextInput extends Phaser.Sprite{constructor(e="",t=6,s,i){super(game,96,28),this.anchor.x=.5,this.characterSet="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 ",this.window=new Window(0,0,t,2,"1",this),this.window.x-=this.window.size.width/2*8,this.stackedText=e,this.text="",this.currentIndex=0,this.maxLength=t,this.textLayer=new Text(3,5,e),this.textLayer.tint=this.window.fontTint,this.window.addChild(this.textLayer),this.cursor=game.add.graphics(0,1),this.cursor.beginFill(this.window.fontTint,1),this.cursor.drawRect(0,0,2,4),this.cursor.endFill(),this.textLayer.addChild(this.cursor),this.lastCursorBlinkTime=0,this.cursorVisible=!1,this.onConfirm=new Phaser.Signal,this.onCancel=new Phaser.Signal,s&&this.onConfirm.add(s),i&&this.onCancel.add(i),game.add.existing(this)}getCharacterToInsert(){return this.characterSet[this.currentIndex]}update(){const e=this.stackedText.length>=this.maxLength;this.text=e?this.stackedText:this.stackedText+this.getCharacterToInsert(),this.textLayer.write(this.text),this.cursor.x=4*this.text.length,this.cursor.visible=!e&&this.cursorVisible;let t=this.currentIndex;gamepad.pressed.up&&t--,gamepad.pressed.down&&t++,t<0&&(t=this.characterSet.length-1),t>this.characterSet.length-1&&(t=0),this.currentIndex=t,gamepad.pressed.a&&(e?this.confirm():this.stackedText+=this.getCharacterToInsert()),gamepad.pressed.b&&(this.stackedText.length>0?this.stackedText=this.stackedText.substr(0,this.stackedText.length-1):this.cancel()),game.time.now-this.lastCursorBlinkTime>=350&&(this.cursorVisible=!this.cursorVisible,this.lastCursorBlinkTime=game.time.now),gamepad.pressed.start&&this.confirm(),gamepad.pressed.select&&this.cancel()}confirm(){this.onConfirm.dispatch(this.text),this.destroy()}cancel(){this.onCancel.dispatch(this.text),this.destroy()}destroy(){super.destroy(),this.onConfirm.dispose()}}class NotificationSystem{constructor(){this.queue=[],this.isShowing=!1,this.currentNotification=null,this.duration=3e3,this.lineHeight=8,this.padding=8,this.maxLineWidth=160,this.charWidth=4,this.notificationWindow=null,this.notificationTexts=null,this.restrictedStates=new Set(["Title","Play","Load","LoadLocalSongs","LoadExternalSongs","LoadSongFolder","Boot"]),this.allowedStates=new Set(["MainMenu","SongSelect","Results","CharacterSelect","Jukebox"]),this.setupStateChangeHandling()}setupStateChangeHandling(){const e=game.state.start;game.state.start=function(t,s,i,...a){return notifications&&notifications.isShowing&&notifications.preserveCurrentNotification(),e.call(this,t,s,i,...a)},game.state.onStateChange.add(this.onStateChange,this)}onStateChange(e){game.time.events.add(100,()=>{const e=game.state.getCurrentState(),t=e?.constructor?.name||"";this.isStateAllowed(t)&&this.processPendingNotifications(),this.preservedNotification&&this.restorePreservedNotification()})}show(e,t=3e3){const s=game.state.getCurrentState(),i=s?.constructor?.name||"",a=this.wrapText(e);this.queue.push({text:a,originalText:e,duration:t,endTime:Date.now()+t,queuedInState:i}),this.isStateAllowed(i)&&!this.isShowing&&this.processNext()}wrapText(e){const t=e.split("\n"),s=[];for(let e of t){if(this.getTextWidth(e)<=this.maxLineWidth){s.push(e);continue}let t="";const i=e.split(" ");for(let e of i){if(this.getTextWidth(e)>this.maxLineWidth){t&&(s.push(t.trim()),t="");const i=this.breakLongWord(e);s.push(...i);continue}const i=t?`${t} ${e}`:e;this.getTextWidth(i)<=this.maxLineWidth?t=i:(t&&s.push(t.trim()),t=e)}t&&s.push(t.trim())}return s.join("\n")}breakLongWord(e){const t=[];let s="";for(let i=0;i<e.length;i++)s+=e[i],this.getTextWidth(s+(e[i+1]||""))>this.maxLineWidth&&(t.push(s),s="");return s&&t.push(s),t}getTextWidth(e){return e.length*this.charWidth}processPendingNotifications(){this.queue.length>0&&!this.isShowing&&(console.log(`📢 Processing ${this.queue.length} pending notifications`),this.processNext())}processNext(){const e=game.state.getCurrentState(),t=e?.constructor?.name||"";if(!this.isStateAllowed(t))return void console.log(`📢 Processing blocked in restricted state: ${t}`);if(0===this.queue.length)return void(this.isShowing=!1);this.isShowing=!0;const s=this.queue.shift();this.currentNotification=s,console.log(`📢 Showing notification: "${s.originalText}"`),this.displayNotification(s.text),game.time.events.add(s.duration,()=>{this.hideCurrent()})}preserveCurrentNotification(){this.currentNotification&&this.notificationWindow&&(this.preservedNotification={text:this.currentNotification.text,originalText:this.currentNotification.originalText,duration:this.currentNotification.duration,remainingTime:this.currentNotification.endTime-Date.now()},this.cleanupUI())}restorePreservedNotification(){if(this.preservedNotification){const e=game.state.getCurrentState(),t=e?.constructor?.name||"";if(!this.isStateAllowed(t))return void console.log(`📢 Restore blocked in restricted state: ${t}`);const s=this.preservedNotification;this.displayNotification(s.text),this.isShowing=!0;const i=Math.max(500,s.remainingTime);game.time.events.add(i,()=>{this.hideCurrent()}),this.currentNotification={text:s.text,originalText:s.originalText,duration:i,endTime:Date.now()+i},this.preservedNotification=null}}displayNotification(e){const t=e.split("\n"),s=t.length,i=Math.min(this.maxLineWidth,Math.max(...t.map(e=>this.getTextWidth(e)))),a=Math.floor(Math.min(180,i+2*this.padding)),n=Math.floor(s*this.lineHeight+2*this.padding),r=(game.width-a)/2;this.notificationWindow=new Window(r/8,.5,a/8,n/8,"1"),this.notificationWindow.focus=!1,this.notificationWindow.selector.visible=!1,this.notificationTexts=[],t.forEach((e,t)=>{const s=new Text(a/2,this.padding+t*this.lineHeight+this.lineHeight/2,e,{...FONTS.default,tint:7797982});s.anchor.set(.5),this.notificationWindow.addChild(s),this.notificationTexts.push(s)}),this.notificationWindow.alpha=0,game.add.tween(this.notificationWindow).to({alpha:1},300,"Linear",!0)}hideCurrent(){if(this.currentNotification){game.add.tween(this.notificationWindow).to({alpha:0},300,"Linear",!0).onComplete.add(()=>{this.cleanupUI(),this.currentNotification=null;const e=game.state.getCurrentState(),t=e?.constructor?.name||"";this.isStateAllowed(t)&&this.processNext()})}}cleanupUI(){this.notificationWindow&&(this.notificationWindow.destroy(),this.notificationWindow=null),this.notificationTexts&&(this.notificationTexts.forEach(e=>e.destroy()),this.notificationTexts=null)}isStateRestricted(e){return this.restrictedStates.has(e)||!this.allowedStates.has(e)&&""!==e}isStateAllowed(e){return this.allowedStates.has(e)}canShowInCurrentState(){const e=game.state.getCurrentState(),t=e?.constructor?.name||"";return this.isStateAllowed(t)}setWrappingSettings(e=160,t=4){this.maxLineWidth=e,this.charWidth=t}wrapTextToLines(e,t=3){const s=this.wrapText(e),i=s.split("\n");if(i.length<=t)return s;const a=i.slice(0,t-1).join("\n");let n=i[t-1];for(;this.getTextWidth(n+"...")>this.maxLineWidth&&n.length>3;)n=n.slice(0,-1);return a+"\n"+n+"..."}getQueueStatus(){const e=game.state.getCurrentState(),t=e?.constructor?.name||"";return{queueLength:this.queue.length,isShowing:this.isShowing,currentState:t,isStateAllowed:this.isStateAllowed(t),hasPreserved:!!this.preservedNotification,maxLineWidth:this.maxLineWidth}}clear(){this.queue=[],this.currentNotification&&this.hideCurrent(),this.preservedNotification=null}hasActiveNotifications(){return this.isShowing||this.queue.length>0||this.preservedNotification}getNotificationCount(){let e=this.queue.length;return this.isShowing&&e++,this.preservedNotification&&e++,e}destroy(){this.clear(),game.state.onStateChange.remove(this.onStateChange,this)}}class Lyrics{constructor(e={}){this.textElement=e.textElement||null,this.maxLineLength=e.maxLineLength||30,this.currentTime=0,this.lrcData=[],this.rangeLrc=[],this.currentLineIndex=-1,e.lrc&&this.setLrc(e.lrc)}setLrc(e){this.tags={},this.lrcData=[],this.rangeLrc=[],this.currentLineIndex=-1;const t=/\[([a-z]+):(.*)\].*/,s=/(\[[0-9.:\[\]]*\])+(.*)/,i=/\[([0-9]+):([0-9.]+)\]/,a=e.split(/[\r\n]/);for(let e=0;e<a.length;e++){const n=t.exec(a[e]);if(n&&n[0]){this.tags[n[1]]=n[2];continue}const r=s.exec(a[e]);if(r&&r[0]){const e=r[1].replace(/\]\[/g,"],[").split(","),t=r[2].trim();for(let s=0;s<e.length;s++){const a=i.exec(e[s]);if(a&&a[0]){const e=60*parseInt(a[1],10)+parseFloat(a[2]);this.lrcData.push({startTime:e,line:t})}}}}this.lrcData.sort((e,t)=>e.startTime-t.startTime);let n=0,r="";for(let e=0;e<this.lrcData.length;e++){const t=this.lrcData[e].startTime;this.rangeLrc.push({startTime:n,endTime:t,line:r}),n=t,r=this.lrcData[e].line}this.rangeLrc.push({startTime:n,endTime:Number.MAX_SAFE_INTEGER,line:r})}move(e){this.currentTime=e;for(let t=0;t<this.rangeLrc.length;t++)if(e>=this.rangeLrc[t].startTime&&e<this.rangeLrc[t].endTime)return void(this.currentLineIndex!==t&&this.textElement&&(this.currentLineIndex=t,this.displayCurrentLine()));-1!==this.currentLineIndex&&this.textElement&&(this.currentLineIndex=-1,this.textElement.write(""))}displayCurrentLine(){if(!this.textElement||this.currentLineIndex<0)return;const e=this.rangeLrc[this.currentLineIndex].line.trim();e?(this.textElement.isScrolling&&this.textElement.stopScrolling&&this.textElement.stopScrolling(),this.textElement.write(e),e.length>this.maxLineLength&&this.textElement.wrap(5*this.maxLineLength)):this.textElement.write("")}getCurrentLine(){return this.currentLineIndex>=0&&this.currentLineIndex<this.rangeLrc.length?this.rangeLrc[this.currentLineIndex].line:""}getNextLine(){const e=this.currentLineIndex+1;return e<this.rangeLrc.length?this.rangeLrc[e].line:""}hasLyrics(){return this.lrcData.length>0}clear(){this.textElement&&this.textElement.write(""),this.currentLineIndex=-1,this.lrcData=[],this.rangeLrc=[]}destroy(){this.clear(),this.textElement=null}}class OffsetAssistant extends Phaser.Sprite{constructor(e){super(e,0,0),this.taps=[],this.confidenceThreshold=.8,this.maxTaps=16,this.requiredTaps=8,this.tickBPM=120,this.tickInterval=6e4/this.tickBPM,this.wasMusicPlaying=backgroundMusic&&backgroundMusic.isPlaying,this.originalMusicTime=0,this.pauseBackgroundMusic(),this.startTickSound(),this.background=e.add.graphics(0,0),this.background.beginFill(0,.8),this.background.drawRect(0,0,e.width,e.height),this.background.endFill(),this.addChild(this.background),this.instructionText=new Text(e.width/2,e.height/2-20,"TAP A TO THE TICK",FONTS.shaded),this.instructionText.anchor.set(.5),this.addChild(this.instructionText),this.offsetText=new Text(e.width/2,e.height/2+10,"Offset: 0ms",FONTS.default),this.offsetText.anchor.set(.5),this.addChild(this.offsetText),this.tapCounter=new Text(e.width/2,e.height/2+30,"Taps: 0",FONTS.default),this.tapCounter.anchor.set(.5),this.tapCounter.alpha=.7,this.addChild(this.tapCounter),this.exitText=new Text(e.width/2,e.height-10,"Press B to exit and save",FONTS.default),this.exitText.anchor.set(.5),this.exitText.alpha=.5,this.addChild(this.exitText),this.lastAPress=!1,this.lastBPress=!1,this.lastTickTime=0,this.nextTickTime=this.game.time.now,this.calculatedOffsets=[]}update(){gamepad.pressed.a&&!this.lastAPress&&this.onTap(),this.lastAPress=gamepad.pressed.a,gamepad.pressed.b&&!this.lastBPress&&this.exit(),this.lastBPress=gamepad.pressed.b,this.updateTickSound(),this.tapCounter.write(`Taps: ${this.taps.length}`)}pauseBackgroundMusic(){backgroundMusic&&backgroundMusic.isPlaying&&(this.originalMusicTime=backgroundMusic.audio.currentTime,backgroundMusic.stop())}resumeBackgroundMusic(){backgroundMusic&&this.wasMusicPlaying&&(backgroundMusic.audio.currentTime=this.originalMusicTime,backgroundMusic.audio.play())}startTickSound(){game.cache.checkSoundKey("assist_tick")?(this.playTickSound(),this.lastTickTime=this.game.time.now,this.nextTickTime=this.lastTickTime+this.tickInterval):console.warn("Tick sound not preloaded!")}updateTickSound(){if(this.destroyed)return;const e=this.game.time.now;e>=this.nextTickTime&&(this.playTickSound(),this.lastTickTime=e,this.nextTickTime=e+this.tickInterval)}playTickSound(){if(game.cache.checkSoundKey("assist_tick")){const e=game.add.audio("assist_tick");e.volume=.5,e.play()}}onTap(){const e=this.game.time.now;this.taps.push(e),this.taps.length>this.maxTaps&&this.taps.shift(),this.calculateOffset(),this.showTapFeedback()}calculateOffset(){if(this.taps.length<2)return this.offsetText.write("Offset: 0ms"),void(this.offsetText.tint=16777215);const e=[];for(let t=0;t<this.taps.length;t++){const s=this.taps[t],i=Math.round((s-this.taps[0])/this.tickInterval),a=s-(this.taps[0]+i*this.tickInterval);e.push(a)}const t=e.reduce((e,t)=>e+t,0)/e.length,s=25*Math.round(t/25);this.calculatedOffsets.push(s),this.calculatedOffsets.length>5&&this.calculatedOffsets.shift();const i=this.calculatedOffsets.length>0?25*Math.round(this.calculatedOffsets.reduce((e,t)=>e+t,0)/this.calculatedOffsets.length/25):s,a=this.calculateConfidence(e),n=`Offset: ${i}ms`;this.offsetText.write(n),this.taps.length>=this.requiredTaps&&a>=this.confidenceThreshold?this.offsetText.tint=65280:this.taps.length>=4?this.offsetText.tint=16776960:this.offsetText.tint=16777215}calculateConfidence(e){if(e.length<3)return 0;const t=e.reduce((e,t)=>e+t,0)/e.length,s=e.reduce((e,s)=>e+Math.pow(s-t,2),0)/e.length,i=Math.sqrt(s),a=Math.max(0,1-i/50);return Math.min(1,a)}roundToNearestMultipleOf25(e){const t=Math.round(e/25);return t>=0?25*t:25*(t+1)}showTapFeedback(){this.game.add.tween(this.instructionText.scale).to({x:1.1,y:1.1},50,Phaser.Easing.Quadratic.Out,!0).yoyo(!0)}exit(){let e=0;if(this.calculatedOffsets.length>0)e=this.roundToNearestMultipleOf25(this.calculatedOffsets.reduce((e,t)=>e+t,0)/this.calculatedOffsets.length),Account.settings.userOffset=e,saveAccount(),notifications.show(`Offset set to ${e}ms`);else if(this.taps.length>0){const e=this.parseOffsetText();null!==e&&(Account.settings.userOffset=e,saveAccount(),notifications.show(`Offset set to ${e}ms`))}this.resumeBackgroundMusic(),this.destroy(),game.state.getCurrentState().menu()}parseOffsetText(){const e=this.offsetText.text.match(/Offset: (-?\d+)ms/);return e?parseInt(e[1],10):null}destroy(){this.resumeBackgroundMusic(),this.destroyed=!0,this.background.destroy(),this.instructionText.destroy(),this.offsetText.destroy(),this.tapCounter.destroy(),this.exitText.destroy(),super.destroy()}}class FileSystemTools{constructor(){this.platform=this.detectPlatform(),"nwjs"===this.platform?this.fileSystem=new NodeFileSystem:"cordova"===this.platform?this.fileSystem=new CordovaFileSystem:this.fileSystem=new FallbackFileSystem,console.log(`FileSystem: Using ${this.platform} implementation`)}detectPlatform(){return"undefined"!=typeof nw&&nw.process?"nwjs":"undefined"!=typeof cordova&&cordova.file?"cordova":"fallback"}getDirectory(e){return this.fileSystem.getDirectory(e)}listDirectories(e){return this.fileSystem.listDirectories(e)}listAllDirectories(e){return this.fileSystem.listAllDirectories(e)}listFiles(e){return this.fileSystem.listFiles(e)}getFile(e){return this.fileSystem.getFile(e)}readFileContent(e){return this.fileSystem.readFileContent(e)}saveFile(e,t,s){return this.fileSystem.saveFile(e,t,s)}createEmptyFile(e,t,s){return this.fileSystem.createEmptyFile(e,t,s)}writeFile(e,t,s){return this.fileSystem.writeFile(e,t,s)}createDirectory(e,t){return this.fileSystem.createDirectory(e,t)}getBasePath(){return"nwjs"===this.platform&&this.fileSystem.getBasePath?this.fileSystem.getBasePath():""}canExitApp(){return"nwjs"===this.platform||"cordova"===this.platform}exitApp(){"nwjs"===this.platform?"undefined"!=typeof nw&&nw.App&&nw.App.quit():"cordova"===this.platform&&"undefined"!=typeof navigator&&navigator.app&&navigator.app.exitApp()}}class NodeDirectoryEntry{constructor(e,t,s,i){this.isFile=!1,this.isDirectory=!0,this.name=e,this.fullPath=t,this.filesystem=s,this.nativeURL=i||`file://${t}`}createReader(){const e=require("fs"),t=require("path"),s=t.join(this.filesystem.basePath,this.fullPath);return{readEntries:(i,a)=>{try{const a=[],n=e.readdirSync(s);for(const i of n){const n=t.join(s,i),r=e.statSync(n),o=t.join(this.fullPath,i);r.isDirectory()?a.push(new NodeDirectoryEntry(i,o,this.filesystem,`file://${n}`)):a.push(new NodeFileEntry(i,o,this.filesystem,`file://${n}`))}i(a)}catch(e){a(e)}}}}getDirectory(e,t,s,i){const a=require("fs"),n=require("path"),r=n.join(this.filesystem.basePath,this.fullPath,e);try{if(!a.existsSync(r)){if(!t||!t.create)throw new Error(`Directory not found: ${e}`);a.mkdirSync(r,{recursive:!0})}if(!a.statSync(r).isDirectory())throw new Error(`Path is not a directory: ${e}`);s(new NodeDirectoryEntry(n.basename(e),n.join(this.fullPath,e),this.filesystem,`file://${r}`))}catch(e){i(e)}}getFile(e,t,s,i){const a=require("fs"),n=require("path"),r=n.join(this.filesystem.basePath,this.fullPath,e);try{if(!a.existsSync(r)){if(!t||!t.create)throw new Error(`File not found: ${e}`);a.writeFileSync(r,"")}if(!a.statSync(r).isFile())throw new Error(`Path is not a file: ${e}`);s(new NodeFileEntry(n.basename(e),n.join(this.fullPath,e),this.filesystem,`file://${r}`))}catch(e){i(e)}}removeRecursively(e,t){const s=require("fs"),i=require("path"),a=i.join(this.filesystem.basePath,this.fullPath);try{const t=e=>{if(s.existsSync(e)){const a=s.readdirSync(e);for(const n of a){const a=i.join(e,n);s.statSync(a).isDirectory()?t(a):s.unlinkSync(a)}s.rmdirSync(e)}};t(a),e()}catch(e){t(e)}}}class NodeFileEntry{constructor(e,t,s,i){this.isFile=!0,this.isDirectory=!1,this.name=e,this.fullPath=t,this.filesystem=s,this.nativeURL=i||`file://${t}`}createWriter(e,t){const s=require("fs"),i=require("path").join(this.filesystem.basePath,this.fullPath);try{e({write:e=>{try{if(e instanceof Blob){const a=new FileReader;a.onload=()=>{s.writeFileSync(i,Buffer.from(a.result))},a.onerror=()=>t(a.error),a.readAsArrayBuffer(e)}else"string"==typeof e?s.writeFileSync(i,e):e instanceof ArrayBuffer?s.writeFileSync(i,Buffer.from(e)):s.writeFileSync(i,e)}catch(e){t(e)}}})}catch(e){t(e)}}file(e,t){const s=require("fs"),i=require("path").join(this.filesystem.basePath,this.fullPath);try{const t=s.statSync(i),a={name:this.name,size:t.size,type:this.getMimeType(this.name),lastModified:t.mtime,slice:(e,t)=>s.readFileSync(i).slice(e,t),localURL:i};a._path=i,e(a)}catch(e){t(e)}}getMimeType(e){return{png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",bmp:"image/bmp",mp3:"audio/mpeg",wav:"audio/wav",ogg:"audio/ogg",mp4:"video/mp4",avi:"video/x-msvideo",mov:"video/quicktime",sm:"text/plain",ssc:"text/plain",json:"application/json",txt:"text/plain"}[e.split(".").pop().toLowerCase()]||"application/octet-stream"}}class NodeFileSystem{constructor(){try{this.fs=require("fs"),this.path=require("path"),this.basePath=this.getBasePath(),this.fileSystemObj={name:"nodefs",root:new NodeDirectoryEntry("","/",this,`file://${this.basePath}`)}}catch(e){throw console.error("Node.js modules not available:",e),e}}getBasePath(){return"undefined"!=typeof nw&&nw.process?nw.process.cwd():"undefined"!=typeof process&&process.cwd?process.cwd():"."}getDirectory(e){return new Promise((t,s)=>{const i=this.path.join(this.basePath,e);this.fs.stat(i,(a,n)=>{if(a)return void s(a);if(!n.isDirectory())return void s(new Error(`Path is not a directory: ${e}`));const r=new NodeDirectoryEntry(this.path.basename(e)||".",e,this,`file://${i}`);t(r)})})}listDirectories(e){return new Promise((t,s)=>{e.createReader().readEntries(e=>t(e.filter(e=>e.isDirectory)),e=>s(e))})}listAllDirectories(e){return new Promise(async t=>{const s=[],i=[e];for(;i.length;){const e=i.shift();try{const t=await this.listDirectories(e);s.push(...t),i.push(...t)}catch(t){console.warn(`Error listing directories in ${e.name}:`,t)}}t(s)})}listFiles(e){return new Promise((t,s)=>{e.createReader().readEntries(e=>t(e.filter(e=>e.isFile)),e=>s(e))})}getFile(e){return new Promise((t,s)=>{e.file(e=>t(e),e=>s(e))})}readFileContent(e){return new Promise((t,s)=>{if(e._path)this.fs.readFile(e._path,"utf8",(e,i)=>{e?s(e):t(i)});else{const i=new FileReader;i.onload=()=>t(i.result),i.onerror=()=>s(i.error),i.readAsText(e)}})}saveFile(e,t,s){return new Promise((t,i)=>{e.getFile(s,{create:!0,exclusive:!1},e=>t(e),e=>i(e))})}createEmptyFile(e,t,s){return new Promise((s,i)=>{e.getFile(t,{create:!0,exclusive:!1},e=>s(e),e=>i(e))})}writeFile(e,t,s){return new Promise((s,i)=>{e.createWriter(e=>{e.write(t),s(e)},e=>i(e))})}createDirectory(e,t){return new Promise((s,i)=>{e.getDirectory(t,{create:!0},e=>s(e),e=>i(e))})}}class CordovaFileSystem{getDirectory(e){return new Promise((t,s)=>{let i=LocalFileSystem.PERSISTENT;game.device.windows?i=cordova.file.dataDirectory:game.device.macOS||game.device.iOS?i=cordova.file.documentsDirectory:game.device.android&&(i=cordova.file.externalRootDirectory),window.resolveLocalFileSystemURL(i+e,e=>t(e),e=>s(e))})}listDirectories(e){return new Promise((t,s)=>{e.createReader().readEntries(e=>t(e.filter(e=>e.isDirectory)),e=>s(e))})}listAllDirectories(e){return new Promise(async t=>{const s=[],i=[e];for(;i.length;){const e=i.shift();try{const t=await this.listDirectories(e);s.push(...t),i.push(...t)}catch(t){console.warn(`Error listing directories in ${e.name}:`,t)}}t(s)})}listFiles(e){return new Promise((t,s)=>{e.createReader().readEntries(e=>t(e.filter(e=>e.isFile)),e=>s(e))})}getFile(e){return new Promise((t,s)=>{e.file(e=>t(e),e=>s(e))})}readFileContent(e){return new Promise((t,s)=>{const i=new FileReader;i.onload=()=>t(i.result),i.onerror=()=>s(i.error),i.readAsText(e)})}saveFile(e,t,s){return new Promise((i,a)=>{e.getFile(s,{create:!0,exclusive:!1},e=>{this.writeFile(e,t).then(()=>i(e)).catch(e=>a(e))},e=>a(e))})}createEmptyFile(e,t,s){return new Promise((i,a)=>{e.getFile(t,{create:!0,exclusive:!1},e=>{this.writeFile(e,null,s).then(()=>i(e)).catch(e=>a(e))},e=>a(e))})}writeFile(e,t,s){return new Promise((s,i)=>{e.createWriter(e=>{e.onwrite=()=>s(e),e.onerror=e=>i(e),e.write(t)})})}createDirectory(e,t){return new Promise((s,i)=>{e.getDirectory(t,{create:!0},e=>{s(e)},e=>i(e))})}}class FallbackFileSystem{getDirectory(e){return Promise.reject(new Error("File system not available in this environment"))}listDirectories(e){return Promise.reject(new Error("File system not available in this environment"))}listAllDirectories(e){return Promise.reject(new Error("File system not available in this environment"))}listFiles(e){return Promise.reject(new Error("File system not available in this environment"))}getFile(e){return Promise.reject(new Error("File system not available in this environment"))}readFileContent(e){return Promise.reject(new Error("File system not available in this environment"))}saveFile(e,t,s){return Promise.reject(new Error("File system not available in this environment"))}createEmptyFile(e,t,s){return Promise.reject(new Error("File system not available in this environment"))}writeFile(e,t,s){return Promise.reject(new Error("File system not available in this environment"))}createDirectory(e,t){return Promise.reject(new Error("File system not available in this environment"))}}let game,gamepad,backgroundMusic,notifications,addonManager,Account={...DEFAULT_ACCOUNT,...JSON.parse(localStorage.getItem("Account")||"{}")};const saveAccount=()=>localStorage.setItem("Account",JSON.stringify(Account)),bootGame=()=>{game&&game.destroy(),game=new Phaser.Game({width:192,height:112,renderer:Account.settings.renderer,scaleMode:Phaser.ScaleManager.SHOW_ALL,crisp:Account.settings.pixelated,antialias:!1,alignV:!1,alignH:!0,enableDebug:!1,failIfMajorPerformanceCaveat:!1,forceSetTimeOut:!1,clearBeforeRender:!0,forceSingleUpdate:!1,maxPointers:0,keyboard:!0,mouse:!1,mouseWheel:!1,mspointer:!1,multiTexture:!1,pointerLock:!1,preserveDrawingBuffer:!1,roundPixels:!0,touch:!1,transparent:!1,parent:"game",state:{create(){game.state.add("Boot",Boot),game.state.start("Boot"),game.recorder=new ScreenRecorder(game)}},...window.GameConfig||{}})};window.onload=bootGame;const addFpsText=()=>{const e=new Text(190,2,"");e.anchor.x=1,game.time.events.loop(100,()=>e.write(`${game.time.fps} (${game.renderer.renderSession.drawCount-1})`))},Audio={pool:{},add:function(e,t=1,s=!1,i=!0){return i&&this.pool[e]||(this.pool[e]=game.add.audio(e)),this.pool[e]},play:function(e,t=1,s=!1,i=!0){if(game)return i&&this.pool[e]||(this.pool[e]=game.add.audio(e)),this.pool[e].play(null,0,t,s,i)},stop:function(e,t){if(game){const s=this.pool[e];return void(s&&(t?s.stop():(s.fadeOut(),s.onFadeComplete.addOnce(()=>s.stop()))))}}};class Gamepad{constructor(e){this.game=e,this.keys=["up","down","left","right","a","b","select","start"],this.held={},this.pressed={},this.released={},this.prevState={},this.keys.forEach(e=>{this.held[e]=!1,this.pressed[e]=!1,this.released[e]=!1,this.prevState[e]=!1}),this.held.any=!1,this.pressed.any=!1,this.released.any=!1,this.prevState.any=!1,this.keyboardMap={up:[Phaser.KeyCode.UP,Phaser.KeyCode.B],down:[Phaser.KeyCode.DOWN,Phaser.KeyCode.F,Phaser.KeyCode.V],left:[Phaser.KeyCode.LEFT,Phaser.KeyCode.D,Phaser.KeyCode.C],right:[Phaser.KeyCode.RIGHT,Phaser.KeyCode.N],a:[Phaser.KeyCode.Z,Phaser.KeyCode.K],b:[Phaser.KeyCode.X,Phaser.KeyCode.J],select:[Phaser.KeyCode.SHIFT,Phaser.KeyCode.TAB,Phaser.KeyCode.SPACEBAR],start:[Phaser.KeyCode.ENTER,Phaser.KeyCode.ESC,Phaser.KeyCode.P]},this.gamepadMap={up:12,down:13,left:14,right:15,a:0,b:1,select:8,start:9},this.signals={pressed:{},released:{}},this.keys.forEach(e=>{this.signals.pressed[e]=new Phaser.Signal,this.signals.released[e]=new Phaser.Signal}),this.signals.pressed.any=new Phaser.Signal,this.signals.released.any=new Phaser.Signal,this.activeTouches=new Map,this.maxTouches=4,this.lastInputSource="none",this.inputDetectionTimeout=null,this.touchControlsVisible=!1,this.setupKeyboard(),this.setupGamepad(),this.setupTouch(),this.setupInputDetection()}setupKeyboard(){this.keyboardState={},this.keys.forEach(e=>{this.keyboardState[e]=!1}),this.keyCodeToAction={};for(const[e,t]of Object.entries(this.keyboardMap))t.forEach(t=>{this.keyCodeToAction[t]=e});const e=[];for(const t of Object.values(this.keyboardMap))e.push(...t);const t=[...new Set(e)];this.game.input.keyboard.addKeyCapture(t),this.game.input.keyboard.onDownCallback=e=>{const t=this.keyCodeToAction[e.keyCode];t&&(this.held[t]=!0,this.keyboardState[t]=!0),this.detectInputSource("keyboard")},this.game.input.keyboard.onUpCallback=e=>{const t=this.keyCodeToAction[e.keyCode];t&&(this.held[t]=!1,this.keyboardState[t]=!1)}}setupGamepad(){this.game.input.gamepad.supported&&(this.game.input.gamepad.start(),this.gamepadState={},this.keys.forEach(e=>{this.gamepadState[e]=!1}),this.game.input.gamepad.onDownCallback=e=>{this.keys.forEach(t=>{this.gamepadMap[t]==e&&(this.held[t]=!0,this.gamepadState[t]=!0,this.detectInputSource("gamepad"))})},this.game.input.gamepad.onUpCallback=e=>{this.keys.forEach(t=>{this.gamepadMap[t]==e&&(this.held[t]=!1,this.gamepadState[t]=!1)})})}setupTouch(){this.controllerElement=document.getElementById("controller"),this.controllerElement&&(this.dpadElements={up:document.getElementById("controller_up"),down:document.getElementById("controller_down"),left:document.getElementById("controller_left"),right:document.getElementById("controller_right")},this.buttonElements={a:document.getElementById("controller_a"),b:document.getElementById("controller_b"),select:document.getElementById("controller_select"),start:document.getElementById("controller_start"),rhythm_up:document.getElementById("controller_rhythm_up"),rhythm_down:document.getElementById("controller_rhythm_down"),rhythm_left:document.getElementById("controller_rhythm_left"),rhythm_right:document.getElementById("controller_rhythm_right")},this.setupControllerTouchEvents(),this.updateTouchControlsVisibility())}setupInputDetection(){document.addEventListener("touchstart",e=>{e.target.closest("#controller")||this.detectInputSource("touch")},{passive:!0}),document.addEventListener("mousedown",e=>{this.game.device.touch&&!e.target.closest("#controller")&&this.detectInputSource("touch")},{passive:!0})}detectInputSource(e){this.lastInputSource!==e&&(this.lastInputSource=e,this.inputDetectionTimeout&&clearTimeout(this.inputDetectionTimeout),this.updateTouchControlsVisibility(),"touch"!==e&&this.game.device.touch&&(this.inputDetectionTimeout=setTimeout(()=>{this.lastInputSource===e&&(this.lastInputSource="none",this.updateTouchControlsVisibility())},1e4)))}updateTouchControlsVisibility(){if(!this.controllerElement)return;const e=this.game.device.touch&&("touch"===this.lastInputSource||"none"===this.lastInputSource);e!==this.touchControlsVisible&&(this.controllerElement.style.display=e?"block":"none",this.touchControlsVisible=e)}setupControllerTouchEvents(){const e=this.controllerElement,t=e=>e.preventDefault();e.addEventListener("touchstart",t,{passive:!1}),e.addEventListener("touchmove",t,{passive:!1}),e.addEventListener("touchend",t,{passive:!1}),e.addEventListener("touchcancel",t,{passive:!1}),e.addEventListener("touchstart",e=>this.handleTouchStart(e)),e.addEventListener("touchmove",e=>this.handleTouchMove(e)),e.addEventListener("touchend",e=>this.handleTouchEnd(e)),e.addEventListener("touchcancel",e=>this.handleTouchEnd(e))}handleTouchStart(e){const t=e.changedTouches;for(let e=0;e<t.length;e++){const s=t[e];if(this.activeTouches.size>=this.maxTouches)continue;const i=this.getButtonFromTouch(s);if(i){this.activeTouches.set(s.identifier,i),this.held[i.replace("rhythm_","")]=!0,this.detectInputSource("touch");const e=this.dpadElements[i]||this.buttonElements[i];e&&e.classList.add("btnPressed")}}}handleTouchMove(e){const t=e.changedTouches;for(let e=0;e<t.length;e++){const s=t[e],i=this.activeTouches.get(s.identifier);if(void 0!==i){const e=this.getButtonFromTouch(s);if(e&&e!==i){this.held[i.replace("rhythm_","")]=!1,this.held[e.replace("rhythm_","")]=!0;const t=this.dpadElements[i]||this.buttonElements[i],a=this.dpadElements[e]||this.buttonElements[e];t&&t.classList.remove("btnPressed"),a&&a.classList.add("btnPressed"),this.activeTouches.set(s.identifier,e)}else if(!e){this.held[i.replace("rhythm_","")]=!1;const e=this.dpadElements[i]||this.buttonElements[i];e&&e.classList.remove("btnPressed")}}}}handleTouchEnd(e){const t=e.changedTouches;for(let e=0;e<t.length;e++){const s=t[e],i=this.activeTouches.get(s.identifier);if(void 0!==i){this.held[i.replace("rhythm_","")]=!1;const e=this.dpadElements[i]||this.buttonElements[i];e&&e.classList.remove("btnPressed"),this.activeTouches.delete(s.identifier)}}}getButtonFromTouch(e){const t=document.elementFromPoint(e.clientX,e.clientY);if(!t)return null;const s=t.closest('[id^="controller_"]');if(!s)return null;const i=s.id.replace("controller_","");return this.keys.includes(i)||i.startsWith("rhythm_")?i:null}update(){if(this.dontUpdateThisTime)return void delete this.dontUpdateThisTime;this.updateButtonStates();let e=null,t=null;this.keys.forEach(s=>{this.pressed[s]&&(this.signals.pressed[s].dispatch(),e=s),this.released[s]&&(this.signals.released[s].dispatch(),t=s)}),e&&this.signals.pressed.any.dispatch(e),t&&this.signals.released.any.dispatch(t),this.keys.forEach(e=>{this.prevState[e]=this.held[e]}),this.prevState.any=this.held.any}isTouchControlled(e){return Array.from(this.activeTouches.values()).includes(e)}updateButtonStates(){let e=!1,t=!1,s=!1;this.keys.forEach(i=>{this.pressed[i]=this.held[i]&&!this.prevState[i],this.released[i]=!this.held[i]&&this.prevState[i],this.pressed[i]&&(e=!0),this.released[i]&&(t=!0),this.held[i]&&(s=!0)}),this.pressed.any=e,this.released.any=t,this.held.any=s}releaseAll(){this.keys.forEach(e=>{this.held[e]=!1,this.pressed[e]=!1,this.released[e]=!1}),this.held.any=!1,this.pressed.any=!1,this.released.any=!1}press(e){this.dontUpdateThisTime=!0,this.pressed[e]=!0,this.pressed.any=!0,this.held[e]=!0,this.held.any=!0}isDirectionPressed(){return this.held.up||this.held.down||this.held.left||this.held.right}getDirection(){let e=0,t=0;return this.held.left&&(e-=1),this.held.right&&(e+=1),this.held.up&&(t-=1),this.held.down&&(t+=1),0!==e&&0!==t&&(e*=.7071,t*=.7071),{x:e,y:t}}reset(){this.releaseAll(),this.activeTouches.clear(),Object.values(this.dpadElements).forEach(e=>e?.classList.remove("btnPressed")),Object.values(this.buttonElements).forEach(e=>e?.classList.remove("btnPressed"))}destroy(){this.inputDetectionTimeout&&clearTimeout(this.inputDetectionTimeout),this.keyboardKeys&&Object.values(this.keyboardKeys).forEach(e=>{e.forEach(e=>{e.onDown.removeAll(),e.onUp.removeAll()})}),this.game.input.gamepad&&(this.game.input.gamepad.onConnectCallback=null,this.game.input.gamepad.onDisconnectCallback=null),this.signals&&(Object.values(this.signals.pressed).forEach(e=>e?.removeAll()),Object.values(this.signals.released).forEach(e=>e?.removeAll())),this.controllerElement&&this.controllerElement.remove(),this.activeTouches?.clear()}}class ScreenRecorder{constructor(e){this.game=e,this.mediaRecorder=null,this.recordedBlobs=[],this.isRecording=!1,this.stream=null,this.videoBitsPerSecond=11e5,this.videoFrameRate=25,this.scale=1,this.imageScale=7,this.canvas=e.canvas,this.canvas.captureStream||console.error("Canvas captureStream is not supported in this browser")}async start(e=null,t=0){if(this.isRecording)console.warn("Already recording");else if(this.canvas.captureStream)try{this.scaledCanvas=document.createElement("canvas"),this.scaledCanvas.width=this.canvas.width*this.scale,this.scaledCanvas.height=this.canvas.height*this.scale,this.scaledContext=this.scaledCanvas.getContext("2d"),this.scaledContext.imageSmoothingEnabled=!1,this.scaledContext.webkitImageSmoothingEnabled=!1,this.scaledContext.mozImageSmoothingEnabled=!1,this.stream=this.scaledCanvas.captureStream(this.videoFrameRate),e&&await this.addAudioToStream(e,t);let s={mimeType:"video/webm; codecs=vp9",videoBitsPerSecond:this.videoBitsPerSecond};MediaRecorder.isTypeSupported(s.mimeType)||(s={mimeType:"video/webm; codecs=vp8",videoBitsPerSecond:this.videoBitsPerSecond},MediaRecorder.isTypeSupported(s.mimeType)||(s={mimeType:"video/webm",videoBitsPerSecond:this.videoBitsPerSecond})),this.mediaRecorder=new MediaRecorder(this.stream,s),this.recordedBlobs=[],this.mediaRecorder.ondataavailable=e=>{e.data&&e.data.size>0&&this.recordedBlobs.push(e.data)},this.mediaRecorder.onstop=()=>{this.save(),this.cleanup()},this.mediaRecorder.onerror=e=>{console.error("MediaRecorder error:",e.error),this.isRecording=!1,this.cleanup()},this.mediaRecorder.start(1e3),this.isRecording=!0,this.startRenderingLoop(),console.log(`Started recording with MIME type: ${s.mimeType}, audio delay: ${t}ms`)}catch(e){console.error("MediaRecorder init failed:",e),this.cleanup()}else console.error("Screen recording not supported in this browser")}startRenderingLoop(){const e=()=>{this.isRecording&&this.scaledCanvas&&this.scaledContext&&(this.scaledContext.fillStyle="#000000",this.scaledContext.fillRect(0,0,this.scaledCanvas.width,this.scaledCanvas.height),this.scaledContext.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,0,0,this.scaledCanvas.width,this.scaledCanvas.height),requestAnimationFrame(e))};e()}stop(){if(this.isRecording&&this.mediaRecorder)try{this.mediaRecorder.stop(),this.isRecording=!1,console.log("Stopped recording")}catch(e){console.error("Error stopping recorder:",e),this.cleanup()}else console.warn("Not recording")}pause(){this.isRecording&&this.mediaRecorder&&"recording"===this.mediaRecorder.state&&(this.mediaRecorder.pause(),console.log("Recording paused"))}resume(){this.isRecording&&this.mediaRecorder&&"paused"===this.mediaRecorder.state&&(this.mediaRecorder.resume(),console.log("Recording resumed"))}screenshot(){const e=document.createElement("canvas");e.width=this.game.width*this.imageScale,e.height=this.game.height*this.imageScale;const t=e.getContext("2d");t.imageSmoothingEnabled=!1,t.webkitImageSmoothingEnabled=!1,t.mozImageSmoothingEnabled=!1,t.fillStyle="#000000",t.fillRect(0,0,e.width,e.height);const s=this.game.add.renderTexture(this.game.width,this.game.height,"screenshotTemp");s.renderXY(this.game.world,0,0,!0);const i=s.getCanvas();t.drawImage(i,0,0,this.game.width,this.game.height,0,0,e.width,e.height),e.toBlob(async e=>{const t=`screenshot-${Date.now()}.png`;await this.saveFile(t,e),console.log("Screenshot saved:",t)},"image/png"),s.destroy()}async save(e){if(0===this.recordedBlobs.length)return void console.warn("No recording data available");const t=new Blob(this.recordedBlobs,{type:"video/webm"});e||(e=`recording_${Date.now()}.webm`),await this.saveFile(e,t),console.log("Recording saved as:",e)}async saveFile(e,t){if(CURRENT_ENVIRONMENT===ENVIRONMENT.CORDOVA||CURRENT_ENVIRONMENT===ENVIRONMENT.NWJS){const s=new FileSystemTools,i="Screenshots",a=await s.getDirectory(EXTERNAL_DIRECTORY+i);await s.saveFile(a,t,e)}else{const s=window.URL.createObjectURL(t),i=document.createElement("a");i.style.display="none",i.href=s,i.download=e,document.body.appendChild(i),i.click(),setTimeout(()=>{document.body.removeChild(i),window.URL.revokeObjectURL(s)},100)}}async addAudioToStream(e=null,t=0){try{if(e&&e.src){if(t>0&&(console.log(`Applying audio delay: ${t}ms`),e.currentTime>0&&(e.currentTime=Math.max(0,e.currentTime-t/1e3)),await new Promise(e=>setTimeout(e,t))),e.paused){console.warn("Audio element is paused, attempting to play it");try{await e.play()}catch(e){console.warn("Could not play audio element:",e)}}if(e.captureStream){const t=e.captureStream();if(await new Promise(e=>setTimeout(e,100)),t&&t.getAudioTracks().length>0)return t.getAudioTracks().forEach(e=>{console.log("Adding audio track:",e),this.stream.addTrack(e)}),console.log("Game audio added to recording"),!0;console.warn("Audio stream has no audio tracks")}else console.warn("Audio element does not support captureStream")}console.log("Falling back to microphone audio");return(await navigator.mediaDevices.getUserMedia({audio:!0})).getAudioTracks().forEach(e=>{this.stream.addTrack(e)}),console.log("Microphone audio added to recording"),!0}catch(e){return console.warn("Could not add audio to recording:",e),!1}}async addAudioAfterStart(e=null,t=0){if(!this.isRecording||!this.mediaRecorder)return console.warn("Cannot add audio - recording not started"),!1;this.mediaRecorder.pause();try{const s=await this.addAudioToStream(e,t);return this.mediaRecorder.resume(),s}catch(e){return console.error("Error adding audio after start:",e),this.mediaRecorder.resume(),!1}}cleanup(){this.isRecording=!1,this.stream&&(this.stream.getTracks().forEach(e=>e.stop()),this.stream=null),this.scaledCanvas&&(this.scaledCanvas=null,this.scaledContext=null),this.mediaRecorder=null}static isSupported(){return!(!HTMLCanvasElement.prototype.captureStream||!window.MediaRecorder)}getState(){return this.mediaRecorder?this.mediaRecorder.state:"inactive"}setScale(e){this.scale=e,console.log(`Scale factor set to: ${this.scale}`)}getScale(){return this.scale}}class Metronome{constructor(e){this.scene=e,this.player=e.player,this.mode=Account.settings.metronome,this.enabled="OFF"!==this.mode,this.beatDivisions={OFF:0,Quarters:1,Eighths:2,Sixteenths:4,"Thirty-seconds":8,Note:"Note"},this.lastDivisionValue=-1,this.currentDivision=this.beatDivisions[this.mode],this.noteIndex=0,this.lastNoteBeat=-1,this.notes=[],this.scene.onSelectPressed=this.toggle.bind(this)}update(){this.enabled&&("Note"===this.mode?this.updateNoteMode():this.updateBeatMode())}updateBeatMode(){if(0===this.currentDivision)return;const{beat:e}=this.scene.getCurrentTime(),t=this.getCurrentDivisionValue(e);t!==this.lastDivisionValue&&(this.playTick(),this.lastDivisionValue=t)}updateNoteMode(){const{beat:e}=this.scene.getCurrentTime(),t=e;if(0===this.notes.length&&this.initializeNotes(),this.noteIndex>=this.notes.length)return;const s=this.notes[this.noteIndex];if(t>=s)for(this.playTick(),this.lastNoteBeat=s,this.noteIndex++;this.noteIndex<this.notes.length&&this.notes[this.noteIndex]===this.lastNoteBeat;)this.noteIndex++}initializeNotes(){const e=this.scene.song.chart.difficulties[this.scene.song.difficultyIndex],t=`${e.type}${e.rating}`,s=this.scene.song.chart.notes[t];if(!s)return void(this.notes=[]);const i=new Set;for(const e of s)if("1"===e.type||"2"===e.type||"4"===e.type){const t=Math.round(1e3*e.beat)/1e3;i.add(t)}this.notes=Array.from(i).sort((e,t)=>e-t),this.noteIndex=0,this.lastNoteBeat=-1}getCurrentDivisionValue(e){return 0===this.currentDivision?-1:Math.floor(e*this.currentDivision)}playTick(){Audio.play("assist_tick")}toggle(){"OFF"!=this.mode&&(this.enabled=!this.enabled,this.lastDivisionValue=-1,this.resetNoteMode())}resetNoteMode(){this.noteIndex=0,this.lastNoteBeat=-1,this.notes=[]}setMode(e){this.beatDivisions.hasOwnProperty(e)&&(this.mode=e,this.currentDivision=this.beatDivisions[e],this.lastDivisionValue=-1,this.resetNoteMode(),this.enabled="OFF"!==e,Account.settings.metronome=e,saveAccount())}destroy(){this.enabled=!1,this.lastDivisionValue=-1,this.resetNoteMode(),this.statusText&&(this.statusText.destroy(),this.statusText=null)}}class BackgroundMusic{constructor(){this.audio=document.createElement("audio"),this.audio.volume=[0,25,50,75,100][Account.settings.volume]/100,this.randomSong=Account.settings.randomSong,this.audio.loop=!0,this.isPlaying=!1,this.currentSong=null,this.availableSongsCache=null,this.cacheTimestamp=0,this.cacheDuration=3e4,this.registerVisibilityChangeListener()}registerVisibilityChangeListener(){this.visibilityChangeListener=()=>{document.hidden?this.audio.pause():this.audio.play()},window.addEventListener("visibilitychange",this.visibilityChangeListener)}async playLastSong(){if(this.isPlaying||!Account.settings.enableMenuMusic)return;if(this.randomSong||!Account.lastSong)return void this.playRandomSong();const e=Account.lastSong;if(e.isExternal)try{await this.checkUrlAccessible(e.url),this.playSong(e)}catch(e){console.warn("Last external song not accessible, falling back to random song:",e),this.playRandomSong()}else this.playSong(e)}playRandomSong(){const e=this.getCachedAvailableSongs();if(0===e.length)return;const t=game.rnd.pick(e),s={url:t.audioUrl,title:t.title||t.chart?.title||"Unknown",artist:t.artist||t.chart?.artist||"Unknown",sampleStart:t.sampleStart||t.chart?.sampleStart||0,isExternal:void 0!==t.files||void 0!==t.chart?.files};this.playSong(s)}getCachedAvailableSongs(){const e=Date.now();return this.availableSongsCache&&e-this.cacheTimestamp<this.cacheDuration||(this.availableSongsCache=this.getAllAvailableSongsFast(),this.cacheTimestamp=e),this.availableSongsCache}getAllAvailableSongsFast(){const e=[],t=new Set;if(window.localSongs&&window.localSongs.length>0)for(const s of window.localSongs)s.audioUrl&&this.isValidAudioUrl(s.audioUrl)&&(t.has(s.audioUrl)||(t.add(s.audioUrl),e.push(s)));if(window.externalSongs&&window.externalSongs.length>0)for(const s of window.externalSongs)s.audioUrl&&this.isValidAudioUrl(s.audioUrl)&&(t.has(s.audioUrl)||(t.add(s.audioUrl),e.push(s)));const s=game.state.getCurrentState();if(s&&s.songs&&Array.isArray(s.songs))for(const i of s.songs)i.audioUrl&&this.isValidAudioUrl(i.audioUrl)&&(t.has(i.audioUrl)||(t.add(i.audioUrl),e.push(i)));return e}isValidAudioUrl(e){return!!e&&("string"==typeof e&&(!e.includes("assets/no-")&&("undefined"!==e&&"null"!==e&&0!==e.trim().length)))}async checkUrlAccessible(e){return new Promise((t,s)=>{if(!e)return void s();if(e.startsWith("blob:"))return void t();const i=document.createElement("audio");i.preload="metadata",i.onloadedmetadata=()=>{i.remove(),t()},i.onerror=()=>{i.remove(),s(new Error("Audio load failed"))},setTimeout(()=>{i.remove(),s(new Error("Audio load timeout"))},800),i.src=e})}playSong(e){this.audio.pause(),this.audio.currentTime=0,this.audio.src=e.url,this.audio.currentTime=e.sampleStart||0,this.audio.play().then(()=>{if(this.isPlaying=!0,this.currentSong=e,notifications){e.title,e.artist}}).catch(t=>{console.warn(`Failed to play background music: ${e.title}`,t),this.removeSongFromCache(e.url),setTimeout(()=>{this.playRandomSong()},100)})}removeSongFromCache(e){this.availableSongsCache&&(this.availableSongsCache=this.availableSongsCache.filter(t=>t.audioUrl!==e))}stop(){this.audio.pause(),this.audio.currentTime=0,this.isPlaying=!1,this.currentSong=null}setVolume(e){this.audio.volume=[0,25,50,75,100][e]/100}refreshCache(){this.availableSongsCache=null,this.cacheTimestamp=0}destroy(){this.stop(),this.audio.src="",this.audio=null,window.removeEventListener("visibilitychange",this.visibilityChangeListener),this.availableSongsCache=null}}class Visualizer{constructor(e,t,s,i,a){this.scene=e,this.x=t,this.y=s,this.width=i,this.height=a,this.graphics=e.add.graphics(t,s),this.active=!0}update(){}destroy(){this.graphics.destroy()}clear(){this.graphics.clear()}}class AccuracyVisualizer extends Visualizer{constructor(e,t,s,i,a){super(e,t,s,i,a),this.accuracyHistory=[],this.maxHistoryLength=this.width/4}update(){if(this.active&&this.scene.player&&(this.clear(),this.accuracyHistory=this.scene.player.timingStory,this.accuracyHistory.length>this.maxHistoryLength&&this.accuracyHistory.shift(),this.graphics.lineStyle(1,15790320,.3),this.graphics.moveTo(0,3),this.graphics.lineTo(this.width,3),this.accuracyHistory.length>1)){this.graphics.lineStyle(1,65280,1),this.graphics.moveTo(0,3);for(let e=0;e<this.accuracyHistory.length;e++){const t=e/this.maxHistoryLength*this.width,s=2+this.accuracyHistory[e]/.4*3;this.graphics.lineTo(t,s)}}}}class AudioVisualizer extends Visualizer{constructor(e,t,s,i,a){super(e,t,s,i,a),this.audioContext=null,this.analyser=null,this.dataArray=null,this.bufferLength=32,this.bars=[],this.setupAudioAnalysis()}setupAudioAnalysis(){try{if(this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=64,this.analyser.maxDecibels=-10,this.analyser.smoothingTimeConstant=.1,this.bufferLength=this.analyser.frequencyBinCount,this.dataArray=new Uint8Array(this.bufferLength),this.scene.audio){this.audioContext.createMediaElementSource(this.scene.audio).connect(this.analyser),this.analyser.connect(this.audioContext.destination)}}catch(e){console.warn("Audio visualizer not supported:",e),this.active=!1}}update(){if(!this.active||!this.analyser)return;this.clear(),this.analyser.getByteFrequencyData(this.dataArray);const e=this.width/this.bufferLength*2;let t=0;for(let s=0;s<this.bufferLength/2;s++){const i=this.dataArray[s]/255*this.height;i>0&&(this.graphics.lineStyle(e-1,255,.9),this.graphics.moveTo(t,this.height-1),this.graphics.lineTo(t,this.height-i)),t+=e}}destroy(){super.destroy(),this.audioContext&&this.audioContext.close()}}class BPMVisualizer extends Visualizer{constructor(e,t,s,i,a){super(e,t,s,i,a),this.bpmChanges=e.song?.chart?.bpmChanges||[],this.stops=e.song?.chart?.stops||[],this.text=new Text(i-1,1,""),this.text.anchor.x=1,this.text.alpha=.5,this.graphics.addChild(this.text),this.beatIndicatorAlpha=1,this.currentBeat=0,this.currentBeatInt=0,this.previusBeatInt=1,this.currentBpm=0,this.previusBpm=1}update(){if(!this.active)return;this.clear();const e=this.scene.getCurrentTime();this.currentBeat=e.beat,this.currentBeatInt=Math.floor(this.currentBeat),this.currentBeatInt!=this.previusBeatInt&&(this.beatIndicatorAlpha=1),this.previusBeatInt=this.currentBeatInt,this.currentBpm=this.getLastBpm(),this.currentBpm!=this.previusBpm&&(this.text.write(`${this.currentBpm}`),this.text.alpha=1,game.add.tween(this.text).to({alpha:.5},100,"Linear",!0)),this.text.tint=this.getLastStop()&&this.getLastStop().beat==this.currentBeat?16711680:16777215,this.previusBpm=this.currentBpm;Math.max(...this.bpmChanges.map(e=>e.beat),this.currentBeat+50);this.bpmChanges.forEach(e=>{const t=(e.beat-this.currentBeat)/8*this.width;t>=0&&t<=this.width&&(this.graphics.beginFill(16776960,.8),this.graphics.drawRect(t-1,0,1,this.height),this.graphics.endFill())}),this.stops.forEach(e=>{const t=(e.beat-this.currentBeat)/8*this.width;t>=0&&t<=this.width&&(this.graphics.beginFill(16711680,.8),this.graphics.drawRect(t-1,0,1,this.height),this.graphics.endFill())}),this.graphics.beginFill(65280,this.beatIndicatorAlpha),this.graphics.drawCircle(3,3,4),this.graphics.endFill();let t=Math.min(250,this.currentBpm)/250*.5;this.beatIndicatorAlpha-=t}getLastBpm(){return this.bpmChanges.length?this.bpmChanges.find((e,t,s)=>t+1==s.length||s[t+1].beat>=this.currentBeat).bpm:0}getLastStop(){return this.stops.length?this.stops.find((e,t,s)=>t+1==s.length||s[t+1].beat>=this.currentBeat):null}destroy(){super.destroy(),this.text.destroy()}}class FullScreenAudioVisualizer{constructor(e,t={}){this.audioElement=e,this.options={barColor:7797982,barWidth:4,barSpacing:2,barBaseHeight:10,barMaxHeight:80,smoothing:.8,alpha:1,fftSize:256,visualizationType:"circular",...t},this.graphics=game.add.graphics(0,0),this.analyser=null,this.dataArray=null,this.bufferLength=0,this.frequencyData=null,this.isActive=!1,this.setupAudioAnalysis()}setupAudioAnalysis(){try{this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext)),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=this.options.fftSize,this.analyser.smoothingTimeConstant=this.options.smoothing,this.analyser.minDecibels=-90,this.analyser.maxDecibels=-10,this.bufferLength=this.analyser.frequencyBinCount,this.dataArray=new Uint8Array(this.bufferLength),this.frequencyData=new Uint8Array(this.bufferLength),this.audioElement&&this.connectAudioSource(),this.isActive=!0}catch(e){console.warn("FullScreenAudioVisualizer: Audio analysis not supported:",e),this.isActive=!1}}connectAudioSource(){if(this.audioElement&&this.analyser)try{this.source&&this.source.disconnect(),this.source=this.audioContext.createMediaElementSource(this.audioElement),this.source.connect(this.analyser),this.analyser.connect(this.audioContext.destination)}catch(e){console.warn("FullScreenAudioVisualizer: Could not connect audio source:",e)}}setAudioSource(e){this.audioElement=e,this.isActive&&this.connectAudioSource()}update(){if(!this.isActive||!this.analyser)return;this.graphics.clear(),this.graphics.alpha=this.options.alpha,this.analyser.getByteFrequencyData(this.dataArray);const e=Math.floor(this.bufferLength/2);if(this.frequencyData){for(let t=0;t<e;t++)this.frequencyData[t]=Math.max(this.frequencyData[t]*this.options.smoothing,this.dataArray[t]);for(let t=e;t<this.bufferLength;t++)this.frequencyData[t]=0}else this.frequencyData=new Uint8Array(this.dataArray);switch(this.options.visualizationType){case"bars":default:this.drawBars();break;case"waveform":this.drawWaveform();break;case"circular":this.drawCircularVisualizer();break;case"symmetrical":this.drawSymmetricalBars()}}drawBars(){const e=Math.floor(game.width/(this.options.barWidth+this.options.barSpacing)),t=(game.width-e*(this.options.barWidth+this.options.barSpacing))/2,s=Math.floor(this.bufferLength/2);for(let i=0;i<e;i++){const a=Math.floor(i/e*s);if(a>=s)continue;const n=(this.frequencyData[a]||0)/255,r=this.options.barBaseHeight+n*this.options.barMaxHeight,o=t+i*(this.options.barWidth+this.options.barSpacing),h=game.height-r;this.drawBar(o,h,this.options.barWidth,r,n)}}drawSymmetricalBars(){const e=Math.floor(game.width/(this.options.barWidth+this.options.barSpacing)),t=Math.floor(e/2),s=game.width/2,i=Math.floor(this.bufferLength/2);for(let e=0;e<t;e++){const a=Math.floor(e/t*i);if(a>=i)continue;const n=(this.frequencyData[a]||0)/255,r=this.options.barBaseHeight+n*this.options.barMaxHeight,o=s+e*(this.options.barWidth+this.options.barSpacing),h=game.height-r;this.drawBar(o,h,this.options.barWidth,r,n);const l=s-(e+1)*(this.options.barWidth+this.options.barSpacing),c=game.height-r;this.drawBar(l,c,this.options.barWidth,r,n)}}drawWaveform(){const e=new Uint8Array(this.bufferLength);this.analyser.getByteTimeDomainData(e),this.graphics.lineStyle(2,this.options.barColor,.8);const t=game.width/this.bufferLength;let s=0;for(let i=0;i<this.bufferLength;i++){const a=e[i]/128*game.height/2;0===i?this.graphics.moveTo(s,a):this.graphics.lineTo(s,a),s+=t}}drawCircularVisualizer(){const e=game.width/2,t=game.height/2,s=.3*Math.min(game.width,game.height),i=Math.floor(this.bufferLength/2);this.graphics.lineStyle(2,this.options.barColor,.8);for(let a=0;a<i;a+=2){const n=this.frequencyData[a]/255,r=a/i*Math.PI*2,o=n*s*.5,h=e+Math.cos(r)*s,l=t+Math.sin(r)*s,c=e+Math.cos(r)*(s+o),d=t+Math.sin(r)*(s+o);this.graphics.moveTo(h,l),this.graphics.lineTo(c,d)}}drawBar(e,t,s,i,a){const n=this.options.barColor,r=.3+.7*a,o=(n>>16&255)*r,h=(n>>8&255)*r,l=(255&n)*r,c=Math.floor(o)<<16|Math.floor(h)<<8|Math.floor(l);if(this.graphics.beginFill(c,.8),this.graphics.drawRect(e,t,s,i),this.graphics.endFill(),a>.5){const n=.4*(a-.5);this.graphics.beginFill(16777215,n),this.graphics.drawRect(e,t,s,Math.max(2,.1*i)),this.graphics.endFill()}}setVisualizationType(e){["bars","waveform","circular","symmetrical"].includes(e)?this.options.visualizationType=e:(console.warn(`Invalid visualization type: ${e}. Using 'bars' instead.`),this.options.visualizationType="bars")}setBarColor(e){this.options.barColor=e}setAlpha(e){this.options.alpha=Phaser.Math.clamp(e,0,1)}setOptions(e){this.options={...this.options,...e},this.analyser&&(e.fftSize&&(this.analyser.fftSize=e.fftSize,this.bufferLength=this.analyser.frequencyBinCount,this.dataArray=new Uint8Array(this.bufferLength),this.frequencyData=new Uint8Array(this.bufferLength)),void 0!==e.smoothing&&(this.analyser.smoothingTimeConstant=e.smoothing)),e.visualizationType&&this.setVisualizationType(e.visualizationType)}getSettings(){return{...this.options}}isReady(){return this.isActive&&null!==this.analyser}pause(){this.isActive=!1}resume(){this.isActive=!0}destroy(){this.isActive=!1,this.source&&this.source.disconnect(),this.analyser&&this.analyser.disconnect(),this.audioContext&&"closed"!==this.audioContext.state&&this.audioContext.close().catch(e=>{console.warn("Error closing audio context:",e)}),this.graphics&&this.graphics.destroy(),this.audioElement=null,this.analyser=null,this.source=null,this.audioContext=null,this.dataArray=null,this.frequencyData=null}static create(e,t={}){return new FullScreenAudioVisualizer(e,t)}static isSupported(){return!(!window.AudioContext&&!window.webkitAudioContext)}}class SMFile{static generateSMContent(e){let t="";if(t+=`#TITLE:${e.title||""};\n`,t+=`#SUBTITLE:${e.subtitle||""};\n`,t+=`#ARTIST:${e.artist||""};\n`,t+=`#TITLETRANSLIT:${e.titleTranslit||""};\n`,t+=`#SUBTITLETRANSLIT:${e.subtitleTranslit||""};\n`,t+=`#ARTISTTRANSLIT:${e.artistTranslit||""};\n`,t+=`#GENRE:${e.genre||""};\n`,t+=`#CREDIT:${e.credit||""};\n`,t+=`#BANNER:${this.getFilename(e.banner)};\n`,t+=`#BACKGROUND:${this.getFilename(e.background)};\n`,t+=`#LYRICSPATH:${this.getFilename(e.lyrics)};\n`,t+=`#CDTITLE:${this.getFilename(e.cdtitle)};\n`,t+=`#MUSIC:${this.getFilename(e.audio)};\n`,t+=`#OFFSET:${e.offset||0};\n`,t+=`#SAMPLESTART:${e.sampleStart||0};\n`,t+=`#SAMPLELENGTH:${e.sampleLength||10};\n`,e.bpmChanges&&e.bpmChanges.length>0?t+=`#BPMS:${e.bpmChanges.map(e=>`${e.beat.toFixed(3)}=${e.bpm.toFixed(3)}`).join(",")};\n`:t+="#BPMS:0.000=120.000;\n",e.stops&&e.stops.length>0?t+=`#STOPS:${e.stops.map(e=>`${e.beat.toFixed(3)}=${e.len.toFixed(3)}`).join(",")};\n`:t+="#STOPS:;\n",e.backgrounds&&e.backgrounds.length>0){const s=e.backgrounds.map(e=>`${e.beat.toFixed(3)}=${e.file||""}=${e.opacity||1}=${e.fadeIn||0}=${e.fadeOut||0}=${e.effect||0}`).join(",");t+=`#BGCHANGES:${s};\n`}else t+="#BGCHANGES:;\n";return e.difficulties&&e.notes&&e.difficulties.forEach(s=>{const i=s.type+s.rating,a=e.notes[i];a&&(t+=this.generateNotesSection(s,a))}),t}static getFilename(e){if(!e||"no-media"===e)return"";const t=e.split(/[\\/]/);return t[t.length-1]||""}static generateNotesSection(e,t){let s="#NOTES:\n";s+="     dance-single:\n",s+="     :\n",s+=`     ${e.type}:\n`,s+=`     ${e.rating}:\n`,s+="     0.000000:\n";const i={};let a=4;t.forEach(e=>{const t=Math.floor(e.beat/4);i[t]||(i[t]=[]),i[t].push(e);const s=e.beat-Math.floor(e.beat);if(s>0){const e=this.findRequiredResolution(s);a=Math.max(a,e)}});const n=Object.keys(i).map(Number).sort((e,t)=>e-t),r=a;return n.forEach(e=>{const t=i[e],a=this.convertMeasureToSM(t,e,r);s+=a}),s+=";\n",s}static findRequiredResolution(e){const t=[4,8,12,16,24,32,48,64,96,192];for(const s of t){const t=Math.round(e*s)/s;if(Math.abs(e-t)<.001)return s}return 192}static convertMeasureToSM(e,t,s){const i=[],a=4*t,n=4/s;for(let e=0;e<s;e++)i.push("0000");return e.forEach(e=>{const t=e.beat-a,r=Math.round(t/n);if(r>=0&&r<s){const t=i[r].split("");let s="0";switch(e.type){case"1":s="1";break;case"2":s="2";break;case"3":s="3";break;case"4":s="4";break;case"M":s="M"}t[e.column]=s,i[r]=t.join("")}}),i.join(",\n")+",\n"}static parseSMContent(e,t=""){let s=e.replace(/\/\/.*/g,"").replace(/\r?\n|\r/g,"").split(";");for(let e=s.length-1;e>=0;e-=1)if(s[e]){s[e]=s[e].split(/:/g);for(let t in s[e])s[e][t]=s[e][t].trim()}else s.splice(e,1);let i={};const a={bpmChanges:[],stops:[],notes:{},backgrounds:[],banner:"no-media",difficulties:[],background:"no-media",cdtitle:null,audioUrl:null,videoUrl:null,sampleStart:0,sampleLength:10,baseUrl:t};for(let e in s){let n=s[e];switch(n[0]){case"#TITLE":a.title=n[1];break;case"#SUBTITLE":a.subtitle=n[1];break;case"#ARTIST":a.artist=n[1];break;case"#TITLETRANSLIT":a.titleTranslit=n[1];break;case"#SUBTITLETRANSLIT":a.subtitleTranslit=n[1];break;case"#ARTISTTRANSLIT":a.artistTranslit=n[1];break;case"#GENRE":a.genre=n[1];break;case"#CREDIT":a.credit=n[1];break;case"#BANNER":n[1]&&(a.banner=this.resolveFileUrl(n[1],t));break;case"#BACKGROUND":n[1]&&(a.background=this.resolveFileUrl(n[1],t));break;case"#MUSIC":n[1]&&(a.audio=n[1],a.audioUrl=this.resolveFileUrl(n[1],t));break;case"#OFFSET":a.offset=Number(n[1]);break;case"#BPMS":{let e=n[1].split(",");e=e.filter(e=>/=/.exec(e));for(let t in e){let s=e[t].split("=");e[t]={beat:Number(s[0]),bpm:Number(s[1])}}a.bpmChanges=a.bpmChanges.concat(e);break}case"#STOPS":{let e=n[1].split(",");e=e.filter(e=>e.includes("="));for(let t in e){let s=e[t].split("=");e[t]={beat:Number(s[0]),len:Number(s[1])}}a.stops=a.stops.concat(e);break}case"#NOTES":i[n[3]+n[4]]=n[6].split(","),a.difficulties.push({type:n[3],rating:n[4]})}}for(let e in i)a.notes[e]=this.parseNotes(i[e],a.bpmChanges,a.stops);return a}static resolveFileUrl(e,t){return e?e.startsWith("http")||e.startsWith("//")?e:t+e:null}static parseNotes(e,t,s){const i=[];let a=0;const n=(e,t,s)=>4*e+t/s*4,r=e=>(new LocalSMParser).beatToSec(t,s,e);for(let t in e){const s=e[t].trim();if(!s)continue;const o=s.length/4;for(let e=0;e<o;e++){const t=s.substr(4*e,4);for(let h=0;h<4;h++){const l=t[h];if("0"!==l){const t=n(a,e,o),c={type:l,beat:t,sec:r(t),column:h};if("2"===l||"4"===l){let i=!1;for(let l=e+1;l<o&&!i;l++){if("3"===s.substr(4*l+h,1)){const e=n(a,l,o);c.beatLength=e-t,c.secLength=r(e)-r(t),c.beatEnd=e,c.secEnd=r(e),i=!0}}}i.push(c)}}}a++}return i}}class LocalSMParser{constructor(){this.baseUrl=""}async parseSM(e,t){this.baseUrl=t.endsWith("/")?t:t+"/";let s={};if(e.includes("#VERSION:"))return this.parseSSC(e,t);let i=e.replace(/\/\/.*/g,"").replace(/\r?\n|\r/g,"").split(";");for(let e=i.length-1;e>=0;e-=1)if(i[e]){i[e]=i[e].split(/:/g);for(let t in i[e])i[e][t]=i[e][t].trim()}else i.splice(e,1);let a={};s.bpmChanges=[],s.stops=[],s.notes={},s.backgrounds=[],s.banner="no-media",s.difficulties=[],s.background="no-media",s.cdtitle=null,s.audioUrl=null,s.videoUrl=null,s.sampleStart=0,s.sampleLength=10,s.baseUrl=t;for(let e in i){let t=i[e];switch(t[0]){case"#TITLE":s.title=t[1];break;case"#SUBTITLE":s.subtitle=t[1];break;case"#ARTIST":s.artist=t[1];break;case"#TITLETRANSLIT":s.titleTranslit=t[1];break;case"#SUBTITLETRANSLIT":s.subtitleTranslit=t[1];break;case"#ARTISTTRANSLIT":s.artistTranslit=t[1];break;case"#GENRE":s.genre=t[1];break;case"#CREDIT":s.credit=t[1];break;case"#BGCHANGES":t[1]&&t[1].split(",").forEach(e=>{if(!(e=e.trim()))return;const t=e.split("=").filter(e=>""!==e);if(t.length<6)return;const i={beat:parseFloat(t[0]),file:t[1],opacity:parseFloat(t[2]),fadeIn:parseInt(t[3])||0,fadeOut:parseInt(t[4])||0,effect:parseInt(t[5])||0,type:"image",startTime:0,duration:0};if(i.file){const e=i.file.split(".").pop().toLowerCase();i.type=["mp4","avi","mov"].includes(e)?"video":"image",i.url=this.resolveFileUrl(i.file)}t.length>6&&(i.duration=parseFloat(t[6])||0,i.startTime=parseFloat(t[7])||0),s.backgrounds.push(i)});break;case"#BANNER":t[1]&&(s.banner=this.resolveFileUrl(t[1]));break;case"#CDTITLE":t[1]&&(s.cdtitle=this.resolveFileUrl(t[1]));break;case"#LYRICSPATH":t[1]&&(s.lyrics=this.resolveFileUrl(t[1]));break;case"#SAMPLESTART":t[1]&&(s.sampleStart=parseFloat(t[1]));break;case"#SAMPLELENGTH":t[1]&&(s.sampleLength=parseFloat(t[1]));break;case"#BACKGROUND":t[1]&&(s.background=this.resolveFileUrl(t[1]));break;case"#VIDEO":t[1]&&(s.videoUrl=this.resolveFileUrl(t[1]));break;case"#MUSIC":t[1]&&(s.audio=t[1],s.audioUrl=this.resolveFileUrl(t[1]));break;case"#OFFSET":s.offset=Number(t[1]);break;case"#BPMS":{let e=t[1].split(",");e=e.filter(e=>/=/.exec(e));for(let t in e){let s=e[t].split("=");e[t]={beat:Number(s[0]),bpm:Number(s[1])}}s.bpmChanges=s.bpmChanges.concat(e);break}case"#STOPS":{let e=t[1].split(",");e=e.filter(e=>e.includes("="));for(let t in e){let s=e[t].split("=");e[t]={beat:Number(s[0]),len:Number(s[1])}}s.stops=s.stops.concat(e);break}case"#NOTES":a[t[3]+t[4]]=t[6].split(","),s.difficulties.push({type:t[3],rating:t[4]})}}if(s.bpmChanges.sort((e,t)=>e.beat-t.beat),0!==s.bpmChanges[0].beat)throw`No starting bpm, first bpm change is ${s.bpmChanges[0]}`;s.bpmChanges[0].sec=0;for(let e=1;e<s.bpmChanges.length;e++)s.bpmChanges[e].sec=this.beatToSec(s.bpmChanges,s.stops,s.bpmChanges[e].beat);for(let e=0;e<s.stops.length;e++)s.stops[e].sec=this.beatToSec(s.bpmChanges,s.stops,s.stops[e].beat);for(let e in a){let t=[null,null,null,null];s.notes[e]=[];for(let i in a[e]){if(a[e][i]=a[e][i].trim(),a[e][i].length%4)throw`Invalid length on measure ${i}, length is ${a[e][i].length}`;a[e][i]=a[e][i].match(/(.{4})/g);let n=a[e][i].length;for(let r in a[e][i]){let o=a[e][i][r],h=[{},{},{},{}],l=4*i+r/n*4;for(let i=0;i<h.length;i++){switch(o[i]){case"3":if(null==t[i])throw"hold end without any hold before";{let a=s.notes[e][t[i]];a.beatEnd=l,a.beatLength=l-a.beat,a.secEnd=this.beatToSec(s.bpmChanges,s.stops,l),a.secLength=this.beatToSec(s.bpmChanges,s.stops,l)-this.beatToSec(s.bpmChanges,s.stops,a.beat)}t[i]=null;case"0":h[i]=null;continue;case"4":case"2":if(t[i])throw"new hold started before last ended";t[i]=s.notes[e].length+i;case"1":case"M":h[i].type=o[i];break;default:throw`invalid note type ${o[i]}`}h[i].beat=l,h[i].sec=this.beatToSec(s.bpmChanges,s.stops,l),h[i].column=i}s.notes[e]=s.notes[e].concat(h)}}s.notes[e]=s.notes[e].filter(e=>null!==e)}return s}resolveFileUrl(e){return e?e.startsWith("http")||e.startsWith("//")?e:this.baseUrl+e:null}getLastBpm(e,t,s){return e.find((e,i,a)=>i+1==a.length||a[i+1][s]>=t)}beatToSec(e,t,s){let i=this.getLastBpm(e,s,"beat"),a=(s-i.beat)/i.bpm*60+i.sec,n=t.filter(({beat:e})=>e>=i.beat&&e<s).map(e=>e.len);for(let e in n)a+=n[e];return a}parseSSC(e,t){const s={bpmChanges:[],stops:[],notes:{},backgrounds:[],banner:"no-media",difficulties:[],background:"no-media",cdtitle:null,audioUrl:null,videoUrl:null,sampleStart:0,sampleLength:10,baseUrl:t},i=e.split(/\/\/-+/)[0].split("\n");for(let e of i)if(e.startsWith("#")){const[t,...i]=e.slice(1).split(":"),a=i.join(":").trim();switch(t){case"TITLE":s.title=a;break;case"ARTIST":s.artist=a;break;case"BANNER":s.banner=this.resolveFileUrl(a);break;case"BACKGROUND":s.background=this.resolveFileUrl(a);break;case"MUSIC":s.audio=a,s.audioUrl=this.resolveFileUrl(a)}}return s}}class ExternalSMParser{parseSM(e,t){let s={};if(t.includes("#VERSION:"))return this.parseSSC(e,t);let i=t.replace(/\/\/.*/g,"").replace(/\r?\n|\r/g,"").split(";");for(let e=i.length-1;e>=0;e-=1)if(i[e]){i[e]=i[e].split(/:/g);for(let t in i[e])i[e][t]=i[e][t].trim()}else i.splice(e,1);let a={};s.bpmChanges=[],s.stops=[],s.notes={},s.backgrounds=[],s.banner="no-media",s.difficulties=[],s.background="no-media",s.cdtitle=null,s.audioUrl=null,s.videoUrl=null,s.files=e,s.sampleStart=0,s.sampleLength=10;for(let t in i){let n=i[t];switch(n[0]){case"#TITLE":s.title=n[1];break;case"#SUBTITLE":s.subtitle=n[1];break;case"#ARTIST":s.artist=n[1];break;case"#TITLETRANSLIT":s.titleTranslit=n[1];break;case"#SUBTITLETRANSLIT":s.subtitleTranslit=n[1];break;case"#ARTISTTRANSLIT":s.artistTranslit=n[1];break;case"#GENRE":s.genre=n[1];break;case"#CREDIT":s.credit=n[1];break;case"#BGCHANGES":n[1]&&n[1].split(",").forEach(t=>{if(!(t=t.trim()))return;const i=t.split("=").filter(e=>""!==e);if(i.length<6)return;const a={beat:parseFloat(i[0]),file:i[1],opacity:parseFloat(i[2]),fadeIn:parseInt(i[3])||0,fadeOut:parseInt(i[4])||0,effect:parseInt(i[5])||0,type:"image",startTime:0,duration:0};if(a.file){const t=a.file.split(".").pop().toLowerCase();if(a.type=["mp4","avi","mov"].includes(t)?"video":"image",e[a.file.toLowerCase()]){const t=e[a.file.toLowerCase()];a.url=t.localURL?t.localURL:URL.createObjectURL(t),a.url=a.url.replace("cdvfile://","file://").replace("localhost/persistent/","/storage/emulated/0/")}}i.length>6&&(a.duration=parseFloat(i[6])||0,a.startTime=parseFloat(i[7])||0),s.backgrounds.push(a)});break;case"#BANNER":if(n[1]&&e[n[1].toLowerCase()]){const t=e[n[1].toLowerCase()];s.banner=t.localURL?t.localURL:URL.createObjectURL(t),s.banner=s.banner.replace("cdvfile://","file://").replace("localhost/persistent/","/storage/emulated/0/")}break;case"#CDTITLE":if(n[1]&&e[n[1].toLowerCase()]){const t=e[n[1].toLowerCase()];s.cdtitle=t.localURL?t.localURL:URL.createObjectURL(t),s.cdtitle=s.cdtitle.replace("cdvfile://","file://").replace("localhost/persistent/","/storage/emulated/0/")}break;case"#SAMPLESTART":n[1]&&(s.sampleStart=parseFloat(n[1]));break;case"#SAMPLELENGTH":n[1]&&(s.sampleLength=parseFloat(n[1]));break;case"#BACKGROUND":if(n[1]&&e[n[1].toLowerCase()]){const t=e[n[1].toLowerCase()];s.background=t.localURL?t.localURL:URL.createObjectURL(t),s.background=s.background.replace("cdvfile://","file://").replace("localhost/persistent/","/storage/emulated/0/")}break;case"#VIDEO":if(n[1]&&e[n[1].toLowerCase()]){const t=e[n[1].toLowerCase()];s.videoUrl=t.localURL?t.localURL:URL.createObjectURL(t),s.videoUrl=s.videoUrl.replace("cdvfile://","file://").replace("localhost/persistent/","/storage/emulated/0/")}break;case"#LYRICSPATH":if(n[1]&&e[n[1].toLowerCase()]){const t=e[n[1].toLowerCase()];s.lyrics=t.localURL?t.localURL:URL.createObjectURL(t),s.lyrics=s.lyrics.replace("cdvfile://","file://").replace("localhost/persistent/","/storage/emulated/0/")}break;case"#MUSIC":if(n[1]&&(s.audio=n[1],e[n[1].toLowerCase()])){const t=e[n[1].toLowerCase()];s.audioUrl=t.localURL?t.localURL:URL.createObjectURL(t),s.audioUrl=s.audioUrl.replace("cdvfile://","file://").replace("localhost/persistent/","/storage/emulated/0/")}break;case"#OFFSET":s.offset=Number(n[1]);break;case"#BPMS":{let e=n[1].split(",");e=e.filter(e=>/=/.exec(e));for(let t in e){let s=e[t].split("=");e[t]={beat:Number(s[0]),bpm:Number(s[1])}}s.bpmChanges=s.bpmChanges.concat(e);break}case"#STOPS":{let e=n[1].split(",");e=e.filter(e=>e.includes("="));for(let t in e){let s=e[t].split("=");e[t]={beat:Number(s[0]),len:Number(s[1])}}s.stops=s.stops.concat(e);break}case"#NOTES":a[n[3]+n[4]]=n[6].split(","),s.difficulties.push({type:n[3],rating:n[4]})}}if(s.bpmChanges.sort((e,t)=>e.beat-t.beat),0===s.bpmChanges.length||0!==s.bpmChanges[0].beat)throw"No starting bpm";s.bpmChanges[0].sec=0;for(let e=1;e<s.bpmChanges.length;e++)s.bpmChanges[e].sec=this.beatToSec(s.bpmChanges,s.stops,s.bpmChanges[e].beat);for(let e=0;e<s.stops.length;e++)s.stops[e].sec=this.beatToSec(s.bpmChanges,s.stops,s.stops[e].beat);for(let e in a){let t=[null,null,null,null];s.notes[e]=[];for(let i in a[e]){if(a[e][i]=a[e][i].trim(),a[e][i].length%4)throw`Invalid length on measure ${i}, length is ${a[e][i].length}`;a[e][i]=a[e][i].match(/(.{4})/g);let n=a[e][i].length;for(let r in a[e][i]){let o=a[e][i][r],h=[{},{},{},{}],l=4*i+r/n*4;for(let i=0;i<h.length;i++){switch(o[i]){case"3":if(null==t[i])throw"hold end without any hold before";{let a=s.notes[e][t[i]];a.beatEnd=l,a.beatLength=l-a.beat,a.secEnd=this.beatToSec(s.bpmChanges,s.stops,l),a.secLength=this.beatToSec(s.bpmChanges,s.stops,l)-this.beatToSec(s.bpmChanges,s.stops,a.beat)}t[i]=null;case"0":h[i]=null;continue;case"4":case"2":if(t[i])throw"new hold started before last ended";t[i]=s.notes[e].length+i;case"1":case"M":h[i].type=o[i];break;default:throw`invalid note type ${o[i]}`}h[i].beat=l,h[i].sec=this.beatToSec(s.bpmChanges,s.stops,l),h[i].column=i}s.notes[e]=s.notes[e].concat(h)}}s.notes[e]=s.notes[e].filter(e=>null!==e)}return s}parseSSC(e,t){const s=t.split(/\/\/-+/),i=s[0],a=s.slice(1),n={bpmChanges:[],stops:[],notes:{},backgrounds:[],banner:"no-media",difficulties:[],background:"no-media",cdtitle:null,audioUrl:null,videoUrl:null,files:e,sampleStart:0,sampleLength:10},r={};if(i.split("\n").filter(e=>e.trim().startsWith("#")).forEach(e=>{const[t,...s]=e.slice(1).split(":");let i=s.join(":").trim().replace(/;+$/,"");["BPMS","STOPS","BGCHANGES"].includes(t)&&(i=i.split(",").map(e=>e.trim()).join(",")),r[t]=i}),r.MUSIC&&e[r.MUSIC.toLowerCase()]){const t=e[r.MUSIC.toLowerCase()];n.audioUrl=t.localURL?t.localURL:URL.createObjectURL(t),n.audio=r.MUSIC}if(Object.assign(n,{title:r.TITLE||"",subtitle:r.SUBTITLE||"",artist:r.ARTIST||"",titleTranslit:r.TITLETRANSLIT||"",subtitleTranslit:r.SUBTITLETRANSLIT||"",artistTranslit:r.ARTISTTRANSLIT||"",genre:r.GENRE||"",credit:r.CREDIT||"",offset:Number(r.OFFSET)||0,sampleStart:Number(r.SAMPLESTART)||0,sampleLength:Number(r.SAMPLELENGTH)||10}),r.BANNER&&e[r.BANNER.toLowerCase()]){const t=e[r.BANNER.toLowerCase()];n.banner=t.localURL?t.localURL:URL.createObjectURL(t)}if(r.BACKGROUND&&e[r.BACKGROUND.toLowerCase()]){const t=e[r.BACKGROUND.toLowerCase()];n.background=t.localURL?t.localURL:URL.createObjectURL(t)}if(r.BPMS){const e=r.BPMS.split(",").map(e=>{const[t,s]=e.split("=");return{beat:Number(t),bpm:Number(s)}});n.bpmChanges=e}if(r.STOPS){const e=r.STOPS.split(",").map(e=>{const[t,s]=e.split("=");return{beat:Number(t),len:Number(s)}});n.stops=e}if(n.bpmChanges.length>0){n.bpmChanges.sort((e,t)=>e.beat-t.beat),n.bpmChanges[0].sec=0;for(let e=1;e<n.bpmChanges.length;e++)n.bpmChanges[e].sec=this.beatToSec(n.bpmChanges,n.stops,n.bpmChanges[e].beat);for(let e=0;e<n.stops.length;e++)n.stops[e].sec=this.beatToSec(n.bpmChanges,n.stops,n.stops[e].beat)}return a.forEach(e=>{const t=e.split("\n").filter(e=>""!==e.trim()),s={};let i=!1,a=[];if(t.forEach(e=>{if(e.startsWith("#")){if(e.startsWith("#NOTES"))i=!0;else if(!e.startsWith("#NOTEDATA")&&!e.startsWith("#CHARTNAME")){const[t,...i]=e.slice(1).split(":"),a=i.join(":").trim().replace(/;+$/,"");s[t]=a}}else i&&(";"===e.trim()?i=!1:a.push(e.trim()))}),s.DIFFICULTY&&s.METER){const e=`${s.DIFFICULTY}${s.METER}`;n.difficulties.push({type:s.DIFFICULTY,rating:s.METER}),n.notes[e]=this.convertSSCNotes(a,n.bpmChanges,n.stops)}}),n}convertSSCNotes(e,t,s){const i=[];let a=0;return e.forEach(e=>{const n=e.split("\n").filter(e=>""!==e.trim()),r=n.length;n.forEach((e,n)=>{const o=4*a+n/r*4;for(let a=0;a<4&&a<e.length;a++){const n=e[a];if("0"!==n&&"3"!==n){const e={type:n,beat:o,sec:this.beatToSec(t,s,o),column:a};i.push(e)}}}),a++}),i}getLastBpm(e,t,s){return e.find((e,i,a)=>i+1==a.length||a[i+1][s]>=t)}beatToSec(e,t,s){if(!e||0===e.length)return s;let i=this.getLastBpm(e,s,"beat"),a=(s-i.beat)/i.bpm*60+i.sec,n=t.filter(({beat:e})=>e>=i.beat&&e<s).map(e=>e.len);for(let e in n)a+=n[e];return a}}class AddonManager{constructor(){this.addons=new Map,this.enabledAddons=new Set,this.hibernatingAddons=new Set,this.safeMode=!1,this.isInitialized=!1}async initialize(){if(!this.isInitialized){if(this.safeMode=Account.settings?.safeMode||!1,this.enabledAddons=new Set(Account.settings?.enabledAddons||[]),this.hibernatingAddons=new Set(Account.settings?.hibernatingAddons||[]),this.safeMode)return console.log("🔒 Addon Safe Mode enabled - skipping addon loading"),void(this.isInitialized=!0);await this.loadAddons(),this.isInitialized=!0}}async loadAddons(){try{console.log("📦 Loading addons..."),await this.loadAddonsFromStorage(),await this.processAddons()}catch(e){console.error("Error loading addons:",e)}}async loadAddonsFromStorage(){const e=new FileSystemTools;try{const t=await e.getDirectory(EXTERNAL_DIRECTORY+"Addons"),s=await e.listDirectories(t);console.log(`Found ${s.length} addon directories`);for(const t of s)try{await this.loadAddonFromDirectory(t,e)}catch(e){console.warn(`Failed to load addon from ${t.name}:`,e)}}catch(e){console.log("No external addons directory found")}}async loadAddonFromDirectory(e,t){const s=await t.listFiles(e),i={};for(const e of s){const s=await t.getFile(e);i[s.name.toLowerCase()]={entry:e,file:s,name:s.name}}const a=i["manifest.json"];if(!a)throw new Error("No manifest.json found");const n=await t.readFileContent(a.file),r=JSON.parse(n);if(!r.id||!r.name||!r.version)throw new Error("Invalid manifest: missing required fields");const o={id:r.id,name:r.name,version:r.version,icon:r.icon,author:r.author||"Unknown",description:r.description||"",manifest:r,directory:e,dir:e,files:i,assets:[],behaviors:{},isEnabled:this.enabledAddons.has(r.id)&&!this.hibernatingAddons.has(r.id),isHibernating:this.hibernatingAddons.has(r.id)};r.icon&&(o.icon=o.dir.nativeURL+r.icon),this.processAddonAssets(o),this.addons.set(o.id,o),console.log(`📦 Loaded addon: ${o.name} v${o.version} (${o.isEnabled?"enabled":"disabled"})`)}async processAddons(){for(const[e,t]of this.addons)if(t.isEnabled)try{await this.processAddonBehaviors(t)}catch(e){console.error(`Failed to process addon ${t.name}:`,e)}}processAddonAssets(e){const t=e.manifest.assets;if(!t)return;const s={};window.gameResources.forEach(e=>s[e.key]=e);for(const[i,a]of Object.entries(t)){const t=e.dir.nativeURL+a;e.assets;s[i]?e.assets.push({...s[i],key:i,url:t}):e.assets.push({type:"image",key:i,url:t})}}async processAddonBehaviors(e){const t=e.manifest.behaviors;if(t)for(const[s,i]of Object.entries(t)){const t=e.dir.nativeURL+i,a=await this.loadTextFile(t);e.behaviors[s]={content:a,stateName:s}}}async loadTextFile(e){return new Promise((t,s)=>{const i=new XMLHttpRequest;i.open("GET",e),i.onload=()=>{200===i.status?t(i.responseText):t(null)},i.onerror=()=>t(null),i.send()})}async readFileContent(e){return new Promise((t,s)=>{const i=new FileReader;i.onload=()=>t(i.result),i.onerror=()=>s(i.error),i.readAsText(e)})}executeBehavior(e,t,s,i){const a=e.behaviors[t];if(a)try{const t={global:s.global,game:game,state:s.state,addon:e,console:console,...i||{}};new Function(...Object.keys(t),`${a.content}`).call(s.global||window,...Object.values(t))}catch(s){console.error(`Error executing behavior for ${e.name} in ${t}:`,s)}}executeGlobalBehaviors(){for(const[e,t]of this.addons)!t.isHibernating&&t.isEnabled&&this.executeBehavior(t,"Global",{game:game,global:window})}executeStateBehaviors(e,t,s){for(const[i,a]of this.addons)!a.isHibernating&&a.isEnabled&&this.executeBehavior(a,e,{game:game,global:t,state:t,stateName:e,extraParams:s})}parseVersion(e){const t=e.split(".").map(e=>parseInt(e,10)||0);for(;t.length<3;)t.push(0);return t}compareVersions(e,t){for(let s=0;s<3;s++){if(e[s]>t[s])return 1;if(e[s]<t[s])return-1}return 0}enableAddon(e){const t=this.addons.get(e);return!!t&&(t.isEnabled=!0,this.enabledAddons.add(e),this.hibernatingAddons.delete(e),this.saveAddonSettings(),!0)}disableAddon(e){const t=this.addons.get(e);return!!t&&(t.isEnabled=!1,this.enabledAddons.delete(e),this.saveAddonSettings(),!0)}hibernateAddon(e){const t=this.addons.get(e);return!!t&&(t.isEnabled=!1,t.isHibernating=!0,this.enabledAddons.delete(e),this.hibernatingAddons.add(e),this.saveAddonSettings(),!0)}wakeAddon(e){const t=this.addons.get(e);return!(!t||!t.isHibernating)&&(t.isEnabled=!0,t.isHibernating=!1,this.enabledAddons.add(e),this.hibernatingAddons.delete(e),this.saveAddonSettings(),!0)}uninstallAddon(e){const t=this.addons.get(e);return!!t&&(t.dir.removeRecursively(),this.addons.delete(e),!0)}setSafeMode(e){this.safeMode=e,Account.settings.safeMode=e,saveAccount()}getAddonList(){return Array.from(this.addons.values()).map(e=>({id:e.id,name:e.name,version:e.version,author:e.author,description:e.description,isEnabled:e.isEnabled,isHibernating:e.isHibernating,icon:e.icon,assets:e.assets,behaviors:e.behaviors,hasAssets:Object.keys(e.assets).length>0,hasBehaviors:Object.keys(e.behaviors).length>0}))}getResourceList(){let e=[];return Array.from(this.addons.values()).forEach(t=>{!t.isHibernating&&t.isEnabled&&(e=[...e,...t.assets])}),e}saveAddonSettings(){Account.settings.enabledAddons=Array.from(this.enabledAddons),Account.settings.hibernatingAddons=Array.from(this.hibernatingAddons),Account.settings.safeMode=this.safeMode,saveAccount()}needsReload(){const e=new Set(Account.settings?.enabledAddons||[]),t=new Set(Account.settings?.hibernatingAddons||[]),s=Account.settings?.safeMode||!1;return!this.setsEqual(e,this.enabledAddons)||!this.setsEqual(t,this.hibernatingAddons)||s!==this.safeMode}setsEqual(e,t){if(e.size!==t.size)return!1;for(const s of e)if(!t.has(s))return!1;return!0}}class Boot{preload(){this.load.baseURL="assets/",this.keys=[],Object.keys(FONTS).forEach(e=>{const t=FONTS[e];this.load.spritesheet(t.font,`fonts/${e}.png`,t.fontWidth||4,t.fontHeight||6)}),WINDOW_PANELS.forEach(e=>{this.load.spritesheet(`ui_window_${e}`,`ui/window_${e}.png`,8,8),this.keys.push(`ui_window_${e}`)})}create(){gamepad=new Gamepad(game),notifications=new NotificationSystem,game.time.advancedTiming=!0,game.world.updateOnlyExistingChildren=!0,game.onMenuIn=new Phaser.Signal,game.state.add("Load",Load),game.state.add("LoadCordova",LoadCordova),game.state.add("LoadAddons",LoadAddons),game.state.add("LoadLocalSongs",LoadLocalSongs),game.state.add("LoadExternalSongs",LoadExternalSongs),game.state.add("LoadSongFolder",LoadSongFolder),game.state.add("Title",Title),game.state.add("MainMenu",MainMenu),game.state.add("SongSelect",SongSelect),game.state.add("CharacterSelect",CharacterSelect),game.state.add("Play",Play),game.state.add("Results",Results),game.state.add("Jukebox",Jukebox),game.state.add("Credits",Credits),window.primaryAssets=this.keys,window.gameResources=[{key:"ui_loading_dots",url:"ui/loading_dots.png",type:"spritesheet",frameWidth:26,frameHeight:6},{key:"ui_background_gradient",url:"ui/background_gradient.png"},{key:"ui_logo_shape",url:"ui/logo_shape.png"},{key:"ui_hud_background",url:"ui/hud_background.png"},{key:"ui_lobby_background",url:"ui/lobby_background.png"},{key:"ui_lobby_overlay",url:"ui/lobby_overlay.png"},{key:"ui_navigation_hint_keyboard",url:"ui/navigation_hint_keyboard.png",type:"spritesheet",frameWidth:192,frameHeight:112},{key:"ui_glitch_animation",url:"ui/glitch_animation.png",type:"spritesheet",frameWidth:192,frameHeight:112},{key:"ui_navigation_hint_gamepad",url:"ui/navigation_hint_gamepad.png",type:"spritesheet",frameWidth:192,frameHeight:112},{key:"ui_difficulty_banner",url:"ui/difficulty_banner.png"},{key:"ui_lifebar",url:"ui/lifebar.png",type:"spritesheet",frameWidth:1,frameHeight:5},{key:"ui_skill_bar",url:"ui/skill_bar.png",type:"spritesheet",frameWidth:2,frameHeight:2},{key:"ui_accuracy_bar",url:"ui/accuracy_bar.png"},{key:"ui_jukebox_pause_toggle",url:"ui/jukebox_pause_toggle.png",type:"spritesheet",frameWidth:12,frameHeight:12},{key:"ui_jukebox_seek",url:"ui/jukebox_seek.png",type:"spritesheet",frameWidth:8,frameHeight:8},{key:"ui_jukebox_skip",url:"ui/jukebox_skip.png",type:"spritesheet",frameWidth:8,frameHeight:8},{key:"ui_jukebox_menu",url:"ui/jukebox_menu.png",type:"spritesheet",frameWidth:8,frameHeight:8},{key:"ui_jukebox_visualization",url:"ui/jukebox_visualization.png",type:"spritesheet",frameWidth:8,frameHeight:8},{key:"assist_tick",type:"audio",url:"sfx/assist_tick.ogg"},{key:"level_up",type:"audio",url:"sfx/level_up.ogg"},{key:"exp_up",type:"audio",url:"sfx/exp_up.ogg"},{key:"arrows",url:"chart/arrows.png",type:"spritesheet",frameWidth:16,frameHeight:16},{key:"receptor",url:"chart/receptor.png",type:"spritesheet",frameWidth:16,frameHeight:16},{key:"explosion",url:"chart/explosion.png",type:"image"},{key:"mineexplosion",url:"chart/mine_explosion.png",type:"image"},{key:"mine",url:"chart/mine.png",type:"spritesheet",frameWidth:16,frameHeight:16},{key:"hold_end",url:"chart/hold_end.png",type:"spritesheet",frameWidth:16,frameHeight:8},{key:"hold_body",url:"chart/hold_body.png",type:"spritesheet",frameWidth:16,frameHeight:112},{key:"roll_end",url:"chart/roll_end.png",type:"spritesheet",frameWidth:16,frameHeight:8},{key:"roll_body",url:"chart/roll_body.png",type:"spritesheet",frameWidth:16,frameHeight:16},{key:"character_base",url:"character/base.png",type:"spritesheet",frameWidth:100,frameHeight:100},{key:"character_eyes",url:"character/eyes.png",type:"spritesheet",frameWidth:100,frameHeight:100},...(()=>{const e=[];for(let t=1;t<=CHARACTER_SYSTEM.HAIR_STYLES.front.length;t++)e.push({key:`character_front_hair_${t}`,url:`character/front_hair_${t}.png`,type:"spritesheet",frameWidth:100,frameHeight:100});for(let t=1;t<=CHARACTER_SYSTEM.HAIR_STYLES.back.length;t++)e.push({key:`character_back_hair_${t}`,url:`character/back_hair_${t}.png`,type:"spritesheet",frameWidth:100,frameHeight:100});return e})(),...(()=>{const e=[];return CHARACTER_ITEMS.clothing.forEach(t=>{e.push({key:`character_clothing_${t.id}`,url:`character/${t.id}.png`,type:"spritesheet",frameWidth:100,frameHeight:100})}),CHARACTER_ITEMS.accessories.forEach(t=>{e.push({key:`character_accessory_${t.id}`,url:`character/${t.id}.png`,type:"spritesheet",frameWidth:100,frameHeight:100})}),e})(),{key:"character_noise",url:"ui/character_noise.png",type:"spritesheet",frameWidth:36,frameHeight:7}],window.addEventListener("keydown",e=>{if("INPUT"!==document.activeElement.tagName)switch(e.code){case"F8":e.preventDefault(),game.recorder&&game.recorder.screenshot();break;case"F9":e.preventDefault(),game.recorder.isRecording?game.recorder.stop():game.recorder.start();break;case"F10":e.preventDefault(),window.recordNextGame=!0}}),game.state.start("Load",!0,!1,window.gameResources,"LoadCordova")}}class Load{init(e,t,s){this.resources=e||[],this.nextState=t||"Title",this.nextStateParams=s||{},this.loadedCount=0,this.totalCount=this.resources.length}preload(){this.resources.forEach(e=>{switch(e.type){case void 0:case"image":this.load.image(e.key,e.url);break;case"spritesheet":this.load.spritesheet(e.key,e.url,e.frameWidth,e.frameHeight);break;case"audio":this.load.audio(e.key,e.url);break;case"video":this.load.video(e.key,e.url,"canplay",!0);break;case"json":this.load.json(e.key,e.url);break;case"text":this.load.text(e.key,e.url)}this.loadedCount++}),this.progressText=new ProgressText("LOADING ASSETS")}create(){game.state.start(this.nextState,!0,!1,this.nextStateParams)}}class LoadCordova{create(){CURRENT_ENVIRONMENT==ENVIRONMENT.CORDOVA?this.loadScript():this.createFolderStructure()}loadScript(){this.loadingDots=new LoadingDots,this.progressText=new ProgressText("INITIALIZING FILESYSTEM");const e=document.createElement("script");e.src="./cordova/cordova.js",document.head.appendChild(e),document.addEventListener("deviceready",()=>{this.createFolderStructure(),document.addEventListener("backbutton",()=>{"Play"==game.state.current?gamepad.press("start"):gamepad.press("b")})})}async createFolderStructure(){if(CURRENT_ENVIRONMENT==ENVIRONMENT.CORDOVA||CURRENT_ENVIRONMENT==ENVIRONMENT.NWJS){const e=new FileSystemTools,t=await e.getDirectory(""),s=await e.createDirectory(t,EXTERNAL_DIRECTORY);await e.createDirectory(s,"Addons"),await e.createDirectory(s,"Screenshots"),await e.createDirectory(s,"Songs")}this.continue()}continue(){game.state.start("LoadAddons")}}class LoadAddons{create(){this.progressText=new ProgressText("LOADING ADD-ONS"),this.loadingDots=new LoadingDots,this.initialize()}async initialize(){addonManager=new AddonManager,await addonManager.initialize(),addonManager.executeGlobalBehaviors();const e=addonManager.getResourceList();game.load.baseURL="",game.state.start("Load",!0,!1,e,"LoadLocalSongs")}}class LoadLocalSongs{create(){this.progressText=new ProgressText("LOADING SONGS"),this.songs=[],this.parser=new LocalSMParser,this.loadSongs(),this.loadingDots=new LoadingDots}async loadSongs(){try{const e=DEFAULT_SONG_FOLDERS;for(const t of e)try{const e=await this.loadSong(t);e&&this.songs.push(e)}catch(e){console.warn(`Failed to load song from ${t}:`,e)}this.finish()}catch(e){console.error("Error loading songs:",e)}}async loadSong(e){const t=`assets/songs/${e}/`;try{let s=t+e+".sm",i=await this.loadTextFile(s);if(!i){const e=["song.sm","chart.sm","steps.sm"];for(const s of e)if(i=await this.loadTextFile(t+s),i)break}if(!i)throw new Error(`No .sm file found in ${e}`);const a=await this.parser.parseSM(i,t);return a.folderName=e,a.loaded=!0,a}catch(t){return console.warn(`Could not load song ${e}:`,t),null}}async loadTextFile(e){return new Promise((t,s)=>{const i=new XMLHttpRequest;i.open("GET",e),i.onload=()=>{200===i.status?t(i.responseText):t(null)},i.onerror=()=>t(null),i.send()})}finish(){window.localSongs=this.songs,game.state.start("Title")}}class LoadExternalSongs{init(e,t){this.nextState=e||"SongSelect",this.nextStateParams=t||[]}create(){if(this.loadingDots=new LoadingDots,this.progressText=new ProgressText("LOADING EXTERNAL SONGS"),this.fileSystem=new FileSystemTools,window.externalSongs)return this.songs=window.externalSongs,void this.finish(window.lastExternalSongIndex||0);this.songs=[],this.parser=new ExternalSMParser,this.loadedCount=0,this.failedCount=0,this.totalCount=0,this.currentlyLoading=new Set,CURRENT_ENVIRONMENT==ENVIRONMENT.CORDOVA||CURRENT_ENVIRONMENT==ENVIRONMENT.NWJS?this.loadSongsFromStorage():this.showFileInput()}async loadSongsFromStorage(){try{console.log("Loading songs from external storage...");const e=await this.fileSystem.getDirectory(EXTERNAL_DIRECTORY+"Songs"),t=await this.fileSystem.listAllDirectories(e);t.unshift(e),this.totalCount=t.length,this.updateProgress(),console.log(`Found ${this.totalCount} directories to scan`),await this.loadDirectoriesSequential(t),this.finish()}catch(e){console.error("Error loading external songs:",e),this.showError("Failed to load external songs: "+e.message)}}async loadDirectoriesParallel(e){const t=[];for(let s=0;s<e.length;s+=16)t.push(e.slice(s,s+16));for(const e of t)await this.processDirectoryBatch(e)}async processDirectoryBatch(e){const t=e.map(e=>this.processSongDirectoryWithTracking(e));await Promise.allSettled(t)}async loadDirectoriesSequential(e){for(const t of e)await this.processSongDirectoryWithTracking(t)}async processSongDirectoryWithTracking(e){const t=e.name||"Unknown Directory";this.currentlyLoading.add(t);try{const s=await this.processSongDirectory(e);s?(this.songs.push(s),this.loadedCount++,console.log(`✓ Loaded: ${s.title||t}`)):(this.failedCount++,console.log(`✗ Failed: ${t} (no valid chart found)`))}catch(e){console.warn(`✗ Error in ${t}:`,e),this.failedCount++}finally{this.currentlyLoading.delete(t),this.updateProgress()}}async processSongDirectory(e){try{const t=await this.fileSystem.listFiles(e),s={};for(const e of t){const t=await this.fileSystem.getFile(e);s[t.name.toLowerCase()]=t}const i=Object.keys(s).filter(e=>e.endsWith(".sm")||e.endsWith(".ssc"));if(0===i.length)return console.log(`No chart files found in ${e.name}`),null;for(const t of i)try{console.log(`Trying to parse ${t} in ${e.name}`);const i=await this.fileSystem.readFileContent(s[t]),a=this.parser.parseSM(s,i);if(a&&a.difficulties&&a.difficulties.length>0)return a.folderName=e.name||"External Song",a.loaded=!0,console.log(`✓ Successfully parsed ${t}`),a}catch(e){console.warn(`Failed to parse ${t}:`,e);continue}return console.log(`No valid chart files in ${e.name}`),null}catch(t){return console.warn(`Error processing directory ${e.name}:`,t),null}}updateProgress(){const e=this.loadedCount+this.failedCount,t=this.totalCount>0?Math.round(e/this.totalCount*100):0,s=`${this.loadedCount}/${this.totalCount-this.failedCount} (${t}%)`;this.progressText.write(s)}showFileInput(){const e=document.createElement("input");e.type="file",e.webkitdirectory=!0,e.multiple=!0,e.onchange=e=>{this.processFileInput(e.target.files)},e.click()}async processFileInput(e){try{const t={};for(let s=0;s<e.length;s++)t[e[s].name.toLowerCase()]=e[s];const s={};for(const t of e){const e=t.webkitRelativePath.split("/")[0];s[e]||(s[e]={}),s[e][t.name.toLowerCase()]=t}const i=Object.keys(s);this.totalCount=i.length,this.updateProgress(),await this.processFileDirectoriesSequential(s,i),this.finish()}catch(e){console.error("Error processing file input:",e),this.showError("Failed to load songs from files: "+e.message)}}async processFileDirectoriesParallel(e,t){const s=[];for(let e=0;e<t.length;e+=16)s.push(t.slice(e,e+16));for(const t of s)await this.processFileDirectoryBatch(e,t)}async processFileDirectoryBatch(e,t){const s=t.map(t=>this.processSongFilesWithTracking(e[t],t));await Promise.allSettled(s)}async processFileDirectoriesSequential(e,t){for(const s of t)await this.processSongFilesWithTracking(e[s],s)}async processSongFilesWithTracking(e,t){this.currentlyLoading.add(t);try{const s=await this.processSongFiles(e,t);s?(this.songs.push(s),this.loadedCount++,console.log(`✓ Loaded: ${s.title||t}`)):(this.failedCount++,console.log(`✗ Failed: ${t} (no valid chart found)`))}catch(e){console.warn(`✗ Error in ${t}:`,e),this.failedCount++}finally{this.currentlyLoading.delete(t),this.updateProgress()}}async processSongFiles(e,t){const s=Object.keys(e).filter(e=>e.endsWith(".sm")||e.endsWith(".ssc"));if(0===s.length)return console.log(`No chart files found in ${t}`),null;for(const i of s)try{console.log(`Trying to parse ${i} in ${t}`);const s=await this.fileSystem.readFileContent(e[i]),a=this.parser.parseSM(e,s);if(a&&a.difficulties&&a.difficulties.length>0)return a.folderName=t,a.loaded=!0,console.log(`✓ Successfully parsed ${i}`),a}catch(e){console.warn(`Failed to parse ${i}:`,e);continue}return console.log(`No valid chart files in ${t}`),null}showError(e){this.progressText.write(e),game.time.events.add(3e3,()=>{game.state.start("MainMenu")})}finish(e=0){console.log(`Loading complete: ${this.loadedCount} songs loaded, ${this.failedCount} failed`),0!==this.songs.length?(window.externalSongs=this.songs,this.nextStateParams.length?game.state.start(this.nextState,!0,!1,...this.nextStateParams):game.state.start(this.nextState,!0,!1,this.songs),setTimeout(()=>window.lastExternalSongIndex=window.selectStartingIndex)):this.showError("No external songs found")}}class LoadSongFolder{create(){this.progressText=new ProgressText("SELECT SONG FOLDER"),this.parser=new ExternalSMParser,this.showFileInput()}showFileInput(){const e=document.createElement("input");e.type="file",e.webkitdirectory=!0,e.multiple=!0,e.onchange=e=>{this.processFiles(e.target.files)},e.webkitdirectory||(e.multiple=!0,this.progressText.write("Select all song files")),e.click()}async processFiles(e){try{this.progressText.write("LOADING SONG...");const t={};for(let s=0;s<e.length;s++)t[e[s].name.toLowerCase()]=e[s];const s=Object.keys(t).filter(e=>e.endsWith(".sm"));if(0===s.length)return void this.showError("No .sm file found in selected folder");const i=s[0],a=await this.readFileContent(t[i]),n=this.parser.parseSM(t,a);n.folderName=`Single_External_${i}`,n.loaded=!0,game.state.start("SongSelect",!0,!1,[n],0,!0)}catch(e){console.error("Error loading song folder:",e),this.showError("Failed to load song")}}readFileContent(e){return new Promise((t,s)=>{const i=new FileReader;i.onload=()=>t(i.result),i.onerror=()=>s(i.error),i.readAsText(e)})}showError(e){this.progressText.write(e),game.time.events.add(3e3,()=>{game.state.start("MainMenu")})}}class Title{create(){game.camera.fadeIn(16777215),this.background=new BackgroundGradient,this.lines=new FuturisticLines,this.logo=new Logo,this.inputInstructionText=new Text(game.width/2,80,"PRESS ANY KEY"),this.inputInstructionText.anchor.x=.5,game.add.tween(this.inputInstructionText).to({alpha:0},500,"Linear",!0,0,-1).yoyo(!0),this.text=game.add.sprite(0,0),this.creditText=new Text(2,110,COPYRIGHT,this.text),this.creditText.anchor.y=1,this.creditText=new Text(190,110,VERSION,this.text),this.creditText.anchor.set(1),backgroundMusic||(backgroundMusic=new BackgroundMusic),backgroundMusic.playLastSong(),this.introEnded=!1,this.logo.intro(()=>this.introEnded=!0),addonManager.executeStateBehaviors(this.constructor.name,this)}update(){gamepad.update(),this.introEnded&&!this.outroStarted&&gamepad.pressed.any&&(this.outroStarted=!0,this.text.alpha=0,this.logo.outro(()=>game.state.start("MainMenu")))}}class MainMenu{create(){game.camera.fadeIn(16777215),this.futuristicLines=new FuturisticLines,this.backgroundGradient=new BackgroundGradient,this.navigationHint=new NavigationHint(0),this.menu(),this.previewCanvas=document.createElement("canvas"),this.previewCtx=this.previewCanvas.getContext("2d"),this.previewImg=new Image,backgroundMusic&&backgroundMusic.isPlaying||(backgroundMusic||(backgroundMusic=new BackgroundMusic),backgroundMusic.playLastSong()),this.keepBackgroundMusic=!1,addonManager.executeStateBehaviors(this.constructor.name,this)}menu(){const e=new WindowManager;this.manager=e;const t=()=>{const e=new CarouselMenu(0,40,112,56,{align:"left",bgcolor:"brown",fgcolor:"#ffffff",animate:!0,crop:!1});e.addItem("Rhythm Game",()=>s()),e.addItem("Character Select",()=>{this.keepBackgroundMusic=!0,game.state.start("CharacterSelect")}),e.addItem("Settings",()=>n()),e.addItem("Extras",()=>r()),game.onMenuIn.dispatch("home",e),CURRENT_ENVIRONMENT!=ENVIRONMENT.CORDOVA&&CURRENT_ENVIRONMENT!=ENVIRONMENT.NWJS||(e.addItem("Exit",()=>u()),e.onCancel.add(()=>u()))},s=()=>{const e=new CarouselMenu(0,40,112,56,{align:"left",bgcolor:"brown",fgcolor:"#ffffff",animate:!0,crop:!1});e.addItem("Free Play",()=>this.freePlay()),e.addItem("Extra Songs",()=>i()),game.onMenuIn.dispatch("startGame",e),e.addItem("< Back",()=>t()),e.onCancel.add(()=>t())},i=()=>{const e=new CarouselMenu(0,40,112,56,{align:"left",bgcolor:"brown",fgcolor:"#ffffff",animate:!0,crop:!1});CURRENT_ENVIRONMENT!=ENVIRONMENT.CORDOVA&&CURRENT_ENVIRONMENT!=ENVIRONMENT.NWJS||e.addItem("User Songs",()=>this.loadExternalSongs()),e.addItem("Load Single Song",()=>this.loadSingleSong()),!window.externalSongs||CURRENT_ENVIRONMENT!=ENVIRONMENT.CORDOVA&&CURRENT_ENVIRONMENT!=ENVIRONMENT.NWJS||e.addItem("Reload User Songs",()=>{backgroundMusic.refreshCache(),window.externalSongs=void 0,this.loadExternalSongs()}),game.onMenuIn.dispatch("extraSongs",e),e.addItem("< Back",()=>t()),e.onCancel.add(()=>t())};let a;const n=()=>{a=e.createWindow(3,1,18,12,"1"),a.fontTint=7797982,a.addSettingItem("Volume",["0%","25%","50%","75%","100%"],Account.settings.volume,e=>{Account.settings.volume=e,saveAccount(),backgroundMusic.audio.volume=[0,25,50,75,100][e]/100}),a.addSettingItem("Auto-play",["OFF","ON"],Account.settings.autoplay?1:0,e=>{Account.settings.autoplay=1===e,saveAccount()});const s=["OFF","Note","Quarters","Eighths","Sixteenths","Thirty-seconds"],i=Account.settings.metronome||"OFF",n=s.indexOf(i);a.addSettingItem("Metronome",s,n,e=>{const t=s[e];Account.settings.metronome=t,saveAccount()});let r=0;r=Account.settings.enableMenuMusic?Account.settings.randomSong?1:0:2;const o=["NONE","BPM","ACCURACY","AUDIO"],h=Account.settings.visualizer||"NONE",u=o.indexOf(h);a.addSettingItem("Visualizer",o,u,e=>{const t=o[e];Account.settings.visualizer=t,saveAccount()}),a.addSettingItem("Scroll Direction",["FALLING","RISING"],"falling"===Account.settings.scrollDirection?0:1,e=>{Account.settings.scrollDirection=0===e?"falling":"rising",saveAccount()});const g=[{value:"NOTE",display:"NOTE"},{value:"VIVID",display:"VIVID"},{value:"FLAT",display:"FLAT"},{value:"RAINBOW",display:"RAINBOW"}],m=Account.settings.noteColorOption||"NOTE",p=g.findIndex(e=>e.value===m);a.addSettingItem("Note Colors",g.map(e=>e.display),p,e=>{const t=g[e].value;Account.settings.noteColorOption=t,saveAccount()}),a.addSettingItem("Note Speed",["Normal","Double","Triple","Insane","Sound Barrier","Light Speed","Faster than light"],Account.settings.noteSpeedMult-1,e=>{Account.settings.noteSpeedMult=e+1,saveAccount()}),a.addSettingItem("Speed Mod",["X-MOD","C-MOD"],"C-MOD"===Account.settings.speedMod?1:0,e=>{Account.settings.speedMod=1===e?"C-MOD":"X-MOD",saveAccount()}),a.addSettingItem("Beat Lines",["YES","NO"],Account.settings.beatLines?0:1,e=>{Account.settings.beatLines=0===e,saveAccount()});const f=[];for(let e=-1e3;e<=1e3;e+=25)f.push(`${e}ms`);const y=((Account.settings.userOffset||0)+1e3)/25;a.addSettingItem("Global Offset",f,y,e=>{const t=25*e-1e3;Account.settings.userOffset=t,saveAccount()}),a.addSettingItem("Menu Music",["LAST SONG","RANDOM SONG","OFF"],r,e=>{switch(e){case 0:Account.settings.randomSong=!1,Account.settings.enableMenuMusic=!0;break;case 1:Account.settings.randomSong=!0,Account.settings.enableMenuMusic=!0;break;case 2:Account.settings.enableMenuMusic=!1}saveAccount()});let b=!1;a.addSettingItem("Renderer",["AUTO","CANVAS","WEBGL"],Account.settings.renderer,e=>{Account.settings.renderer=e,saveAccount(),b=!0}),a.addSettingItem("Pixelated",["YES","NO"],Account.settings.pixelated?0:1,e=>{Account.settings.pixelated=0==e,b=!0,saveAccount()}),a.addSettingItem("Safe Mode",["ENABLED","DISABLED"],Account.settings.safeMode?0:1,e=>{b=!0;const t=0==e;addonManager?.setSafeMode(t),saveAccount()}),a.addItem("Erase Highscores","",()=>l()),game.onMenuIn.dispatch("settings",a),a.addItem("Restore Default Settings","",()=>c()),a.addItem("APPLY","",()=>{e.remove(a,!0),b?d():t()},!0)},r=()=>{const e=new CarouselMenu(0,40,112,56,{align:"left",bgcolor:"brown",fgcolor:"#ffffff",animate:!0,crop:!1});CURRENT_ENVIRONMENT!=ENVIRONMENT.CORDOVA&&CURRENT_ENVIRONMENT!=ENVIRONMENT.NWJS||e.addItem("Addon Manager",()=>this.addonManager()),e.addItem("Offset Assistant",()=>this.startOffsetAssistant()),e.addItem("Jukebox",()=>o()),e.addItem("Credits",()=>this.showCredits()),game.onMenuIn.dispatch("extras",e),e.addItem("< Back",()=>t()),e.onCancel.add(()=>t())},o=()=>{CURRENT_ENVIRONMENT==ENVIRONMENT.CORDOVA||CURRENT_ENVIRONMENT==ENVIRONMENT.NWJS?window.externalSongs?game.state.start("Jukebox"):h("Load extra songs from external storage?",()=>{game.state.start("LoadExternalSongs",!0,!1,"Jukebox",[void 0,void 0])},()=>{game.state.start("Jukebox")}):game.state.start("Jukebox")},h=(t,s,i)=>{e.remove(a,!0);const n=new Text(game.width/2,40,t||"You sure?",FONTS.shaded);n.anchor.x=.5;const r=e.createWindow(10,7,5,4,"1");r.fontTint=7797982,r.offset={x:7,y:0},r.addItem("Yes","",()=>{n.destroy(),e.remove(r,!0),s?.()}),r.addItem("No","",()=>{n.destroy(),e.remove(r,!0),i?.()},!0)},l=()=>h("Permanently erase hight scores?",()=>{Account.highScores={},saveAccount(),n()},()=>n()),c=()=>{h("All settings will be restored to default.\nA refresh is needed",()=>{Account.settings=DEFAULT_ACCOUNT.settings,saveAccount(),window.location.reload()},()=>n())},d=()=>h("Restart Now?",()=>location.reload(),()=>n()),u=()=>h("Sure? Exit?",()=>{switch(CURRENT_ENVIRONMENT){case ENVIRONMENT.CORDOVA:navigator.app.exitApp();break;case ENVIRONMENT.NWJS:nw?.App?.quit?.()}},()=>t());t()}freePlay(){game.state.start("SongSelect",!0,!1,window.localSongs)}startOffsetAssistant(){const e=new OffsetAssistant(game);game.add.existing(e)}loadExternalSongs(){game.state.start("LoadExternalSongs")}loadSingleSong(){game.state.start("LoadSongFolder")}addonManager(){const e=new Text(4,4,""),t=game.add.sprite(112,4),s=()=>{const e=addonManager.getAddonList(),t=new CarouselMenu(96,56,96,56,{align:"left",bgcolor:"brown",fgcolor:"#ffffff",animate:!0,crop:!1});0===e.length?t.addItem("No addons installed",()=>{}):(e.forEach(e=>{const s=e.isHibernating?"gray":e.isEnabled?"#00cc00":"brown";t.addItem(`${e.name} v${e.version}`,()=>n(e),{addon:e,bgcolor:s})}),t.onSelect.add((e,t)=>{t.data&&t.data.addon&&a(t.data.addon)}),a(e[0])),game.onMenuIn.dispatch("addons",t),t.addItem("< Back",()=>r()),t.onCancel.add(()=>r())};let i=!1;const a=s=>{e.write(`${s.name}\nV${s.version}\nBy ${s.author}\nBEHAVIORS:${s.behaviors?Object.keys(s.behaviors).length:0}\nASSETS:${s.assets?s.assets.length:0}\n\n${s.description}\nSTATE: `+(s.isHibernating?"Hybernating":s.isEnabled?"Enabled":"Disabled")+"\n").wrap(112),s.icon&&(this.previewImg.src=s.icon,this.previewImg.onload=()=>{this.previewCtx.drawImage(this.previewImg,0,0,50,50),t.loadTexture(PIXI.Texture.fromCanvas(this.previewCanvas))})},n=e=>{const t=new CarouselMenu(96,56,96,56,{align:"left",bgcolor:"#9b59b6",fgcolor:"#ffffff",animate:!0,crop:!1});e.isHibernating?t.addItem("Wake Addon",()=>{addonManager.wakeAddon(e.id),i=!0,s()}):e.isEnabled?(t.addItem("Disable Addon",()=>{addonManager.disableAddon(e.id),i=!0,s()}),t.addItem("Hibernate Addon",()=>{addonManager.hibernateAddon(e.id),i=!0,s()})):t.addItem("Enable Addon",()=>{addonManager.enableAddon(e.id),i=!0,s()}),t.addItem("Uninstall Addon",()=>o("The addon folder will be removed. Continue?",()=>{addonManager.uninstallAddon(e.id),i=!0,s()},()=>s())),game.onMenuIn.dispatch("addonDetails",t),t.addItem("< Back",()=>s()),t.onCancel.add(()=>s())},r=()=>{i||addonManager.needsReload()?o("Reload required. Restart now?",()=>{location.reload()},()=>{this.menu()}):(t.destroy(),e.destroy(),this.menu())},o=(s,i,a)=>{const n=new Text(game.width/2,40,s||"You sure?",FONTS.shaded);n.anchor.x=.5,t.destroy(),e.destroy();const r=this.manager.createWindow(10,7,5,4,"1");r.fontTint=7797982,r.offset={x:7,y:0},r.addItem("Yes","",()=>{n.destroy(),this.manager.remove(r,!0),i?.()}),r.addItem("No","",()=>{n.destroy(),this.manager.remove(r,!0),a?.()},!0)};s()}showCredits(){game.state.start("Credits",!0,!1,"MainMenu")}update(){gamepad.update(),this.manager?.update()}shutdown(){backgroundMusic&&!this.keepBackgroundMusic&&(backgroundMusic.destroy(),backgroundMusic=null)}}class SongSelect{init(e,t,s){this.songs=e||[],this.songs=e||(window.selectedSongs||[]),window.selectedSongs=this.songs,this.startingIndex=t||(window.selectStartingIndex||0),this.autoSelect=s||!1,this.startingIndex+1>this.songs.length&&(this.startingIndex=0)}create(){game.camera.fadeIn(0),new FuturisticLines,new BackgroundGradient,this.selectedSong=null,this.selectedDifficulty=0,backgroundMusic&&backgroundMusic.stop(),this.previewAudio=document.createElement("audio"),this.previewAudio.volume=[0,25,50,75,100][Account.settings.volume]/100,this.bannerImg=document.createElement("img"),this.cdtitleImg=document.createElement("img"),this.previewCanvas=document.createElement("canvas"),this.previewCtx=this.previewCanvas.getContext("2d"),this.navigationHint=new NavigationHint(2),this.autoplayText=new Text(4,104,""),this.bannerSprite=game.add.sprite(4,4,null),this.metadataText=new Text(102,4,""),this.highScoreText=new Text(104,50,""),this.loadingDots=new LoadingDots,this.loadingDots.visible=!1,this.visibilityChangeListener=()=>{document.hidden?this.previewAudio?.pause():this.previewAudio?.play()},window.addEventListener("visibilitychange",this.visibilityChangeListener),this.createSongSelectionMenu(),this.autoSelect&&(this.selectSong(this.songs[this.songCarousel.selectedIndex],this.songCarousel.selectedIndex),this.songCarousel.destroy(),this.autoSelect=!1),addonManager.executeStateBehaviors(this.constructor.name,this)}createSongSelectionMenu(){const e=game.width/2;this.songCarousel=new CarouselMenu(0,35,e,72,{bgcolor:"#9b59b6",fgcolor:"#ffffff",align:"left",animate:!0,margin:{left:2}}),0===this.songs.length?this.songCarousel.addItem("No songs found",null):this.songs.forEach((e,t)=>{const s=e.titleTranslit||e.title,i=s||`Song ${t+1}`;this.songCarousel.addItem(i,s=>{this.selectSong(e,t)},{song:e,index:t})}),game.onMenuIn.dispatch("songList",this.songCarousel),this.songCarousel.selectedIndex=this.startingIndex,this.songCarousel.updateSelection(),this.songCarousel.onSelect.add((e,t)=>{t.data&&t.data.song&&this.previewSong(t.data.song)}),this.songCarousel.onCancel.add(()=>{game.state.start("MainMenu")}),this.songs.length>0&&this.previewSong(this.songs[this.songCarousel.selectedIndex])}previewSong(e){this.autoSelect||(this.loadingDots.visible=!0);let t=this.songCarousel.selectedIndex;e.audioUrl&&(this.previewAudio.src=e.audioUrl,this.previewAudio.currentTime=e.sampleStart||0,this.previewAudio.play()),e.banner&&(this.bannerImg.src=e.banner,this.bannerImg.onload=()=>{t==this.songCarousel.selectedIndex&&(this.loadingDots.visible=!1),this.previewCtx.drawImage(this.bannerImg,0,0,96,32);const e=PIXI.Texture.fromCanvas(this.previewCanvas);this.bannerSprite.loadTexture(e)},this.bannerImg.onerror=()=>this.loadingDots.visible=!1),this.metadataText.write(this.getMetadataText(e)),this.metadataText.wrapPreserveNewlines(80),this.displayHighScores(e),this.startingIndex=window.selectStartingIndex=this.songCarousel.selectedIndex}displayHighScores(e){const t=this.getSongKey(e),s=Account.highScores[t];if(!s)return void(this.highScoreText&&this.highScoreText.write("NO HIGH SCORES"));let i="HIGH SCORES:\n";e.difficulties.forEach((e,t)=>{const a=`${e.type}${e.rating}`,n=s[a];i+=n?`${e.type}: ${n.score.toLocaleString()} (${n.rating})\n`:`${e.type}: ---\n`}),this.highScoreText.write(i)}getSongKey(e){if(e.folderName)return`local_${e.folderName}`;if(e.audioUrl){let t=0;for(let s=0;s<e.audioUrl.length;s++){t=(t<<5)-t+e.audioUrl.charCodeAt(s),t&=t}return`external_${t.toString(36)}`}return`unknown_${Date.now()}`}getMetadataText(e){const t=e.titleTranslit||e.title,s=e.subtitleTranslit||e.subtitle,i=e.artistTranslit||e.artist,a=(e.genre,e.credit);let n="";return t&&(n+=t+"\n"),s&&(n+=s+"\n"),i&&(n+="Artist: "+i+"\n"),a&&(n+="Credit: "+a),n}selectSong(e,t){this.selectedSong=e,this.selectedDifficulty=0,this.showDifficultySelection(e)}showDifficultySelection(e){const t=game.width/2,s=game.height;this.difficultyCarousel=new CarouselMenu(0,37,t,s,{bgcolor:"#e67e22",fgcolor:"#ffffff",align:"center",animate:!0}),game.onMenuIn.dispatch("difficulty",this.songCarousel),e.difficulties.sort((e,t)=>e.rating-t.rating).forEach((t,s)=>{this.difficultyCarousel.addItem(`${t.type} (${t.rating})`,t=>{this.startGame(e,s)},{difficulty:t,index:s,bgcolor:this.getDifficultyColor(parseInt(t.rating))})}),this.difficultyCarousel.onCancel.add(()=>{this.createSongSelectionMenu()})}getDifficultyColor(e){e=Math.max(0,Math.min(11,e));var t=25,s=210,i=25,a=210,n=0,r=0,o=Math.floor(t+e/11*(a-t)),h=Math.floor(s+e/11*(n-s)),l=Math.floor(i+e/11*(r-i));return`#${Phaser.Color.componentToHex(o)}${Phaser.Color.componentToHex(h)}${Phaser.Color.componentToHex(l)}`}startGame(e,t){const s=[];e.lyrics&&s.push({type:"text",key:"song_lyrics",url:e.lyrics}),this.load.baseURL="",s.length?game.state.start("Load",!0,!1,s,"Play",{chart:e,difficultyIndex:t}):game.state.start("Play",!0,!1,{chart:e,difficultyIndex:t})}update(){gamepad.update(),this.songCarousel&&this.songCarousel.update(),this.difficultyCarousel&&this.difficultyCarousel.update(),gamepad.pressed.select&&(Account.settings.autoplay=!Account.settings.autoplay),this.autoplayText.write(Account.settings.autoplay?"AUTOPLAY":"")}shutdown(){this.previewAudio.pause(),this.previewAudio.src=null,this.previewAudio=null,window.removeEventListener("visibilitychange",this.visibilityChangeListener)}}class CharacterSelect extends Phaser.State{create(){game.camera.fadeIn(0),this.characterManager=new CharacterManager,this.selectedCharacter=this.characterManager.getCurrentCharacter(),new Background("ui_lobby_background",!1,1),new Background("ui_lobby_overlay",!0,.3,.5),new FuturisticLines,this.navigationHint=new NavigationHint(0),this.createUI(),this.updateDisplay()}createUI(){this.characterDisplay=new CharacterDisplay(46,6,this.selectedCharacter),this.createDetailsText(),this.actionMenu=null,this.customizationMenu=null,this.skillsCarousel=null,this.creationMenu=null,this.characterCarousel=null,this.showHomeUI()}createDetailsText(){this.nameText=new Text(115,10,"",FONTS.shaded),this.levelText=new Text(140,10,"",FONTS.default),this.selectedSkillText=new Text(115,34,"",FONTS.default),this.skillDescriptionText=new Text(117,42,"",FONTS.default),this.expBar=new ExperienceBar(140,16,36,3),this.skillBar=new SkillBar(117,18)}showHomeUI(){this.clearAllMenus(),this.showCharacterDetails(),this.showCharacterList(),this.updateDisplay()}clearAllMenus(){this.characterCarousel&&(this.characterCarousel.destroy(),this.characterCarousel=null),this.actionMenu&&(this.actionMenu.destroy(),this.actionMenu=null),this.customizationMenu&&(this.customizationMenu.destroy(),this.customizationMenu=null),this.skillsCarousel&&(this.skillsCarousel.destroy(),this.skillsCarousel=null),this.creationMenu&&(this.creationMenu.destroy(),this.creationMenu=null),gamepad.signals.pressed.any.removeAll()}writeCharacterInformation(){const e=this.selectedCharacter;this.nameText.write(e?e.name:""),this.nameText.bringToTop();e&&(e.experience,e.getRequiredExperience());if(this.levelText.write(e?`Lv. ${e.level}`:""),this.levelText.bringToTop(),e?(this.expBar.setProgress(e.getExperienceProgress()),this.expBar.bringToTop(),this.expBar.visible=!0):this.expBar.visible=!1,e?(this.skillBar.value=e.skillLevel,this.skillBar.update(),this.skillBar.bringToTop(),this.skillBar.visible=!0):this.skillBar.visible=!1,e&&e.selectedSkill){const t=CHARACTER_SKILLS.find(t=>t.id===e.selectedSkill);t?(this.selectedSkillText.write(t.name),this.skillDescriptionText.write(t.description),this.skillDescriptionText.wrapPreserveNewlines(70),this.selectedSkillText.bringToTop(),this.skillDescriptionText.bringToTop()):(this.selectedSkillText.write(""),this.skillDescriptionText.write("< NO SKILL >"),this.skillDescriptionText.bringToTop())}else this.selectedSkillText.write(""),this.skillDescriptionText.write(e?"< NO SKILL >":"< NO CHARACTER >"),this.selectedSkillText.bringToTop()}selectCharacter(e){this.selectedCharacter=e,this.updateDisplay()}updateDisplay(){this.characterDisplay&&this.characterDisplay.destroy(),this.characterDisplay=new CharacterDisplay(46,6,this.selectedCharacter),this.characterCarousel&&this.characterCarousel.bringToTop(),this.writeCharacterInformation()}showCharacterList(){this.characterCarousel=new CarouselMenu(0,8,80,104,{bgcolor:"#9b59b6",fgcolor:"#ffffff",align:"left",animate:!0});let e=0;this.characterManager.getCharacterList().forEach(t=>{const s=this.selectedCharacter&&t.name===this.selectedCharacter.name;this.characterCarousel.addItem(s?`> ${t.name}`:`  ${t.name}`,()=>{this.selectCharacter(t),this.showActionMenu()},{character:t,bgcolor:s?"#e74c3c":"#9b59b6"}),s&&this.characterCarousel.selectIndex(e),e++}),this.characterCarousel.addItem("× NO CHARACTER",()=>{this.selectedCharacter=null,this.characterManager.unsetCharacter(),this.showHomeUI()},{bgcolor:this.selectedCharacter?"#9b59b6":"#e74c3c"}),this.selectedCharacter||this.characterCarousel.selectIndex(e),this.characterCarousel.addItem("+ ADD CHARACTER",()=>this.startCharacterCreation()),this.characterCarousel.onSelect.add((e,t)=>{this.selectCharacter(t.data.character||null)}),this.showCharacterDetails(),this.characterCarousel.onCancel.add(()=>{game.state.start("MainMenu")})}showActionMenu(){this.clearAllMenus(),this.hideCharacterDetails(),this.actionMenu=new CarouselMenu(60,60,72,48,{bgcolor:"#34495e",fgcolor:"#ffffff",align:"center",activeAlpha:1,inactiveAlpha:.5}),this.actionMenu.addItem("SELECT",()=>this.confirmSelection()),this.selectedCharacter.unlockedSkills.length&&this.actionMenu.addItem("SET SKILL",()=>this.setSkill()),this.actionMenu.addItem("CUSTOMIZE",()=>this.customizeCharacter()),this.actionMenu.addItem("DELETE",()=>this.deleteCharacter()),this.actionMenu.onCancel.add(()=>{this.showHomeUI()})}confirmSelection(){this.characterManager.setCurrentCharacter(this.selectedCharacter.name),this.showCharacterList()}setSkill(){this.hideCharacterDetails(),this.skillPreviewText=new Text(110,4,"",FONTS.default),this.skillPreviewText.wrapPreserveNewlines(70),this.skillsCarousel=new CarouselMenu(0,8,80,104,{bgcolor:"#9b59b6",fgcolor:"#ffffff",align:"left",animate:!0});let e=0,t=0;this.selectedCharacter.unlockedSkills.forEach(s=>{const i=CHARACTER_SKILLS.find(e=>e.id===s);if(i){const a=this.selectedCharacter.selectedSkill===s;a&&(t=e),e++,this.skillsCarousel.addItem(a?`> ${i.name}`:`  ${i.name}`,e=>{this.selectedCharacter.selectedSkill=e.data.skillId,this.updateSkillPreview(e.data.skillId),this.skillsCarousel.destroy(),this.skillsCarousel=null,this.skillPreviewText.destroy(),this.setSkill()},{skillId:s,bgcolor:a?"#e74c3c":"#9b59b6"})}}),this.skillsCarousel.selectIndex(t),this.skillsCarousel.onSelect.add((e,t)=>{this.updateSkillPreview(t.data.skillId)}),this.skillsCarousel.onCancel.add(()=>{this.skillsCarousel.destroy(),this.skillsCarousel=null,this.skillPreviewText.destroy(),this.showActionMenu()}),this.selectedCharacter.unlockedSkills.length>0&&this.updateSkillPreview(this.selectedCharacter.unlockedSkills[0])}updateSkillPreview(e){const t=CHARACTER_SKILLS.find(t=>t.id===e);if(!t)return;let s=`${t.name}\n\n`;switch(s+=`${t.description}\n\n`,s+="EFFECT:\n",t.effect){case"convert_judgement":s+=`• Converts ${t.effectParams.from} to ${t.effectParams.to}\n`;break;case"modify_judgement_window":s+=`• Judgement window ×${t.effectParams.multiplier}\n`;break;case"health_regen":s+=`• +${t.effectParams.amount} HP every ${t.effectParams.interval/1e3}s\n`;break;case"modify_max_health":s+=`• +${t.effectParams.amount} Max HP\n`;break;case"modify_note_speed":s+=`• Note speed ×${t.effectParams.multiplier}\n`}switch(s+="\nACTIVATION:\n",t.activationCondition){case"on_miss":s+="• When you get a Miss judgement\n";break;case"on_combo":case"on_high_combo":s+=`• When combo reaches ${t.effectParams.threshold}\n`;break;case"on_low_health":s+=`• When health drops below ${t.effectParams.threshold}%\n`;break;case"on_perfect_streak":s+=`• After ${t.effectParams.threshold} perfect notes in a row\n`}t.duration>0&&(s+=`\nDURATION: ${t.duration/1e3}s\n`),t.cooldown>0&&(s+=`COOLDOWN: ${t.cooldown/1e3}s\n`),this.skillPreviewText.write(s),this.skillPreviewText.wrapPreserveNewlines(80),this.skillPreviewText.bringToTop()}customizeCharacter(){this.showCustomizationMenu()}showCustomizationMenu(){this.clearAllMenus(),this.customizationMenu=new CarouselMenu(10,60,172,48,{bgcolor:"#2c3e50",fgcolor:"#ffffff",align:"center",activeAlpha:1,inactiveAlpha:.6}),this.customizationMenu.addItem("SKIN TONE",()=>this.customizeSkinTone()),this.customizationMenu.addItem("HAIR COLOR",()=>this.customizeHairColor()),this.customizationMenu.addItem("FRONT HAIR",()=>this.customizeHairStyle("frontHair")),this.customizationMenu.addItem("BACK HAIR",()=>this.customizeHairStyle("backHair")),this.customizationMenu.addItem("CLOTHING",()=>this.customizeClothing()),this.customizationMenu.addItem("ACCESSORY",()=>this.customizeAccessory()),this.customizationMenu.addItem("APPLY",()=>this.finishCustomization()),this.customizationMenu.onCancel.add(()=>{this.characterDisplay.updateAppearance(this.originalAppearance),this.showActionMenu()}),this.originalAppearance={...this.selectedCharacter.appearance}}createGradientBackground(e,t,s,i,a){const n=game.add.bitmapData(s,i),r=n.context.createLinearGradient(s,0,0,0),o=a||"rgba(44, 90, 198, 0.6)";r.addColorStop(0,"transparent"),r.addColorStop(.3,o),r.addColorStop(.7,o),r.addColorStop(1,"transparent"),n.context.fillStyle=r,n.context.fillRect(0,0,s,i);return game.add.sprite(e,t,n)}customizeSkinTone(){const e=["LIGHT","DARK"],t=this.createGradientBackground(92,85,92,24);t.anchor.set(.5);const s=new Text(96,80,"SKIN TONE",FONTS.shaded);s.anchor.set(.5);let i=this.selectedCharacter.appearance.skinTone;const a=new Text(96,90,e[i],FONTS.default);a.anchor.set(.5);const n=r=>{if("left"===r)i=(i-1+e.length)%e.length,this.selectedCharacter.appearance.skinTone=i,this.characterDisplay.updateAppearance({skinTone:i});else if("right"===r)i=(i+1)%e.length,this.selectedCharacter.appearance.skinTone=i,this.characterDisplay.updateAppearance({skinTone:i});else if("a"===r||"b"===r||"start"===r)return s.destroy(),a.destroy(),t.destroy(),gamepad.signals.pressed.any.remove(n),void this.showCustomizationMenu();a.write(e[i])};gamepad.signals.pressed.any.add(n)}customizeHairColor(){let e=this.selectedCharacter.appearance.hairColor,t=e>>16&255,s=e>>8&255,i=255&e;const a=this.createGradientBackground(92,85,92,24);a.anchor.set(.5);const n=new Text(96,80,"HAIR COLOR",FONTS.shaded);n.anchor.set(.5);const r=new Text(96,90,`R:${t} G:${s} B:${i}`,FONTS.default);r.anchor.set(.5);const o=()=>{const e=t<<16|s<<8|i;this.selectedCharacter.appearance.hairColor=e,this.characterDisplay.updateAppearance({hairColor:e}),r.write(`R:${t} G:${s} B:${i}`)},h=e=>{switch(e){case"left":t=Math.max(0,t-32);break;case"right":t=Math.min(255,t+32);break;case"up":s=Math.min(255,s+32);break;case"down":s=Math.max(0,s-32);break;case"a":i=Math.min(255,i+32);break;case"b":i=Math.max(0,i-32);break;case"start":return n.destroy(),r.destroy(),a.destroy(),gamepad.signals.pressed.any.remove(h),void this.showCustomizationMenu()}o()};gamepad.signals.pressed.any.add(h)}customizeHairStyle(e){const t=Account.characters.unlockedHairs["frontHair"===e?"front":"back"],s=t.map(t=>CHARACTER_SYSTEM.HAIR_STYLES["frontHair"===e?"front":"back"][t-1]),i=[];for(let e=0;e<t.length;e++)i.push(e+1);const a=this.createGradientBackground(92,85,92,24);a.anchor.set(.5);const n=new Text(96,80,`${e.toUpperCase()}`,FONTS.shaded);n.anchor.set(.5);let r=this.selectedCharacter.appearance[e]-1;const o=new Text(96,90,"",FONTS.default);o.write(s[r],18),o.anchor.set(.5);const h=t=>{if("left"===t)r=(r-1+s.length)%s.length,this.characterDisplay.updateAppearance({[e]:i[r]});else if("right"===t)r=(r+1)%s.length,this.characterDisplay.updateAppearance({[e]:i[r]});else if("a"===t||"b"===t||"start"===t)return this.selectedCharacter.appearance[e]=i[r],this.characterDisplay.updateAppearance({[e]:i[r]}),n.destroy(),o.destroy(),a.destroy(),gamepad.signals.pressed.any.remove(h),void this.showCustomizationMenu();o.write(s[r],18)};gamepad.signals.pressed.any.add(h)}customizeClothing(){const e=Account.characters.unlockedItems.filter(e=>CHARACTER_ITEMS.clothing.some(t=>t.id===e)),t=e.map(e=>{const t=CHARACTER_ITEMS.clothing.find(t=>t.id===e);return t?t.name:e}),s=this.createGradientBackground(92,85,92,24);s.anchor.set(.5);const i=new Text(96,80,"CLOTHING",FONTS.shaded);i.anchor.set(.5);let a=e.indexOf(this.selectedCharacter.appearance.clothing);-1===a&&(a=0);const n=new Text(96,90,"",FONTS.default);n.write(t[a],18),n.anchor.set(.5);const r=o=>{if("left"===o)a=(a-1+t.length)%t.length,this.characterDisplay.updateAppearance({clothing:e[a]});else if("right"===o)a=(a+1)%t.length,this.characterDisplay.updateAppearance({clothing:e[a]});else if("a"===o||"b"===o||"start"===o)return this.selectedCharacter.appearance.clothing=e[a],this.characterDisplay.updateAppearance({clothing:e[a]}),i.destroy(),n.destroy(),s.destroy(),gamepad.signals.pressed.any.remove(r),void this.showCustomizationMenu();n.write(t[a],18)};gamepad.signals.pressed.any.add(r)}customizeAccessory(){const e=Account.characters.unlockedItems.filter(e=>CHARACTER_ITEMS.accessories.some(t=>t.id===e)),t=["NONE",...e.map(e=>{const t=CHARACTER_ITEMS.accessories.find(t=>t.id===e);return t?t.name:e})],s=this.createGradientBackground(92,85,92,24);s.anchor.set(.5);const i=new Text(96,80,"ACCESSORY",FONTS.shaded);i.anchor.set(.5);let a=this.selectedCharacter.appearance.accessory?e.indexOf(this.selectedCharacter.appearance.accessory)+1:0;const n=new Text(96,90,"",FONTS.default);n.write(t[a],18),n.anchor.set(.5);const r=o=>{if("left"===o)a=(a-1+t.length)%t.length,this.characterDisplay.updateAppearance({accessory:0===a?null:e[a-1]});else if("right"===o)a=(a+1)%t.length,this.characterDisplay.updateAppearance({accessory:0===a?null:e[a-1]});else if("a"===o||"b"===o||"start"===o)return this.selectedCharacter.appearance.accessory=0===a?null:e[a-1],this.characterDisplay.updateAppearance({accessory:this.selectedCharacter.appearance.accessory}),i.destroy(),n.destroy(),s.destroy(),gamepad.signals.pressed.any.remove(r),void this.showCustomizationMenu();n.write(t[a],18)};gamepad.signals.pressed.any.add(r)}finishCustomization(){this.characterManager.saveToAccount(),this.showActionMenu()}deleteCharacter(){this.confirm("DELETE CHARACTER?",()=>{this.characterManager.deleteCharacter(this.selectedCharacter.name),this.characterManager.getCharacterList().length<=1?(this.selectedCharacter=null,this.characterManager.unsetCharacter()):this.selectedCharacter=this.characterManager.getCharacterList()[0],this.showHomeUI()},()=>{this.showActionMenu()},"no")}confirm(e,t,s,i="none"){this.clearAllMenus();const a=new Text(96,60,e,FONTS.shaded);a.anchor.set(.5);const n=new CarouselMenu(60,70,72,32,{bgcolor:"#2c3e50",fgcolor:"#ffffff",align:"center"});let r="#34495e",o="#34495e",h=0;switch(i){case"yes":r="#27ae60",o="#c0392b",h=0;break;case"no":r="#c0392b",o="#27ae60",h=1;break;default:r="#34495e",o="#34495e",h=0}n.addItem("YES",()=>{a.destroy(),n.destroy(),t?.()},{bgcolor:r}),n.addItem("NO",()=>{a.destroy(),n.destroy(),s?.()},{bgcolor:o}),1===h&&n.selectIndex(1),n.onCancel.add(()=>{a.destroy(),n.destroy(),s?.()})}startCharacterCreation(){this.creationStep=0,this.newCharacterAppearance={skinTone:0,hairColor:16777215,frontHair:"1",backHair:"1",clothing:"school_uniform",accessory:null},this.clearAllMenus(),this.hideCharacterDetails(),this.tempCharacterDisplay=new CharacterDisplay(46,6,{name:"NEW CHARACTER",appearance:this.newCharacterAppearance}),this.creationWindowManager=new WindowManager,this.showCreationStep()}hideCharacterDetails(){this.nameText.visible=!1,this.levelText.visible=!1,this.selectedSkillText.visible=!1,this.skillDescriptionText.visible=!1,this.expBar.visible=!1,this.skillBar.visible=!1}showCharacterDetails(){this.nameText.visible=!0,this.levelText.visible=!0,this.selectedSkillText.visible=!0,this.skillDescriptionText.visible=!0,this.expBar.visible=!0,this.skillBar.visible=!0}showCreationStep(){this.creationMenu&&(this.creationMenu.destroy(),this.creationMenu=null),this.creationText&&(this.creationText.destroy(),this.creationText=null),this.creationWindow&&this.creationWindowManager.remove(this.creationWindow,!0),gamepad.signals.pressed.any.removeAll();const e=[{title:"CHOOSE SKIN TONE",action:e=>this.creationCustomizeSkinTone(e)},{title:"CHOOSE HAIR COLOR",action:e=>this.creationCustomizeHairColor(e)},{title:"CHOOSE FRONT HAIR",action:e=>this.creationCustomizeHairStyle("frontHair",e)},{title:"CHOOSE BACK HAIR",action:e=>this.creationCustomizeHairStyle("backHair",e)},{title:"CHOOSE CLOTHING",action:e=>this.creationCustomizeClothing(e)},{title:"CHOOSE ACCESSORY",action:e=>this.creationCustomizeAccessory(e)},{title:"NAME YOUR CHARACTER",action:e=>this.creationNameCharacter(e)}];if(this.creationStep<e.length){const t=e[this.creationStep];this.creationWindow=this.creationWindowManager.createWindow(12,7,10,5,"1"),this.creationWindow.x-=this.creationWindow.size.width/2*8,this.creationWindow.offset={x:20,y:8},this.creationWindow.disableScrollBar=!0,this.creationText=new Text(96,70,t.title,FONTS.shaded),this.creationText.anchor.set(.5),t.action(()=>{this.showCreationNavigationMenu()})}}showCreationNavigationMenu(){this.creationWindow.addItem("NEXT","",()=>{this.creationStep++,this.showCreationStep()}),this.creationStep>0&&this.creationWindow.addItem("PREVIOUS","",()=>{this.creationStep--,this.showCreationStep()},!0),this.creationWindow.addItem("CANCEL","",()=>{this.cancelCharacterCreation()},this.creationStep<=0),this.creationWindowManager.focus(this.creationWindow)}creationCustomizeSkinTone(e){const t=["LIGHT","DARK"];let s=this.newCharacterAppearance.skinTone;const i=new Text(96,80,t[s],FONTS.default);i.anchor.set(.5);const a=n=>{if("left"===n)s=(s-1+t.length)%t.length;else if("right"===n)s=(s+1)%t.length;else{if("a"===n)return i.destroy(),gamepad.signals.pressed.any.remove(a),void e();if("b"===n)return i.destroy(),gamepad.signals.pressed.any.remove(a),void this.showCreationNavigationMenu()}this.newCharacterAppearance.skinTone=s,this.tempCharacterDisplay.updateAppearance({skinTone:s}),i.write(t[s])};gamepad.signals.pressed.any.add(a)}creationCustomizeHairColor(e){let t=this.newCharacterAppearance.hairColor,s=Math.max(136,t>>16&255),i=Math.max(136,t>>8&255),a=Math.max(136,255&t);const n=()=>{const e=s<<16|i<<8|a;return this.newCharacterAppearance.hairColor=e,this.tempCharacterDisplay.updateAppearance({hairColor:e}),`R:${s} G:${i} B:${a}`},r=new Text(96,80,n(),FONTS.default);r.anchor.set(.5);const o=t=>{switch(t){case"left":s=Math.max(0,s-32);break;case"right":s=Math.min(255,s+32);break;case"up":i=Math.min(255,i+32);break;case"down":i=Math.max(0,i-32);break;case"a":a=Math.min(255,a+32);break;case"b":a=Math.max(0,a-32);break;case"start":return r.destroy(),gamepad.signals.pressed.any.remove(o),void e();case"select":return r.destroy(),gamepad.signals.pressed.any.remove(o),void this.showCreationNavigationMenu()}r.write(n())};gamepad.signals.pressed.any.add(o)}creationCustomizeHairStyle(e,t){const s=Account.characters.unlockedHairs["frontHair"===e?"front":"back"],i=s.map(t=>CHARACTER_SYSTEM.HAIR_STYLES["frontHair"===e?"front":"back"][t-1]),a=[];for(let e=0;e<s.length;e++)a.push(e+1);let n=this.newCharacterAppearance[e]-1;const r=new Text(96,80,i[n],FONTS.default);r.anchor.set(.5);const o=()=>{this.newCharacterAppearance[e]=a[n],this.tempCharacterDisplay.updateAppearance({[e]:a[n]}),r.write(i[n])},h=e=>{if("left"===e)n=(n-1+i.length)%i.length;else if("right"===e)n=(n+1)%i.length;else{if("a"===e)return r.destroy(),gamepad.signals.pressed.any.remove(h),void t();if("b"===e)return r.destroy(),gamepad.signals.pressed.any.remove(h),void this.showCreationNavigationMenu()}o()};o(),gamepad.signals.pressed.any.add(h)}creationCustomizeClothing(e){const t=Account.characters.unlockedItems.filter(e=>CHARACTER_ITEMS.clothing.some(t=>t.id===e)),s=t.map(e=>{const t=CHARACTER_ITEMS.clothing.find(t=>t.id===e);return t?t.name:e});let i=t.indexOf(this.newCharacterAppearance.clothing);-1===i&&(i=0);const a=new Text(96,80,s[i],FONTS.default);a.anchor.set(.5);const n=r=>{if("left"===r)i=(i-1+s.length)%s.length;else if("right"===r)i=(i+1)%s.length;else{if("a"===r)return a.destroy(),gamepad.signals.pressed.any.remove(n),void e();if("b"===r)return a.destroy(),gamepad.signals.pressed.any.remove(n),void this.showCreationNavigationMenu()}this.newCharacterAppearance.clothing=t[i],this.tempCharacterDisplay.updateAppearance({clothing:t[i]}),a.write(s[i])};gamepad.signals.pressed.any.add(n)}creationCustomizeAccessory(e){const t=Account.characters.unlockedItems.filter(e=>CHARACTER_ITEMS.accessories.some(t=>t.id===e)),s=["NONE",...t.map(e=>{const t=CHARACTER_ITEMS.accessories.find(t=>t.id===e);return t?t.name:e})];let i=this.newCharacterAppearance.accessory?t.indexOf(this.newCharacterAppearance.accessory)+1:0;const a=new Text(96,80,s[i],FONTS.default);a.anchor.set(.5);const n=r=>{if("left"===r)i=(i-1+s.length)%s.length;else if("right"===r)i=(i+1)%s.length;else{if("a"===r)return a.destroy(),gamepad.signals.pressed.any.remove(n),void e();if("b"===r)return a.destroy(),gamepad.signals.pressed.any.remove(n),void this.showCreationNavigationMenu()}this.newCharacterAppearance.accessory=0===i?null:t[i-1],this.tempCharacterDisplay.updateAppearance({accessory:this.newCharacterAppearance.accessory}),a.write(s[i])};n(),gamepad.signals.pressed.any.add(n)}creationNameCharacter(e){this.creationMenu&&(this.creationMenu.destroy(),this.creationMenu=null),this.creationText&&(this.creationText.destroy(),this.creationText=null);const t=new Text(96,80,"ENTER CHARACTER NAME",FONTS.shaded);t.anchor.set(.5),new TextInput("",CHARACTER_SYSTEM.MAX_NAME_LENGTH,s=>{const i=this.characterManager.createCharacter(s,this.newCharacterAppearance);i?(this.selectedCharacter=i,t.destroy(),instructionText.destroy(),this.tempCharacterDisplay&&(this.tempCharacterDisplay.destroy(),this.tempCharacterDisplay=null),this.showHomeUI()):(notifications.show("Character name already exists"),this.creationNameCharacter(e))},()=>{t.destroy(),this.cancelCharacterCreation()})}cancelCharacterCreation(){this.tempCharacterDisplay&&(this.tempCharacterDisplay.destroy(),this.tempCharacterDisplay=null),this.creationMenu&&(this.creationMenu.destroy(),this.creationMenu=null),this.creationText&&(this.creationText.destroy(),this.creationText=null),this.creationWindow&&this.creationWindowManager.remove(this.creationWindow,!0),this.showHomeUI()}update(){gamepad.update(),this.creationWindowManager&&this.creationWindowManager.update()}shutdown(){this.characterManager.saveToAccount()}}class Play{init(e,t){this.song=e,this.difficultyIndex=t,this.player=null,this.backgroundQueue=[],this.currentBackground=null,this.isPaused=!1,this.pauseStartTime=0,this.totalPausedDuration=0,this.pendingSongStart=!1,this.audioEndListener=null,this.started=!1,this.startTime=0,this.autoplay=Account.settings.autoplay,this.userOffset=Account.settings.userOffset,this.lastVideoUpdateTime=0,this.lyrics=null,this.hasLyricsFile=!!e.chart.lyrics,this.visualizerType=Account.settings.visualizer||"NONE",this.lastVisualizerUpdateTime=0,this.metronome=null,this.gameRecorder=null,this.characterManager=new CharacterManager,this.currentCharacter=this.characterManager.getCurrentCharacter(),this.skillSystem=new CharacterSkillSystem(this,this.currentCharacter),Account.lastSong={url:e.chart.audioUrl,title:e.chart.title,artist:e.chart.artist,sampleStart:e.chart.sampleStart||0,isExternal:void 0!==e.chart.files},saveAccount(),this.JUDGE_WINDOWS=JUDGE_WINDOWS,this.SCORE_VALUES=SCORE_VALUES}create(){backgroundMusic&&backgroundMusic.stop(),game.camera.fadeIn(0),this.backgroundLayer=game.add.group(),this.backgroundSprite=game.add.sprite(0,0,null,0,this.backgroundLayer),this.backgroundSprite.alpha=.6,this.backgroundCanvas=document.createElement("canvas"),this.backgroundCanvas.width=192,this.backgroundCanvas.height=112,this.backgroundCtx=this.backgroundCanvas.getContext("2d"),this.audio=document.createElement("audio"),this.audio.src=this.song.chart.audioUrl,this.audio.volume=[0,25,50,75,100][Account.settings.volume]/100,this.visibilityChangeListener=()=>{document.hidden&&(this.isPaused||this.pause())},window.addEventListener("visibilitychange",this.visibilityChangeListener),this.video=document.createElement("video"),this.video.muted=!0,this.video.loop=!0,this.createHud(),this.setupLyrics(),this.setupPlayer(),this.metronome=new Metronome(this),this.songStart(),addonManager.executeStateBehaviors(this.constructor.name,this)}createHud(){this.backgroundGradient=new BackgroundGradient(0,.4,5e3),this.hud=game.add.sprite(0,0,"ui_hud_background",0),this.overHud=game.add.sprite(0,0);const e=this.song.chart.difficulties[this.song.difficultyIndex];this.difficultyBanner=game.add.sprite(0,0,"ui_difficulty_banner",0),this.difficultyBanner.tint=this.getDifficultyColor(e.rating),this.hud.addChild(this.difficultyBanner),this.difficultyTypeText=new Text(5,1,e.type.substr(0,7),null,this.difficultyBanner);const t=this.song.chart.titleTranslit||this.song.chart.title;this.songTitleText=new Text(34,1,"",null,this.hud),this.songTitleText.write(t,28),this.playerName=new Text(4,8,"",FONTS.shaded,this.hud),this.playerName.write(this.currentCharacter?this.currentCharacter.name:"NONE",4),this.playerName.tint=this.currentCharacter?this.currentCharacter.appearance.hairColor:16777215,this.skillBar=new SkillBar(6,15),this.hud.addChild(this.skillBar),this.currentCharacter||(this.skillBar.visible=!1),this.scoreText=new Text(22,12,"0".repeat(9),null,this.hud),this.lifebarStart=game.add.sprite(21,8,"ui_lifebar",0),this.lifebarMiddle=game.add.sprite(1,0,"ui_lifebar",1),this.lifebarMiddle.width=102,this.lifebarEnd=game.add.sprite(103,0,"ui_lifebar",2),this.hud.addChild(this.lifebarStart),this.lifebarStart.addChild(this.lifebarMiddle),this.lifebarStart.addChild(this.lifebarEnd),this.autoplayText=new Text(4,90,this.autoplay?"AUTOPLAY":"",FONTS.stroke,this.hud),this.healthText=new Text(137,8,"100",FONTS.number,this.hud),this.healthText.anchor.x=1,this.judgementText=new Text(game.width/2,60,"",FONTS.shaded),this.judgementText.anchor.set(.5),this.accuracyBar=game.add.sprite(41,108,"ui_accuracy_bar"),this.hud.addChild(this.accuracyBar),this.comboText=new Text(191,106,"0",FONTS.combo),this.comboText.anchor.set(1),this.createVisualizer()}createVisualizer(){switch(this.visualizer&&(this.visualizer.destroy(),this.visualizer=null),this.visualizerType){case"ACCURACY":this.visualizer=new AccuracyVisualizer(this,2,103,36,7);break;case"AUDIO":this.visualizer=new AudioVisualizer(this,2,103,36,7);break;case"BPM":this.visualizer=new BPMVisualizer(this,2,103,36,7);break;default:this.visualizer=null}this.visualizer&&this.hud.addChild(this.visualizer.graphics)}setupPlayer(){this.player=new Player(this)}setupLyrics(){if(this.hasLyricsFile&&game.cache.checkTextKey("song_lyrics")){const e=game.cache.getText("song_lyrics");this.lyricsText=new Text(game.width/2,72,"",FONTS.stroke),this.lyricsText.anchor.set(.5),this.lyrics=new Lyrics({textElement:this.lyricsText,maxLineLength:25,lrc:e})}}getDifficultyColor(e){e=Math.max(0,Math.min(11,e));var t=25,s=210,i=25,a=210,n=0,r=0;return Math.floor(t+e/11*(a-t))<<16|Math.floor(s+e/11*(n-s))<<8|Math.floor(i+e/11*(r-i))}getDifficultyColorFromType(e){return{Beginner:65458,Easy:65356,Medium:16763904,Hard:16744192,Challenge:16731136}[e]}setBackground(){this.song.chart.background&&"no-media"!==this.song.chart.background?this.loadBackgroundImage(this.song.chart.background):(this.backgroundCtx.fillStyle="#000000",this.backgroundCtx.fillRect(0,0,192,112),this.updateBackgroundTexture())}songStart(){this.setBackground();const e=this.song.chart.offset||0;this.startTime=game.time.now+2e3-1e3*e,setTimeout(()=>{this.audio?.play(),this.started=!0,window.recordNextGame&&game.recorder.start(this.audio,0)},2e3+this.userOffset),this.audioEndListener=this.audio.addEventListener("ended",()=>this.songEnd(),{once:!0})}showCharacterCloseShot(e){const t=Math.max(500,e-400),s=new CharacterCloseShot(2,103,this.currentCharacter);s.visible=!1,this.overHud.addChild(s),this.visualizer&&(this.visualizer.graphics.visible=!1);const i=game.add.sprite(2,103,"character_noise");i.animations.add("static",[0,1,2,3,4,5,6,7],60,!0),i.animations.play("static"),this.overHud.addChild(i),game.time.events.add(200,()=>{i.destroy(),s.visible=!0,s.blink(game.rnd.between(0,200))}),game.time.events.add(t,()=>{s.visible=!1;const e=game.add.sprite(2,103,"character_noise");e.animations.add("static",[0,1,2,3,4,5,6,7],60,!0),e.animations.play("static"),this.overHud.addChild(e),game.time.events.add(200,()=>{this.visualizer&&(this.visualizer.graphics.visible=!0),e.destroy(),s.destroy()})})}showGlitchAnimation(e=1e3){const t=game.add.sprite(0,0,"ui_glitch_animation");t.animations.add("glitch",[0,1,2,3,4,5,6],12,!0),t.animations.play("glitch"),t.lifespan=e,t.blendMode=PIXI.blendModes.ADD,this.overHud.addChild(t)}loadBackgroundImage(e){const t=new Image;t.onload=()=>{this.backgroundCtx.drawImage(t,0,0,192,112),this.updateBackgroundTexture()},t.src=e}loadBackgroundVideo(e){this.video.src=e,this.video.play(),this.backgroundGradient.visible=!1}clearBackgroundImage(){this.backgroundSprite.loadTexture(null),this.backgroundGradient.visible=!1}applyBackground(e){"-nosongbg-"==e.file?this.clearBackgroundImage():"video"==e.type?this.loadBackgroundVideo(e.url):(this.loadBackgroundImage(e.url),this.video.src="",this.backgroundGradient.visible=!0),this.currentBackground=e,this.applyBgEffects(e)}applyBgEffects(e){e.fadeIn?(this.backgroundSprite.alpha=0,game.add.tween(this.backgroundSprite).to({alpha:.6*parseFloat(e.opacity)},500,"Linear",!0)):this.backgroundSprite.alpha=.6*e.opacity}updateBackgroundTexture(){const e=PIXI.Texture.fromCanvas(this.backgroundCanvas);this.backgroundSprite.loadTexture(e)}songEnd(){const e={score:this.player.score,accuracy:this.player.accuracy,maxCombo:this.player.maxCombo,judgements:{...this.player.judgementCounts},skillsUsed:this.skillSystem.getSkillsUsed(),difficultyRating:this.song.chart.difficulties[this.song.difficultyIndex].rating},t=this.autoplay?0:this.characterManager.calculateExperienceGain(e);this.autoplay||this.characterManager.updateCharacterStats(e,t);const s={song:this.song,difficultyIndex:this.difficultyIndex,character:this.currentCharacter,player:this.player,expGain:t,gameResults:e};game.state.start("Results",!0,!1,s)}togglePause(){this.isAnimating||(this.isPaused?this.resume():this.pause())}pause(){this.isPaused=!0,this.pauseStartTime=game.time.now,this.audio?.pause(),this.video.src&&this.video?.pause(),this.showPauseMenu()}resume(){this.isPaused=!1,this.totalPausedDuration+=game.time.now-this.pauseStartTime,this.hidePauseMenu(),this.video.src&&this.video?.play(),this.audio?.play()}showPauseMenu(){const e=game.height/2-20;this.pauseBg=game.add.graphics(0,0),this.pauseBg.beginFill(0,.6),this.pauseBg.drawRect(0,0,192,112),this.pauseBg.endFill(),this.pauseCarousel=new CarouselMenu(10,e,80,60,{bgcolor:"brown",fgcolor:"#ffffff",align:"center",animate:!0}),this.pauseCarousel.addItem("CONTINUE",()=>this.resume()),Account.settings.autoplay&&this.pauseCarousel.addItem("DISABLE AUTOPLAY",()=>{Account.settings.autoplay=!1,game.state.start("SongSelect",!0,!1,null,null,!0)}),this.pauseCarousel.addItem("RESTART",()=>game.state.start("Play",!0,!1,this.song,this.difficultyIndex)),this.pauseCarousel.addItem("GIVE UP",()=>this.songEnd()),game.onMenuIn.dispatch("pause",this.pauseCarousel),this.pauseCarousel.addItem("QUIT",()=>game.state.start("MainMenu")),this.pauseCarousel.onCancel.add(()=>this.resume())}hidePauseMenu(){this.pauseCarousel&&(this.pauseBg.destroy(),this.pauseCarousel.destroy(),this.pauseCarousel=null)}getCurrentTime(){if(this.isPaused){const e=this.pauseStartTime-this.startTime-this.totalPausedDuration+this.userOffset;return{now:e/1e3,beat:this.secToBeat(e/1e3)}}{const e=game.time.now-this.startTime-this.totalPausedDuration+this.userOffset;return{now:e/1e3,beat:this.secToBeat(e/1e3)}}}secToBeat(e){return this.player?this.player.secToBeat(e):0}updateBackgrounds(){const{beat:e}=this.getCurrentTime();if(this.song.chart.backgrounds.forEach(t=>{e>=t.beat&&!t.activated&&(t.activated=!0,this.backgroundQueue.push(t))}),this.backgroundQueue.length>0){const e=this.backgroundQueue.shift();this.applyBackground(e)}this.updateVideo()}updateVideo(){this.currentBackground&&"video"==this.currentBackground.type&&game.time.now-this.lastVideoUpdateTime>=3*game.time.elapsedMS&&(this.lastVideoUpdateTime=game.time.now,this.backgroundCtx.drawImage(this.video,0,0,192,112),this.updateBackgroundTexture())}update(){if(gamepad.update(),this.isPaused)return;if(gamepad.pressed.start&&!this.lastStart&&this.togglePause(),this.lastStart=gamepad.pressed.start,this.skillSystem&&this.skillSystem.update(),this.hasLyricsFile&&this.lyrics&&this.started){const e=this.getCurrentTime().now;this.lyrics.move(e)}this.visualizer&&game.time.now-this.lastVisualizerUpdateTime>=2*game.time.elapsedMS&&(this.visualizer.update(),this.lastVisualizerUpdateTime=game.time.now),gamepad.pressed.select&&!this.lastSelect&&this.metronome.toggle(),this.lastSelect=gamepad.pressed.select,this.metronome&&this.metronome.update();let e="";this.autoplay?e=this.metronome.enabled?"AUTOPLAY + METRONOME":"AUTOPLAY":this.metronome.enabled&&(e="METRONOME"),this.autoplayText.text!=e&&this.autoplayText.write(e),this.player.update(),this.updateBackgrounds(),this.hud.bringToTop(),this.hud.alpha=this.player.gameOver?.5:1,this.overHud.bringToTop(),this.judgementText.bringToTop(),this.comboText.bringToTop()}render(){this.player&&this.player.render()}shutdown(){this.audio.removeEventListener("ended",this.audioEndListener),window.removeEventListener("visibilitychange",this.visibilityChangeListener),this.audio.pause(),this.audio.src="",this.audio=null,this.video.src&&(this.video.pause(),this.video.src="",this.video=null),this.song.chart.backgrounds.forEach(e=>e.activated=!1),this.visualizer&&(this.visualizer.destroy(),this.visualizer=null),this.metronome&&(this.metronome.destroy(),this.metronome=null),window.recordNextGame&&(game.recorder.stop(),window.recordNextGame=!1)}}class Results{init(e){this.gameData=e,this.isNewRecord=!1,this.finalScore=0,this.finalAccuracy=0,this.scoreRating=""}create(){game.camera.fadeIn(0),new FuturisticLines,new BackgroundGradient;const{song:e,player:t}=this.gameData,s=e.chart.difficulties[e.difficultyIndex];this.finalScore=t.score,this.finalAccuracy=t.accuracy,this.scoreRating=t.getScoreRating(),this.previewAudio=document.createElement("audio"),this.previewAudio.volume=[0,25,50,75,100][Account.settings.volume]/100,this.visibilityChangeListener=()=>{document.hidden?this.previewAudio?.pause():this.previewAudio?.play()},window.addEventListener("visibilitychange",this.visibilityChangeListener),this.isNewRecord=this.saveHighScore(e,s,t),this.displayResults(),this.gameData.character&&this.showCharacterExp(),this.showMenu(),addonManager.executeStateBehaviors(this.constructor.name,this)}saveHighScore(e,t,s){if(Account.settings.autoplay)return!1;const i=this.getSongKey(e),a=`${t.type}${t.rating}`;Account.highScores[i]||(Account.highScores[i]={});const n=Account.highScores[i][a],r={score:s.score,accuracy:s.accuracy,rating:s.getScoreRating(),maxCombo:s.maxCombo,date:Date.now(),judgements:{...s.judgementCounts}};let o=!1;return(!n||s.score>n.score)&&(Account.highScores[i][a]=r,saveAccount(),o=!0),o}getSongKey(e){return e.chart.folderName?`local_${e.chart.folderName}`:e.chart.audioUrl?`external_${this.hashString(e.chart.audioUrl)}`:`unknown_${Date.now()}`}hashString(e){let t=0;for(let s=0;s<e.length;s++){t=(t<<5)-t+e.charCodeAt(s),t&=t}return t.toString(36)}displayResults(){const{song:e,player:t}=this.gameData,s=e.chart.difficulties[e.difficultyIndex];this.bannerImg=document.createElement("img"),this.cdtitleImg=document.createElement("img"),this.bannerCanvas=document.createElement("canvas"),this.bannerCtx=this.bannerCanvas.getContext("2d"),this.bannerSprite=game.add.sprite(112,10),e.chart.audioUrl&&(this.previewAudio.src=e.chart.audioUrl,this.previewAudio.currentTime=e.chart.sampleStart||0,this.previewAudio.play()),e.chart.banner&&(this.bannerImg.src=e.chart.banner,this.bannerImg.onload=()=>{this.bannerCtx.drawImage(this.bannerImg,0,0,72,28),this.bannerSprite.loadTexture(PIXI.Texture.fromCanvas(this.bannerCanvas))});const i=e.chart.titleTranslit||e.chart.title;this.songText=new Text(8,10,`${i}`,FONTS.shaded),this.diffText=new Text(10,20,`${s.type} (${s.rating})`),this.diffText.tint=(new Play).getDifficultyColor(s.rating),i.length>25&&this.songText.scrollwrite(i,25);const a=Account.settings.autoplay;this.scoreText=new Text(10,30,`SCORE: ${a?"---":this.finalScore.toLocaleString()}`,FONTS.default),this.accuracyText=new Text(10,40,"ACCURACY: "+(a?"---":`${this.finalAccuracy.toFixed(2)}%`),FONTS.default),this.ratingText=new Text(10,50,`RATING: ${a?"AUTO":this.scoreRating}`,FONTS.shaded),this.ratingText.tint=this.getRatingColor(this.scoreRating),this.comboText=new Text(10,60,`MAX COMBO: ${a?"---":t.maxCombo}`,FONTS.default),this.judgementsText=new Text(15,70,a?"\nAUTOPLAY ENABLED":this.getJudgementsText(t.judgementCounts)),this.judgementsText.tint=a?16711680:16777215,!a&&this.isNewRecord&&(this.recordText=new Text(this.scoreText.right+4,this.scoreText.y,"NEW RECORD!",FONTS.shaded),this.recordText.anchor.x=.5,this.recordText.x+=this.scoreText.width/2,this.recordText.tint=16766720,game.add.tween(this.recordText.scale).to({x:1.2,y:1.2},500,"Linear",!0).yoyo(!0).repeat(-1))}showCharacterExp(){new CharacterPortrait(112,41,this.gameData.character||null);const e=new Text(128,42,"",FONTS.shaded),t=new Text(0,42,""),s=new ExperienceBar(129,50,40,3);if(this.gameData.character){e.write(this.gameData.character.name);const i=this.gameData.character.experienceStory[0],a=CHARACTER_SYSTEM.EXPERIENCE_CURVE;if(i){let n=i.expBefore,r=i.levelBefore;function o(e,n){e<a(n)?(e++,Audio.play("exp_up",.6)):(e=0,n++,t.write(`Lv. ${n}`),Audio.play("level_up",.9)),s.setProgress(e/a(n)),(n<i.levelAfter||e<i.expAfter)&&game.time.events.add(100,()=>o(e,n))}t.x=e.right+8,t.write(`Lv. ${r}`),s.setProgress(n/a(r)),this.gameData.expGain&&game.time.events.add(600,()=>o(n,r))}}}showMenu(){this.navigationHint=new NavigationHint(1);const e=this.gameData.character?72:80,t=this.gameData.character?53:40,s=new CarouselMenu(108,t,80,e,{bgcolor:"brown",fgcolor:"#ffffff"});s.addItem("NEXT",()=>{game.state.start("SongSelect",!0,!1,null,window.selectStartingIndex+1,!0)}),s.addItem("CONTINUE",()=>game.state.start("SongSelect")),Account.settings.autoplay&&s.addItem("DISABLE AUTOPLAY",()=>{Account.settings.autoplay=!1,game.state.start("SongSelect")}),s.addItem("RETRY",()=>game.state.start("Play",!0,!1,this.gameData.song)),s.addItem("QUIT",()=>game.state.start("MainMenu")),game.onMenuIn.dispatch("results",s)}getJudgementsText(e){return`MARVELOUS: ${e.marvelous}\nPERFECT: ${e.perfect}\nGREAT: ${e.great}\nGOOD: ${e.good}\nBOO: ${e.boo}\nMISS: ${e.miss}`}getRatingColor(e){return{"SSS+":16766720,SSS:16766720,SS:15790320,S:15790320,A:65280,B:255,C:16776960,D:16753920,E:16711680,F:8388736}[e]||16777215}update(){gamepad.update()}shutdown(){this.previewAudio.pause(),this.previewAudio.src=null,this.previewAudio=null,window.removeEventListener("visibilitychange",this.visibilityChangeListener)}}class Jukebox{init(e=null,t=0){this.songs=e||(window.localSongs&&window.externalSongs?[...window.localSongs,...window.externalSongs]:window.localSongs)||[],this.currentIndex=t||0,this.currentSong=this.songs[this.currentIndex],this.isPlaying=!1,this.isShuffled=!1,this.menuVisible=!1,this.songListMenuVisible=!1,this.originalSongOrder=[...this.songs],this.visualizerMode="symmetrical",this.seekSpeed=1,this.lastSeekTime=0,this.seekCooldown=60,this.doublePressTimeout=200,this.currentBackground=null,this.backgroundQueue=[],this.backgroundSprite=null,this.videoElement=null,this.visualizer=null,this.lyrics=null,this.hasLyrics=!1,this.fullscreenMode=!1,this.buttonActiveTimers={},this.lastLeftPress=0,this.lastRightPress=0,this.lastSelectPress=0,this.lastBPress=0,this.playbackPositions={}}create(){game.camera.fadeIn(0),this.setupBackground(),this.setupAudioPlayer(),this.setupUI(),this.setupVisualizer(),this.setupLyrics(),this.navigationHint=new NavigationHint(3),this.loadSong(this.currentIndex),addonManager.executeStateBehaviors(this.constructor.name,this)}setupBackground(){this.backgroundSprite=game.add.sprite(0,0),this.backgroundSprite.alpha=.4,this.videoElement=document.createElement("video"),this.videoElement.muted=!0,this.videoElement.loop=!0}setupAudioPlayer(){backgroundMusic&&backgroundMusic.stop(),this.audioElement=document.createElement("audio"),this.audioElement.volume=[0,25,50,75,100][Account.settings.volume]/100,this.audioElement.addEventListener("timeupdate",()=>{this.updateProgressBar(),this.updateTimeDisplay()}),this.audioElement.addEventListener("ended",()=>{this.nextSong(!0)}),this.audioElement.addEventListener("error",e=>{console.warn("Audio error:",e)})}setupUI(){this.uiBackground=game.add.graphics(0,0),this.uiBackground.beginFill(0,.7),this.uiBackground.drawRect(0,80,game.width,32),this.uiBackground.endFill(),this.bannerSprite=game.add.sprite(4,4),this.songTitle=new Text(102,4,"",FONTS.shaded),this.songArtist=new Text(104,14,"",FONTS.default),this.songCredit=new Text(104,24,"",FONTS.default),this.currentTimeText=new Text(4,84,"0:00",FONTS.default),this.durationText=new Text(188,84,"0:00",FONTS.default),this.durationText.anchor.x=1,this.progressBarBg=game.add.graphics(30,86),this.progressBarBg.lineStyle(2,6710886,1),this.progressBarBg.moveTo(0,0),this.progressBarBg.lineTo(132,0),this.progressBar=game.add.graphics(30,86),this.createPlaybackControls(),this.lyricsText=new Text(game.width/2,51,"",FONTS.stroke),this.lyricsText.anchor.set(.5),this.lyricsText.visible=!0}createPlaybackControls(){const e=70,t=8,s=8,i=8,a=12,n=8;let r=game.width/2-(t+2+s+2+i+2+a+2+i+2+s+2+n)/2;this.visualizationButton=game.add.sprite(r+t/2,e,"ui_jukebox_visualization",0),this.visualizationButton.anchor.set(.5),r+=t+2,this.skipLeftButton=game.add.sprite(r+s/2,e,"ui_jukebox_skip",0),this.skipLeftButton.anchor.set(.5),this.skipLeftButton.scale.x=-1,r+=s+2,this.seekLeftButton=game.add.sprite(r+i/2,e,"ui_jukebox_seek",0),this.seekLeftButton.anchor.set(.5),this.seekLeftButton.scale.x=-1,r+=i+2,this.pauseButton=game.add.sprite(r+a/2,e,"ui_jukebox_pause_toggle",0),this.pauseButton.anchor.set(.5),r+=a+2,this.seekRightButton=game.add.sprite(r+i/2,e,"ui_jukebox_seek",0),this.seekRightButton.anchor.set(.5),r+=i+2,this.skipRightButton=game.add.sprite(r+s/2,e,"ui_jukebox_skip",0),this.skipRightButton.anchor.set(.5),r+=s+2,this.menuButton=game.add.sprite(r+n/2,e,"ui_jukebox_menu",0),this.menuButton.anchor.set(.5)}setupVisualizer(){this.visualizer=new FullScreenAudioVisualizer(this.audioElement,{visualizationType:this.visualizerMode,barColor:7797982,barWidth:3,barSpacing:1,barBaseHeight:5,barMaxHeight:40,alpha:.6,fftSize:512,smoothing:.7})}setupLyrics(){this.currentSong.lyrics?this.loadLyrics(this.currentSong.lyrics):(this.lyrics=null,this.hasLyrics=!1)}async loadLyrics(e){try{const t=await new Promise((t,s)=>{const i=new XMLHttpRequest;i.open("GET",e),i.onload=()=>{200===i.status||0===i.status?t(i.responseText):s(new Error(`Failed to load lyrics: ${i.status}`))},i.onerror=()=>s(new Error("Network error loading lyrics")),i.send()});this.lyrics=new Lyrics({textElement:this.lyricsText,maxLineLength:25,lrc:t}),this.hasLyrics=!0}catch(e){console.warn("Could not load lyrics:",e),this.lyrics=null,this.hasLyrics=!1}}getSongKey(e){if(e.folderName)return`local_${e.folderName}`;if(e.audioUrl){let t=0;for(let s=0;s<e.audioUrl.length;s++){t=(t<<5)-t+e.audioUrl.charCodeAt(s),t&=t}return`external_${t.toString(36)}`}return`unknown_${Date.now()}`}resetPlaybackPosition(){if(this.audioElement&&this.currentSong){const e=this.getSongKey(this.currentSong);this.playbackPositions[e]=0}}savePlaybackPosition(){if(this.audioElement&&this.currentSong){const e=this.getSongKey(this.currentSong);this.playbackPositions[e]=this.audioElement.currentTime}}loadPlaybackPosition(){if(this.currentSong){const e=this.getSongKey(this.currentSong),t=this.playbackPositions[e];if(t&&t>0)return t}return 0}loadSong(e,t){if(e<0||e>=this.songs.length)return;t?this.resetPlaybackPosition():this.savePlaybackPosition(),this.audioElement.pause(),this.isPlaying=!1,this.currentIndex=e,this.currentSong=this.songs[this.currentIndex],this.audioElement.src=this.currentSong.audioUrl,this.updateSongDisplay(),this.updateBackground(),this.setupLyrics();const s=this.loadPlaybackPosition();this.audioElement.currentTime=s,this.play()}updateSongDisplay(){const e=this.currentSong;if(this.songTitle.write(e.titleTranslit||e.title||"Unknown Title",21),this.songArtist.write(e.artistTranslit||e.artist||"Unknown Artist",21),this.songCredit.write(e.credit||"",21),e.banner&&"no-media"!==e.banner){const t=new Image;t.onload=()=>{const e=document.createElement("canvas");e.width=96,e.height=32;e.getContext("2d").drawImage(t,0,0,96,32);const s=PIXI.Texture.fromCanvas(e);this.bannerSprite.loadTexture(s)},t.src=e.banner}else this.bannerSprite.loadTexture(null)}updateBackground(){if(this.backgroundSprite.loadTexture(null),this.videoElement.src="",this.currentSong.background&&"no-media"!==this.currentSong.background){const e=new Image;e.onload=()=>{const t=document.createElement("canvas");t.width=192,t.height=112;t.getContext("2d").drawImage(e,0,0,192,112);const s=PIXI.Texture.fromCanvas(t);this.backgroundSprite.loadTexture(s)},e.src=this.currentSong.background}this.currentSong.videoUrl&&(this.videoElement.src=this.currentSong.videoUrl,this.videoElement.play(),this.lastVideoUpdate=game.time.now)}updateDurationDisplay(){const e=this.audioElement.duration;if(isNaN(e)||e==1/0)return void this.durationText.write("--:--");const t=Math.floor(e/60),s=Math.floor(e%60);this.durationText.write(`${t}:${s.toString().padStart(2,"0")}`)}updateProgressBar(){const e=this.audioElement.currentTime,t=this.audioElement.duration;if(isNaN(t)||0===t)return;const s=132*(e/t);this.progressBar.clear(),this.progressBar.lineStyle(2,7797982,1),this.progressBar.moveTo(0,0),this.progressBar.lineTo(s,0)}updateTimeDisplay(){const e=this.audioElement.currentTime,t=Math.floor(e/60),s=Math.floor(e%60);this.currentTimeText.write(`${t}:${s.toString().padStart(2,"0")}`)}updateFullscreenMode(){this.fullscreenMode?(this.backgroundSprite.alpha=1,this.uiBackground.visible=!1,this.bannerSprite.visible=!1,this.songTitle.visible=!1,this.songArtist.visible=!1,this.songCredit.visible=!1,this.currentTimeText.visible=!1,this.durationText.visible=!1,this.progressBarBg.visible=!1,this.progressBar.visible=!1,this.visualizationButton.visible=!1,this.skipLeftButton.visible=!1,this.seekLeftButton.visible=!1,this.pauseButton.visible=!1,this.seekRightButton.visible=!1,this.skipRightButton.visible=!1,this.menuButton.visible=!1,this.navigationHint.visible=!1):(this.backgroundSprite.alpha=.4,this.uiBackground.visible=!0,this.bannerSprite.visible=!0,this.songTitle.visible=!0,this.songArtist.visible=!0,this.songCredit.visible=!0,this.currentTimeText.visible=!0,this.durationText.visible=!0,this.progressBarBg.visible=!0,this.progressBar.visible=!0,this.visualizationButton.visible=!0,this.skipLeftButton.visible=!0,this.seekLeftButton.visible=!0,this.pauseButton.visible=!0,this.seekRightButton.visible=!0,this.skipRightButton.visible=!0,this.menuButton.visible=!0,this.navigationHint.visible=!0),this.lyricsText.visible=!0}toggleFullscreen(){this.fullscreenMode=!this.fullscreenMode,this.updateFullscreenMode()}updateButtonStates(){const e=game.time.now;if(this.menuButton.frame=this.buttonActiveTimers.menu>e?1:0,this.menuVisible||this.songListMenuVisible)return;const t=this.isPlaying?0:1;this.pauseButton.frame=t,this.seekLeftButton.frame=gamepad.held.left?1:0,this.seekRightButton.frame=gamepad.held.right?1:0,this.skipLeftButton.frame=this.buttonActiveTimers.skipLeft>e?1:0,this.skipRightButton.frame=this.buttonActiveTimers.skipRight>e?1:0,this.visualizationButton.frame=this.buttonActiveTimers.visualization>e?1:0}setButtonActive(e,t=100){this.buttonActiveTimers[e]=game.time.now+t}changeVolume(e){let t=Account.settings.volume,s=t+e;if(s=Phaser.Math.clamp(s,0,4),s!==t){Account.settings.volume=s,saveAccount(),this.audioElement.volume=[0,25,50,75,100][s]/100;const e=["MUTE","25%","50%","75%","100%"];notifications.show(`VOLUME: ${e[s]}`,1e3)}}play(){this.audioElement.play().then(()=>{this.isPlaying=!0}).catch(e=>{console.warn("Playback failed:",e),this.isPlaying=!1,this.audioElement.currentTime=0,this.play()})}pause(){this.audioElement.pause(),this.isPlaying=!1}togglePlayback(){this.isPlaying?this.pause():this.play(),this.pauseButton.frame=2,this.setButtonActive("pause",100)}nextSong(e){let t=this.currentIndex+1;t>=this.songs.length&&(t=0),this.loadSong(t,e)}previousSong(){let e=this.currentIndex-1;e<0&&(e=this.songs.length-1),this.loadSong(e)}toggleShuffle(){if(this.isShuffled=!this.isShuffled,this.isShuffled){const e=[...this.songs];for(let t=e.length-1;t>0;t--){const s=Math.floor(Math.random()*(t+1));[e[t],e[s]]=[e[s],e[t]]}this.songs=e}else this.songs=[...this.originalSongOrder];this.setButtonActive("visualization",100)}seekForward(){const e=this.audioElement.currentTime,t=Math.min(e+this.seekSpeed,this.audioElement.duration||1/0);this.audioElement.currentTime=t}seekBackward(){const e=this.audioElement.currentTime,t=Math.max(e-this.seekSpeed,0);this.audioElement.currentTime=t}changeVisualizerMode(){const e=["bars","symmetrical","waveform","circular"],t=(e.indexOf(this.visualizerMode)+1)%e.length;this.visualizerMode=e[t],this.visualizer.setVisualizationType(this.visualizerMode),this.setButtonActive("visualization",100)}showSongList(){this.songListMenuVisible=!0;const e=game.add.graphics(0,0);e.beginFill(0,.7),e.drawRect(0,0,game.width,game.height),e.endFill();const t=new CarouselMenu(20,20,152,72,{bgcolor:"brown",fgcolor:"#ffffff",align:"left",disableScrollBar:!1});this.songs.forEach((s,i)=>{const a=s.titleTranslit||s.title||`Song ${i+1}`,n=i===this.currentIndex,r=n?`> ${a}`:`  ${a}`;t.addItem(r,()=>{i!==this.currentIndex&&this.loadSong(i),t.destroy(),e.destroy(),this.songListMenuVisible=!1},{song:s,index:i,bgcolor:n?"#9b59b6":"brown"})}),t.onCancel.add(()=>{t.destroy(),e.destroy(),this.songListMenuVisible=!1}),t.selectedIndex=this.currentIndex,t.updateSelection()}showMenu(){this.menuVisible=!0,this.setButtonActive("menu",100);const e=game.add.graphics(0,0);e.beginFill(0,.7),e.drawRect(0,0,game.width,game.height),e.endFill();const t=new CarouselMenu(60,40,72,40,{bgcolor:"brown",fgcolor:"#ffffff",align:"center"});t.addItem("Continue",()=>{t.destroy(),e.destroy(),this.menuVisible=!1}),t.addItem("Song List",()=>{t.destroy(),e.destroy(),this.menuVisible=!1,this.showSongList()}),t.addItem("Toggle Shuffle",()=>{this.toggleShuffle(),t.destroy(),e.destroy(),this.menuVisible=!1}),t.addItem("Exit Jukebox",()=>{this.exitJukebox()}),t.onCancel.add(()=>{t.destroy(),e.destroy(),this.menuVisible=!1})}exitJukebox(){this.savePlaybackPosition(),this.audioElement.pause(),this.audioElement.src="",this.videoElement&&(this.videoElement.pause(),this.videoElement.src=""),this.visualizer&&this.visualizer.destroy(),this.lyrics&&this.lyrics.destroy(),game.state.start("MainMenu")}update(){if(this.visualizer&&this.visualizer.update(),this.updateDurationDisplay(),this.updateButtonStates(),this.updateLyrics(),this.videoElement.src&&this.videoElement.readyState>=2){const e=game.time.now;if(e-this.lastVideoUpdate>=33){this.lastVideoUpdate=e;const t=document.createElement("canvas");t.width=192,t.height=112;t.getContext("2d").drawImage(this.videoElement,0,0,192,112);const s=PIXI.Texture.fromCanvas(t);this.backgroundSprite.loadTexture(s)}}this.handleInput()}updateLyrics(){if(this.hasLyrics&&this.lyrics&&this.audioElement){const e=this.audioElement.currentTime;this.lyrics.move(e)}else this.lyricsText.write("")}handleInput(){const e=game.time.now;gamepad.update(),this.menuVisible||this.songListMenuVisible||(gamepad.pressed.up&&this.changeVolume(1),gamepad.pressed.down&&this.changeVolume(-1),gamepad.pressed.a&&this.togglePlayback(),gamepad.pressed.b&&this.toggleFullscreen(),gamepad.pressed.select&&this.changeVisualizerMode(),gamepad.pressed.select&&e-this.lastSelectPress<this.doublePressTimeout&&this.toggleShuffle(),gamepad.pressed.start&&this.showMenu(),e-this.lastSeekTime>this.seekCooldown&&(gamepad.held.left&&(this.seekBackward(),this.lastSeekTime=e),gamepad.held.right&&(this.seekForward(),this.lastSeekTime=e)),gamepad.pressed.left&&e-this.lastLeftPress<this.doublePressTimeout&&(this.previousSong(),this.setButtonActive("skipLeft",100),this.lastSeekTime=e),gamepad.pressed.right&&e-this.lastRightPress<this.doublePressTimeout&&(this.nextSong(),this.setButtonActive("skipRight",100),this.lastSeekTime=e),gamepad.pressed.left&&(this.lastLeftPress=e),gamepad.pressed.right&&(this.lastRightPress=e),gamepad.pressed.select&&(this.lastSelectPress=e),gamepad.pressed.b&&(this.lastBPress=e))}shutdown(){this.savePlaybackPosition(),this.audioElement.pause(),this.audioElement.src="",this.videoElement&&(this.videoElement.pause(),this.videoElement.src=""),this.visualizer&&this.visualizer.destroy(),this.lyrics&&this.lyrics.destroy()}}class Credits{init(e="MainMenu",t={}){this.returnState=e,this.returnStateParams=t,this.scrollSpeed=15,this.isWaitingForInput=!1,this.backgroundInterval=8e3,this.availableBackgrounds=[]}create(){game.camera.fadeIn(0),this.setupBackground(),this.startBackgroundMusic(),this.creditsContainer=game.add.group();const e=[{text:"PADMANIACS",font:FONTS.shaded,tint:7797982,spacing:25},{text:"Created by Retora",font:FONTS.default,tint:16777215,spacing:15},{text:"SONG CREDITS",font:FONTS.shaded,tint:7797982,spacing:20}],t=this.getSongCredits();t.length>0&&(e.push(...t),e.push({text:"",font:FONTS.default,tint:16777215,spacing:15})),e.push({text:"Special Thanks",font:FONTS.shaded,tint:7797982,spacing:20},{text:"StepMania Team",font:FONTS.default,tint:16777215,spacing:8},{text:"photonstorm",font:FONTS.default,tint:16777215,spacing:8},{text:"itch.io",font:FONTS.default,tint:16777215,spacing:8},{text:"You!",font:FONTS.shaded,tint:16777215,spacing:25},{text:COPYRIGHT,font:FONTS.default,tint:8947848,spacing:40});let s=game.height+20;e.forEach((e,t)=>{const i=new Text(game.width/2,s,e.text,e.font,this.creditsContainer);i.anchor.set(.5),i.wrapPreserveNewlines(112),i.tint=e.tint,i.creditData=e,s+=e.spacing}),this.totalHeight=s,this.startY=this.creditsContainer.y,this.creditsComplete=!1,addonManager.executeStateBehaviors(this.constructor.name,this)}setupBackground(){this.backgroundSprite=game.add.sprite(0,0),this.backgroundSprite.alpha=.7,this.collectBackgrounds(),this.availableBackgrounds.length>0?(this.showNextBackground(),this.backgroundTimer=game.time.events.loop(this.backgroundInterval,this.showNextBackground,this)):this.backgroundSprite.loadTexture("ui_background_gradient")}collectBackgrounds(){this.availableBackgrounds=[],window.localSongs&&Array.isArray(window.localSongs)&&window.localSongs.forEach(e=>{e.background&&"no-media"!==e.background&&this.availableBackgrounds.push(e.background),e.banner&&"no-media"!==e.banner&&this.availableBackgrounds.push(e.banner)}),window.externalSongs&&Array.isArray(window.externalSongs)&&window.externalSongs.forEach(e=>{e.background&&"no-media"!==e.background&&this.availableBackgrounds.push(e.background),e.banner&&"no-media"!==e.banner&&this.availableBackgrounds.push(e.banner)}),this.availableBackgrounds=[...new Set(this.availableBackgrounds)],console.log(`Found ${this.availableBackgrounds.length} backgrounds for slideshow`)}showNextBackground(){if(0===this.availableBackgrounds.length)return;const e=game.rnd.pick(this.availableBackgrounds),t=new Image;t.onload=()=>{const e=document.createElement("canvas");e.width=192,e.height=112;e.getContext("2d").drawImage(t,0,0,192,112);const s=PIXI.Texture.fromCanvas(e);this.backgroundSprite.loadTexture(s),this.backgroundSprite.alpha=0,game.add.tween(this.backgroundSprite).to({alpha:.4},1e3,"Linear",!0)},t.src=e}startBackgroundMusic(){backgroundMusic&&backgroundMusic.stop();const e=[];window.localSongs&&Array.isArray(window.localSongs)&&e.push(...window.localSongs),window.externalSongs&&Array.isArray(window.externalSongs)&&e.push(...window.externalSongs);const t=e.filter(e=>e.audioUrl);if(t.length>0){const e=game.rnd.pick(t);this.creditsMusic=document.createElement("audio"),this.creditsMusic.src=e.audioUrl,this.creditsMusic.volume=[0,25,50,75,100][Account.settings.volume]/100,this.creditsMusic.loop=!0,this.creditsMusic.play().catch(e=>{console.warn("Could not play credits music:",e)}),console.log(`Playing credits music: ${e.title||"Unknown Song"}`)}}getSongCredits(){const e=[],t=new Set;return window.localSongs&&Array.isArray(window.localSongs)&&window.localSongs.forEach(s=>{const i=s.credit,a=s.titleTranslit||s.title||"Unknown Song";i&&!t.has(i.toLowerCase())&&(t.add(i.toLowerCase()),e.push({text:a,font:FONTS.default,tint:16777215,spacing:8},{text:`by ${i}`,font:FONTS.default,tint:14737632,spacing:12}))}),e.push({text:"",font:FONTS.default,tint:16777215,spacing:8},{text:"All songs and charts belong to their respective copyright holders.",font:FONTS.default,tint:8947848,spacing:12}),e}update(){if(this.visualizer&&this.visualizer.update(),gamepad.update(),this.creditsComplete)return;this.creditsContainer.y-=this.scrollSpeed*(gamepad.held.any?4:1)*(game.time.elapsed/1e3);this.creditsContainer.y+this.totalHeight<0&&!this.creditsComplete&&(this.creditsComplete=!0,this.onCreditsComplete())}onCreditsComplete(){this.continueText=new Text(game.width/2,game.height/2,"Thank you for playing",FONTS.shaded),this.continueText.anchor.set(.5),this.continueText.alpha=0,game.add.tween(this.continueText).to({alpha:1},1e3,"Linear",!0),this.isWaitingForInput=!0,gamepad.signals.pressed.any.addOnce(()=>{this.returnToMenu()})}returnToMenu(){this.creditsMusic&&(this.creditsMusic.pause(),this.creditsMusic.src="",this.creditsMusic=null),this.backgroundTimer&&game.time.events.remove(this.backgroundTimer),backgroundMusic&&Account.settings.enableMenuMusic&&backgroundMusic.playLastSong(),game.camera.fade(0,1e3),game.camera.onFadeComplete.addOnce(()=>{game.state.start(this.returnState,!0,!1,this.returnStateParams)})}shutdown(){this.skipHandler&&gamepad.signals.pressed.any.remove(this.skipHandler),this.creditsMusic&&(this.creditsMusic.pause(),this.creditsMusic.src=""),this.backgroundTimer&&game.time.events.remove(this.backgroundTimer)}}class ChartRenderer{constructor(e,t,s,i={}){this.scene=e,this.song=t,this.difficultyIndex=s,this.chart=t.chart,this.difficulty=this.chart.difficulties[s],this.notes=this.chart.notes[this.difficulty.type+this.difficulty.rating],this.bpmChanges=this.chart.bpmChanges,this.stops=this.chart.stops,this.options={enableGameplayLogic:!0,enableJudgement:!0,enableInput:!0,enableHealth:!0,enableMissChecking:!0,...i},this.scrollDirection=Account.settings.scrollDirection||"falling",this.VERTICAL_SEPARATION=1.25,this.SCREEN_CONSTANT="C-MOD"===Account.settings.speedMod?4:1,this.NOTE_SPEED_MULTIPLIER=Account.settings.noteSpeedMult+this.SCREEN_CONSTANT,this.JUDGE_LINE="falling"===this.scrollDirection?90:30,this.DIRECTION="falling"===this.scrollDirection?-1:1,this.COLUMN_SIZE=16,this.COLUMN_SEPARATION=4,this.INACTIVE_COLOR=8947848,this.speedMod=Account.settings.speedMod||"X-MOD",this.noteColorOption=Account.settings.noteColorOption||"NOTE";const a=0,n=1,r=2,o=3,h=4,l=5,c=6,d=7,u=8,g=9,m=10,p=11;this.colorMappings={NOTE:{4:a,8:n,12:r,16:o,24:h,32:l,48:c,64:d,96:u,128:g,192:m,default:p},VIVID:{4:o,8:a,12:n,16:c,24:o,32:a,48:n,64:c,96:o,128:a,192:n,default:c},FLAT:{4:o,8:o,12:o,16:o,24:o,32:o,48:o,64:o,96:o,128:o,192:o,default:o},RAINBOW:{4:l,8:n,12:h,16:h,24:n,32:l,48:h,64:n,96:h,128:l,192:n,default:h}},this.linesGroup=new Phaser.SpriteBatch(game),this.receptorsGroup=new Phaser.SpriteBatch(game),this.freezeBodyGroup=new Phaser.Group(game),this.freezeEndGroup=new Phaser.Group(game),this.notesGroup=new Phaser.SpriteBatch(game),this.minesGroup=new Phaser.Group(game),this.explosionsGroup=new Phaser.SpriteBatch(game),this.receptors=[],this.initialize()}initialize(){const e=this.calculateLeftOffset();for(let t=0;t<4;t++){const s=game.add.sprite(e+t*(this.COLUMN_SIZE+this.COLUMN_SEPARATION)+this.COLUMN_SIZE/2,this.JUDGE_LINE,"receptor",2);s.anchor.set(.5),s.angle={0:90,1:0,2:180,3:-90}[t],this.options.enableInput&&(s.inputEnabled=!0,s.down=!1),s.animations.add("down",[2,1,0],30,!1),s.animations.add("up",[0,1,2],30,!1);const i=game.add.sprite(s.x,s.y,"explosion");i.anchor.set(.5),i.angle=s.angle,i.visible=!1,s.explosion=i;const a=50;i.visible=!1,i.scale.setTo(1.5),game.add.tween(i.scale).to({x:2,y:2},a,"Linear",!0).yoyo(!0).repeat(-1),this.receptorsGroup.add(s),this.receptors.push(s)}}calculateLeftOffset(){return(192-(4*this.COLUMN_SIZE+3*this.COLUMN_SEPARATION))/2}getNoteFrame(e){const t=e.beat,s=this.colorMappings[this.noteColorOption],i=Object.keys(s).filter(e=>"default"!==e).map(Number).sort((e,t)=>e-t);for(const e of i)if(this.isBeatDivision(t,e))return s[e];return s.default}isBeatDivision(e,t){const s=1e-4,i=e*t%4;return Math.abs(i)<s||Math.abs(i-4)<s}calculateVerticalPosition(e,t,s){let i,a=0;if("C-MOD"===this.speedMod){if(i=(e.sec-t)*this.COLUMN_SIZE*this.VERTICAL_SEPARATION*this.NOTE_SPEED_MULTIPLIER,e.beatLength){const t=e.secLength||60*e.beatLength/this.getCurrentBPM();a=Math.max(this.COLUMN_SIZE,t*this.COLUMN_SIZE*this.VERTICAL_SEPARATION*this.NOTE_SPEED_MULTIPLIER)}}else{i=(e.beat-s)*this.COLUMN_SIZE*this.VERTICAL_SEPARATION*this.NOTE_SPEED_MULTIPLIER,e.beatLength&&(a=Math.max(this.COLUMN_SIZE,e.beatLength*this.COLUMN_SIZE*this.VERTICAL_SEPARATION*this.NOTE_SPEED_MULTIPLIER))}return{pastSize:i,bodyHeight:a,yPos:"falling"===this.scrollDirection?this.JUDGE_LINE-i:this.JUDGE_LINE+i}}getCurrentBPM(e=0){const t=this.bpmChanges.find((t,s,i)=>s===i.length-1||i[s+1].beat>e);return t?t.bpm:120}getLastBpm(e,t){return this.bpmChanges.find((s,i,a)=>i+1==a.length||a[i+1][t]>=e)}beatToSec(e){let t=this.getLastBpm(e,"beat"),s=(e-t.beat)/t.bpm*60+t.sec,i=this.stops.filter(({beat:s})=>s>=t.beat&&s<e).map(e=>e.len);for(let e in i)s+=i[e];return s}secToBeat(e){let t=this.getLastBpm(e,"sec"),s=this.stops.filter(({sec:s})=>s>=t.sec&&s<e).map(t=>t.sec+t.len>e?e-t.sec:t.len);for(let t in s)e-=s[t];return(e-t.sec)*t.bpm/60+t.beat}render(e,t){"falling"===this.scrollDirection?this.renderFalling(e,t):this.renderRising(e,t),Account.settings.beatLines&&this.renderTimeLines(e,t)}renderFalling(e,t){const s=this.calculateLeftOffset();this.notes.forEach(i=>{let{pastSize:a,bodyHeight:n,yPos:r}=this.calculateVerticalPosition(i,e,t);const o=s+i.column*(this.COLUMN_SIZE+this.COLUMN_SEPARATION);this.options.enableMissChecking&&"M"!==i.type&&"2"!=i.type&&"4"!=i.type&&!i.hit&&!i.miss&&r>game.height&&(i.miss=!0,this.options.enableGameplayLogic&&this.scene.player.processJudgement&&this.scene.player.processJudgement(i,"miss",i.column)),r<-this.COLUMN_SIZE||r>game.height+n?i.sprite&&(i.sprite.kill(),delete i.sprite,i.holdParts&&(i.holdParts.body.destroy(),i.holdParts.end.destroy(),delete i.holdParts)):("M"===i.type?(i.sprite||(i.sprite=this.minesGroup.getFirstDead()||(()=>{const e=game.add.sprite(o,r,"mine");return this.minesGroup.add(e),e})(),i.sprite.reset(0,-32),i.sprite.animations.add("blink",[0,1,2,3,4,5,6,7],10,!0),i.sprite.animations.play("blink")),i.sprite.anchor.set(.5),i.sprite.x=o+this.COLUMN_SIZE/2,i.sprite.y=r):"2"!==i.type&&"4"!==i.type||(r=this.renderHoldNote(i,o,r,n,e,t,"falling")),"M"!==i.type&&"3"!==i.type&&(i.sprite||(i.sprite=this.notesGroup.getFirstDead()||(()=>{const e=game.add.sprite(0,0);return this.notesGroup.add(e),e})(),i.sprite.reset(0,-32),i.sprite.loadTexture("arrows"),i.sprite.frame=this.getNoteFrame(i),i.sprite.anchor.set(.5),i.sprite.angle={0:90,1:0,2:180,3:-90}[i.column]),i.sprite.x=o+this.COLUMN_SIZE/2,i.sprite.y=r))})}renderRising(e,t){const s=this.calculateLeftOffset();this.notes.forEach(i=>{let{pastSize:a,bodyHeight:n,yPos:r}=this.calculateVerticalPosition(i,e,t);const o=s+i.column*(this.COLUMN_SIZE+this.COLUMN_SEPARATION);this.options.enableMissChecking&&"M"!==i.type&&"2"!=i.type&&"4"!=i.type&&!i.hit&&!i.miss&&r<-this.COLUMN_SIZE&&(i.miss=!0,this.options.enableGameplayLogic&&this.scene.player.processJudgement&&this.scene.player.processJudgement(i,"miss",i.column)),r>game.height+this.COLUMN_SIZE||r<-n?i.sprite&&(i.sprite.kill(),delete i.sprite,i.holdParts&&(i.holdParts.body.destroy(),i.holdParts.end.destroy(),delete i.holdParts)):("M"===i.type?(i.sprite||(i.sprite=this.minesGroup.getFirstDead()||(()=>{const e=game.add.sprite(o,r,"mine");return this.notesGroup.add(e),e})(),i.sprite.reset(0,-32),i.sprite.animations.add("blink",[0,1,2,3,4,5,6,7],10,!0),i.sprite.animations.play("blink")),i.sprite.anchor.set(.5),i.sprite.x=o+this.COLUMN_SIZE/2,i.sprite.y=r):"2"!==i.type&&"4"!==i.type||(r=this.renderHoldNote(i,o,r,n,e,t,"rising")),"M"!==i.type&&"3"!==i.type&&(i.sprite||(i.sprite=this.notesGroup.getFirstDead()||(()=>{const e=game.add.sprite(0,0);return this.notesGroup.add(e),e})(),i.sprite.reset(0,-32),i.sprite.loadTexture("arrows"),i.sprite.frame=this.getNoteFrame(i),i.sprite.anchor.set(.5),i.sprite.angle={0:90,1:0,2:180,3:-90}[i.column]),i.sprite.x=o+this.COLUMN_SIZE/2,i.sprite.y=r))})}renderHoldNote(e,t,s,i,a,n,r){if(!e.holdParts){const s="2"===e.type?"hold":"roll",i=()=>{const e=this.freezeBodyGroup.getFirstDead()||(()=>{const e=game.add.tileSprite(-64,-64,this.COLUMN_SIZE,0,`${s}_body`);return"rising"===r?(e.scale.y=-1,e.anchor.y=1):e.anchor.y=1,this.freezeBodyGroup.add(e),e})();return e.reset(t,-64),e.loadTexture(`${s}_body`),e},a=()=>{const e=this.freezeEndGroup.getFirstDead()||(()=>{const e=game.add.sprite(0,0);return"rising"===r?(e.scale.y=-1,e.anchor.y=1):e.anchor.y=1,this.freezeEndGroup.add(e),e})();return e.reset(t,-64),e.loadTexture(`${s}_end`),e};e.holdParts={body:i(),end:a()},e.holdActive=!1}const o=this.options.enableGameplayLogic&&!e.finish&&!e.miss&&this.scene.activeHolds&&this.scene.activeHolds[e.column]?.note===e&&this.scene.activeHolds[e.column].active;let h=void 0!==e.visibleHeight?e.visibleHeight:i;if(h<0&&(h=1),o&&this.options.enableGameplayLogic){if("falling"===r){const t=s-i,a=this.JUDGE_LINE;e.visibleHeight=Math.max(0,a-t),s>a-this.COLUMN_SIZE/2&&(s=a)}else{const t=s+i,a=this.JUDGE_LINE;e.visibleHeight=Math.max(0,t-a),s<a+this.COLUMN_SIZE/2&&(s=a)}e.active=!0}else this.options.enableGameplayLogic&&void 0!==e.visibleHeight&&("falling"===r?s-=i-e.visibleHeight:s+=i-e.visibleHeight,e.active=!1);!this.options.enableMissChecking||e.miss||e.holdActive||("falling"===r&&s>this.JUDGE_LINE+this.COLUMN_SIZE||"rising"===r&&s<this.JUDGE_LINE-this.COLUMN_SIZE)&&(e.miss=!0,this.options.enableGameplayLogic&&this.scene.player.processJudgement&&this.scene.player.processJudgement(e,"miss",e.column));let l=!e.finish,c=Math.floor(s),d=Math.floor(h);"falling"===r?(e.holdParts.body.y=c,e.holdParts.body.height=d,e.holdParts.end.y=c-d):(e.holdParts.body.y=c,e.holdParts.body.height=d,e.holdParts.end.y=c+d),e.holdParts.body.visible=l,e.holdParts.end.visible=l,e.sprite&&(e.sprite.visible=!o&&l);const u=o?1:0,g="2"===e.type?47872:61166,m=e.miss?this.INACTIVE_COLOR:g,p=e.miss?.8:1;return e.holdParts.body.frame=u,e.holdParts.end.frame=u,e.holdParts.body.tint=m,e.holdParts.end.tint=m,e.holdParts.body.alpha=p,e.holdParts.end.alpha=p,s}renderTimeLines(e,t){if(!Account.settings.beatLines)return;const s=Account.settings.beatsPerMeasure||4,i=Math.floor(t/s),a=i+8,n=new Set;for(let r=i;r<=a;r++){const i=r*s;this.updateTimeLine(i,.9,e,t),n.add(i);for(let a=1;a<s;a++){const s=i+a;this.updateTimeLine(s,.35,e,t),n.add(s)}}this.cleanupInvisibleLines(n)}updateTimeLine(e,t,s,i){let a;if("C-MOD"===this.speedMod){const t=(this.beatToSec(e)-s)*this.COLUMN_SIZE*this.VERTICAL_SEPARATION*this.NOTE_SPEED_MULTIPLIER;a="falling"===this.scrollDirection?this.JUDGE_LINE-t:this.JUDGE_LINE+t}else{const t=(e-i)*this.COLUMN_SIZE*this.VERTICAL_SEPARATION*this.NOTE_SPEED_MULTIPLIER;a="falling"===this.scrollDirection?this.JUDGE_LINE-t:this.JUDGE_LINE+t}if(a>=-this.COLUMN_SIZE&&a<=game.height+this.COLUMN_SIZE){let s=this.findLineForBeat(e);return s?(s.y=a,s.alpha=t,s.revive()):(s=this.createLine(a,t),s&&(s.targetBeat=e)),s}return null}findLineForBeat(e){const t=this.linesGroup.getAll("alive",!0);for(let s=0;s<t.length;s++){const i=t[s];if(i.targetBeat===e)return i}return null}createExplosion(e,t="normal"){const s=this.receptors[e.column],i=this.explosionsGroup.getFirstDead()||(()=>{const e=game.add.sprite(-64,-64);return e.anchor.set(.5),this.explosionsGroup.add(e),e})();i.loadTexture("normal"==t?"explosion":"mineexplosion"),i.reset(s.x,s.y),i.alpha=1,i.scale.set(1),i.angle=s.angle;game.add.tween(i.scale).to({x:2,y:2},200,"Linear",!0),game.add.tween(i).to({alpha:0},200,"Linear",!0).onComplete.add(()=>i.kill())}toggleHoldExplosion(e,t){const s=this.receptors[e].explosion;s.visible=t,t&&s.bringToTop()}cleanupInvisibleLines(e){const t=this.linesGroup.getAll("alive",!0);for(let e=0;e<t.length;e++){const s=t[e],i=2*this.COLUMN_SIZE;(s.y<-i||s.y>game.height+i)&&s.kill()}}createLine(e,t){const s=this.linesGroup.getFirstDead()||(()=>{const t=game.add.bitmapData(1,1);t.fill(255,255,255);const s=game.add.sprite(this.calculateLeftOffset(),e,t);return s.width=4*this.COLUMN_SIZE+3*this.COLUMN_SEPARATION,this.linesGroup.add(s),s})();return s.y=e,s.alpha=t,s.revive(),s}destroy(){this.linesGroup.destroy(!0),this.receptorsGroup.destroy(!0),this.freezeBodyGroup.destroy(!0),this.freezeEndGroup.destroy(!0),this.notesGroup.destroy(!0),this.minesGroup.destroy(!0),this.explosionsGroup.destroy(!0)}}class Player{constructor(e){this.scene=e,this.renderer=new ChartRenderer(e,JSON.parse(JSON.stringify(e.song)),e.song.difficultyIndex,{enableGameplayLogic:!0,enableJudgement:!0,enableInput:!0,enableHealth:!0,enableMissChecking:!0}),this.notes=this.renderer.notes,this.bpmChanges=this.renderer.bpmChanges,this.stops=this.renderer.stops,this.autoplay=e.autoplay,this.autoplayActiveHolds=new Set,this.keymap={left:0,down:1,up:2,right:3,a:3,b:2},this.inputStates=[!1,!1,!1,!1],this.lastInputStates=[!1,!1,!1,!1],this.activeHolds={},this.heldColumns=new Set,this.judgementHistory=[],this.lastNoteCheckBeats=[0,0,0,0],this.score=0,this.combo=0,this.maxCombo=0,this.maxHealth=100,this.health=this.maxHealth,this.previousHealth=this.health,this.timingStory=[],this.HOLD_FORGIVENESS=.3,this.ROLL_FORGIVENESS=.3,this.ROLL_REQUIRED_INTERVALS=.5,this.judgementCounts={marvelous:0,perfect:0,great:0,good:0,boo:0,miss:0},this.totalNotes=0,this.accuracy=0,this.gameOver=!1,this.skillSystem=this.scene.skillSystem,this.perfectStreak=0,this.comboShieldActive=!1,this.skillSystem.onHealthRegen=e=>this.onSkillHpRegen(e),this.skillSystem.onComboShield=()=>this.onComboShield(),this.calculateTotalNotes(),this.updateAccuracy(),this.receptors=this.renderer.receptors,this.judgementText=this.scene.judgementText||new Text(96,20,"",{tint:16777215}),this.comboText=this.scene.comboText||new Text(96,40,"0",{tint:16777215}),this.scoreText=this.scene.scoreText||new Text(8,8,"00000000",{tint:16777215}),this.healthText=this.scene.healthText||new Text(184,8,"100%",{tint:16777215})}calculateTotalNotes(){this.totalNotes=this.notes.filter(e=>"1"===e.type||"2"===e.type||"4"===e.type).length}calculateLeftOffset(){return(192-(4*this.COLUMN_SIZE+3*this.COLUMN_SEPARATION))/2}findClosestNote(e,t,s,i=.5){const a=this.scene.getCurrentTime().now,n=i*(this.getCurrentBPM(t)/60),r=this.notes.filter(i=>!i.hit&&i.column===e&&s.includes(i.type)&&Math.abs(i.beat-t)<=n);return 0===r.length?null:r.reduce((e,t)=>Math.abs(t.sec-a)<Math.abs(e.sec-a)?t:e)}findNotesInJudgeWindow(e,t,s,i){return this.notes.filter(a=>!a.hit&&a.column===e&&s.includes(a.type)&&Math.abs(a.beat-t)<=i)}processNoteIfInWindow(e,t,s,i){const a=e.sec-t,n=this.scene.JUDGE_WINDOWS.boo/1e3;return Math.abs(a)<=n&&this.lastNoteCheckBeats[s]!==e.beat&&(i(e,a),this.lastNoteCheckBeats[s]=e.beat,!0)}autoPlay(){if(!this.scene.startTime||this.scene.isPaused)return;const{now:e,beat:t}=this.scene.getCurrentTime();for(let t=0;t<4;t++){const s=this.notes.find(e=>!e.hit&&e.column===t&&"1"===e.type);if(s){const i=s.sec-e;Math.abs(i)<=this.scene.JUDGE_WINDOWS.marvelous/1e3&&!this.inputStates[t]&&(this.handleInput(t,!0),this.handleInput(t,!1))}}for(let e=0;e<4;e++){const s=this.findClosestNote(e,t,["2","4"]);if(s&&!this.autoplayActiveHolds.has(e)){Math.abs(s.beat-t)<=this.scene.JUDGE_WINDOWS.marvelous&&(this.handleInput(e,!0),this.autoplayActiveHolds.add(e))}const i=this.activeHolds[e];i&&i.progress>=i.note.secLength&&(this.handleInput(e,!1),this.autoplayActiveHolds.delete(e))}for(let e of this.autoplayActiveHolds){const t=this.activeHolds[e];t&&!t.note.hit||(this.handleInput(e,!1),this.autoplayActiveHolds.delete(e))}}handleInput(e,t){if(!this.scene.startTime||this.scene.isPaused)return;const{now:s,beat:i}=this.scene.getCurrentTime(),a=this.activeHolds[e];if(this.inputStates[e]=t,t){this.heldColumns.add(e);const t=this.getHoldForgiveness();a?.inactive&&s-a.lastRelease<t&&(a.active=!0,a.inactive=!1,a.pressCount++,a.lastPress=s,this.toggleHoldExplosion(e,!0)),"4"===a?.note.type&&(a.tapped++,a.lastTap=s,a.active=!0,a.inactive=!1);const n=this.checkRegularNotes(e,s,i);a||n||this.checkHoldStart(e,s,i)}else this.heldColumns.delete(e),this.checkHoldRelease(e,s)}checkRegularNotes(e,t,s){const i=this.findClosestNote(e,s,["1"]);return!!i&&this.processNoteIfInWindow(i,t,e,(t,s)=>{console.log("Time delta:",1e3*s,"ms");const i=this.getJudgement(s);this.createExplosion(t),t.sprite?.destroy(),!t.hit&&this.processJudgement(t,i,e),t.hit=!0})}checkMines(e,t,s){const i=this.notes.filter(t=>!t.hit&&t.column===e&&"M"===t.type&&Math.abs(t.beat-s)<=.1);let a=!1;for(const e of i){const{yPos:i}=this.renderer.calculateVerticalPosition(e,t,s),n=this.renderer.JUDGE_LINE;Math.abs(i-n)<=12&&(this.triggerMine(e),a=!0)}return a}triggerMine(e){this.createExplosion(e,"mine"),e.hit=!0,e.sprite?.destroy();const t=this.skillSystem?this.skillSystem.getMineDamageMultiplier():1,s=Math.floor(10*t);this.health=Math.max(0,this.health-s),this.combo=0,this.skillSystem&&this.skillSystem.checkSkillActivation("on_mine_hit",{})}checkHoldStart(e,t,s){const i=this.findClosestNote(e,s,["2","4"]);i&&this.processNoteIfInWindow(i,t,e,(s,i)=>{const a=this.getJudgement(i);this.processJudgement(s,a,e),this.activeHolds[e]={note:s,startTime:t,progress:0,tapped:0,pressCount:0,active:!0,inactive:!1,lastPress:t,lastRelease:null,lastTap:t},s.holdActive=!0,this.toggleHoldExplosion(e,!0)})}checkHoldRelease(e,t){const s=this.activeHolds[e];if(s&&(s.lastRelease=t,"2"===s.note.type)){const i=this.getHoldForgiveness();s.note.secLength-(t-s.startTime)>i&&(s.active=!1,s.inactive=!0,this.toggleHoldExplosion(e,!1))}}createExplosion(e,t="normal"){this.renderer.createExplosion(e,t)}toggleHoldExplosion(e,t){this.renderer.toggleHoldExplosion(e,t)}getAdjustedJudgementWindows(){const e={...this.scene.JUDGE_WINDOWS},t=this.skillSystem?this.skillSystem.getJudgementWindowMultiplier():1;return Object.keys(e).forEach(s=>{e[s]*=t}),e}getHoldForgiveness(){return this.HOLD_FORGIVENESS*(this.skillSystem?this.skillSystem.getHoldForgivenessMultiplier():1)}getRollForgiveness(){return this.ROLL_FORGIVENESS*(this.skillSystem?this.skillSystem.getRollForgivenessMultiplier():1)}getJudgement(e){this.timingStory.push(e);const t=this.getAdjustedJudgementWindows(),s=Math.abs(1e3*e);for(const[e,i]of Object.entries(t))if(s<=i)return"marvelous"===e||"perfect"===e?this.perfectStreak++:this.perfectStreak=0,e;return"miss"}processJudgement(e,t,s,i="normal"){if("miss"===t&&this.comboShieldActive&&(t="boo",this.comboShieldActive=!1),this.skillSystem&&(this.skillSystem.checkSkillActivation("on_miss",{judgement:t}),this.perfectStreak>0&&this.skillSystem.checkSkillActivation("on_perfect_streak",{perfectStreak:this.perfectStreak})),this.skillSystem){const e=this.skillSystem.getJudgementConversion();e&&t===e.from&&(t=e.to)}let a="";switch(t){case"ok":a="marvelous";break;case"n.g.":case"ng":a="boo",t="n.g.";break;default:a=t}this.autoplay&&(t="normal"==i?"marvelous":"ok",a="marvelous");const n=this.skillSystem?this.skillSystem.getScoreMultiplier(a):1,r=Math.floor(this.scene.SCORE_VALUES[a]*n);if(this.gameOver||(this.score+=r),this.judgementCounts[a]++,"miss"===t)this.combo=0,this.health=Math.max(0,this.health-5);else{this.combo++;const e=this.skillSystem?this.skillSystem.getHealthGainMultiplier():1,t=Math.floor(2*e);this.gameOver||(this.health=Math.min(this.getMaxHealth(),this.health+t)),this.combo>this.maxCombo&&(this.maxCombo=this.combo)}this.updateAccuracy(),this.updateUI(),this.showJudgementText(t,s,i)}getMaxHealth(){return this.maxHealth+(this.skillSystem?this.skillSystem.getMaxHealthBonus():0)}getNoteSpeedMultiplier(){return this.NOTE_SPEED_MULTIPLIER*(this.skillSystem?this.skillSystem.getNoteSpeedMultiplier():1)}updateAccuracy(){if(this.gameOver)return;const e={marvelous:1,perfect:.9,great:.8,good:.5,boo:.25,miss:0};let t=0,s=0;for(const[i,a]of Object.entries(this.judgementCounts)){t+=1*a,s+=a*e[i]}const i=Object.values(this.judgementCounts).reduce((e,t)=>e+t,0);if(t+=1*Math.max(0,this.totalNotes-i),this.accuracy=t>0?s/t*100:100,this.accuracy=Phaser.Math.clamp(this.accuracy,0,100),this.scene.accuracyBar){const e=Math.floor(Math.max(1,this.accuracy/100*150));this.scene.accuracyBar.crop(new Phaser.Rectangle(0,0,e,2))}}updateUI(){this.comboText.write(this.combo.toString()),this.comboText.tint=this.getComboColor(this.combo),this.scoreText.write(this.score.toString().padStart(8,"0")),this.combo>0&&this.pulseText(this.comboText)}getScoreRating(){const e=this.accuracy;return e>=98?"SSS+":e>=95?"SSS":e>=92.5?"SS":e>=90?"S":e>=80?"A":e>=70?"B":e>=60?"C":e>=50?"D":e>=40?"E":"F"}showJudgementText(e,t,s){let i={marvelous:65535,perfect:16776960,great:65280,good:255,boo:16753920,miss:16711680,ok:52224,ng:2293759}[e.replace("n.g.","ng")];if("freeze"==s){const s=new Text(this.renderer.receptors[t].x,this.renderer.JUDGE_LINE+12*this.renderer.DIRECTION,e,FONTS.stroke);s.tint=i,s.anchor.setTo(.5),game.add.tween(s).to({alpha:0,y:s.y+8*this.renderer.DIRECTION},250,"Linear",!0,25).onComplete.addOnce(()=>s.destroy())}else if(this.judgementText.write(e.toUpperCase()),this.judgementText.tint=i,this.judgementText.alpha=1,this.judgementText.scale.set(1),game.tweens.removeFrom(this.judgementText),game.add.tween(this.judgementText.scale).to({x:1.5,y:1},200,"Linear",!0).yoyo(!0),game.add.tween(this.judgementText).to({alpha:0},200,"Linear",!0,200),void 0!==t&&"miss"!==e){const e=this.receptors[t];this.pulseSprite(e)}}pulseText(e){e.scale.set(1),game.add.tween(e.scale).to({x:1.3,y:1.3},100,"Linear",!0).yoyo(!0)}pulseSprite(e){e.scale.set(1),game.add.tween(e.scale).to({x:1.2,y:1.2},50,"Linear",!0).yoyo(!0)}getComboColor(e){const t=100,s=Math.min(t,e);return Math.floor(255+s/t*0)<<16|Math.floor(255+s/t*0)<<8|Math.floor(255+s/t*-255)}onSkillHpRegen(e=0){this.gameOver||(this.health=Math.min(this.getMaxHealth(),this.health+e))}onComboShield(){this.comboShieldActive=!0}getCurrentBPM(e=0){return this.renderer.getCurrentBPM(e)}getLastBpm(e,t){return this.renderer.getLastBpm(e,t)}beatToSec(e){return this.renderer.beatToSec(e)}secToBeat(e){return this.renderer.secToBeat(e)}render(){if(!this.scene.startTime||this.scene.isPaused)return;this.renderer.scene.activeHolds=this.activeHolds;const{now:e,beat:t}=this.scene.getCurrentTime();this.renderer.render(e,t)}update(){const{now:e,beat:t}=this.scene.getCurrentTime();if(this.autoplay)this.autoPlay();else{Object.keys(this.keymap).forEach(e=>{gamepad.pressed[e]?this.handleInput(this.keymap[e],!0):gamepad.released[e]&&this.handleInput(this.keymap[e],!1)});for(let s=0;s<4;s++)this.inputStates[s]&&this.checkMines(s,e,t)}for(let e=0;e<4;e++){const t=this.receptors[e],s=this.inputStates[e];t.down!=s&&(t.down=s),t.frame=s?0:2}this.skillSystem&&(this.skillSystem.update(),this.combo>0&&(this.skillSystem.checkSkillActivation("on_combo",{combo:this.combo}),this.skillSystem.checkSkillActivation("on_high_combo",{combo:this.combo})),this.health<=30&&this.skillSystem.checkSkillActivation("on_low_health",{health:this.health}),this.health<=15&&this.skillSystem.checkSkillActivation("on_critical_health",{health:this.health})),this.health!=this.previousHealth&&(this.previousHealth=this.health,game.add.tween(this.scene.lifebarMiddle).to({width:this.health/this.getMaxHealth()*102},100,Phaser.Easing.Quadratic.In,!0),this.health<=0&&(this.gameOver=!0,this.health=0),this.healthText.write(this.health.toString())),this.scene.lifebarEnd.x=this.scene.lifebarMiddle.width,this.scene.accuracyBar&&(this.accuracy<=0?this.scene.accuracyBar.visible=!1:this.scene.accuracyBar.visible=!0),Object.entries(this.activeHolds).forEach(([e,t])=>{const{now:s}=this.scene.getCurrentTime();if(this.autoplay||"2"===t.note.type){if(!t.active){const i=this.getHoldForgiveness();s-t.lastRelease>i&&(t.inactive=!0,t.note.miss=!0,this.toggleHoldExplosion(e,!1))}}else if("4"===t.note.type){const i=this.getRollForgiveness();s-t.lastTap>i&&(t.inactive=!0,t.active=!1,t.note.miss=!0,this.toggleHoldExplosion(e,!1))}if(t.progress=s-t.startTime,t.progress>=t.note.secLength){let s="n.g.";if("2"===t.note.type)s=t.note.miss?"n.g.":"ok";else if("4"===t.note.type){const e=Math.ceil(t.note.beatLength*this.ROLL_REQUIRED_INTERVALS);s=t.note.beatLength<=.5||t.tapped>=e&&!t.note.miss?"ok":"n.g."}t.note.finish=!0,this.processJudgement(t.note,s,Number(e),"freeze"),t.note.hit=!0,this.toggleHoldExplosion(e,!1),delete this.activeHolds[e]}})}destroy(){this.renderer&&this.renderer.destroy()}}