/**
 * PadManiacs Rhythm Game
 * Copyright (C) RETORA 2025
 * Licensed under the PadManiacs License (see LICENSE file for full terms)
 * 
 * Source: https://github.com/RetoraDev/PadManiacs
 * Version: v0.0.6 dev
 * Build: 11/17/2025, 2:10:10 PM
 * Platform: Development
 * Debug: false
 * Minified: true
 */

const COPYRIGHT="(C) RETORA 2025",VERSION="v0.0.6 dev";window.DEBUG=!1;const FONTS={default:{font:"font_tiny"},tiny:{font:"font_tiny"},shaded:{font:"font_tiny_shaded"},stroke:{font:"font_tiny_stroke",fontWidth:5},number:{font:"font_tiny_number",fontMap:"1234567890 "},combo:{font:"font_combo",fontMap:"0123456789 ",fontWidth:8,fontHeight:8}},WINDOW_PANELS=["1"],DEFAULT_SONG_FOLDERS=["MikiMikiRomanticNight","ThousandCherryBlossoms","UndeadEnemy","Carnival","HatsuneMiku-Melt","KagamineRin-LoveIsWar(R184mmRemix)","KasaneTerritory-KasaneTeto","ANewWorld","39","AsuNoHikari","TheDubstepSoldiersattheFront","JustBeFriends","GentleDespair","Palette","GiganticGirl","melody_2.exe"],JUDGE_WINDOWS={marvelous:.2,perfect:.25,great:.3,good:.35,boo:.45},SCORE_VALUES={marvelous:1e3,perfect:800,great:500,good:200,boo:50,miss:0},ENVIRONMENT={UNKNOWN:"WEB",NWJS:"NWJS",CORDOVA:"CORDOVA",WEB:"WEB"},CURRENT_ENVIRONMENT=ENVIRONMENT.UNKNOWN,CORDOVA_EXTERNAL_DIRECTORY="PadManiacs/",NWJS_EXTERNAL_DIRECTORY="data/",EXTERNAL_DIRECTORY=CURRENT_ENVIRONMENT==ENVIRONMENT.CORDOVA?"PadManiacs/":"data/",ADDONS_DIRECTORY="Addons",SCREENSHOTS_DIRECTORY="Screenshots",SONGS_DIRECTORY="Songs",ENABLE_PARALLEL_LOADING=!1,MAX_PARALLEL_DOWNLOADS=16,MAX_PARALLEL_ADDON_LOADS=3,ENABLE_ADDON_SAFE_MODE=!0,ENABLE_UI_SFX=!1,DEFAULT_ACCOUNT={settings:{volume:3,autoplay:!1,enableMenuMusic:!0,randomSong:!1,renderer:0,pixelated:!0,noteColorOption:"NOTE",noteSpeedMult:1,userOffset:0,scrollDirection:"falling",visualizer:"NONE",metronome:"OFF",beatLines:!1,beatsPerMeasure:4,speedMod:"X-MOD",safeMode:!1,enabledAddons:[],hibernatingAddons:[]},lastSong:null,highScores:{}};class FileSystemTools{constructor(){this.platform=this.detectPlatform(),"nwjs"===this.platform?this.fileSystem=new NodeFileSystem:"cordova"===this.platform?this.fileSystem=new CordovaFileSystem:this.fileSystem=new FallbackFileSystem,console.log(`FileSystem: Using ${this.platform} implementation`)}detectPlatform(){return"undefined"!=typeof nw&&nw.process?"nwjs":"undefined"!=typeof cordova&&cordova.file?"cordova":"fallback"}getDirectory(t){return this.fileSystem.getDirectory(t)}listDirectories(t){return this.fileSystem.listDirectories(t)}listAllDirectories(t){return this.fileSystem.listAllDirectories(t)}listFiles(t){return this.fileSystem.listFiles(t)}getFile(t){return this.fileSystem.getFile(t)}readFileContent(t){return this.fileSystem.readFileContent(t)}saveFile(t,e,s){return this.fileSystem.saveFile(t,e,s)}createEmptyFile(t,e,s){return this.fileSystem.createEmptyFile(t,e,s)}writeFile(t,e,s){return this.fileSystem.writeFile(t,e,s)}createDirectory(t,e){return this.fileSystem.createDirectory(t,e)}getBasePath(){return"nwjs"===this.platform&&this.fileSystem.getBasePath?this.fileSystem.getBasePath():""}canExitApp(){return"nwjs"===this.platform||"cordova"===this.platform}exitApp(){"nwjs"===this.platform?"undefined"!=typeof nw&&nw.App&&nw.App.quit():"cordova"===this.platform&&"undefined"!=typeof navigator&&navigator.app&&navigator.app.exitApp()}}class NodeDirectoryEntry{constructor(t,e,s,i){this.isFile=!1,this.isDirectory=!0,this.name=t,this.fullPath=e,this.filesystem=s,this.nativeURL=i||`file://${e}`}createReader(){const t=require("fs"),e=require("path"),s=e.join(this.filesystem.basePath,this.fullPath);return{readEntries:(i,a)=>{try{const a=[],n=t.readdirSync(s);for(const i of n){const n=e.join(s,i),o=t.statSync(n),r=e.join(this.fullPath,i);o.isDirectory()?a.push(new NodeDirectoryEntry(i,r,this.filesystem,`file://${n}`)):a.push(new NodeFileEntry(i,r,this.filesystem,`file://${n}`))}i(a)}catch(t){a(t)}}}}getDirectory(t,e,s,i){const a=require("fs"),n=require("path"),o=n.join(this.filesystem.basePath,this.fullPath,t);try{if(!a.existsSync(o)){if(!e||!e.create)throw new Error(`Directory not found: ${t}`);a.mkdirSync(o,{recursive:!0})}if(!a.statSync(o).isDirectory())throw new Error(`Path is not a directory: ${t}`);s(new NodeDirectoryEntry(n.basename(t),n.join(this.fullPath,t),this.filesystem,`file://${o}`))}catch(t){i(t)}}getFile(t,e,s,i){const a=require("fs"),n=require("path"),o=n.join(this.filesystem.basePath,this.fullPath,t);try{if(!a.existsSync(o)){if(!e||!e.create)throw new Error(`File not found: ${t}`);a.writeFileSync(o,"")}if(!a.statSync(o).isFile())throw new Error(`Path is not a file: ${t}`);s(new NodeFileEntry(n.basename(t),n.join(this.fullPath,t),this.filesystem,`file://${o}`))}catch(t){i(t)}}removeRecursively(t,e){const s=require("fs"),i=require("path"),a=i.join(this.filesystem.basePath,this.fullPath);try{const e=t=>{if(s.existsSync(t)){const a=s.readdirSync(t);for(const n of a){const a=i.join(t,n);s.statSync(a).isDirectory()?e(a):s.unlinkSync(a)}s.rmdirSync(t)}};e(a),t()}catch(t){e(t)}}}class NodeFileEntry{constructor(t,e,s,i){this.isFile=!0,this.isDirectory=!1,this.name=t,this.fullPath=e,this.filesystem=s,this.nativeURL=i||`file://${e}`}createWriter(t,e){const s=require("fs"),i=require("path").join(this.filesystem.basePath,this.fullPath);try{t({write:t=>{try{if(t instanceof Blob){const a=new FileReader;a.onload=()=>{s.writeFileSync(i,Buffer.from(a.result))},a.onerror=()=>e(a.error),a.readAsArrayBuffer(t)}else"string"==typeof t?s.writeFileSync(i,t):t instanceof ArrayBuffer?s.writeFileSync(i,Buffer.from(t)):s.writeFileSync(i,t)}catch(t){e(t)}}})}catch(t){e(t)}}file(t,e){const s=require("fs"),i=require("path").join(this.filesystem.basePath,this.fullPath);try{const e=s.statSync(i),a={name:this.name,size:e.size,type:this.getMimeType(this.name),lastModified:e.mtime,slice:(t,e)=>s.readFileSync(i).slice(t,e),localURL:i};a._path=i,t(a)}catch(t){e(t)}}getMimeType(t){return{png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",bmp:"image/bmp",mp3:"audio/mpeg",wav:"audio/wav",ogg:"audio/ogg",mp4:"video/mp4",avi:"video/x-msvideo",mov:"video/quicktime",sm:"text/plain",ssc:"text/plain",json:"application/json",txt:"text/plain"}[t.split(".").pop().toLowerCase()]||"application/octet-stream"}}class NodeFileSystem{constructor(){try{this.fs=require("fs"),this.path=require("path"),this.basePath=this.getBasePath(),this.fileSystemObj={name:"nodefs",root:new NodeDirectoryEntry("","/",this,`file://${this.basePath}`)}}catch(t){throw console.error("Node.js modules not available:",t),t}}getBasePath(){return"undefined"!=typeof nw&&nw.process?nw.process.cwd():"undefined"!=typeof process&&process.cwd?process.cwd():"."}getDirectory(t){return new Promise((e,s)=>{const i=this.path.join(this.basePath,t);this.fs.stat(i,(a,n)=>{if(a)return void s(a);if(!n.isDirectory())return void s(new Error(`Path is not a directory: ${t}`));const o=new NodeDirectoryEntry(this.path.basename(t)||".",t,this,`file://${i}`);e(o)})})}listDirectories(t){return new Promise((e,s)=>{t.createReader().readEntries(t=>e(t.filter(t=>t.isDirectory)),t=>s(t))})}listAllDirectories(t){return new Promise(async e=>{const s=[],i=[t];for(;i.length;){const t=i.shift();try{const e=await this.listDirectories(t);s.push(...e),i.push(...e)}catch(e){console.warn(`Error listing directories in ${t.name}:`,e)}}e(s)})}listFiles(t){return new Promise((e,s)=>{t.createReader().readEntries(t=>e(t.filter(t=>t.isFile)),t=>s(t))})}getFile(t){return new Promise((e,s)=>{t.file(t=>e(t),t=>s(t))})}readFileContent(t){return new Promise((e,s)=>{if(t._path)this.fs.readFile(t._path,"utf8",(t,i)=>{t?s(t):e(i)});else{const i=new FileReader;i.onload=()=>e(i.result),i.onerror=()=>s(i.error),i.readAsText(t)}})}saveFile(t,e,s){return new Promise((e,i)=>{t.getFile(s,{create:!0,exclusive:!1},t=>e(t),t=>i(t))})}createEmptyFile(t,e,s){return new Promise((s,i)=>{t.getFile(e,{create:!0,exclusive:!1},t=>s(t),t=>i(t))})}writeFile(t,e,s){return new Promise((s,i)=>{t.createWriter(t=>{t.write(e),s(t)},t=>i(t))})}createDirectory(t,e){return new Promise((s,i)=>{t.getDirectory(e,{create:!0},t=>s(t),t=>i(t))})}}class CordovaFileSystem{getDirectory(t){return new Promise((e,s)=>{let i=LocalFileSystem.PERSISTENT;game.device.windows?i=cordova.file.dataDirectory:game.device.macOS||game.device.iOS?i=cordova.file.documentsDirectory:game.device.android&&(i=cordova.file.externalRootDirectory),window.resolveLocalFileSystemURL(i+t,t=>e(t),t=>s(t))})}listDirectories(t){return new Promise((e,s)=>{t.createReader().readEntries(t=>e(t.filter(t=>t.isDirectory)),t=>s(t))})}listAllDirectories(t){return new Promise(async e=>{const s=[],i=[t];for(;i.length;){const t=i.shift();try{const e=await this.listDirectories(t);s.push(...e),i.push(...e)}catch(e){console.warn(`Error listing directories in ${t.name}:`,e)}}e(s)})}listFiles(t){return new Promise((e,s)=>{t.createReader().readEntries(t=>e(t.filter(t=>t.isFile)),t=>s(t))})}getFile(t){return new Promise((e,s)=>{t.file(t=>e(t),t=>s(t))})}readFileContent(t){return new Promise((e,s)=>{const i=new FileReader;i.onload=()=>e(i.result),i.onerror=()=>s(i.error),i.readAsText(t)})}saveFile(t,e,s){return new Promise((i,a)=>{t.getFile(s,{create:!0,exclusive:!1},t=>{this.writeFile(t,e).then(()=>i(t)).catch(t=>a(t))},t=>a(t))})}createEmptyFile(t,e,s){return new Promise((i,a)=>{t.getFile(e,{create:!0,exclusive:!1},t=>{this.writeFile(t,null,s).then(()=>i(t)).catch(t=>a(t))},t=>a(t))})}writeFile(t,e,s){return new Promise((s,i)=>{t.createWriter(t=>{t.onwrite=()=>s(t),t.onerror=t=>i(t),t.write(e)})})}createDirectory(t,e){return new Promise((s,i)=>{t.getDirectory(e,{create:!0},t=>{s(t)},t=>i(t))})}}class FallbackFileSystem{getDirectory(t){return Promise.reject(new Error("File system not available in this environment"))}listDirectories(t){return Promise.reject(new Error("File system not available in this environment"))}listAllDirectories(t){return Promise.reject(new Error("File system not available in this environment"))}listFiles(t){return Promise.reject(new Error("File system not available in this environment"))}getFile(t){return Promise.reject(new Error("File system not available in this environment"))}readFileContent(t){return Promise.reject(new Error("File system not available in this environment"))}saveFile(t,e,s){return Promise.reject(new Error("File system not available in this environment"))}createEmptyFile(t,e,s){return Promise.reject(new Error("File system not available in this environment"))}writeFile(t,e,s){return Promise.reject(new Error("File system not available in this environment"))}createDirectory(t,e){return Promise.reject(new Error("File system not available in this environment"))}}let game,gamepad,backgroundMusic,notifications,addonManager,Account={...DEFAULT_ACCOUNT,...JSON.parse(localStorage.getItem("Account")||"{}")};const saveAccount=()=>localStorage.setItem("Account",JSON.stringify(Account)),bootGame=()=>{game&&game.destroy(),game=new Phaser.Game({width:192,height:112,renderer:Account.settings.renderer,scaleMode:Phaser.ScaleManager.SHOW_ALL,crisp:Account.settings.pixelated,antialias:!1,alignV:!1,alignH:!0,enableDebug:!1,failIfMajorPerformanceCaveat:!1,forceSetTimeOut:!1,clearBeforeRender:!0,forceSingleUpdate:!0,maxPointers:0,keyboard:!0,mouse:!1,mouseWheel:!1,mspointer:!1,multiTexture:!1,pointerLock:!1,preserveDrawingBuffer:!1,roundPixels:!0,touch:!1,transparent:!1,parent:"game",state:{create(){game.state.add("Boot",Boot),game.state.add("Load",Load),game.state.add("LoadCordova",LoadCordova),game.state.add("LoadAddons",LoadAddons),game.state.add("LoadLocalSongs",LoadLocalSongs),game.state.add("LoadExternalSongs",LoadExternalSongs),game.state.add("LoadSongFolder",LoadSongFolder),game.state.add("Title",Title),game.state.add("MainMenu",MainMenu),game.state.add("SongSelect",SongSelect),game.state.add("Play",Play),game.state.add("Results",Results),game.state.add("Jukebox",Jukebox),game.state.add("Credits",Credits),game.state.start("Boot"),game.recorder=new ScreenRecorder(game)}},...window.GameConfig||{}})};window.onload=bootGame;const addFpsText=()=>{const t=new Text(190,2,"");t.anchor.x=1,game.time.events.loop(1e3,()=>t.write(`FPS: ${game.time.fps}`))},Audio={pool:{},add:function(t,e=1,s=!1,i=!0){return i&&this.pool[t]||(this.pool[t]=game.add.audio(t)),this.pool[t]},play:function(t,e=1,s=!1,i=!0){if(game)return i&&this.pool[t]||(this.pool[t]=game.add.audio(t)),this.pool[t].play(null,0,e,s,i)},stop:function(t,e){if(game){const s=this.pool[t];return void(s&&(e?s.stop():(s.fadeOut(),s.onFadeComplete.addOnce(()=>s.stop()))))}}};class Gamepad{constructor(t){this.game=t,this.keys=["up","down","left","right","a","b","select","start"],this.held={},this.pressed={},this.released={},this.prevState={},this.keys.forEach(t=>{this.held[t]=!1,this.pressed[t]=!1,this.released[t]=!1,this.prevState[t]=!1}),this.held.any=!1,this.pressed.any=!1,this.released.any=!1,this.prevState.any=!1,this.keyboardMap={up:[Phaser.KeyCode.UP,Phaser.KeyCode.B],down:[Phaser.KeyCode.DOWN,Phaser.KeyCode.F,Phaser.KeyCode.V],left:[Phaser.KeyCode.LEFT,Phaser.KeyCode.D,Phaser.KeyCode.C],right:[Phaser.KeyCode.RIGHT,Phaser.KeyCode.N],a:[Phaser.KeyCode.Z,Phaser.KeyCode.K],b:[Phaser.KeyCode.X,Phaser.KeyCode.J],select:[Phaser.KeyCode.SHIFT,Phaser.KeyCode.TAB,Phaser.KeyCode.SPACEBAR],start:[Phaser.KeyCode.ENTER,Phaser.KeyCode.ESC,Phaser.KeyCode.P]},this.gamepadMap={up:12,down:13,left:14,right:15,a:0,b:1,select:8,start:9},this.signals={pressed:{},released:{}},this.keys.forEach(t=>{this.signals.pressed[t]=new Phaser.Signal,this.signals.released[t]=new Phaser.Signal}),this.signals.pressed.any=new Phaser.Signal,this.signals.released.any=new Phaser.Signal,this.activeTouches=new Map,this.maxTouches=4,this.lastInputSource="none",this.inputDetectionTimeout=null,this.touchControlsVisible=!1,this.setupKeyboard(),this.setupGamepad(),this.setupTouch(),this.setupInputDetection()}setupKeyboard(){this.keyboardState={},this.keys.forEach(t=>{this.keyboardState[t]=!1}),this.keyCodeToAction={};for(const[t,e]of Object.entries(this.keyboardMap))e.forEach(e=>{this.keyCodeToAction[e]=t});const t=[];for(const e of Object.values(this.keyboardMap))t.push(...e);const e=[...new Set(t)];this.game.input.keyboard.addKeyCapture(e),this.game.input.keyboard.onDownCallback=t=>{const e=this.keyCodeToAction[t.keyCode];e&&(this.held[e]=!0,this.keyboardState[e]=!0),this.detectInputSource("keyboard")},this.game.input.keyboard.onUpCallback=t=>{const e=this.keyCodeToAction[t.keyCode];e&&(this.held[e]=!1,this.keyboardState[e]=!1)}}setupGamepad(){this.game.input.gamepad.supported&&(this.game.input.gamepad.start(),this.gamepadState={},this.keys.forEach(t=>{this.gamepadState[t]=!1}),this.game.input.gamepad.onDownCallback=t=>{this.keys.forEach(e=>{this.gamepadMap[e]==t&&(this.held[e]=!0,this.gamepadState[e]=!0,this.detectInputSource("gamepad"))})},this.game.input.gamepad.onUpCallback=t=>{this.keys.forEach(e=>{this.gamepadMap[e]==t&&(this.held[e]=!1,this.gamepadState[e]=!1)})})}setupTouch(){this.controllerElement=document.getElementById("controller"),this.controllerElement&&(this.dpadElements={up:document.getElementById("controller_up"),down:document.getElementById("controller_down"),left:document.getElementById("controller_left"),right:document.getElementById("controller_right")},this.buttonElements={a:document.getElementById("controller_a"),b:document.getElementById("controller_b"),select:document.getElementById("controller_select"),start:document.getElementById("controller_start"),rhythm_up:document.getElementById("controller_rhythm_up"),rhythm_down:document.getElementById("controller_rhythm_down"),rhythm_left:document.getElementById("controller_rhythm_left"),rhythm_right:document.getElementById("controller_rhythm_right")},this.setupControllerTouchEvents(),this.updateTouchControlsVisibility())}setupInputDetection(){document.addEventListener("touchstart",t=>{t.target.closest("#controller")||this.detectInputSource("touch")},{passive:!0}),document.addEventListener("mousedown",t=>{this.game.device.touch&&!t.target.closest("#controller")&&this.detectInputSource("touch")},{passive:!0})}detectInputSource(t){this.lastInputSource!==t&&(this.lastInputSource=t,this.inputDetectionTimeout&&clearTimeout(this.inputDetectionTimeout),this.updateTouchControlsVisibility(),"touch"!==t&&this.game.device.touch&&(this.inputDetectionTimeout=setTimeout(()=>{this.lastInputSource===t&&(this.lastInputSource="none",this.updateTouchControlsVisibility())},1e4)))}updateTouchControlsVisibility(){if(!this.controllerElement)return;const t=this.game.device.touch&&("touch"===this.lastInputSource||"none"===this.lastInputSource);t!==this.touchControlsVisible&&(this.controllerElement.style.display=t?"block":"none",this.touchControlsVisible=t)}setupControllerTouchEvents(){const t=this.controllerElement,e=t=>t.preventDefault();t.addEventListener("touchstart",e,{passive:!1}),t.addEventListener("touchmove",e,{passive:!1}),t.addEventListener("touchend",e,{passive:!1}),t.addEventListener("touchcancel",e,{passive:!1}),t.addEventListener("touchstart",t=>this.handleTouchStart(t)),t.addEventListener("touchmove",t=>this.handleTouchMove(t)),t.addEventListener("touchend",t=>this.handleTouchEnd(t)),t.addEventListener("touchcancel",t=>this.handleTouchEnd(t))}handleTouchStart(t){const e=t.changedTouches;for(let t=0;t<e.length;t++){const s=e[t];if(this.activeTouches.size>=this.maxTouches)continue;const i=this.getButtonFromTouch(s);if(i){this.activeTouches.set(s.identifier,i),this.held[i.replace("rhythm_","")]=!0,this.detectInputSource("touch");const t=this.dpadElements[i]||this.buttonElements[i];t&&t.classList.add("btnPressed")}}}handleTouchMove(t){const e=t.changedTouches;for(let t=0;t<e.length;t++){const s=e[t],i=this.activeTouches.get(s.identifier);if(void 0!==i){const t=this.getButtonFromTouch(s);if(t&&t!==i){this.held[i.replace("rhythm_","")]=!1,this.held[t.replace("rhythm_","")]=!0;const e=this.dpadElements[i]||this.buttonElements[i],a=this.dpadElements[t]||this.buttonElements[t];e&&e.classList.remove("btnPressed"),a&&a.classList.add("btnPressed"),this.activeTouches.set(s.identifier,t)}else if(!t){this.held[i.replace("rhythm_","")]=!1;const t=this.dpadElements[i]||this.buttonElements[i];t&&t.classList.remove("btnPressed")}}}}handleTouchEnd(t){const e=t.changedTouches;for(let t=0;t<e.length;t++){const s=e[t],i=this.activeTouches.get(s.identifier);if(void 0!==i){this.held[i.replace("rhythm_","")]=!1;const t=this.dpadElements[i]||this.buttonElements[i];t&&t.classList.remove("btnPressed"),this.activeTouches.delete(s.identifier)}}}getButtonFromTouch(t){const e=document.elementFromPoint(t.clientX,t.clientY);if(!e)return null;const s=e.closest('[id^="controller_"]');if(!s)return null;const i=s.id.replace("controller_","");return this.keys.includes(i)||i.startsWith("rhythm_")?i:null}update(){if(this.dontUpdateThisTime)return void delete this.dontUpdateThisTime;this.updateButtonStates();let t=!1,e=!1;this.keys.forEach(s=>{this.pressed[s]&&(this.signals.pressed[s].dispatch(),t=!0),this.released[s]&&(this.signals.released[s].dispatch(),e=!0)}),t&&this.signals.pressed.any.dispatch(),e&&this.signals.released.any.dispatch(),this.keys.forEach(t=>{this.prevState[t]=this.held[t]}),this.prevState.any=this.held.any}isTouchControlled(t){return Array.from(this.activeTouches.values()).includes(t)}updateButtonStates(){let t=!1,e=!1,s=!1;this.keys.forEach(i=>{this.pressed[i]=this.held[i]&&!this.prevState[i],this.released[i]=!this.held[i]&&this.prevState[i],this.pressed[i]&&(t=!0),this.released[i]&&(e=!0),this.held[i]&&(s=!0)}),this.pressed.any=t,this.released.any=e,this.held.any=s}releaseAll(){this.keys.forEach(t=>{this.held[t]=!1,this.pressed[t]=!1,this.released[t]=!1}),this.held.any=!1,this.pressed.any=!1,this.released.any=!1}press(t){this.dontUpdateThisTime=!0,this.pressed[t]=!0,this.pressed.any=!0,this.held[t]=!0,this.held.any=!0}isDirectionPressed(){return this.held.up||this.held.down||this.held.left||this.held.right}getDirection(){let t=0,e=0;return this.held.left&&(t-=1),this.held.right&&(t+=1),this.held.up&&(e-=1),this.held.down&&(e+=1),0!==t&&0!==e&&(t*=.7071,e*=.7071),{x:t,y:e}}reset(){this.releaseAll(),this.activeTouches.clear(),Object.values(this.dpadElements).forEach(t=>t?.classList.remove("btnPressed")),Object.values(this.buttonElements).forEach(t=>t?.classList.remove("btnPressed"))}destroy(){this.inputDetectionTimeout&&clearTimeout(this.inputDetectionTimeout),this.keyboardKeys&&Object.values(this.keyboardKeys).forEach(t=>{t.forEach(t=>{t.onDown.removeAll(),t.onUp.removeAll()})}),this.game.input.gamepad&&(this.game.input.gamepad.onConnectCallback=null,this.game.input.gamepad.onDisconnectCallback=null),this.signals&&(Object.values(this.signals.pressed).forEach(t=>t?.removeAll()),Object.values(this.signals.released).forEach(t=>t?.removeAll())),this.controllerElement&&this.controllerElement.remove(),this.activeTouches?.clear()}}class ScreenRecorder{constructor(t){this.game=t,this.mediaRecorder=null,this.recordedBlobs=[],this.isRecording=!1,this.stream=null,this.videoBitsPerSecond=11e5,this.videoFrameRate=25,this.scale=1,this.imageScale=7,this.canvas=t.canvas,this.canvas.captureStream||console.error("Canvas captureStream is not supported in this browser")}async start(t=null,e=0){if(this.isRecording)console.warn("Already recording");else if(this.canvas.captureStream)try{this.scaledCanvas=document.createElement("canvas"),this.scaledCanvas.width=this.canvas.width*this.scale,this.scaledCanvas.height=this.canvas.height*this.scale,this.scaledContext=this.scaledCanvas.getContext("2d"),this.scaledContext.imageSmoothingEnabled=!1,this.scaledContext.webkitImageSmoothingEnabled=!1,this.scaledContext.mozImageSmoothingEnabled=!1,this.stream=this.scaledCanvas.captureStream(this.videoFrameRate),t&&await this.addAudioToStream(t,e);let s={mimeType:"video/webm; codecs=vp9",videoBitsPerSecond:this.videoBitsPerSecond};MediaRecorder.isTypeSupported(s.mimeType)||(s={mimeType:"video/webm; codecs=vp8",videoBitsPerSecond:this.videoBitsPerSecond},MediaRecorder.isTypeSupported(s.mimeType)||(s={mimeType:"video/webm",videoBitsPerSecond:this.videoBitsPerSecond})),this.mediaRecorder=new MediaRecorder(this.stream,s),this.recordedBlobs=[],this.mediaRecorder.ondataavailable=t=>{t.data&&t.data.size>0&&this.recordedBlobs.push(t.data)},this.mediaRecorder.onstop=()=>{this.save(),this.cleanup()},this.mediaRecorder.onerror=t=>{console.error("MediaRecorder error:",t.error),this.isRecording=!1,this.cleanup()},this.mediaRecorder.start(1e3),this.isRecording=!0,this.startRenderingLoop(),console.log(`Started recording with MIME type: ${s.mimeType}, audio delay: ${e}ms`)}catch(t){console.error("MediaRecorder init failed:",t),this.cleanup()}else console.error("Screen recording not supported in this browser")}startRenderingLoop(){const t=()=>{this.isRecording&&this.scaledCanvas&&this.scaledContext&&(this.scaledContext.fillStyle="#000000",this.scaledContext.fillRect(0,0,this.scaledCanvas.width,this.scaledCanvas.height),this.scaledContext.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,0,0,this.scaledCanvas.width,this.scaledCanvas.height),requestAnimationFrame(t))};t()}stop(){if(this.isRecording&&this.mediaRecorder)try{this.mediaRecorder.stop(),this.isRecording=!1,console.log("Stopped recording")}catch(t){console.error("Error stopping recorder:",t),this.cleanup()}else console.warn("Not recording")}pause(){this.isRecording&&this.mediaRecorder&&"recording"===this.mediaRecorder.state&&(this.mediaRecorder.pause(),console.log("Recording paused"))}resume(){this.isRecording&&this.mediaRecorder&&"paused"===this.mediaRecorder.state&&(this.mediaRecorder.resume(),console.log("Recording resumed"))}screenshot(){const t=document.createElement("canvas");t.width=this.game.width*this.imageScale,t.height=this.game.height*this.imageScale;const e=t.getContext("2d");e.imageSmoothingEnabled=!1,e.webkitImageSmoothingEnabled=!1,e.mozImageSmoothingEnabled=!1,e.fillStyle="#000000",e.fillRect(0,0,t.width,t.height);const s=this.game.add.renderTexture(this.game.width,this.game.height,"screenshotTemp");s.renderXY(this.game.world,0,0,!0);const i=s.getCanvas();e.drawImage(i,0,0,this.game.width,this.game.height,0,0,t.width,t.height),t.toBlob(async t=>{const e=`screenshot-${Date.now()}.png`;await this.saveFile(e,t),console.log("Screenshot saved:",e)},"image/png"),s.destroy()}async save(t){if(0===this.recordedBlobs.length)return void console.warn("No recording data available");const e=new Blob(this.recordedBlobs,{type:"video/webm"});t||(t=`recording_${Date.now()}.webm`),await this.saveFile(t,e),console.log("Recording saved as:",t)}async saveFile(t,e){if(CURRENT_ENVIRONMENT===ENVIRONMENT.CORDOVA||CURRENT_ENVIRONMENT===ENVIRONMENT.NWJS){const s=new FileSystemTools,i="Screenshots",a=await s.getDirectory(EXTERNAL_DIRECTORY+i);await s.saveFile(a,e,t)}else{const s=window.URL.createObjectURL(e),i=document.createElement("a");i.style.display="none",i.href=s,i.download=t,document.body.appendChild(i),i.click(),setTimeout(()=>{document.body.removeChild(i),window.URL.revokeObjectURL(s)},100)}}async addAudioToStream(t=null,e=0){try{if(t&&t.src){if(e>0&&(console.log(`Applying audio delay: ${e}ms`),t.currentTime>0&&(t.currentTime=Math.max(0,t.currentTime-e/1e3)),await new Promise(t=>setTimeout(t,e))),t.paused){console.warn("Audio element is paused, attempting to play it");try{await t.play()}catch(t){console.warn("Could not play audio element:",t)}}if(t.captureStream){const e=t.captureStream();if(await new Promise(t=>setTimeout(t,100)),e&&e.getAudioTracks().length>0)return e.getAudioTracks().forEach(t=>{console.log("Adding audio track:",t),this.stream.addTrack(t)}),console.log("Game audio added to recording"),!0;console.warn("Audio stream has no audio tracks")}else console.warn("Audio element does not support captureStream")}console.log("Falling back to microphone audio");return(await navigator.mediaDevices.getUserMedia({audio:!0})).getAudioTracks().forEach(t=>{this.stream.addTrack(t)}),console.log("Microphone audio added to recording"),!0}catch(t){return console.warn("Could not add audio to recording:",t),!1}}async addAudioAfterStart(t=null,e=0){if(!this.isRecording||!this.mediaRecorder)return console.warn("Cannot add audio - recording not started"),!1;this.mediaRecorder.pause();try{const s=await this.addAudioToStream(t,e);return this.mediaRecorder.resume(),s}catch(t){return console.error("Error adding audio after start:",t),this.mediaRecorder.resume(),!1}}cleanup(){this.isRecording=!1,this.stream&&(this.stream.getTracks().forEach(t=>t.stop()),this.stream=null),this.scaledCanvas&&(this.scaledCanvas=null,this.scaledContext=null),this.mediaRecorder=null}static isSupported(){return!(!HTMLCanvasElement.prototype.captureStream||!window.MediaRecorder)}getState(){return this.mediaRecorder?this.mediaRecorder.state:"inactive"}setScale(t){this.scale=t,console.log(`Scale factor set to: ${this.scale}`)}getScale(){return this.scale}}class NotificationSystem{constructor(){this.queue=[],this.isShowing=!1,this.currentNotification=null,this.duration=3e3,this.lineHeight=8,this.padding=8,this.maxLineWidth=160,this.charWidth=4,this.notificationWindow=null,this.notificationTexts=null,this.restrictedStates=new Set(["Title","Play","Load","LoadLocalSongs","LoadExternalSongs","LoadSongFolder","Boot"]),this.allowedStates=new Set(["MainMenu","SongSelect","Results"]),this.setupStateChangeHandling()}setupStateChangeHandling(){const t=game.state.start;game.state.start=function(e,s,i,...a){return notifications&&notifications.isShowing&&notifications.preserveCurrentNotification(),t.call(this,e,s,i,...a)},game.state.onStateChange.add(this.onStateChange,this)}onStateChange(t){game.time.events.add(100,()=>{const t=game.state.getCurrentState(),e=t?.constructor?.name||"";this.isStateAllowed(e)&&this.processPendingNotifications(),this.preservedNotification&&this.restorePreservedNotification()})}show(t,e=3e3){const s=game.state.getCurrentState(),i=s?.constructor?.name||"",a=this.wrapText(t);this.queue.push({text:a,originalText:t,duration:e,endTime:Date.now()+e,queuedInState:i}),this.isStateAllowed(i)&&!this.isShowing&&this.processNext()}wrapText(t){const e=t.split("\n"),s=[];for(let t of e){if(this.getTextWidth(t)<=this.maxLineWidth){s.push(t);continue}let e="";const i=t.split(" ");for(let t of i){if(this.getTextWidth(t)>this.maxLineWidth){e&&(s.push(e.trim()),e="");const i=this.breakLongWord(t);s.push(...i);continue}const i=e?`${e} ${t}`:t;this.getTextWidth(i)<=this.maxLineWidth?e=i:(e&&s.push(e.trim()),e=t)}e&&s.push(e.trim())}return s.join("\n")}breakLongWord(t){const e=[];let s="";for(let i=0;i<t.length;i++)s+=t[i],this.getTextWidth(s+(t[i+1]||""))>this.maxLineWidth&&(e.push(s),s="");return s&&e.push(s),e}getTextWidth(t){return t.length*this.charWidth}processPendingNotifications(){this.queue.length>0&&!this.isShowing&&(console.log(`ðŸ“¢ Processing ${this.queue.length} pending notifications`),this.processNext())}processNext(){const t=game.state.getCurrentState(),e=t?.constructor?.name||"";if(!this.isStateAllowed(e))return void console.log(`ðŸ“¢ Processing blocked in restricted state: ${e}`);if(0===this.queue.length)return void(this.isShowing=!1);this.isShowing=!0;const s=this.queue.shift();this.currentNotification=s,console.log(`ðŸ“¢ Showing notification: "${s.originalText}"`),this.displayNotification(s.text),game.time.events.add(s.duration,()=>{this.hideCurrent()})}preserveCurrentNotification(){this.currentNotification&&this.notificationWindow&&(this.preservedNotification={text:this.currentNotification.text,originalText:this.currentNotification.originalText,duration:this.currentNotification.duration,remainingTime:this.currentNotification.endTime-Date.now()},this.cleanupUI())}restorePreservedNotification(){if(this.preservedNotification){const t=game.state.getCurrentState(),e=t?.constructor?.name||"";if(!this.isStateAllowed(e))return void console.log(`ðŸ“¢ Restore blocked in restricted state: ${e}`);const s=this.preservedNotification;this.displayNotification(s.text),this.isShowing=!0;const i=Math.max(500,s.remainingTime);game.time.events.add(i,()=>{this.hideCurrent()}),this.currentNotification={text:s.text,originalText:s.originalText,duration:i,endTime:Date.now()+i},this.preservedNotification=null}}displayNotification(t){const e=t.split("\n"),s=e.length,i=Math.min(this.maxLineWidth,Math.max(...e.map(t=>this.getTextWidth(t)))),a=Math.floor(Math.min(180,i+2*this.padding)),n=Math.floor(s*this.lineHeight+2*this.padding),o=(game.width-a)/2;this.notificationWindow=new Window(o/8,.5,a/8,n/8,"1"),this.notificationWindow.focus=!1,this.notificationWindow.selector.visible=!1,this.notificationTexts=[],e.forEach((t,e)=>{const s=new Text(a/2,this.padding+e*this.lineHeight+this.lineHeight/2,t,{...FONTS.default,tint:7797982});s.anchor.set(.5),this.notificationWindow.addChild(s),this.notificationTexts.push(s)}),this.notificationWindow.alpha=0,game.add.tween(this.notificationWindow).to({alpha:1},300,"Linear",!0)}hideCurrent(){if(this.currentNotification){game.add.tween(this.notificationWindow).to({alpha:0},300,"Linear",!0).onComplete.add(()=>{this.cleanupUI(),this.currentNotification=null;const t=game.state.getCurrentState(),e=t?.constructor?.name||"";this.isStateAllowed(e)&&this.processNext()})}}cleanupUI(){this.notificationWindow&&(this.notificationWindow.destroy(),this.notificationWindow=null),this.notificationTexts&&(this.notificationTexts.forEach(t=>t.destroy()),this.notificationTexts=null)}isStateRestricted(t){return this.restrictedStates.has(t)||!this.allowedStates.has(t)&&""!==t}isStateAllowed(t){return this.allowedStates.has(t)}canShowInCurrentState(){const t=game.state.getCurrentState(),e=t?.constructor?.name||"";return this.isStateAllowed(e)}setWrappingSettings(t=160,e=4){this.maxLineWidth=t,this.charWidth=e}wrapTextToLines(t,e=3){const s=this.wrapText(t),i=s.split("\n");if(i.length<=e)return s;const a=i.slice(0,e-1).join("\n");let n=i[e-1];for(;this.getTextWidth(n+"...")>this.maxLineWidth&&n.length>3;)n=n.slice(0,-1);return a+"\n"+n+"..."}getQueueStatus(){const t=game.state.getCurrentState(),e=t?.constructor?.name||"";return{queueLength:this.queue.length,isShowing:this.isShowing,currentState:e,isStateAllowed:this.isStateAllowed(e),hasPreserved:!!this.preservedNotification,maxLineWidth:this.maxLineWidth}}clear(){this.queue=[],this.currentNotification&&this.hideCurrent(),this.preservedNotification=null}hasActiveNotifications(){return this.isShowing||this.queue.length>0||this.preservedNotification}getNotificationCount(){let t=this.queue.length;return this.isShowing&&t++,this.preservedNotification&&t++,t}destroy(){this.clear(),game.state.onStateChange.remove(this.onStateChange,this)}}class Lyrics{constructor(t={}){this.textElement=t.textElement||null,this.maxLineLength=t.maxLineLength||30,this.currentTime=0,this.lrcData=[],this.rangeLrc=[],this.currentLineIndex=-1,t.lrc&&this.setLrc(t.lrc)}setLrc(t){this.tags={},this.lrcData=[],this.rangeLrc=[],this.currentLineIndex=-1;const e=/\[([a-z]+):(.*)\].*/,s=/(\[[0-9.:\[\]]*\])+(.*)/,i=/\[([0-9]+):([0-9.]+)\]/,a=t.split(/[\r\n]/);for(let t=0;t<a.length;t++){const n=e.exec(a[t]);if(n&&n[0]){this.tags[n[1]]=n[2];continue}const o=s.exec(a[t]);if(o&&o[0]){const t=o[1].replace(/\]\[/g,"],[").split(","),e=o[2].trim();for(let s=0;s<t.length;s++){const a=i.exec(t[s]);if(a&&a[0]){const t=60*parseInt(a[1],10)+parseFloat(a[2]);this.lrcData.push({startTime:t,line:e})}}}}this.lrcData.sort((t,e)=>t.startTime-e.startTime);let n=0,o="";for(let t=0;t<this.lrcData.length;t++){const e=this.lrcData[t].startTime;this.rangeLrc.push({startTime:n,endTime:e,line:o}),n=e,o=this.lrcData[t].line}this.rangeLrc.push({startTime:n,endTime:Number.MAX_SAFE_INTEGER,line:o})}move(t){this.currentTime=t;for(let e=0;e<this.rangeLrc.length;e++)if(t>=this.rangeLrc[e].startTime&&t<this.rangeLrc[e].endTime)return void(this.currentLineIndex!==e&&this.textElement&&(this.currentLineIndex=e,this.displayCurrentLine()));-1!==this.currentLineIndex&&this.textElement&&(this.currentLineIndex=-1,this.textElement.write(""))}displayCurrentLine(){if(!this.textElement||this.currentLineIndex<0)return;const t=this.rangeLrc[this.currentLineIndex].line.trim();t?(this.textElement.isScrolling&&this.textElement.stopScrolling&&this.textElement.stopScrolling(),this.textElement.write(t),t.length>this.maxLineLength&&this.textElement.wrap(5*this.maxLineLength)):this.textElement.write("")}getCurrentLine(){return this.currentLineIndex>=0&&this.currentLineIndex<this.rangeLrc.length?this.rangeLrc[this.currentLineIndex].line:""}getNextLine(){const t=this.currentLineIndex+1;return t<this.rangeLrc.length?this.rangeLrc[t].line:""}hasLyrics(){return this.lrcData.length>0}clear(){this.textElement&&this.textElement.write(""),this.currentLineIndex=-1,this.lrcData=[],this.rangeLrc=[]}destroy(){this.clear(),this.textElement=null}}class Metronome{constructor(t){this.scene=t,this.player=t.player,this.mode=Account.settings.metronome,this.enabled="OFF"!==this.mode,this.beatDivisions={OFF:0,Quarters:1,Eighths:2,Sixteenths:4,"Thirty-seconds":8,Note:"Note"},this.lastDivisionValue=-1,this.currentDivision=this.beatDivisions[this.mode],this.noteIndex=0,this.lastNoteBeat=-1,this.notes=[],this.scene.onSelectPressed=this.toggle.bind(this)}update(){this.enabled&&("Note"===this.mode?this.updateNoteMode():this.updateBeatMode())}updateBeatMode(){if(0===this.currentDivision)return;const{beat:t}=this.scene.getCurrentTime(),e=this.getCurrentDivisionValue(t);e!==this.lastDivisionValue&&(this.playTick(),this.lastDivisionValue=e)}updateNoteMode(){const{beat:t}=this.scene.getCurrentTime(),e=t;if(0===this.notes.length&&this.initializeNotes(),this.noteIndex>=this.notes.length)return;const s=this.notes[this.noteIndex];if(e>=s)for(this.playTick(),this.lastNoteBeat=s,this.noteIndex++;this.noteIndex<this.notes.length&&this.notes[this.noteIndex]===this.lastNoteBeat;)this.noteIndex++}initializeNotes(){const t=this.scene.song.chart.difficulties[this.scene.song.difficultyIndex],e=`${t.type}${t.rating}`,s=this.scene.song.chart.notes[e];if(!s)return void(this.notes=[]);const i=new Set;for(const t of s)if("1"===t.type||"2"===t.type||"4"===t.type){const e=Math.round(1e3*t.beat)/1e3;i.add(e)}this.notes=Array.from(i).sort((t,e)=>t-e),this.noteIndex=0,this.lastNoteBeat=-1}getCurrentDivisionValue(t){return 0===this.currentDivision?-1:Math.floor(t*this.currentDivision)}playTick(){if(game.cache.checkSoundKey("assist_tick")){const t=game.add.audio("assist_tick");t.volume=.5,t.play()}}toggle(){"OFF"!=this.mode&&(this.enabled=!this.enabled,this.lastDivisionValue=-1,this.resetNoteMode())}resetNoteMode(){this.noteIndex=0,this.lastNoteBeat=-1,this.notes=[]}setMode(t){this.beatDivisions.hasOwnProperty(t)&&(this.mode=t,this.currentDivision=this.beatDivisions[t],this.lastDivisionValue=-1,this.resetNoteMode(),this.enabled="OFF"!==t,Account.settings.metronome=t,saveAccount())}destroy(){this.enabled=!1,this.lastDivisionValue=-1,this.resetNoteMode(),this.statusText&&(this.statusText.destroy(),this.statusText=null)}}class OffsetAssistant extends Phaser.Sprite{constructor(t){super(t,0,0),this.taps=[],this.confidenceThreshold=.8,this.maxTaps=16,this.requiredTaps=8,this.tickBPM=120,this.tickInterval=6e4/this.tickBPM,this.wasMusicPlaying=backgroundMusic&&backgroundMusic.isPlaying,this.originalMusicTime=0,this.pauseBackgroundMusic(),this.startTickSound(),this.background=t.add.graphics(0,0),this.background.beginFill(0,.8),this.background.drawRect(0,0,t.width,t.height),this.background.endFill(),this.addChild(this.background),this.instructionText=new Text(t.width/2,t.height/2-20,"TAP A TO THE TICK",FONTS.shaded),this.instructionText.anchor.set(.5),this.addChild(this.instructionText),this.offsetText=new Text(t.width/2,t.height/2+10,"Offset: 0ms",FONTS.default),this.offsetText.anchor.set(.5),this.addChild(this.offsetText),this.tapCounter=new Text(t.width/2,t.height/2+30,"Taps: 0",FONTS.default),this.tapCounter.anchor.set(.5),this.tapCounter.alpha=.7,this.addChild(this.tapCounter),this.exitText=new Text(t.width/2,t.height-10,"Press B to exit and save",FONTS.default),this.exitText.anchor.set(.5),this.exitText.alpha=.5,this.addChild(this.exitText),this.lastAPress=!1,this.lastBPress=!1,this.lastTickTime=0,this.nextTickTime=this.game.time.now,this.calculatedOffsets=[]}update(){gamepad.pressed.a&&!this.lastAPress&&this.onTap(),this.lastAPress=gamepad.pressed.a,gamepad.pressed.b&&!this.lastBPress&&this.exit(),this.lastBPress=gamepad.pressed.b,this.updateTickSound(),this.tapCounter.write(`Taps: ${this.taps.length}`)}pauseBackgroundMusic(){backgroundMusic&&backgroundMusic.isPlaying&&(this.originalMusicTime=backgroundMusic.audio.currentTime,backgroundMusic.stop())}resumeBackgroundMusic(){backgroundMusic&&this.wasMusicPlaying&&(backgroundMusic.audio.currentTime=this.originalMusicTime,backgroundMusic.audio.play())}startTickSound(){game.cache.checkSoundKey("assist_tick")?(this.playTickSound(),this.lastTickTime=this.game.time.now,this.nextTickTime=this.lastTickTime+this.tickInterval):console.warn("Tick sound not preloaded!")}updateTickSound(){if(this.destroyed)return;const t=this.game.time.now;t>=this.nextTickTime&&(this.playTickSound(),this.lastTickTime=t,this.nextTickTime=t+this.tickInterval)}playTickSound(){if(game.cache.checkSoundKey("assist_tick")){const t=game.add.audio("assist_tick");t.volume=.5,t.play()}}onTap(){const t=this.game.time.now;this.taps.push(t),this.taps.length>this.maxTaps&&this.taps.shift(),this.calculateOffset(),this.showTapFeedback()}calculateOffset(){if(this.taps.length<2)return this.offsetText.write("Offset: 0ms"),void(this.offsetText.tint=16777215);const t=[];for(let e=0;e<this.taps.length;e++){const s=this.taps[e],i=Math.round((s-this.taps[0])/this.tickInterval),a=s-(this.taps[0]+i*this.tickInterval);t.push(a)}const e=t.reduce((t,e)=>t+e,0)/t.length,s=25*Math.round(e/25);this.calculatedOffsets.push(s),this.calculatedOffsets.length>5&&this.calculatedOffsets.shift();const i=this.calculatedOffsets.length>0?25*Math.round(this.calculatedOffsets.reduce((t,e)=>t+e,0)/this.calculatedOffsets.length/25):s,a=this.calculateConfidence(t),n=`Offset: ${i}ms`;this.offsetText.write(n),this.taps.length>=this.requiredTaps&&a>=this.confidenceThreshold?this.offsetText.tint=65280:this.taps.length>=4?this.offsetText.tint=16776960:this.offsetText.tint=16777215}calculateConfidence(t){if(t.length<3)return 0;const e=t.reduce((t,e)=>t+e,0)/t.length,s=t.reduce((t,s)=>t+Math.pow(s-e,2),0)/t.length,i=Math.sqrt(s),a=Math.max(0,1-i/50);return Math.min(1,a)}roundToNearestMultipleOf25(t){const e=Math.round(t/25);return e>=0?25*e:25*(e+1)}showTapFeedback(){this.game.add.tween(this.instructionText.scale).to({x:1.1,y:1.1},50,Phaser.Easing.Quadratic.Out,!0).yoyo(!0)}exit(){let t=0;if(this.calculatedOffsets.length>0)t=this.roundToNearestMultipleOf25(this.calculatedOffsets.reduce((t,e)=>t+e,0)/this.calculatedOffsets.length),Account.settings.userOffset=t,saveAccount(),notifications.show(`Offset set to ${t}ms`);else if(this.taps.length>0){const t=this.parseOffsetText();null!==t&&(Account.settings.userOffset=t,saveAccount(),notifications.show(`Offset set to ${t}ms`))}this.resumeBackgroundMusic(),this.destroy(),game.state.getCurrentState().menu()}parseOffsetText(){const t=this.offsetText.text.match(/Offset: (-?\d+)ms/);return t?parseInt(t[1],10):null}destroy(){this.resumeBackgroundMusic(),this.destroyed=!0,this.background.destroy(),this.instructionText.destroy(),this.offsetText.destroy(),this.tapCounter.destroy(),this.exitText.destroy(),super.destroy()}}class Text extends Phaser.Sprite{constructor(t,e,s="",i,a){i={font:"font_tiny",fontMap:" ABCDEFGHIJKLMNOPQRSTUVWXYZ.,:!Â¡?Â¿h+-Ã—*()[]/\\0123456789_'\"`â€¢<>=%",fontWidth:4,fontHeight:6,typewriter:!1,typewriterInterval:100,...i},super(game,t,e),this.config=i,this.texture=new Phaser.RetroFont(game,i.font,i.fontWidth,i.fontHeight,i.fontMap),this.texture.multiLine=!0,this.texture.autoUpperCase=!0,this.timer=game.time.create(!1),this.typewriterInterval=i.typewriterInterval,i.typewriter?this.typewriter(s):this.write(s),game.add.existing(this),a&&(a instanceof Phaser.Group?a.add(this):a instanceof PIXI.DisplayObjectContainer&&a.addChild(this))}write(t,e){return e&&t.length>e?this.scrollwrite(t,e):(this.timer.running&&this.timer.stop(),this.texture.text=t),this}typewrite(t,e){this.timer.running&&this.timer.stop();let s=0;return this.texture.text="",this.timer.loop(this.typewriterInterval,()=>{s<t.length?(this.write(this.texture.text+t[s]),s++):(e&&e(),this.timer.stop())}),this.timer.start(),this}scrollwrite(t,e=5,s=200,i=5){this.timer.running&&this.timer.stop();const a=t+" ".repeat(i);let n=0,o=!0;const r=()=>{if(!this.visible||!o)return;let t="";for(let s=0;s<e;s++){t+=a[(n+s)%a.length]}this.texture.text=t,n=(n+1)%a.length};return this.timer.loop(s,()=>r()),r(),this.timer.start(),{stop:()=>{o=!1,this.timer.stop()},pause:()=>{o=!1},resume:()=>{o=!0},setSpeed:t=>{s=t,this.timer.loopDelay=t}}}stopScrolling(){this.timer.running&&this.timer.stop()}isScrolling(){return this.timer.running}wrap(t,e=1){if(!this.texture.text)return this;const s=this.texture.text,i=this.config.fontWidth||4,a=Math.floor(t/i);if(a<=0)return this;const n=s.split(" "),o=[];let r="";for(let t=0;t<n.length;t++){const e=n[t],s=r?`${r} ${e}`:e;if(e.length>a){r&&(o.push(r),r="");let t="";for(let s=0;s<e.length;s++)t+=e[s],(t.length>=a||s===e.length-1)&&(o.push(t),t="");continue}s.length<=a?r=s:(o.push(r),r=e)}r&&o.push(r);const h=o.join("\n");return this.write(h),this}wrapPreserveNewlines(t,e=1){if(!this.texture.text)return this;const s=this.texture.text,i=this.config.fontWidth||4,a=Math.floor(t/i);if(a<=0)return this;const n=s.split("\n"),o=[];for(const t of n){if(t.length<=a){o.push(t);continue}const e=t.split(" ");let s="";for(let t=0;t<e.length;t++){const i=e[t];if(i.length>a){s&&(o.push(s),s="");let t="";for(let e=0;e<i.length;e++)t+=i[e],(t.length>=a||e===i.length-1)&&(o.push(t),t="");continue}const n=s?`${s} ${i}`:i;n.length<=a?s=n:(s&&o.push(s),s=i)}s&&o.push(s)}const r=o.join("\n");return this.write(r),this}getWrappedText(t){if(!this.texture.text)return"";const e=this.texture.text,s=this.config.fontWidth||4,i=Math.floor(t/s);if(i<=0)return e;const a=e.split(" "),n=[];let o="";for(let t=0;t<a.length;t++){const e=a[t];if(e.length>i){o&&(n.push(o),o="");let t="";for(let s=0;s<e.length;s++)t+=e[s],(t.length>=i||s===e.length-1)&&(n.push(t),t="");continue}const s=o?`${o} ${e}`:e;s.length<=i?o=s:(n.push(o),o=e)}return o&&n.push(o),n.join("\n")}}class Window extends Phaser.Sprite{constructor(t,e,s,i,a="1",n=null){super(game,8*t,8*e),this.size={width:s,height:i},this.offset={x:0,y:0},this.scrollOffset=0,this.itemOffset=1,this.visibleItems=i,this.selectedIndex=0,this.focus=!1,this.skin=a,this.font="default",this.fontTint=7797982,this.fixedToCamera=!0,n?n.addChild(this):game.add.existing(this),this.createWindowFrame(),this.selector=game.add.sprite(3,0,`ui_window_${a}`,9),this.selector.visible=!1,this.selector.animations.add("blink",[9,10],4,!0),this.selector.animations.play("blink"),this.addChild(this.selector),this.scrollBar=game.add.graphics(8*this.size.width-3,8),this.scrollBar.alpha=0,this.addChild(this.scrollBar),this.scrollBarTween=null,this.onSelect=new Phaser.Signal,this.onConfirm=new Phaser.Signal,this.onCancel=new Phaser.Signal,this.items=[],this.updateSelector()}createWindowFrame(){this.frameParts=[];for(let t=0;t<this.size.height;t++)for(let e=0;e<this.size.width;e++){let s=4;s=0===t?0===e?0:e>=this.size.width-1?2:1:t===this.size.height-1?0===e?6:e>=this.size.width-1?8:7:0===e?3:e>=this.size.width-1?5:4;const i=game.add.sprite(8*e,8*t,`ui_window_${this.skin}`,s);this.addChild(i),this.frameParts.push(i)}}addItem(t,e,s=null,i=!1){const a=new Text(8+this.offset.x,0,t,{...FONTS[this.font],tint:this.fontTint});this.addChild(a);const n=new Text(8*this.size.width-8-4,0,e,{...FONTS[this.font],tint:this.fontTint});n.anchor.x=1,a.addChild(n);const o={text:a,valueText:n,callback:s,backButton:i,type:"item",visible:!0,setText:t=>{a.write(t)},setValueText:t=>{n.write(t)}};return this.items.push(o),o}addSettingItem(t,e,s=0,i=null){const a=new Text(8+this.offset.x,0,t,{...FONTS[this.font],tint:this.fontTint});this.addChild(a),e=e.map(t=>Window.processMultilingual(t));const n=new Text(8*this.size.width-8-4,0,e[s].toString(),{...FONTS[this.font],tint:this.fontTint});n.anchor.x=1,a.addChild(n);const o={text:a,valueText:n,options:e,currentIndex:s,callback:i,type:"setting",visible:!0};return this.items.push(o),this.update(),o}static processMultilingual(t){if("string"!=typeof t)return t;return t=(t=t.replace(/([^|(]+\|\|[^|)]+)/g,t=>{const e=t.split("||");return e[SETTINGS.language]||e[0]})).replace(/\(([^)|]+)\|([^)]+)\)/g,(t,e,s)=>0===SETTINGS.language?e:s)}update(){const t=8*this.size.height-10;this.visibleItems=Math.floor(t/8),this.visibleItems=Math.min(this.visibleItems,this.items.length),this.scrollOffset=Math.max(0,Math.min(this.scrollOffset,this.items.length-this.visibleItems));const e=8*this.visibleItems,s=(8*this.size.height-e)/2;this.items.forEach((t,e)=>{const i=e>=this.scrollOffset&&e<this.scrollOffset+this.visibleItems;if(t.text.visible=i,t.visible=i,t.text.tint=this.fontTint,t.valueText&&(t.valueText.tint=this.fontTint),i){const i=e-this.scrollOffset,a=s+8*i;t.text.y=a+this.offset.y}}),this.updateSelector()}updateSelector(){if(this.focus&&this.items.length>0&&this.selectedIndex>=this.scrollOffset&&this.selectedIndex<this.scrollOffset+this.visibleItems){const t=8*this.visibleItems,e=(8*this.size.height-t)/2+8*(this.selectedIndex-this.scrollOffset)+this.offset.y;this.selector.y=e,this.selector.visible=!0}else this.selector.visible=!1}updateScrollBar(){if(this.scrollBar.clear(),this.items.length<=this.visibleItems)return void this.hideScrollBar();const t=8*(this.size.height-2),e=this.items.length,s=Math.max(8,this.visibleItems/e*t),i=e-this.visibleItems,a=this.scrollOffset/i*(t-s);this.scrollBar.beginFill(this.fontTint,.8),this.scrollBar.drawRect(0,a,1,s),this.scrollBar.endFill(),this.showScrollBar()}showScrollBar(){this.scrollBarTween&&this.scrollBarTween.stop(),this.scrollBar.alpha=1,this.scrollBarTween=game.add.tween(this.scrollBar),this.scrollBarTween.to({alpha:0},1e3,Phaser.Easing.Quadratic.Out,!0,500).onComplete.add(()=>{this.scrollBarTween=null})}hideScrollBar(){this.scrollBarTween&&(this.scrollBarTween.stop(),this.scrollBarTween=null),this.scrollBar.alpha=0,this.scrollBar.clear()}adjustScroll(){this.selectedIndex<this.scrollOffset?this.scrollOffset=this.selectedIndex:this.selectedIndex>=this.scrollOffset+this.visibleItems&&(this.scrollOffset=this.selectedIndex-this.visibleItems+1)}navigate(t){if(0===this.items.length)return;let e=this.selectedIndex;switch(t){case"up":e=Math.max(0,this.selectedIndex-1);break;case"down":e=Math.min(this.items.length-1,this.selectedIndex+1);break;case"left":return void this.handleLeft();case"right":return void this.handleRight()}this.onSelect.dispatch(e,t),e!==this.selectedIndex&&(this.selectedIndex=e,this.adjustScroll(),this.updateScrollBar(),this.playNavSound())}handleLeft(){const t=this.items[this.selectedIndex];t&&("setting"===t.type?(t.currentIndex=(t.currentIndex-1+t.options.length)%t.options.length,t.valueText.write(t.options[t.currentIndex].toString()),t.callback&&t.callback(t.currentIndex,t.options[t.currentIndex]),this.playNavSound()):"toggle"===t.type&&(t.state=!t.state,t.toggleSwitch.animations.play(t.state?"on":"off"),t.callback&&t.callback(t.state),this.playNavSound()))}handleRight(){const t=this.items[this.selectedIndex];t&&("setting"===t.type?(t.currentIndex=(t.currentIndex+1)%t.options.length,t.valueText.write(t.options[t.currentIndex].toString()),t.callback&&t.callback(t.currentIndex,t.options[t.currentIndex]),this.playNavSound()):"toggle"===t.type&&(t.state=!t.state,t.toggleSwitch.animations.play(t.state?"on":"off"),t.callback&&t.callback(t.state),this.playNavSound()))}playNavSound(){}confirm(){if(this.items.length>0){const t=this.items[this.selectedIndex];return"item"===t.type?t.callback&&t.callback(this.items[this.selectedIndex]):this.handleRight(),!0}return this.onConfirm.dispatch(this.selectedIndex,this.items[this.selectedIndex]),!1}cancel(){this.items.forEach(t=>{t.backButton&&t.callback()}),this.onCancel.dispatch(this.selectedIndex)}clear(){this.items.forEach(t=>{t.text.destroy(),t.valueText&&t.valueText.destroy(),t.toggleText&&t.toggleText.destroy()}),this.scrollBarTween&&(this.scrollBarTween.stop(),this.scrollBarTween=null),this.frameParts.forEach(t=>t.destroy()),this.items=[],this.frameParts=[],this.selectedIndex=0,this.scrollOffset=0}show(){this.visible=!0}hide(){this.visible=!1}destroy(){this.clear(),super.destroy()}}class WindowManager{constructor(){this.windows=[],this.focusedWindow=null,this.lastUp=!1,this.lastDown=!1,this.lastConfirm=!1,this.lastCancel=!1}add(t){return this.windows.includes(t)||(this.windows.push(t),t.selector.visible=!1,1===this.windows.length&&this.focus(t)),t}show(t){t.show()}remove(t,e=!0){const s=this.windows.indexOf(t);return-1!==s&&(t===this.focusedWindow?(this.windows.splice(s,1),this.focusedWindow=this.windows.length>0?this.windows[this.windows.length-1]:null,this.focusedWindow&&(this.focusedWindow.selector.visible=!0)):this.windows.splice(s,1),e&&t.destroy(),!0)}focus(t,e=!0){return!(!t||!this.windows.includes(t))&&(this.focusedWindow&&(this.focusedWindow.focus=!1,e&&(this.focusedWindow.visible=!1),this.focusedWindow.selector.visible=!1),this.focusedWindow=t,t.focus=!0,t.selector.visible=!0,t.show(),!0)}unfocus(){this.focusedWindow=null}closeAll(){this.focusedWindow&&(this.focusedWindow.focus=!1,this.focusedWindow=null),this.windows.forEach(t=>t.hide())}update(){if(this.focusedWindow){const t=gamepad.pressed.up&&!this.lastUp,e=gamepad.pressed.down&&!this.lastDown,s=gamepad.pressed.left&&!this.lastDown,i=gamepad.pressed.right&&!this.lastDown,a=gamepad.pressed.a&&!this.lastConfirm,n=gamepad.pressed.b&&!this.lastCancel;t?this.focusedWindow.navigate("up"):e?this.focusedWindow.navigate("down"):s?this.focusedWindow.navigate("left"):i&&this.focusedWindow.navigate("right"),a&&this.focusedWindow.confirm(),n&&this.focusedWindow.cancel(),this.lastUp=gamepad.pressed.up,this.lastDown=gamepad.pressed.down,this.lastConfirm=gamepad.pressed.a,this.lastCancel=gamepad.pressed.b}}createWindow(t,e,s,i,a="1",n=null){const o=new Window(t,e,s,i,a,n);return this.add(o),o}clearAll(t=!1){t&&this.windows.forEach(t=>t.destroy()),this.windows=[],this.focusedWindow=null}bringToFront(t){return!!this.windows.includes(t)&&(t.bringToTop(),this.windows.splice(this.windows.indexOf(t),1),this.windows.push(t),!0)}}class CarouselMenu extends Phaser.Sprite{constructor(t,e,s,i,a={}){super(game,t,e),this.config={animate:!0,align:"left",bgcolor:"#3498db",fgcolor:"#ffffff",disableScrollBar:!1,...a,margin:{top:4,bottom:4,left:4,right:4,...a.margin||{}}},this.viewport={width:s,height:i},this.items=[],this.selectedIndex=0,this.scrollOffset=0,this.itemHeight=8,this.itemSpacing=1,this.totalItemHeight=this.itemHeight+this.itemSpacing,this.visibleItems=Math.floor((i-this.config.margin.top-this.config.margin.bottom)/this.totalItemHeight),this.visibleItems=Math.max(1,this.visibleItems),this.isAnimating=!1,this.inputEnabled=!0,this.config.disableScrollBar||(this.scrollBar=game.add.graphics(this.viewport.width-3,this.config.margin.top),this.scrollBar.alpha=0,this.addChild(this.scrollBar),this.scrollBarTween=null),this.lastUp=!1,this.lastDown=!1,this.lastLeft=!1,this.lastRight=!1,this.lastConfirm=!1,this.lastCancel=!1,this.setupInput(),this.config.silent||game.add.existing(this)}setupInput(){gamepad.releaseAll(),this.onSelect=new Phaser.Signal,this.onConfirm=new Phaser.Signal,this.onCancel=new Phaser.Signal}addItem(t,e=null,s={}){const i={parent:null,background:null,text:null,textContent:t,callback:e,data:s,index:this.items.length,originalX:"right"===this.config.align?this.config.margin.right:this.config.margin.left,originalAlpha:.4,isSelected:!1,alphaTween:null};return this.items.push(i),this.updateSelection(),i}createItemVisuals(t,e){const s=t.index;let i=this.config.margin.left,a=t.initialY||this.config.margin.top+s*this.totalItemHeight;const n=t.data;t.initialY=null;const o=new Phaser.Sprite(game,i,a);o.alpha=.4,this.addChild(o);const r=this.viewport.width-this.config.margin.left-this.config.margin.right,h=this.itemHeight,l=this.createGradientBackground(r,h,n.bgcolor);l.x=t.originalX,o.addChild(l);const c="right"===this.config.align?r-8:8,d="right"===this.config.align?1:0,u=new Text(c,0,t.textContent,{...FONTS.default,tint:n.fgcolor||this.config.fgcolor});u.anchor.x=d,u.y=1,o.addChild(u),4*t.textContent.length>this.viewport.width-16&&u.write(t.textContent.substr(0,Math.floor(this.viewport.width-16)/4)),t.parent=o,t.background=l,t.text=u}removeItemVisuals(t){t.parent?.destroy(),t.parent=null,t.background=null,t.text=null}createGradientBackground(t,e,s){const i=game.add.bitmapData(t,e),a=i.context.createLinearGradient("right"===this.config.align?t:0,0,"right"===this.config.align?0:t,0),n=s||this.config.bgcolor;"right"===this.config.align?(a.addColorStop(0,"transparent"),a.addColorStop(.3,n),a.addColorStop(1,n)):(a.addColorStop(0,n),a.addColorStop(.7,n),a.addColorStop(1,"transparent")),i.context.fillStyle=a,i.context.fillRect(0,0,t,e);return game.add.sprite(0,0,i)}update(){this.inputEnabled&&(this.handleInput(),this.updateAnimations())}handleInput(){const t=gamepad.pressed.up&&!this.lastUp,e=gamepad.pressed.down&&!this.lastDown,s=gamepad.pressed.left&&!this.lastLeft,i=gamepad.pressed.right&&!this.lastRight,a=gamepad.pressed.a&&!this.lastConfirm,n=gamepad.pressed.b&&!this.lastCancel;t?this.navigate(-1):e?this.navigate(1):s?this.navigate(-1,!0):i&&this.navigate(1,!0),a&&this.items.length>0&&this.confirm(),n&&this.cancel(),this.lastUp=gamepad.pressed.up,this.lastDown=gamepad.pressed.down,this.lastLeft=gamepad.pressed.left,this.lastRight=gamepad.pressed.right,this.lastConfirm=gamepad.pressed.a,this.lastCancel=gamepad.pressed.b}navigate(t,e){if(0===this.items.length||this.isAnimating)return;let s=e?t*Math.max(1,this.visibleItems):t,i=this.selectedIndex+s;e?(i<0&&(i=0),i>this.items.length-1&&(i=this.items.length-1)):(i<0&&(i=this.items.length-1),i>this.items.length-1&&(i=0)),i!==this.selectedIndex&&(this.selectedIndex=i,this.updateSelection(),this.playNavSound(),this.onSelect.dispatch(this.selectedIndex,this.items[this.selectedIndex]),this.config.disableScrollBar||this.showScrollBar())}updateSelection(){this.adjustScroll(),this.items.forEach((t,e)=>{const s=e===this.selectedIndex;e>=this.scrollOffset&&e<this.scrollOffset+this.visibleItems?(t.parent||this.createItemVisuals(t,s),s&&!t.isSelected?this.selectItem(t):!s&&t.isSelected&&this.deselectItem(t)):(t.parent&&this.removeItemVisuals(t),t.isSelected&&this.deselectItem(t))}),this.updateItemPositions(),this.config.disableScrollBar||this.updateScrollBar()}selectItem(t){const e=this.items.find(e=>e.isSelected&&e!==t);e&&this.deselectItem(e),t.isSelected=!0,t.alphaTween&&t.alphaTween.stop(),t.parent&&(this.config.animate?t.alphaTween=game.add.tween(t.parent).to({alpha:.9},250,Phaser.Easing.Quadratic.InOut,!0,0,-1,!0).yoyo(!0,500):t.parent.alpha=.9,t.text&&4*t.textContent.length>this.viewport.width-16&&t.text.scrollwrite(t.textContent,Math.floor(this.viewport.width-16)/4))}deselectItem(t){t.isSelected=!1,t.alphaTween&&(t.alphaTween.stop(),t.alphaTween=null),t.parent&&(this.config.animate?game.add.tween(t.parent).to({alpha:.4},100,Phaser.Easing.Quadratic.Out,!0):t.parent.alpha=.4,t.text&&t.text.isScrolling()&&(t.text.stopScrolling(),t.text.write(t.textContent.substr(0,Math.floor(this.viewport.width-16)/4))))}adjustScroll(){this.selectedIndex<this.scrollOffset?this.scrollOffset=this.selectedIndex:this.selectedIndex>=this.scrollOffset+this.visibleItems&&(this.scrollOffset=this.selectedIndex-this.visibleItems+1),this.scrollOffset=Phaser.Math.clamp(this.scrollOffset,0,Math.max(0,this.items.length-this.visibleItems))}updateScrollBar(){if(this.config.disableScrollBar)return;if(this.scrollBar.clear(),this.items.length<=this.visibleItems)return void this.hideScrollBar();const t=this.viewport.height-this.config.margin.top-this.config.margin.bottom,e=this.items.length,s=Math.max(8,this.visibleItems/e*t),i=e-this.visibleItems,a=this.scrollOffset/i*(t-s),n=Phaser.Color.hexToRGB(this.config.fgcolor);this.scrollBar.beginFill(n,.8),this.scrollBar.drawRect(0,a,1,s),this.scrollBar.endFill(),this.showScrollBar()}showScrollBar(){this.config.disableScrollBar||(this.scrollBarTween&&this.scrollBarTween.stop(),this.scrollBar.alpha=1,this.scrollBarTween=game.add.tween(this.scrollBar),this.scrollBarTween.to({alpha:0},1e3,Phaser.Easing.Quadratic.Out,!0,500).onComplete.add(()=>{this.scrollBarTween=null}))}hideScrollBar(){this.config.disableScrollBar||(this.scrollBarTween&&(this.scrollBarTween.stop(),this.scrollBarTween=null),this.scrollBar.alpha=0,this.scrollBar.clear())}updateItemPositions(){this.items.forEach((t,e)=>{const s=e-this.scrollOffset,i=this.config.margin.top+s*this.totalItemHeight;t.parent?this.config.animate&&!this.isAnimating?game.add.tween(t.parent).to({y:i},150,"Quad.easeOut",!0):t.parent.y=i:t.initialY=i})}updateAnimations(){}confirm(){if(0===this.items.length||this.isAnimating)return;const t=this.items[this.selectedIndex];this.inputEnabled=!1,this.isAnimating=!0,this.animateSelection(t,()=>{this.onConfirm.dispatch(this.selectedIndex,t),t.callback?.(t),this.destroy()})}animateSelection(t,e){if(this.items.forEach(t=>{t.alphaTween&&(t.alphaTween.stop(),t.alphaTween=null)}),!t.parent)return;const s="right"===this.config.align?100:-100;this.items.forEach(e=>{e!==t&&e.parent&&e.parent.visible&&game.add.tween(e.parent).to({x:e.parent.x+s,alpha:0},500,"Quad.easeOut",!0)}),t.alphaTween&&t.alphaTween.stop(),t.parent.alpha=1;const i=this.viewport.width-this.config.margin.left-this.config.margin.right,a=this.itemHeight,n=this.createGradientBackground(i,a);n.x="right"===this.config.align?this.config.margin.right:this.config.margin.left,n.alpha=0,t.parent.addChild(n);game.add.tween(n).to({alpha:1},100,"Linear",!0).onComplete.addOnce(()=>{t.text.visible=!1;game.add.tween(t.parent).to({alpha:0},100,"Linear",!0).onComplete.addOnce(()=>{e?.()})})}animateCancel(t){this.items.forEach(t=>{t.alphaTween&&(t.alphaTween.stop(),t.alphaTween=null)});const e="right"===this.config.align?100:-100;this.items.forEach(t=>{t.parent&&t.parent.visible&&game.add.tween(t.parent).to({x:t.parent.x+e,alpha:0},500,"Quad.easeOut",!0)}),game.time.events.add(500,()=>t?.())}cancel(){!this.isAnimating&&this.onCancel.getNumListeners()>0&&this.animateCancel(()=>{this.onCancel.dispatch(),this.destroy()})}playNavSound(){}clear(){this.items.forEach(t=>{this.removeItemVisuals(t),t.alphaTween&&t.alphaTween.stop(),t.parent&&t.parent.destroy()}),this.items=[],this.selectedIndex=0,this.scrollOffset=0,!this.config.disableScrollBar&&this.scrollBarTween&&(this.scrollBarTween.stop(),this.scrollBarTween=null),this.onSelect.dispose(),this.onConfirm.dispose(),this.onCancel.dispose()}destroy(){this.clear(),super.destroy()}}class BackgroundGradient extends Phaser.Sprite{constructor(t=.1,e=.5,s=5e3){super(game,0,0,"ui_background_gradient"),this.alpha=t,game.add.tween(this).to({alpha:e},5e3,Phaser.Easing.Quadratic.InOut,!0).yoyo(!0).repeat(-1),game.add.existing(this)}}class Background extends Phaser.Sprite{constructor(t,e,s=.1,i=.5,a=5e3){super(game,0,0,t),this.alpha=s,e&&game.add.tween(this).to({alpha:i},5e3,Phaser.Easing.Quadratic.InOut,!0).yoyo(!0).repeat(-1),game.add.existing(this)}}class FuturisticLines extends Phaser.Sprite{constructor(){super(game,0,0),this.lines=[],this.maxLines=12,this.lineSpeed=1.2,this.tailLength=100,this.spawnRate=150,this.lastSpawnTime=0,this.lineColors=[7798015,4914430,58879,47316],this.lineAlpha=.3,this.graphics=game.add.graphics(0,0),this.addChild(this.graphics),game.add.existing(this)}update(){const t=game.time.now;this.lines.length<this.maxLines&&t-this.lastSpawnTime>this.spawnRate&&(this.spawnLine(),this.spawnRate=game.rnd.between(150,2e3),this.lastSpawnTime=t),this.updateLines(),this.drawLines()}spawnLine(){const t=game.rnd.integerInRange(10,game.height-10),e={x:-20,y:t,startY:t,points:[{x:-20,y:t}],color:game.rnd.pick(this.lineColors),speed:this.lineSpeed*game.rnd.realInRange(.9,1.1),direction:0,age:0,maxAge:1e4,active:!0,lastDirectionChange:0,nextDirectionChangeTime:game.rnd.integerInRange(1e3,5e3),state:"straight"};this.lines.push(e)}updateLines(){for(let t=this.lines.length-1;t>=0;t--){const e=this.lines[t];if(!e.active){this.lines.splice(t,1);continue}if(e.age+=game.time.elapsed,e.age>e.maxAge){e.active=!1;continue}e.age-e.lastDirectionChange>e.nextDirectionChangeTime&&this.changeLineDirection(e);const s=e.direction*(Math.PI/180),i=e.speed*Math.cos(s),a=e.speed*Math.sin(s);for(e.x+=i,e.y+=a,e.points.push({x:e.x,y:e.y});e.points.length>0&&e.points[0].x<e.x-this.tailLength;)e.points.shift();(e.x>game.width+100+this.tailLength||e.y<-50||e.y>game.height+50)&&(e.active=!1)}}changeLineDirection(t){t.lastDirectionChange=t.age,"straight"===t.state?(t.direction=game.rnd.pick([-45,45]),t.state="angled",t.nextDirectionChangeTime=game.rnd.integerInRange(100,500)):"angled"===t.state&&(t.direction=0,t.state="straight",t.nextDirectionChangeTime=game.rnd.integerInRange(1e3,5e3))}drawLines(){this.graphics.clear();for(const t of this.lines)!t.active||t.points.length<2||(this.drawTail(t),this.drawCap(t))}drawTail(t){const e=t.points;for(let s=1;s<e.length;s++){const i=e[s-1],a=e[s],n=s/e.length,o=s<=4?0:this.lineAlpha*(.9*n);this.graphics.lineStyle(1,t.color,o),this.graphics.moveTo(i.x,i.y),this.graphics.lineTo(a.x,a.y)}}drawCap(t){if(0===t.points.length)return;const e=t.points[t.points.length-1];this.graphics.beginFill(16777215,1.5*this.lineAlpha),this.graphics.drawRect(e.x,e.y,1,1),this.graphics.endFill()}setDensity(t){this.maxLines=Phaser.Math.clamp(t,1,15)}setSpeed(t){this.lineSpeed=Phaser.Math.clamp(t,.5,3)}setTailLength(t){this.tailLength=Phaser.Math.clamp(t,20,100)}clearLines(){this.lines=[],this.graphics.clear()}setColors(t){this.lineColors=t}setAlpha(t){this.lineAlpha=Phaser.Math.clamp(t,.1,.8)}destroy(){this.clearLines(),this.graphics.destroy(),super.destroy()}}class LoadingDots extends Phaser.Sprite{constructor(){super(game,game.width-2,game.height-2,"ui_loading_dots"),this.anchor.set(1),this.animations.add("loading",[0,1,2,3,4,3,2,1],8,!0),this.animations.play("loading"),game.add.existing(this)}}class Logo extends Phaser.Sprite{constructor(){super(game,game.width/2,game.height/2,null),this.anchor.set(.5),this.mainShape=this.addShape(),game.add.existing(this)}intro(t){this.mainShape.alpha=0,game.add.tween(this.mainShape).to({alpha:1},1e3,"Linear",!0).onComplete.addOnce(()=>{this.logoTween=game.add.tween(this.mainShape).to({alpha:.8},500,"Linear",!0).repeat(-1).yoyo(!0),t&&t()})}outro(t){this.effect(32,1e3);const e=this.addShape();e.alpha=1,game.add.tween(e).to({alpha:0},250,"Linear",!0),game.add.tween(e.scale).to({x:8,y:8},250,"Linear",!0),game.camera.flash(16777215,300),game.time.events.add(350,()=>game.camera.fade(16777215,1e3)),game.camera.onFadeComplete.addOnce(()=>t&&t())}effect(t=5,e=1e3,s=!1){let i=[];for(let a=0;a<t;a++){const n=this.addShape();n.alpha=0,n.scale.set(1+a/10),i.push(n),game.add.tween(n).to({alpha:1},e,"Linear",!0,(s?100*-t:0)+100*a).yoyo(!0)}}addShape(t=16777215,e=0,s=0){const i=game.add.sprite(e,s,"ui_logo_shape");return i.anchor.set(.5),i.tint=t,this.addChild(i),i}}class NavigationHint extends Phaser.Sprite{constructor(t=0){super(game,0,0),this.defaultFrame=t,this.lastInputSource=null,game.add.existing(this)}hide(){this.visible=!1}show(){this.visible=!0}update(){gamepad&&(gamepad.lastInputSource!=this.lastInputSource&&(this.loadTexture("keyboard"==gamepad.lastInputSource?"ui_navigation_hint_keyboard":"ui_navigation_hint_gamepad"),this.frame=this.defaultFrame),this.lastInputSource=gamepad.lastInputSource)}}class ProgressText extends Text{constructor(t){super(4,game.height-4,t,FONTS.default),this.anchor.y=1}}class BackgroundMusic{constructor(){this.audio=document.createElement("audio"),this.audio.volume=[0,25,50,75,100][Account.settings.volume]/100,this.randomSong=Account.settings.randomSong,this.audio.loop=!0,this.isPlaying=!1,this.currentSong=null,this.availableSongsCache=null,this.cacheTimestamp=0,this.cacheDuration=3e4,this.registerVisibilityChangeListener()}registerVisibilityChangeListener(){this.visibilityChangeListener=()=>{document.hidden?this.audio.pause():this.audio.play()},window.addEventListener("visibilitychange",this.visibilityChangeListener)}async playLastSong(){if(this.isPlaying||!Account.settings.enableMenuMusic)return;if(this.randomSong||!Account.lastSong)return void this.playRandomSong();const t=Account.lastSong;if(t.isExternal)try{await this.checkUrlAccessible(t.url),this.playSong(t)}catch(t){console.warn("Last external song not accessible, falling back to random song:",t),this.playRandomSong()}else this.playSong(t)}playRandomSong(){const t=this.getCachedAvailableSongs();if(0===t.length)return;const e=game.rnd.pick(t),s={url:e.audioUrl,title:e.title||e.chart?.title||"Unknown",artist:e.artist||e.chart?.artist||"Unknown",sampleStart:e.sampleStart||e.chart?.sampleStart||0,isExternal:void 0!==e.files||void 0!==e.chart?.files};this.playSong(s)}getCachedAvailableSongs(){const t=Date.now();return this.availableSongsCache&&t-this.cacheTimestamp<this.cacheDuration||(this.availableSongsCache=this.getAllAvailableSongsFast(),this.cacheTimestamp=t),this.availableSongsCache}getAllAvailableSongsFast(){const t=[],e=new Set;if(window.localSongs&&window.localSongs.length>0)for(const s of window.localSongs)s.audioUrl&&this.isValidAudioUrl(s.audioUrl)&&(e.has(s.audioUrl)||(e.add(s.audioUrl),t.push(s)));if(window.externalSongs&&window.externalSongs.length>0)for(const s of window.externalSongs)s.audioUrl&&this.isValidAudioUrl(s.audioUrl)&&(e.has(s.audioUrl)||(e.add(s.audioUrl),t.push(s)));const s=game.state.getCurrentState();if(s&&s.songs&&Array.isArray(s.songs))for(const i of s.songs)i.audioUrl&&this.isValidAudioUrl(i.audioUrl)&&(e.has(i.audioUrl)||(e.add(i.audioUrl),t.push(i)));return t}isValidAudioUrl(t){return!!t&&("string"==typeof t&&(!t.includes("assets/no-")&&("undefined"!==t&&"null"!==t&&0!==t.trim().length)))}async checkUrlAccessible(t){return new Promise((e,s)=>{if(!t)return void s();if(t.startsWith("blob:"))return void e();const i=document.createElement("audio");i.preload="metadata",i.onloadedmetadata=()=>{i.remove(),e()},i.onerror=()=>{i.remove(),s(new Error("Audio load failed"))},setTimeout(()=>{i.remove(),s(new Error("Audio load timeout"))},800),i.src=t})}playSong(t){this.audio.pause(),this.audio.currentTime=0,this.audio.src=t.url,this.audio.currentTime=t.sampleStart||0,this.audio.play().then(()=>{if(this.isPlaying=!0,this.currentSong=t,notifications){t.title,t.artist}}).catch(e=>{console.warn(`Failed to play background music: ${t.title}`,e),this.removeSongFromCache(t.url),setTimeout(()=>{this.playRandomSong()},100)})}removeSongFromCache(t){this.availableSongsCache&&(this.availableSongsCache=this.availableSongsCache.filter(e=>e.audioUrl!==t))}stop(){this.audio.pause(),this.audio.currentTime=0,this.isPlaying=!1,this.currentSong=null}setVolume(t){this.audio.volume=[0,25,50,75,100][t]/100}refreshCache(){this.availableSongsCache=null,this.cacheTimestamp=0}destroy(){this.stop(),this.audio.src="",this.audio=null,window.removeEventListener("visibilitychange",this.visibilityChangeListener),this.availableSongsCache=null}}class Visualizer{constructor(t,e,s,i,a){this.scene=t,this.x=e,this.y=s,this.width=i,this.height=a,this.graphics=t.add.graphics(e,s),this.active=!0}update(){}destroy(){this.graphics.destroy()}clear(){this.graphics.clear()}}class AccuracyVisualizer extends Visualizer{constructor(t,e,s,i,a){super(t,e,s,i,a),this.accuracyHistory=[],this.maxHistoryLength=this.width/4}update(){if(this.active&&this.scene.player&&(this.clear(),this.accuracyHistory=this.scene.player.timingStory,this.accuracyHistory.length>this.maxHistoryLength&&this.accuracyHistory.shift(),this.graphics.lineStyle(1,15790320,.3),this.graphics.moveTo(0,3),this.graphics.lineTo(this.width,3),this.accuracyHistory.length>1)){this.graphics.lineStyle(1,65280,1),this.graphics.moveTo(0,3);for(let t=0;t<this.accuracyHistory.length;t++){const e=t/this.maxHistoryLength*this.width,s=2+this.accuracyHistory[t]/.4*3;this.graphics.lineTo(e,s)}}}}class AudioVisualizer extends Visualizer{constructor(t,e,s,i,a){super(t,e,s,i,a),this.audioContext=null,this.analyser=null,this.dataArray=null,this.bufferLength=32,this.bars=[],this.setupAudioAnalysis()}setupAudioAnalysis(){try{if(this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=64,this.analyser.maxDecibels=-10,this.analyser.smoothingTimeConstant=.1,this.bufferLength=this.analyser.frequencyBinCount,this.dataArray=new Uint8Array(this.bufferLength),this.scene.audio){this.audioContext.createMediaElementSource(this.scene.audio).connect(this.analyser),this.analyser.connect(this.audioContext.destination)}}catch(t){console.warn("Audio visualizer not supported:",t),this.active=!1}}update(){if(!this.active||!this.analyser)return;this.clear(),this.analyser.getByteFrequencyData(this.dataArray);const t=this.width/this.bufferLength*2;let e=0;for(let s=0;s<this.bufferLength/2;s++){const i=this.dataArray[s]/255*this.height;i>0&&(this.graphics.lineStyle(t-1,255,.9),this.graphics.moveTo(e,this.height-1),this.graphics.lineTo(e,this.height-i)),e+=t}}destroy(){super.destroy(),this.audioContext&&this.audioContext.close()}}class BPMVisualizer extends Visualizer{constructor(t,e,s,i,a){super(t,e,s,i,a),this.bpmChanges=t.song?.chart?.bpmChanges||[],this.stops=t.song?.chart?.stops||[],this.text=new Text(i-1,1,""),this.text.anchor.x=1,this.text.alpha=.5,this.graphics.addChild(this.text),this.beatIndicatorAlpha=1,this.currentBeat=0,this.currentBeatInt=0,this.previusBeatInt=1,this.currentBpm=0,this.previusBpm=1}update(){if(!this.active)return;this.clear();const t=this.scene.getCurrentTime();this.currentBeat=t.beat,this.currentBeatInt=Math.floor(this.currentBeat),this.currentBeatInt!=this.previusBeatInt&&(this.beatIndicatorAlpha=1),this.previusBeatInt=this.currentBeatInt,this.currentBpm=this.getLastBpm(),this.currentBpm!=this.previusBpm&&(this.text.write(`${this.currentBpm}`),this.text.alpha=1,game.add.tween(this.text).to({alpha:.5},100,"Linear",!0)),this.text.tint=this.getLastStop()&&this.getLastStop().beat==this.currentBeat?16711680:16777215,this.previusBpm=this.currentBpm;Math.max(...this.bpmChanges.map(t=>t.beat),this.currentBeat+50);this.bpmChanges.forEach(t=>{const e=(t.beat-this.currentBeat)/8*this.width;e>=0&&e<=this.width&&(this.graphics.beginFill(16776960,.8),this.graphics.drawRect(e-1,0,1,this.height),this.graphics.endFill())}),this.stops.forEach(t=>{const e=(t.beat-this.currentBeat)/8*this.width;e>=0&&e<=this.width&&(this.graphics.beginFill(16711680,.8),this.graphics.drawRect(e-1,0,1,this.height),this.graphics.endFill())}),this.graphics.beginFill(65280,this.beatIndicatorAlpha),this.graphics.drawCircle(3,3,4),this.graphics.endFill();let e=Math.min(250,this.currentBpm)/250*.5;this.beatIndicatorAlpha-=e}getLastBpm(){return this.bpmChanges.length?this.bpmChanges.find((t,e,s)=>e+1==s.length||s[e+1].beat>=this.currentBeat).bpm:0}getLastStop(){return this.stops.length?this.stops.find((t,e,s)=>e+1==s.length||s[e+1].beat>=this.currentBeat):null}destroy(){super.destroy(),this.text.destroy()}}class FullScreenAudioVisualizer{constructor(t,e={}){this.audioElement=t,this.options={barColor:7797982,barWidth:4,barSpacing:2,barBaseHeight:10,barMaxHeight:80,smoothing:.8,alpha:1,fftSize:256,visualizationType:"circular",...e},this.graphics=game.add.graphics(0,0),this.analyser=null,this.dataArray=null,this.bufferLength=0,this.frequencyData=null,this.isActive=!1,this.setupAudioAnalysis()}setupAudioAnalysis(){try{this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext)),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=this.options.fftSize,this.analyser.smoothingTimeConstant=this.options.smoothing,this.analyser.minDecibels=-90,this.analyser.maxDecibels=-10,this.bufferLength=this.analyser.frequencyBinCount,this.dataArray=new Uint8Array(this.bufferLength),this.frequencyData=new Uint8Array(this.bufferLength),this.audioElement&&this.connectAudioSource(),this.isActive=!0}catch(t){console.warn("FullScreenAudioVisualizer: Audio analysis not supported:",t),this.isActive=!1}}connectAudioSource(){if(this.audioElement&&this.analyser)try{this.source&&this.source.disconnect(),this.source=this.audioContext.createMediaElementSource(this.audioElement),this.source.connect(this.analyser),this.analyser.connect(this.audioContext.destination)}catch(t){console.warn("FullScreenAudioVisualizer: Could not connect audio source:",t)}}setAudioSource(t){this.audioElement=t,this.isActive&&this.connectAudioSource()}update(){if(!this.isActive||!this.analyser)return;this.graphics.clear(),this.graphics.alpha=this.options.alpha,this.analyser.getByteFrequencyData(this.dataArray);const t=Math.floor(this.bufferLength/2);if(this.frequencyData){for(let e=0;e<t;e++)this.frequencyData[e]=Math.max(this.frequencyData[e]*this.options.smoothing,this.dataArray[e]);for(let e=t;e<this.bufferLength;e++)this.frequencyData[e]=0}else this.frequencyData=new Uint8Array(this.dataArray);switch(this.options.visualizationType){case"bars":default:this.drawBars();break;case"waveform":this.drawWaveform();break;case"circular":this.drawCircularVisualizer();break;case"symmetrical":this.drawSymmetricalBars()}}drawBars(){const t=Math.floor(game.width/(this.options.barWidth+this.options.barSpacing)),e=(game.width-t*(this.options.barWidth+this.options.barSpacing))/2,s=Math.floor(this.bufferLength/2);for(let i=0;i<t;i++){const a=Math.floor(i/t*s);if(a>=s)continue;const n=(this.frequencyData[a]||0)/255,o=this.options.barBaseHeight+n*this.options.barMaxHeight,r=e+i*(this.options.barWidth+this.options.barSpacing),h=game.height-o;this.drawBar(r,h,this.options.barWidth,o,n)}}drawSymmetricalBars(){const t=Math.floor(game.width/(this.options.barWidth+this.options.barSpacing)),e=Math.floor(t/2),s=game.width/2,i=Math.floor(this.bufferLength/2);for(let t=0;t<e;t++){const a=Math.floor(t/e*i);if(a>=i)continue;const n=(this.frequencyData[a]||0)/255,o=this.options.barBaseHeight+n*this.options.barMaxHeight,r=s+t*(this.options.barWidth+this.options.barSpacing),h=game.height-o;this.drawBar(r,h,this.options.barWidth,o,n);const l=s-(t+1)*(this.options.barWidth+this.options.barSpacing),c=game.height-o;this.drawBar(l,c,this.options.barWidth,o,n)}}drawWaveform(){const t=new Uint8Array(this.bufferLength);this.analyser.getByteTimeDomainData(t),this.graphics.lineStyle(2,this.options.barColor,.8);const e=game.width/this.bufferLength;let s=0;for(let i=0;i<this.bufferLength;i++){const a=t[i]/128*game.height/2;0===i?this.graphics.moveTo(s,a):this.graphics.lineTo(s,a),s+=e}}drawCircularVisualizer(){const t=game.width/2,e=game.height/2,s=.3*Math.min(game.width,game.height),i=Math.floor(this.bufferLength/2);this.graphics.lineStyle(2,this.options.barColor,.8);for(let a=0;a<i;a+=2){const n=this.frequencyData[a]/255,o=a/i*Math.PI*2,r=n*s*.5,h=t+Math.cos(o)*s,l=e+Math.sin(o)*s,c=t+Math.cos(o)*(s+r),d=e+Math.sin(o)*(s+r);this.graphics.moveTo(h,l),this.graphics.lineTo(c,d)}}drawBar(t,e,s,i,a){const n=this.options.barColor,o=.3+.7*a,r=(n>>16&255)*o,h=(n>>8&255)*o,l=(255&n)*o,c=Math.floor(r)<<16|Math.floor(h)<<8|Math.floor(l);if(this.graphics.beginFill(c,.8),this.graphics.drawRect(t,e,s,i),this.graphics.endFill(),a>.5){const n=.4*(a-.5);this.graphics.beginFill(16777215,n),this.graphics.drawRect(t,e,s,Math.max(2,.1*i)),this.graphics.endFill()}}setVisualizationType(t){["bars","waveform","circular","symmetrical"].includes(t)?this.options.visualizationType=t:(console.warn(`Invalid visualization type: ${t}. Using 'bars' instead.`),this.options.visualizationType="bars")}setBarColor(t){this.options.barColor=t}setAlpha(t){this.options.alpha=Phaser.Math.clamp(t,0,1)}setOptions(t){this.options={...this.options,...t},this.analyser&&(t.fftSize&&(this.analyser.fftSize=t.fftSize,this.bufferLength=this.analyser.frequencyBinCount,this.dataArray=new Uint8Array(this.bufferLength),this.frequencyData=new Uint8Array(this.bufferLength)),void 0!==t.smoothing&&(this.analyser.smoothingTimeConstant=t.smoothing)),t.visualizationType&&this.setVisualizationType(t.visualizationType)}getSettings(){return{...this.options}}isReady(){return this.isActive&&null!==this.analyser}pause(){this.isActive=!1}resume(){this.isActive=!0}destroy(){this.isActive=!1,this.source&&this.source.disconnect(),this.analyser&&this.analyser.disconnect(),this.audioContext&&"closed"!==this.audioContext.state&&this.audioContext.close().catch(t=>{console.warn("Error closing audio context:",t)}),this.graphics&&this.graphics.destroy(),this.audioElement=null,this.analyser=null,this.source=null,this.audioContext=null,this.dataArray=null,this.frequencyData=null}static create(t,e={}){return new FullScreenAudioVisualizer(t,e)}static isSupported(){return!(!window.AudioContext&&!window.webkitAudioContext)}}class LocalSMParser{constructor(){this.baseUrl=""}async parseSM(t,e){this.baseUrl=e.endsWith("/")?e:e+"/";let s={};if(t.includes("#VERSION:"))return this.parseSSC(t,e);let i=t.replace(/\/\/.*/g,"").replace(/\r?\n|\r/g,"").split(";");for(let t=i.length-1;t>=0;t-=1)if(i[t]){i[t]=i[t].split(/:/g);for(let e in i[t])i[t][e]=i[t][e].trim()}else i.splice(t,1);let a={};s.bpmChanges=[],s.stops=[],s.notes={},s.backgrounds=[],s.banner="no-media",s.difficulties=[],s.background="no-media",s.cdtitle=null,s.audioUrl=null,s.videoUrl=null,s.sampleStart=0,s.sampleLength=10,s.baseUrl=e;for(let t in i){let e=i[t];switch(e[0]){case"#TITLE":s.title=e[1];break;case"#SUBTITLE":s.subtitle=e[1];break;case"#ARTIST":s.artist=e[1];break;case"#TITLETRANSLIT":s.titleTranslit=e[1];break;case"#SUBTITLETRANSLIT":s.subtitleTranslit=e[1];break;case"#ARTISTTRANSLIT":s.artistTranslit=e[1];break;case"#GENRE":s.genre=e[1];break;case"#CREDIT":s.credit=e[1];break;case"#BGCHANGES":e[1]&&e[1].split(",").forEach(t=>{if(!(t=t.trim()))return;const e=t.split("=").filter(t=>""!==t);if(e.length<6)return;const i={beat:parseFloat(e[0]),file:e[1],opacity:parseFloat(e[2]),fadeIn:parseInt(e[3])||0,fadeOut:parseInt(e[4])||0,effect:parseInt(e[5])||0,type:"image",startTime:0,duration:0};if(i.file){const t=i.file.split(".").pop().toLowerCase();i.type=["mp4","avi","mov"].includes(t)?"video":"image",i.url=this.resolveFileUrl(i.file)}e.length>6&&(i.duration=parseFloat(e[6])||0,i.startTime=parseFloat(e[7])||0),s.backgrounds.push(i)});break;case"#BANNER":e[1]&&(s.banner=this.resolveFileUrl(e[1]));break;case"#CDTITLE":e[1]&&(s.cdtitle=this.resolveFileUrl(e[1]));break;case"#LYRICSPATH":e[1]&&(s.lyrics=this.resolveFileUrl(e[1]));break;case"#SAMPLESTART":e[1]&&(s.sampleStart=parseFloat(e[1]));break;case"#SAMPLELENGTH":e[1]&&(s.sampleLength=parseFloat(e[1]));break;case"#BACKGROUND":e[1]&&(s.background=this.resolveFileUrl(e[1]));break;case"#VIDEO":e[1]&&(s.videoUrl=this.resolveFileUrl(e[1]));break;case"#MUSIC":e[1]&&(s.audio=e[1],s.audioUrl=this.resolveFileUrl(e[1]));break;case"#OFFSET":s.offset=Number(e[1]);break;case"#BPMS":{let t=e[1].split(",");t=t.filter(t=>/=/.exec(t));for(let e in t){let s=t[e].split("=");t[e]={beat:Number(s[0]),bpm:Number(s[1])}}s.bpmChanges=s.bpmChanges.concat(t);break}case"#STOPS":{let t=e[1].split(",");t=t.filter(t=>t.includes("="));for(let e in t){let s=t[e].split("=");t[e]={beat:Number(s[0]),len:Number(s[1])}}s.stops=s.stops.concat(t);break}case"#NOTES":a[e[3]+e[4]]=e[6].split(","),s.difficulties.push({type:e[3],rating:e[4]})}}if(s.bpmChanges.sort((t,e)=>t.beat-e.beat),0!==s.bpmChanges[0].beat)throw`No starting bpm, first bpm change is ${s.bpmChanges[0]}`;s.bpmChanges[0].sec=0;for(let t=1;t<s.bpmChanges.length;t++)s.bpmChanges[t].sec=this.beatToSec(s.bpmChanges,s.stops,s.bpmChanges[t].beat);for(let t=0;t<s.stops.length;t++)s.stops[t].sec=this.beatToSec(s.bpmChanges,s.stops,s.stops[t].beat);for(let t in a){let e=[null,null,null,null];s.notes[t]=[];for(let i in a[t]){if(a[t][i]=a[t][i].trim(),a[t][i].length%4)throw`Invalid length on measure ${i}, length is ${a[t][i].length}`;a[t][i]=a[t][i].match(/(.{4})/g);let n=a[t][i].length;for(let o in a[t][i]){let r=a[t][i][o],h=[{},{},{},{}],l=4*i+o/n*4;for(let i=0;i<h.length;i++){switch(r[i]){case"3":if(null==e[i])throw"hold end without any hold before";{let a=s.notes[t][e[i]];a.beatEnd=l,a.beatLength=l-a.beat,a.secEnd=this.beatToSec(s.bpmChanges,s.stops,l),a.secLength=this.beatToSec(s.bpmChanges,s.stops,l)-this.beatToSec(s.bpmChanges,s.stops,a.beat)}e[i]=null;case"0":h[i]=null;continue;case"4":case"2":if(e[i])throw"new hold started before last ended";e[i]=s.notes[t].length+i;case"1":case"M":h[i].type=r[i];break;default:throw`invalid note type ${r[i]}`}h[i].beat=l,h[i].sec=this.beatToSec(s.bpmChanges,s.stops,l),h[i].column=i}s.notes[t]=s.notes[t].concat(h)}}s.notes[t]=s.notes[t].filter(t=>null!==t)}return s}resolveFileUrl(t){return t?t.startsWith("http")||t.startsWith("//")?t:this.baseUrl+t:null}getLastBpm(t,e,s){return t.find((t,i,a)=>i+1==a.length||a[i+1][s]>=e)}beatToSec(t,e,s){let i=this.getLastBpm(t,s,"beat"),a=(s-i.beat)/i.bpm*60+i.sec,n=e.filter(({beat:t})=>t>=i.beat&&t<s).map(t=>t.len);for(let t in n)a+=n[t];return a}parseSSC(t,e){const s={bpmChanges:[],stops:[],notes:{},backgrounds:[],banner:"no-media",difficulties:[],background:"no-media",cdtitle:null,audioUrl:null,videoUrl:null,sampleStart:0,sampleLength:10,baseUrl:e},i=t.split(/\/\/-+/)[0].split("\n");for(let t of i)if(t.startsWith("#")){const[e,...i]=t.slice(1).split(":"),a=i.join(":").trim();switch(e){case"TITLE":s.title=a;break;case"ARTIST":s.artist=a;break;case"BANNER":s.banner=this.resolveFileUrl(a);break;case"BACKGROUND":s.background=this.resolveFileUrl(a);break;case"MUSIC":s.audio=a,s.audioUrl=this.resolveFileUrl(a)}}return s}}class ExternalSMParser{parseSM(t,e){let s={};if(e.includes("#VERSION:"))return this.parseSSC(t,e);let i=e.replace(/\/\/.*/g,"").replace(/\r?\n|\r/g,"").split(";");for(let t=i.length-1;t>=0;t-=1)if(i[t]){i[t]=i[t].split(/:/g);for(let e in i[t])i[t][e]=i[t][e].trim()}else i.splice(t,1);let a={};s.bpmChanges=[],s.stops=[],s.notes={},s.backgrounds=[],s.banner="no-media",s.difficulties=[],s.background="no-media",s.cdtitle=null,s.audioUrl=null,s.videoUrl=null,s.files=t,s.sampleStart=0,s.sampleLength=10;for(let e in i){let n=i[e];switch(n[0]){case"#TITLE":s.title=n[1];break;case"#SUBTITLE":s.subtitle=n[1];break;case"#ARTIST":s.artist=n[1];break;case"#TITLETRANSLIT":s.titleTranslit=n[1];break;case"#SUBTITLETRANSLIT":s.subtitleTranslit=n[1];break;case"#ARTISTTRANSLIT":s.artistTranslit=n[1];break;case"#GENRE":s.genre=n[1];break;case"#CREDIT":s.credit=n[1];break;case"#BGCHANGES":n[1]&&n[1].split(",").forEach(e=>{if(!(e=e.trim()))return;const i=e.split("=").filter(t=>""!==t);if(i.length<6)return;const a={beat:parseFloat(i[0]),file:i[1],opacity:parseFloat(i[2]),fadeIn:parseInt(i[3])||0,fadeOut:parseInt(i[4])||0,effect:parseInt(i[5])||0,type:"image",startTime:0,duration:0};if(a.file){const e=a.file.split(".").pop().toLowerCase();if(a.type=["mp4","avi","mov"].includes(e)?"video":"image",t[a.file.toLowerCase()]){const e=t[a.file.toLowerCase()];a.url=e.localURL?e.localURL:URL.createObjectURL(e),a.url=a.url.replace("cdvfile://","file://").replace("localhost/persistent/","/storage/emulated/0/")}}i.length>6&&(a.duration=parseFloat(i[6])||0,a.startTime=parseFloat(i[7])||0),s.backgrounds.push(a)});break;case"#BANNER":if(n[1]&&t[n[1].toLowerCase()]){const e=t[n[1].toLowerCase()];s.banner=e.localURL?e.localURL:URL.createObjectURL(e),s.banner=s.banner.replace("cdvfile://","file://").replace("localhost/persistent/","/storage/emulated/0/")}break;case"#CDTITLE":if(n[1]&&t[n[1].toLowerCase()]){const e=t[n[1].toLowerCase()];s.cdtitle=e.localURL?e.localURL:URL.createObjectURL(e),s.cdtitle=s.cdtitle.replace("cdvfile://","file://").replace("localhost/persistent/","/storage/emulated/0/")}break;case"#SAMPLESTART":n[1]&&(s.sampleStart=parseFloat(n[1]));break;case"#SAMPLELENGTH":n[1]&&(s.sampleLength=parseFloat(n[1]));break;case"#BACKGROUND":if(n[1]&&t[n[1].toLowerCase()]){const e=t[n[1].toLowerCase()];s.background=e.localURL?e.localURL:URL.createObjectURL(e),s.background=s.background.replace("cdvfile://","file://").replace("localhost/persistent/","/storage/emulated/0/")}break;case"#VIDEO":if(n[1]&&t[n[1].toLowerCase()]){const e=t[n[1].toLowerCase()];s.videoUrl=e.localURL?e.localURL:URL.createObjectURL(e),s.videoUrl=s.videoUrl.replace("cdvfile://","file://").replace("localhost/persistent/","/storage/emulated/0/")}break;case"#LYRICSPATH":if(n[1]&&t[n[1].toLowerCase()]){const e=t[n[1].toLowerCase()];s.lyrics=e.localURL?e.localURL:URL.createObjectURL(e),s.lyrics=s.lyrics.replace("cdvfile://","file://").replace("localhost/persistent/","/storage/emulated/0/")}break;case"#MUSIC":if(n[1]&&(s.audio=n[1],t[n[1].toLowerCase()])){const e=t[n[1].toLowerCase()];s.audioUrl=e.localURL?e.localURL:URL.createObjectURL(e),s.audioUrl=s.audioUrl.replace("cdvfile://","file://").replace("localhost/persistent/","/storage/emulated/0/")}break;case"#OFFSET":s.offset=Number(n[1]);break;case"#BPMS":{let t=n[1].split(",");t=t.filter(t=>/=/.exec(t));for(let e in t){let s=t[e].split("=");t[e]={beat:Number(s[0]),bpm:Number(s[1])}}s.bpmChanges=s.bpmChanges.concat(t);break}case"#STOPS":{let t=n[1].split(",");t=t.filter(t=>t.includes("="));for(let e in t){let s=t[e].split("=");t[e]={beat:Number(s[0]),len:Number(s[1])}}s.stops=s.stops.concat(t);break}case"#NOTES":a[n[3]+n[4]]=n[6].split(","),s.difficulties.push({type:n[3],rating:n[4]})}}if(s.bpmChanges.sort((t,e)=>t.beat-e.beat),0===s.bpmChanges.length||0!==s.bpmChanges[0].beat)throw"No starting bpm";s.bpmChanges[0].sec=0;for(let t=1;t<s.bpmChanges.length;t++)s.bpmChanges[t].sec=this.beatToSec(s.bpmChanges,s.stops,s.bpmChanges[t].beat);for(let t=0;t<s.stops.length;t++)s.stops[t].sec=this.beatToSec(s.bpmChanges,s.stops,s.stops[t].beat);for(let t in a){let e=[null,null,null,null];s.notes[t]=[];for(let i in a[t]){if(a[t][i]=a[t][i].trim(),a[t][i].length%4)throw`Invalid length on measure ${i}, length is ${a[t][i].length}`;a[t][i]=a[t][i].match(/(.{4})/g);let n=a[t][i].length;for(let o in a[t][i]){let r=a[t][i][o],h=[{},{},{},{}],l=4*i+o/n*4;for(let i=0;i<h.length;i++){switch(r[i]){case"3":if(null==e[i])throw"hold end without any hold before";{let a=s.notes[t][e[i]];a.beatEnd=l,a.beatLength=l-a.beat,a.secEnd=this.beatToSec(s.bpmChanges,s.stops,l),a.secLength=this.beatToSec(s.bpmChanges,s.stops,l)-this.beatToSec(s.bpmChanges,s.stops,a.beat)}e[i]=null;case"0":h[i]=null;continue;case"4":case"2":if(e[i])throw"new hold started before last ended";e[i]=s.notes[t].length+i;case"1":case"M":h[i].type=r[i];break;default:throw`invalid note type ${r[i]}`}h[i].beat=l,h[i].sec=this.beatToSec(s.bpmChanges,s.stops,l),h[i].column=i}s.notes[t]=s.notes[t].concat(h)}}s.notes[t]=s.notes[t].filter(t=>null!==t)}return s}parseSSC(t,e){const s=e.split(/\/\/-+/),i=s[0],a=s.slice(1),n={bpmChanges:[],stops:[],notes:{},backgrounds:[],banner:"no-media",difficulties:[],background:"no-media",cdtitle:null,audioUrl:null,videoUrl:null,files:t,sampleStart:0,sampleLength:10},o={};if(i.split("\n").filter(t=>t.trim().startsWith("#")).forEach(t=>{const[e,...s]=t.slice(1).split(":");let i=s.join(":").trim().replace(/;+$/,"");["BPMS","STOPS","BGCHANGES"].includes(e)&&(i=i.split(",").map(t=>t.trim()).join(",")),o[e]=i}),o.MUSIC&&t[o.MUSIC.toLowerCase()]){const e=t[o.MUSIC.toLowerCase()];n.audioUrl=e.localURL?e.localURL:URL.createObjectURL(e),n.audio=o.MUSIC}if(Object.assign(n,{title:o.TITLE||"",subtitle:o.SUBTITLE||"",artist:o.ARTIST||"",titleTranslit:o.TITLETRANSLIT||"",subtitleTranslit:o.SUBTITLETRANSLIT||"",artistTranslit:o.ARTISTTRANSLIT||"",genre:o.GENRE||"",credit:o.CREDIT||"",offset:Number(o.OFFSET)||0,sampleStart:Number(o.SAMPLESTART)||0,sampleLength:Number(o.SAMPLELENGTH)||10}),o.BANNER&&t[o.BANNER.toLowerCase()]){const e=t[o.BANNER.toLowerCase()];n.banner=e.localURL?e.localURL:URL.createObjectURL(e)}if(o.BACKGROUND&&t[o.BACKGROUND.toLowerCase()]){const e=t[o.BACKGROUND.toLowerCase()];n.background=e.localURL?e.localURL:URL.createObjectURL(e)}if(o.BPMS){const t=o.BPMS.split(",").map(t=>{const[e,s]=t.split("=");return{beat:Number(e),bpm:Number(s)}});n.bpmChanges=t}if(o.STOPS){const t=o.STOPS.split(",").map(t=>{const[e,s]=t.split("=");return{beat:Number(e),len:Number(s)}});n.stops=t}if(n.bpmChanges.length>0){n.bpmChanges.sort((t,e)=>t.beat-e.beat),n.bpmChanges[0].sec=0;for(let t=1;t<n.bpmChanges.length;t++)n.bpmChanges[t].sec=this.beatToSec(n.bpmChanges,n.stops,n.bpmChanges[t].beat);for(let t=0;t<n.stops.length;t++)n.stops[t].sec=this.beatToSec(n.bpmChanges,n.stops,n.stops[t].beat)}return a.forEach(t=>{const e=t.split("\n").filter(t=>""!==t.trim()),s={};let i=!1,a=[];if(e.forEach(t=>{if(t.startsWith("#")){if(t.startsWith("#NOTES"))i=!0;else if(!t.startsWith("#NOTEDATA")&&!t.startsWith("#CHARTNAME")){const[e,...i]=t.slice(1).split(":"),a=i.join(":").trim().replace(/;+$/,"");s[e]=a}}else i&&(";"===t.trim()?i=!1:a.push(t.trim()))}),s.DIFFICULTY&&s.METER){const t=`${s.DIFFICULTY}${s.METER}`;n.difficulties.push({type:s.DIFFICULTY,rating:s.METER}),n.notes[t]=this.convertSSCNotes(a,n.bpmChanges,n.stops)}}),n}convertSSCNotes(t,e,s){const i=[];let a=0;return t.forEach(t=>{const n=t.split("\n").filter(t=>""!==t.trim()),o=n.length;n.forEach((t,n)=>{const r=4*a+n/o*4;for(let a=0;a<4&&a<t.length;a++){const n=t[a];if("0"!==n&&"3"!==n){const t={type:n,beat:r,sec:this.beatToSec(e,s,r),column:a};i.push(t)}}}),a++}),i}getLastBpm(t,e,s){return t.find((t,i,a)=>i+1==a.length||a[i+1][s]>=e)}beatToSec(t,e,s){if(!t||0===t.length)return s;let i=this.getLastBpm(t,s,"beat"),a=(s-i.beat)/i.bpm*60+i.sec,n=e.filter(({beat:t})=>t>=i.beat&&t<s).map(t=>t.len);for(let t in n)a+=n[t];return a}}class AddonManager{constructor(){this.addons=new Map,this.enabledAddons=new Set,this.hibernatingAddons=new Set,this.safeMode=!1,this.isInitialized=!1}async initialize(){if(!this.isInitialized){if(this.safeMode=Account.settings?.safeMode||!1,this.enabledAddons=new Set(Account.settings?.enabledAddons||[]),this.hibernatingAddons=new Set(Account.settings?.hibernatingAddons||[]),this.safeMode)return console.log("ðŸ”’ Addon Safe Mode enabled - skipping addon loading"),void(this.isInitialized=!0);await this.loadAddons(),this.isInitialized=!0}}async loadAddons(){try{console.log("ðŸ“¦ Loading addons..."),await this.loadAddonsFromStorage(),await this.processAddons()}catch(t){console.error("Error loading addons:",t)}}async loadAddonsFromStorage(){const t=new FileSystemTools;try{const e=await t.getDirectory(EXTERNAL_DIRECTORY+"Addons"),s=await t.listDirectories(e);console.log(`Found ${s.length} addon directories`);for(const e of s)try{await this.loadAddonFromDirectory(e,t)}catch(t){console.warn(`Failed to load addon from ${e.name}:`,t)}}catch(t){console.log("No external addons directory found")}}async loadAddonFromDirectory(t,e){const s=await e.listFiles(t),i={};for(const t of s){const s=await e.getFile(t);i[s.name.toLowerCase()]={entry:t,file:s,name:s.name}}const a=i["manifest.json"];if(!a)throw new Error("No manifest.json found");const n=await e.readFileContent(a.file),o=JSON.parse(n);if(!o.id||!o.name||!o.version)throw new Error("Invalid manifest: missing required fields");const r={id:o.id,name:o.name,version:o.version,icon:o.icon,author:o.author||"Unknown",description:o.description||"",manifest:o,directory:t,dir:t,files:i,assets:[],behaviors:{},isEnabled:this.enabledAddons.has(o.id)&&!this.hibernatingAddons.has(o.id),isHibernating:this.hibernatingAddons.has(o.id)};o.icon&&(r.icon=r.dir.nativeURL+o.icon),this.processAddonAssets(r),this.addons.set(r.id,r),console.log(`ðŸ“¦ Loaded addon: ${r.name} v${r.version} (${r.isEnabled?"enabled":"disabled"})`)}async processAddons(){for(const[t,e]of this.addons)if(e.isEnabled)try{await this.processAddonBehaviors(e)}catch(t){console.error(`Failed to process addon ${e.name}:`,t)}}processAddonAssets(t){const e=t.manifest.assets;if(!e)return;const s={};window.gameResources.forEach(t=>s[t.key]=t);for(const[i,a]of Object.entries(e)){const e=t.dir.nativeURL+a;t.assets;s[i]?t.assets.push({...s[i],key:i,url:e}):t.assets.push({type:"image",key:i,url:e})}}async processAddonBehaviors(t){const e=t.manifest.behaviors;if(e)for(const[s,i]of Object.entries(e)){const e=t.dir.nativeURL+i,a=await this.loadTextFile(e);t.behaviors[s]={content:a,stateName:s}}}async loadTextFile(t){return new Promise((e,s)=>{const i=new XMLHttpRequest;i.open("GET",t),i.onload=()=>{200===i.status?e(i.responseText):e(null)},i.onerror=()=>e(null),i.send()})}async readFileContent(t){return new Promise((e,s)=>{const i=new FileReader;i.onload=()=>e(i.result),i.onerror=()=>s(i.error),i.readAsText(t)})}executeBehavior(t,e,s,i){const a=t.behaviors[e];if(a)try{const e={global:s.global,game:game,state:s.state,addon:t,console:console,...i||{}};new Function(...Object.keys(e),`${a.content}`).call(s.global||window,...Object.values(e))}catch(s){console.error(`Error executing behavior for ${t.name} in ${e}:`,s)}}executeGlobalBehaviors(){for(const[t,e]of this.addons)!e.isHibernating&&e.isEnabled&&this.executeBehavior(e,"Global",{game:game,global:window})}executeStateBehaviors(t,e,s){for(const[i,a]of this.addons)!a.isHibernating&&a.isEnabled&&this.executeBehavior(a,t,{game:game,global:e,state:e,stateName:t,extraParams:s})}parseVersion(t){const e=t.split(".").map(t=>parseInt(t,10)||0);for(;e.length<3;)e.push(0);return e}compareVersions(t,e){for(let s=0;s<3;s++){if(t[s]>e[s])return 1;if(t[s]<e[s])return-1}return 0}enableAddon(t){const e=this.addons.get(t);return!!e&&(e.isEnabled=!0,this.enabledAddons.add(t),this.hibernatingAddons.delete(t),this.saveAddonSettings(),!0)}disableAddon(t){const e=this.addons.get(t);return!!e&&(e.isEnabled=!1,this.enabledAddons.delete(t),this.saveAddonSettings(),!0)}hibernateAddon(t){const e=this.addons.get(t);return!!e&&(e.isEnabled=!1,e.isHibernating=!0,this.enabledAddons.delete(t),this.hibernatingAddons.add(t),this.saveAddonSettings(),!0)}wakeAddon(t){const e=this.addons.get(t);return!(!e||!e.isHibernating)&&(e.isEnabled=!0,e.isHibernating=!1,this.enabledAddons.add(t),this.hibernatingAddons.delete(t),this.saveAddonSettings(),!0)}uninstallAddon(t){const e=this.addons.get(t);return!!e&&(e.dir.removeRecursively(),this.addons.delete(t),!0)}setSafeMode(t){this.safeMode=t,Account.settings.safeMode=t,saveAccount()}getAddonList(){return Array.from(this.addons.values()).map(t=>({id:t.id,name:t.name,version:t.version,author:t.author,description:t.description,isEnabled:t.isEnabled,isHibernating:t.isHibernating,icon:t.icon,assets:t.assets,behaviors:t.behaviors,hasAssets:Object.keys(t.assets).length>0,hasBehaviors:Object.keys(t.behaviors).length>0}))}getResourceList(){let t=[];return Array.from(this.addons.values()).forEach(e=>{!e.isHibernating&&e.isEnabled&&(t=[...t,...e.assets])}),t}saveAddonSettings(){Account.settings.enabledAddons=Array.from(this.enabledAddons),Account.settings.hibernatingAddons=Array.from(this.hibernatingAddons),Account.settings.safeMode=this.safeMode,saveAccount()}needsReload(){const t=new Set(Account.settings?.enabledAddons||[]),e=new Set(Account.settings?.hibernatingAddons||[]),s=Account.settings?.safeMode||!1;return!this.setsEqual(t,this.enabledAddons)||!this.setsEqual(e,this.hibernatingAddons)||s!==this.safeMode}setsEqual(t,e){if(t.size!==e.size)return!1;for(const s of t)if(!e.has(s))return!1;return!0}}class Boot{preload(){this.load.baseURL="assets/",this.keys=[],Object.keys(FONTS).forEach(t=>{const e=FONTS[t];this.load.spritesheet(e.font,`fonts/${t}.png`,e.fontWidth||4,e.fontHeight||6)}),WINDOW_PANELS.forEach(t=>{this.load.spritesheet(`ui_window_${t}`,`ui/window_${t}.png`,8,8),this.keys.push(`ui_window_${t}`)})}create(){gamepad=new Gamepad(game),notifications=new NotificationSystem,game.time.advancedTiming=!0,game.world.updateOnlyExistingChildren=!0,game.onMenuIn=new Phaser.Signal,window.primaryAssets=this.keys,window.gameResources=[{key:"ui_loading_dots",url:"ui/loading_dots.png",type:"spritesheet",frameWidth:26,frameHeight:6},{key:"ui_background_gradient",url:"ui/background_gradient.png"},{key:"ui_logo_shape",url:"ui/logo_shape.png"},{key:"ui_hud_background",url:"ui/hud_background.png"},{key:"ui_navigation_hint_keyboard",url:"ui/navigation_hint_keyboard.png",type:"spritesheet",frameWidth:192,frameHeight:112},{key:"ui_navigation_hint_gamepad",url:"ui/navigation_hint_gamepad.png",type:"spritesheet",frameWidth:192,frameHeight:112},{key:"ui_difficulty_banner",url:"ui/difficulty_banner.png"},{key:"ui_lifebar",url:"ui/lifebar.png",type:"spritesheet",frameWidth:1,frameHeight:5},{key:"ui_acurracy_bar",url:"ui/acurracy_bar.png"},{key:"ui_jukebox_pause_toggle",url:"ui/jukebox_pause_toggle.png",type:"spritesheet",frameWidth:12,frameHeight:12},{key:"ui_jukebox_seek",url:"ui/jukebox_seek.png",type:"spritesheet",frameWidth:8,frameHeight:8},{key:"ui_jukebox_skip",url:"ui/jukebox_skip.png",type:"spritesheet",frameWidth:8,frameHeight:8},{key:"ui_jukebox_menu",url:"ui/jukebox_menu.png",type:"spritesheet",frameWidth:8,frameHeight:8},{key:"ui_jukebox_visualization",url:"ui/jukebox_visualization.png",type:"spritesheet",frameWidth:8,frameHeight:8},{key:"assist_tick",type:"audio",url:"sfx/assist_tick.ogg"},{key:"arrows",url:"chart/arrows.png",type:"spritesheet",frameWidth:16,frameHeight:16},{key:"receptor",url:"chart/receptor.png",type:"spritesheet",frameWidth:16,frameHeight:16},{key:"explosion",url:"chart/explosion.png",type:"image"},{key:"mineexplosion",url:"chart/mine_explosion.png",type:"image"},{key:"mine",url:"chart/mine.png",type:"spritesheet",frameWidth:16,frameHeight:16},{key:"hold_end",url:"chart/hold_end.png",type:"spritesheet",frameWidth:16,frameHeight:8},{key:"hold_body",url:"chart/hold_body.png",type:"spritesheet",frameWidth:16,frameHeight:112},{key:"roll_end",url:"chart/roll_end.png",type:"spritesheet",frameWidth:16,frameHeight:8},{key:"roll_body",url:"chart/roll_body.png",type:"spritesheet",frameWidth:16,frameHeight:16}],window.addEventListener("keydown",t=>{if("INPUT"!==document.activeElement.tagName)switch(t.code){case"F8":t.preventDefault(),game.recorder&&game.recorder.screenshot();break;case"F9":t.preventDefault(),game.recorder.isRecording?game.recorder.stop():game.recorder.start();break;case"F10":t.preventDefault(),window.recordNextGame=!0}}),game.state.start("Load",!0,!1,window.gameResources,"LoadCordova")}}class Load{init(t,e,s){this.resources=t||[],this.nextState=e||"Title",this.nextStateParams=s||{},this.loadedCount=0,this.totalCount=this.resources.length}preload(){this.resources.forEach(t=>{switch(t.type){case void 0:case"image":this.load.image(t.key,t.url);break;case"spritesheet":this.load.spritesheet(t.key,t.url,t.frameWidth,t.frameHeight);break;case"audio":this.load.audio(t.key,t.url);break;case"video":this.load.video(t.key,t.url,"canplay",!0);break;case"json":this.load.json(t.key,t.url);break;case"text":this.load.text(t.key,t.url)}this.loadedCount++}),this.progressText=new ProgressText("LOADING ASSETS")}create(){game.state.start(this.nextState,!0,!1,this.nextStateParams)}}class LoadCordova{create(){CURRENT_ENVIRONMENT==ENVIRONMENT.CORDOVA?this.loadScript():this.createFolderStructure()}loadScript(){this.loadingDots=new LoadingDots,this.progressText=new ProgressText("INITIALIZING FILESYSTEM");const t=document.createElement("script");t.src="./cordova/cordova.js",document.head.appendChild(t),document.addEventListener("deviceready",()=>{this.createFolderStructure(),document.addEventListener("backbutton",()=>{"Play"==game.state.current?gamepad.press("start"):gamepad.press("b")})})}async createFolderStructure(){if(CURRENT_ENVIRONMENT==ENVIRONMENT.CORDOVA||CURRENT_ENVIRONMENT==ENVIRONMENT.NWJS){const t=new FileSystemTools,e=await t.getDirectory(""),s=await t.createDirectory(e,EXTERNAL_DIRECTORY);await t.createDirectory(s,"Addons"),await t.createDirectory(s,"Screenshots"),await t.createDirectory(s,"Songs")}this.continue()}continue(){game.state.start("LoadAddons")}}class LoadAddons{create(){this.progressText=new ProgressText("LOADING ADD-ONS"),this.loadingDots=new LoadingDots,this.initialize()}async initialize(){addonManager=new AddonManager,await addonManager.initialize(),addonManager.executeGlobalBehaviors();const t=addonManager.getResourceList();game.load.baseURL="",game.state.start("Load",!0,!1,t,"LoadLocalSongs")}}class LoadLocalSongs{create(){this.progressText=new ProgressText("LOADING SONGS"),this.songs=[],this.parser=new LocalSMParser,this.loadSongs(),this.loadingDots=new LoadingDots}async loadSongs(){try{const t=DEFAULT_SONG_FOLDERS;for(const e of t)try{const t=await this.loadSong(e);t&&this.songs.push(t)}catch(t){console.warn(`Failed to load song from ${e}:`,t)}this.finish()}catch(t){console.error("Error loading songs:",t)}}async loadSong(t){const e=`assets/songs/${t}/`;try{let s=e+t+".sm",i=await this.loadTextFile(s);if(!i){const t=["song.sm","chart.sm","steps.sm"];for(const s of t)if(i=await this.loadTextFile(e+s),i)break}if(!i)throw new Error(`No .sm file found in ${t}`);const a=await this.parser.parseSM(i,e);return a.folderName=t,a.loaded=!0,a}catch(e){return console.warn(`Could not load song ${t}:`,e),null}}async loadTextFile(t){return new Promise((e,s)=>{const i=new XMLHttpRequest;i.open("GET",t),i.onload=()=>{200===i.status?e(i.responseText):e(null)},i.onerror=()=>e(null),i.send()})}finish(){window.localSongs=this.songs,game.state.start("Title")}}class LoadExternalSongs{init(t,e){this.nextState=t||"SongSelect",this.nextStateParams=e||[]}create(){if(this.loadingDots=new LoadingDots,this.progressText=new ProgressText("LOADING EXTERNAL SONGS"),this.fileSystem=new FileSystemTools,window.externalSongs)return this.songs=window.externalSongs,void this.finish(window.lastExternalSongIndex||0);this.songs=[],this.parser=new ExternalSMParser,this.loadedCount=0,this.failedCount=0,this.totalCount=0,this.currentlyLoading=new Set,CURRENT_ENVIRONMENT==ENVIRONMENT.CORDOVA||CURRENT_ENVIRONMENT==ENVIRONMENT.NWJS?this.loadSongsFromStorage():this.showFileInput()}async loadSongsFromStorage(){try{console.log("Loading songs from external storage...");const t=await this.fileSystem.getDirectory(EXTERNAL_DIRECTORY+"Songs"),e=await this.fileSystem.listAllDirectories(t);e.unshift(t),this.totalCount=e.length,this.updateProgress(),console.log(`Found ${this.totalCount} directories to scan`),await this.loadDirectoriesSequential(e),this.finish()}catch(t){console.error("Error loading external songs:",t),this.showError("Failed to load external songs: "+t.message)}}async loadDirectoriesParallel(t){const e=[];for(let s=0;s<t.length;s+=16)e.push(t.slice(s,s+16));for(const t of e)await this.processDirectoryBatch(t)}async processDirectoryBatch(t){const e=t.map(t=>this.processSongDirectoryWithTracking(t));await Promise.allSettled(e)}async loadDirectoriesSequential(t){for(const e of t)await this.processSongDirectoryWithTracking(e)}async processSongDirectoryWithTracking(t){const e=t.name||"Unknown Directory";this.currentlyLoading.add(e);try{const s=await this.processSongDirectory(t);s?(this.songs.push(s),this.loadedCount++,console.log(`âœ“ Loaded: ${s.title||e}`)):(this.failedCount++,console.log(`âœ— Failed: ${e} (no valid chart found)`))}catch(t){console.warn(`âœ— Error in ${e}:`,t),this.failedCount++}finally{this.currentlyLoading.delete(e),this.updateProgress()}}async processSongDirectory(t){try{const e=await this.fileSystem.listFiles(t),s={};for(const t of e){const e=await this.fileSystem.getFile(t);s[e.name.toLowerCase()]=e}const i=Object.keys(s).filter(t=>t.endsWith(".sm")||t.endsWith(".ssc"));if(0===i.length)return console.log(`No chart files found in ${t.name}`),null;for(const e of i)try{console.log(`Trying to parse ${e} in ${t.name}`);const i=await this.fileSystem.readFileContent(s[e]),a=this.parser.parseSM(s,i);if(a&&a.difficulties&&a.difficulties.length>0)return a.folderName=t.name||"External Song",a.loaded=!0,console.log(`âœ“ Successfully parsed ${e}`),a}catch(t){console.warn(`Failed to parse ${e}:`,t);continue}return console.log(`No valid chart files in ${t.name}`),null}catch(e){return console.warn(`Error processing directory ${t.name}:`,e),null}}updateProgress(){const t=this.loadedCount+this.failedCount,e=this.totalCount>0?Math.round(t/this.totalCount*100):0,s=`${this.loadedCount}/${this.totalCount-this.failedCount} (${e}%)`;this.progressText.write(s)}showFileInput(){const t=document.createElement("input");t.type="file",t.webkitdirectory=!0,t.multiple=!0,t.onchange=t=>{this.processFileInput(t.target.files)},t.click()}async processFileInput(t){try{const e={};for(let s=0;s<t.length;s++)e[t[s].name.toLowerCase()]=t[s];const s={};for(const e of t){const t=e.webkitRelativePath.split("/")[0];s[t]||(s[t]={}),s[t][e.name.toLowerCase()]=e}const i=Object.keys(s);this.totalCount=i.length,this.updateProgress(),await this.processFileDirectoriesSequential(s,i),this.finish()}catch(t){console.error("Error processing file input:",t),this.showError("Failed to load songs from files: "+t.message)}}async processFileDirectoriesParallel(t,e){const s=[];for(let t=0;t<e.length;t+=16)s.push(e.slice(t,t+16));for(const e of s)await this.processFileDirectoryBatch(t,e)}async processFileDirectoryBatch(t,e){const s=e.map(e=>this.processSongFilesWithTracking(t[e],e));await Promise.allSettled(s)}async processFileDirectoriesSequential(t,e){for(const s of e)await this.processSongFilesWithTracking(t[s],s)}async processSongFilesWithTracking(t,e){this.currentlyLoading.add(e);try{const s=await this.processSongFiles(t,e);s?(this.songs.push(s),this.loadedCount++,console.log(`âœ“ Loaded: ${s.title||e}`)):(this.failedCount++,console.log(`âœ— Failed: ${e} (no valid chart found)`))}catch(t){console.warn(`âœ— Error in ${e}:`,t),this.failedCount++}finally{this.currentlyLoading.delete(e),this.updateProgress()}}async processSongFiles(t,e){const s=Object.keys(t).filter(t=>t.endsWith(".sm")||t.endsWith(".ssc"));if(0===s.length)return console.log(`No chart files found in ${e}`),null;for(const i of s)try{console.log(`Trying to parse ${i} in ${e}`);const s=await this.fileSystem.readFileContent(t[i]),a=this.parser.parseSM(t,s);if(a&&a.difficulties&&a.difficulties.length>0)return a.folderName=e,a.loaded=!0,console.log(`âœ“ Successfully parsed ${i}`),a}catch(t){console.warn(`Failed to parse ${i}:`,t);continue}return console.log(`No valid chart files in ${e}`),null}showError(t){this.progressText.write(t),game.time.events.add(3e3,()=>{game.state.start("MainMenu")})}finish(t=0){console.log(`Loading complete: ${this.loadedCount} songs loaded, ${this.failedCount} failed`),0!==this.songs.length?(window.externalSongs=this.songs,this.nextStateParams.length?game.state.start(this.nextState,!0,!1,...this.nextStateParams):game.state.start(this.nextState,!0,!1,this.songs),setTimeout(()=>window.lastExternalSongIndex=window.selectStartingIndex)):this.showError("No external songs found")}}class LoadSongFolder{create(){this.progressText=new ProgressText("SELECT SONG FOLDER"),this.parser=new ExternalSMParser,this.showFileInput()}showFileInput(){const t=document.createElement("input");t.type="file",t.webkitdirectory=!0,t.multiple=!0,t.onchange=t=>{this.processFiles(t.target.files)},t.webkitdirectory||(t.multiple=!0,this.progressText.write("Select all song files")),t.click()}async processFiles(t){try{this.progressText.write("LOADING SONG...");const e={};for(let s=0;s<t.length;s++)e[t[s].name.toLowerCase()]=t[s];const s=Object.keys(e).filter(t=>t.endsWith(".sm"));if(0===s.length)return void this.showError("No .sm file found in selected folder");const i=s[0],a=await this.readFileContent(e[i]),n=this.parser.parseSM(e,a);n.folderName=`Single_External_${i}`,n.loaded=!0,game.state.start("SongSelect",!0,!1,[n],0,!0)}catch(t){console.error("Error loading song folder:",t),this.showError("Failed to load song")}}readFileContent(t){return new Promise((e,s)=>{const i=new FileReader;i.onload=()=>e(i.result),i.onerror=()=>s(i.error),i.readAsText(t)})}showError(t){this.progressText.write(t),game.time.events.add(3e3,()=>{game.state.start("MainMenu")})}}class Title{create(){game.camera.fadeIn(16777215),this.background=new BackgroundGradient,this.lines=new FuturisticLines,this.logo=new Logo,this.inputInstructionText=new Text(game.width/2,80,"PRESS ANY KEY"),this.inputInstructionText.anchor.x=.5,game.add.tween(this.inputInstructionText).to({alpha:0},500,"Linear",!0,0,-1).yoyo(!0),this.text=game.add.sprite(0,0),this.creditText=new Text(2,110,COPYRIGHT,this.text),this.creditText.anchor.y=1,this.creditText=new Text(190,110,VERSION,this.text),this.creditText.anchor.set(1),backgroundMusic||(backgroundMusic=new BackgroundMusic),backgroundMusic.playLastSong(),this.introEnded=!1,this.logo.intro(()=>this.introEnded=!0),addonManager.executeStateBehaviors(this.constructor.name,this)}update(){gamepad.update(),this.introEnded&&!this.outroStarted&&gamepad.pressed.any&&(this.outroStarted=!0,this.text.alpha=0,this.logo.outro(()=>game.state.start("MainMenu")))}}class MainMenu{create(){game.camera.fadeIn(16777215),this.futuristicLines=new FuturisticLines,this.backgroundGradient=new BackgroundGradient,this.navigationHint=new NavigationHint(0),this.menu(),this.previewCanvas=document.createElement("canvas"),this.previewCtx=this.previewCanvas.getContext("2d"),this.previewImg=new Image,backgroundMusic&&backgroundMusic.isPlaying||(backgroundMusic||(backgroundMusic=new BackgroundMusic),backgroundMusic.playLastSong()),addonManager.executeStateBehaviors(this.constructor.name,this)}menu(){const t=new WindowManager;this.manager=t;const e=()=>{const t=new CarouselMenu(0,56,112,56,{align:"left",bgcolor:"brown",fgcolor:"#ffffff",animate:!0,crop:!1});t.addItem("Rhythm Game",()=>s()),t.addItem("Settings",()=>n()),t.addItem("Extras",()=>o()),game.onMenuIn.dispatch("home",t),CURRENT_ENVIRONMENT!=ENVIRONMENT.CORDOVA&&CURRENT_ENVIRONMENT!=ENVIRONMENT.NWJS||(t.addItem("Exit",()=>u()),t.onCancel.add(()=>u()))},s=()=>{const t=new CarouselMenu(0,56,112,56,{align:"left",bgcolor:"brown",fgcolor:"#ffffff",animate:!0,crop:!1});t.addItem("Free Play",()=>this.freePlay()),t.addItem("Extra Songs",()=>i()),game.onMenuIn.dispatch("startGame",t),t.addItem("< Back",()=>e()),t.onCancel.add(()=>e())},i=()=>{const t=new CarouselMenu(0,56,112,56,{align:"left",bgcolor:"brown",fgcolor:"#ffffff",animate:!0,crop:!1});CURRENT_ENVIRONMENT!=ENVIRONMENT.CORDOVA&&CURRENT_ENVIRONMENT!=ENVIRONMENT.NWJS||t.addItem("User Songs",()=>this.loadExternalSongs()),t.addItem("Load Single Song",()=>this.loadSingleSong()),!window.externalSongs||CURRENT_ENVIRONMENT!=ENVIRONMENT.CORDOVA&&CURRENT_ENVIRONMENT!=ENVIRONMENT.NWJS||t.addItem("Reload User Songs",()=>{backgroundMusic.refreshCache(),window.externalSongs=void 0,this.loadExternalSongs()}),game.onMenuIn.dispatch("extraSongs",t),t.addItem("< Back",()=>e()),t.onCancel.add(()=>e())};let a;const n=()=>{a=t.createWindow(3,1,18,12,"1"),a.fontTint=7797982,a.addSettingItem("Volume",["0%","25%","50%","75%","100%"],Account.settings.volume,t=>{Account.settings.volume=t,saveAccount(),backgroundMusic.audio.volume=[0,25,50,75,100][t]/100}),a.addSettingItem("Auto-play",["OFF","ON"],Account.settings.autoplay?1:0,t=>{Account.settings.autoplay=1===t,saveAccount()});const s=["OFF","Note","Quarters","Eighths","Sixteenths","Thirty-seconds"],i=Account.settings.metronome||"OFF",n=s.indexOf(i);a.addSettingItem("Metronome",s,n,t=>{const e=s[t];Account.settings.metronome=e,saveAccount()});let o=0;o=Account.settings.enableMenuMusic?Account.settings.randomSong?1:0:2;const r=["NONE","BPM","ACURRACY","AUDIO"],h=Account.settings.visualizer||"NONE",u=r.indexOf(h);a.addSettingItem("Visualizer",r,u,t=>{const e=r[t];Account.settings.visualizer=e,saveAccount()}),a.addSettingItem("Scroll Direction",["FALLING","RISING"],"falling"===Account.settings.scrollDirection?0:1,t=>{Account.settings.scrollDirection=0===t?"falling":"rising",saveAccount()});const g=[{value:"NOTE",display:"NOTE"},{value:"VIVID",display:"VIVID"},{value:"FLAT",display:"FLAT"},{value:"RAINBOW",display:"RAINBOW"}],p=Account.settings.noteColorOption||"NOTE",m=g.findIndex(t=>t.value===p);a.addSettingItem("Note Colors",g.map(t=>t.display),m,t=>{const e=g[t].value;Account.settings.noteColorOption=e,saveAccount()}),a.addSettingItem("Note Speed",["Normal","Double","Triple","Insane","Sound Barrier","Light Speed","Faster than light"],Account.settings.noteSpeedMult-1,t=>{Account.settings.noteSpeedMult=t+1,saveAccount()}),a.addSettingItem("Speed Mod",["X-MOD","C-MOD"],"C-MOD"===Account.settings.speedMod?1:0,t=>{Account.settings.speedMod=1===t?"C-MOD":"X-MOD",saveAccount()}),a.addSettingItem("Beat Lines",["YES","NO"],Account.settings.beatLines?0:1,t=>{Account.settings.beatLines=0===t,saveAccount()});const f=[];for(let t=-1e3;t<=1e3;t+=25)f.push(`${t}ms`);const y=((Account.settings.userOffset||0)+1e3)/25;a.addSettingItem("Global Offset",f,y,t=>{const e=25*t-1e3;Account.settings.userOffset=e,saveAccount()}),a.addSettingItem("Menu Music",["LAST SONG","RANDOM SONG","OFF"],o,t=>{switch(t){case 0:Account.settings.randomSong=!1,Account.settings.enableMenuMusic=!0;break;case 1:Account.settings.randomSong=!0,Account.settings.enableMenuMusic=!0;break;case 2:Account.settings.enableMenuMusic=!1}saveAccount()});let b=!1;a.addSettingItem("Renderer",["AUTO","CANVAS","WEBGL"],Account.settings.renderer,t=>{Account.settings.renderer=t,saveAccount(),b=!0}),a.addSettingItem("Pixelated",["YES","NO"],Account.settings.pixelated?0:1,t=>{Account.settings.pixelated=0==t,b=!0,saveAccount()}),a.addSettingItem("Safe Mode",["ENABLED","DISABLED"],Account.settings.safeMode?0:1,t=>{b=!0;const e=0==t;addonManager?.setSafeMode(e),saveAccount()}),a.addItem("Erase Highscores","",()=>l()),game.onMenuIn.dispatch("settings",a),a.addItem("Restore Default Settings","",()=>c()),a.addItem("APPLY","",()=>{t.remove(a,!0),b?d():e()},!0)},o=()=>{const t=new CarouselMenu(0,56,112,56,{align:"left",bgcolor:"brown",fgcolor:"#ffffff",animate:!0,crop:!1});CURRENT_ENVIRONMENT!=ENVIRONMENT.CORDOVA&&CURRENT_ENVIRONMENT!=ENVIRONMENT.NWJS||t.addItem("Addon Manager",()=>this.addonManager()),t.addItem("Offset Assistant",()=>this.startOffsetAssistant()),t.addItem("Jukebox",()=>r()),t.addItem("Credits",()=>this.showCredits()),game.onMenuIn.dispatch("extras",t),t.addItem("< Back",()=>e()),t.onCancel.add(()=>e())},r=()=>{CURRENT_ENVIRONMENT==ENVIRONMENT.CORDOVA||CURRENT_ENVIRONMENT==ENVIRONMENT.NWJS?window.externalSongs?game.state.start("Jukebox"):h("Load extra songs from external storage?",()=>{game.state.start("LoadExternalSongs",!0,!1,"Jukebox",[void 0,void 0])},()=>{game.state.start("Jukebox")}):game.state.start("Jukebox")},h=(e,s,i)=>{t.remove(a,!0);const n=new Text(game.width/2,40,e||"You sure?",FONTS.shaded);n.anchor.x=.5;const o=t.createWindow(10,7,5,4,"1");o.fontTint=7797982,o.offset={x:7,y:0},o.addItem("Yes","",()=>{n.destroy(),t.remove(o,!0),s?.()}),o.addItem("No","",()=>{n.destroy(),t.remove(o,!0),i?.()},!0)},l=()=>h("Permanently erase hight scores?",()=>{Account.highScores={},saveAccount(),n()},()=>n()),c=()=>{h("All settings will be restored to default.\nA refresh is needed",()=>{Account.settings=DEFAULT_ACCOUNT.settings,saveAccount(),window.location.reload()},()=>n())},d=()=>h("Restart Now?",()=>location.reload(),()=>n()),u=()=>h("Sure? Exit?",()=>{switch(CURRENT_ENVIRONMENT){case ENVIRONMENT.CORDOVA:navigator.app.exitApp();break;case ENVIRONMENT.NWJS:nw?.App?.quit?.()}},()=>e());e()}freePlay(){game.state.start("SongSelect",!0,!1,window.localSongs)}startOffsetAssistant(){const t=new OffsetAssistant(game);game.add.existing(t)}loadExternalSongs(){game.state.start("LoadExternalSongs")}loadSingleSong(){game.state.start("LoadSongFolder")}addonManager(){const t=new Text(4,4,""),e=game.add.sprite(112,4),s=()=>{const t=addonManager.getAddonList(),e=new CarouselMenu(96,56,96,56,{align:"left",bgcolor:"brown",fgcolor:"#ffffff",animate:!0,crop:!1});0===t.length?e.addItem("No addons installed",()=>{}):(t.forEach(t=>{const s=t.isHibernating?"gray":t.isEnabled?"#00cc00":"brown";e.addItem(`${t.name} v${t.version}`,()=>n(t),{addon:t,bgcolor:s})}),e.onSelect.add((t,e)=>{e.data&&e.data.addon&&a(e.data.addon)}),a(t[0])),game.onMenuIn.dispatch("addons",e),e.addItem("< Back",()=>o()),e.onCancel.add(()=>o())};let i=!1;const a=s=>{t.write(`${s.name}\nV${s.version}\nBy ${s.author}\nBEHAVIORS:${s.behaviors?Object.keys(s.behaviors).length:0}\nASSETS:${s.assets?s.assets.length:0}\n\n${s.description}\nSTATE: `+(s.isHibernating?"Hybernating":s.isEnabled?"Enabled":"Disabled")+"\n").wrap(112),s.icon&&(this.previewImg.src=s.icon,this.previewImg.onload=()=>{this.previewCtx.drawImage(this.previewImg,0,0,50,50),e.loadTexture(PIXI.Texture.fromCanvas(this.previewCanvas))})},n=t=>{const e=new CarouselMenu(96,56,96,56,{align:"left",bgcolor:"#9b59b6",fgcolor:"#ffffff",animate:!0,crop:!1});t.isHibernating?e.addItem("Wake Addon",()=>{addonManager.wakeAddon(t.id),i=!0,s()}):t.isEnabled?(e.addItem("Disable Addon",()=>{addonManager.disableAddon(t.id),i=!0,s()}),e.addItem("Hibernate Addon",()=>{addonManager.hibernateAddon(t.id),i=!0,s()})):e.addItem("Enable Addon",()=>{addonManager.enableAddon(t.id),i=!0,s()}),e.addItem("Uninstall Addon",()=>r("The addon folder will be removed. Continue?",()=>{addonManager.uninstallAddon(t.id),i=!0,s()},()=>s())),game.onMenuIn.dispatch("addonDetails",e),e.addItem("< Back",()=>s()),e.onCancel.add(()=>s())},o=()=>{i||addonManager.needsReload()?r("Reload required. Restart now?",()=>{location.reload()},()=>{this.menu()}):(e.destroy(),t.destroy(),this.menu())},r=(s,i,a)=>{const n=new Text(game.width/2,40,s||"You sure?",FONTS.shaded);n.anchor.x=.5,e.destroy(),t.destroy();const o=this.manager.createWindow(10,7,5,4,"1");o.fontTint=7797982,o.offset={x:7,y:0},o.addItem("Yes","",()=>{n.destroy(),this.manager.remove(o,!0),i?.()}),o.addItem("No","",()=>{n.destroy(),this.manager.remove(o,!0),a?.()},!0)};s()}showCredits(){game.state.start("Credits",!0,!1,"MainMenu")}update(){gamepad.update(),this.manager?.update()}shutdown(){backgroundMusic&&(backgroundMusic.destroy(),backgroundMusic=null)}}class SongSelect{init(t,e,s){this.songs=t||[],this.songs=t||(window.selectedSongs||[]),window.selectedSongs=this.songs,this.startingIndex=e||(window.selectStartingIndex||0),this.autoSelect=s||!1,this.startingIndex+1>this.songs.length&&(this.startingIndex=0)}create(){game.camera.fadeIn(0),new FuturisticLines,new BackgroundGradient,this.selectedSong=null,this.selectedDifficulty=0,backgroundMusic&&backgroundMusic.stop(),this.previewAudio=document.createElement("audio"),this.previewAudio.volume=[0,25,50,75,100][Account.settings.volume]/100,this.bannerImg=document.createElement("img"),this.cdtitleImg=document.createElement("img"),this.previewCanvas=document.createElement("canvas"),this.previewCtx=this.previewCanvas.getContext("2d"),this.navigationHint=new NavigationHint(2),this.autoplayText=new Text(4,104,""),this.bannerSprite=game.add.sprite(4,4,null),this.metadataText=new Text(102,4,""),this.highScoreText=new Text(104,50,""),this.loadingDots=new LoadingDots,this.loadingDots.visible=!1,this.visibilityChangeListener=()=>{document.hidden?this.previewAudio?.pause():this.previewAudio?.play()},window.addEventListener("visibilitychange",this.visibilityChangeListener),this.createSongSelectionMenu(),this.autoSelect&&(this.selectSong(this.songs[this.songCarousel.selectedIndex],this.songCarousel.selectedIndex),this.songCarousel.destroy(),this.autoSelect=!1),addonManager.executeStateBehaviors(this.constructor.name,this)}createSongSelectionMenu(){const t=game.width/2;this.songCarousel=new CarouselMenu(0,35,t,72,{bgcolor:"#9b59b6",fgcolor:"#ffffff",align:"left",animate:!0,margin:{left:2}}),0===this.songs.length?this.songCarousel.addItem("No songs found",null):this.songs.forEach((t,e)=>{const s=t.titleTranslit||t.title,i=s||`Song ${e+1}`;this.songCarousel.addItem(i,s=>{this.selectSong(t,e)},{song:t,index:e})}),game.onMenuIn.dispatch("songList",this.songCarousel),this.songCarousel.selectedIndex=this.startingIndex,this.songCarousel.updateSelection(),this.songCarousel.onSelect.add((t,e)=>{e.data&&e.data.song&&this.previewSong(e.data.song)}),this.songCarousel.onCancel.add(()=>{game.state.start("MainMenu")}),this.songs.length>0&&this.previewSong(this.songs[this.songCarousel.selectedIndex])}previewSong(t){this.autoSelect||(this.loadingDots.visible=!0);let e=this.songCarousel.selectedIndex;t.audioUrl&&(this.previewAudio.src=t.audioUrl,this.previewAudio.currentTime=t.sampleStart||0,this.previewAudio.play()),t.banner&&(this.bannerImg.src=t.banner,this.bannerImg.onload=()=>{e==this.songCarousel.selectedIndex&&(this.loadingDots.visible=!1),this.previewCtx.drawImage(this.bannerImg,0,0,96,32);const t=PIXI.Texture.fromCanvas(this.previewCanvas);this.bannerSprite.loadTexture(t)},this.bannerImg.onerror=()=>this.loadingDots.visible=!1),this.metadataText.write(this.getMetadataText(t)),this.metadataText.wrapPreserveNewlines(80),this.displayHighScores(t),this.startingIndex=window.selectStartingIndex=this.songCarousel.selectedIndex}displayHighScores(t){const e=this.getSongKey(t),s=Account.highScores[e];if(!s)return void(this.highScoreText&&this.highScoreText.write("NO HIGH SCORES"));let i="HIGH SCORES:\n";t.difficulties.forEach((t,e)=>{const a=`${t.type}${t.rating}`,n=s[a];i+=n?`${t.type}: ${n.score.toLocaleString()} (${n.rating})\n`:`${t.type}: ---\n`}),this.highScoreText.write(i)}getSongKey(t){if(t.folderName)return`local_${t.folderName}`;if(t.audioUrl){let e=0;for(let s=0;s<t.audioUrl.length;s++){e=(e<<5)-e+t.audioUrl.charCodeAt(s),e&=e}return`external_${e.toString(36)}`}return`unknown_${Date.now()}`}getMetadataText(t){const e=t.titleTranslit||t.title,s=t.subtitleTranslit||t.subtitle,i=t.artistTranslit||t.artist,a=(t.genre,t.credit);let n="";return e&&(n+=e+"\n"),s&&(n+=s+"\n"),i&&(n+="Artist: "+i+"\n"),a&&(n+="Credit: "+a),n}selectSong(t,e){this.selectedSong=t,this.selectedDifficulty=0,this.showDifficultySelection(t)}showDifficultySelection(t){const e=game.width/2,s=game.height;this.difficultyCarousel=new CarouselMenu(0,37,e,s,{bgcolor:"#e67e22",fgcolor:"#ffffff",align:"center",animate:!0}),game.onMenuIn.dispatch("difficulty",this.songCarousel),t.difficulties.sort((t,e)=>t.rating-e.rating).forEach((e,s)=>{this.difficultyCarousel.addItem(`${e.type} (${e.rating})`,e=>{this.startGame(t,s)},{difficulty:e,index:s,bgcolor:this.getDifficultyColor(parseInt(e.rating))})}),this.difficultyCarousel.onCancel.add(()=>{this.createSongSelectionMenu()})}getDifficultyColor(t){t=Math.max(0,Math.min(11,t));var e=25,s=210,i=25,a=210,n=0,o=0,r=Math.floor(e+t/11*(a-e)),h=Math.floor(s+t/11*(n-s)),l=Math.floor(i+t/11*(o-i));return`#${Phaser.Color.componentToHex(r)}${Phaser.Color.componentToHex(h)}${Phaser.Color.componentToHex(l)}`}startGame(t,e){const s=[];t.lyrics&&s.push({type:"text",key:"song_lyrics",url:t.lyrics}),this.load.baseURL="",s.length?game.state.start("Load",!0,!1,s,"Play",{chart:t,difficultyIndex:e}):game.state.start("Play",!0,!1,{chart:t,difficultyIndex:e})}update(){gamepad.update(),this.songCarousel&&this.songCarousel.update(),this.difficultyCarousel&&this.difficultyCarousel.update(),gamepad.pressed.select&&(Account.settings.autoplay=!Account.settings.autoplay),this.autoplayText.write(Account.settings.autoplay?"AUTOPLAY":"")}shutdown(){this.previewAudio.pause(),this.previewAudio.src=null,this.previewAudio=null,window.removeEventListener("visibilitychange",this.visibilityChangeListener)}}class Play{init(t,e){this.song=t,this.difficultyIndex=e,this.player=null,this.backgroundQueue=[],this.currentBackground=null,this.isPaused=!1,this.pauseStartTime=0,this.totalPausedDuration=0,this.pendingSongStart=!1,this.audioEndListener=null,this.started=!1,this.startTime=0,this.autoplay=Account.settings.autoplay,this.userOffset=Account.settings.userOffset,this.lastVideoUpdateTime=0,this.lyrics=null,this.hasLyricsFile=!!t.chart.lyrics,this.visualizerType=Account.settings.visualizer||"NONE",this.lastVisualizerUpdateTime=0,this.metronome=null,this.gameRecorder=null,Account.lastSong={url:t.chart.audioUrl,title:t.chart.title,artist:t.chart.artist,sampleStart:t.chart.sampleStart||0,isExternal:void 0!==t.chart.files},saveAccount(),this.JUDGE_WINDOWS=JUDGE_WINDOWS,this.SCORE_VALUES=SCORE_VALUES}create(){backgroundMusic&&backgroundMusic.stop(),game.camera.fadeIn(0),this.backgroundLayer=game.add.group(),this.backgroundSprite=game.add.sprite(0,0,null,0,this.backgroundLayer),this.backgroundSprite.alpha=.6,this.backgroundCanvas=document.createElement("canvas"),this.backgroundCanvas.width=192,this.backgroundCanvas.height=112,this.backgroundCtx=this.backgroundCanvas.getContext("2d"),this.audio=document.createElement("audio"),this.audio.src=this.song.chart.audioUrl,this.audio.volume=[0,25,50,75,100][Account.settings.volume]/100,this.visibilityChangeListener=()=>{document.hidden&&(this.isPaused||this.pause())},window.addEventListener("visibilitychange",this.visibilityChangeListener),this.video=document.createElement("video"),this.video.muted=!0,this.video.loop=!0,this.createHud(),this.setupLyrics(),this.player=new Player(this),this.metronome=new Metronome(this),this.songStart(),addonManager.executeStateBehaviors(this.constructor.name,this)}createHud(){this.backgroundGradient=new BackgroundGradient(0,.4,5e3),this.hud=game.add.sprite(0,0,"ui_hud_background",0);const t=this.song.chart.difficulties[this.song.difficultyIndex];this.difficultyBanner=game.add.sprite(0,0,"ui_difficulty_banner",0),this.difficultyBanner.tint=this.getDifficultyColor(t.rating),this.hud.addChild(this.difficultyBanner),this.difficultyTypeText=new Text(5,1,t.type.substr(0,7),null,this.difficultyBanner);const e=this.song.chart.titleTranslit||this.song.chart.title;this.songTitleText=new Text(34,1,e,null,this.hud),this.playerName=new Text(4,8,"Miku",FONTS.shaded,this.hud),this.playerName.tint=16777215,e.length>28&&this.songTitleText.scrollwrite(e,28),this.scoreText=new Text(22,12,"0".repeat(9),null,this.hud),this.lifebarStart=game.add.sprite(21,8,"ui_lifebar",0),this.lifebarMiddle=game.add.sprite(1,0,"ui_lifebar",1),this.lifebarMiddle.width=104,this.lifebarEnd=game.add.sprite(104,0,"ui_lifebar",2),this.hud.addChild(this.lifebarStart),this.lifebarStart.addChild(this.lifebarMiddle),this.lifebarStart.addChild(this.lifebarEnd),this.autoplayText=new Text(4,90,this.autoplay?"AUTOPLAY":"",FONTS.stroke,this.hud),this.healthText=new Text(137,8,"100",FONTS.number,this.hud),this.healthText.anchor.x=1,this.judgementText=new Text(game.width/2,60,"",FONTS.shaded),this.judgementText.anchor.set(.5),this.acurracyBar=game.add.sprite(41,108,"ui_acurracy_bar"),this.hud.addChild(this.acurracyBar),this.comboText=new Text(191,106,"0",FONTS.combo),this.comboText.anchor.set(1),this.createVisualizer()}createVisualizer(){switch(this.visualizer&&(this.visualizer.destroy(),this.visualizer=null),this.visualizerType){case"ACURRACY":this.visualizer=new AccuracyVisualizer(this,2,103,36,7);break;case"AUDIO":this.visualizer=new AudioVisualizer(this,2,103,36,7);break;case"BPM":this.visualizer=new BPMVisualizer(this,2,103,36,7);break;default:this.visualizer=null}this.visualizer&&this.hud.addChild(this.visualizer.graphics)}setupLyrics(){if(this.hasLyricsFile&&game.cache.checkTextKey("song_lyrics")){const t=game.cache.getText("song_lyrics");this.lyricsText=new Text(game.width/2,72,"",FONTS.stroke),this.lyricsText.anchor.set(.5),this.lyrics=new Lyrics({textElement:this.lyricsText,maxLineLength:25,lrc:t})}}getDifficultyColor(t){t=Math.max(0,Math.min(11,t));var e=25,s=210,i=25,a=210,n=0,o=0;return Math.floor(e+t/11*(a-e))<<16|Math.floor(s+t/11*(n-s))<<8|Math.floor(i+t/11*(o-i))}getDifficultyColorFromType(t){return{Beginner:65458,Easy:65356,Medium:16763904,Hard:16744192,Challenge:16731136}[t]}setBackground(){this.song.chart.background&&"no-media"!==this.song.chart.background?this.loadBackgroundImage(this.song.chart.background):(this.backgroundCtx.fillStyle="#000000",this.backgroundCtx.fillRect(0,0,192,112),this.updateBackgroundTexture())}songStart(){this.setBackground();const t=this.song.chart.offset||0;this.startTime=game.time.now+2e3-1e3*t,setTimeout(()=>{this.audio.play(),this.started=!0,window.recordNextGame&&game.recorder.start(this.audio,0)},2e3+this.userOffset),this.audioEndListener=this.audio.addEventListener("ended",()=>this.songEnd(),{once:!0})}loadBackgroundImage(t){const e=new Image;e.onload=()=>{this.backgroundCtx.drawImage(e,0,0,192,112),this.updateBackgroundTexture()},e.src=t}loadBackgroundVideo(t){this.video.src=t,this.video.play(),this.backgroundGradient.visible=!1}clearBackgroundImage(){this.backgroundSprite.loadTexture(null),this.backgroundGradient.visible=!1}applyBackground(t){"-nosongbg-"==t.file?this.clearBackgroundImage():"video"==t.type?this.loadBackgroundVideo(t.url):(this.loadBackgroundImage(t.url),this.video.src="",this.backgroundGradient.visible=!0),this.currentBackground=t,this.applyBgEffects(t)}applyBgEffects(t){t.fadeIn?(this.backgroundSprite.alpha=0,game.add.tween(this.backgroundSprite).to({alpha:.6*parseFloat(t.opacity)},500,"Linear",!0)):this.backgroundSprite.alpha=.6*t.opacity}updateBackgroundTexture(){const t=PIXI.Texture.fromCanvas(this.backgroundCanvas);this.backgroundSprite.loadTexture(t)}songEnd(){const t={song:this.song,difficultyIndex:this.difficultyIndex,player:this.player};game.state.start("Results",!0,!1,t)}togglePause(){this.isAnimating||(this.isPaused?this.resume():this.pause())}pause(){this.isPaused=!0,this.pauseStartTime=game.time.now,this.audio?.pause(),this.video.src&&this.video?.pause(),this.showPauseMenu()}resume(){this.isPaused=!1,this.totalPausedDuration+=game.time.now-this.pauseStartTime,this.hidePauseMenu(),this.pendingSongStart?(this.pendingSongStart=!1,this.songStart()):(this.video.src&&this.video?.play(),this.audio?.play())}showPauseMenu(){const t=game.height/2-20;this.pauseBg=game.add.graphics(0,0),this.pauseBg.beginFill(0,.6),this.pauseBg.drawRect(0,0,192,112),this.pauseBg.endFill(),this.pauseCarousel=new CarouselMenu(10,t,80,60,{bgcolor:"brown",fgcolor:"#ffffff",align:"center",animate:!0}),this.pauseCarousel.addItem("CONTINUE",()=>this.resume()),Account.settings.autoplay&&this.pauseCarousel.addItem("DISABLE AUTOPLAY",()=>{Account.settings.autoplay=!1,game.state.start("SongSelect",!0,!1,null,null,!0)}),this.pauseCarousel.addItem("RESTART",()=>game.state.start("Play",!0,!1,this.song,this.difficultyIndex)),this.pauseCarousel.addItem("GIVE UP",()=>this.songEnd()),game.onMenuIn.dispatch("pause",this.pauseCarousel),this.pauseCarousel.addItem("QUIT",()=>game.state.start("MainMenu")),this.pauseCarousel.onCancel.add(()=>this.resume())}hidePauseMenu(){this.pauseCarousel&&(this.pauseBg.destroy(),this.pauseCarousel.destroy(),this.pauseCarousel=null)}getCurrentTime(){if(this.isPaused){const t=this.pauseStartTime-this.startTime-this.totalPausedDuration+this.userOffset;return{now:t/1e3,beat:this.secToBeat(t/1e3)}}{const t=game.time.now-this.startTime-this.totalPausedDuration+this.userOffset;return{now:t/1e3,beat:this.secToBeat(t/1e3)}}}secToBeat(t){return this.player?this.player.secToBeat(t):0}updateBackgrounds(){const{beat:t}=this.getCurrentTime();if(this.song.chart.backgrounds.forEach(e=>{t>=e.beat&&!e.activated&&(e.activated=!0,this.backgroundQueue.push(e))}),this.backgroundQueue.length>0){const t=this.backgroundQueue.shift();this.applyBackground(t)}this.updateVideo()}updateVideo(){this.currentBackground&&"video"==this.currentBackground.type&&game.time.now-this.lastVideoUpdateTime>=3*game.time.elapsedMS&&(this.lastVideoUpdateTime=game.time.now,this.backgroundCtx.drawImage(this.video,0,0,192,112),this.updateBackgroundTexture())}update(){if(gamepad.update(),this.isPaused)return;if(gamepad.pressed.start&&!this.lastStart&&this.togglePause(),this.lastStart=gamepad.pressed.start,this.hasLyricsFile&&this.lyrics&&this.started){const t=this.getCurrentTime().now;this.lyrics.move(t)}this.visualizer&&game.time.now-this.lastVisualizerUpdateTime>=2*game.time.elapsedMS&&(this.visualizer.update(),this.lastVisualizerUpdateTime=game.time.now),gamepad.pressed.select&&!this.lastSelect&&this.metronome.toggle(),this.lastSelect=gamepad.pressed.select,this.metronome&&this.metronome.update();let t="";this.autoplay?t=this.metronome.enabled?"AUTOPLAY + METRONOME":"AUTOPLAY":this.metronome.enabled&&(t="METRONOME"),this.autoplayText.text!=t&&this.autoplayText.write(t),this.player.update(),this.updateBackgrounds(),this.hud.bringToTop(),this.hud.alpha=this.player.gameOver?.5:1,this.judgementText.bringToTop(),this.comboText.bringToTop()}render(){this.player&&this.player.render()}shutdown(){this.audio.removeEventListener("ended",this.audioEndListener),window.removeEventListener("visibilitychange",this.visibilityChangeListener),this.audio.pause(),this.audio.src="",this.audio=null,this.video.src&&(this.video.pause(),this.video.src="",this.video=null),this.song.chart.backgrounds.forEach(t=>t.activated=!1),this.visualizer&&(this.visualizer.destroy(),this.visualizer=null),this.metronome&&(this.metronome.destroy(),this.metronome=null),window.recordNextGame&&(game.recorder.stop(),window.recordNextGame=!1)}}class Results{init(t){this.gameData=t,this.isNewRecord=!1,this.finalScore=0,this.finalAccuracy=0,this.scoreRating=""}create(){game.camera.fadeIn(0),new FuturisticLines,new BackgroundGradient;const{song:t,player:e}=this.gameData,s=t.chart.difficulties[t.difficultyIndex];this.finalScore=e.score,this.finalAccuracy=e.accuracy,this.scoreRating=e.getScoreRating(),this.previewAudio=document.createElement("audio"),this.previewAudio.volume=[0,25,50,75,100][Account.settings.volume]/100,this.visibilityChangeListener=()=>{document.hidden?this.previewAudio?.pause():this.previewAudio?.play()},window.addEventListener("visibilitychange",this.visibilityChangeListener),this.isNewRecord=this.saveHighScore(t,s,e),this.displayResults(),this.showMenu(),addonManager.executeStateBehaviors(this.constructor.name,this)}saveHighScore(t,e,s){if(Account.settings.autoplay)return!1;const i=this.getSongKey(t),a=`${e.type}${e.rating}`;Account.highScores[i]||(Account.highScores[i]={});const n=Account.highScores[i][a],o={score:s.score,accuracy:s.accuracy,rating:s.getScoreRating(),maxCombo:s.maxCombo,date:Date.now(),judgements:{...s.judgementCounts}};let r=!1;return(!n||s.score>n.score)&&(Account.highScores[i][a]=o,saveAccount(),r=!0),r}getSongKey(t){return t.chart.folderName?`local_${t.chart.folderName}`:t.chart.audioUrl?`external_${this.hashString(t.chart.audioUrl)}`:`unknown_${Date.now()}`}hashString(t){let e=0;for(let s=0;s<t.length;s++){e=(e<<5)-e+t.charCodeAt(s),e&=e}return e.toString(36)}displayResults(){const{song:t,player:e}=this.gameData,s=t.chart.difficulties[t.difficultyIndex];this.bannerImg=document.createElement("img"),this.cdtitleImg=document.createElement("img"),this.bannerCanvas=document.createElement("canvas"),this.bannerCtx=this.bannerCanvas.getContext("2d"),this.bannerSprite=game.add.sprite(112,10),t.chart.audioUrl&&(this.previewAudio.src=t.chart.audioUrl,this.previewAudio.currentTime=t.chart.sampleStart||0,this.previewAudio.play()),t.chart.banner&&(this.bannerImg.src=t.chart.banner,this.bannerImg.onload=()=>{this.bannerCtx.drawImage(this.bannerImg,0,0,72,28),this.bannerSprite.loadTexture(PIXI.Texture.fromCanvas(this.bannerCanvas))});const i=t.chart.titleTranslit||t.chart.title;this.songText=new Text(8,10,`${i}`,FONTS.shaded),this.diffText=new Text(10,20,`${s.type} (${s.rating})`),this.diffText.tint=(new Play).getDifficultyColor(s.rating),i.length>25&&this.songText.scrollwrite(i,25);const a=Account.settings.autoplay;this.scoreText=new Text(10,30,`SCORE: ${a?"---":this.finalScore.toLocaleString()}`,FONTS.default),this.accuracyText=new Text(10,40,"ACCURACY: "+(a?"---":`${this.finalAccuracy.toFixed(2)}%`),FONTS.default),this.ratingText=new Text(10,50,`RATING: ${a?"AUTO":this.scoreRating}`,FONTS.shaded),this.ratingText.tint=this.getRatingColor(this.scoreRating),this.comboText=new Text(10,60,`MAX COMBO: ${a?"---":e.maxCombo}`,FONTS.default),this.judgementsText=new Text(15,70,a?"\nAUTOPLAY ENABLED":this.getJudgementsText(e.judgementCounts)),this.judgementsText.tint=a?16711680:16777215,!a&&this.isNewRecord&&(this.recordText=new Text(152,38,"NEW RECORD!",FONTS.shaded),this.recordText.anchor.x=.5,this.recordText.tint=16766720,game.add.tween(this.recordText.scale).to({x:1.2,y:1.2},500,"Linear",!0).yoyo(!0).repeat(-1))}showMenu(){this.navigationHint=new NavigationHint(1);const t=new CarouselMenu(108,44,80,80,{bgcolor:"brown",fgcolor:"#ffffff"});t.addItem("NEXT",()=>{game.state.start("SongSelect",!0,!1,null,window.selectStartingIndex+1,!0)}),t.addItem("CONTINUE",()=>game.state.start("SongSelect")),Account.settings.autoplay&&t.addItem("DISABLE AUTOPLAY",()=>{Account.settings.autoplay=!1,game.state.start("SongSelect")}),t.addItem("RETRY",()=>game.state.start("Play",!0,!1,this.gameData.song)),t.addItem("QUIT",()=>game.state.start("MainMenu")),game.onMenuIn.dispatch("results",t)}getJudgementsText(t){return`MARVELOUS: ${t.marvelous}\nPERFECT: ${t.perfect}\nGREAT: ${t.great}\nGOOD: ${t.good}\nBOO: ${t.boo}\nMISS: ${t.miss}`}getRatingColor(t){return{"SSS+":16766720,SSS:16766720,SS:15790320,S:15790320,A:65280,B:255,C:16776960,D:16753920,E:16711680,F:8388736}[t]||16777215}update(){gamepad.update()}shutdown(){this.previewAudio.pause(),this.previewAudio.src=null,this.previewAudio=null,window.removeEventListener("visibilitychange",this.visibilityChangeListener)}}class Jukebox{init(t=null,e=0){this.songs=t||(window.localSongs&&window.externalSongs?[...window.localSongs,...window.externalSongs]:window.localSongs)||[],this.currentIndex=e||0,this.currentSong=this.songs[this.currentIndex],this.isPlaying=!1,this.isShuffled=!1,this.menuVisible=!1,this.songListMenuVisible=!1,this.originalSongOrder=[...this.songs],this.visualizerMode="symmetrical",this.seekSpeed=1,this.lastSeekTime=0,this.seekCooldown=60,this.doublePressTimeout=200,this.currentBackground=null,this.backgroundQueue=[],this.backgroundSprite=null,this.videoElement=null,this.visualizer=null,this.lyrics=null,this.hasLyrics=!1,this.fullscreenMode=!1,this.buttonActiveTimers={},this.lastLeftPress=0,this.lastRightPress=0,this.lastSelectPress=0,this.lastBPress=0,this.playbackPositions={}}create(){game.camera.fadeIn(0),this.setupBackground(),this.setupAudioPlayer(),this.setupUI(),this.setupVisualizer(),this.setupLyrics(),this.navigationHint=new NavigationHint(3),this.loadSong(this.currentIndex),addonManager.executeStateBehaviors(this.constructor.name,this)}setupBackground(){this.backgroundSprite=game.add.sprite(0,0),this.backgroundSprite.alpha=.4,this.videoElement=document.createElement("video"),this.videoElement.muted=!0,this.videoElement.loop=!0}setupAudioPlayer(){backgroundMusic&&backgroundMusic.stop(),this.audioElement=document.createElement("audio"),this.audioElement.volume=[0,25,50,75,100][Account.settings.volume]/100,this.audioElement.addEventListener("timeupdate",()=>{this.updateProgressBar(),this.updateTimeDisplay()}),this.audioElement.addEventListener("ended",()=>{this.nextSong(!0)}),this.audioElement.addEventListener("error",t=>{console.warn("Audio error:",t)})}setupUI(){this.uiBackground=game.add.graphics(0,0),this.uiBackground.beginFill(0,.7),this.uiBackground.drawRect(0,80,game.width,32),this.uiBackground.endFill(),this.bannerSprite=game.add.sprite(4,4),this.songTitle=new Text(102,4,"",FONTS.shaded),this.songArtist=new Text(104,14,"",FONTS.default),this.songCredit=new Text(104,24,"",FONTS.default),this.currentTimeText=new Text(4,84,"0:00",FONTS.default),this.durationText=new Text(188,84,"0:00",FONTS.default),this.durationText.anchor.x=1,this.progressBarBg=game.add.graphics(30,86),this.progressBarBg.lineStyle(2,6710886,1),this.progressBarBg.moveTo(0,0),this.progressBarBg.lineTo(132,0),this.progressBar=game.add.graphics(30,86),this.createPlaybackControls(),this.lyricsText=new Text(game.width/2,51,"",FONTS.stroke),this.lyricsText.anchor.set(.5),this.lyricsText.visible=!0}createPlaybackControls(){const t=70,e=8,s=8,i=8,a=12,n=8;let o=game.width/2-(e+2+s+2+i+2+a+2+i+2+s+2+n)/2;this.visualizationButton=game.add.sprite(o+e/2,t,"ui_jukebox_visualization",0),this.visualizationButton.anchor.set(.5),o+=e+2,this.skipLeftButton=game.add.sprite(o+s/2,t,"ui_jukebox_skip",0),this.skipLeftButton.anchor.set(.5),this.skipLeftButton.scale.x=-1,o+=s+2,this.seekLeftButton=game.add.sprite(o+i/2,t,"ui_jukebox_seek",0),this.seekLeftButton.anchor.set(.5),this.seekLeftButton.scale.x=-1,o+=i+2,this.pauseButton=game.add.sprite(o+a/2,t,"ui_jukebox_pause_toggle",0),this.pauseButton.anchor.set(.5),o+=a+2,this.seekRightButton=game.add.sprite(o+i/2,t,"ui_jukebox_seek",0),this.seekRightButton.anchor.set(.5),o+=i+2,this.skipRightButton=game.add.sprite(o+s/2,t,"ui_jukebox_skip",0),this.skipRightButton.anchor.set(.5),o+=s+2,this.menuButton=game.add.sprite(o+n/2,t,"ui_jukebox_menu",0),this.menuButton.anchor.set(.5)}setupVisualizer(){this.visualizer=new FullScreenAudioVisualizer(this.audioElement,{visualizationType:this.visualizerMode,barColor:7797982,barWidth:3,barSpacing:1,barBaseHeight:5,barMaxHeight:40,alpha:.6,fftSize:512,smoothing:.7})}setupLyrics(){this.currentSong.lyrics?this.loadLyrics(this.currentSong.lyrics):(this.lyrics=null,this.hasLyrics=!1)}async loadLyrics(t){try{const e=await new Promise((e,s)=>{const i=new XMLHttpRequest;i.open("GET",t),i.onload=()=>{200===i.status||0===i.status?e(i.responseText):s(new Error(`Failed to load lyrics: ${i.status}`))},i.onerror=()=>s(new Error("Network error loading lyrics")),i.send()});this.lyrics=new Lyrics({textElement:this.lyricsText,maxLineLength:25,lrc:e}),this.hasLyrics=!0}catch(t){console.warn("Could not load lyrics:",t),this.lyrics=null,this.hasLyrics=!1}}getSongKey(t){if(t.folderName)return`local_${t.folderName}`;if(t.audioUrl){let e=0;for(let s=0;s<t.audioUrl.length;s++){e=(e<<5)-e+t.audioUrl.charCodeAt(s),e&=e}return`external_${e.toString(36)}`}return`unknown_${Date.now()}`}resetPlaybackPosition(){if(this.audioElement&&this.currentSong){const t=this.getSongKey(this.currentSong);this.playbackPositions[t]=0}}savePlaybackPosition(){if(this.audioElement&&this.currentSong){const t=this.getSongKey(this.currentSong);this.playbackPositions[t]=this.audioElement.currentTime}}loadPlaybackPosition(){if(this.currentSong){const t=this.getSongKey(this.currentSong),e=this.playbackPositions[t];if(e&&e>0)return e}return 0}loadSong(t,e){if(t<0||t>=this.songs.length)return;e?this.resetPlaybackPosition():this.savePlaybackPosition(),this.audioElement.pause(),this.isPlaying=!1,this.currentIndex=t,this.currentSong=this.songs[this.currentIndex],this.audioElement.src=this.currentSong.audioUrl,this.updateSongDisplay(),this.updateBackground(),this.setupLyrics();const s=this.loadPlaybackPosition();this.audioElement.currentTime=s,this.play()}updateSongDisplay(){const t=this.currentSong;if(this.songTitle.write(t.titleTranslit||t.title||"Unknown Title",21),this.songArtist.write(t.artistTranslit||t.artist||"Unknown Artist",21),this.songCredit.write(t.credit||"",21),t.banner&&"no-media"!==t.banner){const e=new Image;e.onload=()=>{const t=document.createElement("canvas");t.width=96,t.height=32;t.getContext("2d").drawImage(e,0,0,96,32);const s=PIXI.Texture.fromCanvas(t);this.bannerSprite.loadTexture(s)},e.src=t.banner}else this.bannerSprite.loadTexture(null)}updateBackground(){if(this.backgroundSprite.loadTexture(null),this.videoElement.src="",this.currentSong.background&&"no-media"!==this.currentSong.background){const t=new Image;t.onload=()=>{const e=document.createElement("canvas");e.width=192,e.height=112;e.getContext("2d").drawImage(t,0,0,192,112);const s=PIXI.Texture.fromCanvas(e);this.backgroundSprite.loadTexture(s)},t.src=this.currentSong.background}this.currentSong.videoUrl&&(this.videoElement.src=this.currentSong.videoUrl,this.videoElement.play(),this.lastVideoUpdate=game.time.now)}updateDurationDisplay(){const t=this.audioElement.duration;if(isNaN(t)||t==1/0)return void this.durationText.write("--:--");const e=Math.floor(t/60),s=Math.floor(t%60);this.durationText.write(`${e}:${s.toString().padStart(2,"0")}`)}updateProgressBar(){const t=this.audioElement.currentTime,e=this.audioElement.duration;if(isNaN(e)||0===e)return;const s=132*(t/e);this.progressBar.clear(),this.progressBar.lineStyle(2,7797982,1),this.progressBar.moveTo(0,0),this.progressBar.lineTo(s,0)}updateTimeDisplay(){const t=this.audioElement.currentTime,e=Math.floor(t/60),s=Math.floor(t%60);this.currentTimeText.write(`${e}:${s.toString().padStart(2,"0")}`)}updateFullscreenMode(){this.fullscreenMode?(this.backgroundSprite.alpha=1,this.uiBackground.visible=!1,this.bannerSprite.visible=!1,this.songTitle.visible=!1,this.songArtist.visible=!1,this.songCredit.visible=!1,this.currentTimeText.visible=!1,this.durationText.visible=!1,this.progressBarBg.visible=!1,this.progressBar.visible=!1,this.visualizationButton.visible=!1,this.skipLeftButton.visible=!1,this.seekLeftButton.visible=!1,this.pauseButton.visible=!1,this.seekRightButton.visible=!1,this.skipRightButton.visible=!1,this.menuButton.visible=!1,this.navigationHint.visible=!1):(this.backgroundSprite.alpha=.4,this.uiBackground.visible=!0,this.bannerSprite.visible=!0,this.songTitle.visible=!0,this.songArtist.visible=!0,this.songCredit.visible=!0,this.currentTimeText.visible=!0,this.durationText.visible=!0,this.progressBarBg.visible=!0,this.progressBar.visible=!0,this.visualizationButton.visible=!0,this.skipLeftButton.visible=!0,this.seekLeftButton.visible=!0,this.pauseButton.visible=!0,this.seekRightButton.visible=!0,this.skipRightButton.visible=!0,this.menuButton.visible=!0,this.navigationHint.visible=!0),this.lyricsText.visible=!0}toggleFullscreen(){this.fullscreenMode=!this.fullscreenMode,this.updateFullscreenMode()}updateButtonStates(){const t=game.time.now;if(this.menuButton.frame=this.buttonActiveTimers.menu>t?1:0,this.menuVisible||this.songListMenuVisible)return;const e=this.isPlaying?0:1;this.pauseButton.frame=e,this.seekLeftButton.frame=gamepad.held.left?1:0,this.seekRightButton.frame=gamepad.held.right?1:0,this.skipLeftButton.frame=this.buttonActiveTimers.skipLeft>t?1:0,this.skipRightButton.frame=this.buttonActiveTimers.skipRight>t?1:0,this.visualizationButton.frame=this.buttonActiveTimers.visualization>t?1:0}setButtonActive(t,e=100){this.buttonActiveTimers[t]=game.time.now+e}changeVolume(t){let e=Account.settings.volume,s=e+t;if(s=Phaser.Math.clamp(s,0,4),s!==e){Account.settings.volume=s,saveAccount(),this.audioElement.volume=[0,25,50,75,100][s]/100;const t=["MUTE","25%","50%","75%","100%"];notifications.show(`VOLUME: ${t[s]}`,1e3)}}play(){this.audioElement.play().then(()=>{this.isPlaying=!0}).catch(t=>{console.warn("Playback failed:",t),this.isPlaying=!1,this.audioElement.currentTime=0,this.play()})}pause(){this.audioElement.pause(),this.isPlaying=!1}togglePlayback(){this.isPlaying?this.pause():this.play(),this.pauseButton.frame=2,this.setButtonActive("pause",100)}nextSong(t){let e=this.currentIndex+1;e>=this.songs.length&&(e=0),this.loadSong(e,t)}previousSong(){let t=this.currentIndex-1;t<0&&(t=this.songs.length-1),this.loadSong(t)}toggleShuffle(){if(this.isShuffled=!this.isShuffled,this.isShuffled){const t=[...this.songs];for(let e=t.length-1;e>0;e--){const s=Math.floor(Math.random()*(e+1));[t[e],t[s]]=[t[s],t[e]]}this.songs=t}else this.songs=[...this.originalSongOrder];this.setButtonActive("visualization",100)}seekForward(){const t=this.audioElement.currentTime,e=Math.min(t+this.seekSpeed,this.audioElement.duration||1/0);this.audioElement.currentTime=e}seekBackward(){const t=this.audioElement.currentTime,e=Math.max(t-this.seekSpeed,0);this.audioElement.currentTime=e}changeVisualizerMode(){const t=["bars","symmetrical","waveform","circular"],e=(t.indexOf(this.visualizerMode)+1)%t.length;this.visualizerMode=t[e],this.visualizer.setVisualizationType(this.visualizerMode),this.setButtonActive("visualization",100)}showSongList(){this.songListMenuVisible=!0;const t=game.add.graphics(0,0);t.beginFill(0,.7),t.drawRect(0,0,game.width,game.height),t.endFill();const e=new CarouselMenu(20,20,152,72,{bgcolor:"brown",fgcolor:"#ffffff",align:"left",disableScrollBar:!1});this.songs.forEach((s,i)=>{const a=s.titleTranslit||s.title||`Song ${i+1}`,n=i===this.currentIndex,o=n?`> ${a}`:`  ${a}`;e.addItem(o,()=>{i!==this.currentIndex&&this.loadSong(i),e.destroy(),t.destroy(),this.songListMenuVisible=!1},{song:s,index:i,bgcolor:n?"#9b59b6":"brown"})}),e.onCancel.add(()=>{e.destroy(),t.destroy(),this.songListMenuVisible=!1}),e.selectedIndex=this.currentIndex,e.updateSelection()}showMenu(){this.menuVisible=!0,this.setButtonActive("menu",100);const t=game.add.graphics(0,0);t.beginFill(0,.7),t.drawRect(0,0,game.width,game.height),t.endFill();const e=new CarouselMenu(60,40,72,40,{bgcolor:"brown",fgcolor:"#ffffff",align:"center"});e.addItem("Continue",()=>{e.destroy(),t.destroy(),this.menuVisible=!1}),e.addItem("Song List",()=>{e.destroy(),t.destroy(),this.menuVisible=!1,this.showSongList()}),e.addItem("Toggle Shuffle",()=>{this.toggleShuffle(),e.destroy(),t.destroy(),this.menuVisible=!1}),e.addItem("Exit Jukebox",()=>{this.exitJukebox()}),e.onCancel.add(()=>{e.destroy(),t.destroy(),this.menuVisible=!1})}exitJukebox(){this.savePlaybackPosition(),this.audioElement.pause(),this.audioElement.src="",this.videoElement&&(this.videoElement.pause(),this.videoElement.src=""),this.visualizer&&this.visualizer.destroy(),this.lyrics&&this.lyrics.destroy(),game.state.start("MainMenu")}update(){if(this.visualizer&&this.visualizer.update(),this.updateDurationDisplay(),this.updateButtonStates(),this.updateLyrics(),this.videoElement.src&&this.videoElement.readyState>=2){const t=game.time.now;if(t-this.lastVideoUpdate>=33){this.lastVideoUpdate=t;const e=document.createElement("canvas");e.width=192,e.height=112;e.getContext("2d").drawImage(this.videoElement,0,0,192,112);const s=PIXI.Texture.fromCanvas(e);this.backgroundSprite.loadTexture(s)}}this.handleInput()}updateLyrics(){if(this.hasLyrics&&this.lyrics&&this.audioElement){const t=this.audioElement.currentTime;this.lyrics.move(t)}else this.lyricsText.write("")}handleInput(){const t=game.time.now;gamepad.update(),this.menuVisible||this.songListMenuVisible||(gamepad.pressed.up&&this.changeVolume(1),gamepad.pressed.down&&this.changeVolume(-1),gamepad.pressed.a&&this.togglePlayback(),gamepad.pressed.b&&this.toggleFullscreen(),gamepad.pressed.select&&this.changeVisualizerMode(),gamepad.pressed.select&&t-this.lastSelectPress<this.doublePressTimeout&&this.toggleShuffle(),gamepad.pressed.start&&this.showMenu(),t-this.lastSeekTime>this.seekCooldown&&(gamepad.held.left&&(this.seekBackward(),this.lastSeekTime=t),gamepad.held.right&&(this.seekForward(),this.lastSeekTime=t)),gamepad.pressed.left&&t-this.lastLeftPress<this.doublePressTimeout&&(this.previousSong(),this.setButtonActive("skipLeft",100),this.lastSeekTime=t),gamepad.pressed.right&&t-this.lastRightPress<this.doublePressTimeout&&(this.nextSong(),this.setButtonActive("skipRight",100),this.lastSeekTime=t),gamepad.pressed.left&&(this.lastLeftPress=t),gamepad.pressed.right&&(this.lastRightPress=t),gamepad.pressed.select&&(this.lastSelectPress=t),gamepad.pressed.b&&(this.lastBPress=t))}shutdown(){this.savePlaybackPosition(),this.audioElement.pause(),this.audioElement.src="",this.videoElement&&(this.videoElement.pause(),this.videoElement.src=""),this.visualizer&&this.visualizer.destroy(),this.lyrics&&this.lyrics.destroy()}}class Credits{init(t="MainMenu",e={}){this.returnState=t,this.returnStateParams=e,this.scrollSpeed=15,this.isWaitingForInput=!1,this.backgroundInterval=8e3,this.availableBackgrounds=[]}create(){game.camera.fadeIn(0),this.setupBackground(),this.startBackgroundMusic(),this.creditsContainer=game.add.group();const t=[{text:"PADMANIACS",font:FONTS.shaded,tint:7797982,spacing:25},{text:"Created by Retora",font:FONTS.default,tint:16777215,spacing:15},{text:"SONG CREDITS",font:FONTS.shaded,tint:7797982,spacing:20}],e=this.getSongCredits();e.length>0&&(t.push(...e),t.push({text:"",font:FONTS.default,tint:16777215,spacing:15})),t.push({text:"Special Thanks",font:FONTS.shaded,tint:7797982,spacing:20},{text:"StepMania Team",font:FONTS.default,tint:16777215,spacing:8},{text:"photonstorm",font:FONTS.default,tint:16777215,spacing:8},{text:"itch.io",font:FONTS.default,tint:16777215,spacing:8},{text:"You!",font:FONTS.shaded,tint:16777215,spacing:25},{text:COPYRIGHT,font:FONTS.default,tint:8947848,spacing:40});let s=game.height+20;t.forEach((t,e)=>{const i=new Text(game.width/2,s,t.text,t.font,this.creditsContainer);i.anchor.set(.5),i.wrapPreserveNewlines(112),i.tint=t.tint,i.creditData=t,s+=t.spacing}),this.totalHeight=s,this.startY=this.creditsContainer.y,this.creditsComplete=!1,addonManager.executeStateBehaviors(this.constructor.name,this)}setupBackground(){this.backgroundSprite=game.add.sprite(0,0),this.backgroundSprite.alpha=.7,this.collectBackgrounds(),this.availableBackgrounds.length>0?(this.showNextBackground(),this.backgroundTimer=game.time.events.loop(this.backgroundInterval,this.showNextBackground,this)):this.backgroundSprite.loadTexture("ui_background_gradient")}collectBackgrounds(){this.availableBackgrounds=[],window.localSongs&&Array.isArray(window.localSongs)&&window.localSongs.forEach(t=>{t.background&&"no-media"!==t.background&&this.availableBackgrounds.push(t.background),t.banner&&"no-media"!==t.banner&&this.availableBackgrounds.push(t.banner)}),window.externalSongs&&Array.isArray(window.externalSongs)&&window.externalSongs.forEach(t=>{t.background&&"no-media"!==t.background&&this.availableBackgrounds.push(t.background),t.banner&&"no-media"!==t.banner&&this.availableBackgrounds.push(t.banner)}),this.availableBackgrounds=[...new Set(this.availableBackgrounds)],console.log(`Found ${this.availableBackgrounds.length} backgrounds for slideshow`)}showNextBackground(){if(0===this.availableBackgrounds.length)return;const t=game.rnd.pick(this.availableBackgrounds),e=new Image;e.onload=()=>{const t=document.createElement("canvas");t.width=192,t.height=112;t.getContext("2d").drawImage(e,0,0,192,112);const s=PIXI.Texture.fromCanvas(t);this.backgroundSprite.loadTexture(s),this.backgroundSprite.alpha=0,game.add.tween(this.backgroundSprite).to({alpha:.4},1e3,"Linear",!0)},e.src=t}startBackgroundMusic(){backgroundMusic&&backgroundMusic.stop();const t=[];window.localSongs&&Array.isArray(window.localSongs)&&t.push(...window.localSongs),window.externalSongs&&Array.isArray(window.externalSongs)&&t.push(...window.externalSongs);const e=t.filter(t=>t.audioUrl);if(e.length>0){const t=game.rnd.pick(e);this.creditsMusic=document.createElement("audio"),this.creditsMusic.src=t.audioUrl,this.creditsMusic.volume=[0,25,50,75,100][Account.settings.volume]/100,this.creditsMusic.loop=!0,this.creditsMusic.play().catch(t=>{console.warn("Could not play credits music:",t)}),console.log(`Playing credits music: ${t.title||"Unknown Song"}`)}}getSongCredits(){const t=[],e=new Set;return window.localSongs&&Array.isArray(window.localSongs)&&window.localSongs.forEach(s=>{const i=s.credit,a=s.titleTranslit||s.title||"Unknown Song";i&&!e.has(i.toLowerCase())&&(e.add(i.toLowerCase()),t.push({text:a,font:FONTS.default,tint:16777215,spacing:8},{text:`by ${i}`,font:FONTS.default,tint:14737632,spacing:12}))}),t.push({text:"",font:FONTS.default,tint:16777215,spacing:8},{text:"All songs and charts belong to their respective copyright holders.",font:FONTS.default,tint:8947848,spacing:12}),t}update(){if(this.visualizer&&this.visualizer.update(),gamepad.update(),this.creditsComplete)return;this.creditsContainer.y-=this.scrollSpeed*(gamepad.held.any?4:1)*(game.time.elapsed/1e3);this.creditsContainer.y+this.totalHeight<0&&!this.creditsComplete&&(this.creditsComplete=!0,this.onCreditsComplete())}onCreditsComplete(){this.continueText=new Text(game.width/2,game.height/2,"Thank you for playing",FONTS.shaded),this.continueText.anchor.set(.5),this.continueText.alpha=0,game.add.tween(this.continueText).to({alpha:1},1e3,"Linear",!0),this.isWaitingForInput=!0,gamepad.signals.pressed.any.addOnce(()=>{this.returnToMenu()})}returnToMenu(){this.creditsMusic&&(this.creditsMusic.pause(),this.creditsMusic.src="",this.creditsMusic=null),this.backgroundTimer&&game.time.events.remove(this.backgroundTimer),backgroundMusic&&Account.settings.enableMenuMusic&&backgroundMusic.playLastSong(),game.camera.fade(0,1e3),game.camera.onFadeComplete.addOnce(()=>{game.state.start(this.returnState,!0,!1,this.returnStateParams)})}shutdown(){this.skipHandler&&gamepad.signals.pressed.any.remove(this.skipHandler),this.creditsMusic&&(this.creditsMusic.pause(),this.creditsMusic.src=""),this.backgroundTimer&&game.time.events.remove(this.backgroundTimer)}}class Player{constructor(t){this.scene=t,this.chart=JSON.parse(JSON.stringify(t.song.chart)),this.difficulty=this.chart.difficulties[t.song.difficultyIndex],this.notes=this.chart.notes[this.difficulty.type+this.difficulty.rating],this.bpmChanges=this.chart.bpmChanges,this.stops=this.chart.stops,this.autoplay=t.autoplay,this.autoplayActiveHolds=new Set,this.scrollDirection=Account.settings.scrollDirection||"falling",this.keymap={left:0,down:1,up:2,right:3,a:3,b:2},this.inputStates=[!1,!1,!1,!1],this.lastInputStates=[!1,!1,!1,!1],this.activeHolds={},this.heldColumns=new Set,this.judgementHistory=[],this.lastNoteCheckBeats=[0,0,0,0],this.score=0,this.combo=0,this.acurracy=0,this.maxCombo=0,this.maxHealth=100,this.health=this.maxHealth,this.previousHealth=this.health,this.timingStory=[],this.receptors=[],this.judgementText=null,this.comboText=null,this.scoreText=null,this.healthText=null,this.VERTICAL_SEPARATION=1.25,this.SCREEN_CONSTANT="C-MOD"===Account.settings.speedMod?4:1,this.NOTE_SPEED_MULTIPLIER=Account.settings.noteSpeedMult+this.SCREEN_CONSTANT,this.JUDGE_LINE="falling"===this.scrollDirection?90:30,this.COLUMN_SIZE=16,this.COLUMN_SEPARATION=4,this.HOLD_FORGIVENESS=.3,this.ROLL_FORGIVENESS=.3,this.ROLL_REQUIRED_INTERVALS=.5,this.INACTIVE_COLOR=8947848,this.speedMod=Account.settings.speedMod||"X-MOD",this.judgementCounts={marvelous:0,perfect:0,great:0,good:0,boo:0,miss:0},this.totalNotes=0,this.accuracy=0,this.gameOver=!1,this.calculateTotalNotes(),this.updateAccuracy(),this.lastVisibleBeats=new Set,this.linesGroup=game.add.group(),this.receptorsGroup=game.add.group(),this.freezeBodyGroup=game.add.group(),this.freezeEndGroup=game.add.group(),this.notesGroup=game.add.group(),this.explosionsGroup=game.add.group(),this.initialize(),this.noteColorOption=Account.settings.noteColorOption||"NOTE";const e=0,s=1,i=2,a=3,n=4,o=5,r=6,h=7,l=8,c=9,d=10,u=11;this.colorMappings={NOTE:{4:e,8:s,12:i,16:a,24:n,32:o,48:r,64:h,96:l,128:c,192:d,default:u},VIVID:{4:a,8:e,12:s,16:r,24:a,32:e,48:s,64:r,96:a,128:e,192:s,default:r},FLAT:{4:a,8:a,12:a,16:a,24:a,32:a,48:a,64:a,96:a,128:a,192:a,default:a},RAINBOW:{4:o,8:s,12:n,16:n,24:s,32:o,48:n,64:s,96:n,128:o,192:s,default:n}}}initialize(){const t=this.calculateLeftOffset();this.receptors=[];for(let e=0;e<4;e++){const s=game.add.sprite(t+e*(this.COLUMN_SIZE+this.COLUMN_SEPARATION)+this.COLUMN_SIZE/2,this.JUDGE_LINE,"receptor",2);s.anchor.set(.5),s.angle={0:90,1:0,2:180,3:-90}[e],s.inputEnabled=!0,s.down=!1,s.events.onInputDown.add(()=>this.handleInput(e,!0)),s.events.onInputUp.add(()=>this.handleInput(e,!1)),s.animations.add("down",[2,1,0],30,!1),s.animations.add("up",[0,1,2],30,!1);const i=game.add.sprite(s.x,s.y,"explosion");i.anchor.set(.5),i.angle=s.angle,i.visible=!1,s.explosion=i;const a=50;i.visible=!1,i.scale.setTo(1.5),game.add.tween(i.scale).to({x:2,y:2},a,"Linear",!0).yoyo(!0).repeat(-1),this.receptorsGroup.add(s),this.receptors.push(s)}this.judgementText=this.scene.judgementText||new Text(96,20,"",{tint:16777215}),this.comboText=this.scene.comboText||new Text(96,40,"0",{tint:16777215}),this.scoreText=this.scene.scoreText||new Text(8,8,"00000000",{tint:16777215}),this.healthText=this.scene.healthText||new Text(184,8,"100%",{tint:16777215})}calculateTotalNotes(){this.totalNotes=this.notes.filter(t=>"1"===t.type||"2"===t.type||"4"===t.type).length}calculateLeftOffset(){return(192-(4*this.COLUMN_SIZE+3*this.COLUMN_SEPARATION))/2}autoPlay(){if(!this.scene.startTime||this.scene.isPaused)return;const{now:t,beat:e}=this.scene.getCurrentTime();for(let t=0;t<4;t++){this.notes.find(s=>!s.hit&&s.column===t&&"1"===s.type&&s.beat-e<=.005)&&!this.inputStates[t]&&(this.handleInput(t,!0),this.handleInput(t,!1))}for(let t=0;t<4;t++){this.notes.find(s=>("2"===s.type||"4"===s.type)&&s.column===t&&!s.hit&&!s.holdActive&&Math.abs(s.beat-e)<=this.scene.JUDGE_WINDOWS.marvelous)&&!this.autoplayActiveHolds.has(t)&&(this.handleInput(t,!0),this.autoplayActiveHolds.add(t));const s=this.activeHolds[t];s&&s.progress>=s.note.secLength&&(this.handleInput(t,!1),this.autoplayActiveHolds.delete(t))}for(let t of this.autoplayActiveHolds){const e=this.activeHolds[t];e&&!e.note.hit||(this.handleInput(t,!1),this.autoplayActiveHolds.delete(t))}}handleInput(t,e){if(!this.scene.startTime||this.scene.isPaused)return;const{now:s,beat:i}=this.scene.getCurrentTime(),a=this.activeHolds[t];if(this.inputStates[t]=e,e){this.heldColumns.add(t),a?.inactive&&s-a.lastRelease<this.HOLD_FORGIVENESS&&(a.active=!0,a.inactive=!1,a.pressCount++,a.lastPress=s,this.toggleHoldExplosion(t,!0)),"4"===a?.note.type&&(a.tapped++,a.lastTap=s,a.active=!0,a.inactive=!1,this.toggleHoldExplosion(t,!0));this.checkRegularNotes(t,s,i)||this.checkHoldStart(t,s,i)}else this.heldColumns.delete(t),this.checkHoldRelease(t,s)}checkRegularNotes(t,e,s){const i=this.notes.find(e=>!e.hit&&e.column===t&&"1"===e.type&&Math.abs(e.beat-s)<=this.scene.JUDGE_WINDOWS.boo);if(i&&this.lastNoteCheckBeats[t]!==s){const e=Math.abs(i.beat-s),a=this.getJudgement(e);return this.createExplosion(i),i.sprite?.destroy(),this.processJudgement(i,a,t),i.hit=!0,this.lastNoteCheckBeats[t]=s,!0}return!1}checkMines(t,e,s){const i=this.notes.find(e=>"M"===e.type&&e.column===t&&!e.hit&&Math.abs(e.beat-s)<=this.scene.JUDGE_WINDOWS.marvelous);i&&(this.createExplosion(i,"mine"),i.hit=!0,i.sprite?.destroy(),this.health=Math.max(0,this.health-10),this.combo=0)}checkHoldStart(t,e,s){const i=this.notes.find(e=>("2"===e.type||"4"===e.type)&&e.column===t&&!e.hit&&Math.abs(e.beat-s)<=this.scene.JUDGE_WINDOWS.boo);if(i&&this.lastNoteCheckBeats[t]!==s){const a=Math.abs(i.beat-s);this.getJudgement(a);this.activeHolds[t]={note:i,startTime:e,progress:0,tapped:0,pressCount:0,active:!0,inactive:!1,lastPress:e,lastRelease:null,lastTap:e},i.holdActive=!0}}checkHoldRelease(t,e){const s=this.activeHolds[t];if(s&&(s.lastRelease=e,"2"===s.note.type)){s.note.secLength-(e-s.startTime)>this.HOLD_FORGIVENESS&&(s.active=!1,s.inactive=!0,this.toggleHoldExplosion(t,!1))}}toggleHoldExplosion(t,e){const s=this.receptors[t].explosion;s.visible=e,e&&s.bringToTop()}getJudgement(t){this.timingStory.push(t);for(const[e,s]of Object.entries(this.scene.JUDGE_WINDOWS))if(t<=s)return e;return"miss"}processJudgement(t,e,s){const i=this.scene.SCORE_VALUES[e];this.gameOver||(this.score+=i),this.autoplay&&(e="marvelous"),this.judgementCounts[e]++,"miss"===e?(this.combo=0,this.health=Math.max(0,this.health-5)):(this.combo++,this.gameOver||(this.health=Math.min(this.maxHealth,this.health+2)),this.combo>this.maxCombo&&(this.maxCombo=this.combo)),this.updateAccuracy(),this.updateUI(),this.showJudgementText(e,s)}updateAccuracy(){if(this.gameOver)return;const t={marvelous:1,perfect:1,great:.8,good:.5,boo:.25,miss:0};let e=0,s=0;for(const[i,a]of Object.entries(this.judgementCounts)){e+=1*a,s+=a*t[i]}const i=Object.values(this.judgementCounts).reduce((t,e)=>t+e,0);if(e+=1*Math.max(0,this.totalNotes-i),this.accuracy=e>0?s/e*100:100,this.accuracy=Phaser.Math.clamp(this.accuracy,0,100),this.scene.acurracyBar){const t=Math.floor(Math.max(1,this.accuracy/100*150));this.scene.acurracyBar.crop(new Phaser.Rectangle(0,0,t,2))}}updateUI(){this.comboText.write(this.combo.toString()),this.comboText.tint=this.getComboColor(this.combo),this.scoreText.write(this.score.toString().padStart(8,"0"));const t=Math.round(this.health/this.maxHealth);this.healthText.write(""+100*t),this.combo>0&&this.pulseText(this.comboText)}getScoreRating(){const t=this.accuracy;return t>=98?"SSS+":t>=95?"SSS":t>=92.5?"SS":t>=90?"S":t>=80?"A":t>=70?"B":t>=60?"C":t>=50?"D":t>=40?"E":"F"}showJudgementText(t,e){if(this.judgementText.write(t.toUpperCase()),this.judgementText.tint={marvelous:65535,perfect:16776960,great:65280,good:255,boo:16753920,miss:16711680}[t],this.judgementText.alpha=1,this.judgementText.scale.set(1),game.tweens.removeFrom(this.judgementText),game.add.tween(this.judgementText.scale).to({x:1.5,y:1},200,"Linear",!0).yoyo(!0),game.add.tween(this.judgementText).to({alpha:0},200,"Linear",!0,200),void 0!==e&&"miss"!==t){const t=this.receptors[e];this.pulseSprite(t)}}pulseText(t){t.scale.set(1),game.add.tween(t.scale).to({x:1.3,y:1.3},100,"Linear",!0).yoyo(!0)}pulseSprite(t){t.scale.set(1),game.add.tween(t.scale).to({x:1.2,y:1.2},50,"Linear",!0).yoyo(!0)}getComboColor(t){const e=100,s=Math.min(e,t);return Math.floor(255+s/e*0)<<16|Math.floor(255+s/e*0)<<8|Math.floor(255+s/e*-255)}createExplosion(t,e="normal"){const s=this.receptors[t.column],i=this.explosionsGroup.getFirstDead()||(()=>{const t=game.add.sprite(-64,-64);return t.anchor.set(.5),this.explosionsGroup.add(t),t})();i.loadTexture("normal"==e?"explosion":"mineexplosion"),i.reset(s.x,s.y),i.alpha=1,i.scale.set(1),i.angle=s.angle;game.add.tween(i.scale).to({x:2,y:2},200,"Linear",!0),game.add.tween(i).to({alpha:0},200,"Linear",!0).onComplete.add(()=>i.kill())}createLine(t,e){const s=this.linesGroup.getFirstDead()||(()=>{const e=game.add.bitmapData(1,1);e.fill(255,255,255);const s=game.add.sprite(this.calculateLeftOffset(),t,e);return s.width=4*this.COLUMN_SIZE+3*this.COLUMN_SEPARATION,this.linesGroup.add(s),s})();return s.y=t,s.alpha=e,s.revive(),s}getNoteFrame(t){const e=t.beat,s=this.colorMappings[this.noteColorOption],i=Object.keys(s).filter(t=>"default"!==t).map(Number).sort((t,e)=>t-e);for(const t of i)if(this.isBeatDivision(e,t))return s[t];return s.default}isBeatDivision(t,e){const s=1e-4,i=t*e%4;return Math.abs(i)<s||Math.abs(i-4)<s}render(){this.scene.startTime&&!this.scene.isPaused&&("falling"===this.scrollDirection?this.renderFalling():this.renderRising(),Account.settings.beatLines&&this.renderTimeLines())}calculateVerticalPosition(t,e,s){let i,a=0;if("C-MOD"===this.speedMod){if(i=(t.sec-e)*this.COLUMN_SIZE*this.VERTICAL_SEPARATION*this.NOTE_SPEED_MULTIPLIER,t.beatLength){const e=t.secLength||60*t.beatLength/this.getCurrentBPM();a=Math.max(this.COLUMN_SIZE,e*this.COLUMN_SIZE*this.VERTICAL_SEPARATION*this.NOTE_SPEED_MULTIPLIER)}}else{i=(t.beat-s)*this.COLUMN_SIZE*this.VERTICAL_SEPARATION*this.NOTE_SPEED_MULTIPLIER,t.beatLength&&(a=Math.max(this.COLUMN_SIZE,t.beatLength*this.COLUMN_SIZE*this.VERTICAL_SEPARATION*this.NOTE_SPEED_MULTIPLIER))}return{pastSize:i,bodyHeight:a,yPos:"falling"===this.scrollDirection?this.JUDGE_LINE-i:this.JUDGE_LINE+i}}renderFalling(){if(!this.scene.startTime||this.scene.isPaused)return;const{now:t,beat:e}=this.scene.getCurrentTime(),s=this.calculateLeftOffset();this.notes.forEach(i=>{let{pastSize:a,bodyHeight:n,yPos:o}=this.calculateVerticalPosition(i,t,e);const r=s+i.column*(this.COLUMN_SIZE+this.COLUMN_SEPARATION);if("M"!==i.type&&"2"!=i.type&&"4"!=i.type&&!i.hit&&!i.miss&&o>game.height&&(i.miss=!0,this.processJudgement(i,"miss",i.column)),o<-this.COLUMN_SIZE||o>game.height+n)return void(i.sprite&&(i.sprite.kill(),delete i.sprite,i.holdParts&&(i.holdParts.body.destroy(),i.holdParts.end.destroy(),delete i.holdParts)));const h=this.activeHolds[i.column];if("M"===i.type)i.sprite||(i.sprite=this.notesGroup.getFirstDead()||(()=>{const t=game.add.sprite(r,o,"mine");return this.notesGroup.add(t),t})(),i.sprite.reset(0,-32),i.sprite.loadTexture("mine"),i.sprite.animations.add("blink",[0,1,2,3,4,5,6,7],10,!0),i.sprite.animations.play("blink")),i.sprite.anchor.set(.5),i.sprite.x=r+this.COLUMN_SIZE/2,i.sprite.y=o;else if("2"===i.type||"4"===i.type){if(!i.holdParts){const t="2"===i.type?"hold":"roll",e=()=>{const e=this.freezeBodyGroup.getFirstDead()||(()=>{const e=game.add.tileSprite(-64,-64,this.COLUMN_SIZE,0,`${t}_body`);return this.freezeBodyGroup.add(e),e})();return e.reset(r,-64),e.loadTexture(`${t}_body`),e},s=()=>{const e=this.freezeEndGroup.getFirstDead()||(()=>{const t=game.add.sprite(0,0);return this.freezeEndGroup.add(t),t})();return e.reset(r,-64),e.loadTexture(`${t}_end`),e};i.holdParts={body:e(),end:s()},i.holdParts.body.anchor.y=1,i.holdParts.end.anchor.y=1,i.holdActive=!1}const t=!i.finish&&!i.miss&&h?.note===i&&h.active;h?.note===i&&h.inactive;let e=void 0!==i.visibleHeight?i.visibleHeight:n;if(e<0&&(e=1),t){const t=o-n,e=this.JUDGE_LINE;i.visibleHeight=Math.max(0,e-t),o>e-this.COLUMN_SIZE/2&&(o=e),i.active=!0}else void 0!==i.visibleHeight&&(o-=n-i.visibleHeight,i.active=!1);!i.miss&&!i.holdActive&&o>this.JUDGE_LINE+this.COLUMN_SIZE&&(i.miss=!0,this.processJudgement(i,"miss",i.column));let s=!i.finish,a=Math.floor(o),l=Math.floor(e);i.holdParts.body.y=a,i.holdParts.body.height=l,i.holdParts.end.y=a-l,i.holdParts.body.visible=s,i.holdParts.end.visible=s,i.sprite&&(i.sprite.visible=!t&&s);const c=t?1:0,d="2"===i.type?47872:61166,u=i.miss?this.INACTIVE_COLOR:d,g=i.miss?.8:1;i.holdParts.body.frame=c,i.holdParts.end.frame=c,i.holdParts.body.tint=u,i.holdParts.end.tint=u,i.holdParts.body.alpha=g,i.holdParts.end.alpha=g}!h?.active||i.finish||i.miss||this.toggleHoldExplosion(i.column,!0),"M"!==i.type&&"3"!==i.type&&(i.sprite||(i.sprite=this.notesGroup.getFirstDead()||(()=>{const t=game.add.sprite(0,0);return this.notesGroup.add(t),t})(),i.sprite.reset(0,-32),i.sprite.loadTexture("arrows"),i.sprite.frame=this.getNoteFrame(i),i.sprite.anchor.set(.5),i.sprite.angle={0:90,1:0,2:180,3:-90}[i.column]),i.sprite.x=r+this.COLUMN_SIZE/2,i.sprite.y=o)})}renderRising(){const{now:t,beat:e}=this.scene.getCurrentTime(),s=this.calculateLeftOffset();this.notes.forEach(i=>{let{deltaNote:a,scalar:n,bodyHeight:o,yPos:r}=this.calculateVerticalPosition(i,t,e);const h=s+i.column*(this.COLUMN_SIZE+this.COLUMN_SEPARATION);if("M"!==i.type&&"2"!=i.type&&"4"!=i.type&&!i.hit&&!i.miss&&r<-this.COLUMN_SIZE&&(i.miss=!0,this.processJudgement(i,"miss",i.column)),r>game.height+this.COLUMN_SIZE||r<-o)return void(i.sprite&&(i.sprite.kill(),delete i.sprite,i.holdParts&&(i.holdParts.body.destroy(),i.holdParts.end.destroy(),delete i.holdParts)));const l=this.activeHolds[i.column];if("M"===i.type)i.sprite||(i.sprite=this.notesGroup.getFirstDead()||(()=>{const t=game.add.sprite(h,r,"mine");return this.notesGroup.add(t),t})(),i.sprite.reset(0,-32),i.sprite.loadTexture("mine"),i.sprite.animations.add("blink",[0,1,2,3,4,5,6,7],10,!0),i.sprite.animations.play("blink")),i.sprite.anchor.set(.5),i.sprite.x=h+this.COLUMN_SIZE/2,i.sprite.y=r;else if("2"===i.type||"4"===i.type){if(!i.holdParts){const t="2"===i.type?"hold":"roll",e=()=>{const e=this.freezeBodyGroup.getFirstDead()||(()=>{const e=game.add.tileSprite(-64,-64,this.COLUMN_SIZE,`${t}_body`);return e.scale.y=-1,e.anchor.y=1,this.freezeBodyGroup.add(e),e})();return e.reset(h,-64),e.loadTexture(`${t}_body`),e},s=()=>{const e=this.freezeEndGroup.getFirstDead()||(()=>{const t=game.add.sprite(0,0);return t.scale.y=-1,t.anchor.y=1,this.freezeEndGroup.add(t),t})();return e.reset(h,-64),e.loadTexture(`${t}_end`),e};i.holdParts={body:e(),end:s()},i.holdActive=!1}const t=!i.finish&&!i.miss&&l?.note===i&&l.active;l?.note===i&&l.inactive;let e=void 0!==i.visibleHeight?i.visibleHeight:o;if(e<0&&(e=1),t){const t=r+o,e=this.JUDGE_LINE;i.visibleHeight=Math.max(0,t-e),r<e+this.COLUMN_SIZE/2&&(r=e),i.active=!0}else void 0!==i.visibleHeight&&(r+=o-i.visibleHeight,i.active=!1);!i.miss&&!i.holdActive&&r<this.JUDGE_LINE-this.COLUMN_SIZE&&(i.miss=!0,this.processJudgement(i,"miss",i.column));let s=!i.finish,a=Math.floor(r),n=Math.floor(e);i.holdParts.body.y=a,i.holdParts.body.height=n,i.holdParts.end.y=a+n,i.holdParts.body.visible=s,i.holdParts.end.visible=s,i.sprite&&(i.sprite.visible=!t&&s);const c=t?1:0,d="2"===i.type?47872:61166,u=i.miss?this.INACTIVE_COLOR:d,g=i.miss?.8:1;i.holdParts.body.frame=c,i.holdParts.end.frame=c,i.holdParts.body.tint=u,i.holdParts.end.tint=u,i.holdParts.body.alpha=g,i.holdParts.end.alpha=g}!l?.active||i.finish||i.miss||this.toggleHoldExplosion(i.column,!0),"M"!==i.type&&"3"!==i.type&&(i.sprite||(i.sprite=this.notesGroup.getFirstDead()||(()=>{const t=game.add.sprite(0,0);return this.notesGroup.add(t),t})(),i.sprite.reset(0,-32),i.sprite.loadTexture("arrows"),i.sprite.frame=this.getNoteFrame(i),i.sprite.anchor.set(.5),i.sprite.angle={0:90,1:0,2:180,3:-90}[i.column]),i.sprite.x=h+this.COLUMN_SIZE/2,i.sprite.y=r)})}renderTimeLines(){if(!Account.settings.beatLines)return;const{beat:t}=this.scene.getCurrentTime(),e=Account.settings.beatsPerMeasure||4,s=Math.floor(t/e),i=s+8,a=new Set;for(let t=s;t<=i;t++){const s=t*e;this.updateTimeLine(s,.9),a.add(s);for(let t=1;t<e;t++){const e=s+t;this.updateTimeLine(e,.35),a.add(e)}}this.cleanupInvisibleLines(a),this.lastVisibleBeats=a}updateTimeLine(t,e){const{now:s,beat:i}=this.scene.getCurrentTime();let a;if("C-MOD"===this.speedMod){const e=(this.beatToSec(t)-s)*this.COLUMN_SIZE*this.VERTICAL_SEPARATION*this.NOTE_SPEED_MULTIPLIER;a="falling"===this.scrollDirection?this.JUDGE_LINE-e:this.JUDGE_LINE+e}else{const e=(t-i)*this.COLUMN_SIZE*this.VERTICAL_SEPARATION*this.NOTE_SPEED_MULTIPLIER;a="falling"===this.scrollDirection?this.JUDGE_LINE-e:this.JUDGE_LINE+e}if(a>=-this.COLUMN_SIZE&&a<=this.scene.game.height+this.COLUMN_SIZE){let s=this.findLineForBeat(t);return s?(s.y=a,s.alpha=e,s.revive()):(s=this.createLine(a,e),s&&(s.targetBeat=t)),s}return null}findLineForBeat(t){const e=this.linesGroup.getAll("alive",!0);for(let s=0;s<e.length;s++){const i=e[s];if(i.targetBeat===t)return i}return null}cleanupInvisibleLines(t){const e=this.linesGroup.getAll("alive",!0);for(let t=0;t<e.length;t++){const s=e[t],i=2*this.COLUMN_SIZE;(s.y<-i||s.y>this.scene.game.height+i)&&s.kill()}}update(){const{now:t,beat:e}=this.scene.getCurrentTime();this.autoplay?this.autoPlay():Object.keys(this.keymap).forEach(s=>{gamepad.pressed[s]?this.handleInput(this.keymap[s],!0):gamepad.released[s]&&this.handleInput(this.keymap[s],!1);for(let s=0;s<4;s++){this.inputStates[s]&&this.checkMines(s,t,e)}});for(let t=0;t<4;t++){const e=this.receptors[t],s=this.inputStates[t];e.down!=s&&(e.down=s),e.frame=s?0:2}this.health!=this.previousHealth&&(this.previousHealth=this.health,game.add.tween(this.scene.lifebarMiddle).to({width:this.health/this.maxHealth*104},100,Phaser.Easing.Quadratic.In,!0),this.health<=0&&(this.gameOver=!0,this.health=0),this.healthText.write(`${Math.floor(this.health/this.maxHealth*100)}`)),this.scene.lifebarEnd.x=this.scene.lifebarMiddle.width,this.scene.acurracyBar&&(this.accuracy<=0?this.scene.acurracyBar.visible=!1:this.scene.acurracyBar.visible=!0),Object.entries(this.activeHolds).forEach(([t,e])=>{const{now:s}=this.scene.getCurrentTime();if(this.autoplay||"2"===e.note.type){if(!e.active){s-e.lastRelease>this.HOLD_FORGIVENESS&&(e.inactive=!0,e.note.miss=!0,this.toggleHoldExplosion(t,!1))}}else if("4"===e.note.type){s-e.lastTap>this.ROLL_FORGIVENESS&&(e.inactive=!0,e.active=!1,e.note.miss=!0,this.toggleHoldExplosion(t,!1))}if(e.progress=s-e.startTime,e.progress>=e.note.secLength){let s="boo";if("2"===e.note.type)s=e.note.miss?"boo":"marvelous";else if("4"===e.note.type){const t=Math.ceil(e.note.beatLength*this.ROLL_REQUIRED_INTERVALS);s=e.note.beatLength<=.5||e.tapped>=t&&!e.note.miss?"marvelous":"boo"}e.note.finish=!0,this.processJudgement(e.note,s,Number(t)),e.note.hit=!0,this.toggleHoldExplosion(t,!1),delete this.activeHolds[t]}})}getLastStop(t,e){return this.stops.find((s,i,a)=>i+1==a.length||a[i+1][e]>=t)}getLastBpm(t,e){return this.bpmChanges.find((s,i,a)=>i+1==a.length||a[i+1][e]>=t)}secToBeat(t){let e=this.getLastBpm(t,"sec"),s=this.stops.filter(({sec:s})=>s>=e.sec&&s<t).map(e=>e.sec+e.len>t?t-e.sec:e.len);for(let e in s)t-=s[e];return(t-e.sec)*e.bpm/60+e.beat}beatToSec(t){let e=this.getLastBpm(t,"beat"),s=(t-e.beat)/e.bpm*60+e.sec,i=this.stops.filter(({beat:s})=>s>=e.beat&&s<t).map(t=>t.len);for(let t in i)s+=i[t];return s}}